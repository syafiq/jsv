`)}a.push(S,v,l[5]),r-=l[2].length+l[4].length}}else if(l[7]){const y=l[6]==="";g={_:Xy[l[7]],offset:h+(y?0:l[6].length),length:m.length},n(g)&&(y?a.push(m):a.push(l[6]+m+l[9]),r-=l[7].length*2+(y?2:0))}else l[11]?(g={_:"messageEntityMentionName",user_id:l[10].toUserId(),offset:h,length:m.length},n(g)&&(a.push(m),r-=l[0].length-m.length)):l[12]&&(g={_:"messageEntityTextUrl",url:l[14],offset:h,length:m.length},n(g)&&(a.push(m),r-=l[12].length-m.length));i||a.push(l[0]),o=o.substr(l.index+l[0].length),r+=l.index+l[0].length;const f=r-u;f&&e.forEach(y=>{y.offset>=h&&(y.offset+=f)})}o&&a.push(o);let c=a.join("");c.replace(/\s+/g,"").length||(c=o,s.splice(0,s.length)),oo(e,s),eI(e);let d=c.length;if(!t){c=c.replace(/^\s*/,"");let h=d-c.length;h&&e.forEach(u=>{u.offset=Math.max(0,u.offset-h)}),c=c.replace(/\s*$/,""),h=d-c.length,d=c.length,h&&e.forEach(u=>{u.offset+u.length>d&&(u.length=d-u.offset)})}return c}const zu=300;class Ek{constructor(e,t,s){this.managers=e,this.onReady=t,this.onChange=s,this.middlewareHelper=Gt(),this.listenerSetter=new Qt,this.construct()}construct(){this.container=document.createElement("div"),this.container.classList.add("new-message-send-as-container"),this.closeBtn=document.createElement("div"),this.closeBtn.classList.add("new-message-send-as-close","new-message-send-as-avatar"),this.closeBtn.append(Le("close"));const e=[{text:"SendMessageAsTitle",onClick:void 0}];this.buttons=[];let t;const s=i=>{i&&(t=this.avatar);const n=this.avatar!==t,a=!i&&n?2:0;vt({element:this.closeBtn,className:"is-visible",forwards:i,duration:zu,useRafs:a}),n||vt({element:t.node,className:"is-visible",forwards:!i,duration:zu,useRafs:a})};yi({buttonOptions:{noRipple:!0},listenerSetter:this.listenerSetter,container:this.container,direction:"top-right",buttons:e,onOpenBefore:()=>{s(!0)},onOpen:(i,n)=>{e[0].element.classList.add("btn-menu-item-header"),this.btnMenu=n,this.btnMenu.classList.add("scrollable","scrollable-y"),this.btnMenu.append(...this.buttons.map(a=>a.element))},onClose:()=>{s(!1)},onCloseAfter:()=>{this.btnMenu=void 0}}),this.container.append(this.closeBtn)}async updateButtons(e){const t=e.map(async(i,n)=>{const a=document.createElement("div"),{peerId:r,needPremium:l}=i,c=document.createElement("div");c.classList.add("btn-menu-item-subtitle"),r.isUser()?c.append(_("Chat.SendAs.PersonalAccount")):r===this.peerId?c.append(_("VoiceChat.DiscussionGroup")):c.append(await Nn(r.toChatId()));const d=document.createElement("div");return d.append(new Mt({peerId:r}).element),l&&d.append(Le("premium_lock","new-message-send-as-lock")),a.append(d,c),{onClick:n?async()=>{if(i.needPremium&&!C.premium){ps.show();return}const h=this.peerId;this.changeSendAsPeerId(r);const u=this.middlewareHelper.get(),p=()=>{if(this.sendAsPeerId!==r||!u())return;const m=this.sendAsPeers.slice(),g=m.findIndex(f=>f.peerId===r);g!==-1&&m.splice(g,1),m.unshift(i),this.updateButtons(m)};et.isAvailable("animations")?setTimeout(p,250):p(),this.managers.appMessagesManager.saveDefaultSendAs(h,r)}:void 0,textElement:a}}),s=await Promise.all(t);Mn({buttons:s}),s.forEach((i,n)=>{const{peerId:a}=e[n],r=ls({middleware:this.middlewareHelper.get(),size:26,peerId:a});r.node.classList.add("btn-menu-item-icon"),n||r.node.classList.add("active"),i.element.prepend(r.node)}),this.buttons=s,this.btnMenu?.append(...this.buttons.map(i=>i.element))}async updateAvatar(e,t){const s=this.avatar;if(s&&s.node.dataset.peerId.toPeerId()===e)return;s||(t=!0);const i=t?0:2,n=t?0:zu,a=this.avatar=ls({middleware:this.middlewareHelper.get(),size:30,isDialog:!1,peerId:e});a.node.classList.add("new-message-send-as-avatar"),await a.readyThumbPromise,vt({element:a.node,className:"is-visible",forwards:!0,duration:n,useRafs:i}),s&&vt({element:s.node,className:"is-visible",forwards:!1,duration:n,onTransitionEnd:()=>{s.node.remove()},useRafs:i}),this.container.append(a.node)}changeSendAsPeerId(e,t){return this.sendAsPeerId=e,this.onChange(e),this.updateAvatar(e,t)}getDefaultSendAs(){return this.managers.acknowledged.appProfileManager.getChannelFull(this.peerId.toChatId()).then(e=>({cached:e.cached,result:e.result.then(t=>t.default_send_as?Je(t.default_send_as):void 0)}))}async updateManual(e){const t=this.peerId;if(this.updatingPromise||!await this.managers.appPeersManager.isChannel(t))return;const s=this.middlewareHelper.get(()=>!this.updatingPromise||this.updatingPromise===c),{container:i}=this,n=t.toChatId(),a=(await Ro(this.getDefaultSendAs())).result,r=e;a instanceof Promise&&(e=void 0);const l=r&&!e,c=this.updatingPromise=Xs(a,async d=>{if(!s()||d===void 0||(await this.changeSendAsPeerId(d,e),!s()))return;Promise.all([this.managers.appChatsManager.getSendAs(n),fe.isPremiumFeaturesHidden()]).then(([u,p])=>{if(!s())return;p&&(u=u.filter(f=>!f.pFlags.premium_required));const m=u.map(f=>({peerId:Je(f.peer),needPremium:f.pFlags.premium_required}));this.sendAsPeers=m.slice();const g=m.findIndex(f=>f.peerId===d);if(g!==-1){const f=m.splice(g,1)[0];m.unshift(f)}else m.unshift({peerId:d});this.updateButtons(m)});const h=()=>{this.onReady(i,e),this.addedListener||(this.listenerSetter.add(C)("peer_full_update",u=>{this.peerId===u&&this.update()}),this.addedListener=!0)};if(l){h();return}return h});if(c.finally(()=>{this.updatingPromise===c&&(this.updatingPromise=void 0)}),!l)return c}update(e){return this.updateManual(e).then(t=>t?.())}setPeerId(e){this.middlewareHelper.clean(),this.updatingPromise=void 0,this.peerId=e}destroy(){this.container.remove(),this.setPeerId(),this.listenerSetter.removeAll()}}function _k(o,e){return Li(o,e)}function gy(o,e){return Li(o,e,["date","reply_to"])&&_k(o?.reply_to,e?.reply_to)}function Vw(o){return o.icons.find(e=>e.name===fC)}function yh(o){return o?o.match(yC):null}function Wp(o,e){const t={};o.forEach(h=>t[h]={elements:[],active:!1});const s=window.getSelection();if(s.isCollapsed)return t;const i=s.getRangeAt(0),n=i.commonAncestorContainer,r=(n.nodeType===n.ELEMENT_NODE?n:n.parentElement).closest('[contenteditable="true"]');if(!r)return t;const l=document.createTreeWalker(r,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,{acceptNode:h=>i.intersectsNode(h)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT});let c=0,d;for(;d=l.nextNode();){++c;for(const h of o){const u=sI[h],p=d.nodeType===d.ELEMENT_NODE?d:d.parentElement;p.closest(u.match)&&t[h].elements.push(p)}}for(const h of o)t[h].active=t[h].elements.length>=(e?c:1);return t}class qo{constructor(){this.buttons={},this.addedListener=!1,this.waitingForMouseUp=!1,this.mouseUpCounter=0,this.onMouseUpSingle=e=>{if(this.waitingForMouseUp=!1,Ye)if(e&&X(e),this.mouseUpCounter++===0)this.resetSelection(this.savedRange);else{this.hide();return}this.show()}}static getInstance(){return this.INSTANCE||(this.INSTANCE=new qo)}init(){this.container=document.createElement("div"),this.container.classList.add("markup-tooltip","z-depth-1","hide"),this.wrapper=document.createElement("div"),this.wrapper.classList.add("markup-tooltip-wrapper");const e=document.createElement("div"),t=document.createElement("div");e.classList.add("markup-tooltip-tools","markup-tooltip-tools-regular"),t.classList.add("markup-tooltip-tools","markup-tooltip-tools-link"),["bold","italic","underline","strikethrough","monospace","spoiler",["quote","quote_outline"],"link"].forEach(l=>{const c=typeof l=="string"?l:l[0],d=typeof l=="string"?l:l[1],h=Xe(d,{noRipple:!0});e.append(this.buttons[c]=h),l!=="link"?h.addEventListener("mousedown",u=>{X(u),jp(this.input,c),this.cancelClosening()}):D(h,u=>{X(u),this.showLinkEditor(),this.cancelClosening()})}),this.linkBackButton=Xe("left",{noRipple:!0}),this.linkInput=document.createElement("input"),$t(this.linkInput,"MarkupTooltip.LinkPlaceholder",void 0,"placeholder"),this.linkInput.classList.add("input-clear"),this.linkInput.addEventListener("keydown",l=>{const c=!this.linkInput.value.length||!!yh(this.linkInput.value);l.key==="Enter"&&(c?this.applyLink(l):(this.linkInput.classList.contains("error")&&(this.linkInput.classList.remove("error"),this.linkInput.offsetLeft),this.linkInput.classList.add("error")))}),this.linkInput.addEventListener("input",l=>{const c=this.isLinkValid();this.linkInput.classList.toggle("is-valid",c),this.linkInput.classList.remove("error")}),this.linkBackButton.addEventListener("mousedown",l=>{X(l),this.container.classList.remove("is-link"),this.resetSelection(),this.setTooltipPosition(),this.cancelClosening()}),this.linkApplyButton=Xe("check markup-tooltip-link-apply",{noRipple:!0}),this.linkApplyButton.addEventListener("mousedown",l=>{this.applyLink(l)});const i=document.createElement("div");i.classList.add("markup-tooltip-link-apply-container");const n=document.createElement("span"),a=document.createElement("span"),r=document.createElement("span");n.classList.add("markup-tooltip-delimiter"),a.classList.add("markup-tooltip-delimiter"),r.classList.add("markup-tooltip-delimiter"),e.insertBefore(n,this.buttons.link),i.append(r,this.linkApplyButton),t.append(this.linkBackButton,a,this.linkInput,i),this.wrapper.append(e,t),this.container.append(this.wrapper),document.body.append(this.container),window.addEventListener("resize",()=>{this.hide()})}showLinkEditor(){(!this.container||!this.container.classList.contains("is-visible"))&&this.show();const e=this.buttons.link;this.container.classList.add("is-link");const t=document.getSelection();this.savedRange=t.getRangeAt(0);const i=Wp(["link"]).link.elements.find(n=>n.tagName==="A");e.classList.contains("active")?this.linkInput.value=i.href:this.linkInput.value="",this.setTooltipPosition(!0),setTimeout(()=>{this.linkInput.focus()},200),this.linkInput.classList.toggle("is-valid",this.isLinkValid())}applyLink(e){X(e),this.resetSelection();let t=this.linkInput.value;t&&!vC(t)&&(t="https://"+t),jp(this.input,"link",t),setTimeout(()=>{this.hide()},0)}isLinkValid(){return!this.linkInput.value.length||!!yh(this.linkInput.value)}resetSelection(e=this.savedRange){const t=window.getSelection();t.removeAllRanges(),t.addRange(e),this.input.focus()}hide(){this.init||(this.input=void 0,this.container.classList.remove("is-visible"),document.removeEventListener("mouseup",this.onMouseUpSingle),this.waitingForMouseUp=!1,dt.removeByType("markup"),this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=window.setTimeout(()=>{this.hideTimeout=void 0,this.container.classList.add("hide"),this.container.classList.remove("is-link")},200))}getActiveMarkupButton(){const e=new Set,t=Object.keys(this.buttons),s=Wp(t);return t.forEach(i=>{s[i].active&&e.add(this.buttons[i])}),[...e]}setActiveMarkupButton(){const e=this.getActiveMarkupButton();for(const t in this.buttons){const s=this.buttons[t];s.classList.toggle("active",e.includes(s))}}setTooltipPosition(e=!1){const s=document.getSelection().getRangeAt(0),i=U(this.input,"rows-wrapper")||U(this.input,"input-message-container"),n=this.container.classList.contains("is-link")?this.wrapper.lastElementChild:this.wrapper.firstElementChild,a=document.body.getBoundingClientRect(),r=s.getBoundingClientRect(),l=i.getBoundingClientRect(),c=n.getBoundingClientRect();this.container.style.maxWidth=l.width+"px";const d=Fr(void 0,this.input,!1,r),{newHeight:h=0,oldHeight:u=h}=this.input;if(!d)return;const m=(d?d.rect.top:l.top)+a.top*-1-c.height-8+(u-h),g=l.left,f=l.left+l.width-Math.min(l.width,c.width);let y;if(e){const v=this.container.getBoundingClientRect();y=Ot(v.left,g,f)}else{const v=r.left+(r.width-c.width)/2;y=Ot(v,g,f)}this.container.style.transform=`translate3d(${y}px, ${m}px, 0)`}show(){if(this.init&&(this.init(),this.init=null),ho()){this.hide();return}if(this.hideTimeout!==void 0&&clearTimeout(this.hideTimeout),this.container.classList.contains("is-visible"))return;this.container.classList.toggle("night",hi.isDarkOverlayActive),this.setActiveMarkupButton(),this.container.classList.remove("is-link");const e=this.container.classList.contains("hide");e&&(this.container.classList.remove("hide"),this.container.classList.add("no-transition")),this.setTooltipPosition(),e&&(this.container.offsetLeft,this.container.classList.remove("no-transition")),this.container.classList.add("is-visible"),mi||dt.pushItem({type:"markup",onPop:()=>{this.hide()}})}setMouseUpEvent(){this.waitingForMouseUp||(this.waitingForMouseUp=!0,document.addEventListener("mouseup",this.onMouseUpSingle,{once:!0}))}cancelClosening(){Ye&&!Sr&&(document.removeEventListener("mouseup",this.onMouseUpSingle),document.addEventListener("mouseup",e=>{X(e),this.mouseUpCounter=1,this.waitingForMouseUp=!1,this.setMouseUpEvent()},{once:!0}))}canFormatInput(e){return e.classList.contains("input-message-input")}handleSelection(){this.addedListener||(this.addedListener=!0,document.addEventListener("selectionchange",e=>{if(document.activeElement===this.linkInput)return;const t=document.activeElement;if(this.input?t!==this.input:!this.canFormatInput(t)){this.hide();return}const s=document.getSelection();if(ho(s)){this.hide();return}if(this.input=t,Ye)if(Sr)this.show(),this.setTooltipPosition();else{if(this.mouseUpCounter===2){this.mouseUpCounter=0;return}this.savedRange=s.getRangeAt(0),this.setMouseUpEvent()}else this.container&&this.container.classList.contains("is-visible")?(this.setActiveMarkupButton(),this.setTooltipPosition()):this.input.matches(":active")?this.setMouseUpEvent():this.show()}),document.addEventListener("beforeinput",e=>{(e.inputType==="historyRedo"||e.inputType==="historyUndo")&&e.target.addEventListener("input",()=>this.setActiveMarkupButton(),{once:!0})}))}}function kk(o){const e=document.createRange();if(o.endContainer.nodeType===Node.TEXT_NODE&&o.endOffset<o.endContainer.nodeValue.length)return e.setStart(o.endContainer,o.endOffset),e.setEnd(o.endContainer,o.endOffset+1),e.toString();const t=Tk(o.endContainer);if(t)return e.setStart(t,0),e.setEnd(t,1),e.toString()}function Tk(o){for(;o&&!o.nextSibling;)o=o.parentNode;if(o&&o.nextSibling)return $w(o.nextSibling)}function $w(o){if(o.nodeType===Node.TEXT_NODE)return o;for(let e=0;e<o.childNodes.length;e++){const t=o.childNodes[e],s=$w(t);if(s)return s}}const Gw=new WeakMap;function xk(o){const e=Gw.get(o);e&&(e.canRedoFromHTML="",e.undoHistory.length=0,e.executedHistory.length=0,e.canUndoFromHTML="")}function Ak(o){const e=Gw.get(o);e&&e.canRedoFromHTML&&!e.lockRedo&&o.innerHTML!==e.canRedoFromHTML&&(e.canRedoFromHTML="",e.undoHistory.length=0)}function jp(o,e,t){const s={link:t?()=>document.execCommand("createLink",!1,t):()=>document.execCommand("unlink",!1,null)},i=u=>{s[u]=()=>{const p=(n.includes(u)?n:[u]).filter(g=>h[g]?.active);if(cs(p,u)||p.push(u),u==="quote"){const g=document.getSelection();g.rangeCount&&kk(g.getRangeAt(0))===`
`&&g.modify(g.isCollapsed?"move":"extend","forward","character")}let m;return p.length?m=document.execCommand("fontName",!1,"markup-"+p.join("-")):m=Rk(),zw(o),m}},n=["bold","italic","underline","strikethrough","spoiler","quote"];if(n.forEach(u=>{i(u)}),i("monospace"),!s[e])return!1;const a=s[e],r=[],c=Cm.getInstance().prepareApplyingMarkdown(),d={capture:!0,passive:!1};o.addEventListener("input",X,d),r.push(document.execCommand("styleWithCSS",!1,"true"));const h=Wp(Object.keys(s));return h.monospace?.active&&e==="link"&&r.push(Fk()),r.push(typeof a=="function"?a():document.execCommand(a,!1,null)),r.push(document.execCommand("styleWithCSS",!1,"false")),c(),qo.getInstance().setActiveMarkupButton(),o.removeEventListener("input",X,d),Mh(o,"input"),!0}function zw(o){o.querySelectorAll('[style*="font-family"]').forEach(e=>{if(e.style.caretColor){e.style.cssText="";return}const t=e.style.fontFamily;t!==rp&&(e.classList.add("is-markup"),e.dataset.markup=t,nn(e),t.includes("quote")&&e.classList.add("quote-like","quote-like-icon","quote-like-border"))}),o.querySelectorAll(".is-markup").forEach(e=>{const t=e.style.fontFamily;t&&t!==rp||(t.includes("quote")||e.classList.remove("quote-like","quote-like-icon","quote-like-border"),e.classList.remove("is-markup"),delete e.dataset.markup)})}function Fk(){return document.execCommand("removeFormat",!1,null)}function Rk(){return document.execCommand("fontName",!1,rp)}function Dk(o,e){const t={KeyB:"bold",KeyI:"italic",KeyU:"underline",KeyS:"strikethrough",KeyM:"monospace",KeyP:"spoiler"};t.KeyK="link";const s=e.code,i=t[s],n=document.getSelection();!ho(n)&&i&&(s==="KeyK"?qo.getInstance().showLinkEditor():jp(o,i),X(e))}const Bk=500,Nk=!1,or={send_voices:"GlobalAttachVoiceRestricted",send_stickers:"GlobalAttachStickersRestricted",send_gifs:"GlobalAttachGifRestricted",send_media:"GlobalAttachMediaRestricted",send_plain:"GlobalSendMessageRestricted",send_polls:"ErrorSendRestrictedPollsAll",send_inline:"GlobalAttachInlineRestricted"},Md="chat-input",jr=new Set([Q.Scheduled,Q.Stories,Q.Saved]),Nl=class Nl{constructor(e,t,s,i){this.chat=e,this.appImManager=t,this.managers=s,this.className=i,this.lastUrl="",this.lastTimeType=0,this.replyElements={},this.willSendWebPage=null,this.webPageOptions={},this.recording=!1,this.recordCanceled=!1,this.recordStartTime=0,this.unblockUser=()=>{const n=this.toggleControlButtonDisability=zt([this.unblockBtn],!0),a=this.chat.peerId,r=this.getMiddleware(()=>this.chat.peerId===a&&this.toggleControlButtonDisability===n);this.managers.appUsersManager.toggleBlock(a,!1).then(()=>{r()&&(n(),this.toggleControlButtonDisability=void 0)})},this.startBot=()=>{const{startParam:n}=this,a=this.toggleControlButtonDisability=zt([this.botStartBtn],!0),r=this.chat.peerId,l=this.getMiddleware(()=>this.chat.peerId===r&&this.startParam===n&&this.toggleControlButtonDisability===a);this.managers.appMessagesManager.startBot(r.toUserId(),void 0,n).then(()=>{l()&&(a(),this.toggleControlButtonDisability=void 0,this.setStartParam())})},this.onCancelRecordClick=n=>{n&&X(n),this.recordCanceled=!0,this.recorder.stop(),od.setKeepAlive(!1)},this.onEmoticonsToggle=n=>{this.btnToggleEmoticons&&(Ye?Uo(this.btnToggleEmoticons,n?"keyboard":"smile"):this.btnToggleEmoticons.classList.toggle("active",n))},this.onEmoticonsOpen=()=>{this.onEmoticonsToggle(!0)},this.onEmoticonsClose=()=>{this.onEmoticonsToggle(!1)},this.canSendWhenOnline=async()=>{const n=this.chat.peerId;return C.myId===n||!n.isUser()||!await this.managers.appUsersManager.isUserOnlineVisible(n)?!1:(await this.managers.appUsersManager.getUser(n)).status?._!=="userStatusOnline"},this.scheduleSending=async(n=this.sendMessage.bind(this,!0),a=new Date)=>{const r=this.getMiddleware(),l=await this.canSendWhenOnline();r()&&J.createPopup(Wm,{initDate:a,onPick:c=>{r()&&this.setScheduleTimestamp(c,n)},canSendWhenOnline:l}).show()},this.onMessageInput=n=>{const{value:a,entities:r,caretPos:l}=sn(this.messageInputField.input),c=my(a,r,!0),d=oo(r,ro(c));if(Ak(this.messageInput),this.processWebPage(a,d),!a.trim())this.lastTimeType&&this.managers.appMessagesManager.setTyping(this.chat.peerId,{_:"sendMessageCancelAction"},void 0,this.chat.threadId),qo.getInstance().hide(),document.activeElement===this.messageInput&&!mi&&setTimeout(()=>{document.activeElement===this.messageInput&&(this.messageInput.textContent="1",Qs(this.messageInput),this.messageInput.textContent="")},0);else{const u=Date.now();u-this.lastTimeType>=6e3&&n?.isTrusted&&(this.lastTimeType=u,this.managers.appMessagesManager.setTyping(this.chat.peerId,{_:"sendMessageTypingAction"},void 0,this.chat.threadId)),this.botCommands?.toggle(!0)}this.botCommands&&this.updateBotCommandsToggle(),this.editMsgId||this.saveDraftDebounced(),this.checkAutocomplete(a,l,d),zw(this.messageInput),this.updateSendBtn()},this.onEmojiSelected=(n,a)=>{const r=n.docId?{_:"messageEntityCustomEmoji",document_id:n.docId,length:n.emoji.length,offset:0}:qd(n.emoji);this.insertAtCaret(n.emoji,r,a)},this.onBtnSendClick=async n=>{X(n);const a=this.isInputEmpty();if(this.chat.type===Q.Stories&&a&&!this.freezedFocused&&this.canForwardStory){this.forwardStoryCallback?.(n);return}else if(!this.recorder||this.recording||!a||this.forwarding||this.editMsgId)this.recording?Date.now()-this.recordStartTime<Bk?this.onCancelRecordClick():this.recorder.stop():this.sendMessage();else{const r=this.chat.peerId.isAnyChat(),l="send_voices";if(r&&!await this.chat.canSend(l)){Re({langPackKey:or[l]});return}this.chatInput.classList.add("is-locked"),un();let c=!1;if(r||(await this.managers.appProfileManager.getProfile(this.chat.peerId.toUserId()))?.pFlags.voice_messages_forbidden&&(Re({langPackKey:"Chat.SendVoice.PrivacyError",langPackArguments:[await Oe({peerId:this.chat.peerId})]}),c=!0),c){this.chatInput.classList.remove("is-locked");return}this.recorder.start().then(()=>{this.releaseMediaPlayback=lt.setSingleMedia(),this.recordCanceled=!1,this.setRecording(!0),od.setKeepAlive(!0);const d=()=>{J.createPopup(ms,"popup-cancel-record",{titleLangKey:"DiscardVoiceMessageTitle",descriptionLangKey:"DiscardVoiceMessageDescription",buttons:[{langKey:"DiscardVoiceMessageAction",callback:()=>{hs(this.btnCancelRecord)}},{langKey:"Continue",isCancel:!0}]}).show()};this.recordingOverlayListener=this.listenerSetter.add(document.body)("mousedown",v=>{!U(v.target,Md)&&!U(v.target,"popup-cancel-record")&&(X(v),d())},{capture:!0,passive:!1}),dt.pushItem(this.recordingNavigationItem={type:"voice",onPop:()=>(setTimeout(()=>{d()},0),!1)}),this.recordStartTime=Date.now();const h=this.recorder.sourceNode,p=h.context.createAnalyser();h.connect(p),p.fftSize=32;const m=new Uint8Array(p.frequencyBinCount),g=m.length*255,f=54/150,y=()=>{if(!this.recording)return;p.getByteFrequencyData(m);let v=0;m.forEach(L=>{v+=L});const b=Math.min(1,v/g+f);this.recordRippleEl.style.transform=`scale(${b})`;const w=Date.now()-this.recordStartTime,S=w%1e3,I=Ci(w/1e3)+","+("00"+Math.round(S/10)).slice(-2);this.recordTimeEl.textContent=I,vs(y)};y()}).catch(d=>{switch(d.name){case"NotAllowedError":{Rs("Please allow access to your microphone");break}case"NotReadableError":{Rs(d.message);break}default:console.error("Recorder start error:",d,d.name,d.message),Rs(d.message);break}this.setRecording(!1),this.chatInput.classList.remove("is-locked")})}},this.onHelperCancel=async(n,a)=>{if(n&&X(n),this.willSendWebPage){const r=this.lastUrl;let l=!1;if(this.helperType&&(await this.helperFunc(),l=!0),this.lastUrl=r,this.noWebPage=!0,this.willSendWebPage=null,l)return}if(this.helperType==="edit"&&!a){const r=this.editMessage,l=this.getCurrentInputAsDraft(!0);l&&delete l.pFlags.no_webpage;const c=r.reply_to?._==="messageReplyHeader"?r.reply_to:void 0,d=r?.media?._==="messageMediaWebPage"?r.media:void 0,h=d?.webpage?.pFlags?.has_large_media,u={_:"draftMessage",date:l?.date,message:r.message,entities:r.entities,pFlags:{invert_media:r.pFlags.invert_media},media:d&&{_:"inputMediaWebPage",pFlags:{force_large_media:h&&d.pFlags.force_large_media||void 0,force_small_media:h&&d.pFlags.force_small_media||void 0,optional:!0},url:d.webpage.url},reply_to:c&&{_:"inputReplyToMessage",reply_to_msg_id:c.reply_to_msg_id}};if(u.entities?.length||l?.entities?.length){const p=new Set(Object.values(Xy));p.add("messageEntityCustomEmoji"),u?.entities&&(u.entities=u.entities.slice()),[u,l].forEach(m=>{m?.entities&&(ii(m.entities,(g,f,y)=>{p.has(g._)||y.splice(f,1)}),m.entities.length||delete m.entities)})}if(!gy(l,u)){J.createPopup(ms,"discard-editing",{buttons:[{langKey:"Alert.Confirm.Discard",callback:()=>{this.onHelperCancel(void 0,!0)}}],descriptionLangKey:"Chat.Edit.Cancel.Text"}).show();return}}else this.helperType==="reply"&&this.saveDraftDebounced();this.clearHelper(),this.updateSendBtn()},this.onHelperClick=n=>{if(X(n),!U(n.target,"reply"))return;let a;this.helperType==="forward"?a=this.forwardElements?.container:this.helperType==="reply"?(this.chat.setMessageId({lastMsgId:this.replyToMsgId}),a=this.replyElements?.menuContainer):this.helperType==="edit"?this.chat.setMessageId({lastMsgId:this.editMsgId}):this.helperType||(a=this.webPageElements?.container),Ye&&a&&!a.classList.contains("active")&&$s.openBtnMenu(a)},this.listenerSetter=new Qt,this.hoverListenerSetter=new Qt,this.excludeParts={},this.isFocused=!1,this.emoticonsDropdown=zi}construct(){const e=this.className;this.chatInput=document.createElement("div"),this.chatInput.classList.add(Md,e,"hide"),this.inputContainer=document.createElement("div"),this.inputContainer.classList.add(`${Md}-container`,`${e}-container`),this.rowsWrapperWrapper=document.createElement("div"),this.rowsWrapperWrapper.classList.add("rows-wrapper-wrapper"),this.rowsWrapper=document.createElement("div"),this.rowsWrapper.classList.add(...["rows-wrapper",`${Md}-wrapper`,`${e}-wrapper`,this.chat.type!==Q.Stories&&"chat-rows-wrapper"].filter(Boolean)),this.rowsWrapperWrapper.append(this.rowsWrapper);const t=pw(!this.chat.isMainChat);this.rowsWrapper.append(t);const s=this.fakeRowsWrapper=document.createElement("div");s.classList.add("fake-wrapper","fake-rows-wrapper");const i=this.fakeSelectionWrapper=document.createElement("div");i.classList.add("fake-wrapper","fake-selection-wrapper"),this.inputContainer.append(this.rowsWrapperWrapper,s,i),this.chatInput.append(this.inputContainer),this.excludeParts.downButton||this.constructGoDownButton();const n=this.controlContainer=document.createElement("div");n.classList.add("chat-input-control","chat-input-wrapper"),this.inputContainer.append(n)}freezeFocused(e){this.freezedFocused!==e&&(this.freezedFocused=e,this.updateSendBtn())}createButtonIcon(...e){this.noRipple&&(e[1]??(e[1]={}),e[1].noRipple=!0);const t=Xe(...e);return t.tabIndex=-1,t}constructGoDownButton(){this.goDownBtn=gi({icon:"arrow_down",className:"bubbles-corner-button chat-secondary-button bubbles-go-down hide"}),this.inputContainer.append(this.goDownBtn),D(this.goDownBtn,e=>{X(e),this.chat.bubbles.onGoDownClick()},{listenerSetter:this.listenerSetter})}constructReplyElements(){this.replyElements.container=document.createElement("div"),this.replyElements.container.classList.add("reply-wrapper","rows-wrapper-row"),this.replyElements.iconBtn=this.createButtonIcon(""),this.replyElements.cancelBtn=this.createButtonIcon("close reply-cancel",{noRipple:!0}),this.replyElements.container.append(this.replyElements.iconBtn,this.replyElements.cancelBtn),D(this.replyElements.cancelBtn,this.onHelperCancel,{listenerSetter:this.listenerSetter}),D(this.replyElements.container,this.onHelperClick,{listenerSetter:this.listenerSetter});const e=[{icon:"replace",text:"ReplyToAnotherChat",onClick:()=>this.changeReplyRecipient()},this.replyElements.doNotReply={icon:"delete",text:"DoNotReply",onClick:this.onHelperCancel,danger:!0,separator:!0},this.replyElements.doNotQuote={icon:"delete",text:"DoNotQuote",onClick:this.onHelperCancel,danger:!0}],t=this.replyElements.menuContainer=Mn({buttons:e,listenerSetter:this.listenerSetter});Ye||(this.replyHover=new kl({element:t})),this.replyElements.container.append(t)}constructForwardElements(){const e=()=>{i=!0},t=()=>{i=!1},s=this.forwardElements={};let i=!1;const n=[s.showSender={text:"Chat.Alert.Forward.Action.Show1",onClick:e,checkForClose:()=>this.canToggleHideAuthor(),radioGroup:"author"},s.hideSender={text:"Chat.Alert.Forward.Action.Hide1",onClick:e,checkForClose:()=>this.canToggleHideAuthor(),radioGroup:"author"},s.showCaption={text:"Chat.Alert.Forward.Action.ShowCaption",onClick:t,radioGroup:"caption"},s.hideCaption={text:"Chat.Alert.Forward.Action.HideCaption",onClick:t,radioGroup:"caption"},s.changePeer={text:"Chat.Alert.Forward.Action.Another",onClick:()=>{this.changeForwardRecipient()},icon:"replace"},{icon:"delete",text:"DoNotForward",onClick:this.onHelperCancel,danger:!0}],a=s.container=Mn({buttons:n,radioGroups:[{name:"author",onChange:r=>{const l=!!+r;i&&(this.forwardWasDroppingAuthor=!l);const c=this.replyElements.container.querySelector(".reply-title");if(c){const d=c.firstElementChild,h=De.weakMap.get(d),u=s.showSender.checkboxField.checked?"Chat.Accessory.Forward":"Chat.Accessory.Hidden";h.key=u,h.update()}},checked:0},{name:"caption",onChange:r=>{const l=!!+r;let c;l&&this.forwardWasDroppingAuthor!==void 0?c=this.forwardWasDroppingAuthor?s.hideSender:s.showSender:c=l?s.showSender:s.hideSender,c.checkboxField.checked=!0},checked:0}],listenerSetter:this.listenerSetter});Ye||(this.forwardHover=new kl({element:a})),s.modifyArgs=n.slice(0,-2),this.replyElements.container.append(a)}constructWebPageElements(){this.webPageElements={};const e=[this.webPageElements.above={text:"AboveMessage",onClick:()=>{},radioGroup:"position"},this.webPageElements.below={text:"BelowMessage",onClick:()=>{},radioGroup:"position"},this.webPageElements.larger={text:"LargerMedia",onClick:()=>{},radioGroup:"size"},this.webPageElements.smaller={text:"SmallerMedia",onClick:()=>{},radioGroup:"size"},{text:"WebPage.RemovePreview",onClick:()=>{this.onHelperCancel()},icon:"delete",danger:!0}],t=this.webPageElements.container=Mn({buttons:e,radioGroups:[{name:"position",onChange:s=>{this.webPageOptions.invertMedia=!!+s,this.saveDraftDebounced?.()},checked:0},{name:"size",onChange:s=>{this.webPageOptions.largeMedia=!!+s,this.webPageOptions.smallMedia=!+s,this.saveDraftDebounced?.()},checked:0}],listenerSetter:this.listenerSetter});Ye||(this.webPageHover=new kl({element:t})),this.replyElements.container.append(t)}constructMentionButton(){this.goMentionBtn=gi({icon:"mention",className:"bubbles-corner-button chat-secondary-button bubbles-go-mention"}),this.goMentionUnreadBadge=Ao("span",24,"primary"),this.goMentionBtn.append(this.goMentionUnreadBadge),this.inputContainer.append(this.goMentionBtn),D(this.goMentionBtn,e=>{X(e);const t=this.getMiddleware();this.managers.appMessagesManager.goToNextMention(this.chat.peerId,this.chat.threadId).then(s=>{t()&&s&&this.chat.setMessageId({lastMsgId:s})})},{listenerSetter:this.listenerSetter})}constructScheduledButton(){this.btnScheduled=this.createButtonIcon("scheduled btn-scheduled float hide",{noRipple:!0}),D(this.btnScheduled,e=>{this.appImManager.openScheduled(this.chat.peerId)},{listenerSetter:this.listenerSetter}),this.listenerSetter.add(C)("scheduled_new",({peerId:e})=>{this.chat.peerId===e&&this.btnScheduled.classList.remove("hide")}),this.listenerSetter.add(C)("scheduled_delete",({peerId:e})=>{this.chat.peerId===e&&this.managers.appMessagesManager.getScheduledMessages(this.chat.peerId).then(t=>{this.btnScheduled.classList.toggle("hide",!t.length)})})}constructReplyMarkup(){this.btnToggleReplyMarkup=this.createButtonIcon("botcom toggle-reply-markup float hide",{noRipple:!0}),this.replyKeyboard=new Kp({appendTo:this.rowsWrapper,listenerSetter:this.listenerSetter,managers:this.managers,btnHover:this.btnToggleReplyMarkup,chatInput:this}),this.listenerSetter.add(this.replyKeyboard)("open",()=>this.btnToggleReplyMarkup.classList.add("active")),this.listenerSetter.add(this.replyKeyboard)("close",()=>this.btnToggleReplyMarkup.classList.remove("active"))}constructBotCommands(){this.botCommands=new Pk(this.rowsWrapper,this,this.managers),this.botCommandsToggle=document.createElement("div"),this.botCommandsToggle.classList.add("new-message-bot-commands"),this.botCommandsToggle.append(Le("webview","new-message-bot-commands-view-icon"));const e=document.createElement("div");e.classList.add("new-message-bot-commands-icon-scale");const t=this.botCommandsIcon=document.createElement("div");t.classList.add("animated-menu-icon","animated-menu-close-icon"),e.append(t),this.botCommandsView=document.createElement("div"),this.botCommandsView.classList.add("new-message-bot-commands-view"),this.botCommandsToggle.append(e,this.botCommandsView);let s=0,i=!1;D(this.botCommandsToggle,n=>{X(n);const a=this.chat.peerId.toUserId(),{botMenuButton:r}=this;if(r){if(i)return;const d=++s;i=!0,Promise.resolve().then(()=>{if(s===d)return this.chat.openWebApp({botId:a,url:r.url,buttonText:r.text,fromBotMenu:!0})}).finally(()=>{s===d&&(i=!1)});return}const l=this.getMiddleware();t.classList.contains("state-back")?(this.botCommands.toggle(!0),t.classList.remove("state-back")):(this.botCommands.setUserId(a,l),t.classList.add("state-back"))},{listenerSetter:this.listenerSetter}),this.botCommands.addEventListener("visible",()=>{t.classList.add("state-back")}),this.botCommands.addEventListener("hiding",()=>{t.classList.remove("state-back")})}constructRecorder(){const e=window.Recorder;if(e)try{this.recorder=new e({encoderSampleRate:48e3,monitorGain:0,numberOfChannels:1,recordingGain:1,reuseWorker:!0})}catch(t){console.error("Recorder constructor error:",t)}this.recorder&&(D(this.btnCancelRecord,this.onCancelRecordClick,{listenerSetter:this.listenerSetter}),this.recorder.onstop=()=>{this.setRecording(!1),this.chatInput.classList.remove("is-locked"),this.recordRippleEl.style.transform=""},this.recorder.ondataavailable=t=>{if(this.releaseMediaPlayback&&(this.releaseMediaPlayback(),this.releaseMediaPlayback=void 0),this.recordingOverlayListener&&(this.listenerSetter.remove(this.recordingOverlayListener),this.recordingOverlayListener=void 0),this.recordingNavigationItem&&(dt.removeItem(this.recordingNavigationItem),this.recordingNavigationItem=void 0),this.recordCanceled)return;const s=this.chat.getMessageSendingParams(),i=(Date.now()-this.recordStartTime)/1e3|0,n=new Blob([t],{type:"audio/ogg"});od.decode(t,!0).then(a=>{od.setKeepAlive(!1),this.managers.appMessagesManager.sendFile({...s,file:n,isVoiceMessage:!0,isMedia:!0,duration:i,waveform:a.waveform,objectURL:a.url,clearDraft:!0}),this.onMessageSent(!1,!0)})})}constructPeerHelpers(){this.excludeParts.reply||(this.constructReplyElements(),this.excludeParts.forwardOptions||(this.constructForwardElements(),this.constructWebPageElements())),this.newMessageWrapper=document.createElement("div"),this.newMessageWrapper.classList.add("new-message-wrapper","rows-wrapper-row"),this.excludeParts.emoticons||(this.btnToggleEmoticons=this.createButtonIcon("smile toggle-emoticons",{noRipple:!0})),this.inputMessageContainer=document.createElement("div"),this.inputMessageContainer.classList.add("input-message-container"),this.goDownBtn&&(this.goDownUnreadBadge=Ao("span",24,"primary"),this.goDownBtn.append(this.goDownUnreadBadge)),this.excludeParts.mentionButton||this.constructMentionButton(),this.excludeParts.scheduled||this.constructScheduledButton(),this.excludeParts.replyMarkup||this.constructReplyMarkup(),this.excludeParts.botCommands||this.constructBotCommands();let e;const t=(a,r,l)=>{const c=e=Rt();this.fileInput.value="",c.finally(()=>{aa.removeEventListener("change",d)});const d=h=>{if(c!==e){c.reject();return}h||setTimeout(()=>{c.reject()},1e3)};if(aa.addEventListener("change",d),a)this.fileInput.removeAttribute("accept"),this.willAttachType="document";else{const h=[...r?Wd:[],...l?_d:[]].join(", ");this.fileInput.setAttribute("accept",h),this.willAttachType="media"}this.fileInput.click(),this.onFileSelection?.(e)};this.attachMenuButtons=[{icon:"image",text:"Chat.Input.Attach.PhotoOrVideo",onClick:()=>t(!1,!0,!0)},{icon:"document",text:"Chat.Input.Attach.Document",onClick:()=>t(!0)},{icon:"gift",text:"GiftPremium",onClick:()=>this.chat.appImManager.giftPremium(this.chat.peerId),verify:()=>this.chat&&Promise.all([this.chat.canGiftPremium(),this.managers.apiManager.getAppConfig()]).then(([a,{premium_gift_attach_menu_icon:r}])=>a&&r)},{icon:"poll",text:"Poll",onClick:async()=>{const a="send_polls";if(!await this.chat.canSend(a)){Re({langPackKey:or[a]});return}J.createPopup(pk,this.chat).show()},verify:()=>this.chat.peerId.isAnyChat()||this.chat.isBot}];const s=this.attachMenuButtons.slice();this.attachMenu=yi({buttonOptions:{noRipple:!0},listenerSetter:this.listenerSetter,direction:"top-left",buttons:this.attachMenuButtons,onOpenBefore:this.excludeParts.attachMenu?void 0:async()=>{const a=await this.managers.appAttachMenuBotsManager.getAttachMenuBots(),r=s.slice(),l=a.filter(c=>c.pFlags.show_in_attach_menu).map(c=>{const d=Vw(c);return{regularText:Pe(c.short_name),onClick:()=>{this.chat.openWebApp({attachMenuBot:c,fromAttachMenu:!0})},iconDoc:d?.icon,verify:async()=>{let u=!1;const p={attachMenuPeerTypeSameBotPM:()=>this.chat.peerId.toUserId()===c.bot_id,attachMenuPeerTypeBotPM:()=>this.chat.isBot,attachMenuPeerTypePM:()=>this.chat.peerId.isUser(),attachMenuPeerTypeChat:()=>this.chat.isAnyGroup,attachMenuPeerTypeBroadcast:()=>this.chat.isBroadcast};for(const m of c.peer_types){const g=p[m._];if(u=await g(),u)break}return u}}});r.splice(r.length,0,...l),this.attachMenuButtons.splice(0,this.attachMenuButtons.length,...r)},onOpen:()=>{this.emoticonsDropdown?.toggle(!1),this.onMenuToggle?.(!0)},onClose:()=>{this.onMenuToggle?.(!1)}}),this.attachMenu.classList.add("attach-file"),this.attachMenu.firstElementChild.replaceWith(Le("attach")),this.recordTimeEl=document.createElement("div"),this.recordTimeEl.classList.add("record-time"),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.multiple=!0,this.fileInput.style.display="none",this.newMessageWrapper.append(...[this.botCommandsToggle,this.btnToggleEmoticons,this.inputMessageContainer,this.btnScheduled,this.btnToggleReplyMarkup,this.attachMenu,this.recordTimeEl,this.fileInput].filter(Boolean)),this.replyElements?.container&&this.rowsWrapper.append(this.replyElements.container),this.autocompleteHelperController=new Sk,this.stickersHelper=new yk(this.rowsWrapper,this.autocompleteHelperController,this.chat,this.managers),this.emojiHelper=new vk(this.rowsWrapper,this.autocompleteHelperController,this,this.managers),this.excludeParts.commandsHelper||(this.commandsHelper=new wk(this.rowsWrapper,this.autocompleteHelperController,this,this.managers)),this.mentionsHelper=new Ck(this.rowsWrapper,this.autocompleteHelperController,this,this.managers),this.inlineHelper=new Lk(this.rowsWrapper,this.autocompleteHelperController,this.chat,this.managers),this.rowsWrapper.append(this.newMessageWrapper),this.btnCancelRecord=this.createButtonIcon("binfilled btn-circle btn-record-cancel chat-input-secondary-button chat-secondary-button"),this.btnSendContainer=document.createElement("div"),this.btnSendContainer.classList.add("btn-send-container"),this.recordRippleEl=document.createElement("div"),this.recordRippleEl.classList.add("record-ripple"),this.btnSend=this.createButtonIcon(),this.btnSend.classList.add("btn-circle","btn-send","animated-button-icon");const i=[["send","send"],["schedule","schedule"],["check","edit"],["microphone_filled","record"],["forward_filled","forward"]];this.btnSend.append(...i.map(([a,r])=>Le(a,"animated-button-icon-icon","btn-send-icon-"+r))),this.btnSendContainer.append(this.recordRippleEl,this.btnSend),this.sendMenu=new ig({onSilentClick:()=>{this.sendSilent=!0,this.sendMessage()},onScheduleClick:()=>{this.scheduleSending(void 0)},onSendWhenOnlineClick:()=>{this.setScheduleTimestamp(Vl,this.sendMessage.bind(this,!0))},listenerSetter:this.listenerSetter,openSide:"top-left",onContextElement:this.btnSend,onOpen:()=>{const a=this.chat.type!==Q.Scheduled&&(!this.isInputEmpty()||!!Object.keys(this.forwarding).length);return a&&this.emoticonsDropdown?.toggle(!1),a},canSendWhenOnline:this.canSendWhenOnline}),this.btnSendContainer.append(this.sendMenu.sendMenu),this.inputContainer.append(...[this.btnReaction,this.btnCancelRecord,this.btnSendContainer].filter(Boolean)),this.btnToggleEmoticons&&(this.emoticonsDropdown.attachButtonListener(this.btnToggleEmoticons,this.listenerSetter),this.listenerSetter.add(this.emoticonsDropdown)("open",this.onEmoticonsOpen),this.listenerSetter.add(this.emoticonsDropdown)("close",this.onEmoticonsClose)),this.attachMessageInputField(),this.listenerSetter.add(C)("settings_updated",()=>{(this.stickersHelper||this.emojiHelper)&&(this.previousQuery="",this.checkAutocomplete()),this.messageInputField?.onFakeInput()}),this.chat&&this.setChatListeners(),this.constructRecorder(),this.updateSendBtn(),this.listenerSetter.add(this.fileInput)("change",a=>{const r=a.target.files,l=Array.from(r).slice();e.resolve(l),l.length&&(J.createPopup(Ra,this.chat,l,this.willAttachType),this.fileInput.value="")},!1),D(this.btnSend,this.onBtnSendClick,{listenerSetter:this.listenerSetter,touchMouseDown:!0}),this.saveDraftDebounced=Zs(()=>this.saveDraft(),2500,!1,!0);const n=a=>{const r=Ve("btn-primary btn-transparent text-bold chat-input-control-button");return r.append(a instanceof HTMLElement?a:_(a)),r};this.botStartBtn=n("BotStart"),this.unblockBtn=n("Unblock"),this.joinBtn=this.chat.topbar&&n("ChannelJoin"),this.onlyPremiumBtnText=new De.IntlElement({key:"Chat.Input.PremiumRequiredButton",args:[0,document.createElement("a")]}),this.onlyPremiumBtn=n(this.onlyPremiumBtnText.element),D(this.botStartBtn,this.startBot,{listenerSetter:this.listenerSetter}),D(this.unblockBtn,this.unblockUser,{listenerSetter:this.listenerSetter}),D(this.onlyPremiumBtn,()=>{ps.show()},{listenerSetter:this.listenerSetter}),this.joinBtn&&D(this.joinBtn,this.chat.topbar.onJoinClick.bind(this.chat.topbar,this.joinBtn),{listenerSetter:this.listenerSetter}),this.pinnedControlBtn=Ve("btn-primary btn-transparent text-bold chat-input-control-button",{icon:"unpin"}),this.listenerSetter.add(this.pinnedControlBtn)("click",()=>{const a=this.chat.peerId;J.createPopup(dc,a,0,!0,()=>{this.chat.appImManager.setPeer();const r=this.chat.appImManager.chat;r.topbar.pinnedMessage&&r.topbar.pinnedMessage.pinnedMessageContainer.toggle(!0)})}),this.openChatBtn=n("OpenChat"),D(this.openChatBtn,()=>{this.chat.appImManager.setInnerPeer({peerId:this.chat.threadId})},{listenerSetter:this.listenerSetter}),this.controlContainer.append(...[this.botStartBtn,this.unblockBtn,this.joinBtn,this.onlyPremiumBtn,this.replyInTopicOverlay,this.pinnedControlBtn,this.openChatBtn].filter(Boolean))}setChatListeners(){this.listenerSetter.add(C)("draft_updated",({peerId:e,threadId:t,draft:s,force:i})=>{this.chat.threadId!==t||this.chat.peerId!==e||jr.has(this.chat.type)||this.setDraft(s,!0,i)}),this.listenerSetter.add(this.appImManager)("peer_changing",e=>{this.chat===e&&(this.chat.type===Q.Chat||this.chat.type===Q.Discussion)&&this.saveDraft()}),this.listenerSetter.add(this.appImManager)("chat_changing",({from:e,to:t})=>{this.chat===e?this.autocompleteHelperController.toggleListNavigation(!1):this.chat===t&&this.autocompleteHelperController.toggleListNavigation(!0)}),this.listenerSetter.add(C)("scheduled_delete",({peerId:e,mids:t})=>{this.chat.type===Q.Scheduled&&this.chat.peerId===e&&t.includes(this.editMsgId)&&this.onMessageSent()}),this.listenerSetter.add(C)("history_delete",({peerId:e,msgs:t})=>{this.chat.peerId===e&&!jr.has(this.chat.type)&&(t.has(this.editMsgId)&&this.onMessageSent(),this.replyToMsgId&&t.has(this.replyToMsgId)&&this.clearHelper("reply"))}),this.listenerSetter.add(C)("dialogs_multiupdate",e=>{e.has(this.chat.peerId)&&(this.chat.type===Q.Chat||this.chat.type===Q.Discussion)&&(this.startParam===Yy?this.setStartParam():this.center(!0))})}_center(e,t){if(!e&&!this.inputContainer.classList.contains("is-centering")||e===this.fakeWrapperTo)return;const s=e||this.fakeWrapperTo,i=!!e,n=this.fakeWrapperTo;let a="",r="",l;const c=s.getBoundingClientRect(),d=this.fakeRowsWrapper.getBoundingClientRect(),h=d.width,u=c.width;if(h!==u){const m=u/h,g=(h-u)/2;l=c.left-d.left-g,i&&(a=`translateX(${l}px) scaleX(${m})`,m<1&&(r=""+(16+16*(1-m))+"px"))}this.fakeWrapperTo=e;const p=t?200:0;return vt({element:this.inputContainer,className:"is-centering",forwards:i,duration:p}),vt({element:this.rowsWrapperWrapper,className:"is-centering-to-control",forwards:!!(i&&e&&e.classList.contains("chat-input-control")),duration:p}),this.rowsWrapper.style.transform=a,this.rowsWrapper.style.borderRadius=r,{transform:a,borderRadius:r,needTranslateX:n&&(e&&e.classList.contains("chat-input-control")&&n===this.fakeSelectionWrapper||n.classList.contains("chat-input-control"))?l*-.5:l,widthFrom:h,widthTo:u}}async center(e=!1){return this._center(await this.getNeededFakeContainer(),e)}setStartParam(e){this.startParam!==e&&(this.startParam=e,this.center(!0))}isReplyInTopicOverlayNeeded(){return Nk}getJoinButtonType(){const{peerId:e,threadId:t}=this.chat;if(e.isUser())return;const s=fe.getChat(e.toChatId());if(!(!s||!s.pFlags.left||s.pFlags.broadcast)){if(s.pFlags.join_request)return"request";if(s.pFlags.join_to_send||!t)return"join"}}async getNeededFakeContainer(e=this.startParam){if(this.chat.selection?.isSelecting)return this.fakeSelectionWrapper;if(this.chat.type===Q.Pinned||this.chat.type===Q.Saved&&this.chat.threadId!==this.chat.peerId||await this.chat.isStartButtonNeeded()||this.isReplyInTopicOverlayNeeded()||this.chat.peerId.isUser()&&(this.chat.isUserBlocked||this.chat.isPremiumRequired)||this.getJoinButtonType())return this.controlContainer}getReadyToSend(e){return this.chat.type===Q.Scheduled?(this.scheduleSending(e),!0):(e(),!1)}setScheduleTimestamp(e,t){const s=this.getMiddleware(),i=(Date.now()/1e3|0)+10;e<=i&&(e=void 0),this.scheduleDate=e,t(),this.chat.type!==Q.Scheduled&&this.chat.type!==Q.Stories&&e&&setTimeout(()=>{if(!s())return;J.getPopups(Pn).forEach(a=>a.hide()),this.appImManager.openScheduled(this.chat.peerId)},0)}getMiddleware(...e){return this.chat.bubbles.getMiddleware(...e)}async setUnreadCount(){if(!this.goDownUnreadBadge)return;const e=await this.managers.dialogsStorage.getAnyDialog(this.chat.peerId,this.chat.type===Q.Discussion?void 0:this.chat.threadId);if(Dn(e))return;const t=e?.unread_count;hc(this.goDownUnreadBadge,""+(t||""));const s=await this.managers.appNotificationsManager.isPeerLocalMuted({peerId:this.chat.peerId,respectType:!0,threadId:this.chat.threadId});if(this.goDownUnreadBadge.classList.toggle("badge-gray",s),this.goMentionUnreadBadge&&this.chat.type===Q.Chat){const i=!!(e?.unread_mentions_count&&e.unread_count);hc(this.goMentionUnreadBadge,i?""+e.unread_mentions_count:""),this.goMentionBtn.classList.toggle("is-visible",i)}}getCurrentInputAsDraft(e){const{value:t,entities:s}=sn(this.messageInputField.input,!0,!1);let i;if(t.length||e||this.replyToMsgId||this.willSendWebPage){const n=this.willSendWebPage,a=this.webPageOptions,r=!!n?.pFlags?.has_large_media,l=this.getReplyTo();i={_:"draftMessage",date:Es(!0),message:t,entities:s.length?s:void 0,pFlags:{no_webpage:this.noWebPage,invert_media:a?.invertMedia||void 0},reply_to:l?{_:"inputReplyToMessage",reply_to_msg_id:l.replyToMsgId,top_msg_id:this.chat.threadId,reply_to_peer_id:l.replyToPeerId,...l.replyToQuote&&{quote_text:l.replyToQuote.text,quote_entities:l.replyToQuote.entities,quote_offset:l.replyToQuote.offset}}:void 0,media:n?{_:"inputMediaWebPage",pFlags:{force_large_media:r&&a?.largeMedia||void 0,force_small_media:r&&a?.smallMedia||void 0,optional:!0},url:n.url}:void 0}}return i}saveDraft(){if(!this.chat.peerId||this.editMsgId||jr.has(this.chat.type))return;const e=this.getCurrentInputAsDraft();this.managers.appDraftsManager.syncDraft(this.chat.peerId,this.chat.threadId,e)}mentionUser(e,t){Promise.resolve(this.managers.appUsersManager.getUser(e)).then(s=>{let i="",n;const a=si(s);a[0]?i="@"+a[0]:(i=s.first_name||s.last_name,n={_:"messageEntityMentionName",length:i.length,offset:0,user_id:s.id}),i+=" ",this.insertAtCaret(i,n,t)})}destroy(){this.listenerSetter.removeAll(),this.setCurrentHover()}cleanup(e=!0){this.chat&&!this.chat.peerId&&(this.chatInput.classList.add("hide"),this.goDownBtn.classList.add("hide")),rr(),this.lastTimeType=0,this.startParam=void 0,this.toggleControlButtonDisability&&(this.toggleControlButtonDisability(),this.toggleControlButtonDisability=void 0),this.messageInput&&(this.clearInput(),e&&this.clearHelper())}async setDraft(e,t=!0,s=!1){if(!s&&!hp(this.messageInput)||jr.has(this.chat.type))return!1;if(!e&&(e=await this.managers.appDraftsManager.getDraft(this.chat.peerId,this.chat.threadId),!e))return s&&(this.chat.container.classList.contains("is-helper-active")&&this.t(),this.messageInputField.inputFake.textContent="",this.messageInputField.onFakeInput(!1),(this.chat.bubbles.messagesQueuePromise||Promise.resolve()).then(()=>{vs(()=>{this.onMessageSent()})})),!1;const i=Uw(e,{wrappingForPeerId:this.chat.peerId}),n=this.getCurrentInputAsDraft(),a=e.reply_to,r=a?.reply_to_msg_id;return gy(e,n)?!1:(t&&this.clearHelper(),this.noWebPage=e.pFlags.no_webpage,r&&this.initMessageReply({replyToMsgId:r,replyToPeerId:a.reply_to_peer_id&&Je(a.reply_to_peer_id),replyToQuote:a.quote_text&&{text:a.quote_text,entities:a.quote_entities,offset:a.quote_offset}}),this.setInputValue(i,t,t,e),!0)}createSendAs(){if(this.sendAsPeerId=void 0,this.chat&&(this.chat.type===Q.Chat||this.chat.type===Q.Discussion)){let e=!0;this.sendAs=new Ek(this.managers,(t,s)=>{let i=0;t.parentElement||(this.newMessageWrapper.prepend(t),i=2),this.updateOffset("as",!0,s,i)},t=>{if(this.sendAsPeerId=t,e){e=!1;return}this.getPlaceholderParams().then(s=>{this.updateMessageInputPlaceholder(s)})})}else this.sendAs=void 0;return this.sendAs}async finishPeerChange(e){const{peerId:t,startParam:s,middleware:i}=e,{forwardElements:n,btnScheduled:a,replyKeyboard:r,sendMenu:l,goDownBtn:c,chatInput:d,botCommandsToggle:h,attachMenu:u}=this,p=this.sendAs,m=this.createSendAs(),g=this.filterAttachMenuButtons(),[f,y,v,b,w,S,I,L,M,P,E]=await Promise.all([this.managers.appPeersManager.isBroadcast(t),this.managers.appPeersManager.canPinMessage(t),this.managers.appPeersManager.isBot(t),this.chat?.canSend("send_messages")||!0,this.chat?.canSend("send_plain")||!0,this.getNeededFakeContainer(s),Ro(this.managers.acknowledged.appProfileManager.getProfileByPeerId(t)),a?Ro(this.managers.acknowledged.appMessagesManager.getScheduledMessages(t)):void 0,m?(m.setPeerId(t),m.updateManual(!0)):void 0,Oe({peerId:t,onlyFirstName:!0}),this.chat.isPremiumRequiredToContact()]),k=this.messageInput?await this.getPlaceholderParams(w):void 0;return()=>{if(d.classList.remove("hide"),c&&(c.classList.toggle("is-broadcast",f),c.classList.remove("hide")),this.goDownUnreadBadge&&this.setUnreadCount(),this.chat?.type===Q.Pinned&&d.classList.toggle("can-pin",y),n&&(this.forwardWasDroppingAuthor=!1,n.showCaption.checkboxField.setValueSilently(!0),n.showSender.checkboxField.setValueSilently(!0)),a&&L&&(a.classList.add("hide"),Xs(L.result,x=>{!i()||!x||a.classList.toggle("hide",!x.length)})),this.newMessageWrapper&&this.updateOffset(null,!1,!0),h&&(this.hasBotCommands=void 0,this.botMenuButton=void 0,this.botCommands.toggle(!0,void 0,!0),this.updateBotCommandsToggle(!0),h.remove(),v)){const x=I.result;Xs(x,T=>{i()&&this.updateBotCommands(T,!(x instanceof Promise))})}p?.destroy(),M?.(),r?.setPeer(t),l?.setPeerId(t);let A=!1;if(this.chat&&this.joinBtn){const x=this.getJoinButtonType(),T=!A&&!!x;A||(A=T),this.joinBtn.classList.toggle("hide",!T),this.joinBtn.replaceChildren(_(x==="request"?"ChannelJoinRequest":"ChannelJoin"))}if(this.chat&&this.pinnedControlBtn){const x=!A&&this.chat.type===Q.Pinned;A||(A=x),this.pinnedControlBtn.classList.toggle("hide",!x),this.pinnedControlBtn.replaceChildren(_(y?"Chat.Input.UnpinAll":"Chat.Pinned.DontShow"))}if(this.chat&&this.openChatBtn){const x=!A&&this.chat.type===Q.Saved;A||(A=x),this.openChatBtn.classList.toggle("hide",!x)}if(this.chat&&this.onlyPremiumBtn){const x=!A&&!v&&t.isUser()&&E;A||(A=x),this.onlyPremiumBtnText.compareAndUpdate({args:[P,this.onlyPremiumBtnText.args[1]]}),this.onlyPremiumBtn.classList.toggle("hide",!x)}if(this.chat){const x=!A&&!v&&t.isUser();A||(A=x),this.unblockBtn.classList.toggle("hide",!x)}this.botStartBtn.classList.toggle("hide",A),this.messageInput&&(this.updateMessageInput(b||A,w,k),this.messageInput.dataset.peerId=""+t,g&&u&&g.then(x=>{i()&&(u.toggleAttribute("disabled",!x.length),u.classList.toggle("btn-disabled",!x.length))})),this.messageInputField?.onFakeInput(void 0,!0),this.startParam=s,this._center(S,!1)}}updateOffset(e,t,s,i,n){const a=this.hasOffset,r={type:e,forwards:t};Li(a,r)&&!n||(this.hasOffset=r,e?this.newMessageWrapper.dataset.offset=e:delete this.newMessageWrapper.dataset.offset,!(a?.forwards===r.forwards&&!n)&&vt({element:this.newMessageWrapper,className:"has-offset",forwards:t,duration:s?0:300,useRafs:i}))}updateBotCommands(e,t){const s=e.bot_info,i=s?.menu_button;this.hasBotCommands=!!s?.commands?.length,this.botMenuButton=i?._==="botMenuButton"?i:void 0,tt(this.botCommandsView,this.botMenuButton?Pe(this.botMenuButton.text):""),this.botCommandsIcon.classList.toggle("hide",!!this.botMenuButton),this.botCommandsView.classList.toggle("hide",!this.botMenuButton),this.botCommandsToggle.classList.toggle("is-view",!!this.botMenuButton),this.updateBotCommandsToggle(t)}updateBotCommandsToggle(e){const{botCommandsToggle:t,hasBotCommands:s,botMenuButton:i}=this,n=!!(s||i),a=this.isInputEmpty(),r=n&&(a||!!i);if(!n){if(!t.parentElement)return;t.remove()}const l=r,c=t.parentElement?0:2;if(i&&a){const d=Zl(i.text,fm)+22+20+6;this.newMessageWrapper.style.setProperty("--commands-size",`${Math.ceil(d)}px`)}else this.newMessageWrapper.style.removeProperty("--commands-size");t.parentElement||this.newMessageWrapper.prepend(t),this.updateOffset("commands",l,e,c,!0)}async getPlaceholderParams(e){e??(e=await this.chat.canSend("send_plain"));const{peerId:t,threadId:s,isForum:i,type:n}=this.chat;let a,r;if(!e)a="Channel.Persmission.MessageBlock";else if(s&&!i&&!t.isUser())a="Comment";else if(await this.managers.appPeersManager.isBroadcast(t))a="ChannelBroadcast";else if(this.sendAsPeerId!==void 0&&this.sendAsPeerId!==C.myId||await this.managers.appMessagesManager.isAnonymousSending(t))a="SendAnonymously";else if(n===Q.Stories)a="Story.ReplyPlaceholder";else if(i&&n===Q.Chat&&!s){const l=await this.managers.dialogsStorage.getForumTopic(t,Co);l?(a="TypeMessageIn",r=[Pe(l.title)]):a="Message"}else a="Message";return{key:a,args:r}}updateMessageInputPlaceholder({key:e,args:t=[]}){const s=De.weakMap.get(this.messageInputField.placeholder);if(!s)return;const i=s.key,n=s.args;return s.compareAndUpdate({key:e,args:t}),{oldKey:i,oldArgs:n}}filterAttachMenuButtons(){if(this.attachMenuButtons)return Ti(this.attachMenuButtons,e=>e.verify?e.verify():!0)}updateMessageInput(e,t,s){const{chatInput:i,messageInput:n}=this;i.classList.contains("is-hidden")!==!e&&(i.classList.add("no-transition"),i.classList.toggle("is-hidden",!e),i.offsetLeft,i.classList.remove("no-transition"));const l=e&&!t&&this.restoreInputLock;!l&&this.updateMessageInputPlaceholder(s),l?this.restoreInputLock=()=>{this.updateMessageInputPlaceholder(s),this.messageInput.contentEditable="false"}:!e||!t?(n.contentEditable="false",t||this.messageInputField.onFakeInput(void 0,!0)):(this.restoreInputLock=void 0,n.contentEditable="true",this.setDraft(void 0,!1),n.innerHTML||this.messageInputField.onFakeInput(void 0,!0)),this.updateSendBtn()}attachMessageInputField(){const e=this.messageInputField;this.messageInputField=new fb({placeholder:"Message",name:"message",withLinebreaks:!0}),this.messageInputField.input.tabIndex=-1,this.messageInputField.input.classList.replace("input-field-input","input-message-input"),this.messageInputField.inputFake.classList.replace("input-field-input","input-message-input"),this.messageInput=this.messageInputField.input,this.attachMessageInputListeners(),this.messageInput,bC&&wC(this.messageInput),e?(e.input.replaceWith(this.messageInputField.input),e.placeholder.replaceWith(this.messageInputField.placeholder),e.inputFake.replaceWith(this.messageInputField.inputFake)):this.inputMessageContainer.append(this.messageInputField.input,this.messageInputField.placeholder,this.messageInputField.inputFake)}attachMessageInputListeners(){this.listenerSetter.add(this.messageInput)("keydown",e=>{const t=e.key;if(jS(e))X(e),this.sendMessage();else if(e.ctrlKey||e.metaKey)Dk(this.messageInput,e);else if((t==="PageUp"||t==="PageDown")&&!e.shiftKey)if(e.preventDefault(),t==="PageUp"){const s=document.createRange(),i=window.getSelection();s.setStart(this.messageInput.childNodes[0]||this.messageInput,0),s.collapse(!0),i.removeAllRanges(),i.addRange(s)}else Qs(this.messageInput)}),D(this.messageInput,e=>{this.canSendPlain()||Re({langPackKey:or.send_plain})},{listenerSetter:this.listenerSetter}),Ye&&D(this.messageInput,e=>{if(this.emoticonsDropdown.isActive()){this.emoticonsDropdown.toggle(!1),un(),X(e);return}this.chat.isStandalone||this.appImManager.selectTab(No.CHAT)},{listenerSetter:this.listenerSetter}),this.listenerSetter.add(this.messageInput)("input",this.onMessageInput),this.listenerSetter.add(this.messageInput)("keyup",()=>{this.checkAutocomplete()}),this.listenerSetter.add(this.messageInput)("focusin",()=>{this.isFocused=!0,(this.chat.type===Q.Chat||this.chat.type===Q.Discussion)&&this.chat.bubbles.scrollable.loadedAll.bottom&&this.managers.appMessagesManager.readAllHistory(this.chat.peerId,this.chat.threadId),this.onFocusChange?.(!0)}),this.listenerSetter.add(this.messageInput)("focusout",()=>{this.isFocused=!1,this.onFocusChange?.(!1)})}canSendPlain(){return this.messageInput.isContentEditable&&!this.chatInput.classList.contains("is-hidden")}processWebPage(e,t,s=this.processingDraftMessage||this.editMessage){const i=s?.media,n=s?.pFlags?.invert_media,a=i?._==="inputMediaWebPage"?i.url:i?.webpage?.url,r=(!i||a)&&t.filter(h=>h._==="messageEntityUrl"||h._==="messageEntityTextUrl");if(!r?.length){this.lastUrl&&(this.lastUrl="",delete this.noWebPage,this.willSendWebPage=null,this.helperType?this.helperFunc():this.clearHelper());return}let l=a;if(!l)for(const h of r){let u;if(h._==="messageEntityTextUrl")u=h.url;else if(u=e.slice(h.offset,h.offset+h.length),!(u.includes("http://")||u.includes("https://")))continue;l=u;break}if(this.lastUrl===l)return;if(!l){this.willSendWebPage&&this.onHelperCancel();return}this.lastUrl=l;const c=a,d=this.getWebPagePromise=Promise.all([this.managers.appWebPagesManager.getWebPage(l),this.chat.canSend("embed_links")]).then(([h,u])=>{if(this.getWebPagePromise===d&&(this.getWebPagePromise=void 0),this.lastUrl===l)if(h?._==="webPage"&&u){const p=this.setTopInfo({type:"webpage",callerFunc:()=>{},title:h.site_name||h.title||"Webpage",subtitle:h.description||h.url||""});if(this.setCurrentHover(this.webPageHover,p),delete this.noWebPage,this.willSendWebPage=h,this.webPageElements){const m=c&&n?this.webPageElements.above:this.webPageElements.below;m.checkboxField.checked=!0;const g=c&&i.pFlags.force_small_media?this.webPageElements.smaller:this.webPageElements.larger;g.checkboxField.checked=!0,g.element.parentElement.classList.toggle("hide",!h.pFlags.has_large_media)}this.webPageOptions={optional:!0,...c?{invertMedia:c&&n||void 0,smallMedia:c&&i.pFlags.force_small_media||void 0,largeMedia:c&&i.pFlags.force_large_media||void 0}:{}}}else this.willSendWebPage&&this.onHelperCancel()})}insertAtCaret(e,t,s=!0){if(!this.canSendPlain()){Re({langPackKey:or.send_plain});return}Cm.getInstance().makeFocused(this.messageInput);const{value:i,caretPos:n,entities:a}=sn(this.messageInput),r=n>=0?n:i.length,l=i.substr(0,r);i.substr(r);const c=s?l.match(Nl.AUTO_COMPLETE_REG_EXP):null,d=c?c.index+(c[0].length-c[2].length):l.length;if(l.slice(0,d),s&&n!==-1){const h=c?c[2]:i,u=document.getSelection();let p=0;for(;u.toString()!==h;){if(++p>=1e4)throw new Error("lolwhat");u.modify("extend","backward","character")}}iI(this.messageInput,e,t?[t]:void 0,this.chat.peerId)}async checkAutocomplete(e,t,s){const i=e!==void 0;if(!i){const l=sn(this.messageInputField.input,!0,!0);e=l.value,t=l.caretPos,s=l.entities}if(t===-1&&(t=e.length),s===void 0||!i){const l=my(e,s,!0);s=oo(s,ro(l))}if(e=e.slice(0,t),this.previousQuery===e)return;this.previousQuery=e;const n=e.match(Nl.AUTO_COMPLETE_REG_EXP);let a;if(n){const l=s[0];let c=n[2];const d=c[0];if(this.stickersHelper&&C.settings.stickers.suggest!=="none"&&await this.chat.canSend("send_stickers")&&l?._==="messageEntityEmoji"&&l.length===e.length&&!l.offset)a=this.stickersHelper,this.stickersHelper.checkEmoticon(e);else if(d==="@"){const h=this.chat.threadId?Gi(this.chat.threadId):void 0;this.mentionsHelper.checkQuery(c,this.chat.peerId.isUser()?Vt:this.chat.peerId,h,this.globalMentions)&&(a=this.mentionsHelper)}else!n[1]&&d==="/"?this.commandsHelper&&await this.commandsHelper.checkQuery(c,this.chat.peerId)&&(a=this.commandsHelper):C.settings.emoji.suggest&&(c=c.replace(/^\s*/,""),!e.match(/^\s*:(.+):\s*$/)&&!e.match(/:[;!@#$%^&*()-=|]/)&&c&&(a=this.emojiHelper,this.emojiHelper.checkQuery(c,d)))}let r;a||(r=await this.chat.canSend("send_inline")),a=this.checkInlineAutocomplete(e,r,a),this.autocompleteHelperController.hideOtherHelpers(a)}checkInlineAutocomplete(e,t,s){let i=!1;const n=a=>{this.btnPreloader&&(a&&!t&&(a=!1),vt({element:this.btnPreloader,className:"show",forwards:a,duration:400}))};if(!s){const a=e.match(/^@([a-zA-Z\\d_]{3,32})\s/);if(a){const r=a[1],l=e.slice(a[0].length);i=a[0].length===e.length,s=this.inlineHelper,this.btnPreloader?n(!0):(this.btnPreloader=this.createButtonIcon("none btn-preloader float show disable-hover",{noRipple:!0}),pn(this.btnPreloader,!0),this.inputMessageContainer.parentElement.insertBefore(this.btnPreloader,this.inputMessageContainer.nextSibling)),this.inlineHelper.checkQuery(this.chat.peerId,r,l,t).then(({user:c,renderPromise:d})=>{i&&c.bot_inline_placeholder&&(this.messageInput.dataset.inlinePlaceholder=c.bot_inline_placeholder),d.then(()=>{n(!1)})}).catch(c=>{n(!1)})}}return i||delete this.messageInput.dataset.inlinePlaceholder,s!==this.inlineHelper&&n(!1),s}setRecording(e){this.recording!==e&&(this.recording=e,this.setShrinking(this.recording,["is-recording"]),this.updateSendBtn(),this.onRecording?.(e))}setShrinking(e,t){e||(e=this.recording),vt({element:this.chatInput,className:"is-shrinking"+(t?" "+t.join(" "):""),forwards:e,duration:200})}setCanForwardStory(e){this.canForwardStory=e||!0,this.updateSendBtn()}changeForwardRecipient(){if(this.helperWaitingForward||!this.helperFunc)return;this.helperWaitingForward=!0;const e=Fi(this.forwarding),t=this.helperFunc;this.clearHelper(),this.updateSendBtn();let s=!1;J.createPopup(jn,e,()=>{s=!0}).addEventListener("close",()=>{this.helperWaitingForward=!1,s||t()})}async changeReplyRecipient(){if(this.helperWaitingReply)return;this.helperWaitingReply=!0;const e=this.getReplyTo();e.replyToPeerId??(e.replyToPeerId=this.chat.peerId);const t=this.helperFunc;this.clearHelper(),this.updateSendBtn();try{await this.createReplyPicker(e)}catch{t()}this.helperWaitingReply=!1}async createReplyPicker(e){const t=await _s.createReplyPicker();this.appImManager.setInnerPeer({peerId:t}).then(()=>{this.appImManager.chat.input.initMessageReply(e)})}getReplyTo(){if(!this.replyToMsgId&&!this.replyToStoryId)return;const{replyToMsgId:e,replyToStoryId:t,replyToQuote:s,replyToPeerId:i}=this;return{replyToMsgId:e,replyToStoryId:t,replyToQuote:s,replyToPeerId:i}}async clearInput(e=!0,t=!0,s=""){if(document.activeElement===this.messageInput&&Vn){const n=document.createElement("input");document.body.append(n),Ug(n),this.messageInputField.setValueSilently(s),Ug(this.messageInput),n.remove()}else this.messageInputField.setValueSilently(s);Ye||xk(this.messageInput);let i=!1;e&&(i=await this.setDraft(void 0,!1)),!i&&t&&this.onMessageInput()}isInputEmpty(){return hp(this.messageInput)}updateSendBtn(){let e;const t=this.isInputEmpty();this.chat.type===Q.Stories&&t&&!this.freezedFocused&&this.canForwardStory?e="forward":this.editMsgId?e="edit":!this.recorder||this.recording||!t||this.forwarding?e=this.chat.type===Q.Scheduled?"schedule":"send":e="record",["send","record","edit","schedule","forward"].forEach(s=>{this.btnSend.classList.toggle(s,e===s)}),this.btnScheduled&&this.btnScheduled.classList.toggle("show",t&&this.chat.type!==Q.Scheduled),this.btnToggleReplyMarkup&&this.btnToggleReplyMarkup.classList.toggle("show",t&&this.chat.type!==Q.Scheduled),this.onUpdateSendBtn?.(e)}getValueAndEntities(e){const{entities:t,value:s}=sn(e,!0,!1),i=ro(s),n=oo(t,i);return{value:s,totalEntities:n}}onMessageSent(e=!0,t){jr.has(this.chat.type)||this.managers.appMessagesManager.readAllHistory(this.chat.peerId,this.chat.threadId,!0),this.scheduleDate=void 0,this.sendSilent=void 0;const{totalEntities:s}=this.getValueAndEntities(this.messageInput);let i=0;s.filter(a=>{if(a._==="messageEntityEmoji"||a._==="messageEntityCustomEmoji"){const r=a.offset+a.length;return r<=i?!1:(i=r,!0)}return!1}).forEach(a=>{const r=a._==="messageEntityEmoji"?{emoji:Sm(a.unicode)}:{docId:a.document_id,emoji:""};this.managers.appEmojiManager.pushRecentEmoji(r)}),e&&(this.lastUrl="",delete this.noWebPage,this.willSendWebPage=null,this.clearInput()),(t||e)&&this.clearHelper(),this.updateSendBtn(),this.onMessageSent2?.()}sendMessage(e=!1){const{editMsgId:t,chat:s}=this;if(s.type===Q.Scheduled&&!e&&!t){this.scheduleSending();return}const{peerId:i}=s,{noWebPage:n}=this,a=this.chat.getMessageSendingParams(),{value:r,entities:l}=sn(this.messageInputField.input,!0,!1);if(t){const c=this.editMessage;if(r.trim()||c.media)this.managers.appMessagesManager.editMessage(c,r,{entities:l,noWebPage:n,webPage:this.getWebPagePromise?void 0:this.willSendWebPage,webPageOptions:this.webPageOptions}),this.onMessageSent();else{J.createPopup(jo,i,[t],s.type);return}}else r.trim()&&(this.managers.appMessagesManager.sendText({...a,text:r,entities:l,noWebPage:n,webPage:this.getWebPagePromise?void 0:this.willSendWebPage,webPageOptions:this.webPageOptions,clearDraft:!0}),jr.has(this.chat.type)?this.onMessageSent(!0):this.onMessageSent(!1,!1));if(this.forwarding){const c=Fi(this.forwarding);for(const d in c)this.managers.appMessagesManager.forwardMessages({...a,fromPeerId:d.toPeerId(),mids:c[d],dropAuthor:this.forwardElements&&this.forwardElements.hideSender.checkboxField.checked,dropCaptions:this.isDroppingCaptions()}).catch(async h=>{h.type==="VOICE_MESSAGES_FORBIDDEN"&&Re({langPackKey:"Chat.SendVoice.PrivacyError",langPackArguments:[await Oe({peerId:i})]})});r||this.onMessageSent()}}async sendMessageWithDocument(e,t=!1,s=!1,i=!1){e=await this.managers.appDocsManager.getDoc(e);const n=e.type==="sticker"?"send_stickers":e.type==="gif"?"send_gifs":"send_media";return this.chat.peerId.isAnyChat()&&!await this.chat.canSend(n)?(Re({langPackKey:or[n]}),!1):this.chat.type===Q.Scheduled&&!t?(this.scheduleSending(()=>this.sendMessageWithDocument(e,!0,s,i)),!1):e?e.sticker&&Nc(e)&&!C.premium?(ps.show({feature:"premium_stickers"}),!1):(this.managers.appMessagesManager.sendFile({...this.chat.getMessageSendingParams(),file:e,isMedia:!0,clearDraft:s,silent:i}),this.onMessageSent(s,!0),e.type==="sticker"&&this.managers.appStickersManager.saveRecentSticker(e.id),!0):!1}canToggleHideAuthor(){const{forwardElements:e}=this;if(!e)return!1;const t=e.hideCaption.checkboxField;return!t.checked||oi(t.label,"FORM").classList.contains("hide")}isDroppingCaptions(){return!this.canToggleHideAuthor()}initMessageEditing(e){const t=this.chat.getMessage(e);let s=Im(t.message,{entities:t.totalEntities,wrappingForPeerId:this.chat.peerId});const i=async()=>{let n;if(!this.messageInput.isContentEditable){const r=await this.getPlaceholderParams(!0),{contentEditable:l}=this.messageInput;this.messageInput.contentEditable="true";const{oldKey:c,oldArgs:d}=this.updateMessageInputPlaceholder(r);n=()=>{this.messageInput.contentEditable=l,this.updateMessageInputPlaceholder({key:c,args:d})}}const a=await Fa({message:t,usingMids:[t.mid]});this.setTopInfo({type:"edit",callerFunc:i,title:_("AccDescrEditing"),subtitle:a,input:s,message:t}),this.editMsgId=e,this.editMessage=t,s=void 0,this.restoreInputLock=n};i()}initMessagesForward(e){const t=async()=>{const s=Object.keys(e).map(S=>S.toPeerId()),i=new Set;let n=0,a=0;const r=s.map(async S=>{const I=e[S],L=I.map(async M=>{const P=await this.managers.appMessagesManager.getMessageByPeer(S,M);hn(P.fwd_from)&&!P.fromId&&!P.fwdFromId?i.add("N"+hn(P.fwd_from)):i.add("P"+P.fromId),P.media&&!["messageMediaWebPage"].includes(P.media._)&&P.message&&++a});await Promise.all(L),n+=I.length});await Promise.all(r);const l=i.size>2,c=[...i].map(S=>{const I=S[0];if(S=S.slice(1),I==="P"){const L=S.toPeerId();return L===C.myId?_("Chat.Accessory.Forward.You"):new Mt({peerId:L,dialog:!1,onlyFirstName:l}).element}else return l?S.split(" ")[0]:S}),{forwardElements:d}=this;oi(d.showCaption.checkboxField.label,"FORM").classList.toggle("hide",!a);const u=d.hideCaption.checkboxField.checked;a&&u?d.hideSender.checkboxField.setValueSilently(!0):this.forwardWasDroppingAuthor!==void 0&&(this.forwardWasDroppingAuthor?d.hideSender:d.showSender).checkboxField.setValueSilently(!0);const p=d.showSender.checkboxField.checked?"Chat.Accessory.Forward":"Chat.Accessory.Hidden",m=_(p,[n]),g=document.createDocumentFragment();c.length<3?g.append(...ci(c,!1)):g.append(c[0],_("AndOther",[c.length-1]));let f,y;if(s.length===1){const S=s[0],I=e[S];if(f=await this.managers.appMessagesManager.getMessageByPeer(S,I[0]),y=!!f.grouped_id,y){const L=await this.managers.appMessagesManager.getMidsByMessage(f);(L.length!==n||L.find(M=>!I.includes(M)))&&(y=!1)}}const v=document.createDocumentFragment(),b=": ";if(y||n===1){const S=e[s[0]],I=await Fa({message:f,usingMids:S});v.append(g,b,I)}else v.append(_("Chat.Accessory.Forward.From"),b,g);const w=this.setTopInfo({type:"forward",callerFunc:t,title:m,subtitle:v});d.modifyArgs.forEach((S,I)=>{const L=S.textElement,M=De.weakMap.get(L);M.args=[I<2?s.length:a],M.update()}),this.setCurrentHover(this.forwardHover,w),this.forwarding=e};t()}async initMessageReply(e){if(Li(this.getReplyTo(),e))return;let{replyToMsgId:t,replyToQuote:s,replyToPeerId:i}=e;i??(i=this.chat.peerId);let n=await(i?this.managers.appMessagesManager.getMessageByPeer(i,t):this.chat.getMessage(t));const a=()=>{let r,l;if(!n)r=_("Loading"),this.managers.appMessagesManager.reloadMessages(i,t).then(d=>{Li(this.getReplyTo(),e)&&(n=d,n?a():this.clearHelper("reply"))});else{const d=n.fromId;r=new Mt({peerId:n.fromId,dialog:!1,fromName:d?void 0:hn(n.fwd_from)}).element,r=_(s?"ReplyToQuote":"ReplyTo",[r])}const c=this.setTopInfo({type:"reply",callerFunc:a,title:r,subtitle:l,message:n,setColorPeerId:n?.fromId,quote:n?s:void 0});this.setReplyTo(e),this.replyElements.doNotReply.element.classList.toggle("hide",!!s),this.replyElements.doNotQuote.element.classList.toggle("hide",!s),this.setCurrentHover(this.replyHover,c)};a()}setCurrentHover(e,t){this.currentHover&&this.currentHover.toggle(!1),this.hoverListenerSetter.removeAll(),this.currentHover=e,e?.attachButtonListener(t,this.listenerSetter)}setReplyTo(e){const{replyToMsgId:t,replyToQuote:s,replyToPeerId:i,replyToStoryId:n}=e||{};this.replyToMsgId=t,this.replyToStoryId=n,this.replyToQuote=s,this.replyToPeerId=i,this.center(!0)}clearHelper(e){this.helperType==="edit"&&e!=="edit"&&this.clearInput(),e&&(this.lastUrl="",delete this.noWebPage,this.willSendWebPage=null),e!=="reply"&&(this.setReplyTo(void 0),this.forwarding=void 0),this.editMsgId=this.editMessage=void 0,this.helperType=this.helperFunc=void 0,this.setCurrentHover(),this.saveDraftDebounced(),this.restoreInputLock&&(this.restoreInputLock(),this.restoreInputLock=void 0),this.chat.container&&this.chat.container.classList.contains("is-helper-active")&&(dt.removeByType("input-helper"),this.chat.container.classList.remove("is-helper-active"),this.t())}t(){const e="is-toggling-helper";vt({element:this.chat.container,className:e,forwards:!0,duration:150,onTransitionEnd:()=>{this.chat.container.classList.remove(e)}})}setInputValue(e,t=!0,s=!0,i){e||(e=""),t?this.clearInput(!1,!1,e):this.messageInputField.setValueSilently(e),vs(()=>{s&&Qs(this.messageInput),this.processingDraftMessage=i,this.onMessageInput(),this.processingDraftMessage=void 0,this.messageInput.scrollTop=this.messageInput.scrollHeight})}setTopInfo({type:e,callerFunc:t,title:s,subtitle:i,setColorPeerId:n,input:a,message:r,quote:l}){if(this.willSendWebPage&&e==="reply")return;e!=="webpage"&&(this.clearHelper(e),this.helperType=e,this.helperFunc=t);const c=this.replyElements.container,d=c.lastElementChild.previousElementSibling,h=d.classList.contains("reply");this.replyElements.iconBtn.replaceWith(this.replyElements.iconBtn=this.createButtonIcon((e==="webpage"?"link":e)+" reply-icon",{noRipple:!0}));const{container:u}=Xh({title:s,subtitle:i,setColorPeerId:n,animationGroup:this.chat.animationGroup,message:r,textColor:"secondary-text-color",quote:l});return this.appImManager.setPeerColorToElement(n,c),h?d.replaceWith(u):c.lastElementChild.before(u),this.chat.container.classList.contains("is-helper-active")||(this.chat.container.classList.add("is-helper-active"),this.t()),mi||dt.pushItem({type:"input-helper",onPop:()=>{this.onHelperCancel()}}),a!==void 0&&this.setInputValue(a),setTimeout(()=>{this.updateSendBtn()},0),u}};Nl.AUTO_COMPLETE_REG_EXP=/(\s|^)((?:(?:@|^\/)\S*)|(?::|^[^:@\/])(?!.*[:@\/]).*)$/;let vh=Nl;function Ok(o){let e;return o.pFlags.close_friends?e="close":o.pFlags.public?e="public":o.pFlags.selected_contacts?e="selected":o.pFlags.contacts?e="contacts":o.privacy&&(o.privacy.some(t=>t._==="privacyValueAllowContacts")?e="contacts":e="selected"),e}function Kw(o,e){if(o.focus(),Qs(o),e){const t=new KeyboardEvent(e.type,e);o.dispatchEvent(t)}}function Uk(o){return!!o&&o.tagName==="INPUT"&&!["checkbox","radio"].includes(o.type)||o.isContentEditable}function fy(o){const e=o.fwd_from;let t;if(!(!e&&(t=(o.media_areas||[]).find(s=>s._==="mediaAreaChannelPost"),!t)))return{fwdFrom:e,mediaAreaChannelPost:t}}const Hk=He("<button>"),Zr=He("<span>"),bn=He("<div>"),Vk=He('<div><div class="tooltip-part tooltip-background"></div><span class="tooltip-part tooltip-notch"></span><div class="tooltip-part tooltip-text">'),$k=He("<a>"),Gk=He("<div><div></div><div>"),zk=He("<div><div><div dir=auto>"),yy=He("<div><span>"),Kk=He("<div><div><div></div><div><div></div><div></div><div><div><div><div></div><div></div></div></div><div>"),Wk=He("<div><div>"),Ww=5e3,qp=32,Ll=.33,Qp=2,jk=2,qk="storyrepost";let sr=Fc;C.addEventListener("app_config",o=>{const e=o.stories_changelog_user_id;sr=e?e.toPeerId(!1):Fc});const vy=new Nh(void 0,!0),Ii=()=>{const o=Gt();return Et(()=>o.destroy()),o},Cn=o=>{const[,e]=da(o,["icon","noRipple"]);return(()=>{const t=Hk();return $o(t,an(e,{get class(){return jt("btn-icon",o.class)},tabIndex:-1}),!1,!0),q(t,(()=>{const s=he(()=>!!o.icon);return()=>s()?Le(o.icon):o.children})()),t})()},kr=o=>{const[,e]=da(o,["icon"]);return(()=>{const t=Zr();return $o(t,an(e,{get class(){return jt("tgico",o.class)}}),!1,!0),q(t,()=>$y(o.icon)),t})()};function pg(o,e){const t=Zt(o),{onChange:s}=e;let i=new Set(e.appear?void 0:t);const n=new WeakSet,[a,r]=we([],{equals:!1}),[l]=qy(),c=e.exitMethod==="remove"?qt:u=>{r(p=>(p.push(...u),p));for(const p of u)n.delete(p)};let d;return e.exitMethod==="remove"?d=qt:e.exitMethod==="keep-index"?d=u=>u.elements.splice(u.previousIndex,0,u.element):e.exitMethod==="keep-relative"?d=u=>{let p;u.side==="start"?p=u.previousIndex:p=u.elements.length,u.elements.splice(p,0,u.element)}:d=u=>u.elements.push(u.element),he(u=>{const p=a(),m=o();if(m[SC],Zt(l))return l(),u;if(p.length){const g=u.filter(f=>!p.includes(f));return p.length=0,s({list:g,added:[],removed:[],unchanged:g,finishRemoved:c}),g}return Zt(()=>{const g=new Set(m),f=m.slice(),y=[],v=[],b=[];for(const I of m)(i.has(I)?b:y).push(I);const w={elements:f,previousElements:u,side:"start"};let S=!y.length;for(let I=0;I<u.length;++I){const L=u[I];g.has(L)?w.side="end":(n.has(L)||(v.push(L),n.add(L)),w.element=L,w.previousIndex=I,d(w)),S&&L!==f[I]&&(S=!1)}return!v.length&&S?u:(s({list:f,added:y,removed:v,unchanged:b,finishRemoved:c}),i=g,f)})},e.appear?[]:t.slice())}const Qk=o=>{const e=(n,a)=>{const r=o.transitions.get(n);Ne(l=>{const c=r();if(l||c)return c||a(),!0})},t=new Map,s=(n,a)=>{qs(r=>{t.set(n,r),e(n,()=>{r(),a()}),Et(()=>{t.get(n)===r&&t.delete(n)})})};return Et(()=>{t.forEach(n=>n())}),pg(Ym(()=>o.children).toArray,{exitMethod:"keep-relative",onChange:({added:n,removed:a,finishRemoved:r})=>{for(const c of n)t.get(c)?.();if(o.noWait?.()||!et.isAvailable("animations")){r(a);return}const l=[];for(const c of a){if(!o.transitions.has(c)){l.push(c);continue}s(c,()=>{r([c])})}l.length&&r(l)}})};function jw(){const o=new Qt;return Et(()=>o.removeAll()),o}const Yk=o=>{let e,t;if(o.splitByDays){const i=a=>{const r=a.date,l=new Date(r*1e3);return l.setHours(0,0,0),l.getTime()},n=he(()=>{const a=o.state.stories,r={};return a.forEach(l=>{const c=i(l);(r[c]??(r[c]=[])).push(l)}),r});t=he(()=>{const a=n(),r=o.currentStory(),l=i(r);return a[l]}),e=he(()=>{const a=o.currentStory();return t().indexOf(a)})}else t=()=>o.state.stories,e=()=>o.state.index;return ke(Mi,{get each(){return t()},children:(i,n)=>ke(Xk,an(()=>an(o,{slideIndex:n,storyIndex:e})))})},Xk=o=>{const[e,t]=we(0),[s]=Ur(),i=()=>{const d=(Date.now()-s.startTime)/s.storyDuration;t(d)},n=()=>s.peer!==o.state||o.storyIndex()!==o.slideIndex()||s.paused?(a(),!1):(i(),!0),a=()=>{cm(l)},r=()=>{la(n,l)};Ne(()=>{if(s.peer!==o.state){a();return}Ne(xi(()=>[o.storyIndex(),o.slideIndex()],([c,d])=>{c===d?(t(void 0),Ne(()=>{s.paused||s.buffering?a():r()})):(a(),t(c>d?1:void 0))}))});const l=(()=>{const c=bn();return mt(d=>{const h=Se.ViewerStorySlidesSlide,u=e()!==void 0?{"--progress":Math.min(100,e()*100)+"%"}:{};return h!==d._v$&&st(c,d._v$=h),d._v$2=qi(c,u,d._v$2),d},{_v$:void 0,_v$2:void 0}),c})();return l},mg="❤",Zk=o=>o?.emoticon===mg,Jk=o=>{const[e,t]=Ur(),[s,i]=o.focusedSignal,[n,a]=o.inputEmptySignal,[r,l]=o.inputMenuOpenSignal,[c,d]=we(!1),h=Ii(),u=h.get(),p=new Nw(ce,C.managers,!1,{elements:!0,sharedMedia:!0});p.setType(Q.Stories),p.isStandalone=!0;const m=async()=>{const P=!o.currentStory().sent_reaction?{_:"reactionEmoji",emoticon:mg}:void 0;o.sendReaction({reaction:P,target:g})};let g;ke(Cn,{ref(L){const M=g;typeof M=="function"?M(L):g=L},onClick:m,tabIndex:-1,class:"btn-circle btn-reaction chat-input-secondary-button chat-secondary-button",noRipple:!0,get children(){return o.reaction()}});const f=p.input=new vh(p,ce,C.managers,"stories-input");f.noRipple=!0,f.btnReaction=g,f.excludeParts={replyMarkup:!0,scheduled:!0,downButton:!0,reply:!0,forwardOptions:!0,mentionButton:!0,attachMenu:!0,commandsHelper:!0,botCommands:!0,emoticons:mi},f.globalMentions=!0,f.getMiddleware=(...L)=>u.create().get(...L);const y=L=>{const M=L.target;!U(M,Se.ViewerStoryReactions)&&(U(M,Se.ViewerStory)||M.classList.contains(Se.Viewer))&&(X(L),i(!1))};Et(()=>{v&&(dt.removeItem(v),v=void 0)});let v;Ne(xi(()=>s(),L=>{L?(b=Zt(()=>!e.paused),document.addEventListener("click",y,{capture:!0}),dt.pushItem(v={type:"stories-focus",onPop:()=>{i(!1)}})):(document.removeEventListener("click",y,{capture:!0}),dt.removeItem(v),v=void 0),t.toggle(L?!1:b),f.freezeFocused(L),f.chatInput.classList.toggle("is-focused",L)},{defer:!0}));let b=!1;f.onFocusChange=L=>{f.emoticonsDropdown.isActive()||L&&i(L)};let w=!1;const S=L=>{L&&(w=!e.paused),t.toggle(L?!1:w),l(L)};f.onMenuToggle=S,f.construct(),f.constructPeerHelpers(),f.messageInput.dataset.textColor="white",Ne(()=>{if(o.isActive()){const L=()=>(S(!0),void 0),M=()=>(S(!1),void 0);zi.addEventListener("open",L),zi.addEventListener("close",M),zi.chatInput=f,Et(()=>{zi.removeEventListener("open",L),zi.removeEventListener("close",M)})}}),Ne(()=>{f.chatInput.classList.toggle("is-private",!o.isPublic()),f.setCanForwardStory(o.isPublic())}),Ne(()=>{const[L,M,P]=[s(),c(),o.isPublic()],x=Math.min(2,[!L,L?!0:P,M].reduce((R,B)=>R+ +B,0)),T=48,O=8,F=o.isFull()?8:0,N=o.isFull()?0:135,G=e.width-(T+O)*x+(L?N:0)-F*2;f.rowsWrapper.style.setProperty("width",G+"px","important"),f.chatInput.classList.toggle("is-focused",L)});const I=_h();return p.peerId=o.state.peerId,p.onChangePeer({peerId:p.peerId,type:Q.Stories},Ir(u)).then(()=>{if(u())return p.finishPeerChange({peerId:p.peerId,middleware:u})}).then(()=>{u()&&(o.setInputReady(!0),Ul(I,()=>{Ne(()=>{f.setReplyTo({replyToStoryId:o.currentStory().id})})}))}),Et(()=>{f.onFocusChange=f.onFileSelection=f.onMenuToggle=f.onRecording=f.onUpdateSendBtn=f.onMessageSent2=f.forwardStoryCallback=void 0,h.destroy(),p.destroy()}),f.onFileSelection=L=>{S(!0),L.finally(()=>{S(!1)})},f.onUpdateSendBtn=L=>{a(L==="record"||L==="forward")},f.onMessageSent2=()=>{un(),i(!1),o.onMessageSent()},f.forwardStoryCallback=L=>{o.onShareButtonClick(L,f.btnSendContainer)},f.onRecording=L=>{d(L)},f.chatInput},by=" • ",Ku=new Nh(void 0,!0),uo=({element:o,container:e=o.parentElement,vertical:t,text:s,textElement:i,paddingX:n=0,centerVertically:a,onClose:r,icon:l})=>{const c=e.getBoundingClientRect(),d=o.getBoundingClientRect(),h=document.body;let u;return qs(p=>{const[m,g]=we(),f=()=>{const I={"max-width":Math.min(c.width-n*2,320)+"px"},L=m();if(!L)return I;const M=Math.min(c.left+n,c.right),P=Math.max(c.left,c.right-Math.min(c.width,L.width)-n),E=d.left+(d.width-L.width)/2,k=Ot(E,M,P),A=12;t==="top"?I.top=(a?d.top+d.height/2:d.top)-L.height-A+"px":I.top=d.bottom+A+"px",I.left=k+"px";const x=d.left+(d.width-19)/2;return I["--notch-offset"]=x-k+"px",I};let y;const v=(()=>{const I=Vk(),L=I.firstChild,M=L.nextSibling,P=M.nextSibling,E=y;return typeof E=="function"?Nt(E,I):y=I,q(P,l&&ke(kr,{icon:l,class:"tooltip-icon"}),null),q(P,i,null),mt(k=>{const A=jt("tooltip","tooltip-"+t,l&&"tooltip-with-icon"),x=f();return A!==k._v$3&&st(I,k._v$3=A),k._v$4=qi(I,x,k._v$4),k},{_v$3:void 0,_v$4:void 0}),I})();ke(Cv,{mount:h,children:v}),Ho(()=>{g(y.getBoundingClientRect()),y.classList.add("mounted"),vt({element:y,className:"is-visible",duration:200,useRafs:2,forwards:!0})});let b=!1;const w=I=>{I||(b=!0,clearTimeout(S),vt({element:y,className:"is-visible",duration:200,forwards:!1,onTransitionEnd:()=>{r?.(),p()}}))};u=()=>{b||Ku.close()};const S=0;Ku.open(h),Ku.addEventListener("toggle",w,{once:!0})}),{close:u}},qw=async o=>{let e;const{reaction:t,div:s,size:i,textColor:n,play:a,uReaction:r}=o,l=t._==="reactionCustomEmoji",c=Ii().get();r(null);let d;if(l){const u=await C.managers.acknowledged.appEmojiManager.getCustomEmojiDocument(t.document_id);if(!c())return;u.cached||r(),e=await u.result,d=fe.getReaction(e.stickerEmojiRaw)}else{const u=fe.getAvailableReactions();u instanceof Promise&&r();const p=await u;if(!c())return;d=p.find(m=>Ai(t,m)),e=a?d.select_animation:d.static_icon}d&&Xs(d,u=>{u?.around_animation&&as.downloadMedia({media:u.around_animation})});const h=[];await Ds({div:s,doc:e,width:i,height:i,play:a,textColor:n,middleware:c,loadPromises:h,loop:a||void 0}),await Promise.all(h),c()&&r(s)},eT=o=>{const[e,t]=Ur(),{x:s,y:i,w:n,h:a,rotation:r}=o.mediaArea.coordinates,l=he(S=>S||o.isActive()&&e.startTime),[c,d]=we(),h=he(()=>o.mediaArea._==="mediaAreaGeoPoint"||o.mediaArea._==="mediaAreaVenue"),u=he(()=>o.mediaArea._==="mediaAreaSuggestedReaction"),p=he(()=>o.mediaArea._==="mediaAreaChannelPost"),m=async()=>{const S=o.mediaArea.geo,I="https://maps.google.com/maps?q="+S.lat+","+S.long,L=async x=>{if(P){P=!1;return}E=!0,X(x);try{await ft({descriptionLangKey:"Popup.OpenInGoogleMaps",button:{langKey:"Open"}})}catch{k&&t.play();return}P=!0,M.click()};let M,P=!1,E;(()=>{const x=$k();x.$$click=L;const T=M;return typeof T=="function"?Nt(T,x):M=x,Mo(x,"href",I),q(x,()=>_("StoryViewLocation")),x})(),vm(M);const k=!e.paused;t.pause();const{close:A}=uo({element:w,vertical:"top",textElement:M,centerVertically:!!r,onClose:()=>{if(E){E=!1;return}k&&t.play()}});o.setTooltipCloseCallback(()=>A)},g=()=>{const S=o.mediaArea,I=e.width*n/100;o.sendReaction({reaction:S.reaction,target:w,sizes:{genericEffect:I*.375,genericEffectSize:I*1.5,size:I,effectSize:I*2.6875},textColor:S.pFlags.dark?"white":void 0,fireSame:!0})},f=()=>{const S=()=>{o.close(()=>{const P=o.mediaArea;ce.setInnerPeer({peerId:P.channel_id.toPeerId(!0),lastMsgId:P.msg_id})})},I=fi(()=>{M(),S()});I.append(_("Story.ViewPost"));const L=!e.paused;t.pause();const{close:M}=uo({element:w,vertical:"top",textElement:I,centerVertically:!1,onClose:()=>{L&&t.play()}});o.setTooltipCloseCallback(()=>M)},y=S=>{o.isActive()&&(X(S),b(S))},v=S=>{const I=S.reaction,[L,M]=we(0),P=Sa(),E=e.width*n/100*.72;let k;(()=>{const A=bn(),x=k;return typeof x=="function"?Nt(x,A):k=A,mt(()=>st(A,jt(Se.ViewerStoryMediaAreaReactionInner,L()&&Se.hasCount))),A})(),qw({reaction:I,uReaction:P,div:k,size:E,textColor:S.pFlags.dark?"white":void 0,play:!0}),mt(()=>{const T=o.story.views?.reactions?.find(O=>Ai(O.reaction,I));M(T?.count??0)}),Ne(()=>{const A=P();A!==null&&(d([(()=>{const x=Gk(),T=x.firstChild,O=T.nextSibling;return mt(F=>{const N=jt(Se.ViewerStoryMediaAreaReactionBubbles,S.pFlags.dark&&Se.dark,L()&&Se.hasCount),G=Se.ViewerStoryMediaAreaReactionBubble,R=jt(Se.ViewerStoryMediaAreaReactionBubble,Se.small);return N!==F._v$5&&st(x,F._v$5=N),G!==F._v$6&&st(T,F._v$6=G),R!==F._v$7&&st(O,F._v$7=R),F},{_v$5:void 0,_v$6:void 0,_v$7:void 0}),x})(),A,(()=>{const x=bn();return`calc(var(--stories-width) * ${n/100*.72*.275})`!=null?x.style.setProperty("font-size",`calc(var(--stories-width) * ${n/100*.72*.275})`):x.style.removeProperty("font-size"),q(x,(()=>{const T=he(()=>!!L());return()=>T()?Ri(L(),1):""})()),mt(()=>st(x,jt(Se.ViewerStoryMediaAreaReactionCount,S.pFlags.dark&&Se.dark,L()&&Se.hasCount))),x})()]),o.setReady(!0))})};let b;u()?(b=g,v(o.mediaArea)):h()?(b=m,o.setReady(!0)):(p()&&(b=f),o.setReady(!0));let w;return(()=>{const S=bn();S.$$click=y;const I=w;return typeof I=="function"?Nt(I,S):w=S,q(S,c),mt(L=>{const M=jt(Se.ViewerStoryMediaArea,...h()?[l()&&"shimmer","shimmer-bright","shimmer-once"]:[],...u()?[Se.ViewerStoryMediaAreaReaction]:[]),P=`left: ${s}%; top: ${i}%; width: ${n}%; height: ${a}%; --rotate: ${r}deg`;return M!==L._v$8&&st(S,L._v$8=M),L._v$9=qi(S,P,L._v$9),L},{_v$8:void 0,_v$9:void 0}),S})()},tT=o=>{const e=dn({size:qp,peerId:o.state.peerId,isDialog:!1});e.node.classList.add(Se.ViewerStoryHeaderAvatar);const t=C.myId===o.state.peerId,s=!t&&new Mt;let i;s?(s.update({peerId:o.state.peerId,dialog:!1}),i=s.element):i=_("YourStory"),i.classList.add(Se.ViewerStoryHeaderName);const n=(V=!h.paused)=>()=>a(V),a=V=>{V&&u.play()},r=(V=!h.paused)=>{u.pause(),_s.createSharingPicker({onSelect:async $e=>{const Ze=o.state.peerId,ht=await C.managers.appPeersManager.getInputPeerById(Ze);C.managers.appMessagesManager.sendOther({peerId:$e,inputMedia:{_:"inputMediaStory",id:Ie().id,peer:ht}}),Qc(_($e===C.myId?"StorySharedToSavedMessages":"StorySharedTo",[await Oe({peerId:$e})]))},chatRightsActions:["send_media"]}).addEventListener("closeAfterTimeout",n(V))},l=(V,ie)=>{if(Ie().pFlags.noforwards){const{open:Ze}=Xi({buttons:[{icon:"link",text:"CopyLink",onClick:os}],listenTo:ie,...Os});Ze(V)}else r()},c=dn({size:162,peerId:o.state.peerId,isDialog:!1,withStories:!0,storyColors:{read:"rgba(255, 255, 255, .3)"}});c.node.classList.add(Se.ViewerStoryInfoAvatar);let d;if(t)d=_("MyStory");else{const V=new Mt;V.update({peerId:o.state.peerId,dialog:!1,onlyFirstName:!0}),d=V.element}d.classList.add(Se.ViewerStoryInfoName);const[h,u]=Ur(),[p,m]=we(),[g,f]=we(),[y,v]=we(),[b,w]=we(),[S,I]=we(),[L,M]=we(0),[P,E]=we(!1),[k,A]=we(),[x,T]=we(!1),[O,F]=we(),N=we(!1),G=we(),R=we(!0),B=we(!1),H=we(!1),[z,W]=N,[ue,K]=G,[ee]=R,[_e]=B,[ae,re]=H,[Ue,ye]=we(!1),[Z,de]=o.transitionSignal,[be,pe]=we(),[xe,ne]=we(),[Y,j]=we(),[te,le]=we(),[me,Ee]=we(),Ie=he(()=>o.state.stories[o.state.index]),Ke=he(()=>{const ie=Ie().expire_date;return ie?ie<=Es(!0):!1}),$=he(()=>h.peer===o.state),[se,oe]=we(!1,{equals:!1});let ve;Ne(()=>{Ie(),ve=Ii().get()});const Te=(V,ie=Zt(()=>ue()))=>{if(!ie||ie.target===el)return;const $e=ie.sizes??{genericEffect:26,genericEffectSize:100,size:40,effectSize:80};za.fireAroundAnimation({middleware:ie.fireSame?ve:Ii().get(),reaction:V,sizes:$e,stickerContainer:ie.target,cache:ie.fireSame?{}:ie.target,textColor:ie.textColor})};Ne(()=>{const V=Ie().sent_reaction;V&&(V?.document_id,se(),Te(V))});const Ae=async V=>{let{reaction:ie}=V;const $e=o.state.peerId,Ze=Ie(),ht=Ze.id,ot=Ze.sent_reaction;if(ie instanceof Promise&&(ie=await ie,!ie))return;const Dt=!Ai(ot,ie);!Dt&&!V.fireSame&&(ie=void 0),W(!1),K(V),!Dt&&V.fireSame&&oe(!0),await C.managers.acknowledged.appStoriesManager.sendReaction($e,ht,vl(ie)),K()},Ge=()=>{const[V,ie]=we(!1),$e=Ii().get(),Ze=new vw({managers:C.managers,type:"horizontal",middleware:$e,onFinish:ot=>Ae({reaction:ot,target:el}),size:36,openSide:"top",getOpenPosition:()=>{},noMoreButton:!0});Ze.widthContainer.classList.add(Se.ViewerStoryReactions),Ze.init().finally(()=>{ie(!0)});let ht;Ne(()=>{if(!V())return;const ot=We();Ze.widthContainer.classList.toggle("is-visible",ot),ot?clearTimeout(ht):ht=window.setTimeout(()=>{Ee(),Ze.cleanup()},et.isAvailable("animations")?200:0)}),Ee(Ze)},We=()=>z()&&ee()&&!_e(),Ct=he(()=>me()?!0:We());Ne(()=>{Ct()&&Ge()});const Pt=V=>{let ie=!1;Et(()=>{ie=!0,V.pause(),V.removeEventListener("waiting",Ze),V.removeEventListener("canplay",$e)});const $e=()=>{T(!1),$()&&u.setBuffering(!1)},Ze=()=>{const Is=V.networkState===V.NETWORK_LOADING,ks=V.readyState<V.HAVE_FUTURE_DATA;Is&&ks&&(T(!0),$()&&u.setBuffering(!0),V.addEventListener("canplay",$e,{once:!0}))},ht=()=>{V.currentTime&&ti(V,0)};V.addEventListener("waiting",Ze),Et(()=>{h.buffering&&u.setBuffering(!1)}),Ne(()=>{h.paused||!$()?V.pause():V.play()});const ot=()=>{Ne(xi(()=>[$()],([Is])=>{Is||ht()})),Ne(()=>{V.muted=h.muted})};$()?ot():qr(ot)(()=>$());const Dt=Zt(()=>Ie());Ne(()=>{$()&&!h.startTime&&Ie()===Dt&&ht()}),Zt(Ue)||fe.getState().then(Is=>{!ie&&!Is.seenTooltips.storySound&&(Ul(Bt,()=>{const ks=he(Yt=>Yt||$()&&h.startTime);Ne(()=>{if(ks()){const{close:Yt}=uo({...Rg,textElement:_("Story.SoundTooltip")});le(()=>Yt)}})}),C.managers.appStateManager.setByKey(Fs("seenTooltips","storySound"),!0))});const Bt=_h()},ze=V=>{let ie=Ok(V);ie==="public"&&(ie=void 0);const Ze=vl(V.media)?.document,ht=Ze&&Ze.attributes.find(ds=>ds._==="documentAttributeVideo"),ot=ht?!!ht.pFlags.nosound:!1,Dt=ht?.duration,Bt=V.date,Is=V.pFlags.edited,ks=!!V.pFlags.public,Yt=fe.getPeer(o.state.peerId),Xt=si(Yt);pe(ie),A({timestamp:Bt,edited:Is}),ye(ot),f(Dt&&Dt*1e3),re(ks),F(ks&&(!V.pFlags.noforwards||!!Xt[0]))},yt=async V=>{if(T(!0),V._!=="storyItem"){j(),m(),v(),I(),ne(),w(),ze(V),C.managers.appStoriesManager.getStoryById(o.state.peerId,V.id),o.onReady?.();return}const ie=Ii().get(),$e=t?Sa():void 0,Ze=Sa(),ht=Sa(),ot=Sa(),Dt=Sa(),Bt=Sa(),Is=t?he(Yt=>{const ds=V.views?.recent_viewers;return Yt?.join()===ds?.join()?Yt:ds}):void 0,ks=(Yt,Xt,ds)=>({entities:Xt,middleware:ie,textColor:"white",loadPromises:ds,passMaskedLinks:sr===Yt});t&&Ne(async()=>{let Yt;const Xt=Is();if(Xt?.length){Yt=new Wo({avatarSize:30,middleware:ie});const ds=Xt.map(Js=>Js.toPeerId(!1));if($e(null),await Yt.render(ds),!ie())return}$e(Yt)}),Ne(async()=>{let Yt;const{caption:Xt,entities:ds}=V;if(Xt?.trim()){const Js=[],{message:Oi,totalEntities:it}=Lf(Xt,ds?.slice()),Ut=us(Oi,ks(o.state.peerId,it,Js));if(Ze(null),await Promise.all(Js),!ie())return;Yt=Ml(Ut)}Ze(Yt)}),Ne(()=>{if(!Zt(()=>Hs(V)).id){ht();return}ht(null);const ds=zc({peerId:o.state.peerId,storyItem:vl(V),forViewer:!0,containerProps:{class:Se.ViewerStoryContentMediaContainer},childrenClassName:Se.ViewerStoryContentMedia,useBlur:40}),Js=()=>{ht(ds.container)},Oi=()=>{ie()&&(T(!1),Zt(()=>pt()))},it=()=>{const Ut=ds.media();Ut instanceof HTMLVideoElement?(Pt(Ut),ca(Ut).then(Oi)):Oi()};qr(Js)(()=>ds.ready()),qr(it)(()=>ds.media())}),Ne(()=>{let Yt;const Xt=V.sent_reaction,ds=Zk(Xt);if(!Xt||ds)Yt=Le("reactions_filled",...["btn-reaction-icon",ds&&"btn-reaction-default"].filter(Boolean)),ot(Yt);else{const Js=document.createElement("div");Js.classList.add("btn-reaction-sticker","night"),qw({reaction:Xt,uReaction:ot,div:Js,size:26,textColor:"white",play:!1})}}),Ne(()=>{if(!V.media_areas?.length){Dt();return}Dt(null);const[Yt,Xt]=we(!1),[ds,Js]=we(0),Oi=ke(Mi,{get each(){return V.media_areas},children:it=>{const[Ut,Ks]=we(!1);return qr(()=>{Js(Ls=>Ls+1),ds()===V.media_areas.length&&Xt(!0)})(Ut),ke(eT,{story:V,mediaArea:it,isActive:$,setTooltipCloseCallback:le,setReady:Ks,sendReaction:Ae,get close(){return o.close}})}});qr(()=>{Dt(Oi)})(Yt)}),Ne(async()=>{const Yt=fy(V);if(!Yt){Bt();return}const{fwdFrom:Xt,mediaAreaChannelPost:ds}=Yt;Bt(null);const[Js,Oi]=we(),[it,Ut]=we(),Ks={header:(()=>{const Ei=Zr();return q(Ei,Js),mt(()=>st(Ei,Se.ViewerStoryHeaderRepost)),Ei})()};let Ls,Ui,Qn;Xt?(Ls=Xt.from&&Je(Xt.from),Ui=Xt.from_name,Qn=Xt.story_id):Ls=ds.channel_id.toPeerId(!0);const tl={peerId:Ls,fromName:Ui},{node:Jc,readyThumbPromise:ed}=ls({peerId:Ls,peerTitle:Ui,size:16,middleware:ie}),td=(()=>{const Ei=Zr();return q(Ei,it),Ei})(),sd=async(Ei,ma)=>{const nl=await Ei;if(!ie())return;if(ma&&!nl.caption){Ut(_("Story"));return}const ad=[],{message:ja,totalEntities:vu}=Lf(nl.caption,nl.entities?.slice()),GS=us(ja,ks(Ls,vu,ad));await Promise.all(ad),ie()&&Ut(Ml(GS))},id=Qn&&C.managers.acknowledged.appStoriesManager.getStoryById(Ls,Qn).then(async Ei=>{const ma=sd(Ei.result,Ei.cached);if(!Ei.cached){Ut(_("Story"));return}return ma}),[sl,il,nd]=await Promise.all([Oe(tl).then(async Ei=>{const ma=document.createDocumentFragment();if(Ls){const ja=await C.managers.appPeersManager.isBroadcast(Ls),vu=Le(ja?"newchannel_filled":Ls.isUser()?"newprivate_filled":"group_filled","inline-icon","reply-title-icon","with-margin");ma.append(vu)}if(ma.append(Ei),Ui||ds){const ja=document.createElement("div");return ja.classList.add(Se.ViewerStoryRepostSmall),ja.append(ma),ja}const{container:nl,fillPromise:ad}=Xh({title:ma,subtitle:td,useHighlightingColor:!0,setColorPeerId:Ls});return await ad,nl}),Oe(tl),ed.then(()=>Jc),id]);ie()&&(il.classList.add(Se.ViewerStoryHeaderRepostTitle),sl.classList.add(Se.ViewerStoryRepost),Ks.reply=sl,Oi([Le(qk,Se.ViewerStoryHeaderRepostIcon),nd,il]),Bt(Ks))}),Ne(xi(()=>[kS(),$e?.(),Ze(),ht(),ot?.(),Dt(),Bt()],([Yt,...Xt])=>{if(!Yt||Xt.some(Ls=>Ls===null))return;const[ds,Js,Oi,it,Ut,Ks]=Xt;j(ds),v(Js),m(Oi),I(it),ne(Ut),w(Ks),o.onReady?.(),Ne(()=>{ze(V)})},{defer:!0}))};Ne(()=>{const V=Ie();M(0),E(!1),Ne(()=>{yt(V)})});const at=()=>{if(!It.size)return;const V=Array.from(It);It.clear(),C.managers.appStoriesManager.getStoriesById(o.state.peerId,V,!0)},It=new Set;let bt;Ne(()=>{$()?(bt=window.setInterval(at,6e4),Ne(()=>{It.add(Ie().id)})):clearInterval(bt)});const Me=V=>{Be.size&&(C.managers.appStoriesManager.incrementStoryViews(o.state.peerId,Array.from(Be)),Be.clear()),C.managers.appStoriesManager.readStories(o.state.peerId,V)},Be=new Set,je=Zs(Me,5e3,!0,!0);Ne(()=>{if(!$())return;let V;Ne(()=>{const ie=Ie();o.pinned&&Zt(()=>Ke())&&Be.add(ie.id),je(V=ie.id)}),Et(()=>{je.isDebounced()&&(je.clearTimeout(),Me(V))})});const pt=()=>{!h.hasViewer||Zt(()=>!$())||bi()};Ne(pt);const Jt=ke(Yk,an(()=>an(o,{currentStory:Ie})));let wt=!0;const gs=()=>{let V=Xc();if(!V)return"0px";yu()&&h.hasViewer&&Fg()&&wt&&(V>0?++V:--V);const ie=h.width,$e=40,Ze=V>0?1:-1,ht=ie*Ll;let ot=ie*Ze;const Dt=(ie-ht)/2-$e;if(ot=(ie-Dt)*Ze,Math.abs(V)!==1){const Bt=V-1*Ze;ot+=Bt*ht+$e*Bt}return ot+"px"},bi=()=>{if(Zt(()=>x()))return;const V=Zt(()=>g()),ie=V?V+.001:Ww;u.play(ie)},rs=V=>{V&&V.target!==Jo||de(!0)},As=V=>{V&&V.target!==Jo||(wt=!0,de(!1),$()&&bi())},rt=V=>{if(Ue()){const{close:ie}=uo({...Rg,textElement:_("Story.NoSound")});le(()=>ie);return}u.toggleMute()};let xt;const Wt=ke(Cn,{ref(V){const ie=xt;typeof ie=="function"?ie(V):xt=V},get classList(){return{[Se.noSound]:Ue()}},get icon(){return h.muted||Ue()?"speakerofffilled":"speakerfilled"},onClick:rt}),os=()=>{Us(`https://t.me/${si(pu)[0]}/s/${Ie().id}`),Re({langPackKey:"LinkCopied"})},Os={onOpenBefore:async()=>{pu=await C.managers.appStoriesManager.getPeer(o.state.peerId),Ni=Ie(),_n=o.state.peerId},onOpen:()=>{Xo=!h.paused,u.pause()},onCloseAfter:()=>{Xo&&!Zo&&u.play(),Zo=!1}},ni=.2;Ne(()=>{$()&&u.setLoop(g()!==void 0&&P())});let Di;const pa=V=>{const ie=Math.min(1,V/100),$e=ie>=ni;M(ie),E($e),g()===void 0&&($e?Di===void 0&&(Di=!h.paused,u.pause()):Di&&(Di=void 0,u.play()))};let Ms,mn,Bi=!1;const Vr=()=>{if(Bi)return;const V=Ms.scrollTop;pa(V)},qn=V=>{const ie=Math.max(0,V),$e=Date.now();Bi=!0;const Ze=Ie();la(()=>{if(Ie()!==Ze)return!1;const ht=Math.min(1,(Date.now()-$e)/300),ot=kP(ht,1),Dt=V*(1-ot),Bt=Math.round(ie-Dt);return Ms.scrollTop=Bt,pa(Bt),ht<1},Ms).finally(()=>{Bi=!1})},Yo=V=>{if(Ms.scrollHeight<=Ms.clientHeight||Ms.scrollTop)return;X(V);const $e=Math.min(mn.scrollHeight-56,Ms.clientHeight-60);qn($e)},qc=(()=>{const V=zk(),ie=V.firstChild,$e=ie.firstChild;V.addEventListener("scroll",Vr);const Ze=Ms;typeof Ze=="function"?Nt(Ze,V):Ms=V,ie.$$click=Yo;const ht=mn;return typeof ht=="function"?Nt(ht,ie):mn=ie,q($e,()=>b()?.reply,null),q($e,y,null),mt(ot=>{const Dt=jt("scrollable","scrollable-y","no-scrollbar",Se.ViewerStoryCaption,b()&&y()&&Se.hasReply),Bt=jt("spoilers-container",Se.ViewerStoryCaptionText),Is=Se.ViewerStoryCaptionTextCell;return Dt!==ot._v$10&&st(V,ot._v$10=Dt),Bt!==ot._v$11&&st(ie,ot._v$11=Bt),Is!==ot._v$12&&st($e,ot._v$12=Is),ot},{_v$10:void 0,_v$11:void 0,_v$12:void 0}),V})(),Wa=(()=>{const V=bn();return q(V,p),mt(ie=>{const $e=Se.ViewerStoryContentItem,Ze=L()&&{opacity:1-L()*.5};return $e!==ie._v$13&&st(V,ie._v$13=$e),ie._v$14=qi(V,Ze,ie._v$14),ie},{_v$13:void 0,_v$14:void 0}),V})(),uu=()=>{const{timestamp:V,edited:ie}=k()||{};if(!V)return;const $e=Es(!0)-V,Ze=Oc($e),ht={[Vi.Seconds]:"StoryJustNow",[Vi.Minutes]:"MinutesShortAgo",[Vi.Hours]:"HoursShortAgo"},ot=Ze[0],Dt=ht[ot.type],Bt=[];Dt?ot.type===Vi.Days&&ot.duration!==1?Bt.push(Bc(new Date(V*1e3))):Bt.push(_(Dt,[ot.duration])):Bt.push((()=>{const ks=Zr();return q(ks,()=>Ml(Ss(V))),ks})()),ie&&Bt.push(_("EditedMessage")),b()&&Bt.unshift(b().header);let Is=Ar(Bt,by);return b()&&(Is=[Is[0],(()=>{const ks=Zr();return q(ks,()=>Is.slice(1)),mt(()=>st(ks,Se.ViewerStoryHeaderSecondary)),ks})()]),Is},Qc=(V,ie)=>{let $e;ie&&($e=document.createElement("a"),$e.href="#",$e.addEventListener("click",Ze=>{X(Ze),o.close(()=>{ce.setInnerPeer({peerId:ie})})},{capture:!0,passive:!1}),$e.append(_("ViewInChat"))),zb({textElement:V,textRight:$e,appendTo:el,from:"bottom",duration:3e3,icon:"checkround_filled"})},kg=o.state.peerId!==sr&&o.state.peerId!==C.myId&&o.state.peerId.isUser(),[kS,TS]=we(!kg),xS=kg&&ke(Jk,an(()=>an(o,{currentStory:Ie,isActive:$,focusedSignal:N,inputEmptySignal:R,inputMenuOpenSignal:B,sendReaction:Ae,isPublic:ae,shareStory:r,reaction:S,onShareButtonClick:l,onMessageSent:()=>{Qc(_("Story.Tooltip.MessageSent"),o.state.peerId)},setInputReady:TS}))),Tg=async V=>{const ie=o.state.peerId;if(ie===C.myId||ie===sr)return!1;const[$e,Ze]=await Promise.all([C.managers.appStoriesManager.getPeer(ie),C.managers.appStoriesManager.isSubcribedToPeer(ie)]),ht=!!$e.pFlags.stories_hidden;return(V?!ht:ht)&&Ze},xg=async V=>{const ie=o.state.peerId;C.managers.appStoriesManager.toggleStoriesHidden(ie,V),Re({langPackKey:V?"StoriesMovedToContacts":"StoriesMovedToDialogs",langPackArguments:[await Oe({peerId:ie})]})},Yc=async V=>{const ie=o.state.peerId;C.managers.appStoriesManager.togglePinned(ie,Ie().id,V).then(()=>{Re({langPackKey:V?ie.isUser()?"StoryPinnedToProfile":"StoryPinnedToPosts":ie.isUser()?"StoryArchivedFromProfile":"StoryUnpinnedFromPosts"})})};let Xo=!1,pu,_n,Ni,Zo=!1;const Ag=yi({buttons:[{icon:"plusround",text:"Story.AddToProfile",onClick:()=>Yc(!0),verify:()=>_n===C.myId&&!Ni.pFlags?.pinned},{icon:"crossround",text:"Story.RemoveFromProfile",onClick:()=>Yc(!1),verify:()=>_n===C.myId&&!!Ni.pFlags?.pinned},{icon:"plusround",text:"SaveToPosts",onClick:()=>Yc(!0),verify:()=>!_n.isUser()&&!Ni.pFlags?.pinned&&C.managers.appStoriesManager.hasRights(_n,Ni.id,"pin")},{icon:"crossround",text:"RemoveFromPosts",onClick:()=>Yc(!1),verify:()=>!_n.isUser()&&!!Ni.pFlags?.pinned&&C.managers.appStoriesManager.hasRights(_n,Ni.id,"pin")},{icon:"forward",text:"ShareFile",onClick:()=>{Zo=!0,r(Xo)},verify:()=>!!Ni?.pFlags?.public&&!Ni.pFlags.noforwards},{icon:"link",text:"CopyLink",onClick:os,verify:()=>Ni._!=="storyItem"?!1:Ni.pFlags.public&&!!si(pu)[0]},{icon:"download",text:"MediaViewer.Context.Download",onClick:()=>{const V=Ie(),ie=Hs(V,!0);ie&&as.downloadToDisc({media:vl(ie)})},verify:()=>{if(o.state.peerId===C.myId)return!0;const V=Ie();return!!(V?._==="storyItem"&&!V.pFlags.noforwards&&C.premium)}},{icon:"archive",text:"ArchivePeerStories",onClick:()=>xg(!0),verify:()=>Tg(!0)},{icon:"unarchive",text:"UnarchiveStories",onClick:()=>xg(!1),verify:()=>Tg(!1)},{icon:"statistics",text:"ViewStatistics",onClick:()=>{const V=Ie().id;o.close(()=>{setTimeout(()=>{ss.createTab(Kc).open(_n.toChatId(),void 0,V),ss.toggleSidebar(!0)},0)})},verify:()=>C.managers.appProfileManager.canViewStatistics(_n)},{icon:"delete danger",text:"Delete",onClick:async()=>{const V=Ie().id,ie=o.state.peerId;Zo=!0;const $e=n(Xo);try{await ft({titleLangKey:"DeleteStoryTitle",descriptionLangKey:"DeleteStorySubtitle",button:{langKey:"Delete",isDanger:!0}})}catch{$e();return}C.managers.appStoriesManager.deleteStories(ie,[V])},verify:()=>C.managers.appStoriesManager.hasRights(_n,Ni.id,"delete")},{icon:"flag",className:"danger",text:"ReportChat",onClick:()=>{Zo=!0;const V=n(Xo);J.createPopup(fw,o.state.peerId,[Ie().id],V,!0)},verify:()=>!Ni.pFlags?.out&&o.state.peerId!==sr}],direction:"bottom-left",...Os});Ag.classList.add("night");const AS={close:"star_filled",contacts:"newprivate_filled",public:"newchannel_filled",selected:"newgroup_filled"},FS=async()=>{const V=be(),ie=await Oe({peerId:o.state.peerId,onlyFirstName:!0}),{close:$e}=uo({container:Zc,element:mu,vertical:"bottom",textElement:_(V==="close"?"StoryCloseFriendsHint":V==="selected"?"StorySelectedContactsHint":"StoryContactsHint",[ie]),paddingX:13});le(()=>$e)};Ne(()=>{const V=te();V&&(Et(V),Ne(xi(()=>[$(),Ie()],()=>{V(),le()},{defer:!0})))});let mu;const RS=(()=>{const V=bn();V.$$click=()=>FS();const ie=mu;return typeof ie=="function"?Nt(ie,V):mu=V,q(V,()=>Le(AS[be()])),mt(()=>st(V,jt(Se.ViewerStoryPrivacy,"privacy-bg",`privacy-bg-${be()}`))),V})(),DS=t&&(()=>{const V=Ie();if(V._!=="storyItem")return;const ie=V.views?.views_count??0;return ie?_("Views",[ie]):V.expire_date<=Es(!0)?_("NobodyViewsArchived"):_("NobodyViews")}),BS=t&&(()=>{let V;const ie=new Map,$e=J.createPopup(_s,{peerType:["custom"],getMoreCustom:Ze=>C.managers.appStoriesManager.getStoryViewsList(o.state.peerId,Ie().id,50,V,Ze).then(({nextOffset:ot,views:Dt})=>(V=ot,{result:Dt.map(Bt=>{const Is=Bt.user_id.toPeerId(!1);return ie.set(Is,Bt),Is}),isEnd:!V})),processElementAfter:(Ze,ht)=>{const ot=ie.get(Ze);return yw({dialogElement:ht,peerId:Ze,date:ot.date,isMine:!0,middleware:$e.selector.middlewareHelperLoader.get(),reaction:ot.reaction})},onSelect:Ze=>{o.close(()=>{ce.setInnerPeer({peerId:Ze})})},placeholder:"SearchPlaceholder",exceptSelf:!0,meAsSaved:!1})}),NS=t&&(async()=>{const V=o.state.peerId,ie=Ie().id;await ft({titleLangKey:"DeleteStoryTitle",descriptionLangKey:"DeleteStorySubtitle",button:{isDanger:!0,langKey:"Delete"}}),C.managers.appStoriesManager.deleteStories(V,[ie])});if(t){const V=new Set,ie=2;let $e;const Ze=async()=>{if($e)return;const Dt=Ie(),Bt=o.state.stories.indexOf(Dt);o.state.stories.slice(Math.max(0,Bt-ie),Bt+ie).forEach(Yt=>{V.add(Yt.id)});const ks=Array.from(V);V.clear(),$e=C.managers.appStoriesManager.getStoriesViews(o.state.peerId,ks).then(()=>{$e=void 0}),ot&&clearInterval(ht)},ht=setInterval(Ze,1e4);Ne(()=>{const Dt=Ie();V.add(Dt.id)});let ot=!1;Et(()=>{ot=!0}),Ho(()=>{Ze()})}let gu;const OS=(t||sr===o.state.peerId||!o.state.peerId.isUser())&&(()=>{const V=bn();return q(V,()=>t?[(()=>{const ie=bn();return km(ie,"click",BS,!0),q(ie,(()=>{const $e=he(()=>!!Y());return()=>$e()&&Y().container})(),null),q(ie,DS,null),mt(()=>st(ie,Se.ViewerStoryFooterLeft)),ie})(),(()=>{const ie=bn();return q(ie,ke(Cn,{icon:"delete",onClick:NS})),mt(()=>st(ie,Se.ViewerStoryFooterRight)),ie})()]:o.state.peerId.isUser()?_("StoryCantReply"):[(()=>{const ie=yy(),$e=ie.firstChild;return q($e,()=>Le("eye1",Se.ViewerStoryFooterIconIcon),null),q($e,()=>Ri(Ie().views?.views_count||1,1),null),mt(Ze=>{const ht=Se.ViewerStoryFooterLeft,ot=Se.ViewerStoryFooterIcon;return ht!==Ze._v$15&&st(ie,Ze._v$15=ht),ot!==Ze._v$16&&st($e,Ze._v$16=ot),Ze},{_v$15:void 0,_v$16:void 0}),ie})(),(()=>{const ie=yy(),$e=ie.firstChild;q(ie,(()=>{const ht=he(()=>!!O());return()=>ht()&&ke(Cn,{icon:"forward",onClick:ot=>{l(ot,ot.target)}})})(),$e),$e.$$click=ht=>Ae({reaction:{_:"reactionEmoji",emoticon:mg},target:gu.firstElementChild});const Ze=gu;return typeof Ze=="function"?Nt(Ze,$e):gu=$e,q($e,ke(kr,{get icon(){return Ie().sent_reaction?"reactions_filled":"reactions"},get class(){return Se.ViewerStoryFooterIconIcon}}),null),q($e,()=>Ie().views?.reactions_count||0,null),mt(ht=>{const ot=Se.ViewerStoryFooterRight,Dt=jt(Se.ViewerStoryFooterIcon,Se.ViewerStoryFooterReaction,Ie().sent_reaction&&Se.isReacted);return ot!==ht._v$17&&st(ie,ht._v$17=ot),Dt!==ht._v$18&&st($e,ht._v$18=Dt),ht},{_v$17:void 0,_v$18:void 0}),ie})()]),mt(()=>st(V,jt(Se.ViewerStoryFooter,Se.hideOnSmall,C.myId===o.state.peerId&&Se.isMe,sr===o.state.peerId&&Se.isChangelog))),V})();Ne(xi(()=>[$(),Ie()],()=>{et.isAvailable("animations")||Zt(()=>{rs(),As()})}));const US=()=>{const V=o.state.peerId;o.close(()=>{ce.setInnerPeer({peerId:V})})},Xc=he(()=>o.index()-o.peers.indexOf(h.peer)),HS=he(V=>Z()?V:Xc()<0),VS=he(V=>Z()?V:Xc()>0),[Fg,fu]=we(!1),yu=he(()=>{const V=Math.abs(Xc());let ie;return h.hasViewer?ie=V<=Qp:(ie=V===0,!o.isFull()&&V<=Qp&&(wt=!1)),ie});Ne(V=>{if(yu()){if(V)return fu(!0),Wn().then(()=>{fu(!1)}),!0}else return fu(!0),!0});let Jo,el,Zc;const $S=(()=>{const V=Kk(),ie=V.firstChild,$e=ie.firstChild,Ze=$e.nextSibling,ht=Ze.firstChild,ot=ht.nextSibling,Dt=ot.nextSibling,Bt=Dt.firstChild,Is=Bt.firstChild,ks=Is.firstChild,Yt=ks.nextSibling,Xt=Bt.nextSibling;V.addEventListener("transitionend",As),V.addEventListener("transitionstart",rs),V.$$click=it=>{if(!$())u.set({peer:o.state,index:o.state.index});else if(U(it.target,Se.ViewerStoryRepost)){const Ut=Ie(),Ks=fy(Ut);if(!Ks){Re({langPackKey:"HidAccount"});return}const{fwdFrom:Ls,mediaAreaChannelPost:Ui}=Ks;(Ls?.from||Ui)&&o.close(()=>{const Qn=Ls?Je(Ls.from):Ui.channel_id.toPeerId(!0);Ls?.story_id?Da({peerId:Qn,id:Ls.story_id}):ce.setInnerPeer({peerId:Qn,lastMsgId:Ui?.msg_id})})}else if(Ms.scrollTop&&!Vs(it.target,mn)&&!U(it.target,Se.ViewerStoryHeader))qn(-Ms.scrollTop);else if(!h.paused&&!h.hideInterface&&!Vs(it.target,mn)&&!U(it.target,Se.ViewerStoryHeader)&&!U(it.target,"stories-input")&&!U(it.target,Se.ViewerStoryReactions)&&U(it.target,Se.ViewerStory)){const Ut=Jo.getBoundingClientRect(),Ks=it.clientX>Ut.left+Ut.width/3;u.goToNearestStorySafe(Ks)}};const ds=Jo;typeof ds=="function"?Nt(ds,V):Jo=V;const Js=el;typeof Js=="function"?Nt(Js,ie):el=ie,q($e,Wa),q(ot,Jt);const Oi=Zc;return typeof Oi=="function"?Nt(Oi,Dt):Zc=Dt,Bt.$$click=US,q(Bt,()=>e.element,Is),q(ks,i,null),q(ks,(()=>{const it=he(()=>!!o.splitByDays);return()=>it()&&(()=>{const Ut=Zr();return q(Ut,()=>`${by}${o.state.index+1}/${o.state.stories.length}`),mt(()=>st(Ut,Se.ViewerStoryHeaderSecondary)),Ut})()})(),null),q(Yt,uu),q(Xt,()=>be()&&RS,null),q(Xt,ke(Cn,{get icon(){return h.paused&&!h.playAfterGesture?"play":"pause"},onClick:()=>u.toggle()}),null),q(Xt,()=>g()&&Wt,null),q(Xt,Ag,null),q(Xt,(()=>{const it=he(()=>!!o.isFull());return()=>it()&&ke(Cn,{icon:"close",onClick:()=>o.close()})})(),null),q(Ze,()=>(y()||b())&&qc,null),q(Ze,(()=>{const it=he(()=>!!xe());return()=>it()&&(()=>{const Ut=bn();return q(Ut,xe),mt(Ks=>{const Ls=Se.ViewerStoryMediaAreas,Ui=L()&&{opacity:1-L()*.5,"z-index":0};return Ls!==Ks._v$33&&st(Ut,Ks._v$33=Ls),Ks._v$34=qi(Ut,Ui,Ks._v$34),Ks},{_v$33:void 0,_v$34:void 0}),Ut})()})(),null),q(Ze,()=>me()?.widthContainer,null),q(ie,(()=>{const it=he(()=>!o.isFull());return()=>it()&&(()=>{const Ut=bn();return q(Ut,()=>c.node,null),q(Ut,d,null),mt(()=>st(Ut,Se.ViewerStoryInfo)),Ut})()})(),null),q(V,xS||OS,null),mt(it=>{const Ut=Se.ViewerStoryContainer,Ks={...o.isFull()?{[Se.fromLeft]:HS(),[Se.current]:$(),[Se.fromRight]:VS()}:{[Se.small]:!$()},[Se.hold]:h.hideInterface&&$(),[Se.focused]:z(),[Se.fadeIn]:Fg()},Ls=!o.isFull()&&{"--translateX":gs()},Ui=jt(Se.ViewerStory,x()&&$()&&"shimmer"),Qn=Se.ViewerStoryContent,tl=Se.hideOnSmall,Jc=jt(Se.ViewerStoryShadow,y()&&Se.hasCaption),ed=Se.ViewerStorySlides,td=jt(Se.ViewerStoryHeader,"night"),sd=Se.ViewerStoryHeaderLeft,id=Se.ViewerStoryHeaderInfo,sl=Se.ViewerStoryHeaderRow,il=jt(b()?Se.hasRepost:Se.ViewerStoryHeaderSecondary,Se.ViewerStoryHeaderTime),nd=Se.ViewerStoryHeaderRight;return Ut!==it._v$19&&st(V,it._v$19=Ut),it._v$20=vr(V,Ks,it._v$20),it._v$21=qi(V,Ls,it._v$21),Ui!==it._v$22&&st(ie,it._v$22=Ui),Qn!==it._v$23&&st($e,it._v$23=Qn),tl!==it._v$24&&st(Ze,it._v$24=tl),Jc!==it._v$25&&st(ht,it._v$25=Jc),ed!==it._v$26&&st(ot,it._v$26=ed),td!==it._v$27&&st(Dt,it._v$27=td),sd!==it._v$28&&st(Bt,it._v$28=sd),id!==it._v$29&&st(Is,it._v$29=id),sl!==it._v$30&&st(ks,it._v$30=sl),il!==it._v$31&&st(Yt,it._v$31=il),nd!==it._v$32&&st(Xt,it._v$32=nd),it},{_v$19:void 0,_v$20:void 0,_v$21:void 0,_v$22:void 0,_v$23:void 0,_v$24:void 0,_v$25:void 0,_v$26:void 0,_v$27:void 0,_v$28:void 0,_v$29:void 0,_v$30:void 0,_v$31:void 0,_v$32:void 0}),V})(),Rg={container:Zc,element:xt,vertical:"bottom",paddingX:13};return ke(kh,{get when(){return yu()},children:$S})};function sT(o){const[e,t]=Ur(),[s,i]=we(!1),n=he(()=>nt.height>nt.width||nt.width<e.width+135+8*2||e.width===nt.width),a=he(F=>F||s());t.viewerReady(!1);const r=new Set(["ArrowRight","ArrowLeft","ArrowDown","Space"]),l=F=>{if(Uk(document.activeElement)){c.clear();return}const N=L();if(O||N.querySelector(".is-recording")){c.clear(),X(F);return}if(r.has(F.key)||r.has(F.code))X(F);else{const G=N.querySelector(".input-message-input");G&&!Ye&&G.isContentEditable&&hi.overlaysActive===P&&Kw(G,F)}if(F.key==="ArrowDown"){c.clear(),d();return}c(F)},c=$n(F=>{F.key==="ArrowRight"?t.goToNearestStorySafe(!0):F.key==="ArrowLeft"?t.goToNearestStorySafe(!1):F.code==="Space"&&t.toggle()},200,!0);zi.getElement().classList.add("night"),zi.setTextColor("white"),Et(()=>{document.body.removeEventListener("keydown",l),E(!1),y.removeListeners(),dt.removeItem(I),zi.getElement().classList.remove("night"),zi.setTextColor(),zi.chatInput=void 0});const d=F=>{F&&Ul(S,()=>{Et(()=>{F()})}),t.viewerReady(!1),m&&(T=Rt(),wr(T,1e3),m(),m=void 0),t.pause(),c.clear(),i(!1),h.removeEventListener("click",w,{capture:!0})};let h,u,p,m;const g=qs(F=>{m=F,Ne(()=>{e.ended&&d()});const N=new Set,G=new Set,R=performance.now();let B=!1;const H=()=>{clearTimeout(z),B=!0,console.log("ready",performance.now()-R),Ul(S,()=>{Ho(()=>{b()})})},z=setTimeout(()=>{console.error("stories timeout"),e.peers.filter(re=>G.has(re.peerId)&&!N.has(re.peerId)).forEach(re=>{console.error("stories not ready",re)}),H()},250),W=(re,Ue)=>{const ye=()=>{N.add(re.peerId),!B&&N.size===G.size&&H()};G.add(re.peerId);const Z=we(!1),de=ke(tT,{state:re,index:Ue,get splitByDays(){return o.splitByDays},get pinned(){return o.pinned},onReady:ye,close:d,get peers(){return ee()},isFull:n,transitionSignal:Z}),be=mb(()=>de);return Ne(()=>{const pe=be();pe&&(ae.set(pe,Z[0]),Et(()=>{ae.delete(pe)}))}),de},ue=Qp+jk,K=re=>e.peers.slice(Math.max(re-ue,0),Math.min(re+ue+1,e.peers.length)),ee=he(()=>K(e.index)),_e=ke(Cn,{ref(re){const Ue=p;typeof Ue=="function"?Ue(re):p=re},icon:"close",get class(){return Se.ViewerClose},onClick:()=>d()}),ae=new WeakMap;return(()=>{const re=Wk(),Ue=re.firstChild;re.$$click=de=>{if(O){X(de);return}de.target===h&&d()};const ye=h;typeof ye=="function"?Nt(ye,re):h=re;const Z=u;return typeof Z=="function"?Nt(Z,Ue):u=Ue,q(re,()=>!n()&&_e,null),q(re,ke(Qk,{noWait:()=>n(),transitions:ae,get children(){return ke(Mi,{get each(){return ee()},children:W})}}),null),mt(de=>{const be=jt(Se.Viewer,!s()&&Se.isInvisible,n()&&Se.isFull,e.hasViewer&&Se.isReady),pe=e.width+"px",xe=e.height+"px",ne=Se.ViewerBackground;return be!==de._v$35&&st(re,de._v$35=be),pe!==de._v$36&&((de._v$36=pe)!=null?re.style.setProperty("--stories-width",pe):re.style.removeProperty("--stories-width")),xe!==de._v$37&&((de._v$37=xe)!=null?re.style.setProperty("--stories-height",xe):re.style.removeProperty("--stories-height")),ne!==de._v$38&&st(Ue,de._v$38=ne),de},{_v$35:void 0,_v$36:void 0,_v$37:void 0,_v$38:void 0}),re})()});let f;const y=new Or({element:h,onSwipe:(F,N,G)=>{if(!(G instanceof TouchEvent))return;const R=Math.min(125,nt.width/3),B=Math.min(125,nt.height*.2);if(N>B)return d(),!0;if(Math.abs(F)<R)return!1;const z=e.peers.indexOf(e.peer)+(F<0?1:-1),W=e.peers[z];return W?t.set({peer:W}):d(),!0},verifyTouchTarget:F=>!U(F.target,"btn-icon")&&!U(F.target,"btn-corner")&&!U(F.target,Se.ViewerStoryRepost)&&!U(F.target,Se.ViewerStoryMediaArea)&&!U(F.target,Se.ViewerStoryPrivacy)&&!U(F.target,Se.ViewerStoryCaptionText)&&!U(F.target,Se.ViewerStoryReactions)&&!!U(F.target,Se.ViewerStory)&&!U(F.target,Se.small)&&!U(F.target,Se.focused),onStart:()=>{f=window.setTimeout(()=>{t.pause(!0)},200)},onReset:F=>{if(window.clearTimeout(f),!F||!e.paused||U(F.target,"btn-icon")||U(F.target,Se.ViewerStoryPrivacy)||U(F.target,"btn-corner")||U(F.target,Se.ViewerStoryReactions))return;const N=U(F.target,Se.ViewerStory);if(N?.querySelector("."+Se.ViewerStoryCaption)?.scrollTop)return;N&&e.hideInterface&&document.addEventListener("click",X,{capture:!0,once:!0});const R=e.playAfterGesture||!e.hideInterface;t.toggleInterface(!1),R&&t.play()}});let v;const b=()=>{const F=o.target?.();if(!F||!F.classList.contains("avatar")){i(!0);return}v=dn({size:qp,isDialog:!1,useCache:!1}),v.node.style.cssText="position: absolute; visibility: hidden; z-index: 1000; transform-origin: top left;",document.body.append(v.node),Zt(()=>s())||Ne(()=>{v.ready()&&i(!0)}),Ne(()=>{const N=e.peer?.peerId;!N||!v||Zt(()=>{v.render({peerId:N})})}),Et(()=>{v&&v.node.remove()})},w=F=>{O&&X(F);const G=U(F.target,Se.ViewerStory)?.querySelector("."+Se.ViewerStoryCaptionText),R=G&&hu(G,F);if(R)return d(R),!1};h.addEventListener("click",w,{capture:!0});const S=_h(),I={type:"stories",onPop:()=>{if(O)return!1;d()}};dt.pushItem(I);const L=(F=h)=>F.querySelector(`.${Se.ViewerStoryContainer}:not(.${Se.small})`),M=(F,N,G)=>{const R=L(F);if(!et.isAvailable("animations")||!R){G();return}const B=Array.from(F.querySelectorAll(`.${Se.ViewerStoryContainer}`));let H;const z=Zt(()=>{const te=o.target?.();if(!te)return;const le=U(te,"scrollable");if(!le)return te;const me=Fr(te,le);if(!me){v&&(v.node.remove(),v=void 0);return}return v&&(me.overflow.horizontal||me.overflow.vertical)&&(H=!0),te}),W=z&&(z.querySelector(".avatar")||z).getBoundingClientRect(),ue=R.getBoundingClientRect(),K=v?"50%":window.getComputedStyle(R).borderRadius,ee=te=>(N||te.reverse(),te),_e={duration:250,easing:"cubic-bezier(0.4, 0.0, 0.6, 1)"};let ae,re;if(v){re=R.querySelector(`.${Se.ViewerStoryHeaderAvatar}`),re.style.visibility="hidden";const te=re.getBoundingClientRect();v.node.style.top=`${W.top}px`,v.node.style.left=`${W.left}px`,v.node.style.visibility="",v.node.parentElement||document.body.append(v.node);const le=te.left-W.left,me=te.top-W.top,Ee=ee([{transform:`translate(0, 0) scale(${W.width/qp})`},{transform:`translate(${le}px, ${me}px) scale(1)`}]);H&&(Ee[0].opacity=0,Ee[1].opacity=1),ae=v.node.animate(Ee,_e)}const Ue=W&&W.left-nt.width/2+W.width/2,ye=W&&W.top-nt.height/2+W.height/2,Z=W&&R.animate(ee([{borderRadius:K,transform:`translate3d(${Ue}px, ${ye}px, 0) scale3d(${W.width/ue.width}, ${W.height/ue.height}, 1)`,opacity:0},{opacity:1,offset:.3},{borderRadius:"0%",transform:"translate3d(0, 0, 0) scale3d(1, 1, 1)"}]),_e),de=(Z?[u,!n()&&p].filter(Boolean):[R,F]).map(te=>te.animate(ee([{opacity:0},{opacity:1}]),_e)),be=B.indexOf(R);B.splice(be,1);const pe=B.slice(0,be),xe=B.slice(be),ne=(te,le)=>W?te.map((me,Ee,Ie)=>{const Ke=(le?Ee+1:Ie.length-Ee)*60*(le?-1:1);return me.animate(ee([{transform:`translate3d(calc(var(--translateX) + ${Ke}px), 0, 0) scale3d(${Ll/2}, ${Ll/2}, 1)`,opacity:.001},{opacity:.001,offset:.5},{transform:`translate3d(var(--translateX), 0, 0) scale3d(${Ll}, ${Ll}, 1)`,opacity:1}]),_e)}):te.map(me=>me.animate(ee([{opacity:0},{opacity:1}]),_e)),j=[...de,Z,ae,...ne(pe,!1),...ne(xe,!0)].map(te=>te?.finished);return Promise.all(j).then(()=>{v&&(v.node.remove(),re.style.visibility=""),G()})};let P;const E=F=>{t.toggleSorting("viewer",F),hi.isDarkOverlayActive=F,ut.checkAnimations2(F),F&&(P=hi.overlaysActive)},k=jw();let A;k.add(aa)("change",F=>{if(F){A=!e.paused,t.pause(),vy.open();return}const N=()=>{clearTimeout(G)};document.body.addEventListener("mousedown",N,{once:!0});const G=setTimeout(()=>{document.body.removeEventListener("mousedown",N),vy.close()},100);A&&t.play()});let x;k.add(hi)("change",()=>{const F=hi.overlaysActive;F>P?(x=!e.paused,t.pause()):F===P&&x&&t.play()});let T=Rt(),O=!0;return ke(kh,{get when(){return a()},fallback:g,get children(){return ke(_P,{onEnter:(F,N)=>{wr(T,1e3),document.body.addEventListener("keydown",l),E(!0),M(F,!0,N)},onAfterEnter:()=>{O=!1,t.viewerReady(!0),T.resolve()},onExit:(F,N)=>{O=!0,t.viewerReady(!1),M(F,!1,N)},onAfterExit:()=>{O=!1,o.onExit?.(),stop(),T.resolve()},appear:!0,get children(){return s()&&g}})}})}const Wc=o=>o.peers&&!o.onExit?qs(e=>(o.onExit=()=>e(),ke(og,{get peers(){return o.peers},get index(){return o.index},get children(){return Wc(o)}}))):ke(Cv,{get mount(){return document.getElementById("stories-viewer")},get children(){return ke(sT,o)}}),iT=o=>{const[,e]=da(o,["peerId","storyItem"]);return Wc({...e,peers:[{peerId:o.peerId,stories:[o.storyItem],index:0,count:1}],index:0})},Da=async o=>{const[,e]=da(o,["peerId","id"]),t=await C.managers.appStoriesManager.getPeerStories(o.peerId),s=o.id?t.stories.findIndex(i=>i.id===o.id):void 0;if(o.id){const i=await C.managers.appStoriesManager.getStoryById(o.peerId,o.id);if(!i){Re({langPackKey:"Story.ExpiredToast"});return}iT({...e,peerId:o.peerId,storyItem:i,singleStory:!0});return}Wc({...e,peers:[{peerId:o.peerId,stories:t.stories,maxReadId:t.max_read_id,index:s,count:t.stories.length}],index:0})};Dr(["click"]);const nT=He("<span class=delimiter-with-text><span class=delimiter-with-text-stripe></span><span class=delimiter-with-text-stripe>"),aT=He("<a class=bubble-giveaway-link>"),rT=He("<b>"),oT=He("<br>"),wy=He("<div class=bubble-giveaway-channels>"),lT=He("<div class=bubble-giveaway-countries>"),cT=He("<div class=bubble-giveaway-and-more>"),dT=He("<div><div class=bubble-giveaway-sticker><div class=bubble-giveaway-sticker-counter></div></div><div class=bubble-giveaway-row><div class=bubble-giveaway-row-title></div></div><div class=bubble-giveaway-row><div class=bubble-giveaway-row-title></div></div><div class=bubble-giveaway-row><div class=bubble-giveaway-row-title>");function Yp(o){return{3:"Gift3",6:"Gift6",12:"Gift12"}[Ot(o,3,12)]}function Qw(o){return(()=>{const e=nT(),t=e.firstChild,s=t.nextSibling;return q(e,()=>_(o.langKey),s),e})()}async function hT(o){const e=o.media,t=await C.managers.appPaymentsManager.getGiveawayInfo(o.peerId,o.mid),s=document.createDocumentFragment(),i=Cr(e.months,!0),n=o.fwdFromId||o.peerId,a=e._==="messageMediaGiveawayResults",r=t._==="payments.giveawayInfoResults",l=r&&t.pFlags.refunded,c=!l&&r&&t.pFlags.winner,d=!r&&t.pFlags.participating,h=e.pFlags.only_new_subscribers,u=a?e.winners_count+e.unclaimed_count:e.quantity,p=a?e.additional_peers_count||0:e.channels.length-1,m=L=>Ss(L,void 0,!0);let g="Giveaway.Info";const f=[m(r?t.finish_date:e.until_date),_("Giveaway.Info.Users",[u]),await Oe({peerId:n})];p&&(g+=".Several",f.push(_("Giveaway.Info.OtherChannels",[p]))),h&&(g+=".Date",f.push(m(t.start_date))),r&&(g+=".End");let y,v,b;l?y="BoostingGiveawayCanceledByPayment":c?(y="Giveaway.Won",v=[Pe("🏆")],b=!0):r?(y="BoostingGiveawayYouNotWon",b=!0):t.joined_too_early_date?(y="BoostingGiveawayNotEligible",v=[m(t.joined_too_early_date)]):t.disallowed_country?y="BoostingGiveawayNotEligibleCountry":t.admin_disallowed_chat_id?(y="BoostingGiveawayNotEligibleAdmin",v=[await Oe({peerId:t.admin_disallowed_chat_id.toPeerId(!0)})]):(y=d?"Giveaway.Participation":"Giveaway.TakePart",v=[await Oe({peerId:n})],p&&(y+=".Multi",v.push(_("Giveaway.Info.OtherChannels",[p]))),!d&&t.start_date&&v.push(m(e.until_date)));const w=_(r?"BoostingGiveawayHowItWorksTextEnd":"BoostingGiveawayHowItWorksText",[void 0,await Oe({peerId:n}),u,i]),S=_(g,f),I=_(y,v);(b||l)&&I.classList.add("popup-description-framed"),l&&I.classList.add("popup-description-danger"),s.append(...[...b?[I,document.createElement("br")]:[],w,document.createElement("br"),document.createElement("br"),...e.prize_description?[_("Giveaway.AlsoPrizes",[await Oe({peerId:n}),u,Pe(e.prize_description),_("Giveaway.AlsoPrizes2",[u])]),document.createElement("br"),document.createElement("br")]:[],S,...r&&t.activated_count?[" ",_("BoostingGiveawayUsedLinksPlural",[t.activated_count])]:[],...b?[]:[document.createElement("br"),document.createElement("br"),I]].filter(Boolean)),await ft({titleLangKey:r?"BoostingGiveawayEnd":"BoostingGiveAwayAbout",description:s,button:c?{langKey:"BoostingGiveawayViewPrize"}:{langKey:"OK",isCancel:!0}}),c&&J.createPopup(Kn,t.gift_code_slug)}function uT(o){const e=Ii().get(),t=o.giveaway,s=t._==="messageMediaGiveawayResults",i=s?t.winners_count:t.quantity,n=!s&&t.countries_iso2?.map(f=>{const y=document.createElement("span");y.classList.add("bubble-giveaway-country");const v=De.countriesList.find(b=>b.iso2===f);return y.append(Pe(cp(f)+" "+(v.name||v.default_name))),y}),a=Cr(t.months,!0);let r;if(s){let f;(()=>{const y=aT(),v=f;return typeof v=="function"?Nt(v,y):f=y,mt(()=>Mo(y,"data-saved-from",`${t.channel_id.toPeerId(!0)}_${t.launch_msg_id}`)),y})(),r=he(()=>_("Giveaway.Results.Subtitle",[i,f]))}else r=t.prize_description?[(()=>{const f=rT();return q(f,`${i} `),f})(),he(()=>Pe(t.prize_description)),ke(Qw,{langKey:"Giveaway.With"}),he(()=>_(i>1?"Giveaway.WithSubscriptionsPlural":"Giveaway.WithSubscriptionsSingle",[a]))]:[he(()=>_("BoostingGiveawayMsgInfoPlural1",[i])),oT(),he(()=>_("BoostingGiveawayMsgInfoPlural2",[a]))];const l=f=>{const y=li.renderEntity({key:f,middleware:e,avatarSize:30,meAsSaved:!1});return ce.setPeerColorToElement(f,y.element),y.element.classList.add("bubble-giveaway-channel","hover-primary"),y.element},c=!s&&(()=>{const f=wy();return q(f,ke(Mi,{get each(){return t.channels},children:y=>l(y.toPeerId(!0))})),f})(),d=n&&(()=>{const f=lT();return q(f,()=>_("BoostingGiveAwayFromCountries",[ci(n)])),f})();let h;s?h=[(()=>{const f=wy();return q(f,ke(Mi,{get each(){return t.winners},children:y=>l(y.toPeerId(!1))})),f})(),he((()=>{const f=he(()=>t.winners_count>t.winners.length);return()=>f()&&(()=>{const y=cT();return q(y,()=>_("Giveaway.Results.AndMore",[t.winners_count-t.winners.length])),y})()})())]:h=[he(()=>_(t.pFlags.only_new_subscribers?"BoostingGiveawayMsgNewSubsPlural":"BoostingGiveawayMsgAllSubsPlural",[t.channels.length])),c,d];let u;const p=(()=>{const f=dT(),y=f.firstChild,v=y.firstChild,b=y.nextSibling,w=b.firstChild,S=b.nextSibling,I=S.firstChild,L=S.nextSibling,M=L.firstChild,P=u;return typeof P=="function"?Nt(P,y):u=y,q(v,`X${i}`),q(w,()=>_(s?"Giveaway.Results.Title":"BoostingGiveawayPrizes",[i])),q(b,r,null),q(I,()=>_(s?"BoostingGiveawayResultsMsgWinners":"BoostingGiveawayMsgParticipants",[i])),q(S,h,null),q(M,()=>_(s?"Giveaway.Results.Footer":"BoostingWinnersDate",[i])),q(L,()=>!s&&Ss(t.until_date),null),mt(()=>st(f,jt("bubble-giveaway","no-select","disable-hover",s&&"bubble-giveaway-results"))),f})(),m=s?80:160,g=$h({width:m,height:m,assetName:s?"Congratulations":Yp(t.months),middleware:e,loop:!1,autoplay:et.isAvailable("stickers_chat")}).then(({container:f,promise:y})=>(u.style.position="relative",u.style.width=u.style.height=m+"px",u.append(f),y));return o.loadPromises.push(g),p}const pT=He("<div class=popup-toggle-read-date-title>"),mT=He("<div class=popup-toggle-read-date-subtitle>"),gT=He("<button>"),fT=He("<div class=popup-toggle-read-date-sticker>");class Yw extends J{constructor(e,t){super("popup-toggle-read-date",{closable:!0,overlayClosable:!0,body:!0}),this.peerId=e,this.type=t,this.construct()}_construct(){const e=this,t=n=>{let a;return[(()=>{const r=pT();return q(r,()=>n.title),r})(),(()=>{const r=mT();return q(r,()=>n.text),r})(),(()=>{const r=gT();r.$$click=()=>{n.onClick()instanceof Promise&&zt(a,!0)};const l=a;return typeof l=="function"?Nt(l,r):a=r,q(r,()=>_(n.buttonText)),mt(()=>st(r,"btn-primary btn-color-primary popup-toggle-read-date-button"+(n.isPremium?" popup-gift-premium-confirm shimmer":""))),r})()]},i={lastSeen:{title1:"PremiumLastSeenHeader1",text1:"PremiumLastSeenText1",lockedText:"PremiumLastSeenText1Locked",buttonText1:"PremiumLastSeenButton1",onClick:async()=>{await this.managers.appPrivacyManager.setPrivacy("inputPrivacyKeyStatusTimestamp",[{_:"inputPrivacyValueAllowAll"}]),this.hide(),Re({langPackKey:"PremiumLastSeenSet"})},title2:"PremiumLastSeenHeader2",text2:"PremiumLastSeenText2",buttonText2:"PremiumLastSeenButton2"},readTime:{title1:"PremiumReadHeader1",text1:"PremiumReadText1",lockedText:"PremiumReadText1Locked",buttonText1:"PremiumReadButton1",onClick:async()=>{const n=await this.managers.appPrivacyManager.getGlobalPrivacySettings();await this.managers.appPrivacyManager.setGlobalPrivacySettings({_:"globalPrivacySettings",pFlags:{...n.pFlags,hide_read_marks:void 0}}),this.hide(),Re({langPackKey:"PremiumReadSet"})},title2:"PremiumReadHeader2",text2:"PremiumReadText2",buttonText2:"PremiumReadButton2"}}[this.type];return[(()=>{const n=fT();return q(n,()=>e.stickerContainer),n})(),ke(t,{get title(){return _(i.title1)},get text(){return _(e.isPremiumPurchaseBlocked?i.lockedText:i.text1,[e.titles[0]])},get buttonText(){return i.buttonText1},get onClick(){return i.onClick}}),he((()=>{const n=he(()=>!e.isPremiumPurchaseBlocked);return()=>n()&&[ke(Qw,{langKey:"PremiumOr"}),ke(t,{get title(){return _(i.title2)},get text(){return _(i.text2,[e.titles[1]])},get buttonText(){return i.buttonText2},onClick:()=>{e.hide(),ps.show()},isPremium:!0})]})())]}async construct(){const[e,t,s]=await Promise.all([Promise.all(new Array(2).fill(0).map(()=>Oe({peerId:this.peerId,onlyFirstName:!0}))),fe.isPremiumPurchaseBlocked(),$h({width:86,height:86,assetName:this.type==="lastSeen"?"large_lastseen":"large_readtime",middleware:this.middlewareHelper.get(),loop:!1,autoplay:et.isAvailable("stickers_chat")}).then(async({container:a,promise:r})=>(await r,a))]);this.titles=e,this.isPremiumPurchaseBlocked=t,this.stickerContainer=s;const i=document.createElement("div");this.body.append(i);const n=$a(()=>this._construct(),i);this.addEventListener("closeAfterTimeout",n),this.show()}}Dr(["click"]);const Za=(o,e)=>{St(e.title,o||void 0),e.container.style.display=o?"":"none"};class Xw{constructor(e,t,s,i=!0){this.managers=e,this.scrollable=t,this.listenerSetter=s,this.isDialog=i,Jr||this.scrollable.container.classList.add("no-parallax"),s||(this.listenerSetter=new Qt),this.middlewareHelper=Gt()}init(){this.init=null,this.element=document.createElement("div"),this.element.classList.add("profile-content"),this.section=new Ce({noDelimiter:!0}),this.name=document.createElement("div"),this.name.classList.add("profile-name"),this.subtitle=document.createElement("div"),this.subtitle.classList.add("profile-subtitle"),this.bio=new ge({title:" ",subtitle:!0,icon:"info",clickable:i=>{i.target.tagName!=="A"&&(Us(this.bio.title.textContent),Rs(De.format("BioCopied",!0)))},listenerSetter:this.listenerSetter,contextMenu:{buttons:[{icon:"copy",text:"Text.CopyLabel_About",onClick:()=>{hs(this.bio.container)},verify:()=>!this.peerId.isUser()},{icon:"copy",text:"Text.CopyLabel_Bio",onClick:()=>{hs(this.bio.container)},verify:()=>this.peerId.isUser()}]}}),this.bio.title.classList.add("pre-wrap"),this.username=new ge({title:" ",subtitleLangKey:"Username",icon:"username",clickable:()=>{Us("@"+this.username.title.textContent),Rs(De.format("UsernameCopied",!0))},listenerSetter:this.listenerSetter,contextMenu:{buttons:[{icon:"copy",text:"Text.CopyLabel_Username",onClick:()=>{hs(this.username.container)}}]}}),this.phone=new ge({title:" ",subtitle:!0,icon:"phone",clickable:()=>{Us(this.phone.title.textContent.replace(/\s/g,"")),Rs(De.format("PhoneCopied",!0))},listenerSetter:this.listenerSetter,contextMenu:{buttons:[{icon:"copy",text:"Text.CopyLabel_PhoneNumber",onClick:()=>{hs(this.phone.container)}},{icon:"info",text:"PeerInfo.Phone.AnonymousInfo",textArgs:[document.createElement("a")],onClick:()=>{qm("https://fragment.com/numbers")},separator:!0,secondary:!0,verify:async()=>{const{isAnonymous:i}=await this.managers.appUsersManager.getUserPhone(this.peerId.toUserId())||{};return i}}]}}),this.link=new ge({title:" ",subtitleLangKey:"SetUrlPlaceholder",icon:"link",clickable:()=>{const i=this.link.title.textContent;Us(i);const n=i.includes("/c/");Rs(De.format(n?"LinkCopiedPrivateInfo":"LinkCopied",!0))},listenerSetter:this.listenerSetter,contextMenu:{buttons:[{icon:"copy",text:"Text.CopyLabel_ShareLink",onClick:()=>{hs(this.link.container)}}]}}),this.location=new ge({title:" ",subtitleLangKey:"ChatLocation",icon:"location"}),this.section.content.append(this.phone.container,this.username.container,this.location.container,this.bio.container,this.link.container);const{listenerSetter:e}=this;this.isDialog&&(this.notifications=new ge({checkboxField:new ct({toggle:!0}),titleLangKey:"Notifications",icon:"unmute",listenerSetter:this.listenerSetter}),e.add(this.notifications.checkboxField.input)("change",i=>{i.isTrusted&&this.managers.appMessagesManager.togglePeerMute({peerId:this.peerId,threadId:this.threadId})}),e.add(C)("dialog_notify_settings",async i=>{if(this.peerId===i.peerId){const n=await this.managers.appNotificationsManager.isPeerLocalMuted({peerId:this.peerId,respectType:!1,threadId:this.threadId});this.notifications.checkboxField.checked=!n}}),this.section.content.append(this.notifications.container)),this.element.append(this.section.container),Jr&&this.element.append(Hh()),e.add(C)("peer_typings",({peerId:i})=>{this.peerId===i&&this.setPeerStatus()}),e.add(C)("peer_bio_edit",i=>{i===this.peerId&&this.setMoreDetails(!0)});const t=async({peerId:i,threadId:n})=>this.peerId!==i?!1:!((this.peerId.isAnyChat()?await this.managers.appPeersManager.isForum(this.peerId):!1)&&this.threadId)||this.threadId===n;e.add(C)("peer_title_edit",async i=>{const n=this.middlewareHelper.get();if(await t(i)){if(!n())return;this.fillUsername().then(a=>{n()&&a?.()}),this.setMoreDetails(!0)}}),e.add(C)("user_update",i=>{this.peerId===i.toPeerId()&&this.setPeerStatus()}),e.add(C)("contacts_update",async i=>{this.peerId===i.toPeerId()&&(!(await this.managers.appUsersManager.getUser(i)).pFlags.self||!this.isDialog)&&this.fillUserPhone()}),e.add(C)("avatar_update",async i=>{await t(i)&&this.setAvatar()});const s=()=>{this.peerId.isUser()&&this.managers.appUsersManager.getApiUsers([this.peerId.toUserId()])};e.add(C)("premium_toggle",s),e.add(C)("privacy_update",i=>{i.key._==="privacyKeyStatusTimestamp"&&s()}),this.setPeerStatusInterval=window.setInterval(()=>this.setPeerStatus(),6e4)}async setPeerStatus(e=!1,t){const s=this.peerId,i=[];i.push(()=>{if(this.element.classList.toggle("is-me",s===C.myId),s.isUser()&&fe.getUser(s.toUserId()).status?.pFlags?.by_me){const l=_("StatusHiddenShow");l.classList.add("show-when"),D(l,c=>{X(c),J.createPopup(Yw,s,"lastSeen")}),this.subtitle.append(l)}});let n=Promise.resolve();if(!(!s||C.myId===s&&this.isDialog)&&s!==mm){const r=await this.managers.appPeersManager.isForum(this.peerId),l=this.middlewareHelper.get();r&&this.threadId?n=jb({peerId:s,wrapOptions:{middleware:l}}).then(({element:c})=>{this.subtitle.replaceChildren(c)}):n=ce.setPeerStatus({peerId:s,element:this.subtitle,needClear:e,useWhitespace:!0,middleware:l,ignoreSelf:!this.isDialog}),n.then(c=>c&&i.unshift(c))}const a=()=>i.forEach(r=>r());return n.then(()=>{if(t)return a;a()})}cleanupHTML(){[this.bio,this.phone,this.username,this.location,this.link].forEach(e=>{e.container.style.display="none"}),this.notifications&&(this.notifications.container.style.display="",this.notifications.checkboxField.checked=!0),this.clearSetMoreDetailsTimeout()}isSavedDialog(){return!!(this.peerId===C.myId&&this.threadId)}getDetailsForUse(){const{peerId:e,threadId:t}=this;return this.isSavedDialog()?{peerId:t,threadId:void 0}:{peerId:e,threadId:t}}canBeDetailed(){return this.peerId!==C.myId||!this.isDialog}async _setAvatar(){const e=this.middlewareHelper.get(),{peerId:t,threadId:s}=this.getDetailsForUse(),i=!!(s&&await this.managers.appPeersManager.isForum(t));if(this.canBeDetailed()&&!i&&(await this.managers.appPeersManager.getPeerPhoto(t)||pb)){const l=this.avatars;this.avatars=new _p(this.scrollable,this.managers);const[c]=await Promise.all([this.fillName(e,!0),this.avatars.setPeer(t)]);return()=>{c(),this.avatars.info.append(this.name,this.subtitle),this.avatar&&this.avatar.node.remove(),this.avatar=void 0,l?l.container.replaceWith(this.avatars.container):this.element.prepend(this.avatars.container),Jr&&this.scrollable.container.classList.add("parallax")}}const n=ls({middleware:e,size:120,isDialog:this.isDialog,peerId:t,threadId:i?s:void 0,wrapOptions:{customEmojiSize:ys(120,120),middleware:e},withStories:!0,meAsNotes:!!(t===C.myId&&this.threadId)});n.node.classList.add("profile-avatar","avatar-120");const[a]=await Promise.all([this.fillName(e,!1),n.readyThumbPromise]);return()=>{a(),Jr&&this.scrollable.container.classList.remove("parallax"),this.avatars&&(this.avatars.container.remove(),this.avatars.cleanup(),this.avatars=void 0),this.avatar&&this.avatar.node.remove(),this.avatar=n,this.section.content.prepend(this.avatar.node,this.name,this.subtitle)}}setAvatar(e){const t=this._setAvatar();return e?t:t.then(s=>s())}getUsernamesAlso(e){const t=e.slice(1);if(t.length){const s=t.map(n=>hb({username:n}));return _("UsernameAlso",[ci(s,!1)])}}async fillUsername(){const{peerId:e}=this;if(e.isUser()&&this.canBeDetailed()){const t=await this.managers.appPeersManager.getPeerActiveUsernames(e),s=this.getUsernamesAlso(t);return()=>{this.username.subtitle.replaceChildren(s||_("Username")),Za(t[0],this.username)}}}async fillUserPhone(){const{peerId:e}=this;if(e.isUser()&&this.canBeDetailed()){const{phone:t,isAnonymous:s}=await this.managers.appUsersManager.getUserPhone(e.toUserId())||{};return()=>{this.phone.subtitle.replaceChildren(_(s?"AnonymousNumber":"Phone")),Za(t?jm(t):void 0,this.phone)}}}async fillNotifications(){const e=this.notifications;if(e)if(this.canBeDetailed()){const t=await this.managers.appNotificationsManager.isPeerLocalMuted({peerId:this.peerId,respectType:!1,threadId:this.threadId});return()=>{e.checkboxField.checked=!t}}else return()=>{e.container.style.display="none"}}async fillName(e,t){const{peerId:s}=this.getDetailsForUse(),[i]=await Promise.all([Oe({peerId:s,dialog:this.isDialog,withIcons:!this.threadId,threadId:this.threadId,wrapOptions:{middleware:e,textColor:t?"white":void 0},meAsNotes:!!(s===C.myId&&this.threadId)})]);return()=>{tt(this.name,i)}}async fillRows(e){return Promise.all([this.fillUsername(),this.fillUserPhone(),this.fillNotifications(),this.setMoreDetails(void 0,e),this.setPeerStatus(!0,!0)]).then(t=>()=>{t.forEach(s=>s?.())})}async fillProfileElements(){if(!this.cleaned)return;this.cleaned=!1,this.cleanupHTML();const e=Rt();this.middlewareHelper.get().onClean(()=>{e.reject()});const s=await Promise.all([this.setAvatar(!0),this.fillRows(e)]);return()=>{e.resolve(),s.forEach(i=>i?.())}}async _setMoreDetails(e,t,s){const i=this.getMiddlewarePromise(),n=!!(this.threadId&&await i(this.managers.appPeersManager.isForum(e))),a=e.isUser()?await i(this.managers.appUsersManager.isPremium(e.toUserId())):void 0;if(n){let c="https://t.me/";const d=Gi(this.threadId),h=await i(this.managers.appPeersManager.getPeerUsername(e));return h?c+=`${h}/${d}`:c+=`c/${e.toChatId()}/${d}`,()=>{Za(c,this.link)}}const r=[];if(r.push(()=>{this.bio.subtitle.replaceChildren(_(e.isUser()?"UserBio":"Info")),Za(t.about?us(t.about,{whitelistedDomains:a?void 0:s.whitelisted_domains}):void 0,this.bio)}),!e.isUser()){const c=await i(this.managers.appChatsManager.getChat(e.toChatId())),d=si(c);let h;if(d.length)h=this.getUsernamesAlso(d),r.push(()=>Za("https://t.me/"+d[0],this.link));else{const u=t.exported_invite;u?._==="chatInviteExported"&&r.push(()=>Za(u.link,this.link))}r.push(()=>this.link.subtitle.replaceChildren(h||_("SetUrlPlaceholder")))}const l=t.location;return l?._=="channelLocation"&&r.push(()=>Za(l.address,this.location)),this.setMoreDetailsTimeout=window.setTimeout(()=>this.setMoreDetails(!0),6e4),()=>{r.forEach(c=>c())}}async setMoreDetails(e,t){this.clearSetMoreDetailsTimeout();const{peerId:s}=this,i=this.getMiddlewarePromise();if(!s||!this.canBeDetailed()||await i(this.managers.appPeersManager.isPeerRestricted(s)))return;const n=await i(Promise.all([this.managers.acknowledged.appProfileManager.getProfileByPeerId(s,e),this.managers.acknowledged.apiManager.getAppConfig()])),a=n.map(l=>l.result),r=i(Promise.all(a)).then(async([l,c])=>{if(!await i(this.managers.appPeersManager.isPeerRestricted(s)))return i(this._setMoreDetails(s,l,c))});if(n.every(l=>l.cached)&&t)return r;(t||Promise.resolve()).then(()=>r).then(l=>{l?.()})}getMiddlewarePromise(){return Ir(this.middlewareHelper.get(),Rc("MIDDLEWARE"))}setPeer(e,t){this.peerId===e&&this.threadId===t||(this.init?.(),this.peerId=e,this.threadId=t,this.middlewareHelper.clean(),this.cleaned=!0)}clearSetMoreDetailsTimeout(){this.setMoreDetailsTimeout!==void 0&&(clearTimeout(this.setMoreDetailsTimeout),this.setMoreDetailsTimeout=void 0)}destroy(){this.peerId=this.threadId=void 0,this.clearSetMoreDetailsTimeout(),clearInterval(this.setPeerStatusInterval),this.avatars?.cleanup(),this.middlewareHelper.destroy()}}const Sy=64,yT=ys(Sy,Sy);class Xp extends Tt{async init(e,t){this.colorIndex=0;const s=!t,i=t===Co;this.container.classList.add("edit-topic-container"),this.setTitle(s?"NewTopic":"ForumTopic.Title.Edit");const n=e.toChatId();t&&(this.topic=this.originalTopic=Fi(await this.managers.dialogsStorage.getForumTopic(e,t)));{const r=new Ce({name:i?"CreateGeneralTopicTitle":"CreateTopicTitle"}),l=this.iconDiv=document.createElement("div");l.classList.add("edit-topic-icon-container"),!t&&D(l,()=>{this.topic.icon_emoji_id||(this.colorIndex=(this.colorIndex+1)%gl.length,this.setIcon())},{listenerSetter:this.listenerSetter}),t&&l.classList.add("disable-hover");const c=document.createElement("div");c.classList.add("input-wrapper");const d=this.nameInputField=new _t({label:"ForumTopic.Name.Placeholder",withLinebreaks:!1,name:"topic-name",maxLength:70,required:!0});this.topic&&d.setOriginalValue(this.topic.title,!0);const h=this.confirmBtn=Xe("check btn-confirm blue hide",{noRipple:!0});this.header.append(h),D(h,()=>{const u=zt([h],!0);t?this.managers.appChatsManager.editForumTopic({chatId:n,topicId:t,title:d.value,iconEmojiId:this.topic.icon_emoji_id||0}).then(()=>{this.close()}).catch(p=>{console.error("edit topic error",p),u()}):this.managers.appChatsManager.createForumTopic({chatId:n,iconColor:gl[this.colorIndex],iconEmojiId:this.topic.icon_emoji_id,title:d.value}).then(p=>{this.close(),ce.setInnerPeer({peerId:e,threadId:p})}).catch(p=>{console.error("create topic error",p),u()})},{listenerSetter:this.listenerSetter}),this.listenerSetter.add(d.input)("input",()=>{this.validate(),this.setIcon(this.topic?.icon_emoji_id)}),c.append(d.container),r.content.append(l,c),this.scrollable.append(r.container)}const a=[];if(i){const r=new Ce({caption:"EditTopicHideInfo"}),l=new ct({checked:!this.topic.pFlags.hidden,text:"EditTopicHide"});this.listenerSetter.add(l.input)("change",()=>{const d=this.managers.appChatsManager.editForumTopic({chatId:n,topicId:t,hidden:!l.checked});c.disableWithPromise(d)});const c=new ge({checkboxField:l});r.content.append(c.container),this.scrollable.append(r.container)}else{const r=new Ce({});r.container.classList.add("edit-topic-emoticons-container");const l=new Fn({managers:this.managers,isStandalone:!0,noRegularEmoji:!0,mainSets:()=>this.managers.appStickersManager.getLocalStickerSet("inputStickerSetEmojiDefaultTopicIcons").then(d=>d.documents.map(h=>h.id)),onClick:d=>{l.setActive(d.docId?d:{emoji:void 0,docId:void 0}),this.setIcon(d.docId)}});l.getContainerSize=()=>({width:ri.rect.width,height:400}),this.middlewareHelper.onDestroy(()=>{l.destroy()}),l.container.classList.remove("tabs-tab"),this.emojiElement=document.createElement("span"),this.emojiElement.classList.add("super-emoji-topic-icon");const c=l.init().then(async()=>{const d=l.getCustomCategory(),h=this.topic?.icon_emoji_id;l.addEmojiToCategory({category:d,element:this.emojiElement,batch:!1,prepend:!0,active:!h}),h&&l.setActive({docId:h,emoji:""})});a.push(c),r.content.replaceWith(l.container),this.scrollable.append(r.container)}return Promise.all(a).then(()=>this.s())}validate(){let e=this.nameInputField.isValidToChange();!e&&this.originalTopic&&(e=this.topic.icon_emoji_id!==this.originalTopic.icon_emoji_id),this.confirmBtn.classList.toggle("hide",!e)}s(){return this.topic?.icon_color&&(this.colorIndex=gl.indexOf(this.topic.icon_color)),this.setIcon(this.topic?.icon_emoji_id,void 0,!0)}async setIcon(e,t=this.iconDiv,s){const i=this.nameInputField.value,n=t===this.iconDiv;if(n){const d={id:this.topic?.id,icon_color:gl[this.colorIndex],title:Em(i,!0).text||"A",icon_emoji_id:e},h=this.topic;if(this.topic=d,(s||!h||h.icon_color!==d.icon_color||h.title!==d.title)&&this.setIcon(void 0,this.emojiElement),Li(h,d)&&!s)return;this.validate()}const a=await Fh({topic:n?this.topic:{...this.topic,icon_emoji_id:void 0},customEmojiSize:yT,middleware:this.middlewareHelper.get()}),r=document.createElement("div");r.classList.add("edit-topic-icon"),r.append(a);const l=t.lastElementChild;t.append(r);const c=(d,h)=>{const u=[{opacity:"0",transform:"scale(0.8)"},{opacity:"1",transform:"scale(1)"}],p=d.animate(u,{duration:200,iterations:1,easing:"ease-in-out",fill:"forwards",direction:h?"normal":"reverse"});return new Promise(m=>{p.addEventListener("finish",()=>{m()},{once:!0})})};l&&c(l,!1).then(()=>l.remove()),c(r,!0)}}class Cy extends Tt{async init(e){const t=e.toUserId();this.container.classList.add("edit-profile-container"),this.setTitle("EditBot.Title");const s=[],[i,n,a]=await Promise.all([this.managers.apiManager.getLimit("bio"),this.managers.appUsersManager.getUser(t),this.managers.appProfileManager.getBotInfo(t)]);{const r=Eo(this.scrollable,void 0),l=document.createElement("div");l.classList.add("input-wrapper"),this.firstNameInputField=new _t({label:"EditProfile.FirstNameLabel",name:"first-name",maxLength:70}),this.aboutInputField=new _t({label:"DescriptionPlaceholder",name:"bio",maxLength:i}),l.append(this.firstNameInputField.container,this.aboutInputField.container),s.push(this.firstNameInputField,this.aboutInputField),this.editPeer=new Uc({peerId:e,inputFields:s,listenerSetter:this.listenerSetter,middleware:this.middlewareHelper.get()}),this.content.append(this.editPeer.nextBtn),r.append(this.editPeer.avatarEdit.container,l)}{const r=Eo(this.scrollable,void 0,"EditBot.Buttons.Caption"),l=Ve("btn-primary btn-transparent",{icon:"info",text:"EditBot.Buttons.Intro",asLink:!0}),c=Ve("btn-primary btn-transparent",{icon:"botcom",text:"EditBot.Buttons.Commands",asLink:!0}),d=Ve("btn-primary btn-transparent",{icon:"bots",text:"EditBot.Buttons.Settings",asLink:!0}),h="t.me/botfather?start="+Yl(n);[[l,"intro"],[c,"commands"],[d,""]].forEach(([p,m])=>{const g=Eh(h+(m?"-"+m:""));p.href=g.url,p.setAttribute("onclick",g.onclick+"(this)")}),r.append(l,c,d)}{const r=new Ce({name:"EditAccount.Username",caption:!0}),l=document.createElement("div");l.classList.add("input-wrapper"),this.usernameInputField=new Bm({label:"Username",name:"username",plainText:!0,listenerSetter:this.listenerSetter,onChange:()=>{this.editPeer.handleChange();const{error:u}=this.usernameInputField,p=u?.type==="USERNAME_PURCHASE_AVAILABLE";d(p?this.usernameInputField.value:void 0)},availableText:"EditProfile.Username.Available",takenText:"EditProfile.Username.Taken",invalidText:"EditProfile.Username.Invalid"},this.managers),l.append(this.usernameInputField.container);const c=r.caption,{setUsername:d,element:h}=Um();c.append(_("EditBot.Username.Caption"),h),s.push(this.usernameInputField),r.content.append(l),this.scrollable.append(r.container)}{const r=new Om({peerId:e,peer:n,listenerSetter:this.listenerSetter,usernameInputField:this.usernameInputField,middleware:this.middlewareHelper.get()});this.scrollable.append(r.container)}D(this.editPeer.nextBtn,()=>{this.editPeer.nextBtn.disabled=!0;const r=[],l=this.managers.appProfileManager.setBotInfo(t,this.firstNameInputField.value,this.aboutInputField.value);r.push(l.then(()=>{this.close()},c=>{console.error("updateProfile error:",c)})),this.editPeer.uploadAvatar&&r.push(this.editPeer.uploadAvatar().then(c=>this.managers.appProfileManager.uploadProfilePhoto(c,t))),this.usernameInputField.isValidToChange()&&r.push(this.managers.appUsersManager.updateUsername(this.usernameInputField.value)),Promise.race(r).finally(()=>{this.editPeer.nextBtn.removeAttribute("disabled")})},{listenerSetter:this.listenerSetter}),this.firstNameInputField.setOriginalValue(n.first_name,!0),this.aboutInputField.setOriginalValue(a.about,!0),this.usernameInputField.setOriginalValue(Yl(n),!0),this.editPeer.handleChange()}}const hl={};class Tr extends Tt{init(){this.init=null,this.container.classList.add("shared-media-container","profile-container");const e=Ve("btn-icon sidebar-close-button",{noRipple:!0});this.closeBtn.replaceWith(e),this.closeBtn=e;const t=document.createElement("div");t.classList.add("animated-close-icon"),e.append(t),this.isFirst&&t.classList.add("state-back");const s=()=>{const v=document.createElement("div");return v.className="transition slide-fade",v},i=s(),n=(v,b,w)=>{const S=document.createElement("div");S.classList.add("transition-item"),w??(w=this.title.cloneNode()),w.append(v);let I;if(b)S.append(w);else{const L=document.createElement("div");L.classList.add("sidebar-header__rows"),I=document.createElement("div"),I.classList.add("sidebar-header__subtitle"),L.append(w,I),S.append(L)}return{element:S,title:w,subtitle:I}};this.titleI18n=new De.IntlElement;const a=n(this.titleI18n.element,!0,this.title);this.editBtn=Xe("edit");const r=this.btnMenu=yi({listenerSetter:this.listenerSetter,direction:"bottom-left",buttons:[{icon:"message",text:"SavedViewAsMessages",onClick:()=>{ce.toggleViewAsMessages(C.myId,!0)},verify:()=>this.peerId===C.myId&&this.isFirst}]});a.element.append(this.editBtn);let l;(v=>{v[v.Profile=0]="Profile",v[v.Media=1]="Media"})(l||(l={}));const c=n(_("PeerInfo.SharedMedia"));this.sharedMediaTitle=c.title;const d=s();c.subtitle.append(d);const h=[["savedDialogs","SavedDialogsTabCount"],["stories","StoriesCount"],["members","Members"],["media","MediaFiles"],["saved","SavedMessagesCount"],["files","Files"],["links","Links"],["music","MusicFiles"],["voice","Voice"],["groups","CommonGroups"],["similar","SimilarChannelsCount"]];d.append(...h.map(v=>{v[2]=new De.IntlElement({key:"Loading"});const b=document.createElement("div");return b.classList.add("transition-item"),b.append(v[2].element),b})),i.append(...[a,c].map(({element:v})=>v)),this.header.append(i,r),this.noProfile||(this.profile=new Xw(this.managers,this.scrollable,this.listenerSetter),this.profile.init(),this.scrollable.append(this.profile.element));const u=56;this.scrollable.onAdditionalScroll=()=>{const v=this.searchSuper.nav.getBoundingClientRect();if(!v.width)return;const b=v.top-1;m(b<=u)};const p=(v=g.prevId()!==0)=>{let b=0;return v&&(b=1),b},m=v=>{t.classList.toggle("state-back",this.isFirst||v),this.searchSuper.container.classList.toggle("is-full-viewport",v),g(p(v)),v||this.searchSuper.cleanScrollPositions()},g=br({content:i,type:"slide-fade",transitionTime:400,isHeavy:!1});g(this.profile?0:1);const f=br({content:d,type:"slide-fade",transitionTime:400,isHeavy:!1});f(0),D(this.closeBtn,v=>{g.prevId()&&this.profile?(this.scrollable.scrollIntoViewNew({element:this.scrollable.container.querySelector(".profile-content"),position:"start"}),g(0),this.isFirst||t.classList.remove("state-back")):this.scrollable.isHeavyAnimationInProgress||this.slider.onCloseBtnClick()},{listenerSetter:this.listenerSetter}),D(this.editBtn,async()=>{let v;const{peerId:b,threadId:w}=this;w&&await this.managers.appPeersManager.isForum(b)?v=this.slider.createTab(Xp):b.isAnyChat()?v=this.slider.createTab(bf):await this.managers.appUsersManager.isBot(b)?v=this.slider.createTab(Cy):v=this.slider.createTab(Pp),v&&(v instanceof Xp?v.open(b,this.threadId):v instanceof Cy?v.open(b):(v instanceof bf?v.chatId=b.toChatId():v.peerId=b,v.open()))},{listenerSetter:this.listenerSetter}),this.listenerSetter.add(C)("contacts_update",v=>{this.peerId===v.toPeerId(!1)&&this.toggleEditBtn()}),this.listenerSetter.add(C)("chat_update",v=>{this.peerId===v.toPeerId(!0)&&this.toggleEditBtn()}),this.listenerSetter.add(C)("history_multiappend",v=>{this.renderNewMessage(v)}),this.listenerSetter.add(C)("history_delete",({peerId:v,msgs:b})=>{this.deleteDeletedMessages(v,b)}),this.searchSuper=new fg({mediaTabs:[{name:"SharedMedia.SavedDialogs",type:"savedDialogs"},{name:"Stories",type:"stories"},{name:"PeerMedia.Members",type:"members"},{inputFilter:"inputMessagesFilterPhotoVideo",name:"SharedMediaTab2",type:"media"},{inputFilter:"inputMessagesFilterEmpty",name:"SharedMedia.Saved",type:"saved"},{inputFilter:"inputMessagesFilterDocument",name:"SharedFilesTab2",type:"files"},{inputFilter:"inputMessagesFilterUrl",name:"SharedLinksTab2",type:"links"},{inputFilter:"inputMessagesFilterMusic",name:"SharedMusicTab2",type:"music"},{inputFilter:"inputMessagesFilterRoundVoice",name:"SharedVoiceTab2",type:"voice"},{name:"ChatList.Filter.Groups",type:"groups"},{name:"SimilarChannels",type:"similar"}],scrollable:this.scrollable,onChangeTab:v=>{f(h.findIndex(w=>w[0]===v.type));const b=v.type==="members"&&et.isAvailable("animations")?250:0;setTimeout(()=>{y.classList.toggle("is-hidden",v.type!=="members")},b)},managers:this.managers,onLengthChange:(v,b)=>{const w=h.find(S=>S[0]===v);w&&w[2].compareAndUpdate({key:w[1],args:[b]})},openSavedDialogsInner:!this.isFirst,slider:this.slider}),this.searchSuper.scrollStartCallback=()=>{m(!0)},this.profile?this.profile.element.append(this.searchSuper.container):this.scrollable.append(this.searchSuper.container);const y=gi({icon:"addmember_filled"});this.content.append(y),D(y,()=>{qv({peerId:this.peerId,slider:this.slider})},{listenerSetter:this.listenerSetter})}_renderNewMessage(e,t=e.peerId,s){const i=hl[t]?.[s];if(i)for(const n of this.searchSuper.mediaTabs){const a=n.inputFilter,r=i[a];if(!r)continue;let l;if(n.type==="saved"?l=[e].filter(d=>{const h=d.saved_peer_id;return h&&Je(h)===this.searchSuper.searchContext.peerId&&!r.some(u=>u.mid===d.mid)}):l=this.searchSuper.filterMessagesByType([e],a),!l.length)continue;const c=l.filter(d=>!r.find(h=>h.mid===d.mid&&h.peerId===d.peerId)).map(d=>({mid:d.mid,peerId:d.peerId}));r.unshift(...c),(n.type==="saved"?this.peerId===s:this.peerId===t)&&this.searchSuper.usedFromHistory[a]!==-1&&this.threadId===s&&(this.searchSuper.usedFromHistory[a]+=l.length,this.searchSuper.performSearchResult(l,n,!1),this.searchSuper.setCounter(n.type,this.searchSuper.counters[n.type]+l.length))}}async renderNewMessage(e){if(this.init)return;const{peerId:t}=e,s=await this.managers.appPeersManager.isForum(t),i=Un(e,s);this._renderNewMessage(e),i&&this._renderNewMessage(e,void 0,i)}_deleteDeletedMessages(e,t,s,i){for(const n of s)for(const a of this.searchSuper.mediaTabs){const r=a.inputFilter,l=e[r];if(!l)continue;const c=a.type==="saved"?this.peerId===i:this.peerId===t&&this.threadId===i;c&&this.searchSuper.setCounter(a.type,this.searchSuper.counters[a.type]-s.length);const d=l.findIndex(h=>h.mid===n);if(d===-1&&l.splice(d,1),c){const h=this.searchSuper.tabs[r],u=h.querySelector(`[data-mid="${n}"][data-peer-id="${t}"]`);if(u){this.searchSuper.selection.isSelecting&&this.searchSuper.selection.toggleByElement(u);const p=h.querySelectorAll("[data-mid][data-peer-id]"),m=Array.from(p).indexOf(u);u.remove(),m!==-1&&this.searchSuper.usedFromHistory[r]>=m+1&&--this.searchSuper.usedFromHistory[r]}}}}deleteDeletedMessages(e,t){if(this.init)return;const s=hl[e];if(!s)return;const i=[...t.keys()];for(const n in s)this._deleteDeletedMessages(s[n],e,i,isNaN(+n)?void 0:+n);this.scrollable.onScroll()}async cleanupHTML(){const e=this.peerId.isAnyChat(),[t,s]=await Promise.all([e?this.searchSuper.canViewMembers():!1,e?this.managers.appChatsManager.hasRights(this.peerId.toChatId(),"invite_users"):!1]);return()=>{this.profile?.cleanupHTML(),this.editBtn.classList.add("hide"),this.searchSuper.cleanupHTML(!0),this.container.classList.toggle("can-add-members",t&&s)}}setLoadMutex(e){this.searchSuper.loadMutex=e}getHistoryStorage(e,t){var s;return(s=hl[e]??(hl[e]={}))[t]??(s[t]={})}setPeer(e,t){var i;if(this.peerId===e&&this.threadId===t)return!1;this.peerId=e,this.threadId=t,this.noProfile??(this.noProfile=e===C.myId),this.peerChanged=!0,this.init&&this.init();const s=this.getHistoryStorage(e,t);return s.inputMessagesFilterEmpty=(i=this.getHistoryStorage(C.myId,e)).inputMessagesFilterEmpty??(i.inputMessagesFilterEmpty=[]),this.searchSuper.setQuery({peerId:e,threadId:t,historyStorage:s}),this.profile?.setPeer(e,t),!0}async changeTitleKey(){const{peerId:e,threadId:t}=this,s=!!(e===C.myId&&t),[i,n,a,r]=await Promise.all([this.managers.appPeersManager.isForum(e),this.managers.appPeersManager.isBroadcast(e),this.managers.appPeersManager.isBot(e),Oe({peerId:s?t:e,threadId:s?void 0:t,meAsNotes:s&&t===C.myId,dialog:!0})]);return()=>{this.titleI18n.compareAndUpdate({key:a?"Profile.Info.Bot":n?"Profile.Info.Channel":t&&i?"Profile.Info.Topic":e.isUser()?"Profile.Info.User":"Profile.Info.Group"}),this.sharedMediaTitle.replaceChildren(r),this.btnMenu.classList.toggle("hide",!this.isFirst||e!==C.myId)}}async fillProfileElements(){if(!this.peerChanged)return;this.peerChanged=!1;const e=await Promise.all([this.cleanupHTML(),this.toggleEditBtn(!0),this.profile?.fillProfileElements(),this.changeTitleKey()]);return()=>{e.forEach(t=>{t?.()})}}async toggleEditBtn(e){const{peerId:t}=this;let s;if(t.isUser())s=t!==C.myId&&await this.managers.appUsersManager.canEdit(t.toUserId());else{const n=t.toChatId();this.threadId&&fe.isForum(t)?s=await this.managers.dialogsStorage.canManageTopic(await this.managers.dialogsStorage.getForumTopic(t,this.threadId)):s=!!fe.getChat(n).admin_rights||await this.managers.appChatsManager.hasRights(n,"change_info")}const i=()=>{this.editBtn.classList.toggle("hide",!s)};return e?i:i()}loadSidebarMedia(e,t){return this.searchSuper.load(e,t)}onOpenAfterTimeout(){super.onOpenAfterTimeout(),this.scrollable.onScroll()}onCloseAfterTimeout(){super.onCloseAfterTimeout(),this.destroyable&&(this.profile?.destroy(),this.searchSuper.destroy())}destroy(){this.destroyable=!0,this.onCloseAfterTimeout()}static async open(e,t,s){const i=e.createTab(Tr,!0);return i.noProfile=s,i.isFirst=!0,i.setPeer(t),(await i.fillProfileElements())(),await i.loadSidebarMedia(!0),i.open()}}const pc="is-right-column-shown";class vT extends Bv{constructor(){super({sidebarEl:document.getElementById("column-right"),canHideFirst:!0,navigationType:"right"}),this.isColumnProportionSet=!1}construct(e){this.managers=e,Fe.addEventListener("changeScreen",(t,s)=>{s===ei.medium&&t!==ei.mobile&&this.toggleSidebar(!1)}),Fe.addEventListener("resize",()=>{this.setColumnProportion()})}createSharedMediaTab(){const e=this.createTab(Tr,!1,!0);return e.slider=this,e}replaceSharedMediaTab(e){const t=this.sharedMediaTab;if(t){const s=this.historyTabIds.indexOf(t);this._selectTab.getFrom()===t.container&&this._selectTab.setFrom(e?.container),e?(s!==-1&&(this.historyTabIds[s]=e),t.container.classList.contains("active")&&e.container.classList.add("active"),t.container.replaceWith(e.container)):(s!==-1&&this.historyTabIds.splice(s,1),t.container.remove())}else this.tabsContainer.prepend(e.container);this.sharedMediaTab=e}onCloseTab(e,t,s){this.historyTabIds.length||this.toggleSidebar(!1,t),super.onCloseTab(e,t,s)}setColumnProportion(){const e=this.sidebarEl.scrollWidth/this.sidebarEl.previousElementSibling.scrollWidth;document.documentElement.style.setProperty("--right-column-proportion",""+e)}toggleSidebar(e,t){const s=document.body.classList.contains(pc);let i;if(e!==void 0?e?s||(i=!0):s&&(i=!0):i=!0,!i)return Promise.resolve();!s&&!this.historyTabIds.length&&this.sharedMediaTab.open(),this.isColumnProportionSet||(this.setColumnProportion(),this.isColumnProportionSet=!0);const n=ce.selectTab(s?No.CHAT:No.PROFILE,t);return document.body.classList.toggle(pc,e),n}}const Zw=new vT;Gs.appSidebarRight=Zw;const ss=Zw;function gg(o){return Db({...o,onSwipe:(e,t,s)=>{if(e*=-1,t*=-1,Math.abs(e)>50)return o.onSwipe(e,t,s),kv(),!0}})}function bT(o){const e=i=>{X(i)};let t=2;const s=()=>{--t||o.removeEventListener("touchmove",e,{capture:!0})};return o.addEventListener("touchmove",e,{capture:!0,passive:!1}),o.addEventListener("touchend",s,{once:!0}),s}function wT({inputFilter:o,messages:e,limit:t,savedReaction:s}){if(o==="inputMessagesFilterEmpty"&&!s)return e.slice(0,t);const i=[];if(!e.length)return i;let n=!0;const a={},r=[],l=[];switch(o){case"inputMessagesFilterPhotos":a.messageMediaPhoto=!0;break;case"inputMessagesFilterPhotoVideo":a.messageMediaPhoto=!0,a.messageMediaDocument=!0,r.push("video");break;case"inputMessagesFilterVideo":a.messageMediaDocument=!0,r.push("video");break;case"inputMessagesFilterDocument":a.messageMediaDocument=!0,r.push(void 0,"photo","pdf");break;case"inputMessagesFilterVoice":a.messageMediaDocument=!0,r.push("voice");break;case"inputMessagesFilterRoundVoice":a.messageMediaDocument=!0,r.push("round","voice");break;case"inputMessagesFilterRoundVideo":a.messageMediaDocument=!0,r.push("round");break;case"inputMessagesFilterMusic":a.messageMediaDocument=!0,r.push("audio");break;case"inputMessagesFilterUrl":a.url=!0;break;case"inputMessagesFilterChatPhotos":a.avatar=!0;break;case"inputMessagesFilterPinned":l.push("pinned");break;default:n=!1;break}if(!n&&!s?.length)return i;for(let c=0,d=e.length;c<d;++c){const h=e[c];if(!h)continue;let u=!n;if(l?.some(p=>h.pFlags[p]))u=!0;else if(h._==="message"){if(h.media&&a[h.media._]){const p=h.media.document;if(p&&r.length&&!r.includes(p.type))continue;u=!0}else if(a.url&&h.message){const p=["messageEntityTextUrl","messageEntityUrl"];(h.totalEntities.find(m=>p.includes(m._))||yh(h.message))&&(u=!0)}if(u&&s){const p=h.reactions?.results;u=p?s.every(m=>p.some(g=>Ai(g.reaction,m))):!1}}else a.avatar&&h.action&&["messageActionChannelEditPhoto","messageActionChatEditPhoto","messageActionChannelEditVideo","messageActionChatEditVideo"].includes(h.action._)&&(u=!0);if(u&&i.push(h)>=t)break}return i}const ST=He("<div class=grid>");function CT(o){const[e,t]=Ur(),[s,i]=we(),[n,a]=we(0),[r,l]=we(),c=new Map;qr(()=>{const u=ke(Mi,{get each(){return e.peer.stories},children:h});Ne(()=>{const p=u(),m=p.length;a(m),i(p),o.onLengthChange?.(m)}),o.onLengthChange&&Ne(()=>{o.onLengthChange(e.peer?.count)}),o.onReady?.()})(()=>e.ready),Ne(()=>{const u=r();if(!u)return;const p=()=>{l(void 0)},m=he(()=>{const g=e.peer.stories[e.peer.index].id;return c.get(g)});Zt(()=>{const g=e.peer,f=g.stories.findIndex(y=>y.id===u);t.set({peer:g,index:f})}),Wc({onExit:p,target:m,splitByDays:!0})});const h=u=>{const{container:p,div:m,media:g,thumb:f}=zc({peerId:e.peer.peerId,storyItem:u,forPreview:!0,noAspecter:!0,containerProps:{"data-mid":u.id,"data-peer-id":e.peer.peerId,class:"grid-item search-super-item",onClick:y=>{l(u.id)}},childrenClassName:"grid-item-media",noPlayButton:!0});return Ne(()=>{const y=f(),b=g()||y;if(b&&(c.set(u.id,b),Et(()=>{c.delete(u.id)}),n()===1)){const w=u.media,S=w.photo||w.document,L=Wl({photo:S,cacheContext:{type:"x",url:"",downloaded:0},useBlur:!0,ignoreCache:!0,onlyStripped:!0}).image;b.parentElement.prepend(L),Et(()=>{L.remove()})}}),o.selection?.isSelecting&&o.selection.toggleElementCheckbox(m,!0),p};return(()=>{const u=ST();return q(u,s),mt(p=>{const m=n()===2,g=n()===1;return m!==p._v$&&u.classList.toggle("two",p._v$=m),g!==p._v$2&&u.classList.toggle("one",p._v$2=g),p},{_v$:void 0,_v$2:void 0}),u})()}function IT(o){const[,e]=da(o,["onReady","onLengthChange","selection"]);return ke(og,an(e,{get children(){return ke(CT,o)}}))}class LT{constructor(e,t,s){this.attachTo=e,this.searchSuper=t,this.listenerSetter=s,this.onGotoClick=()=>{ce.setInnerPeer({peerId:this.peerId,lastMsgId:this.mid,threadId:this.searchSuper.mediaTab.type==="saved"?this.searchSuper.searchContext.peerId:this.searchSuper.searchContext.threadId})},this.onForwardClick=()=>{this.searchSuper.selection.isSelecting?hs(this.searchSuper.selection.selectionForwardBtn):J.createPopup(jn,{[this.peerId]:[this.mid]})},this.onSelectClick=()=>{this.searchSuper.selection.toggleByElement(this.target)},this.onClearSelectionClick=()=>{this.searchSuper.selection.cancelSelection()},this.onDeleteClick=()=>{this.storyItem?this.searchSuper.selection.onDeleteStoriesClick([this.storyItem.id]):this.searchSuper.selection.isSelecting?hs(this.searchSuper.selection.selectionDeleteBtn):J.createPopup(jo,this.peerId,[this.mid],Q.Chat)},this.onStoryTogglePinClick=n=>{this.searchSuper.selection.onPinClick([this.storyItem.id],n)},this.managers=t.managers,Ye||ua({element:e,callback:n=>{this.init&&(this.init(),this.init=null);let a;try{a=U(n.target,"search-super-item")}catch{}const r=!!U(n.target,"search-super-content-stories");if(!a)return;if(n instanceof MouseEvent&&n.preventDefault(),this.element.classList.contains("active"))return!1;n instanceof MouseEvent&&(n.cancelBubble=!0),(async()=>{this.target=a,this.peerId=a.dataset.peerId.toPeerId(),this.mid=+a.dataset.mid,this.isSelected=t.selection.isMidSelected(this.peerId,this.mid),this.message=r?void 0:await this.managers.appMessagesManager.getMessageByPeer(this.peerId,this.mid),this.storyItem=r?await this.managers.appStoriesManager.getStoryById(this.peerId,this.mid):void 0,this.noForwards=r||(t.selection.isSelecting?this.searchSuper.selection.selectionForwardBtn.classList.contains("hide"):!await this.managers.appMessagesManager.canForward(this.message)),this.selectedMessages=!r&&t.selection.isSelecting?await t.selection.getSelectedMessages():void 0,(await Promise.all(this.buttons.map(async d=>{let h;return this.searchSuper.selection.isSelecting&&!d.withSelection?h=!1:h=d.verify?!!await d.verify():!0,d.element.classList.toggle("hide",!h),h}))).some(d=>d)&&(a.classList.add("menu-open"),Go(n,this.element),$s.openBtnMenu(this.element,()=>{a.classList.remove("menu-open")}))})()},listenerSetter:s})}init(){this.buttons=[{icon:"forward",text:"Forward",onClick:this.onForwardClick,verify:()=>!this.noForwards},{icon:"forward",text:"Message.Context.Selection.Forward",onClick:this.onForwardClick,verify:()=>this.searchSuper.selection.isSelecting&&!this.noForwards,withSelection:!0},{icon:"download",text:"MediaViewer.Context.Download",onClick:()=>wn.onDownloadClick(this.message,this.noForwards),verify:()=>!this.searchSuper.selection.isSelecting&&wn.canDownload(this.message,void 0,this.noForwards)},{icon:"download",text:"Message.Context.Selection.Download",onClick:()=>wn.onDownloadClick(this.selectedMessages,this.noForwards),verify:()=>this.searchSuper.selection.isSelecting&&wn.canDownload(this.selectedMessages,void 0,this.noForwards),withSelection:!0},{icon:"message",text:"Message.Context.Goto",onClick:this.onGotoClick,verify:()=>!this.storyItem,withSelection:!0},{icon:"select",text:"Message.Context.Select",onClick:this.onSelectClick,verify:()=>!this.isSelected&&(!this.storyItem||this.storyItem.pFlags.out),withSelection:!0},{icon:"select",text:"Message.Context.Selection.Clear",onClick:this.onClearSelectionClick,verify:()=>this.isSelected,withSelection:!0},{icon:"pin",text:"Story.AddToProfile",onClick:()=>this.onStoryTogglePinClick(!0),verify:()=>this.storyItem&&this.peerId===C.myId&&!this.storyItem.pFlags.pinned},{icon:"unpin",text:"Story.RemoveFromProfile",onClick:()=>this.onStoryTogglePinClick(!1),verify:()=>this.storyItem&&this.peerId===C.myId&&this.storyItem.pFlags.pinned},{icon:"pin",text:"SaveToPosts",onClick:()=>this.onStoryTogglePinClick(!0),verify:()=>this.storyItem&&!this.peerId.isUser()&&!this.storyItem.pFlags.pinned&&this.managers.appStoriesManager.hasRights(this.peerId,this.storyItem.id,"pin")},{icon:"unpin",text:"RemoveFromPosts",onClick:()=>this.onStoryTogglePinClick(!1),verify:()=>this.storyItem&&!this.peerId.isUser()&&this.storyItem.pFlags.pinned&&this.managers.appStoriesManager.hasRights(this.peerId,this.storyItem.id,"pin")},{icon:"delete",className:"danger",text:"Delete",onClick:this.onDeleteClick,verify:()=>this.storyItem?this.managers.appStoriesManager.hasRights(this.peerId,this.storyItem.id,"delete"):!this.searchSuper.selection.isSelecting&&this.managers.appMessagesManager.canDeleteMessage(this.message)},{icon:"delete",className:"danger",text:"Message.Context.Selection.Delete",onClick:this.onDeleteClick,verify:()=>this.searchSuper.selection.isSelecting&&this.searchSuper.selection.selectionDeleteBtn&&!this.searchSuper.selection.selectionDeleteBtn.classList.contains("hide"),withSelection:!0}],this.element=Mn({buttons:this.buttons,listenerSetter:this.listenerSetter}),this.element.classList.add("search-contextmenu","contextmenu"),document.getElementById("page-chats").append(this.element)}}class fg{constructor(e){this.tabs={},this.prevTabId=-1,this.lazyLoadQueue=new ha,this.middleware=Gt(),this.historyStorage={},this.usedFromHistory={},this.nextRates={},this.loadPromises={},this.loaded={},this.loadedChats=!1,this.firstLoad=!0,this.log=zs("SEARCH-SUPER"),this.monthContainers={},this.mediaTabsMap=new Map,this.asChatList=!1,this.groupByMonth=!0,this.hideEmptyTabs=!0,this.showSender=!1,this.counters={},this.onTransitionStart=()=>{this.container.classList.add("sliding")},this.onTransitionEnd=()=>{this.container.classList.remove("sliding")},Lt(this,e),this.slider??(this.slider=ss),this.container=document.createElement("div"),this.container.classList.add("search-super"),this.listenerSetter=new Qt,this.searchContextMenu=new LT(this.container,this,this.listenerSetter),this.selection=new n_(this,this.managers,this.listenerSetter),this.storiesArchive&&(this.selection.isStoriesArchive=!0);const t=this.navScrollableContainer=document.createElement("div");t.classList.add("search-super-tabs-scrollable","menu-horizontal-scrollable","sticky");const s=this.navScrollable=new Va(t);s.container.classList.add("search-super-nav-scrollable");const i=this.nav=document.createElement("nav");i.classList.add("search-super-tabs","menu-horizontal-div"),this.tabsMenu=i,s.container.append(i);for(const r of this.mediaTabs){const l=document.createElement("div");l.classList.add("menu-horizontal-div-item");const c=document.createElement("span");c.classList.add("menu-horizontal-div-item-span");const d=document.createElement("i");c.append(r.menuTabName=_(r.name)),c.append(d),l.append(c),pi(l),this.tabsMenu.append(l),this.mediaTabsMap.set(r.type,r),r.menuTab=l}this.tabsContainer=document.createElement("div"),this.tabsContainer.classList.add("search-super-tabs-container","tabs-container");let n;Ye&&(this.swipeHandler=gg({element:this.tabsContainer,onSwipe:(r,l,c)=>{r*=-1;const d=this.selectTab.prevId(),h=Array.from(this.tabsMenu.children);let u;if(r>0){for(let p=d+1;p<h.length;++p)if(!h[p].classList.contains("hide")){u=p;break}}else for(let p=d-1;p>=0;--p)if(!h[p].classList.contains("hide")){u=p;break}u!==void 0&&(n=bT(this.tabsContainer),this.selectTab(u))},verifyTouchTarget:r=>!U(r.target,"scrollable-x")}));for(const r of this.mediaTabs){const l=document.createElement("div");l.classList.add("search-super-tab-container","search-super-container-"+r.type,"tabs-tab");const c=document.createElement("div");c.classList.add("search-super-content-container","search-super-content-"+r.type),l.append(c),this.tabsContainer.append(l);const{inputFilter:d}=r;d&&(this.tabs[d]=c),r.contentTab=c}this.container.append(t,this.tabsContainer),this.searchGroupMedia=new Ma(!1,"messages",!0),this.scrollable.onScrolledBottom=()=>{this.mediaTab.contentTab&&this.canLoadMediaTab(this.mediaTab)&&this.load(!0,void 0,"bottom")},this.selectTab=Ac(this.tabsMenu,this.tabsContainer,(r,l,c)=>{if(this.prevTabId===r&&!this.skipScroll){this.scrollable.scrollIntoViewNew({element:this.container,position:"start",startCallback:this.scrollStartCallback});return}const d=this.mediaTabs[r];this.onChangeTab?.(d),this.selection&&(this.selection.isStories=d.type==="stories");const h=this.mediaTab;if(this.mediaTab=d,this.prevTabId!==-1&&c&&this.onTransitionStart(),this.skipScroll)this.skipScroll=!1;else{const u=this.container.offsetTop;let p=this.scrollable.scrollPosition;if(p<u&&(this.scrollable.scrollIntoViewNew({element:this.container,position:"start",startCallback:this.scrollStartCallback}),p=u),h.scroll={scrollTop:p,scrollHeight:this.scrollable.scrollSize},d.scroll===void 0){const m=this.container.getBoundingClientRect(),g=this.container.parentElement.getBoundingClientRect(),f=m.y-g.y;p>f&&(d.scroll={scrollTop:f,scrollHeight:0})}if(d.scroll){const m=h.scroll.scrollTop-d.scroll.scrollTop;m&&(d.contentTab.style.transform=`translateY(${m}px)`)}}this.prevTabId!==-1&&!d.contentTab.childElementCount&&this.load(!0),this.prevTabId=r},()=>{this.scrollable.onScroll(),this.mediaTab.scroll!==void 0&&(this.mediaTab.contentTab.style.transform="",this.scrollable.scrollPosition=this.mediaTab.scroll.scrollTop),n&&(n(),n=void 0),this.onTransitionEnd()},void 0,s,this.listenerSetter),D(this.tabsContainer,r=>{this.selection.isSelecting&&(X(r),this.selection.toggleByElement(U(r.target,"search-super-item")))},{capture:!0,passive:!1,listenerSetter:this.listenerSetter});const a=async(r,l,c,d)=>{const h=U(d.target,r);if(!h)return;const u=+h.dataset.mid;if(!u){this.log.warn("no messageId by click on target:",h);return}const p=h.querySelector(".media-spoiler-container");if(p){Hb({event:d,mediaSpoiler:p});return}const m=h.dataset.peerId.toPeerId(),g=Array.from(this.tabs[c].querySelectorAll("."+l)).map(b=>{const w=U(b,r);return{element:b,mid:+w.dataset.mid,peerId:w.dataset.peerId.toPeerId()}}),f=g.findIndex(b=>b.mid===u&&b.peerId===m),y=this.mediaTabs.find(b=>b.inputFilter===c),v=await this.managers.appMessagesManager.getMessageByPeer(m,u);new Oo().setSearchContext(this.copySearchContext(c,this.nextRates[y.type])).openMedia({message:v,target:g[f].element,fromRight:0,reverse:!1,prevTargets:g.slice(0,f),nextTargets:g.slice(f+1)})};this.tabs.inputMessagesFilterPhotoVideo&&D(this.tabs.inputMessagesFilterPhotoVideo,a.bind(null,"grid-item","grid-item","inputMessagesFilterPhotoVideo"),{listenerSetter:this.listenerSetter}),this.tabs.inputMessagesFilterDocument&&D(this.tabs.inputMessagesFilterDocument,a.bind(null,"document-with-thumb","media-container","inputMessagesFilterDocument"),{listenerSetter:this.listenerSetter}),this.mediaTab=this.mediaTabs[0],dm(()=>{this.lazyLoadQueue.lock()},()=>{this.lazyLoadQueue.unlockAndRefresh()},this.listenerSetter)}setCounter(e,t){this.counters[e]=t,this.onLengthChange?.(e,t)}filterMessagesByType(e,t){return wT({inputFilter:t,messages:e,limit:e.length})}async processEmptyFilter({message:e,searchGroup:t,mediaTab:s}){const i=s.type==="saved";let n=e.peerId;i&&(n=e.fromId),n=await this.managers.appPeersManager.getPeerMigratedTo(n)||n;const a=this.middleware.get(),r=[],l=Qe.addDialogNew({peerId:n,container:t?.list||!1,avatarSize:"bigger",loadPromises:r,wrapOptions:{middleware:a},withStories:!0,meAsSaved:!i,autonomous:i,fromName:n?void 0:hn(e.fwd_from)}),c=Qe.setLastMessageN({dialog:{_:"dialog",peerId:n},lastMessage:e,dialogElement:l,highlightWord:this.searchContext.query,noForwardIcon:i});return r.push(c),Promise.all(r).then(()=>{if(!t)return{element:l.container,message:e}})}async processPhotoVideoFilter({message:e,promises:t,middleware:s}){const i=Hs(e,!0),n=document.createElement("div");n.classList.add("grid-item");let a;const r=ji(i,200,200);if(i._!=="photo"?a=(await On({doc:i,message:e,container:n,boxWidth:0,boxHeight:0,lazyLoadQueue:this.lazyLoadQueue,middleware:s,onlyPreview:!0,withoutPreloader:!0,noPlayButton:!0,photoSize:r})).thumb:a=await Ns({photo:i,message:e,container:n,boxWidth:0,boxHeight:0,lazyLoadQueue:this.lazyLoadQueue,middleware:s,withoutPreloader:!0,noBlur:!0,size:r}),e.media.pFlags.spoiler){const l=await eu({animationGroup:"chat",media:i,middleware:s,width:140,height:140,multiply:.3});n.append(l)}return[a.images.thumb,a.images.full].filter(Boolean).forEach(l=>{l.classList.add("grid-item-media")}),t.push(a.loadPromises.thumb),{element:n,message:e}}async processDocumentFilter({message:e,inputFilter:t}){const s=Hs(e,!0),i=this.showSender||["voice","round"].includes(s.type),n=await lc({message:e,withTime:!i,fontWeight:400,voiceAsMusic:!0,showSender:i,searchContext:this.copySearchContext(t,this.nextRates.files),lazyLoadQueue:this.lazyLoadQueue,autoDownloadSize:0,getSize:()=>320});return["audio","voice","round"].includes(s.type)&&n.classList.add("audio-48"),{message:e,element:n}}async processUrlFilter({message:e,promises:t,middleware:s}){let i=e.media?.webpage;if(!i){const u=e.totalEntities?e.totalEntities.find(y=>y._==="messageEntityUrl"||y._==="messageEntityTextUrl"):null;let p,m,g;if(u)g=e.message.slice(u.offset,u.offset+u.length);else{const y=yh(e.message);if(!y)return;p=y[0]}u?._==="messageEntityTextUrl"?p=u.url:p=p||g,m=p;const f=e.message===p;p.match(/^(ftp|http|https):\/\//)||(m="https://"+p,p=p.includes("@")?p:"https://"+p),m=new URL(m).hostname,i={_:"webPage",pFlags:{},url:p,display_url:m,id:"",hash:0},f||(i.description=e.message)}if(i._==="webPageEmpty")return;const n=document.createElement("div");n.classList.add("preview"),i.photo?Ns({container:n,message:null,photo:i.photo,boxWidth:0,boxHeight:0,withoutPreloader:!0,lazyLoadQueue:this.lazyLoadQueue,middleware:s,size:ji(i.photo,60,60,!1),loadPromises:t,noBlur:!0}):(n.classList.add("empty"),St(n,Ah(i.title||i.display_url||i.description||i.url,!0)));const a=Nb(i),r=Bb(i),c=zl(us(i.url||"")).firstElementChild,d=c instanceof HTMLAnchorElement;if(d)try{c.innerText=decodeURIComponent(c.href)}catch{}r.firstChild&&r.append(`
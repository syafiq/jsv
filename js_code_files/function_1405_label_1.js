EditorUi.prototype.installShapePicker=function(){var a=this.editor.graph,b=this;a.addListener(mxEvent.FIRE_MOUSE_EVENT,mxUtils.bind(this,function(v,m){"mouseDown"==m.getProperty("eventName")&&b.hideShapePicker()}));var f=mxUtils.bind(this,function(){b.hideShapePicker(!0)});a.addListener("wheel",f);a.addListener(mxEvent.ESCAPE,f);a.view.addListener(mxEvent.SCALE,f);a.view.addListener(mxEvent.SCALE_AND_TRANSLATE,f);a.getSelectionModel().addListener(mxEvent.CHANGE,f);var e=a.popupMenuHandler.isMenuShowing;
a.popupMenuHandler.isMenuShowing=function(){return e.apply(this,arguments)||null!=b.shapePicker};var g=a.dblClick;a.dblClick=function(v,m){if(this.isEnabled())if(null!=m||null==b.sidebar||mxEvent.isShiftDown(v)||a.isCellLocked(a.getDefaultParent()))g.apply(this,arguments);else{var r=mxUtils.convertPoint(this.container,mxEvent.getClientX(v),mxEvent.getClientY(v));mxEvent.consume(v);window.setTimeout(mxUtils.bind(this,function(){b.showShapePicker(r.x,r.y)}),30)}};if(null!=this.hoverIcons){this.hoverIcons.addListener("reset",
f);var d=this.hoverIcons.drag;this.hoverIcons.drag=function(){b.hideShapePicker();d.apply(this,arguments)};var h=this.hoverIcons.execute;this.hoverIcons.execute=function(v,m,r){var x=r.getEvent();this.graph.isCloneEvent(x)||mxEvent.isShiftDown(x)?h.apply(this,arguments):this.graph.connectVertex(v.cell,m,this.graph.defaultEdgeLength,x,null,null,mxUtils.bind(this,function(B,D,F){var H=a.getCompositeParent(v.cell);B=a.getCellGeometry(H);for(r.consume();null!=H&&a.model.isVertex(H)&&null!=B&&B.relative;)cell=
H,H=a.model.getParent(cell),B=a.getCellGeometry(H);window.setTimeout(mxUtils.bind(this,function(){b.showShapePicker(r.getGraphX(),r.getGraphY(),H,mxUtils.bind(this,function(C){F(C);null!=b.hoverIcons&&b.hoverIcons.update(a.view.getState(C))}),m)}),30)}),mxUtils.bind(this,function(B){this.graph.selectCellsForConnectVertex(B,x,this)}))};var n=null;this.hoverIcons.addListener("focus",mxUtils.bind(this,function(v,m){null!=n&&window.clearTimeout(n);n=window.setTimeout(mxUtils.bind(this,function(){var r=
m.getProperty("arrow"),x=m.getProperty("direction"),B=m.getProperty("event");r=r.getBoundingClientRect();var D=mxUtils.getOffset(a.container),F=a.container.scrollLeft+r.x-D.x;D=a.container.scrollTop+r.y-D.y;var H=a.getCompositeParent(null!=this.hoverIcons.currentState?this.hoverIcons.currentState.cell:null),C=b.showShapePicker(F,D,H,mxUtils.bind(this,function(N){null!=N&&a.connectVertex(H,x,a.defaultEdgeLength,B,!0,!0,function(Q,T,R){R(N);null!=b.hoverIcons&&b.hoverIcons.update(a.view.getState(N))},
function(Q){a.selectCellsForConnectVertex(Q)},B,this.hoverIcons)}),x,!0);this.centerShapePicker(C,r,F,D,x);mxUtils.setOpacity(C,30);mxEvent.addListener(C,"mouseenter",function(){mxUtils.setOpacity(C,100)});mxEvent.addListener(C,"mouseleave",function(){b.hideShapePicker()})}),Editor.shapePickerHoverDelay)}));this.hoverIcons.addListener("blur",mxUtils.bind(this,function(v,m){null!=n&&window.clearTimeout(n)}))}};
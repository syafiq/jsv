`);Us(g)}}];ki&&u.push({icon:"download",text:"MediaViewer.Context.Download",onClick:async()=>{for(const m of i)for(const g of m.documents)as.downloadToDisc({media:g}),await js(100)}});const p=yi({listenerSetter:this.listenerSetter,buttons:u,direction:"bottom-left"});this.title.after(p),this.footer.textContent="",this.footer.append(h),this.appendTo.classList.remove("is-loading"),this.appendTo.textContent="",this.appendTo.append(...d),this.scrollable.onAdditionalScroll()}updateButton(){const{sets:e,isEmojis:t}=this;let s,i;if(e.length===1){const n=e[0];i=_(t?"EmojiCount":"Stickers",[n.count]),s=!n.installed_date}else{const n=e.filter(r=>r.installed_date);let a;e.length===n.length?(s=!1,a=e.length):(s=!0,a=e.length-n.length),i=_("EmojiPackCount",[a])}this.button.className=s?"btn-primary btn-color-primary":"btn-primary btn-primary-transparent danger",tt(this.button,_(s?"AddStickersCount":"RemoveStickersCount",[i]))}}async function Xm({set:o,lazyLoadQueue:e,container:t,group:s,autoplay:i,width:n,height:a,managers:r=C.managers,middleware:l,textColor:c}){if(o.thumbs?.length){t.classList.add("media-sticker-wrapper"),e.push({div:t,load:async()=>{const p=await r.appStickersManager.getStickerSetThumbDownloadOptions(o),m=as.download(p);if(o.pFlags.animated&&!o.pFlags.videos)return m.then(g=>{Cs.loadAnimationWorker({container:t,loop:!0,autoplay:i,animationData:g,width:n,height:a,needUpscale:!0,name:"setThumb"+o.id,group:s,middleware:l})});{let g;return o.pFlags.videos?(g=Lo({middleware:l}),g.autoplay=!0,g.muted=!0,g.loop=!0):g=new Image,g.classList.add("media-sticker"),m.then(f=>{In(g,URL.createObjectURL(f),()=>{t.append(g),o.pFlags.videos&&ut.addAnimation({animation:g,group:s,observeElement:g,type:"video"})})})}}});return}let d;o.thumb_document_id?d=r.appEmojiManager.getCustomEmojiDocument(o.thumb_document_id):d=r.appStickersManager.getStickerSet(o).then(p=>p.documents[0]);const h=await d;if(!h)return;const u=h.attributes.find(p=>p._==="documentAttributeCustomEmoji");Ds({doc:h,div:t,group:s,lazyLoadQueue:e,managers:r,width:n,height:a,middleware:l,textColor:u?.pFlags?.text_color?c||ic:void 0})}class Qh{constructor(e){this.animated=new Set,this.checkAnimationContainer=(t,s)=>{ut.getAnimations(t).forEach(n=>{s?ut.checkAnimation(n,!1):ut.removeAnimation(n)})},this.processVisible=async t=>{const s=t.dataset.docId,i=await this.managers.appDocsManager.getDoc(s),n=Fe.active.esgSticker.width,a=Ds({doc:i,div:t,width:n,height:n,lazyLoadQueue:null,group:this.group,onlyThumb:!1,play:!0,loop:!0,withLock:!0,...this.visibleRenderOptions||{}}).then(({render:r})=>r);return a.then(()=>{this.checkAnimationContainer(t,this.lazyLoadQueue.intersector.isVisible(t))}),a},this.processInvisible=async t=>{const s=t.dataset.docId,i=await this.managers.appDocsManager.getDoc(s);this.checkAnimationContainer(t,!1),t.replaceChildren(),this.renderSticker(i,t)},Lt(this,e),this.lazyLoadQueue=new TP(void 0,({target:t,visible:s})=>{s||this.processInvisible(t)},this.intersectionObserverInit)}clear(){this.lazyLoadQueue.clear()}renderSticker(e,t,s){return t||(t=document.createElement("div"),t.classList.add("grid-item","super-sticker"),t.dataset.docId=""+e.id,e.animated&&this.observeAnimated(t)),Ds({doc:e,div:t,lazyLoadQueue:this.regularLazyLoadQueue,group:this.group,onlyThumb:e.animated,loadPromises:s,...e.animated?{}:this.visibleRenderOptions||{}}),t}observeAnimated(e){this.animated.add(e),this.lazyLoadQueue.observe({div:e,load:this.processVisible})}unobserveAnimated(e){this.animated.delete(e),this.lazyLoadQueue.delete({div:e})}}class xP{constructor(e){const t=document.createElement("div");t.classList.add("emoji-category");const s=document.createElement("div");s.classList.add("category-items");let i;e.title&&(i=document.createElement("div"),i.classList.add("category-title"),i.append(e.title));let n,a;e.noMenuTab||(n=Xe(void 0,{noRipple:!0}),n.classList.add("menu-horizontal-div-item"),a=document.createElement("div"),a.classList.add("menu-horizontal-div-item-padding"),n.append(a)),i&&t.append(i),t.append(s),this.elements={container:t,title:i,items:s,menuTab:n,menuTabPadding:a},this.id=e.id,this.items=[],this.getContainerSize=e.getContainerSize,this.getElementMediaSize=e.getElementMediaSize,this.gapX=e.gapX??0,this.gapY=e.gapY??0,this.middlewareHelper=e.middleware?e.middleware.create():Gt()}setCategoryItemsHeight(e=this.items.length){const{width:t}=this.getContainerSize(),s=this.getElementMediaSize().width;let i=t/s;this.gapX&&(i-=Math.floor(i-1)*this.gapX/s),i=Math.floor(i);const n=Math.ceil(e/i);let a=n*s;this.gapY&&(a+=(n-1)*this.gapY),this.elements.items.style.minHeight=a+"px"}}class vb{constructor(e,t,s,i,n,a){this.managers=e,this.categoryItemsClassName=t,this.getElementMediaSize=s,this.padding=i,this.gapX=n,this.gapY=a,this.mounted=!1,this.resizeCategories=()=>{for(const[r,l]of this.categoriesMap)l.setCategoryItemsHeight()},this.postponedEvent=r=>(...l)=>{this.emoticonsDropdown.isActive()?this.postponedEvents.push({cb:r,args:l}):r(...l)},this.categories={},this.categoriesMap=new Map,this.categoriesByMenuTabMap=new Map,this.localCategories=[],this.postponedEvents=[],this.listenerSetter=new Qt,this.middlewareHelper=Gt(),this.container=document.createElement("div"),this.container.classList.add("tabs-tab","emoticons-container"),this.menuWrapper=document.createElement("div"),this.menuWrapper.classList.add("menu-wrapper","emoticons-menu-wrapper"),this.menu=document.createElement("nav"),this.menu.className="menu-horizontal-div no-stripe justify-start emoticons-menu",this.menuWrapper.append(this.menu),this.menuScroll=new Va(this.menuWrapper),this.content=document.createElement("div"),this.content.classList.add("emoticons-content"),this.container.append(this.menuWrapper,this.content),this.scrollable=new Ys(this.content,"STICKERS"),this.categoriesContainer=document.createElement("div"),this.scrollable.append(this.categoriesContainer)}getCategoryByContainer(e){return this.categoriesMap.get(e)}getCategoryByMenuTab(e){return this.categoriesByMenuTabMap.get(e)}createCategory({stickerSet:e,title:t,isLocal:s,noMenuTab:i}){const n=new xP({id:""+e.id,title:t,overflowElement:this.content,getContainerSize:()=>{let r,l;if(this.getContainerSize){const c=this.getContainerSize();r=c.width,l=c.height}else{const c=fs.getPropertyAsSize("esg-width");r=c===void 0?nt.width:c}return{width:r-this.padding,height:l}},getElementMediaSize:this.getElementMediaSize,gapX:this.gapX,gapY:this.gapY,noMenuTab:i,middleware:this.middlewareHelper.get()});this.categoryItemsClassName&&n.elements.items.classList.add(this.categoryItemsClassName);const a=n.elements.container;return a.classList.add("hide"),n.set=e,this.categories[e.id]=n,this.categoriesMap.set(a,n),!i&&this.categoriesByMenuTabMap.set(n.elements.menuTab,n),this.categoriesIntersector.observe(a),!i&&this.menuOnClickResult.stickyIntersector.observeStickyHeaderChanges(a),s||!i&&n.elements.menuTab.classList.add("not-local"),n}positionCategory(e,t){const{menuTab:s,container:i}=e.elements,n=t?this.localCategories.filter(l=>l.mounted).length:65535;let a=!1;const r=t?this.localCategories.filter(l=>l.menuScroll&&!a?(a=!0,!0):l.mounted&&!l.menuScroll&&l.elements.menuTab).length:65535;ws(i,this.categoriesContainer,n),ws(s,this.menu,r)}isCategoryVisible(e){return this.categoriesIntersector.isVisible(e.elements.container)}toggleLocalCategory(e,t){if(!t)e.elements.menuTab?.remove(),e.elements.container.remove();else{const s=this.localCategories.indexOf(e),i=this.localCategories.slice(0,s);let n=0,a=0;i.forEach(c=>{c.mounted?(!c.elements.menuTab||c.menuScroll)&&++a:(++n,++a)});const r=s-n,l=s-a;e.elements.menuTab&&ws(e.elements.menuTab,this.menu,l),ws(e.elements.container,this.categoriesContainer,r)}e.mounted=t}createLocalCategory({id:e,title:t,icon:s,noMenuTab:i}){const n=this.createCategory({stickerSet:{id:e},title:t&&_(t),isLocal:!0,noMenuTab:i});return n.local=!0,this.localCategories.push(n),n.elements.title&&n.elements.title.classList.add("disable-hover"),i||(s&&n.elements.menuTab.append(Le(s)),n.elements.menuTabPadding.remove()),this.toggleLocalCategory(n,!1),n}onLocalCategoryUpdate(e){e.setCategoryItemsHeight(),this.toggleLocalCategory(e,!!e.items.length)}deleteCategory(e){return e?(e.elements.container.remove(),e.elements.menuTab.remove(),this.categoriesIntersector.unobserve(e.elements.container),delete this.categories[e.id],this.categoriesMap.delete(e.elements.container),this.categoriesByMenuTabMap.delete(e.elements.menuTab),e.middlewareHelper.destroy(),!0):!1}spliceExceed(e){if(e.limit===void 0)return!1;const{items:t,limit:s}=e;return t.splice(s,t.length-s).forEach(({element:i})=>{i.remove()}),this.onLocalCategoryUpdate(e),!0}init(){this.emoticonsDropdown&&this.listenerSetter.add(this.emoticonsDropdown)("closed",()=>{this.postponedEvents.forEach(({cb:e,args:t})=>{e(...t)}),this.postponedEvents.length=0})}destroy(){this.getContainerSize=void 0,this.postponedEvents.length=0,this.categoriesIntersector?.disconnect(),this.listenerSetter.removeAll(),this.scrollable.destroy(),this.menuScroll?.destroy(),this.menuOnClickResult?.stickyIntersector?.disconnect(),this.middlewareHelper.destroy()}}class ll extends vb{constructor(e){super(e,"super-stickers",()=>Fe.active.esgSticker,3*2,4,4),this.onCategoryVisibility=({target:t,visible:s,entry:i})=>{const n=this.categoriesMap.get(t);n.elements.items.replaceChildren(...s?n.items.map(({element:a})=>a):[])},this.setTyping=(t=!1)=>{!t&&(!this.emoticonsDropdown.isActive()||this.emoticonsDropdown.tab!==this)||C.dispatchEvent("choosing_sticker",!t)},this.container.classList.add("stickers-padding"),this.content.id="content-stickers"}setFavedLimit(e){const t=this.categories.faved;t.limit=e}categoryAppendStickers(e,t,s){const{container:i}=t.elements;t.setCategoryItemsHeight(e),i.classList.remove("hide"),Promise.all([s,fe.isPremiumFeaturesHidden()]).then(([n,a])=>{const r=this.isCategoryVisible(t);n.forEach(l=>{if(a&&Nc(l))return;const c=this.superStickerRenderer.renderSticker(l);t.items.push({document:l,element:c}),r&&t.elements.items.append(c)})})}async renderStickerSet(e,t=!1){const s=this.createCategory({stickerSet:e,title:Pe(e.title)}),{menuTabPadding:i}=s.elements,n=this.managers.appStickersManager.getStickerSet(e);this.categoryAppendStickers(e.count,s,n.then(a=>a.documents)),this.positionCategory(s,t),Xm({set:e,container:i,group:en,lazyLoadQueue:this.emoticonsDropdown.lazyLoadQueue,width:32,height:32,autoplay:!1,middleware:s.middlewareHelper.get()})}init(){super.init(),this.scrollable.onAdditionalScroll=()=>{this.setTyping()};const e={root:this.emoticonsDropdown.getElement()};this.categoriesIntersector=new Th(this.onCategoryVisibility,e);const t=p=>{p.elements.items.replaceChildren(),p.items.forEach(({element:m})=>this.superStickerRenderer.unobserveAnimated(m)),p.items.length=0};this.scrollable.container.addEventListener("click",p=>{const m=p.target;if(U(m,"category-title")){const g=U(m,"emoji-category"),f=this.categoriesMap.get(g);if(f.local)return;J.createPopup(Pn,{id:f.set.id,access_hash:f.set.access_hash}).show();return}this.emoticonsDropdown.onMediaClick(p)}),this.menuOnClickResult=Mr.menuOnClick(this,this.menu,this.scrollable,this.menuScroll);const s=pn(this.content,!0),i=(p,m)=>{p.limit&&(m=m.slice(0,p.limit));const g=new Set(m.map(f=>f.id));ii(p.items,f=>{g.has(f.document.id)||this.deleteSticker(p,f.document,!0)}),this.toggleLocalCategory(p,!!m.length),ii(m,(f,y)=>{this.unshiftSticker(p,f,!0,y)}),this.spliceExceed(p),p.elements.container.classList.remove("hide")},n=this.createLocalCategory({id:"faved",title:"FavoriteStickers",icon:"savedmessages"}),a=this.createLocalCategory({id:"recent",title:"Stickers.Recent",icon:"recent"});a.limit=20;const r=Xe("close",{noRipple:!0});a.elements.title.append(r),D(r,()=>{ft({titleLangKey:"ClearRecentStickersAlertTitle",descriptionLangKey:"ClearRecentStickersAlertMessage",button:{langKey:"Clear"}}).then(()=>{this.managers.appStickersManager.clearRecentStickers()},qt)});const l=this.createLocalCategory({id:"premium",title:"PremiumStickersShort"}),c=Le("star","color-premium");l.elements.menuTab.append(c);const d=[Promise.all([this.managers.apiManager.getLimit("favedStickers"),this.managers.appStickersManager.getFavedStickersStickers()]).then(([p,m])=>{this.setFavedLimit(p),i(n,m)}),this.managers.appStickersManager.getRecentStickersStickers().then(p=>{i(a,p)}),this.managers.appStickersManager.getAllStickers().then(p=>{for(const m of p.sets)this.renderStickerSet(m)}),this.managers.appStickersManager.getPremiumStickers().then(p=>{const m=p.length;this.toggleLocalCategory(l,C.premium&&!!m),this.categoryAppendStickers(p.length,l,Promise.resolve(p)),C.addEventListener("premium_toggle",g=>{this.toggleLocalCategory(this.categories.premium,g&&!!m)})})];Promise.race(d).finally(()=>{s.remove()}),Promise.all(d).finally(()=>{this.mounted=!0,this.setTyping();const p=this.categories.faved,m=this.categories.recent;this.menuOnClickResult.setActive(p.items.length?p:m),C.addEventListener("stickers_installed",g=>{this.categories[g.id]||this.renderStickerSet(g,!0)})}),this.superStickerRenderer=new Qh({regularLazyLoadQueue:this.emoticonsDropdown.lazyLoadQueue,group:en,managers:this.managers,intersectionObserverInit:e});const h=this.superStickerRenderer.lazyLoadQueue;this.emoticonsDropdown.addLazyLoadQueueRepeat(h,this.superStickerRenderer.processInvisible),C.addEventListener("sticker_updated",({type:p,document:m,faved:g})=>{const f=this.categories[p==="faved"?"faved":"recent"];f&&(g?this.unshiftSticker(f,m):this.deleteSticker(f,m))}),C.addEventListener("stickers_deleted",({id:p})=>{const m=this.categories[p];this.deleteCategory(m)&&t(m)}),C.addEventListener("stickers_top",this.postponedEvent(p=>{const m=this.categories[p];m&&(this.positionCategory(m,!0),this.emoticonsDropdown.addEventListener("openAfterLayout",()=>{this.menuOnClickResult.setActiveStatic(m)},{once:!0}))})),C.addEventListener("stickers_order",({type:p,order:m})=>{p==="stickers"&&m.forEach(g=>{const f=this.categories[g];f&&this.positionCategory(f,!1)})}),C.addEventListener("stickers_updated",({type:p,stickers:m})=>{const g=this.categories[p==="faved"?"faved":"recent"];g&&i(g,m)}),C.addEventListener("app_config",()=>{this.managers.apiManager.getLimit("favedStickers").then(p=>{this.setFavedLimit(p)})}),Fe.addEventListener("resize",this.resizeCategories),Ko({listenTo:this.content,listenerSetter:new Qt});const u="menu";yb({listenTo:this.content,verifyRecent:p=>!!Vs(p,this.categories.recent.elements.items),onOpen:()=>{this.emoticonsDropdown.setIgnoreMouseOut(u,!0)},onClose:()=>{this.emoticonsDropdown.setIgnoreMouseOut(u,!1)}}),this.init=null}deleteSticker(e,t,s){const i=Ba(e.items,n=>n.document.id===t.id);i&&(i.element.remove(),s||this.onLocalCategoryUpdate(e))}unshiftSticker(e,t,s,i){if(i!==void 0){const a=e.items[i];if(a&&a.document.id===t.id)return}let n=Ba(e.items,a=>a.document.id===t.id);n||(n={element:this.superStickerRenderer.renderSticker(t),document:t}),e.items.unshift(n),e.elements.items.prepend(n.element),s||this.spliceExceed(e)}unshiftRecentSticker(e){this.managers.appStickersManager.saveRecentSticker(e.id)}deleteRecentSticker(e){this.managers.appStickersManager.saveRecentSticker(e.id,!0)}onClosed(){this.setTyping(!0)}onOpened(){this.setTyping(),this.resizeCategories()}}const Lf=new Set;function bb(o,e,t=!1,s=!1){const i=document.createElement("span");i.classList.add("super-emoji","super-emoji-regular");let n;if(s&&!sC?n=kP(o):(o=Ym(o),n=Pe(o)),i.append(n),i.children.length>1){const a=i.firstElementChild;i.replaceChildren(a)}if(i.firstElementChild?.tagName==="IMG"){const a=i.firstElementChild,r=a.src;if(!Lf.has(r)){a.setAttribute("loading","lazy");const l=document.createElement("span");l.classList.add("emoji-placeholder"),et.isAvailable("animations")&&(a.style.opacity="0",l.style.opacity="1"),a.addEventListener("load",()=>{vs(()=>{et.isAvailable("animations")&&(a.style.opacity="",l.style.opacity=""),i.classList.remove("empty"),Lf.add(r)})},{once:!0}),i.append(l)}}return e&&(t?e.prepend(i):e.appendChild(i)),i}function wb(o){const e=U(o,"super-emoji");if(!e)return;const t=e.firstElementChild;return t&&t.classList.contains("custom-emoji")?{emoji:t.dataset.stickerEmoji,docId:t.dataset.docId}:o.nodeType===o.TEXT_NODE?{emoji:o.nodeValue}:(o.tagName==="SPAN"&&!o.classList.contains("emoji")&&o.firstElementChild&&(o=o.firstElementChild),{emoji:o.getAttribute("alt")||o.innerText})}const wl="Emoji.Recent",xp=[wl,"recent"],ba="",Ap=[ba,""],Sl=[["Emoji.SmilesAndPeople","smile"],["Emoji.AnimalsAndNature","animals"],["Emoji.FoodAndDrink","eats"],["Emoji.TravelAndPlaces","car"],["Emoji.ActivityAndSport","sport"],["Emoji.Objects","lamp"],["Emoji.Flags","flag"],["Skin Tones",""]];let Yn;function Mf(){if(Yn)return Yn;const o=[[Ap,[]],[xp,[]]];Yn=new Map(o);for(const s in Vg){const n=""+Vg[s],a=Sl[+n[0]-1];if(!a)continue;let r=Yn.get(a);r||(r=[],Yn.set(a,r)),r[+n.slice(1)||0]=s}Yn.delete(Sl.pop()),Sl.unshift(Ap,xp);const e=Sl.map(([s])=>s),t=[...Yn.entries()].sort((s,i)=>e.indexOf(s[0][0])-e.indexOf(i[0][0]));return Yn=new Map(t),Yn}const AP=ys(42,42),Au=32;class Fn extends vb{constructor(e){super(e.managers,"super-emojis",()=>AP,16,4,0),this.onCategoryVisibility=({target:t,visible:s})=>{this._onCategoryVisibility(this.categoriesMap.get(t),s)},this.onContentClick=t=>{X(t);const{target:s}=t,i=U(s,"emoji-category"),n=this.categoriesMap.get(i);if(U(s,"category-title")){if(n.local)return;J.createPopup(Pn,{id:n.set.id,access_hash:n.set.access_hash},!0).show();return}const a=wb(s);if(a){if(a.docId&&!C.premium&&(this.isStandalone?n.id!==ba:this.peerId!==C.myId)&&!this.freeCustomEmoji.has(a.docId)){const r=fi(()=>{Br(),ce.openPremiumBot()});Re({langPackKey:"CustomEmoji.PremiumAlert",langPackArguments:[r]});return}this.onClick?this.onClick({...a,element:U(s,"super-emoji").firstElementChild}):this.emoticonsDropdown.chatInput.onEmojiSelected(a,!1),Ye&&un()}},Lt(this,e),this.container.classList.add("emoji-padding"),this.content.id="content-emoji",this.activeElements=[],this.freeCustomEmoji??(this.freeCustomEmoji=new Set)}_onCategoryVisibility(e,t){const s=e.elements.renderer,i=[];if(s){i.push(s);const n=new Map;t?(i.push(...e.items.map(({docId:a,element:r})=>{if(!a)return r;const l=r.firstElementChild;return l.clear(!1),n.set(l.docId,new Set([l])),r})),s.add({addCustomEmojis:n})):(s.clearCanvas(),s.middlewareHelper.clean())}else t&&i.push(...e.items.map(({element:n})=>n));if(e.elements.items.replaceChildren(...i),s&&!t){const n=new Map;e.items.forEach(({docId:a,element:r})=>{if(!a)return;const l=r.firstElementChild;l.clear(),n.set(l.docId,new Set([l]))}),s.add({addCustomEmojis:n,onlyThumb:!0})}}destroy(){super.destroy(),this.menuInnerScroll?.destroy()}init(){super.init(),this.init=void 0;const e={root:this.isStandalone?this.content:this.emoticonsDropdown.getElement()};this.categoriesIntersector=new Th(this.onCategoryVisibility,e),this.menuOnClickResult=Mr.menuOnClick(this,this.menu,this.scrollable,this.menuScroll,void 0,this.listenerSetter);const t=pn(this.content,!0);let s;if(!this.isStandalone&&!this.noPacks){const r=this.menuInnerScroll=new Va(void 0);r.container.classList.add("menu-horizontal-inner-scroll"),s=document.createElement("div"),s.classList.add("menu-horizontal-inner"),s.append(r.container)}this.noPacks&&this.menuWrapper.remove();let i;Mf(),this.noRegularEmoji?(i=new Map([[[Ap[0],"recent"],[]]]),this.noPacks||i.set([xp[0],""],[])):i=Mf(),i.forEach((r,[l,c])=>{const d=this.createLocalCategory({id:l,title:l,icon:c,noMenuTab:!c});d.elements.container.classList.remove("hide"),r.forEach(h=>{const u=Sm(h);this.addEmojiToCategory({category:d,emoji:{emoji:u},batch:!0})})});const n=this.mainSets?.(),a=Promise.all([this.preloaderDelay?js(this.preloaderDelay):void 0,!this.noRegularEmoji&&this.managers.appEmojiManager.getRecentEmojis("native"),!this.isStandalone&&this.managers.appEmojiManager.getRecentEmojis("custom"),!this.noPacks&&Promise.resolve(fe.isPremiumFeaturesHidden()).then(r=>r?void 0:this.managers.appEmojiManager.getCustomEmojis()),n&&Promise.all(Array.isArray(n)?n:[n])]).then(([r,l,c,d,h])=>{t.remove();const u=v=>v.map(b=>({emoji:"",docId:b}));let p,m;h&&(m=u(h[0]),h[1]&&(p=u(h[1]))),!p&&l&&(p=l.map(v=>({emoji:v}))),!m&&c&&(m=u(c));const g=this.categories[wl],f=this.categories[ba];if(this.noRegularEmoji||[g&&[g,l],f&&[f,c]].filter(Boolean).forEach(([b,w])=>{b.limit=Au,w.splice(Au,w.length-Au)}),g&&(this.createRendererForCategory(g),p?.length))for(const v of p)this.addEmojiToCategory({category:g,emoji:v,batch:!0});if(f){if(this.createRendererForCategory(f),m?.length)for(const v of m)this.addEmojiToCategory({category:f,emoji:v,batch:!0});f.elements.container.style.paddingTop=".5rem"}Sl.forEach(([v])=>{const b=this.categories[v];b&&(this.toggleLocalCategory(b,!!b.items.length),v!==wl&&v!==ba&&(b.menuScroll=this.menuInnerScroll,this.menuInnerScroll.append(b.elements.menuTab)))}),this.resizeCategories(),g&&s&&g.elements.menuTab&&g.elements.menuTab.after(s),d&&d.sets.forEach(v=>{this.renderStickerSet(v)}),this.listenerSetter.add(C)("premium_toggle",()=>{this.toggleCustomCategory()}),this.listenerSetter.add(C)("stickers_top",this.postponedEvent(v=>{const b=this.categories[v];b&&(this.positionCategory(b,!0),this.listenerSetter.add(this.emoticonsDropdown)("openAfterLayout",()=>{this.menuOnClickResult.setActiveStatic(b)},{once:!0}))}));const y=v=>{for(const b in this.categories){const S=this.categories[b].elements.renderer;S&&(S.ignoreSettingDimensions=v,v||S.setDimensionsFromRect(void 0,!0))}};!this.isStandalone&&this.listenerSetter.add(this.emoticonsDropdown)("opened",()=>{y(!1)}),!this.isStandalone&&this.listenerSetter.add(this.emoticonsDropdown)("close",()=>{y(!0)}),this.listenerSetter.add(C)("stickers_installed",v=>{!this.categories[v.id]&&v.pFlags.emojis&&this.renderStickerSet(v,!0)}),this.listenerSetter.add(C)("stickers_deleted",v=>{const b=this.categories[v.id];if(this.deleteCategory(b)){const{renderer:w}=b.elements;w&&w.middlewareHelper.clean()}}),!this.noRegularEmoji&&this.listenerSetter.add(C)("emoji_recent",this.postponedEvent(v=>{const b=this.categories[v.docId?ba:wl];if(!b)return;const w=v.docId?I=>I.docId===v.docId:I=>I.emoji===v.emoji,S=Ba(b.items,w);if(S){if(b.items.unshift(S),this.isCategoryVisible(b)){const{renderer:I}=b.elements;ws(S.element,b.elements.items,I?1:0,-1),I?.forceRender()}}else this.addEmojiToCategory({category:b,emoji:v,batch:!1,prepend:!0});this.closeScrollTop===0&&this.menuOnClickResult.setActive(v.docId?this.categories[wl]:b)})),this.toggleCustomCategory(),this.menuOnClickResult.setActive([f,g].find(v=>!!v.elements.menuTab))});return D(this.content,this.onContentClick,{listenerSetter:this.listenerSetter}),Ko({listenTo:this.content,listenerSetter:this.listenerSetter,getTextColor:()=>this.textColor}),this.initPromise=a}get textColor(){return this.emoticonsDropdown?.textColor||ic}renderStickerSet(e,t){const s=this.createCategory({stickerSet:e,title:Pe(e.title)});this.positionCategory(s,t);const{container:i,menuTabPadding:n}=s.elements;s.elements.items.classList.add("not-local"),s.elements.container.classList.add("is-premium-set"),s.elements.title.prepend(Le("premium_lock","category-title-lock")),this.createRendererForCategory(s),s.setCategoryItemsHeight(e.count),i.classList.remove("hide"),this.managers.appStickersManager.getStickerSet(e).then(({documents:r})=>{r.forEach(l=>{this.addEmojiToCategory({category:s,emoji:{docId:l.id,emoji:l.stickerEmojiRaw},batch:!0})}),this.onCategoryVisibility({target:s.elements.container,visible:this.isCategoryVisible(s)})}),Xm({set:e,container:n,group:en,lazyLoadQueue:this.emoticonsDropdown?.lazyLoadQueue,width:32,height:32,autoplay:!1,textColor:this.textColor,middleware:s.middlewareHelper.get()})}get peerId(){return this.emoticonsDropdown?this.emoticonsDropdown.chatInput.chat.peerId:Vt}getCustomCategory(){return this.categories[ba]}toggleCustomCategory(){const e=this.categories[ba],t=C.premium||this.peerId===C.myId||!!this.mainSets,s=t||this.isStandalone;super.toggleLocalCategory(e,!!e.items.length&&s),this.content.classList.toggle("has-premium",t)}toggleLocalCategory(e,t){if(e.id===ba){this.toggleCustomCategory();return}super.toggleLocalCategory(e,t)}setTextColor(e=ic){this.categoriesMap.forEach(t=>{t.elements.renderer?.setTextColor(e)})}createRendererForCategory(e){const t=rv.create({animationGroup:en,customEmojiSize:Fe.active.esgCustomEmoji,textColor:this.textColor});e.elements.renderer=t,e.elements.items.append(t)}addEmojiToCategory(e){const{category:t,emoji:s,batch:i,prepend:n}=e;let a=e.element;if(a){const l=document.createElement("span");l.classList.add("super-emoji"),l.append(a),a=l}else if(s.docId){const l=wm.create(s.docId),c=document.createElement("span");c.classList.add("super-emoji","super-emoji-custom"),c.append(l),a=c}else a=bb(s.emoji,void 0,!1);const r={...s||{emoji:void 0},element:a};(e.active||this.activeEmoji&&(r.docId?this.activeEmoji.docId===r.docId:this.activeEmoji.emoji===r.emoji))&&(this.activeEmoji,this.activeElements.push(r),a.classList.add("active")),t.items[n?"unshift":"push"](r),!i&&!this.spliceExceed(t)&&this.onLocalCategoryUpdate(t)}setActive(e){(e===this.activeEmoji||e?.docId?e.docId===this.activeEmoji?.docId:e?.emoji===this.activeEmoji?.emoji)||(this.activeEmoji=e,this.activeElements.forEach(t=>{t.element.classList.remove("active")}),this.activeElements.length=0,this.categoriesMap.forEach(t=>{t.items.forEach(s=>{(e.docId?s.docId===e.docId:s.emoji===e.emoji)&&(s.element.classList.add("active"),this.activeElements.push(s))})}))}onClose(){this.closeScrollTop=this.scrollable.scrollPosition}}class FP extends nv{constructor(e,t){super(e),this.onVisibilityChange=t,this.intersector=new Th(s=>{const{target:i,visible:n}=s,a=ov(this.queue,r=>r.div===i);n&&a.length&&a.forEach(r=>{this.queue.unshift(r)}),this.onVisibilityChange&&this.onVisibilityChange(s),this.setProcessQueueTimeout()})}observe(e){super.observe(e)}}const Pf="…",tc=new Map,sc=new Set;let Fu=!1;function Sb(){Fu||(Fu=!0,vs(()=>{Fu=!1,RP()}))}function RP(){sc.forEach(Cb),sc.clear()}window.addEventListener("resize",()=>{for(const[o]of tc)sc.add(o);Sb()},{capture:!0,passive:!0});function Ru(o){const e=o.getSize;if(e)return e();const t=o.dataset.sizeType;return t?Fe.active[t].width:o.getBoundingClientRect().width}function Cb(o){let e=tc.get(o);const t=!e;let{text:s,textLength:i,from:n,multiplier:a,font:r,textWidth:l,elementWidth:c}=e||{};if(t){s=o.textContent,i=s.length,n=50,a=n>0&&n/100;let u=o.dataset.fontSize;u&&+u&&(u+="px"),r=`${o.dataset.fontWeight||iC} ${u||Wy} ${Io}`,l=Zl(s,r),c=Ru(o),e={text:s,textLength:i,from:n,multiplier:a,font:r,textWidth:l,elementWidth:c},tc.set(o,e)}const d=Ru(o),h=t||c!==d;if(!t&&h&&(e.elementWidth=c=d),h)if(l>c){o.setAttribute("title",s);let u=s,p=c;for(;u.length>3;){const m=u.length,g=a&&Ot(a*m<<0,1,m-2)||Math.max(m+n-1,1),f=u.substr(0,g).replace(/\s*$/,""),y=u.substr(g+1).replace(/^\s*/,"");if(u=f+y,p=Zl(u+Pf,r),p<c){o.textContent=f+Pf+y;break}}e.elementWidth=Ru(o)}else o.removeAttribute("title")}class Zm extends HTMLElement{connectedCallback(){tc.set(this,null),this.dataset.sizeType||this.getSize?Cb(this):(sc.add(this),Sb())}disconnectedCallback(){tc.delete(this),sc.delete(this)}}customElements.define("middle-ellipsis-element",Zm);function hn(o){return o&&(o.saved_from_name||o.from_name)}function Ib(o){return o.fromId?{peerId:o.fromId}:{fromName:hn(o.fwd_from)}}async function ah(o){const e=document.createElement("span");e.classList.add("sender-title");const t=o.fromId===C.myId&&o.peerId!==C.myId;if(e.append(t?_("FromYou"):await Oe({...Ib(o),dialog:o.peerId===C.myId})),await C.managers.appPeersManager.isAnyGroup(o.peerId)||t){const s=await Oe({peerId:o.peerId});e.append(" ➝ ",s)}return e}function Jm(o){const e=document.createElement("span");return e.classList.add("sent-time"),e.append(Bc(new Date(o.date*1e3))),e}const DP=!0;C.addEventListener("messages_media_read",({mids:o,peerId:e})=>{o.forEach(t=>{const s=`[data-mid="${t}"][data-peer-id="${e}"]`;Array.from(document.querySelectorAll(`audio-element.is-unread${s}, .media-round.is-unread${s}`)).forEach(i=>{i.classList.remove("is-unread")})})});function BP(o){o instanceof Uint8Array||(o=new Uint8Array(o));const t=o.length*8/5|0;if(!t)return new Uint8Array([]);let s;try{const i=new DataView(o.buffer);s=new Uint8Array(t);for(let n=0;n<t;n++){const a=n*5/8|0,r=n*5%8,l=i.getUint16(a,!0);s[n]=l>>r&31}}catch{s=new Uint8Array([])}return s}function NP(o,e){const n=Fe.isMobile?16:23,a=Fe.isMobile?152:190,r=Fe.isMobile?190:256,l=Ot(e/60*r,a,r),c=Math.max(...o),d=o.length,h=Math.min(l/4|0,d);let u=0;const p=n-4;let m="";for(let y=0,v=0,b=0;y<d;++y){const w=o[y]||0;if(b+h>=d){b=b+h-d,b<(h+1)/2&&u<w&&(u=w);const S=Math.max((u*p+(c+1)/2)/(c+1),4),I=`<rect class="audio-waveform-bar" x="${v}" y="${n-S}" width="2" height="${S}" rx="1" ry="1"></rect>`;m+=I,v+=4,b<(h+1)/2?u=0:u=w}else u<w&&(u=w),b+=h}let g,f;return m&&(g=document.createElement("div"),g.classList.add("audio-waveform"),f=document.createElementNS("http://www.w3.org/2000/svg","svg"),f.classList.add("audio-waveform-bars"),f.setAttributeNS(null,"width",""+l),f.setAttributeNS(null,"height",""+n),f.setAttributeNS(null,"viewBox",`0 0 ${l} ${n}`),f.insertAdjacentHTML("beforeend",m),g.append(f)),{svg:f,container:g,availW:l}}async function OP(o){o.classList.add("is-voice");const e=o.message,t=Hs(e);e.pFlags.out&&o.classList.add("is-out");let s=t.attributes.find(p=>p._==="documentAttributeAudio").waveform||new Uint8Array([]);s=BP(s.slice(0,63));const{svg:i,container:n,availW:a}=NP(s,t.duration);let r;n&&(r=n.cloneNode(!0),r.classList.add("audio-waveform-fake"),n.classList.add("audio-waveform-background"));const l=document.createElement("div");l.classList.add("audio-waveform-container"),n&&l.append(n,r);const c=document.createElement("div");if(c.classList.add("audio-time"),o.append(l,c),o.transcriptionState!==void 0){o.classList.add("can-transcribe");const p=document.createElement("div");p.classList.add("audio-to-text-button");const m=Le("transcribe"),g=document.createElement("div");g.classList.add("loader"),g.innerHTML='<svg class="audio-transcribe-outline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 24"><rect class="audio-transcribe-outline-rect" fill="transparent" stroke-width="3" stroke-linejoin="round" rx="6" ry="6" stroke="var(--message-primary-color)" stroke-dashoffset="1" stroke-dasharray="32,68" width="32" height="24"></rect></svg>',p.append(m),p.onclick=()=>{const f=(U(o,"document-wrapper")||U(o,"quote-text")).querySelector(".audio-transcribed-text");if(o.transcriptionState===0)if(f)f.classList.remove("hide"),m.classList.remove(sa("transcribe")),m.classList.add(sa("up")),o.transcriptionState=2;else{const y=o.message;if(y.pFlags.is_outgoing)return;o.transcriptionState=1,!g.parentElement&&p.append(g),Wn().then(()=>{o.transcriptionState===1&&g.classList.add("active")}),o.managers.appMessagesManager.transcribeAudio(y).catch(qt)}else o.transcriptionState===2&&(f.classList.add("hide"),m.classList.remove(sa("up")),m.classList.add(sa("transcribe")),o.transcriptionState=0)},o.append(p)}let d=i,h;return d||(h=new qh,l.append(h.container)),()=>{let p=o.audio;const m=()=>{la(()=>p?(g(),!p.paused):!1,o)},g=()=>{r&&(r.style.width=p.currentTime/p.duration*100+"%")};(!p.paused||p.currentTime>0&&p.currentTime!==p.duration)&&g();const f=zC(g);return o.addAudioListener("timeupdate",f),o.addAudioListener("ended",f),o.addAudioListener("play",m),d&&o.readyPromise.then(()=>{let y=!1,v=!1;d.addEventListener("mouseleave",w=>{y&&(o.togglePlay(void 0,!0),y=!1),v=!1}),d.addEventListener("mousemove",w=>{v=!0,y&&b(w)}),d.addEventListener("mousedown",w=>{w.preventDefault(),w.button===0&&(p.paused||o.togglePlay(void 0,!1),b(w),y=!0)}),d.addEventListener("mouseup",w=>{v&&y&&(o.togglePlay(void 0,!0),y=!1)}),D(d,w=>{X(w),p.paused||b(w)});function b(w){let S;if(w instanceof MouseEvent)S=w.offsetX;else{const L=w.target.getBoundingClientRect();S=w.targetTouches[0].pageX-L.left}const I=S/a*p.duration;ti(p,I)}},qt),!d&&h.setMedia({media:p,streamable:t.supportsStreaming,duration:t.duration}),()=>{d?.remove(),d=null,p=null}}}async function UP(o){const e=o.withTime,t=o.message,s=Hs(t),i=s.type==="voice"||s.type==="round",n=document.createElement("div");n.classList.add("audio-description");const a=s.attributes.find(u=>u._==="documentAttributeAudio");if(!i){const u=[];a?.performer&&u.push(Pe(a.performer)),e?u.push(Ss(t.date)):u.length||u.push(na(s.size)),o.showSender&&u.push(await ah(t)),n.append(" • ",...Ar(u," • "))}o.insertAdjacentHTML("beforeend",`
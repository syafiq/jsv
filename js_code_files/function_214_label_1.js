`:""}).join("")}static onDownloadClick(e,t){if(Array.isArray(e))return e.map(s=>this.onDownloadClick(s));if(this.canDownload(e,void 0,t))return as.downloadToDisc({media:Hs(e,!0)})}}const s_=window.matchMedia("(display-mode: standalone)").matches,Zf=o=>[...o.values()].reduce((e,t)=>e+t.size,0);class ww extends vi{constructor(e){super(!1),this.selectedMids=new Map,this.isSelecting=!1,this.onMouseDown=t=>{const s=U(t.target,this.targetLookupClassName);if(t.button!==0||this.verifyTarget&&!this.verifyTarget(t,s))return;const i=new Map;let n,a=s;const r=(u,p=!0)=>{const m=+u.dataset.mid;if(!m||!u.dataset.peerId)return;const g=u.dataset.peerId.toPeerId();Bn(a)||(a=u);let f=i.get(g);if(f||i.set(g,f=new Set),f.has(m))return;const y=this.isMidSelected(g,m);if(n===void 0&&(n=!y),f.add(m),n&&!y||!n&&y){const v=Zf(i);if(this.toggleByElement&&p){v<2&&Vs(u,a)&&(a=u);const b=this.getElementsBetween(a,u);b.length&&b.forEach(w=>{r(w,!1)})}if(this.selectedMids.size)this.toggleByElement&&this.toggleByElement(u);else if(v===2&&this.toggleByMid)for(const[b,w]of i)for(const S of w)this.toggleByMid(b,S)}};let l=!1;const c=u=>{l||(rr(),l=!0,document.body.classList.add("no-select"));const p=this.getElementFromTarget(u.target);if(p){if(this.verifyMouseMoveTarget&&!this.verifyMouseMoveTarget(u,p,n)){this.listenerSetter.removeManual(this.listenElement,"mousemove",c),this.listenerSetter.removeManual(document,"mouseup",d,h);return}r(p)}},d=u=>{document.body.classList.remove("no-select"),i.size&&D(window,X,{capture:!0,once:!0,passive:!1}),this.listenerSetter.removeManual(this.listenElement,"mousemove",c),rr()},h={once:!0};this.listenerSetter.add(this.listenElement)("mousemove",c),this.listenerSetter.add(document)("mouseup",d,h)},this.getElementsBetween=(t,s)=>{if(t===s)return[];const i=t.getBoundingClientRect(),n=s.getBoundingClientRect(),r=(i.top-n.top||i.left-n.left)<0,l=U(t,this.lookupBetweenParentClassName);if(!l)return[];const c=Array.from(l.querySelectorAll(this.lookupBetweenElementsQuery));let d=c.indexOf(t),h=c.indexOf(s);return r||([h,d]=[d,h]),c.slice(d+1,h)},this.cancelSelection=t=>{t&&(this.doNotAnimate=!0),this.onCancelSelection?.(),this.selectedMids.clear(),this.toggleSelection(),rr(),t&&(this.doNotAnimate=void 0)},Lt(this,e),this.navigationType="multiselect-"+Dc()}attachListeners(e,t){if(this.listenElement&&this.listenerSetter.removeAll(),this.listenElement=e,this.listenerSetter=t,!!e){if(Ye){t.add(e)("touchend",()=>{this.isSelecting&&(this.selectedText=lw())}),ua({element:e,callback:s=>{if(this.isSelecting||this.verifyTouchLongPress&&!this.verifyTouchLongPress())return;this.onTouchLongPress?.(s),document.body.classList.add("no-select"),e.addEventListener("touchend",n=>{X(n),document.body.classList.remove("no-select")},{once:!0,capture:!0}),Vn&&s_&&e.addEventListener("mousedown",X,{once:!0,capture:!0}),rr(),X(s);const i=this.getElementFromTarget(s.target);i&&this.toggleByElement(i)},listenerSetter:t});return}t.add(e)("mousedown",this.onMouseDown)}}isElementShouldBeSelected(e){return this.isMidSelected(e.dataset.peerId.toPeerId(),+e.dataset.mid)}appendCheckbox(e,t){e.prepend(t.label)}toggleElementCheckbox(e,t){const s=!!this.getCheckboxInputFromElement(e);if(t){if(s)return!1;const i=new ct({name:e.dataset.mid,round:!0});this.isSelecting&&this.isElementShouldBeSelected(e)&&(i.input.checked=!0,e.classList.add("is-selected")),this.appendCheckbox(e,i)}else s&&(this.getCheckboxInputFromElement(e).parentElement.remove(),vt({element:e,className:"is-selected",forwards:!1,duration:200}));return!0}getCheckboxInputFromElement(e){return e.firstElementChild?.tagName==="LABEL"&&e.firstElementChild.firstElementChild}async updateContainer(e=!1){const t=this.selectedMids.size;if(!t&&!e)return;let s=!t,i=!t,n=!t,a=!t;if(this.isStories){s=!0,n=!0;const r=this.selectedMids.keys().next().value,l=await this.managers.appStoriesManager.cantPinDeleteStories(r,Array.from(this.selectedMids.get(r)));a=l.cantPin,i=l.cantDelete}else for(const[r,l]of this.selectedMids){const c=this.getStorageKey(r),d=await this.managers.appMessagesManager.cantForwardDeleteMids(c,Array.from(l));if(s=d.cantForward,i=d.cantDelete,s&&i)break}this.onUpdateContainer?.(s,i,n,a)}getStorageKey(e){return`${e}_${this.isScheduled?"scheduled":"history"}`}getSelectedMids(){return Na([...this.selectedMids.values()].map(e=>[...e])).sort((e,t)=>e-t)}getSelectedMessages(){const e=[];return this.selectedMids.forEach((t,s)=>{const i=this.getStorageKey(s),n=Array.from(t).map(a=>this.managers.appMessagesManager.getMessageFromStorage(i,a));e.push(...n)}),Promise.all(e)}toggleSelection(e=!0,t=!1){const s=this.isSelecting,i=this.selectedMids.size;if(this.isSelecting=!!i||t,s===this.isSelecting)return!1;this.dispatchEvent("toggle",this.isSelecting),Ye||(this.listenElement.classList.toggle("no-select",this.isSelecting),s&&rr()),un();const n=!!i||t,a=this.onToggleSelection?.(n,!this.doNotAnimate);return Vn||(n?dt.pushItem({type:this.navigationType,onPop:()=>{this.cancelSelection()}}):dt.removeByType(this.navigationType)),t&&(a||Promise.resolve()).then(()=>this.updateContainer(t)),!0}cleanup(){this.doNotAnimate=!0,this.selectedMids.clear(),this.toggleSelection(!1),this.doNotAnimate=void 0}updateElementSelection(e,t){this.toggleElementCheckbox(e,!0);const s=this.getCheckboxInputFromElement(e);s.checked=t,this.toggleSelection(),this.updateContainer(),vt({element:e,className:"is-selected",forwards:t,duration:200})}isMidSelected(e,t){return!!this.selectedMids.get(e)?.has(t)}length(){return Zf(this.selectedMids)}toggleMid(e,t,s){let i=this.selectedMids.get(e);return s||s===void 0&&i?.has(t)?i&&(i.delete(t),i.size||this.selectedMids.delete(e)):(i||(i=new Set,this.selectedMids.set(e,i)),i.add(t)),!0}deleteSelectedMids(e,t){const s=this.selectedMids.get(e);s&&(t.forEach(i=>{s.delete(i)}),s.size||this.selectedMids.delete(e),this.updateContainer(),this.toggleSelection())}}class i_ extends ww{constructor(e,t,s){super({managers:t,verifyTarget:(i,n)=>!!n&&this.isSelecting,getElementFromTarget:i=>U(i,"search-super-item"),targetLookupClassName:"search-super-item",lookupBetweenParentClassName:"tabs-tab",lookupBetweenElementsQuery:".search-super-item"}),this.searchSuper=e,this.toggleByElement=i=>{const n=+i.dataset.mid,a=i.dataset.peerId.toPeerId();this.toggleMid(a,n)&&this.updateElementSelection(i,this.isMidSelected(a,n))},this.toggleByMid=(i,n)=>{const a=this.searchSuper.mediaTab.contentTab.querySelector(`.search-super-item[data-peer-id="${i}"][data-mid="${n}"]`);this.toggleByElement(a)},this.onDeleteStoriesClick=async i=>{const n=[...this.selectedMids.keys()][0];i||(i=[...this.selectedMids.get(n)]),await ft({titleLangKey:i.length===1?"DeleteStoryTitle":"DeleteStoriesTitle",descriptionLangKey:i.length===1?"DeleteStorySubtitle":"DeleteStoriesSubtitle",descriptionLangArgs:[i.length],button:{langKey:"Delete",isDanger:!0}}),this.cancelSelection(),this.managers.appStoriesManager.deleteStories(n,i)},this.onPinClick=(i,n)=>{const a=[...this.selectedMids.keys()][0];i||(i=[...this.selectedMids.get(a)]);const r=this.managers.appStoriesManager.togglePinned(a,i,n);this.cancelSelection(),r.then(()=>{i.length===1?Re({langPackKey:n?"StoryPinnedToProfile":"StoryArchivedFromProfile"}):Re({langPackKey:n?"StorySavedTitle":"StoryArchived",langPackArguments:[i.length]})})},this.onUpdateContainer=(i,n,a,r)=>{const l=this.length();tt(this.selectionCountEl,_(this.isStories?"StoriesCount":"messages",[l])),this.selectionPinBtn.classList.toggle("hide",!this.isStories||r),this.selectionGotoBtn.classList.toggle("hide",this.isStories||l!==1),this.selectionForwardBtn.classList.toggle("hide",i),this.selectionDeleteBtn&&this.selectionDeleteBtn.classList.toggle("hide",n)},this.onToggleSelection=(i,n)=>{if(vt({element:this.searchSuper.navScrollableContainer,className:"is-selecting",forwards:i,duration:n?200:0,onTransitionEnd:()=>{this.isSelecting||(this.selectionContainer.remove(),this.selectionContainer=this.selectionForwardBtn=this.selectionDeleteBtn=null,this.selectedText=void 0)}}),vt({element:this.searchSuper.container,className:"is-selecting",forwards:i,duration:200}),this.isSelecting&&!this.selectionContainer){const a="search-super-selection";this.selectionContainer=document.createElement("div"),this.selectionContainer.classList.add(a+"-container");const r=Xe(`close ${a}-cancel`,{noRipple:!0});D(r,()=>this.cancelSelection(),{listenerSetter:this.listenerSetter,once:!0}),this.selectionCountEl=document.createElement("div"),this.selectionCountEl.classList.add(a+"-count");const l={listenerSetter:this.listenerSetter};this.selectionPinBtn=Xe(`${this.isStoriesArchive?"pin":"unpin"} ${a}-pin`),D(this.selectionPinBtn,()=>this.onPinClick(void 0,this.isStoriesArchive),l),this.selectionGotoBtn=Xe(`message ${a}-goto`),D(this.selectionGotoBtn,()=>{const d=[...this.selectedMids.keys()][0],h=[...this.selectedMids.get(d)][0];this.cancelSelection(),ce.setInnerPeer({peerId:d,lastMsgId:h,threadId:this.searchSuper.mediaTab.type==="saved"?this.searchSuper.searchContext.peerId:this.searchSuper.searchContext.threadId})},l),this.selectionForwardBtn=Xe(`forward ${a}-forward`),D(this.selectionForwardBtn,()=>{const d={};for(const[h,u]of this.selectedMids)d[h]=Array.from(u).sort((p,m)=>p-m);J.createPopup(jn,d,()=>{this.cancelSelection()})},l),this.isPrivate&&(this.selectionDeleteBtn=Xe(`delete danger ${a}-delete`),D(this.selectionDeleteBtn,()=>{if(this.isStories){this.onDeleteStoriesClick();return}const d=this.searchSuper.searchContext.peerId;J.createPopup(jo,d,this.getSelectedMids(),Q.Chat,()=>{this.cancelSelection()})},l)),this.selectionContainer.append(...[r,this.selectionCountEl,this.selectionPinBtn,this.selectionGotoBtn,this.selectionForwardBtn,this.selectionDeleteBtn].filter(Boolean));const c=this.selectionContainer;c.style.opacity="0",this.searchSuper.navScrollableContainer.append(c),c.offsetLeft,c.style.opacity=""}},this.isPrivate=!e.showSender,this.attachListeners(e.container,s)}toggleSelection(e=!0,t=!1){const s=super.toggleSelection(e,t);return s&&e&&Array.from(this.searchSuper.tabsContainer.querySelectorAll(".search-super-item")).forEach(n=>{this.toggleElementCheckbox(n,this.isSelecting)}),s}}class n_ extends ww{constructor(e,t,s,i){super({managers:i,getElementFromTarget:n=>U(n,"grouped-item")||U(n,"bubble"),verifyTarget:(n,a)=>!(!this.selectedMids.size&&!n.target.classList.contains("bubble")&&!n.target.classList.contains("document-selection")&&a),verifyMouseMoveTarget:(n,a,r)=>!(n.target!==a&&!n.target.classList.contains("document-selection")&&r===void 0&&!this.selectedMids.size),verifyTouchLongPress:()=>!this.chat.input.recording,targetLookupClassName:"bubble",lookupBetweenParentClassName:"bubbles-inner",lookupBetweenElementsQuery:".bubble:not(.is-multiple-documents), .grouped-item",onTouchLongPress:()=>{const{replySwipeHandler:n}=this.chat.bubbles;n?.reset()}}),this.chat=e,this.bubbles=t,this.input=s,this.toggleByElement=n=>{if(!this.canSelectBubble(n))return;const a=+n.dataset.mid,r=n.dataset.peerId.toPeerId();if(n.classList.contains("is-grouped")){if(!this.isGroupedBubbleSelected(n)){const d=this.selectedMids.get(r);d&&this.getMidsFromGroupContainer(n).forEach(({mid:u})=>d.delete(u))}this.bubbles.getBubbleGroupedItems(n).map(this.toggleByElement);return}if(!this.toggleMid(r,a))return;if(n.classList.contains("grouped-item")){const d=U(n,"bubble"),h=this.isGroupedBubbleSelected(d),u=this.isGroupedMidsSelected(d);(u||h)&&this.updateElementSelection(d,u)}this.updateElementSelection(n,this.isMidSelected(r,a))},this.toggleByMid=async(n,a)=>{const r=await this.bubbles.getMountedBubble(a);r&&this.toggleByElement(r.bubble)},this.onToggleSelection=async(n,a)=>{const{needTranslateX:r,widthFrom:l,widthTo:c}=await this.chat.input.center(a);vt({element:this.listenElement,className:"is-selecting",forwards:n,duration:a?200:0,onTransitionEnd:()=>{this.isSelecting||(this.selectionInputWrapper.remove(),this.selectionInputWrapper=this.selectionContainer=this.selectionSendNowBtn=this.selectionForwardBtn=this.selectionDeleteBtn=this.selectionLeft=this.selectionRight=null,this.selectedText=void 0)}});const d=l<c?void 0:r*2;if(this.isSelecting){if(!this.selectionContainer){this.selectionInputWrapper=document.createElement("div"),this.selectionInputWrapper.classList.add("chat-input-wrapper","selection-wrapper"),this.selectionContainer=document.createElement("div"),this.selectionContainer.classList.add("selection-container");const h={listenerSetter:this.listenerSetter},u=Xe("close",{noRipple:!0});D(u,()=>this.cancelSelection(),{once:!0,listenerSetter:this.listenerSetter}),this.selectionCountEl=document.createElement("div"),this.selectionCountEl.classList.add("selection-container-count"),this.chat.type===Q.Scheduled?(this.selectionSendNowBtn=Ve("btn-primary btn-transparent btn-short text-bold selection-container-send",{icon:"send2"}),this.selectionSendNowBtn.append(_("MessageScheduleSend")),D(this.selectionSendNowBtn,()=>{J.createPopup(pw,this.chat.peerId,[...this.selectedMids.get(this.chat.peerId)],()=>{this.cancelSelection()})},h)):(this.selectionForwardBtn=Ve("btn-primary btn-transparent text-bold selection-container-forward",{icon:"forward"}),this.selectionForwardBtn.append(_("Forward")),D(this.selectionForwardBtn,()=>{const g={};for(const[f,y]of this.selectedMids)g[f]=Array.from(y).sort((v,b)=>v-b);J.createPopup(jn,g,()=>{this.cancelSelection()})},h)),this.selectionDeleteBtn=Ve("btn-primary btn-transparent danger text-bold selection-container-delete",{icon:"delete"}),this.selectionDeleteBtn.append(_("Delete")),D(this.selectionDeleteBtn,()=>{J.createPopup(jo,this.chat.peerId,this.getSelectedMids(),this.chat.type,()=>{this.cancelSelection()})},h);const p=this.selectionLeft=document.createElement("div");p.classList.add("selection-container-left"),p.append(u,this.selectionCountEl);const m=this.selectionRight=document.createElement("div");m.classList.add("selection-container-right"),m.append(...[this.selectionSendNowBtn,this.selectionForwardBtn,this.selectionDeleteBtn].filter(Boolean)),d!==void 0&&(p.style.transform=`translateX(${-d}px)`,m.style.transform=`translateX(${d}px)`),this.selectionContainer.append(p,m),this.selectionInputWrapper.style.opacity="0",this.selectionInputWrapper.append(this.selectionContainer),this.input.inputContainer.append(this.selectionInputWrapper),this.selectionInputWrapper.offsetLeft,this.selectionInputWrapper.style.opacity=""}this.selectionLeft.style.transform="",this.selectionRight.style.transform=""}else this.selectionLeft&&d!==void 0&&(this.selectionLeft.style.transform=`translateX(-${d}px)`,this.selectionRight.style.transform=`translateX(${d}px)`)},this.onUpdateContainer=(n,a,r)=>{tt(this.selectionCountEl,_("messages",[this.length()])),this.selectionSendNowBtn?.toggleAttribute("disabled",r),this.selectionForwardBtn?.toggleAttribute("disabled",n),this.selectionDeleteBtn?.toggleAttribute("disabled",a)},this.onCancelSelection=async()=>{}}appendCheckbox(e,t){t.label.classList.add("bubble-select-checkbox"),e.classList.contains("document-container")?e.querySelector(".document, audio-element").append(t.label):super.appendCheckbox(e,t)}toggleSelection(e=!0,t=!1){const s=super.toggleSelection(e,t);if(s&&e)for(const i in this.bubbles.bubbles){if(this.bubbles.skippedMids.has(+i))continue;const n=this.bubbles.bubbles[i];this.toggleElementCheckbox(n,this.isSelecting)}return s}toggleElementCheckbox(e,t){if(!this.canSelectBubble(e))return;const s=super.toggleElementCheckbox(e,t);return s&&e.classList.contains("is-grouped")&&this.bubbles.getBubbleGroupedItems(e).forEach(n=>this.toggleElementCheckbox(n,t)),s}isElementShouldBeSelected(e){const t=e.classList.contains("is-grouped");return super.isElementShouldBeSelected(e)&&(!t||this.isGroupedMidsSelected(e))}isGroupedBubbleSelected(e){return this.getCheckboxInputFromElement(e)?.checked}getMidsFromGroupContainer(e){const t=this.chat.bubbles.getBubbleGroupedItems(e);return t.length||t.push(e),t.map(s=>({mid:+s.dataset.mid,peerId:s.dataset.peerId.toPeerId()}))}isGroupedMidsSelected(e){const t=this.getMidsFromGroupContainer(e),s=t.filter(({peerId:i,mid:n})=>this.isMidSelected(i,n));return t.length===s.length}getCheckboxInputFromElement(e){return e.classList.contains("document-container")?e.querySelector("label input"):super.getCheckboxInputFromElement(e)}canSelectBubble(e){return e&&!e.classList.contains("service")&&!e.classList.contains("is-outgoing")&&!e.classList.contains("is-error")&&!e.classList.contains("bubble-first")&&!e.classList.contains("avoid-selection")}}const Xa="pinned-container";class su{constructor(e){this.floating=!1,Lt(this,e);const{divAndCaption:t,className:s}=this;t&&(t.container.classList.add(Xa,"hide"),t.title.classList.add(Xa+"-title"),t.subtitle.classList.add(Xa+"-subtitle"),t.content.classList.add(Xa+"-content")),this.btnClose=Xe(`close ${Xa+"-close"} pinned-${s}-close`,{noRipple:!0}),this.wrapper=document.createElement("div"),this.wrapper.classList.add(Xa+"-wrapper",`pinned-${s}-wrapper`),pi(this.wrapper),this.wrapperUtils=document.createElement("div"),this.wrapperUtils.classList.add(Xa+"-wrapper-utils",`pinned-${s}-wrapper-utils`),this.wrapperUtils.append(this.btnClose),this.wrapper.append(...t?Array.from(t.container.children):[],this.wrapperUtils),t&&t.container.append(this.wrapper),this.attachOnCloseEvent(this.btnClose)}attachOnCloseEvent(e){D(e,t=>{X(t),((this.onClose?this.onClose():null)||Promise.resolve(!0)).then(s=>{s&&this.toggle(!0)})},{listenerSetter:this.listenerSetter})}toggle(e){const t=this.divAndCaption.container.classList.contains("hide");if(e===void 0)e=!t;else if(e===t)return;const s=(this.floating||Fe.isMobile)&&!e;this.divAndCaption.container.classList.toggle("is-floating",s),this.divAndCaption.container.classList.toggle("hide",e),this.topbar.container.classList.toggle("is-pinned-floating",s),this.topbar.container.classList.toggle(`is-pinned-${this.className}-shown`,!e),this.topbar.setFloating(),this.topbar.setUtilsWidth()}isVisible(){return!this.divAndCaption.container.classList.contains("hide")}isFloating(){return this.divAndCaption.container.classList.contains("is-floating")}fill(e){const{message:t}=e;this.divAndCaption.container.dataset.peerId=""+t.peerId,this.divAndCaption.container.dataset.mid=""+t.mid,this.divAndCaption.fill(e),this.topbar.setUtilsWidth()}}class a_ extends su{constructor(e,t,s){super({topbar:e,chat:t,listenerSetter:e.listenerSetter,className:"audio",divAndCaption:new Yh("pinned-audio",u=>{tt(this.divAndCaption.title,u.title),tt(this.divAndCaption.subtitle,u.subtitle)}),onClose:()=>{lt.stop(void 0,!0)},floating:!0}),this.topbar=e,this.chat=t,this.managers=s,this.onPlaybackParams=u=>{this.fasterEl.classList.toggle("active",u.playbackRate>1),this.repeatEl.querySelector(".button-icon").replaceWith(Le(u.loop?"audio_repeat_single":"audio_repeat","button-icon")),this.repeatEl.classList.toggle("active",u.loop||u.round)},this.onPause=()=>{this.setPlayIcon(!0)},this.onStop=()=>{this.toggle(!0)},this.onMediaPlay=({doc:u,message:p,media:m,playbackParams:g})=>{let f,y;const v=u.type!=="voice"&&u.type!=="round";if(!v)f=new Mt({peerId:p.fromId,fromName:hn(p.fwd_from)}).element,y=Ss(p.date);else{const b=u.attributes.find(w=>w._==="documentAttributeAudio");f=Pe(b?.title??u.file_name),y=b?.performer?Pe(b.performer):_("AudioUnknownArtist")}this.fasterEl.classList.toggle("hide",v),this.repeatEl.classList.toggle("hide",!v),this.onPlaybackParams(g),this.volumeSelector.setVolume(),this.progressLine.setMedia({media:m,duration:u.duration}),this.fill({title:f,subtitle:y,message:p}),this.setPlayIcon(m.paused),this.toggle(!1)},this.divAndCaption.border.remove();const i=Xe("fast_rewind active",{noRipple:!0}),n=Xe("fast_forward active",{noRipple:!0}),a=(u,p)=>{D(u,m=>{X(m),p()},{listenerSetter:this.topbar.listenerSetter})};a(i,()=>{lt.previous()}),a(n,()=>{lt.next()}),this.toggleEl=Xe("",{noRipple:!0}),this.toggleEl.classList.add("active","pinned-audio-ico"),a(this.toggleEl,()=>{lt.toggle()}),this.wrapper.prepend(this.wrapper.firstElementChild,i,this.toggleEl,n),this.volumeSelector=new ih(this.listenerSetter,!0);const r=document.createElement("div");r.classList.add("progress-line-container"),r.append(this.volumeSelector.container);const l=document.createElement("div");l.classList.add("pinned-audio-volume-tunnel"),this.volumeSelector.btn.classList.add("pinned-audio-volume","active"),this.volumeSelector.btn.prepend(l),this.volumeSelector.btn.append(r),this.repeatEl=Xe("audio_repeat",{noRipple:!0}),a(this.repeatEl,()=>{const u=lt.getPlaybackParams();u.round?u.loop?(lt.round=!1,lt.loop=!1):lt.loop=!lt.loop:lt.round=!0});const c=this.fasterEl=Xe("playback_2x",{noRipple:!0});a(c,()=>{lt.playbackRate=c.classList.contains("active")?1:1.75}),this.wrapperUtils.prepend(this.volumeSelector.btn,c,this.repeatEl);const d=document.createElement("div");d.classList.add("pinned-audio-progress-wrapper"),this.progressLine=new qh({withTransition:!0,useTransform:!0}),this.progressLine.container.classList.add("pinned-audio-progress"),d.append(this.progressLine.container),this.wrapper.insertBefore(d,this.wrapperUtils),this.topbar.listenerSetter.add(lt)("play",this.onMediaPlay),this.topbar.listenerSetter.add(lt)("pause",this.onPause),this.topbar.listenerSetter.add(lt)("stop",this.onStop),this.topbar.listenerSetter.add(lt)("playbackParams",this.onPlaybackParams);const h=lt.getPlayingDetails();h&&(this.onMediaPlay(h),this.onPlaybackParams(h.playbackParams))}destroy(){this.progressLine&&this.progressLine.removeListeners()}setPlayIcon(e){Uo(this.toggleEl,e?"play":"pause")}}const ya=1,$u=2,Wr="pinned-message-border";class r_{constructor(){this.drawRect=(e,t,s,i,n)=>`M${e},${t+n}a${n},${n},0,0,1,${s},0v${i-2*n}a${n},${n},0,0,1,${-s},0Z`,this.getClipPath=(e,t,s)=>{let n="";if(s===2)n=this.drawRect(0,0,$u,t,1)+this.drawRect(0,t+ya*2,$u,t,1);else for(let a=0;a<s;++a)n+=this.drawRect(0,(t+ya)*a,$u,t,1);return this.clipPath||(this.clipPath=document.createElementNS("http://www.w3.org/2000/svg","clipPath"),this.path=document.createElementNS("http://www.w3.org/2000/svg","path"),this.clipPath.append(this.path)),this.clipPath.id=e,this.path.setAttributeNS(null,"d",n),this.clipPath},this.getBarHeight=(e,t)=>{let s;return e<=1?s=32:e===2?s=15:e===3?s=10:(e===4||e>3)&&(s=8),s},this.getMarkHeight=(e,t)=>{let s;return e<=1?s=32:e===2?s=15:e===3?s=10:(e===4||e>3)&&(s=8),s},this.getMarkTranslateY=(e,t,s)=>{if(s===1)return 0;if(s===2)return e?t+ya:0;if(s===3){if(e){if(e===1)return t+ya}else return 0;return t*2+ya*2+1}else return(t+ya)*e},this.getTrackTranslateY=(e,t,s,i)=>t<=4||e<=1?0:e>=t-2?i-32-s:(e-2)*s+e*ya,this.getTrackHeight=(e,t)=>e<=3?32:t*e+ya*(e-1)}render(e,t){if(this.border||(this.border=document.createElement("div"),this.border.classList.add(Wr),this.wrapper=document.createElement("div"),this.border.append(this.wrapper)),e===1)return this.count!==e&&(this.wrapper.className=Wr+"-wrapper-1",this.border.classList.remove(Wr+"-mask"),this.wrapper.replaceChildren(),this.wrapper.style.cssText=""),this.border;const s=this.getBarHeight(e,t),i=this.getMarkHeight(e,t),n=this.getTrackHeight(e,s),a=`clipPath_${e}`,r=this.getClipPath(a,s,e),l=this.getMarkTranslateY(t,s,e),c=this.getTrackTranslateY(t,e,s,n);return this.border.classList.toggle(Wr+"-mask",e>4),t<=1?(this.border.classList.add("mask-bottom"),this.border.classList.remove("mask-top")):t>=e-2?(this.border.classList.add("mask-top"),this.border.classList.remove("mask-bottom")):this.border.classList.add("mask-top","mask-bottom"),this.wrapper.className=Wr+"-wrapper",this.wrapper.style.cssText=`clip-path: url(#${a}); width: 2px; height: ${n}px; transform: translateY(-${c}px);`,this.svg||(this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttributeNS(null,"height","0"),this.svg.setAttributeNS(null,"width","0"),this.defs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.defs.append(r),this.svg.append(this.defs),this.mark=document.createElement("div"),this.mark.classList.add(Wr+"-mark")),this.svg.parentElement||this.wrapper.append(this.svg,this.mark),this.mark.style.cssText=`height: ${i}px; transform: translateY(${l}px);`,this.count=e,this.index=t,this.border}}function o_(o,e,t,s){if(Ye){let i;const n={passive:!0};s.add(o)("touchstart",l=>{if(l.touches.length>1){r();return}i=l.touches[0].clientY,s.add(o)("touchmove",a,n),s.add(o)("touchend",r,n)},n);const a=l=>{const c=l.touches[0].clientY,d=c<i;(e==="bottom"&&d||e==="top"&&!d)&&t(),i=c},r=()=>{s.removeManual(o,"touchmove",a,n),s.removeManual(o,"touchend",r,n)}}else s.add(o)("wheel",i=>{const n=i.deltaY>0;(e==="bottom"&&n||e==="top"&&!n)&&t()},{passive:!0})}const hr=class hr{constructor(){this.rows={},this.container=document.createElement("div"),this.container.className=hr.BASE_CLASS}getRow(e,t=!1){if(this.rows[e])return this.rows[e].element;const s=document.createElement("div"),i=!Object.keys(this.rows).length&&!t;return s.className=hr.BASE_CLASS+"-row"+(i?"":" is-hiding hide"),this.rows[e]={element:s,new:!0},this.container.append(s),s}clearRow(e){this.rows[e]&&(this.rows[e].element.remove(),delete this.rows[e])}clearRows(e){this.clearTimeout&&clearTimeout(this.clearTimeout),this.clearTimeout=window.setTimeout(()=>{for(const t in this.rows)+t!==e&&this.clearRow(+t)},hr.DURATION)}setNewRow(e,t=!1){const s=this.rows[e];s.new&&(t?(s.element.classList.remove("hide"),s.element.offsetLeft):s.element.classList.remove("is-hiding","hide"),delete s.new),this.clearRows(e)}animate(e,t,s=e>t,i=!1){if(e===t)return this.setNewRow(e);const n=this.rows[e],a=this.rows[t];if(!a&&!i)return this.setNewRow(e);const r=["from-top","from-bottom"];s||r.reverse(),n.element.classList.add(r[0]),n.element.classList.remove(r[1]),a&&(a.element.classList.add(r[1]),a.element.classList.remove(r[0])),n.new&&this.setNewRow(e,!0),n.element.classList.toggle("is-hiding",!1),a&&a.element.classList.toggle("is-hiding",!0),this.clearRows(e)}};hr.DURATION=200,hr.BASE_CLASS="animated-super";let Do=hr;const fn=class fn{constructor(e=!1){this.reverse=e,this.decimals=[],this.previousNumber=0,this.container=document.createElement("div"),this.container.className=fn.BASE_CLASS}getDecimal(e){if(this.decimals[e])return this.decimals[e];const t=document.createElement("div");t.className=fn.BASE_CLASS+"-decimal";const s=document.createElement("div");s.className=fn.BASE_CLASS+"-decimal-placeholder";const i=new Do;return i.container.className=fn.BASE_CLASS+"-decimal-wrapper",t.append(s,i.container),this.container.append(t),this.decimals[e]={container:t,placeholder:s,animatedSuper:i}}clear(e){this.clearTimeout&&clearTimeout(this.clearTimeout);const t=(""+e).length;t>=this.decimals.length||(this.clearTimeout=window.setTimeout(()=>{this.decimals.splice(t,this.decimals.length-t).forEach(i=>{i.container.remove()})},Do.DURATION))}hideLeft(e){const t=(""+e).length;this.decimals.slice(t).forEach(i=>{const n=+i.placeholder.innerText||0;i.animatedSuper.getRow(fn.EMPTY_INDEX,!0),i.animatedSuper.animate(fn.EMPTY_INDEX,n,this.reverse?e<this.previousNumber:e>this.previousNumber,!0)}),this.clear(e)}setCount(e){const t=Array.from(""+this.previousNumber).map(i=>+i);Array.from(""+e).map(i=>+i).forEach((i,n)=>{const a=this.getDecimal(n),r=a.animatedSuper.getRow(i,!0),l=t[n]??fn.EMPTY_INDEX;r.innerText=a.placeholder.innerText=""+i,a.animatedSuper.animate(i,l,this.reverse?e<this.previousNumber:e>this.previousNumber,!0)}),this.hideLeft(e),this.previousNumber=e}};fn.EMPTY_INDEX=-1,fn.BASE_CLASS="animated-counter";let Hp=fn;const l_=!1,Zn=class Zn{constructor(e,t,s){this.topbar=e,this.chat=t,this.managers=s,this.pinnedMaxMid=0,this.pinnedMid=0,this.pinnedIndex=-1,this.wasPinnedIndex=0,this.wasPinnedMediaIndex=0,this.locked=!1,this.waitForScrollBottom=!1,this.count=0,this.mids=[],this.offsetIndex=0,this.loading=!1,this.loadedBottom=!1,this.loadedTop=!1,this.hidden=!1,this.listenerSetter=new Qt,this.log=zs("PM"),this.debug=!0,this.isStatic=!1;const i=new kb("pinned-message");this.pinnedMessageContainer=new su({topbar:e,chat:t,listenerSetter:this.listenerSetter,className:"message",divAndCaption:i,onClose:async()=>(await s.appPeersManager.canPinMessage(this.chat.peerId)?J.createPopup(dc,this.chat.peerId,this.pinnedMid,!0):J.createPopup(dc,this.chat.peerId,0,!0),!1),floating:l_}),this.pinnedMessageBorder=new r_,i.border.replaceWith(this.pinnedMessageBorder.render(1,0)),this.animatedSubtitle=new Do,i.subtitle.append(this.animatedSubtitle.container),this.animatedMedia=new Do,this.animatedMedia.container.classList.add("pinned-message-media-container"),i.content.prepend(this.animatedMedia.container),this.animatedCounter=new Hp(!0),i.title.append(_("PinnedMessage")," ",this.animatedCounter.container);const n=this.pinnedMessageContainer.btnClose.cloneNode(!0);this.pinnedMessageContainer.attachOnCloseEvent(n),i.container.prepend(n),this.btnOpen=Xe("pinlist pinned-container-close pinned-message-pinlist",{noRipple:!0}),this.pinnedMessageContainer.wrapperUtils.prepend(this.btnOpen),D(this.btnOpen,a=>{X(a),this.topbar.openPinned(!0)},{listenerSetter:this.listenerSetter}),this.listenerSetter.add(C)("peer_pinned_messages",({peerId:a})=>{a===this.chat.peerId&&(this.hidden&&this.pinnedMessageContainer.toggle(this.hidden=!1),this.loadedTop=this.loadedBottom=!1,this.pinnedIndex=-1,this.pinnedMid=0,this.count=0,this.mids=[],this.offsetIndex=0,this.pinnedMaxMid=0,this.setCorrectIndex(0))}),this.listenerSetter.add(C)("peer_pinned_hidden",({peerId:a})=>{a===this.chat.peerId&&this.pinnedMessageContainer.toggle(this.hidden=!0)}),this.setPinnedMessage=Zs(()=>this._setPinnedMessage(),100,!0,!0),this.setCorrectIndexThrottled=$n(this.setCorrectIndex.bind(this),100,!1),this.isStatic=!this.chat.isPinnedMessagesNeeded()}destroy(){this.pinnedMessageContainer.divAndCaption.container.remove(),this.pinnedMessageContainer.toggle(!0),this.listenerSetter.removeAll(),this.unsetScrollDownListener(!1)}setCorrectIndex(e){if(this.isStatic||(this.debug&&this.log("setCorrectIndex",e),this.locked||this.hidden)||(this.loadedBottom||this.loadedTop)&&!this.count)return;const t=this.chat.bubbles.getBubbleByPoint("bottom");if(!t)return;const s=t.dataset.mid;s!==void 0&&this.testMid(+s,e)}testMid(e,t){if(this.isStatic||this.hidden)return;let s=this.mids.findIndex(n=>n<=e);if(s!==-1&&!this.isNeededMore(s))s+=this.offsetIndex;else if(this.loadedTop&&e<this.mids[this.mids.length-1])s=this.mids.length-1+this.offsetIndex;else return this.getCurrentIndexPromise??(this.getCurrentIndexPromise=this.getCurrentIndex(e,t!==void 0));if(this.pinnedIndex!==s)return this.waitForScrollBottom&&t!==void 0&&(this.pinnedIndex===0||this.pinnedIndex>s)?void 0:(this.pinnedIndex=s,this.pinnedMid=this.mids.find(n=>n<=e)||this.mids[this.mids.length-1],this.setPinnedMessage())}isNeededMore(e){return this.count>Zn.LOAD_COUNT&&(!this.loadedBottom&&e<=Zn.LOAD_OFFSET||!this.loadedTop&&this.count-1-e<=Zn.LOAD_OFFSET)}async getCurrentIndex(e,t=!0){if(!this.loading){this.loading=!0;try{const s=this.debug?this.log.bindPrefix("getCurrentIndex"):void 0;s&&s("start",e,t);let i=!1;const n=[this.managers.appMessagesManager.getHistory({peerId:this.chat.peerId,inputFilter:{_:"inputMessagesFilterPinned"},offsetId:e,limit:Zn.LOAD_COUNT,backLimit:Zn.LOAD_COUNT,threadId:this.chat.threadId,needRealOffsetIdOffset:!0}).then(c=>(i=!0,c))];if(!this.pinnedMaxMid){const c=this.managers.appMessagesManager.getPinnedMessage(this.chat.peerId,this.chat.threadId).then(d=>{d.maxId&&(this.pinnedMaxMid=d.maxId,!i&&t&&(this.mids=[this.pinnedMaxMid],this.count=d.count,this.pinnedIndex=0,this.pinnedMid=this.mids[0],this.setPinnedMessage()))});n.push(c)}const a=(await Promise.all(n))[0],r=a.history;let l=r.findIndex(c=>c<=e);l===-1&&(l=r.length),this.offsetIndex=Math.max(0,a.offsetIdOffset)?a.offsetIdOffset-l:0,this.mids=r.slice(),this.count=a.count,this.count||this.pinnedMessageContainer.toggle(!0),this.loadedTop=this.offsetIndex+this.mids.length===this.count,this.loadedBottom=!this.offsetIndex,s&&s("result",e,a,l,this.offsetIndex,this.loadedTop,this.loadedBottom)}catch(s){this.log.error("getCurrentIndex error",s)}this.loading=!1,this.locked?this.testMid(e):t&&this.setCorrectIndex(0),this.getCurrentIndexPromise=void 0}}setScrollDownListener(){this.waitForScrollBottom=!0,this.scrollDownListenerSetter||(this.scrollDownListenerSetter=new Qt,o_(this.chat.bubbles.scrollable.container,"bottom",()=>{this.unsetScrollDownListener()},this.scrollDownListenerSetter))}unsetScrollDownListener(e=!0){this.waitForScrollBottom=!1,this.scrollDownListenerSetter&&(this.scrollDownListenerSetter.removeAll(),this.scrollDownListenerSetter=void 0),e&&this.setCorrectIndex(0)}async handleFollowingPinnedMessage(){this.locked=!0,this.debug&&this.log("handleFollowingPinnedMessage");try{this.setScrollDownListener();const e=this.chat.setPeerPromise;e instanceof Promise&&await e,await xs(),this.getCurrentIndexPromise&&await this.getCurrentIndexPromise,this.debug&&this.log("handleFollowingPinnedMessage: unlock"),this.locked=!1}catch(e){this.log.error("handleFollowingPinnedMessage error:",e),this.locked=!1,this.waitForScrollBottom=!1,this.setCorrectIndex(0)}}followPinnedMessage(e){this.chat.getMessage(e)&&(this.chat.setMessageId({lastMsgId:e}),(this.chat.setPeerPromise||Promise.resolve()).then(()=>{this.handleFollowingPinnedMessage(),this.testMid(this.pinnedIndex>=this.count-1?this.pinnedMaxMid:e-1)}))}async _setPinnedMessage(){const e=this.count;if(e){const t=this.pinnedIndex,s=this.chat.getMessage(this.pinnedMid),i=t===0;this.animatedCounter.container.classList.toggle("is-last",i),i||this.animatedCounter.setCount(e-t),this.pinnedMessageContainer.toggle(!1);const n=t>this.wasPinnedIndex;this.debug&&this.log("setPinnedMessage: fromTop",n,t,this.wasPinnedIndex);const a=this.animatedSubtitle.getRow(t),r=this.animatedMedia.getRow(t);r.classList.add("pinned-message-media");const l=[],c=await ig({titleEl:null,subtitleEl:a,message:s,mediaEl:r,loadPromises:l,animationGroup:this.chat.animationGroup,textColor:"primary-text-color"});await Promise.all(l),this.pinnedMessageContainer.divAndCaption.container.classList.toggle("is-media",c),this.animatedSubtitle.animate(t,this.wasPinnedIndex),c?(this.animatedMedia.animate(t,this.wasPinnedMediaIndex),this.wasPinnedMediaIndex=t):this.animatedMedia.clearRows(),this.pinnedMessageBorder.render(e,e-t-1),this.wasPinnedIndex=t,this.pinnedMessageContainer.divAndCaption.container.dataset.mid=""+s.mid}else this.pinnedMessageContainer.toggle(!0),this.wasPinnedIndex=0;this.pinnedMessageContainer.divAndCaption.container.classList.toggle("is-many",this.count>1)}};Zn.LOAD_COUNT=50,Zn.LOAD_OFFSET=5;let hh=Zn;const c_="assets/audio/";class Sw{constructor(e){this.assets=e,this.tempId=0}playSound(e,t=!1){++this.tempId,this.assetName=e;try{const s=this.createAudio();s.autoplay=!0,s.src=c_+e,s.loop=t,Pi(s)}catch(s){console.error("playSound",e,s)}}playSoundIfDifferent(e,t){this.assetName!==e&&this.playSound(e,t)}createAudio(){let{audio:e}=this;return e||(e=this.audio=new Audio,Pi(e),e)}stopSound(){this.audio&&this.audio.pause()}cancelDelayedPlay(){++this.tempId}playSoundWithTimeout(e,t,s){const i=++this.tempId;setTimeout(()=>{this.tempId===i&&this.playSound(e,t)},s)}}let d_;function h_(){return d_??(d_=new Sw(["group_call_connect.mp3","group_call_end.mp3","group_call_start.mp3","voip_onallowtalk.mp3"]))}function u_(o){return(!!navigator?.mediaDevices?.getSupportedConstraints())[o]}function Cw(){const o={channelCount:2};return["noiseSuppression","echoCancellation","autoGainControl"].forEach(t=>{u_(t)&&(o[t]=!0)}),o}function Iw(o){const e={video:{width:{max:1920},height:{max:1080},frameRate:{max:30}}};return o||(e.audio=!0),e}async function Lw(o){const e=await navigator.mediaDevices.getDisplayMedia(o),t=e.getVideoTracks()[0];return t.contentHint="text",e}async function iu(o,e){const t=await navigator.mediaDevices.getUserMedia(o);return t.getTracks().forEach(s=>{s.enabled=!e}),t}window.getStream=iu;function Mw(){const o={main:{},screen:{}};return async e=>{const{isScreen:t,constraints:s}=e,i=o[t?"screen":"main"];let n=i[s.audio?"audio":"video"];n||(n=(t?Lw:iu)(s,e.muted),s.audio&&!i.audio&&(i.audio=n.finally(()=>i.audio=void 0)),s.video&&!i.video&&(i.video=n.finally(()=>i.video=void 0)));try{return await n}catch(a){throw a}}}window.getStreamCached=Mw;function cg(){return{width:{min:1280,max:1920},height:{min:720,max:1080},frameRate:{min:24,max:30}}}function nu(o){o.stop(),Mh(o,"ended")}const p_=50,Pw=100;class Vp{constructor(e=`\r
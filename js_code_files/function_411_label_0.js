mxConstants.STYLE_STROKECOLOR,mxUtils.getValue(K,mxConstants.STYLE_STROKECOLOR,"#000"));"default"==K&&(K=b.shapeForegroundColor);return K};this.createStyle=function(K){var M=";fillColor=none;";D&&(M=";lineShape=1;");return mxConstants.STYLE_SHAPE+"="+K+M};this.stopDrawing=function(){if(0<l.length){if(D){for(var K=[],M=0;M<t.length;M++)null!=t[M]&&K.push([t[M].x,t[M].y]);K=PerfectFreehand.getStroke(K,u);t=[];for(M=0;M<K.length;M++)t.push({x:K[M][0],y:K[M][1]});t.push(null)}K=t[0].x;var H=t[0].x,N=
t[0].y,P=t[0].y;for(M=1;M<t.length;M++)null!=t[M]&&(K=Math.max(K,t[M].x),H=Math.min(H,t[M].x),N=Math.max(N,t[M].y),P=Math.min(P,t[M].y));K-=H;N-=P;if(0<K&&0<N){var O=100/K,V=100/N;t.map(function(S){if(null==S)return S;S.x=(S.x-H)*O;S.y=(S.y-P)*V;return S});var p='<shape strokewidth="inherit"><foreground>',B=0;for(M=0;M<t.length;M++){var L=t[M];if(null==L){L=!1;B=t[B];var Q=t[M-1];!C&&z&&(L=B.x-Q.x,Q=B.y-Q.y,L=Math.sqrt(L*L+Q*Q)<=b.tolerance);if(C||L)p+='<line x="'+B.x.toFixed(2)+'" y="'+B.y.toFixed(2)+
'"/>';p+="</path>"+(d||C||L?"<fillstroke/>":"<stroke/>");B=M+1}else p=M==B?p+('<path><move x="'+L.x.toFixed(2)+'" y="'+L.y.toFixed(2)+'"/>'):p+('<line x="'+L.x.toFixed(2)+'" y="'+L.y.toFixed(2)+'"/>')}p+="</foreground></shape>";if(b.isEnabled()&&!b.isCellLocked(b.getDefaultParent())){M=this.createStyle("stencil("+Graph.compress(p)+")");p=b.view.scale;B=b.view.translate;M=new mxCell("",new mxGeometry(H/p-B.x,P/p-B.y,K/p,N/p),M);M.vertex=1;b.model.beginUpdate();try{M=b.addCell(M),b.fireEvent(new mxEventObject("cellsInserted",
"cells",[M])),b.fireEvent(new mxEventObject("freehandInserted","cell",M))}finally{b.model.endUpdate()}x&&b.setSelectionCells([M])}}for(M=0;M<l.length;M++)l[M].parentNode.removeChild(l[M]);c=null;l=[];t=[]}F(!1)};b.addListener(mxEvent.FIRE_MOUSE_EVENT,mxUtils.bind(this,function(K,M){K=M.getProperty("eventName");M=M.getProperty("event");K==mxEvent.MOUSE_MOVE&&k&&(null!=M.sourceState&&M.sourceState.setCursor("crosshair"),M.consume())}));b.addMouseListener({mouseDown:mxUtils.bind(this,function(K,M){if(b.isEnabled()&&
!b.isCellLocked(b.getDefaultParent())&&(K=M.getEvent(),k&&!mxEvent.isPopupTrigger(K)&&!mxEvent.isMultiTouchEvent(K))){var H=parseFloat(b.currentVertexStyle[mxConstants.STYLE_STROKEWIDTH]||1);H=Math.max(1,H*b.view.scale);var N=U();c=document.createElementNS("http://www.w3.org/2000/svg","path");c.setAttribute("fill",D?N:"none");c.setAttribute("stroke",N);c.setAttribute("stroke-width",H);"1"==b.currentVertexStyle[mxConstants.STYLE_DASHED]&&(N=b.currentVertexStyle[mxConstants.STYLE_DASH_PATTERN]||"3 3",
N=N.split(" ").map(function(P){return parseFloat(P)*H}).join(" "),c.setAttribute("stroke-dasharray",N));g=[];K=q(K);v(K);m="M"+K.x+" "+K.y;t.push(K);y=[];c.setAttribute("d",D?PerfectFreehand.getSvgPathFromStroke([[K.x,K.y]],u):m);e.appendChild(c);M.consume()}}),mouseMove:mxUtils.bind(this,function(K,M){if(c&&b.isEnabled()&&!b.isCellLocked(b.getDefaultParent())){K=M.getEvent();K=q(K);v(K);var H=E(0);if(H)if(t.push(H),D){var N=[];for(H=0;H<t.length;H++)N.push([t[H].x,t[H].y]);y=[];for(var P=2;P<g.length;P+=
2)H=E(P),N.push([H.x,H.y]),y.push(H);c.setAttribute("d",PerfectFreehand.getSvgPathFromStroke(N,u))}else{m+=" L"+H.x+" "+H.y;N="";y=[];for(P=2;P<g.length;P+=2)H=E(P),N+=" L"+H.x+" "+H.y,y.push(H);c.setAttribute("d",m+N)}J&&(H=b.view.translate,b.scrollRectToVisible((new mxRectangle(K.x-H.x,K.y-H.y)).grow(20)));M.consume()}}),mouseUp:mxUtils.bind(this,function(K,M){c&&b.isEnabled()&&!b.isCellLocked(b.getDefaultParent())&&(I(M.getEvent()),M.consume())})});var q=function(K){return mxUtils.convertPoint(b.container,
mxEvent.getClientX(K),mxEvent.getClientY(K))},v=function(K){for(g.push(K);g.length>f;)g.shift()},E=function(K){var M=g.length;if(1===M%2||M>=f){var H=0,N=0,P,O=0;for(P=K;P<M;P++)O++,K=g[P],H+=K.x,N+=K.y;return{x:H/O,y:N/O}}return null}}}mxFreehand.prototype.NO_SMOOTHING=1;mxFreehand.prototype.MILD_SMOOTHING=4;mxFreehand.prototype.NORMAL_SMOOTHING=8;mxFreehand.prototype.VERY_SMOOTH_SMOOTHING=12;mxFreehand.prototype.SUPER_SMOOTH_SMOOTHING=16;mxFreehand.prototype.HYPER_SMOOTH_SMOOTHING=20;function P2PCollab(b,e,f){function c(O,V){try{if(!E){var p=e.file.getCurrentUser();if(v&&null!=p&&null!=p.displayName){var B={from:I,id:n,type:O,sessionId:e.clientId,userId:p.id,username:p.displayName,data:V,protocol:DrawioFileSync.PROTOCOL,editor:EditorUi.VERSION};B={bytes:e.objectToString(B),data:"aes"};B=JSON.stringify(B);K&&"cursor"!=O&&EditorUi.debug("P2PCollab: sending to socket server",[B]);n++;O=!K&&("cursor"==O||"selectionChange"==O);q&&!O&&P("message",B);if(O)for(p2pId in U)U[p2pId].send(B)}}}catch(L){null!=
`:""}).join("")}static onDownloadClick(e,t){if(Array.isArray(e))return e.map(s=>this.onDownloadClick(s));if(this.canDownload(e,void 0,t))return as.downloadToDisc({media:Hs(e,!0)})}}const i_=window.matchMedia("(display-mode: standalone)").matches,Jf=o=>[...o.values()].reduce((e,t)=>e+t.size,0);class Sw extends vi{constructor(e){super(!1),this.selectedMids=new Map,this.isSelecting=!1,this.onMouseDown=t=>{const s=U(t.target,this.targetLookupClassName);if(t.button!==0||this.verifyTarget&&!this.verifyTarget(t,s))return;const i=new Map;let n,a=s;const r=(u,p=!0)=>{const m=+u.dataset.mid;if(!m||!u.dataset.peerId)return;const g=u.dataset.peerId.toPeerId();Bn(a)||(a=u);let f=i.get(g);if(f||i.set(g,f=new Set),f.has(m))return;const y=this.isMidSelected(g,m);if(n===void 0&&(n=!y),f.add(m),n&&!y||!n&&y){const v=Jf(i);if(this.toggleByElement&&p){v<2&&Vs(u,a)&&(a=u);const b=this.getElementsBetween(a,u);b.length&&b.forEach(w=>{r(w,!1)})}if(this.selectedMids.size)this.toggleByElement&&this.toggleByElement(u);else if(v===2&&this.toggleByMid)for(const[b,w]of i)for(const S of w)this.toggleByMid(b,S)}};let l=!1;const c=u=>{l||(rr(),l=!0,document.body.classList.add("no-select"));const p=this.getElementFromTarget(u.target);if(p){if(this.verifyMouseMoveTarget&&!this.verifyMouseMoveTarget(u,p,n)){this.listenerSetter.removeManual(this.listenElement,"mousemove",c),this.listenerSetter.removeManual(document,"mouseup",d,h);return}r(p)}},d=u=>{document.body.classList.remove("no-select"),i.size&&D(window,X,{capture:!0,once:!0,passive:!1}),this.listenerSetter.removeManual(this.listenElement,"mousemove",c),rr()},h={once:!0};this.listenerSetter.add(this.listenElement)("mousemove",c),this.listenerSetter.add(document)("mouseup",d,h)},this.getElementsBetween=(t,s)=>{if(t===s)return[];const i=t.getBoundingClientRect(),n=s.getBoundingClientRect(),r=(i.top-n.top||i.left-n.left)<0,l=U(t,this.lookupBetweenParentClassName);if(!l)return[];const c=Array.from(l.querySelectorAll(this.lookupBetweenElementsQuery));let d=c.indexOf(t),h=c.indexOf(s);return r||([h,d]=[d,h]),c.slice(d+1,h)},this.cancelSelection=t=>{t&&(this.doNotAnimate=!0),this.onCancelSelection?.(),this.selectedMids.clear(),this.toggleSelection(),rr(),t&&(this.doNotAnimate=void 0)},Lt(this,e),this.navigationType="multiselect-"+Dc()}attachListeners(e,t){if(this.listenElement&&this.listenerSetter.removeAll(),this.listenElement=e,this.listenerSetter=t,!!e){if(Ye){t.add(e)("touchend",()=>{this.isSelecting&&(this.selectedText=cw())}),ua({element:e,callback:s=>{if(this.isSelecting||this.verifyTouchLongPress&&!this.verifyTouchLongPress())return;this.onTouchLongPress?.(s),document.body.classList.add("no-select"),e.addEventListener("touchend",n=>{X(n),document.body.classList.remove("no-select")},{once:!0,capture:!0}),Vn&&i_&&e.addEventListener("mousedown",X,{once:!0,capture:!0}),rr(),X(s);const i=this.getElementFromTarget(s.target);i&&this.toggleByElement(i)},listenerSetter:t});return}t.add(e)("mousedown",this.onMouseDown)}}isElementShouldBeSelected(e){return this.isMidSelected(e.dataset.peerId.toPeerId(),+e.dataset.mid)}appendCheckbox(e,t){e.prepend(t.label)}toggleElementCheckbox(e,t){const s=!!this.getCheckboxInputFromElement(e);if(t){if(s)return!1;const i=new ct({name:e.dataset.mid,round:!0});this.isSelecting&&this.isElementShouldBeSelected(e)&&(i.input.checked=!0,e.classList.add("is-selected")),this.appendCheckbox(e,i)}else s&&(this.getCheckboxInputFromElement(e).parentElement.remove(),vt({element:e,className:"is-selected",forwards:!1,duration:200}));return!0}getCheckboxInputFromElement(e){return e.firstElementChild?.tagName==="LABEL"&&e.firstElementChild.firstElementChild}async updateContainer(e=!1){const t=this.selectedMids.size;if(!t&&!e)return;let s=!t,i=!t,n=!t,a=!t;if(this.isStories){s=!0,n=!0;const r=this.selectedMids.keys().next().value,l=await this.managers.appStoriesManager.cantPinDeleteStories(r,Array.from(this.selectedMids.get(r)));a=l.cantPin,i=l.cantDelete}else for(const[r,l]of this.selectedMids){const c=this.getStorageKey(r),d=await this.managers.appMessagesManager.cantForwardDeleteMids(c,Array.from(l));if(s=d.cantForward,i=d.cantDelete,s&&i)break}this.onUpdateContainer?.(s,i,n,a)}getStorageKey(e){return`${e}_${this.isScheduled?"scheduled":"history"}`}getSelectedMids(){return Na([...this.selectedMids.values()].map(e=>[...e])).sort((e,t)=>e-t)}getSelectedMessages(){const e=[];return this.selectedMids.forEach((t,s)=>{const i=this.getStorageKey(s),n=Array.from(t).map(a=>this.managers.appMessagesManager.getMessageFromStorage(i,a));e.push(...n)}),Promise.all(e)}toggleSelection(e=!0,t=!1){const s=this.isSelecting,i=this.selectedMids.size;if(this.isSelecting=!!i||t,s===this.isSelecting)return!1;this.dispatchEvent("toggle",this.isSelecting),Ye||(this.listenElement.classList.toggle("no-select",this.isSelecting),s&&rr()),un();const n=!!i||t,a=this.onToggleSelection?.(n,!this.doNotAnimate);return Vn||(n?dt.pushItem({type:this.navigationType,onPop:()=>{this.cancelSelection()}}):dt.removeByType(this.navigationType)),t&&(a||Promise.resolve()).then(()=>this.updateContainer(t)),!0}cleanup(){this.doNotAnimate=!0,this.selectedMids.clear(),this.toggleSelection(!1),this.doNotAnimate=void 0}updateElementSelection(e,t){this.toggleElementCheckbox(e,!0);const s=this.getCheckboxInputFromElement(e);s.checked=t,this.toggleSelection(),this.updateContainer(),vt({element:e,className:"is-selected",forwards:t,duration:200})}isMidSelected(e,t){return!!this.selectedMids.get(e)?.has(t)}length(){return Jf(this.selectedMids)}toggleMid(e,t,s){let i=this.selectedMids.get(e);return s||s===void 0&&i?.has(t)?i&&(i.delete(t),i.size||this.selectedMids.delete(e)):(i||(i=new Set,this.selectedMids.set(e,i)),i.add(t)),!0}deleteSelectedMids(e,t){const s=this.selectedMids.get(e);s&&(t.forEach(i=>{s.delete(i)}),s.size||this.selectedMids.delete(e),this.updateContainer(),this.toggleSelection())}}class n_ extends Sw{constructor(e,t,s){super({managers:t,verifyTarget:(i,n)=>!!n&&this.isSelecting,getElementFromTarget:i=>U(i,"search-super-item"),targetLookupClassName:"search-super-item",lookupBetweenParentClassName:"tabs-tab",lookupBetweenElementsQuery:".search-super-item"}),this.searchSuper=e,this.toggleByElement=i=>{const n=+i.dataset.mid,a=i.dataset.peerId.toPeerId();this.toggleMid(a,n)&&this.updateElementSelection(i,this.isMidSelected(a,n))},this.toggleByMid=(i,n)=>{const a=this.searchSuper.mediaTab.contentTab.querySelector(`.search-super-item[data-peer-id="${i}"][data-mid="${n}"]`);this.toggleByElement(a)},this.onDeleteStoriesClick=async i=>{const n=[...this.selectedMids.keys()][0];i||(i=[...this.selectedMids.get(n)]),await ft({titleLangKey:i.length===1?"DeleteStoryTitle":"DeleteStoriesTitle",descriptionLangKey:i.length===1?"DeleteStorySubtitle":"DeleteStoriesSubtitle",descriptionLangArgs:[i.length],button:{langKey:"Delete",isDanger:!0}}),this.cancelSelection(),this.managers.appStoriesManager.deleteStories(n,i)},this.onPinClick=(i,n)=>{const a=[...this.selectedMids.keys()][0];i||(i=[...this.selectedMids.get(a)]);const r=this.managers.appStoriesManager.togglePinned(a,i,n);this.cancelSelection(),r.then(()=>{i.length===1?Re({langPackKey:n?"StoryPinnedToProfile":"StoryArchivedFromProfile"}):Re({langPackKey:n?"StorySavedTitle":"StoryArchived",langPackArguments:[i.length]})})},this.onUpdateContainer=(i,n,a,r)=>{const l=this.length();tt(this.selectionCountEl,_(this.isStories?"StoriesCount":"messages",[l])),this.selectionPinBtn.classList.toggle("hide",!this.isStories||r),this.selectionGotoBtn.classList.toggle("hide",this.isStories||l!==1),this.selectionForwardBtn.classList.toggle("hide",i),this.selectionDeleteBtn&&this.selectionDeleteBtn.classList.toggle("hide",n)},this.onToggleSelection=(i,n)=>{if(vt({element:this.searchSuper.navScrollableContainer,className:"is-selecting",forwards:i,duration:n?200:0,onTransitionEnd:()=>{this.isSelecting||(this.selectionContainer.remove(),this.selectionContainer=this.selectionForwardBtn=this.selectionDeleteBtn=null,this.selectedText=void 0)}}),vt({element:this.searchSuper.container,className:"is-selecting",forwards:i,duration:200}),this.isSelecting&&!this.selectionContainer){const a="search-super-selection";this.selectionContainer=document.createElement("div"),this.selectionContainer.classList.add(a+"-container");const r=Xe(`close ${a}-cancel`,{noRipple:!0});D(r,()=>this.cancelSelection(),{listenerSetter:this.listenerSetter,once:!0}),this.selectionCountEl=document.createElement("div"),this.selectionCountEl.classList.add(a+"-count");const l={listenerSetter:this.listenerSetter};this.selectionPinBtn=Xe(`${this.isStoriesArchive?"pin":"unpin"} ${a}-pin`),D(this.selectionPinBtn,()=>this.onPinClick(void 0,this.isStoriesArchive),l),this.selectionGotoBtn=Xe(`message ${a}-goto`),D(this.selectionGotoBtn,()=>{const d=[...this.selectedMids.keys()][0],h=[...this.selectedMids.get(d)][0];this.cancelSelection(),ce.setInnerPeer({peerId:d,lastMsgId:h,threadId:this.searchSuper.mediaTab.type==="saved"?this.searchSuper.searchContext.peerId:this.searchSuper.searchContext.threadId})},l),this.selectionForwardBtn=Xe(`forward ${a}-forward`),D(this.selectionForwardBtn,()=>{const d={};for(const[h,u]of this.selectedMids)d[h]=Array.from(u).sort((p,m)=>p-m);J.createPopup(jn,d,()=>{this.cancelSelection()})},l),this.isPrivate&&(this.selectionDeleteBtn=Xe(`delete danger ${a}-delete`),D(this.selectionDeleteBtn,()=>{if(this.isStories){this.onDeleteStoriesClick();return}const d=this.searchSuper.searchContext.peerId;J.createPopup(jo,d,this.getSelectedMids(),Q.Chat,()=>{this.cancelSelection()})},l)),this.selectionContainer.append(...[r,this.selectionCountEl,this.selectionPinBtn,this.selectionGotoBtn,this.selectionForwardBtn,this.selectionDeleteBtn].filter(Boolean));const c=this.selectionContainer;c.style.opacity="0",this.searchSuper.navScrollableContainer.append(c),c.offsetLeft,c.style.opacity=""}},this.isPrivate=!e.showSender,this.attachListeners(e.container,s)}toggleSelection(e=!0,t=!1){const s=super.toggleSelection(e,t);return s&&e&&Array.from(this.searchSuper.tabsContainer.querySelectorAll(".search-super-item")).forEach(n=>{this.toggleElementCheckbox(n,this.isSelecting)}),s}}class a_ extends Sw{constructor(e,t,s,i){super({managers:i,getElementFromTarget:n=>U(n,"grouped-item")||U(n,"bubble"),verifyTarget:(n,a)=>!(!this.selectedMids.size&&!n.target.classList.contains("bubble")&&!n.target.classList.contains("document-selection")&&a),verifyMouseMoveTarget:(n,a,r)=>!(n.target!==a&&!n.target.classList.contains("document-selection")&&r===void 0&&!this.selectedMids.size),verifyTouchLongPress:()=>!this.chat.input.recording,targetLookupClassName:"bubble",lookupBetweenParentClassName:"bubbles-inner",lookupBetweenElementsQuery:".bubble:not(.is-multiple-documents), .grouped-item",onTouchLongPress:()=>{const{replySwipeHandler:n}=this.chat.bubbles;n?.reset()}}),this.chat=e,this.bubbles=t,this.input=s,this.toggleByElement=n=>{if(!this.canSelectBubble(n))return;const a=+n.dataset.mid,r=n.dataset.peerId.toPeerId();if(n.classList.contains("is-grouped")){if(!this.isGroupedBubbleSelected(n)){const d=this.selectedMids.get(r);d&&this.getMidsFromGroupContainer(n).forEach(({mid:u})=>d.delete(u))}this.bubbles.getBubbleGroupedItems(n).map(this.toggleByElement);return}if(!this.toggleMid(r,a))return;if(n.classList.contains("grouped-item")){const d=U(n,"bubble"),h=this.isGroupedBubbleSelected(d),u=this.isGroupedMidsSelected(d);(u||h)&&this.updateElementSelection(d,u)}this.updateElementSelection(n,this.isMidSelected(r,a))},this.toggleByMid=async(n,a)=>{const r=await this.bubbles.getMountedBubble(a);r&&this.toggleByElement(r.bubble)},this.onToggleSelection=async(n,a)=>{const{needTranslateX:r,widthFrom:l,widthTo:c}=await this.chat.input.center(a);vt({element:this.listenElement,className:"is-selecting",forwards:n,duration:a?200:0,onTransitionEnd:()=>{this.isSelecting||(this.selectionInputWrapper.remove(),this.selectionInputWrapper=this.selectionContainer=this.selectionSendNowBtn=this.selectionForwardBtn=this.selectionDeleteBtn=this.selectionLeft=this.selectionRight=null,this.selectedText=void 0)}});const d=l<c?void 0:r*2;if(this.isSelecting){if(!this.selectionContainer){this.selectionInputWrapper=document.createElement("div"),this.selectionInputWrapper.classList.add("chat-input-wrapper","selection-wrapper"),this.selectionContainer=document.createElement("div"),this.selectionContainer.classList.add("selection-container");const h={listenerSetter:this.listenerSetter},u=Xe("close",{noRipple:!0});D(u,()=>this.cancelSelection(),{once:!0,listenerSetter:this.listenerSetter}),this.selectionCountEl=document.createElement("div"),this.selectionCountEl.classList.add("selection-container-count"),this.chat.type===Q.Scheduled?(this.selectionSendNowBtn=Ve("btn-primary btn-transparent btn-short text-bold selection-container-send",{icon:"send2"}),this.selectionSendNowBtn.append(_("MessageScheduleSend")),D(this.selectionSendNowBtn,()=>{J.createPopup(mw,this.chat.peerId,[...this.selectedMids.get(this.chat.peerId)],()=>{this.cancelSelection()})},h)):(this.selectionForwardBtn=Ve("btn-primary btn-transparent text-bold selection-container-forward",{icon:"forward"}),this.selectionForwardBtn.append(_("Forward")),D(this.selectionForwardBtn,()=>{const g={};for(const[f,y]of this.selectedMids)g[f]=Array.from(y).sort((v,b)=>v-b);J.createPopup(jn,g,()=>{this.cancelSelection()})},h)),this.selectionDeleteBtn=Ve("btn-primary btn-transparent danger text-bold selection-container-delete",{icon:"delete"}),this.selectionDeleteBtn.append(_("Delete")),D(this.selectionDeleteBtn,()=>{J.createPopup(jo,this.chat.peerId,this.getSelectedMids(),this.chat.type,()=>{this.cancelSelection()})},h);const p=this.selectionLeft=document.createElement("div");p.classList.add("selection-container-left"),p.append(u,this.selectionCountEl);const m=this.selectionRight=document.createElement("div");m.classList.add("selection-container-right"),m.append(...[this.selectionSendNowBtn,this.selectionForwardBtn,this.selectionDeleteBtn].filter(Boolean)),d!==void 0&&(p.style.transform=`translateX(${-d}px)`,m.style.transform=`translateX(${d}px)`),this.selectionContainer.append(p,m),this.selectionInputWrapper.style.opacity="0",this.selectionInputWrapper.append(this.selectionContainer),this.input.inputContainer.append(this.selectionInputWrapper),this.selectionInputWrapper.offsetLeft,this.selectionInputWrapper.style.opacity=""}this.selectionLeft.style.transform="",this.selectionRight.style.transform=""}else this.selectionLeft&&d!==void 0&&(this.selectionLeft.style.transform=`translateX(-${d}px)`,this.selectionRight.style.transform=`translateX(${d}px)`)},this.onUpdateContainer=(n,a,r)=>{tt(this.selectionCountEl,_("messages",[this.length()])),this.selectionSendNowBtn?.toggleAttribute("disabled",r),this.selectionForwardBtn?.toggleAttribute("disabled",n),this.selectionDeleteBtn?.toggleAttribute("disabled",a)},this.onCancelSelection=async()=>{}}appendCheckbox(e,t){t.label.classList.add("bubble-select-checkbox"),e.classList.contains("document-container")?e.querySelector(".document, audio-element").append(t.label):super.appendCheckbox(e,t)}toggleSelection(e=!0,t=!1){const s=super.toggleSelection(e,t);if(s&&e)for(const i in this.bubbles.bubbles){if(this.bubbles.skippedMids.has(+i))continue;const n=this.bubbles.bubbles[i];this.toggleElementCheckbox(n,this.isSelecting)}return s}toggleElementCheckbox(e,t){if(!this.canSelectBubble(e))return;const s=super.toggleElementCheckbox(e,t);return s&&e.classList.contains("is-grouped")&&this.bubbles.getBubbleGroupedItems(e).forEach(n=>this.toggleElementCheckbox(n,t)),s}isElementShouldBeSelected(e){const t=e.classList.contains("is-grouped");return super.isElementShouldBeSelected(e)&&(!t||this.isGroupedMidsSelected(e))}isGroupedBubbleSelected(e){return this.getCheckboxInputFromElement(e)?.checked}getMidsFromGroupContainer(e){const t=this.chat.bubbles.getBubbleGroupedItems(e);return t.length||t.push(e),t.map(s=>({mid:+s.dataset.mid,peerId:s.dataset.peerId.toPeerId()}))}isGroupedMidsSelected(e){const t=this.getMidsFromGroupContainer(e),s=t.filter(({peerId:i,mid:n})=>this.isMidSelected(i,n));return t.length===s.length}getCheckboxInputFromElement(e){return e.classList.contains("document-container")?e.querySelector("label input"):super.getCheckboxInputFromElement(e)}canSelectBubble(e){return e&&!e.classList.contains("service")&&!e.classList.contains("is-outgoing")&&!e.classList.contains("is-error")&&!e.classList.contains("bubble-first")&&!e.classList.contains("avoid-selection")}}const Xa="pinned-container";class su{constructor(e){this.floating=!1,Lt(this,e);const{divAndCaption:t,className:s}=this;t&&(t.container.classList.add(Xa,"hide"),t.title.classList.add(Xa+"-title"),t.subtitle.classList.add(Xa+"-subtitle"),t.content.classList.add(Xa+"-content")),this.btnClose=Xe(`close ${Xa+"-close"} pinned-${s}-close`,{noRipple:!0}),this.wrapper=document.createElement("div"),this.wrapper.classList.add(Xa+"-wrapper",`pinned-${s}-wrapper`),pi(this.wrapper),this.wrapperUtils=document.createElement("div"),this.wrapperUtils.classList.add(Xa+"-wrapper-utils",`pinned-${s}-wrapper-utils`),this.wrapperUtils.append(this.btnClose),this.wrapper.append(...t?Array.from(t.container.children):[],this.wrapperUtils),t&&t.container.append(this.wrapper),this.attachOnCloseEvent(this.btnClose)}attachOnCloseEvent(e){D(e,t=>{X(t),((this.onClose?this.onClose():null)||Promise.resolve(!0)).then(s=>{s&&this.toggle(!0)})},{listenerSetter:this.listenerSetter})}toggle(e){const t=this.divAndCaption.container.classList.contains("hide");if(e===void 0)e=!t;else if(e===t)return;const s=(this.floating||Fe.isMobile)&&!e;this.divAndCaption.container.classList.toggle("is-floating",s),this.divAndCaption.container.classList.toggle("hide",e),this.topbar.container.classList.toggle("is-pinned-floating",s),this.topbar.container.classList.toggle(`is-pinned-${this.className}-shown`,!e),this.topbar.setFloating(),this.topbar.setUtilsWidth()}isVisible(){return!this.divAndCaption.container.classList.contains("hide")}isFloating(){return this.divAndCaption.container.classList.contains("is-floating")}fill(e){const{message:t}=e;this.divAndCaption.container.dataset.peerId=""+t.peerId,this.divAndCaption.container.dataset.mid=""+t.mid,this.divAndCaption.fill(e),this.topbar.setUtilsWidth()}}class r_ extends su{constructor(e,t,s){super({topbar:e,chat:t,listenerSetter:e.listenerSetter,className:"audio",divAndCaption:new Yh("pinned-audio",u=>{tt(this.divAndCaption.title,u.title),tt(this.divAndCaption.subtitle,u.subtitle)}),onClose:()=>{lt.stop(void 0,!0)},floating:!0}),this.topbar=e,this.chat=t,this.managers=s,this.onPlaybackParams=u=>{this.fasterEl.classList.toggle("active",u.playbackRate>1),this.repeatEl.querySelector(".button-icon").replaceWith(Le(u.loop?"audio_repeat_single":"audio_repeat","button-icon")),this.repeatEl.classList.toggle("active",u.loop||u.round)},this.onPause=()=>{this.setPlayIcon(!0)},this.onStop=()=>{this.toggle(!0)},this.onMediaPlay=({doc:u,message:p,media:m,playbackParams:g})=>{let f,y;const v=u.type!=="voice"&&u.type!=="round";if(!v)f=new Mt({peerId:p.fromId,fromName:hn(p.fwd_from)}).element,y=Ss(p.date);else{const b=u.attributes.find(w=>w._==="documentAttributeAudio");f=Pe(b?.title??u.file_name),y=b?.performer?Pe(b.performer):_("AudioUnknownArtist")}this.fasterEl.classList.toggle("hide",v),this.repeatEl.classList.toggle("hide",!v),this.onPlaybackParams(g),this.volumeSelector.setVolume(),this.progressLine.setMedia({media:m,duration:u.duration}),this.fill({title:f,subtitle:y,message:p}),this.setPlayIcon(m.paused),this.toggle(!1)},this.divAndCaption.border.remove();const i=Xe("fast_rewind active",{noRipple:!0}),n=Xe("fast_forward active",{noRipple:!0}),a=(u,p)=>{D(u,m=>{X(m),p()},{listenerSetter:this.topbar.listenerSetter})};a(i,()=>{lt.previous()}),a(n,()=>{lt.next()}),this.toggleEl=Xe("",{noRipple:!0}),this.toggleEl.classList.add("active","pinned-audio-ico"),a(this.toggleEl,()=>{lt.toggle()}),this.wrapper.prepend(this.wrapper.firstElementChild,i,this.toggleEl,n),this.volumeSelector=new ih(this.listenerSetter,!0);const r=document.createElement("div");r.classList.add("progress-line-container"),r.append(this.volumeSelector.container);const l=document.createElement("div");l.classList.add("pinned-audio-volume-tunnel"),this.volumeSelector.btn.classList.add("pinned-audio-volume","active"),this.volumeSelector.btn.prepend(l),this.volumeSelector.btn.append(r),this.repeatEl=Xe("audio_repeat",{noRipple:!0}),a(this.repeatEl,()=>{const u=lt.getPlaybackParams();u.round?u.loop?(lt.round=!1,lt.loop=!1):lt.loop=!lt.loop:lt.round=!0});const c=this.fasterEl=Xe("playback_2x",{noRipple:!0});a(c,()=>{lt.playbackRate=c.classList.contains("active")?1:1.75}),this.wrapperUtils.prepend(this.volumeSelector.btn,c,this.repeatEl);const d=document.createElement("div");d.classList.add("pinned-audio-progress-wrapper"),this.progressLine=new qh({withTransition:!0,useTransform:!0}),this.progressLine.container.classList.add("pinned-audio-progress"),d.append(this.progressLine.container),this.wrapper.insertBefore(d,this.wrapperUtils),this.topbar.listenerSetter.add(lt)("play",this.onMediaPlay),this.topbar.listenerSetter.add(lt)("pause",this.onPause),this.topbar.listenerSetter.add(lt)("stop",this.onStop),this.topbar.listenerSetter.add(lt)("playbackParams",this.onPlaybackParams);const h=lt.getPlayingDetails();h&&(this.onMediaPlay(h),this.onPlaybackParams(h.playbackParams))}destroy(){this.progressLine&&this.progressLine.removeListeners()}setPlayIcon(e){Uo(this.toggleEl,e?"play":"pause")}}const ya=1,$u=2,Wr="pinned-message-border";class o_{constructor(){this.drawRect=(e,t,s,i,n)=>`M${e},${t+n}a${n},${n},0,0,1,${s},0v${i-2*n}a${n},${n},0,0,1,${-s},0Z`,this.getClipPath=(e,t,s)=>{let n="";if(s===2)n=this.drawRect(0,0,$u,t,1)+this.drawRect(0,t+ya*2,$u,t,1);else for(let a=0;a<s;++a)n+=this.drawRect(0,(t+ya)*a,$u,t,1);return this.clipPath||(this.clipPath=document.createElementNS("http://www.w3.org/2000/svg","clipPath"),this.path=document.createElementNS("http://www.w3.org/2000/svg","path"),this.clipPath.append(this.path)),this.clipPath.id=e,this.path.setAttributeNS(null,"d",n),this.clipPath},this.getBarHeight=(e,t)=>{let s;return e<=1?s=32:e===2?s=15:e===3?s=10:(e===4||e>3)&&(s=8),s},this.getMarkHeight=(e,t)=>{let s;return e<=1?s=32:e===2?s=15:e===3?s=10:(e===4||e>3)&&(s=8),s},this.getMarkTranslateY=(e,t,s)=>{if(s===1)return 0;if(s===2)return e?t+ya:0;if(s===3){if(e){if(e===1)return t+ya}else return 0;return t*2+ya*2+1}else return(t+ya)*e},this.getTrackTranslateY=(e,t,s,i)=>t<=4||e<=1?0:e>=t-2?i-32-s:(e-2)*s+e*ya,this.getTrackHeight=(e,t)=>e<=3?32:t*e+ya*(e-1)}render(e,t){if(this.border||(this.border=document.createElement("div"),this.border.classList.add(Wr),this.wrapper=document.createElement("div"),this.border.append(this.wrapper)),e===1)return this.count!==e&&(this.wrapper.className=Wr+"-wrapper-1",this.border.classList.remove(Wr+"-mask"),this.wrapper.replaceChildren(),this.wrapper.style.cssText=""),this.border;const s=this.getBarHeight(e,t),i=this.getMarkHeight(e,t),n=this.getTrackHeight(e,s),a=`clipPath_${e}`,r=this.getClipPath(a,s,e),l=this.getMarkTranslateY(t,s,e),c=this.getTrackTranslateY(t,e,s,n);return this.border.classList.toggle(Wr+"-mask",e>4),t<=1?(this.border.classList.add("mask-bottom"),this.border.classList.remove("mask-top")):t>=e-2?(this.border.classList.add("mask-top"),this.border.classList.remove("mask-bottom")):this.border.classList.add("mask-top","mask-bottom"),this.wrapper.className=Wr+"-wrapper",this.wrapper.style.cssText=`clip-path: url(#${a}); width: 2px; height: ${n}px; transform: translateY(-${c}px);`,this.svg||(this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttributeNS(null,"height","0"),this.svg.setAttributeNS(null,"width","0"),this.defs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.defs.append(r),this.svg.append(this.defs),this.mark=document.createElement("div"),this.mark.classList.add(Wr+"-mark")),this.svg.parentElement||this.wrapper.append(this.svg,this.mark),this.mark.style.cssText=`height: ${i}px; transform: translateY(${l}px);`,this.count=e,this.index=t,this.border}}function l_(o,e,t,s){if(Ye){let i;const n={passive:!0};s.add(o)("touchstart",l=>{if(l.touches.length>1){r();return}i=l.touches[0].clientY,s.add(o)("touchmove",a,n),s.add(o)("touchend",r,n)},n);const a=l=>{const c=l.touches[0].clientY,d=c<i;(e==="bottom"&&d||e==="top"&&!d)&&t(),i=c},r=()=>{s.removeManual(o,"touchmove",a,n),s.removeManual(o,"touchend",r,n)}}else s.add(o)("wheel",i=>{const n=i.deltaY>0;(e==="bottom"&&n||e==="top"&&!n)&&t()},{passive:!0})}const hr=class hr{constructor(){this.rows={},this.container=document.createElement("div"),this.container.className=hr.BASE_CLASS}getRow(e,t=!1){if(this.rows[e])return this.rows[e].element;const s=document.createElement("div"),i=!Object.keys(this.rows).length&&!t;return s.className=hr.BASE_CLASS+"-row"+(i?"":" is-hiding hide"),this.rows[e]={element:s,new:!0},this.container.append(s),s}clearRow(e){this.rows[e]&&(this.rows[e].element.remove(),delete this.rows[e])}clearRows(e){this.clearTimeout&&clearTimeout(this.clearTimeout),this.clearTimeout=window.setTimeout(()=>{for(const t in this.rows)+t!==e&&this.clearRow(+t)},hr.DURATION)}setNewRow(e,t=!1){const s=this.rows[e];s.new&&(t?(s.element.classList.remove("hide"),s.element.offsetLeft):s.element.classList.remove("is-hiding","hide"),delete s.new),this.clearRows(e)}animate(e,t,s=e>t,i=!1){if(e===t)return this.setNewRow(e);const n=this.rows[e],a=this.rows[t];if(!a&&!i)return this.setNewRow(e);const r=["from-top","from-bottom"];s||r.reverse(),n.element.classList.add(r[0]),n.element.classList.remove(r[1]),a&&(a.element.classList.add(r[1]),a.element.classList.remove(r[0])),n.new&&this.setNewRow(e,!0),n.element.classList.toggle("is-hiding",!1),a&&a.element.classList.toggle("is-hiding",!0),this.clearRows(e)}};hr.DURATION=200,hr.BASE_CLASS="animated-super";let Do=hr;const fn=class fn{constructor(e=!1){this.reverse=e,this.decimals=[],this.previousNumber=0,this.container=document.createElement("div"),this.container.className=fn.BASE_CLASS}getDecimal(e){if(this.decimals[e])return this.decimals[e];const t=document.createElement("div");t.className=fn.BASE_CLASS+"-decimal";const s=document.createElement("div");s.className=fn.BASE_CLASS+"-decimal-placeholder";const i=new Do;return i.container.className=fn.BASE_CLASS+"-decimal-wrapper",t.append(s,i.container),this.container.append(t),this.decimals[e]={container:t,placeholder:s,animatedSuper:i}}clear(e){this.clearTimeout&&clearTimeout(this.clearTimeout);const t=(""+e).length;t>=this.decimals.length||(this.clearTimeout=window.setTimeout(()=>{this.decimals.splice(t,this.decimals.length-t).forEach(i=>{i.container.remove()})},Do.DURATION))}hideLeft(e){const t=(""+e).length;this.decimals.slice(t).forEach(i=>{const n=+i.placeholder.innerText||0;i.animatedSuper.getRow(fn.EMPTY_INDEX,!0),i.animatedSuper.animate(fn.EMPTY_INDEX,n,this.reverse?e<this.previousNumber:e>this.previousNumber,!0)}),this.clear(e)}setCount(e){const t=Array.from(""+this.previousNumber).map(i=>+i);Array.from(""+e).map(i=>+i).forEach((i,n)=>{const a=this.getDecimal(n),r=a.animatedSuper.getRow(i,!0),l=t[n]??fn.EMPTY_INDEX;r.innerText=a.placeholder.innerText=""+i,a.animatedSuper.animate(i,l,this.reverse?e<this.previousNumber:e>this.previousNumber,!0)}),this.hideLeft(e),this.previousNumber=e}};fn.EMPTY_INDEX=-1,fn.BASE_CLASS="animated-counter";let Hp=fn;const c_=!1,Zn=class Zn{constructor(e,t,s){this.topbar=e,this.chat=t,this.managers=s,this.pinnedMaxMid=0,this.pinnedMid=0,this.pinnedIndex=-1,this.wasPinnedIndex=0,this.wasPinnedMediaIndex=0,this.locked=!1,this.waitForScrollBottom=!1,this.count=0,this.mids=[],this.offsetIndex=0,this.loading=!1,this.loadedBottom=!1,this.loadedTop=!1,this.hidden=!1,this.listenerSetter=new Qt,this.log=zs("PM"),this.debug=!0,this.isStatic=!1;const i=new Tb("pinned-message");this.pinnedMessageContainer=new su({topbar:e,chat:t,listenerSetter:this.listenerSetter,className:"message",divAndCaption:i,onClose:async()=>(await s.appPeersManager.canPinMessage(this.chat.peerId)?J.createPopup(dc,this.chat.peerId,this.pinnedMid,!0):J.createPopup(dc,this.chat.peerId,0,!0),!1),floating:c_}),this.pinnedMessageBorder=new o_,i.border.replaceWith(this.pinnedMessageBorder.render(1,0)),this.animatedSubtitle=new Do,i.subtitle.append(this.animatedSubtitle.container),this.animatedMedia=new Do,this.animatedMedia.container.classList.add("pinned-message-media-container"),i.content.prepend(this.animatedMedia.container),this.animatedCounter=new Hp(!0),i.title.append(_("PinnedMessage")," ",this.animatedCounter.container);const n=this.pinnedMessageContainer.btnClose.cloneNode(!0);this.pinnedMessageContainer.attachOnCloseEvent(n),i.container.prepend(n),this.btnOpen=Xe("pinlist pinned-container-close pinned-message-pinlist",{noRipple:!0}),this.pinnedMessageContainer.wrapperUtils.prepend(this.btnOpen),D(this.btnOpen,a=>{X(a),this.topbar.openPinned(!0)},{listenerSetter:this.listenerSetter}),this.listenerSetter.add(C)("peer_pinned_messages",({peerId:a})=>{a===this.chat.peerId&&(this.hidden&&this.pinnedMessageContainer.toggle(this.hidden=!1),this.loadedTop=this.loadedBottom=!1,this.pinnedIndex=-1,this.pinnedMid=0,this.count=0,this.mids=[],this.offsetIndex=0,this.pinnedMaxMid=0,this.setCorrectIndex(0))}),this.listenerSetter.add(C)("peer_pinned_hidden",({peerId:a})=>{a===this.chat.peerId&&this.pinnedMessageContainer.toggle(this.hidden=!0)}),this.setPinnedMessage=Zs(()=>this._setPinnedMessage(),100,!0,!0),this.setCorrectIndexThrottled=$n(this.setCorrectIndex.bind(this),100,!1),this.isStatic=!this.chat.isPinnedMessagesNeeded()}destroy(){this.pinnedMessageContainer.divAndCaption.container.remove(),this.pinnedMessageContainer.toggle(!0),this.listenerSetter.removeAll(),this.unsetScrollDownListener(!1)}setCorrectIndex(e){if(this.isStatic||(this.debug&&this.log("setCorrectIndex",e),this.locked||this.hidden)||(this.loadedBottom||this.loadedTop)&&!this.count)return;const t=this.chat.bubbles.getBubbleByPoint("bottom");if(!t)return;const s=t.dataset.mid;s!==void 0&&this.testMid(+s,e)}testMid(e,t){if(this.isStatic||this.hidden)return;let s=this.mids.findIndex(n=>n<=e);if(s!==-1&&!this.isNeededMore(s))s+=this.offsetIndex;else if(this.loadedTop&&e<this.mids[this.mids.length-1])s=this.mids.length-1+this.offsetIndex;else return this.getCurrentIndexPromise??(this.getCurrentIndexPromise=this.getCurrentIndex(e,t!==void 0));if(this.pinnedIndex!==s)return this.waitForScrollBottom&&t!==void 0&&(this.pinnedIndex===0||this.pinnedIndex>s)?void 0:(this.pinnedIndex=s,this.pinnedMid=this.mids.find(n=>n<=e)||this.mids[this.mids.length-1],this.setPinnedMessage())}isNeededMore(e){return this.count>Zn.LOAD_COUNT&&(!this.loadedBottom&&e<=Zn.LOAD_OFFSET||!this.loadedTop&&this.count-1-e<=Zn.LOAD_OFFSET)}async getCurrentIndex(e,t=!0){if(!this.loading){this.loading=!0;try{const s=this.debug?this.log.bindPrefix("getCurrentIndex"):void 0;s&&s("start",e,t);let i=!1;const n=[this.managers.appMessagesManager.getHistory({peerId:this.chat.peerId,inputFilter:{_:"inputMessagesFilterPinned"},offsetId:e,limit:Zn.LOAD_COUNT,backLimit:Zn.LOAD_COUNT,threadId:this.chat.threadId,needRealOffsetIdOffset:!0}).then(c=>(i=!0,c))];if(!this.pinnedMaxMid){const c=this.managers.appMessagesManager.getPinnedMessage(this.chat.peerId,this.chat.threadId).then(d=>{d.maxId&&(this.pinnedMaxMid=d.maxId,!i&&t&&(this.mids=[this.pinnedMaxMid],this.count=d.count,this.pinnedIndex=0,this.pinnedMid=this.mids[0],this.setPinnedMessage()))});n.push(c)}const a=(await Promise.all(n))[0],r=a.history;let l=r.findIndex(c=>c<=e);l===-1&&(l=r.length),this.offsetIndex=Math.max(0,a.offsetIdOffset)?a.offsetIdOffset-l:0,this.mids=r.slice(),this.count=a.count,this.count||this.pinnedMessageContainer.toggle(!0),this.loadedTop=this.offsetIndex+this.mids.length===this.count,this.loadedBottom=!this.offsetIndex,s&&s("result",e,a,l,this.offsetIndex,this.loadedTop,this.loadedBottom)}catch(s){this.log.error("getCurrentIndex error",s)}this.loading=!1,this.locked?this.testMid(e):t&&this.setCorrectIndex(0),this.getCurrentIndexPromise=void 0}}setScrollDownListener(){this.waitForScrollBottom=!0,this.scrollDownListenerSetter||(this.scrollDownListenerSetter=new Qt,l_(this.chat.bubbles.scrollable.container,"bottom",()=>{this.unsetScrollDownListener()},this.scrollDownListenerSetter))}unsetScrollDownListener(e=!0){this.waitForScrollBottom=!1,this.scrollDownListenerSetter&&(this.scrollDownListenerSetter.removeAll(),this.scrollDownListenerSetter=void 0),e&&this.setCorrectIndex(0)}async handleFollowingPinnedMessage(){this.locked=!0,this.debug&&this.log("handleFollowingPinnedMessage");try{this.setScrollDownListener();const e=this.chat.setPeerPromise;e instanceof Promise&&await e,await xs(),this.getCurrentIndexPromise&&await this.getCurrentIndexPromise,this.debug&&this.log("handleFollowingPinnedMessage: unlock"),this.locked=!1}catch(e){this.log.error("handleFollowingPinnedMessage error:",e),this.locked=!1,this.waitForScrollBottom=!1,this.setCorrectIndex(0)}}followPinnedMessage(e){this.chat.getMessage(e)&&(this.chat.setMessageId({lastMsgId:e}),(this.chat.setPeerPromise||Promise.resolve()).then(()=>{this.handleFollowingPinnedMessage(),this.testMid(this.pinnedIndex>=this.count-1?this.pinnedMaxMid:e-1)}))}async _setPinnedMessage(){const e=this.count;if(e){const t=this.pinnedIndex,s=this.chat.getMessage(this.pinnedMid),i=t===0;this.animatedCounter.container.classList.toggle("is-last",i),i||this.animatedCounter.setCount(e-t),this.pinnedMessageContainer.toggle(!1);const n=t>this.wasPinnedIndex;this.debug&&this.log("setPinnedMessage: fromTop",n,t,this.wasPinnedIndex);const a=this.animatedSubtitle.getRow(t),r=this.animatedMedia.getRow(t);r.classList.add("pinned-message-media");const l=[],c=await ng({titleEl:null,subtitleEl:a,message:s,mediaEl:r,loadPromises:l,animationGroup:this.chat.animationGroup,textColor:"primary-text-color"});await Promise.all(l),this.pinnedMessageContainer.divAndCaption.container.classList.toggle("is-media",c),this.animatedSubtitle.animate(t,this.wasPinnedIndex),c?(this.animatedMedia.animate(t,this.wasPinnedMediaIndex),this.wasPinnedMediaIndex=t):this.animatedMedia.clearRows(),this.pinnedMessageBorder.render(e,e-t-1),this.wasPinnedIndex=t,this.pinnedMessageContainer.divAndCaption.container.dataset.mid=""+s.mid}else this.pinnedMessageContainer.toggle(!0),this.wasPinnedIndex=0;this.pinnedMessageContainer.divAndCaption.container.classList.toggle("is-many",this.count>1)}};Zn.LOAD_COUNT=50,Zn.LOAD_OFFSET=5;let hh=Zn;const d_="assets/audio/";class Cw{constructor(e){this.assets=e,this.tempId=0}playSound(e,t=!1){++this.tempId,this.assetName=e;try{const s=this.createAudio();s.autoplay=!0,s.src=d_+e,s.loop=t,Pi(s)}catch(s){console.error("playSound",e,s)}}playSoundIfDifferent(e,t){this.assetName!==e&&this.playSound(e,t)}createAudio(){let{audio:e}=this;return e||(e=this.audio=new Audio,Pi(e),e)}stopSound(){this.audio&&this.audio.pause()}cancelDelayedPlay(){++this.tempId}playSoundWithTimeout(e,t,s){const i=++this.tempId;setTimeout(()=>{this.tempId===i&&this.playSound(e,t)},s)}}let h_;function u_(){return h_??(h_=new Cw(["group_call_connect.mp3","group_call_end.mp3","group_call_start.mp3","voip_onallowtalk.mp3"]))}function p_(o){return(!!navigator?.mediaDevices?.getSupportedConstraints())[o]}function Iw(){const o={channelCount:2};return["noiseSuppression","echoCancellation","autoGainControl"].forEach(t=>{p_(t)&&(o[t]=!0)}),o}function Lw(o){const e={video:{width:{max:1920},height:{max:1080},frameRate:{max:30}}};return o||(e.audio=!0),e}async function Mw(o){const e=await navigator.mediaDevices.getDisplayMedia(o),t=e.getVideoTracks()[0];return t.contentHint="text",e}async function iu(o,e){const t=await navigator.mediaDevices.getUserMedia(o);return t.getTracks().forEach(s=>{s.enabled=!e}),t}window.getStream=iu;function Pw(){const o={main:{},screen:{}};return async e=>{const{isScreen:t,constraints:s}=e,i=o[t?"screen":"main"];let n=i[s.audio?"audio":"video"];n||(n=(t?Mw:iu)(s,e.muted),s.audio&&!i.audio&&(i.audio=n.finally(()=>i.audio=void 0)),s.video&&!i.video&&(i.video=n.finally(()=>i.video=void 0)));try{return await n}catch(a){throw a}}}window.getStreamCached=Pw;function dg(){return{width:{min:1280,max:1920},height:{min:720,max:1080},frameRate:{min:24,max:30}}}function nu(o){o.stop(),Mh(o,"ended")}const m_=50,Ew=100;class Vp{constructor(e=`\r
`){this.joiner=e,this.lines=[],this.newLine=[]}add(...e){return this.lines.push(...e),this}push(e){return this.newLine.push(e),this}addJoined(e=""){return this.add(this.newLine.join(e)),this.newLine=[],this}join(){return this.lines.join(this.joiner)}finalize(){return this.join()+this.joiner}}function hg(o){return o<<0}function ey(o){return o>>>0}function g_(o,e=3){if(!o)return 0;const{length:t}=o;let s=0;for(let n=0;n<t;++n)s+=o[n]*o[n];const i=Math.sqrt(s/t)/255;return Math.min(1,i*e)}const _w="9";function au(o){return o==="screencast"?"video":o}function f_(o){const e=[];return e.push("a=candidate:"),e.push(`${o.foundation} ${o.component} ${o.protocol.toUpperCase()} ${o.priority} ${o.ip} ${o.port} typ ${o.type}`),o["rel-addr"]!==void 0&&e.push(` raddr ${o["rel-addr"]} rport ${o["rel-port"]}`),e.push(` generation ${o.generation}`),e.join("")}function kw(o){return o==="application"?"DTLS/SCTP":"UDP/TLS/RTP/SAVPF"}function Tw(o,e=_w,t){const s=kw(o);return`m=${au(o)} ${e} ${s} ${t.join(" ")}`}class ru extends Vp{addCandidate(e){return this.add(f_(e))}addHeader(e,t){const s=t.join(" ");return this.add("v=0",`o=- ${e} 2 IN IP4 0.0.0.0`,"s=-","t=0 0","a=extmap-allow-mixed",`a=group:BUNDLE ${s}`,"a=ice-options:trickle","a=msid-semantic:WMS *")}addTransport(e,t){this.add(`a=ice-ufrag:${e.ufrag}`,`a=ice-pwd:${e.pwd}`,"a=ice-options:trickle");for(const s of e.fingerprints)this.add(`a=fingerprint:${s.hash} ${s.fingerprint}`,`a=setup:${s.setup}`);if(!t&&e.candidates)for(const s of e.candidates)this.addCandidate(s);return this}addSsrc(e){let t="stream",{type:s,sourceGroups:i}=e;const n=ey(e.source);t+=n,s+=n;const a=()=>{this.add(`a=msid:${t} ${s}`)},r=l=>{this.add(`a=ssrc:${l} cname:${t}`,`a=ssrc:${l} msid:${t} ${s}`,`a=ssrc:${l} mslabel:${t}`,`a=ssrc:${l} label:${s}`)};return a(),i?.length?i.forEach(l=>{if(l.sources.length){const c=l.sources.map(ey);this.add(`a=ssrc-group:${l.semantics} ${c.join(" ")}`),c.forEach(r)}}):r(n),this}addSsrcEntry(e,t,s){const i=(...f)=>this.add(...f),{type:n,mid:a,direction:r,port:l}=e,c=t.transport,d=n==="application",h=d?void 0:t[n],u=r==="inactive";if(e.shouldBeSkipped(s))return i(`m=${au(n)} 0 ${kw(n)} 0`,"c=IN IP4 0.0.0.0","a=inactive",`a=mid:${a}`);const p=d?[{id:5e3}]:h["payload-types"],m=p.map(f=>f.id);i(Tw(n,l,m),"c=IN IP4 0.0.0.0",`a=rtcp:${l} IN IP4 0.0.0.0`),c["rtcp-mux"]&&i("a=rtcp-mux"),i(`a=mid:${a}`);let g=r;if(r!=="sendrecv"&&s&&!(u||d)&&(g=r==="sendonly"?"recvonly":"sendonly"),i(`a=${g}`),this.addTransport(c),d)i(`a=sctpmap:${p[0].id} webrtc-datachannel 256`);else{const f=h["rtp-hdrexts"];f?.length&&f.forEach(y=>{i(`a=extmap:${y.id} ${y.uri}`)}),p.forEach(y=>{i(`a=rtpmap:${y.id} ${y.name}/${y.clockrate}${y.channels&&y.channels>1?`/${y.channels}`:""}`);const v=y.parameters;if(Array.isArray(v))v.length&&console.error("parameters is array???",v);else if(v&&Object.keys(v).length){const w=[];for(const S in v)w.push(`${S}=${v[S]}`);i(`a=fmtp:${y.id} ${w.join(";")}`)}const b=y["rtcp-fbs"];b?.length&&b.forEach(w=>{i(`a=rtcp-fb:${y.id} ${w.type}${w.subtype?" "+w.subtype:""}`)})})}return e.source&&(g==="sendonly"||g==="sendrecv")&&this.addSsrc(e),this}addConference(e){const{conference:t,entries:s,bundle:i,isAnswer:n}=e;this.addHeader(t.sessionId,i),np&&this.addTransport(t.transport);for(const a of s)this.addSsrcEntry((n?a.recvEntry||a.sendEntry:a.sendEntry||a.recvEntry)||a,t,n);return this}static fromConference(e){return new ru().addConference(e).finalize()}}class y_{constructor(e,t){const s=this.streamSource=e.createMediaStreamSource(t),i=this.analyser=e.createAnalyser();this.gain=e.createGain(),i.minDecibels=-100,i.maxDecibels=-30,i.smoothingTimeConstant=.05,i.fftSize=1024,s.connect(i)}}const Dl=class Dl{constructor(e){this.interval=e,this.getAmplitude=t=>{const{streamAnalyser:s,stream:i,track:n,source:a,type:r}=t,l=s.analyser;if(!l)return;const c=new Uint8Array(l.frequencyBinCount);l.getByteFrequencyData(c);const d=g_(c);return{type:r,source:a,stream:i,track:n,value:d}},this.analyse=()=>{const t=this.counter%3===0,n=(t?this.items:this.items.filter(a=>a.type==="input")).filter(a=>a.kind==="audio").slice(0,m_).map(this.getAmplitude);++this.counter>=1e3&&(this.counter=0),Dl.ANALYSER_LISTENER.dispatchEvent("amplitude",{amplitudes:n,type:t?"all":"input"})},this.context=new(window.AudioContext||window.webkitAudioContext),this.items=[],this.outputStream=new MediaStream,this.inputStream=new MediaStream,this.counter=0,this.log=zs("SM"),this.direction="sendonly",this.canCreateConferenceEntry=!0,this.types=["audio","video"]}addStream(e,t){e.getTracks().forEach(s=>{this.addTrack(e,s,t)})}addTrack(e,t,s){this.log("addTrack",s,t,e);const{context:i,items:n,inputStream:a,outputStream:r}=this,l=t.kind,c=Dl.getSource(e,s);switch(s){case"input":{a?a.addTrack(t):this.inputStream=e;break}case"output":{for(let d=0;d<n.length;++d){const{track:h,type:u,source:p}=n[d];if(p===c&&u==="input"){n.splice(d,1),r.removeTrack(h);break}}l!=="video"&&r.addTrack(t);break}}this.finalizeAddingTrack({type:s,source:c,stream:e,track:t,kind:l,streamAnalyser:l==="audio"?new y_(i,e):void 0}),l==="audio"&&this.interval&&this.changeTimer()}finalizeAddingTrack(e){const{track:t}=e;t.addEventListener("ended",()=>{this.removeTrack(t)},{once:!0}),this.items.push(e)}hasInputTrackKind(e){return this.items.find(t=>t.type==="input"&&t.kind===e)}static getSource(e,t){return t==="input"?e.source||e.id:""+hg(+e.id.substring(6))}removeTrack(e){this.log("removeTrack",e);const{items:t}=this;let s=!1;for(let i=0,n=t.length;!s&&i<n;++i){const{track:a,type:r}=t[i];switch(r){case"output":{a===e&&(t.splice(i,1),this.outputStream.removeTrack(e),s=!0);break}case"input":{a===e&&(t.splice(i,1),this.inputStream.removeTrack(e),s=!0);break}}}e.kind==="audio"&&this.interval&&this.changeTimer()}replaceInputAudio(e,t){this.removeTrack(t),this.addStream(e,"input")}changeTimer(){this.timer!==void 0&&clearInterval(this.timer),this.items.length&&(this.timer=window.setInterval(this.analyse,this.interval))}appendToConference(e){if(this.locked)return;const{inputStream:t,direction:s,canCreateConferenceEntry:i}=this,n={direction:s,streams:[t]},a=this.types.map(l=>[l,n]),r=t.getTracks();for(const[l,c]of a){let d=e.findEntry(f=>f.direction===s&&f.type===l);if(!d){if(!i)continue;d=e.createEntry(l)}let{transceiver:h}=d;h||(h=d.createTransceiver(e.connection,c)),d.direction!==h.direction&&(h.direction=d.direction);const u=au(l),p=r.findIndex(f=>f.kind===u),m=p!==-1?r.splice(p,1)[0]:void 0,g=h.sender;g.track!==m&&g.replaceTrack(m).catch(f=>{this.log.error(f)})}}stop(){try{this.inputStream.getTracks().concat(this.outputStream.getTracks()).forEach(t=>{nu(t)})}catch(e){this.log.error(e)}}};Dl.ANALYSER_LISTENER=new vi;let Er=Dl;class xw extends vi{constructor(){super(!1);const e=this.player=document.createElement("div");e.classList.add("call-player"),e.style.display="none",document.body.append(e),this.elements=new Map;const t=this.audio=new Audio;t.autoplay=!0,t.volume=1,this.player.append(t),this.elements.set("audio",t),this.fixSafariAudio(),this.getStream=Pw()}get isSharingAudio(){return!!this.streamManager.hasInputTrackKind("audio")}get isSharingVideo(){return!!this.streamManager.hasInputTrackKind("video")}fixSafariAudio(){Pi(this.audio)}requestAudioSource(e){return this.requestInputSource(!0,!1,e)}requestInputSource(e,t,s){const{streamManager:i}=this;if(i){const a=!e||this.isSharingAudio,r=!t||this.isSharingVideo;if(a&&r)return Promise.resolve()}const n={audio:e&&Iw(),video:t&&dg()};return this.getStream({constraints:n,muted:s}).then(a=>{this.onInputStream(a)})}requestScreen(){return this.getStream({isScreen:!0,constraints:Lw(!0)}).then(e=>{this.onInputStream(e)})}getElement(e){return this.elements.get(""+e)}cleanup(){this.player.textContent="",this.player.remove(),this.elements.clear(),this.streamManager.stop(),super.cleanup()}onTrack(e){this.tryAddTrack({stream:e.streams[0],track:e.track,type:"output"})}saveInputVideoStream(e,t){const s=e.getVideoTracks()[0];this.tryAddTrack({stream:e,track:s,type:"input",source:t||"main"})}tryAddTrack({stream:e,track:t,type:s,source:i}){i||(i=Er.getSource(e,s)),this.log("tryAddTrack",e,t,s,i);const n=s==="output",{player:a,elements:r,streamManager:l}=this,c=t.kind,d=c==="video",h=d?i:c;let u=r.get(h);d&&t.addEventListener("ended",()=>{this.log("[track] onended"),r.delete(h)},{once:!0}),n&&l.addTrack(e,t,s);const p=d?e:l.outputStream;if(u)u.paused&&Pi(u),u.srcObject=p;else{if(u=document.createElement(c),u.autoplay=!0,u.srcObject=p,u.volume=1,u.sinkId!=="undefined"){const{outputDeviceId:m}=this;m&&u.setSinkId(m)}d?(u.setAttribute("playsinline","true"),u.muted=!0):a.appendChild(u),r.set(h,u)}return i}setMuted(e){this.streamManager.inputStream.getAudioTracks().forEach(t=>{t?.kind==="audio"&&(t.enabled=e===void 0?!t.enabled:!e)})}onInputStream(e){if(this.isClosing)e.getTracks().forEach(t=>{nu(t)});else{e.getVideoTracks().length&&this.saveInputVideoStream(e,"main");const{streamManager:s,description:i}=this;s.addStream(e,"input"),i&&s.appendToConference(i)}}}function v_(o,e,t){t||(t=zs("RTCDataChannel"));const s=o.createDataChannel("data",e);return s.addEventListener("message",i=>{t("onmessage",i)}),s.addEventListener("open",()=>{t("onopen")}),s.addEventListener("close",()=>{t("onclose")}),s.log=t,s}function b_(o,e){e||(e=zs("RTCPeerConnection")),e("constructor");const t=new RTCPeerConnection(o);return t.addEventListener("track",s=>{e("ontrack",s)}),t.addEventListener("signalingstatechange",()=>{e("onsignalingstatechange",t.signalingState)}),t.addEventListener("connectionstatechange",()=>{e("onconnectionstatechange",t.connectionState)}),t.addEventListener("negotiationneeded",()=>{e("onnegotiationneeded",t.signalingState)}),t.addEventListener("icecandidate",s=>{e("onicecandidate",s)}),t.addEventListener("iceconnectionstatechange",()=>{e("oniceconnectionstatechange",t.iceConnectionState)}),t.addEventListener("datachannel",()=>{e("ondatachannel")}),t.log=e,{connection:t}}class ou{constructor(e,t){this.mid=e,this.type=t,this.port=_w}setDirection(e){return this.originalDirection||(this.originalDirection=e),this.direction=e}setPort(e){return this.port=e}setEndpoint(e){return this.endpoint=e}setPeerId(e){return this.peerId=e}createTransceiver(e,t){return t?.direction&&this.setDirection(t.direction),this.transceiver=e.addTransceiver(au(this.type),t)}setSource(e){let t;if(Array.isArray(e)){if(!e[0])return;t=e,e=t[0].sources[0]}return this.sourceGroups=t,this.source=e}shouldBeSkipped(e){return e&&this.direction==="inactive"}}function Nd(o,e,t){let s;if(Array.isArray(e)){if(!e[0])return;s=e,e=s[0].sources[0]}return{endpoint:t,type:o,source:e,sourceGroups:s}}class w_{constructor(e){this.connection=e,this.sessionId=""+Date.now(),this.maxSeenId=-1,this.entries=[],this.entriesByMid=new Map,this.entriesBySource=new Map,this.entriesByPeerId=new Map}setData(e){return Lt(this,e)}createEntry(e){const t=""+ ++this.maxSeenId,s=new ou(t,e);return this.entries.push(s),this.entriesByMid.set(t,s),s}deleteEntry(e){cs(this.entries,e),this.entriesByMid.delete(e.mid),this.entriesBySource.delete(e.source);const t=this.entriesByPeerId.get(e.peerId);t&&(t.delete(e),t.size||this.entriesByPeerId.delete(e.peerId))}setEntrySource(e,t){e.setSource(t),this.entriesBySource.set(e.source,e)}setEntryPeerId(e,t){e.setPeerId(t);let s=this.entriesByPeerId.get(t);s||this.entriesByPeerId.set(t,s=new Set),s.add(e)}findEntry(e){return this.entries.find(e)}findFreeSendRecvEntry(e,t){let s=this.entries.find(i=>i.direction==="sendrecv"&&i.type===e&&!(t?i.sendEntry:i.recvEntry));return s||(s=this.createEntry(e),s.setDirection("sendrecv")),s}getEntryByMid(e){return this.entriesByMid.get(e)}getEntryBySource(e){return this.entriesBySource.get(e)}getEntriesByPeerId(e){return this.entriesByPeerId.get(e)}generateSdp(e){return ru.fromConference({conference:this,...e})}}class Aw{constructor(e){Lt(this,e),this.log||(this.log=this.connection?.log||zs("CALL-CONNECTION-BASE")),this.sources={}}createPeerConnection(e){return this.connection||(this.connection=b_(e,this.log.bindPrefix("connection")).connection)}createDataChannel(e){return this.dataChannel||(this.dataChannel=v_(this.connection,e,this.log.bindPrefix("data")))}createDescription(){return this.description||(this.description=new w_(this.connection))}appendStreamToConference(){return this.streamManager.appendToConference(this.description)}closeConnection(){const{connection:e}=this;if(e)try{e.log("close"),e.close()}catch(t){this.log.error(t)}}closeConnectionAndStream(e){this.closeConnection(),e&&this.streamManager.stop()}negotiate(){const e=this.negotiating;return e||(this.negotiating=this.negotiateInternal().finally(()=>{this.negotiating=void 0}))}sendDataChannelData(e){this.dataChannel.readyState==="open"&&this.dataChannel.send(JSON.stringify(e))}}function S_(o,e){const t=i=>{const n={};return i.attributes.get("extmap").forEach(r=>{const l=r.key.split("/",1)[0];n[l]=r.value}),n};["audio","video"].filter(i=>e[i]).map(i=>[e[i],i]).forEach(([i,n])=>{const a=o.find(l=>l.mediaType===n);if(!a)return;const r=t(a);ii(i["rtp-hdrexts"],(l,c,d)=>{r[l.id]!==l.uri&&(d.splice(c,1),console.log("[sdp] filtered extmap:",l,c,n))})})}var mc,gc;class C_{constructor(e,t){es(this,mc,void 0);es(this,gc,void 0);kt(this,mc,e),kt(this,gc,t)}get session(){return At(this,mc)}get media(){return At(this,gc)}get bundle(){return this.session.lines.find(t=>t.parsed?.key==="group").value.split(" ").slice(1)}toString(){return this.session.lines.concat(...this.media.map(e=>e.lines)).map(e=>e.toString()).join(`\r
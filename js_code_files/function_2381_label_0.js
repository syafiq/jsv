DrawioFile.prototype.mergeFile=function(b,e,k,l){var B=!0;try{this.stats.fileMerged++;var q=this.getShadowPages(),D=b.getShadowPages();if(null!=D&&0<D.length){var N=[this.ui.diffPages(null!=l?l:q,D)],S=this.ignorePatches(N);this.setShadowPages(D);if(S)EditorUi.debug("File.mergeFile",[this],"file",[b],"ignored",S);else{null!=this.sync&&this.sync.sendLocalChanges();this.backupPatch=this.isModified()?this.ui.diffPages(q,this.ui.pages):null;l={};S={};var F=this.ui.patchPages(q,N[0]),K=this.ui.getHashValueForPages(F,
l),R=this.ui.getHashValueForPages(D,S);EditorUi.debug("File.mergeFile",[this],"file",[b],"shadow",q,"pages",this.ui.pages,"patches",N,"backup",this.backupPatch,"checksum",K,"current",R,"valid",K==R,"from",this.getCurrentRevisionId(),"to",b.getCurrentRevisionId(),"modified",this.isModified());if(null!=K&&K!=R){var d=this.compressReportData(this.getAnonymizedXmlForPages(D)),f=this.compressReportData(this.getAnonymizedXmlForPages(F)),g=this.ui.hashValue(b.getCurrentEtag()),u=this.ui.hashValue(this.getCurrentEtag());
this.checksumError(k,N,"Shadow Details: "+JSON.stringify(l)+"\nChecksum: "+K+"\nCurrent: "+R+"\nCurrent Details: "+JSON.stringify(S)+"\nFrom: "+g+"\nTo: "+u+"\n\nFile Data:\n"+d+"\nPatched Shadow:\n"+f,null,"mergeFile",K,R,b.getCurrentRevisionId());return}if(null!=this.sync){var x=this.sync.patchRealtime(N,DrawioFile.LAST_WRITE_WINS?this.backupPatch:null);null==x||mxUtils.isEmptyObject(x)||N.push(x)}this.patch(N,DrawioFile.LAST_WRITE_WINS?this.backupPatch:null)}}else throw B=!1,Error(mxResources.get("notADiagramFile"));
this.inConflictState=this.invalidChecksum=!1;this.setDescriptor(b.getDescriptor());this.descriptorChanged();this.backupPatch=null;null!=e&&e()}catch(P){this.invalidChecksum=this.inConflictState=!0;this.descriptorChanged();null!=k&&k(P);try{if(B)if(this.errorReportsEnabled)this.sendErrorReport("Error in mergeFile",null,P);else{var A=this.getCurrentUser(),H=null!=A?A.id:"unknown";EditorUi.logError("Error in mergeFile",null,this.getMode()+"."+this.getId(),H,P)}}catch(M){}}};
function Yt(...o){const e=o.reduce((s,n)=>s+(n.byteLength||n.length),0),t=new Uint8Array(e);let a=0;return o.forEach(s=>{t.set(s instanceof ArrayBuffer?new Uint8Array(s):s,a),a+=s.byteLength||s.length}),t}Uint8Array.prototype.concat=function(...o){return Yt(this,...o)};Uint8Array.prototype.toJSON=function(){return[...this]};Promise.prototype.finally=Promise.prototype.finally||function(o){const e=t=>Promise.resolve(o()).then(t);return this.then(t=>e(()=>t),t=>e(()=>Promise.reject(t)))};function Pn(o){return+o<0}function vn(o){return+o>=0}String.prototype.toUserId=function(){return(+this).toUserId()};String.prototype.toChatId=function(){return(+this).toChatId()};String.prototype.toPeerId=function(o){return(+this).toPeerId(o)};String.prototype.isPeerId=function(){return/^[\d-]/.test(this.toString())};Number.prototype.toUserId=function(){return+this};Number.prototype.toChatId=function(){return Math.abs(this)};Number.prototype.toPeerId=function(o){return o===void 0?+this:o?-Math.abs(this):+this};Number.prototype.isPeerId=function(){return!0};[["isUser",vn],["isAnyChat",Pn]].forEach(o=>{const e=Array.isArray(o)?o[0]:o,t=Array.isArray(o)?o[1]:o;String.prototype[e]=function(){return t.call(null,this.toString())},Number.prototype[e]=function(){return t.call(null,+this)}});const we={test:location.search.indexOf("test=1")>0,debug:location.search.indexOf("debug=1")>0,http:!1,ssl:!0,asServiceWorker:!1,transport:"websocket",noSharedWorker:location.search.indexOf("noSharedWorker=1")>0,multipleTransports:!0};(we.http=location.search.indexOf("http=1")>0)&&(we.multipleTransports=!1);we.multipleTransports&&(we.http=!0);we.http&&(we.transport="https");const qe=we.debug,Si=typeof window<"u"?window:self,Fe=Si,gs=Date.now()%Math.random()*1e8|0,Ae=typeof window<"u"?window:self;function Le(o,e){const t=o.indexOf(e);return(t===-1?void 0:o.splice(t,1))?.[0]}const Ia=typeof ServiceWorkerGlobalScope<"u"&&self instanceof ServiceWorkerGlobalScope,Ja=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&!Ia,oa=Ja||Ia,bi=()=>self.clients.matchAll({includeUncontrolled:!1,type:"window"}),Mn=(o,...e)=>{try{o.postMessage(...e)}catch(t){console.error("[worker] postMessage error:",t,e)}},Sn=(o,...e)=>{bi().then(t=>{t.length&&t.slice(o?0:-1).forEach(a=>{Mn(a,...e)})})},bn=(...o)=>{Mn(self,...o)},Cn=()=>{};Ia&&Sn.bind(null,!1);Ia&&Sn.bind(null,!0);class ca{constructor(e){this._constructor(e)}_constructor(e){this.reuseResults=e,this.listeners={},this.listenerResults={}}addEventListener(e,t,a){var n;const s={callback:t,options:a};if(((n=this.listeners)[e]??(n[e]=new Set)).add(s),this.listenerResults.hasOwnProperty(e)&&(t(...this.listenerResults[e]),a?.once)){this.listeners[e].delete(s);return}}addMultipleEventsListeners(e){for(const t in e)this.addEventListener(t,e[t])}removeEventListener(e,t,a){if(this.listeners[e]){for(const s of this.listeners[e])if(s.callback===t){this.listeners[e].delete(s);break}}}invokeListenerCallback(e,t,...a){let s,n;try{s=t.callback(...a)}catch(i){n=i}if(t.options?.once&&this.removeEventListener(e,t.callback),n)throw n;return s}_dispatchEvent(e,t,...a){this.reuseResults&&(this.listenerResults[e]=a);const s=t&&[],n=this.listeners[e];if(n)for(const i of n){const r=this.invokeListenerCallback(e,i,...a);s&&s.push(r)}return s}dispatchResultableEvent(e,...t){return this._dispatchEvent(e,!0,...t)}dispatchEvent(e,...t){this._dispatchEvent(e,!1,...t)}cleanup(){this.listeners={},this.listenerResults={}}}const Xa={};function Ee(o){return Xa[o]??(Xa[o]={type:o})}const Ta=navigator?navigator.userAgent:null;navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i);navigator.userAgent.toLowerCase().indexOf("android");(()=>{try{return+navigator.userAgent.match(/Chrom(?:e|ium)\/(.+?)(?:\s|\.)/)[1]}catch{}})();const Ci="safari"in Ae||!!(Ta&&(/\b(iPad|iPhone|iPod)\b/.test(Ta)||Ta.match("Safari")&&!Ta.match("Chrome"))),Ii=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;(navigator.maxTouchPoints===void 0||navigator.maxTouchPoints>0)&&navigator.userAgent.search(/iOS|iPhone OS|Android|BlackBerry|BB10|Series ?[64]0|J2ME|MIDP|opera mini|opera mobi|mobi.+Gecko|Windows Phone/i)!=-1;const Di=Date.now();function Va(){return"["+((Date.now()-Di)/1e3).toFixed(3)+"]"}var Ie=(o=>(o[o.None=0]="None",o[o.Error=1]="Error",o[o.Warn=2]="Warn",o[o.Log=4]="Log",o[o.Debug=8]="Debug",o))(Ie||{});const wi=[0,1,2,4,8],ki=Ci||Ii,Ns=!ki,es={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},Ai=[["debug",8],["info",4],["warn",2],["error",1],["assert",1],["trace",4],["group",4],["groupCollapsed",4],["groupEnd",4]];function We(o,e=7,t=!1,a=""){let s;!qe&&!t&&(e=1),Ns?a||(Ia?a=es.fg.yellow:Ja&&(a=es.fg.cyan)):a="";const n=a;a?a=`%s ${a}%s`:a="%s";const i=function(...p){return e&4&&console.log(a,Va(),o,...p)};Ai.forEach(([p,d])=>{i[p]=function(...f){return e&d&&console[p](a,Va(),o,...f)}}),i.setPrefix=function(p){s=p,o="["+p+"]"},i.setPrefix(o),i.setLevel=function(p){e=wi.slice(0,p+1).reduce((d,f)=>d|f,0)};const r={};return i.bindPrefix=function(p,d=e){return r[p]??(r[p]=We(`${s}] ${Ns&&n?es.reset:""}[${p}`,d,t,n))},i}const Fi=!0;class Fs extends ca{constructor(e){super(!1),this.logSuffix=e,this.onMessage=t=>{const a=t.data,s=t.source||t.currentTarget;this.processTaskMap[a.type](a,s,t)},this.processResultTask=t=>{const{taskId:a,result:s,error:n}=t.payload,i=this.awaiting[a];i&&(this.debug&&this.log.debug("done",i.taskType,s,n),"error"in t.payload?i.reject(n):i.resolve(s),delete this.awaiting[a])},this.processAckTask=t=>{const a=t.payload,s=this.awaiting[a.taskId];if(!s)return;const n=s.resolve,i={cached:a.cached,result:a.cached?"result"in a?Promise.resolve(a.result):Promise.reject(a.error):new Promise((r,p)=>{s.resolve=r,s.reject=p})};n(i),a.cached&&delete this.awaiting[a.taskId]},this.processPingTask=(t,a,s)=>{this.pushTask(this.createTask("pong",void 0),s.source)},this.processPongTask=(t,a,s)=>{const n=this.pingResolves.get(a);n&&(this.pingResolves.delete(a),n())},this.processCloseTask=(t,a,s)=>{this.detachPort(a)},this.processBatchTask=(t,a,s)=>{const n={data:s.data,source:s.source,currentTarget:s.currentTarget};t.payload.forEach(i=>{n.data=i,this.onMessage(n)})},this.processLockTask=(t,a,s)=>{const n=t.payload;this.requestedLocks.has(n)||(this.requestedLocks.set(n,a),navigator.locks.request(n,()=>{this.processCloseTask(void 0,a,void 0),this.requestedLocks.delete(n)}))},this.processInvokeTask=async(t,a,s)=>{const n=t.id,i=t.payload;let r,p,d;i.void||(r={taskId:n},p=this.createTask("result",r)),i.withAck&&(d=this.createTask("ack",{taskId:n,cached:!0}));let f;try{const c=this.listeners[i.type];if(!c?.size)throw new Error("no listener");const l=c.values().next().value;let h=this.invokeListenerCallback(i.type,l,i.payload,a,s);if(i.void)return;if(f=h instanceof Promise,d){const y=!f;if(d.payload.cached=y,y&&(d.payload.result=h),this.pushTask(d,a),y)return}f&&(h=await h),r.result=h}catch(c){if(this.log.error("worker task error:",c,t),i.void)return;if(d&&d.payload.cached){d.payload.error=c,this.pushTask(d,a);return}r.error=c}this.pushTask(p,a)},this.listenPorts=[],this.sendPorts=[],this.pingResolves=new Map,this.taskId=0,this.awaiting={},this.pending=new Map,this.log=We("MP"+(e?"-"+e:"")),this.debug=qe,this.heldLocks=new Map,this.requestedLocks=new Map,this.processTaskMap={result:this.processResultTask,ack:this.processAckTask,invoke:this.processInvokeTask,ping:this.processPingTask,pong:this.processPongTask,close:this.processCloseTask,lock:this.processLockTask,batch:this.processBatchTask}}setOnPortDisconnect(e){this.onPortDisconnect=e}attachPort(e){this.attachListenPort(e),this.attachSendPort(e)}attachListenPort(e){this.listenPorts.push(e),e.addEventListener("message",this.onMessage)}attachSendPort(e){if(this.log.warn("attaching send port"),e.start?.(),this.sendPorts.push(e),typeof window<"u"&&Fi)if("locks"in navigator){const t=["lock",gs,this.logSuffix||"",Math.random()*2147483647|0].join("-");this.log.warn("created lock",t);const a=new Promise(s=>this.heldLocks.set(e,{resolve:s,id:t})).then(()=>this.heldLocks.delete(e));navigator.locks.request(t,()=>(this.resendLockTask(e),a))}else window.addEventListener("beforeunload",()=>{const t=this.createTask("close",void 0);this.postMessage(void 0,t)});this.releasePending()}resendLockTask(e){const t=this.heldLocks.get(e);t&&this.pushTask(this.createTask("lock",t.id),e)}detachPort(e){this.log.warn("disconnecting port"),Le(this.listenPorts,e),Le(this.sendPorts,e),e.removeEventListener?.("message",this.onMessage),e.close?.(),this.onPortDisconnect?.(e),this.heldLocks.get(e)?.resolve();const a=Ee("PORT_DISCONNECTED");for(const s in this.awaiting){const n=this.awaiting[s];n.port===e&&(n.reject(a),delete this.awaiting[s])}}postMessage(e,t){(Array.isArray(e)?e:e?[e]:this.sendPorts).forEach(s=>{s.postMessage(t,t.transfer)})}async releasePending(){this.releasingPending||(this.releasingPending=!0,await Promise.resolve(),this.debug&&this.log.debug("releasing tasks, length:",this.pending.size),this.pending.forEach((e,t)=>{let a=e;{let n;a=[],e.forEach(i=>{i.transfer?(n=void 0,a.push(i)):(n||(n=this.createTask("batch",[]),a.push(n)),n.payload.push(i))})}const s=t?[t]:this.sendPorts;s.length&&(a.forEach(n=>{try{this.postMessage(s,n)}catch(i){this.log.error("postMessage error:",i,n,s)}}),this.pending.delete(t))}),this.debug&&this.log.debug("released tasks"),this.releasingPending=!1)}createTask(e,t,a){return{type:e,payload:t,id:this.taskId++,transfer:a}}createInvokeTask(e,t,a,s,n){return this.createTask("invoke",{type:e,payload:t,withAck:a,void:s},n)}pushTask(e,t){let a=this.pending.get(t);a||this.pending.set(t,a=[]),a.push(e),this.releasePending()}invokeVoid(e,t,a,s){const n=this.createInvokeTask(e,t,void 0,!0,s);this.pushTask(n,a)}invoke(e,t,a,s,n){this.debug&&this.log.debug("start",e,t);let i;const r=new Promise((p,d)=>{i=this.createInvokeTask(e,t,a,void 0,n),this.awaiting[i.id]={resolve:p,reject:d,taskType:e,port:s},this.pushTask(i,s)});if(oa){r.finally(()=>{clearInterval(p)});const p=Ae.setInterval(()=>{this.log.error("task still has no result",i,s)},6e4)}return r}invokeExceptSource(e,t,a){const s=this.sendPorts.slice();Le(s,a),s.forEach(n=>{this.invokeVoid(e,t,n)})}}class Ei extends Fs{constructor(){super("CRYPTO"),this.lastIndex=-1}invokeCryptoNew({method:e,args:t,transfer:a}){const s={method:e,args:t},n=this.listeners.invoke;if(n?.size){let r=n.values().next().value.callback(s);return!oa&&!(r instanceof Promise)&&(r=Promise.resolve(r)),r}const i=e==="aes-encrypt"||e==="aes-decrypt"?this.lastIndex=(this.lastIndex+1)%this.sendPorts.length:0;return this.invoke("invoke",s,void 0,this.sendPorts[i],a)}invokeCrypto(e,...t){return this.invokeCryptoNew({method:e,args:t})}}const _e=new Ei;Fe&&(Fe.cryptoMessagePort=_e);let In;function vt(){return In}function Ui(o){return In=o}const ht=0,Dn=1271266957,Ti=777,Ri=2666e3,ms=777e3,wn=2147483647,qs=20*1024*1024,ya="",xi="default_static",ba=4294967296,kn=ba+1,Bi=new Set(["web","k","z","a"]),ot=0,Ct=1,je=new Set([ot,Ct]),ts=Math.max(...Array.from(je))+1;class xe extends Fs{constructor(){super("MTPROTO"),xe.INSTANCE=this,Fe&&(Fe.mtprotoMessagePort=this)}static getInstance(){return this.INSTANCE}}class An extends ca{constructor(){super(),this.myId=ht,this.connectionStatus={},this.premium=!1,this.addEventListener("user_auth",({id:e})=>{this.myId=e.toPeerId()}),this.addEventListener("premium_toggle_private",({isNew:e,isPremium:t})=>{this.premium=t,e||this.dispatchEventSingle("premium_toggle",t)}),this.addEventListener("connection_status_change",e=>{this.connectionStatus[e.name]=e}),this.dispatchEvent=(e,...t)=>{super.dispatchEvent(e,...t),xe.getInstance().invokeVoid("event",{name:e,args:t})},oa||this.addEventListener("settings_updated",({settings:e})=>{this.settings=e})}getConnectionStatus(){return this.connectionStatus}getPremium(){return this.premium}dispatchEventSingle(...e){super.dispatchEvent(...e)}}const Bt=new An;Fe.rootScope=Bt;function Ge(){}const Li={isFulfilled:!1,isRejected:!1,notify:()=>{},notifyAll:function(...o){this.lastNotify=o,this.listeners?.forEach(e=>e(...o))},addNotifyListener:function(o){this.lastNotify&&o(...this.lastNotify),(this.listeners??(this.listeners=[])).push(o)},resolve:function(o){this.isFulfilled||this.isRejected||(this.isFulfilled=!0,this._resolve(o),this.onFinish())},reject:function(...o){this.isRejected||this.isFulfilled||(this.isRejected=!0,this._reject(...o),this.onFinish())},onFinish:function(){this.notify=this.notifyAll=this.lastNotify=null,this.listeners&&(this.listeners.length=0),this.cancel&&(this.cancel=Ge)}};function Se(){let o,e;const t=new Promise((a,s)=>{o=a,e=s});return Object.assign(t,Li),t._resolve=o,t._reject=e,t}self.deferredPromise=Se;function ia(o,e,t=!0){let a=null,s,n;const i=()=>{clearInterval(a),a=null},r=(...p)=>{s=!0,n=p,a||(t&&(s=!1,o(...n)),a=setInterval(()=>{if(!s){i();return}s=!1,o(...n)},e))};return r.clear=i,r}function hs(o,e){if(e)for(const t in e)e[t]!==void 0&&(o[t]=e[t]);return o}const Ma=class Ma{constructor(e){hs(this,e),we.test&&(this.name+="_test"),this.storageIsAvailable=!0,this.log=We(["IDB",e.name].join("-")),this.log("constructor"),this.openDatabase(!0),Ma.INSTANCES.push(this)}isAvailable(){return this.storageIsAvailable}openDatabase(e=!1){if(this.openDbPromise&&!e)return this.openDbPromise;const t=(i,r)=>{const p=Array.from(i.indexNames);for(const d of p)i.deleteIndex(d);if(r.indexes?.length)for(const d of r.indexes)i.indexNames.contains(d.indexName)||i.createIndex(d.indexName,d.keyPath,d.objectParameters)},a=(i,r)=>{const p=i.createObjectStore(r.name);t(p,r)};try{var s=indexedDB.open(this.name,this.version);if(!s)return Promise.reject()}catch(i){return this.log.error("error opening db",i.message),this.storageIsAvailable=!1,Promise.reject(i)}let n=!1;return setTimeout(()=>{n||s.onerror(Ee("IDB_CREATE_TIMEOUT"))},3e3),this.openDbPromise=new Promise((i,r)=>{s.onsuccess=p=>{n=!0;const d=s.result;let f=!1;this.log("Opened"),d.onerror=c=>{this.storageIsAvailable=!1,this.log.error("Error creating/accessing IndexedDB database",c),r(c)},d.onclose=c=>{this.log.error("closed:",c),!f&&this.openDatabase()},d.onabort=c=>{this.log.error("abort:",c);const l=c.target;this.openDatabase(f=!0),l.onerror&&l.onerror(c),d.close()},d.onversionchange=c=>{this.log.error("onversionchange, lol?")},i(this.db=d)},s.onerror=p=>{n=!0,this.storageIsAvailable=!1,this.log.error("Error creating/accessing IndexedDB database",p),r(p)},s.onupgradeneeded=p=>{n=!0,this.log.warn("performing idb upgrade from",p.oldVersion,"to",p.newVersion);const d=p.target,f=d.result;this.stores.forEach(c=>{if(!f.objectStoreNames.contains(c.name))a(f,c);else{const h=d.transaction.objectStore(c.name);t(h,c)}})}})}static create(e){return this.INSTANCES.find(t=>t.name===e.name)??new Ma(e)}static closeDatabases(e){this.INSTANCES.forEach(t=>{if(e&&e===t)return;const a=t.db;a&&(a.onclose=()=>{},a.close())})}};Ma.INSTANCES=[];let Na=Ma;class Oi{constructor(e,t){this.storeName=t,this.log=We(["IDB",e.name,t].join("-")),this.idb=Na.create(e)}delete(e,t){const a=Array.isArray(e);return a||(e=[].concat(e)),this.getObjectStore("readwrite",s=>{const n=e.map(i=>s.delete(i));return a?n:n[0]},"",t)}clear(e){return this.getObjectStore("readwrite",t=>t.clear(),"",e)}save(e,t,a){const s=Array.isArray(e);return s||(e=[].concat(e),t=[].concat(t)),this.getObjectStore("readwrite",n=>{const i=e.map((r,p)=>n.put(t[p],r));return s?i:i[0]},"",a)}get(e,t){const a=Array.isArray(e);if(a){if(!e.length)return Promise.resolve([])}else{if(!e)return;e=[].concat(e)}return this.getObjectStore("readonly",s=>{const n=e.map(i=>s.get(i));return a?n:n[0]},"",t)}getObjectStore(e,t,a,s=this.storeName){let n;return a&&(n=performance.now(),this.log(a+": start")),this.idb.openDatabase().then(i=>new Promise((r,p)=>{const d=i.transaction([s],e,{durability:"relaxed"}),f=()=>{clearTimeout(h),p(d.error)},c=()=>{clearTimeout(h),a&&this.log(a+": end",performance.now()-n);const q=A.map(L=>L.result);r(v?q:q[0])};d.onerror=f;const l=e==="readwrite";l&&(d.oncomplete=()=>c());const h=setTimeout(()=>{this.log.error("transaction not finished",d,a)},1e4),y=t(d.objectStore(s)),v=Array.isArray(y),A=v?y:[].concat(y);if(l)return;const I=A.length;let w=I;const D=()=>{d.error||--w||c()};for(let q=0;q<I;++q){const L=A[q];L.onerror=f,L.onsuccess=D}}))}getAll(e){return this.getObjectStore("readonly",t=>t.getAll(),"",e)}}function js(){}const as=16,sa=class sa{constructor(e,t){this.db=e,this.storeName=t,this.cache={},this.getPromises=new Map,this.keysToSet=new Set,this.saveDeferred=Se(),this.keysToDelete=new Set,this.deleteDeferred=Se(),this.storage=new Oi(e,t),sa.STORAGES.length?this.useStorage=sa.STORAGES[0].useStorage:this.useStorage=!0,this.savingFreezed=!1,sa.STORAGES.push(this),this.saveThrottled=ia(async()=>{const a=this.saveDeferred;this.saveDeferred=Se();const s=this.keysToSet;if(s.size){const n=Array.from(s.values());s.clear();const i=n.map(r=>this.cache[r]);try{await this.storage.save(n,i)}catch(r){console.error("[AS]: set error:",r,n,i)}}a.resolve(),s.size&&this.saveThrottled()},as,!1),this.deleteThrottled=ia(async()=>{const a=this.deleteDeferred;this.deleteDeferred=Se();const s=this.keysToDelete;if(s.size){const n=Array.from(s.values());s.clear();try{await this.storage.delete(n)}catch(i){console.error("[AS]: delete error:",i,n)}}a.resolve(),s.size&&this.deleteThrottled()},as,!1),this.getThrottled=ia(async()=>{const a=Array.from(this.getPromises.keys());this.storage.get(a).then(s=>{for(let n=0,i=a.length;n<i;++n){const r=a[n],p=this.getPromises.get(r);p&&(p.resolve(this.cache[r]=s[n]),this.getPromises.delete(r))}},s=>{new Set(["NO_ENTRY_FOUND","STORAGE_OFFLINE"]).has(s.type)||(this.useStorage=!1,console.error("[AS]: get error:",s,a,t));for(let i=0,r=a.length;i<r;++i){const p=a[i],d=this.getPromises.get(p);d&&(d.resolve(void 0),this.getPromises.delete(p))}}).finally(()=>{this.getPromises.size&&this.getThrottled()})},as,!1)}isAvailable(){return this.useStorage}getCache(){return this.cache}getFromCache(e){return this.cache[e]}setToCache(e,t){return this.cache[e]=t}async get(e,t=!0){if(this.cache.hasOwnProperty(e)&&t)return this.getFromCache(e);if(this.useStorage){const a=this.getPromises.get(e);if(a)return a;const s=Se();return this.getPromises.set(e,s),this.getThrottled(),s}}getAll(){return this.storage.getAll().catch(()=>[])}set(e,t=!1){const a=this.useStorage&&!t&&!this.savingFreezed;for(const s in e)if(e.hasOwnProperty(s)){const n=e[s];this.setToCache(s,n),a&&(this.keysToSet.add(s),this.keysToDelete.delete(s),this.saveThrottled())}return a?this.saveDeferred:Promise.resolve()}delete(e,t=!1){return e=""+e,t||delete this.cache[e],this.useStorage&&(this.keysToSet.delete(e),this.keysToDelete.add(e),this.deleteThrottled()),this.useStorage?this.deleteDeferred:Promise.resolve()}clear(e=!1){if(!e)for(const t in this.cache)delete this.cache[t];return this.storage.clear().catch(js)}static toggleStorage(e,t){return Promise.all(this.STORAGES.map(a=>{if(a.useStorage=e,!(!oa||!t))return e?a.set(a.cache):(a.keysToSet.clear(),a.keysToDelete.clear(),a.getPromises.forEach(s=>s.resolve(void 0)),a.getPromises.clear(),a.clear(!0))})).catch(js)}static freezeSaving(e,t){this.STORAGES.forEach(a=>a.savingFreezed=!0);try{e()}catch(a){console.error("freezeSaving callback error:",a)}this.STORAGES.forEach(a=>a.savingFreezed=!1)}};sa.STORAGES=[];let Nt=sa;Fe&&(Fe.AppStorage=Nt);const Es={name:"tweb",version:7,stores:[{name:"session"},{name:"stickerSets"},{name:"users"},{name:"chats"},{name:"dialogs"},{name:"messages"}]};class Vi extends Nt{constructor(){super(Es,"session")}}const qt=new Vi;Fe.stateStorage=qt;const Us="";function qa(...o){return o.join(Us)}function Ni(o,e,t,a){const s=e.split(Us),n=s.length;let i=o;for(let p=0;p<n-1;++p){const d=s[p];i=i[d]??(i[d]={})}const r=s[n-1];t===void 0&&a?delete i[r]:i[r]=t}class qi{constructor(){this.state={},this.storage=qt}getState(){return Promise.resolve(this.state)}setByKey(e,t){Ni(this.state,e,t);const a=e.split(Us)[0];return a==="settings"&&Bt.dispatchEvent("settings_updated",{key:e,value:t,settings:this.state.settings}),this.pushToState(a,this.state[a])}pushToState(e,t,a=!0,s){return a&&(this.state[e]=t),this.setKeyValueToStorage(e,t,s)}setKeyValueToStorage(e,t=this.state[e],a){return xe.getInstance().invokeVoid("mirror",{name:"state",key:e,value:t}),this.storage.set({[e]:t},a)}}const ta=new qi,Gs=["web.telegram.org","webk.telegram.org"],Hs=Math.min(4,navigator.hardwareConcurrency??4),Oe={id:1025907,hash:"452b0359b988148995f22ff0f4229750",version:"2.0.0",versionFull:"2.0.0 (487)",build:487,langPackVersion:"4.7.3",langPack:"webk",langPackCode:"en",domains:Gs,baseDcId:2,isMainDomain:Gs.includes(location.hostname),suffix:"K",threads:Hs,cryptoWorkers:Hs};Oe.isMainDomain&&(Oe.id=2496,Oe.hash="8da85b0d5bfe62527e5b244c209159c3");function dt(o){return new Promise(e=>{setTimeout(e,o)})}class Lt{constructor(e,t,a){this.dcId=e,this.url=t,this.pending=[],this.debug=we.debug&&!1;let s=Ie.Error|Ie.Log;this.debug&&(s|=Ie.Debug),this.log=We(`HTTP-${e}`+a,s),this.log("constructor"),this.connected=!1}_send(e,t){this.debug&&this.log.debug("-> body length to send:",e.length);const a=new AbortController,s=setTimeout(()=>a.abort(),3e4);return fetch(this.url,{method:"POST",body:e,mode:t,signal:a.signal}).then(async n=>{if(n.status!==200&&!t)throw n.arrayBuffer().then(r=>{this.log.error("not 200",new TextDecoder("utf-8").decode(new Uint8Array(r)))}),n;this.setConnected(!0);const i=await n.arrayBuffer();return new Uint8Array(i)}).catch(n=>{throw this.setConnected(!1),n}).finally(()=>{clearTimeout(s)})}setConnected(e){this.connected===e||this.destroyed||(this.connected=e,we.multipleTransports&&pa.setTransportValue("https",e))}destroy(){this.setConnected(!1),this.destroyed=!0,this.pending.forEach(e=>e.reject()),this.pending.length=0}send(e){if(this.networker)return this._send(e);{const t=new Promise((a,s)=>{this.pending.push({resolve:a,reject:s,body:e})});return this.releasePending(),t}}async releasePending(){if(!this.releasing){this.releasing=!0;for(let e=0;e<this.pending.length;++e){const t=this.pending[e],{body:a,resolve:s}=t;try{const n=await this._send(a);s(n),this.pending.splice(e,1)}catch(n){this.log.error("Send plain request error:",n),await dt(5e3)}--e}this.releasing=!1}}}class ji extends ca{constructor(e,t,a){super(),this.dcId=e,this.url=t,this.debug=we.debug&&!1,this.handleOpen=()=>{this.log("opened"),this.debug&&this.log.debug("sending init packet"),this.dispatchEvent("open")},this.handleError=n=>{this.log.error("handleError",n),this.close()},this.handleClose=n=>{this.log("closed",n),this.removeListeners(),this.dispatchEvent("close")},this.handleMessage=n=>{this.debug&&this.log.debug("<-","handleMessage",n.data.byteLength),this.dispatchEvent("message",n.data)},this.send=n=>{this.debug&&this.log.debug("-> body length to send:",n.length),this.ws.send(n)};let s=Ie.Error|Ie.Log;return this.debug&&(s|=Ie.Debug),this.log=We(`WS-${e}`+a,s),this.log("constructor"),this.connect(),this}removeListeners(){this.ws&&(this.ws.removeEventListener("open",this.handleOpen),this.ws.removeEventListener("close",this.handleClose),this.ws.removeEventListener("error",this.handleError),this.ws.removeEventListener("message",this.handleMessage),this.ws=void 0)}connect(){this.ws=new WebSocket(this.url,"binary"),this.ws.binaryType="arraybuffer",this.ws.addEventListener("open",this.handleOpen),this.ws.addEventListener("close",this.handleClose),this.ws.addEventListener("error",this.handleError),this.ws.addEventListener("message",this.handleMessage)}close(){if(this.ws){this.log("close execution");try{this.ws.close()}catch{}this.handleClose()}}}function Ut(o){if(crypto&&"getRandomValues"in crypto)crypto.getRandomValues(o);else throw new Error("NO_SECURE_RANDOM");return o}class Gi{constructor(){this._process=(e,t)=>_e.invokeCryptoNew({method:"aes-ctr-process",args:[{id:this.id,data:e,operation:t}],transfer:[e.buffer]})}async init(e){this.idPromise!==void 0&&this.release();const t=new Uint8Array(64);for(Ut(t);;){const f=t[3]<<24|t[2]<<16|t[1]<<8|t[0],c=t[7]<<24|t[6]<<16|t[5]<<8|t[4];if(t[0]!==239&&f!==1145128264&&f!==1414745936&&f!==542393671&&f!==1230262351&&f!==4008636142&&f!==3722304989&&c!==0)break;Ut(t)}const a=t.slice().reverse(),s=t.slice(8,40),n=t.slice(40,56),i=a.slice(8,40),r=a.slice(40,56),p=this.idPromise=_e.invokeCrypto("aes-ctr-prepare",{encKey:s,encIv:n,decKey:i,decIv:r});this.process=async(f,c)=>(await p,this._process(f,c)),this.id=await p,this.process=this._process,t.set(e.obfuscateTag,56);const d=await this.encode(t.slice());return t.set(d.slice(56,64),56),t}encode(e){return this.process(e,"encrypt")}decode(e){return this.process(e,"decrypt")}async release(){const e=this.idPromise;if(e===void 0)return;this.id=void 0,this.idPromise=void 0;const t=await e;_e.invokeCrypto("aes-ctr-destroy",t)}destroy(){this.release()}}class Hi{constructor(){this.tag=239,this.obfuscateTag=new Uint8Array([this.tag,this.tag,this.tag,this.tag])}encodePacket(e){const t=e.byteLength>>2;let a;return t<127?a=new Uint8Array([t]):a=new Uint8Array([127,t&255,t>>8&255,t>>16&255]),a.concat(e)}readPacket(e){let t=e[0];return t>=127?(t=e[1]|e[2]<<8|e[3]<<16,e.slice(4,t<<3)):e.slice(1,t<<3)}}var Wi=new Hi,Pt=(o=>(o[o.Connected=0]="Connected",o[o.Connecting=1]="Connecting",o[o.Closed=2]="Closed",o[o.TimedOut=3]="TimedOut",o))(Pt||{});function Ue(o){const e=o.length,t=new Array(e);for(let a=0;a<e;++a)t[a]=(o[a]<16?"0":"")+(o[a]||0).toString(16);return t.join("")}class zi{constructor(e,t,a,s,n){this.Connection=e,this.dcId=t,this.url=a,this.logSuffix=s,this.retryTimeout=n,this.codec=Wi,this.obfuscation=new Gi,this.pending=[],this.debug=we.debug&&!1,this.connected=!1,this.autoReconnect=!0,this.onOpen=async()=>{this.connected=!0,we.multipleTransports&&pa.setTransportOpened("websocket");const r=await this.obfuscation.init(this.codec);this.connected&&(this.connection.send(r),this.networker&&(this.pending.length=0,this.networker.onTransportOpen()),setTimeout(()=>{this.releasePending()},0))},this.onMessage=async r=>{const p=Date.now();let d=await this.obfuscation.decode(new Uint8Array(r));if(d=this.codec.readPacket(d),this.networker){this.networker.onTransportData(d,p);return}const f=this.pending.shift();if(!f){this.debug&&this.log.debug("no pending for res:",Ue(d));return}f.resolve(d)},this.onClose=()=>{this.clear();let r,p;if(this.autoReconnect){const d=Date.now(),f=d-this.lastCloseTime;r=!isNaN(f)&&f<this.retryTimeout?this.retryTimeout-f:0,p=d+r}this.networker&&(this.networker.setConnectionStatus(Pt.Closed,p),this.pending.length=0),this.autoReconnect?(this.log("will try to reconnect after timeout:",r/1e3),this.reconnectTimeout=Ae.setTimeout(this.reconnect,r)):this.log("reconnect isn't needed")},this.reconnect=()=>{if(this.reconnectTimeout!==void 0&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),!this.connection){if(this.log("trying to reconnect..."),this.lastCloseTime=Date.now(),this.networker)this.networker.setConnectionStatus(Pt.Connecting);else for(const r of this.pending)r.bodySent&&(r.bodySent=!1);this.connect()}};let i=Ie.Error|Ie.Log;this.debug&&(i|=Ie.Debug),this.log=We(`TCP-${t}`+s,i),this.log("constructor"),this.connect()}clear(){we.multipleTransports&&this.connected&&pa.setTransportClosed("websocket"),this.connected=!1,this.connection&&(this.connection.removeEventListener("open",this.onOpen),this.connection.removeEventListener("close",this.onClose),this.connection.removeEventListener("message",this.onMessage),this.connection=void 0)}forceReconnect(){this.close(),this.reconnect()}destroy(){this.setAutoReconnect(!1),this.close(),this.obfuscation&&this.obfuscation.destroy(),this.pending.forEach(e=>{e.reject&&e.reject()}),this.pending.length=0}close(){const e=this.connection;if(e){const t=this.connected;this.clear(),t&&(e.addEventListener("message",this.onMessage),e.addEventListener("close",()=>{e.removeEventListener("message",this.onMessage)},{once:!0}),e.close())}}setAutoReconnect(e){this.autoReconnect=e,e?!this.connection&&this.reconnectTimeout===void 0&&this.reconnect():this.reconnectTimeout!==void 0&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}connect(){this.connection&&this.close(),this.connection=new this.Connection(this.dcId,this.url,this.logSuffix),this.connection.addEventListener("open",this.onOpen),this.connection.addEventListener("close",this.onClose),this.connection.addEventListener("message",this.onMessage)}changeUrl(e){this.url!==e&&(this.url=e,this.forceReconnect())}encodeBody(e){const t=this.codec.encodePacket(e);return this.obfuscation.encode(t)}send(e){this.debug&&this.log.debug("-> body length to pending:",e.length);const t=void 0;if(this.networker)this.pending.push({body:e,encoded:t}),this.releasePending();else{const a=new Promise((s,n)=>{this.pending.push({resolve:s,reject:n,body:e,encoded:t})});return this.releasePending(),a}}async releasePending(){if(!this.connected||this.releasingPending)return;this.releasingPending=!0;let e=this.pending.length,t=!1;for(let a=0;a<e;++a){const s=this.pending[a];if(!s)break;const{body:n,bodySent:i}=s;if(n&&!i){this.debug&&this.log.debug("-> body length to send:",n.length);const r=s.encoded??(s.encoded=await this.encodeBody(n));if(!this.connected)break;this.connection.send(r),s.resolve?s.bodySent=!0:(this.pending.splice(a--,1),e--),t=!0}}this.releasingPending=void 0,this.pending.length&&t&&this.releasePending()}}const Ws=we.test?"_test":"",Ki="_premium",Ji=3e3,Yi=3e3;function Fn(o){return o==="client"?"":"-1"}function En(o,e,t){const a=Fn(e),s=e!=="client"?"apiws"+Ws+(t?Ki:""):"apiws"+Ws;return`wss://${Oe.suffix.toLowerCase()}ws${o}${a}.web.telegram.org/${s}`}class _a{constructor(){this.sslSubdomains=["pluto","venus","aurora","vesta","flora"],this.dcOptions=we.test?[{id:1,host:"149.154.175.10",port:80},{id:2,host:"149.154.167.40",port:80},{id:3,host:"149.154.175.117",port:80}]:[{id:1,host:"149.154.175.50",port:80},{id:2,host:"149.154.167.50",port:80},{id:3,host:"149.154.175.100",port:80},{id:4,host:"149.154.167.91",port:80},{id:5,host:"149.154.171.5",port:80}],this.chosenServers={},this.transportSocket=(e,t,a)=>{const s=En(e,t,a),n=t==="upload"?"-U":t==="download"?"-D":"",i=t==="client"?Ji:Yi;let r;return r=ji,new zi(r,e,s,n,i)},this.transportHTTP=(e,t,a)=>{let s;{const i=Fn(t),r=this.sslSubdomains[e-1]+i,p=we.test?"apiw_test1":"apiw1";s="https://"+r+".web.telegram.org/"+p}const n=t==="upload"?"-U":t==="download"?"-D":"";return new Lt(e,s,n)}}chooseServer(e,t="client",a=we.transport,s=!0,n){this.chosenServers.hasOwnProperty(a)||(this.chosenServers[a]={client:{},download:{},upload:{}});const i=this.chosenServers[a][t];e in i||(i[e]=[]);const r=i[e];if(!r.length||!s){let p;return p=(a==="websocket"?this.transportSocket:this.transportHTTP)(e,t,n),p?(s&&r.push(p),p):(console.error("No chosenServer!",e),null)}return r[0]}static removeTransport(e,t){for(const a in e)for(const s in e[a])for(const n in e[a][s]){const i=e[a][s][n];Le(i,t)}}}class Zi extends ca{constructor(){super(!0),this.opened=new Map,this.addEventListener("change",e=>{e.get("websocket")||this.waitForWebSocket()})}async pingTransports(){const e=this.dcConfigurator??(this.dcConfigurator=new _a),t=2e3,a=this.transports={https:e.chooseServer(Oe.baseDcId,"client","https",!1),websocket:e.chooseServer(Oe.baseDcId,"client","websocket",!1)},s=Se();this.transports.https._send(new Uint8Array,"no-cors").then(()=>s.resolve(!0),()=>s.resolve(!1)),setTimeout(()=>s.resolve(!1),t);const n=Se(),i=a.websocket;i.setAutoReconnect(!1),i.connection.addEventListener("close",()=>n.resolve(!1),{once:!0}),i.connection.addEventListener("open",()=>n.resolve(!0),{once:!0}),setTimeout(()=>{n.isFulfilled||n.isRejected||(i.connection&&i.connection.close(),n.resolve(!1))},t);const[r,p]=await Promise.all([s,n]);for(const f in a)a[f].destroy();return{https:r||this.opened.get("https")>0,websocket:p||this.opened.get("websocket")>0}}async waitForWebSocket(){if(!this.pinging){for(this.pinging=!0;;){const{https:e,websocket:t}=await this.pingTransports();if((e||t)&&this.dispatchEvent("transport",t||!e?"websocket":"https"),t)break;await dt(1e4)}this.pinging=!1}}setTransportValue(e,t){let a=this.opened.get(e)||0;a+=t?1:-1,this.opened.set(e,a),this.dispatchEvent("change",this.opened)}setTransportOpened(e){return this.setTransportValue(e,!0)}setTransportClosed(e){return this.setTransportValue(e,!1)}}const $i=new Zi;var pa=$i;const Un=Se();class Qi extends Fs{constructor(){super("SERVICE"),Fe&&(Fe.serviceMessagePort=this)}}function Re(o,e){return o instanceof Promise?o.then(e):e(o)}class ce{setManagers(e){Object.assign(this,e)}}function Xi(){const o=["users","chats","dialogs"],e={};for(const t of o)e[t]=new Nt(Es,t);return e}function er(o,e,t){const a=performance.now();return(t||console).warn(Va(),"start",e),o.then(()=>{(t||console).warn(Va(),"end",e,performance.now()-a)}),o}function tr(o){return(...e)=>er(...e,o)}async function ar(o){const e=tr(We("STORAGES-LOADER")),t=Object.keys(o),a=t.map(p=>{const d=o[p].getAll();return e(d,"storage "+p)}),s={},n=await Promise.all(a);for(let p=0,d=t.length;p<d;++p)s[t[p]]=n[p];n.splice(0,t.length);const{storages:i,callback:r}=await Un;if(i.size){const p=[];for(const d of i)s[d].length=0,p.push(o[d].clear());i.clear(),await Promise.all(p).catch(Ge)}return r(),s}let sr;function nr(o){return sr??(sr=ar(o))}class ir extends ce{constructor(){super(),this.log=We("STORAGES"),this.storages=Xi()}loadStorages(){return nr(this.storages)}async loadStorage(e){return this.loadStorages().then(t=>({storage:this.storages[e],results:t[e]}))}}class rr extends ce{getState(){return this.apiManager.invokeApi("account.getPassword").then(e=>e)}updateSettings(e={}){return this.getState().then(t=>{let a,s;const n={password:null,new_settings:{_:"account.passwordInputSettings",hint:e.hint,email:e.email}};e.currentPassword?a=this.cryptoWorker.invokeCrypto("computeSRP",e.currentPassword,t,!1):a=Promise.resolve({_:"inputCheckPasswordEmpty"});const i=t.new_algo,r=new Uint8Array(i.salt1.length+32);return Ut(r),r.set(i.salt1,0),i.salt1=r,e.newPassword?s=this.cryptoWorker.invokeCrypto("computeSRP",e.newPassword,t,!0):s=Promise.resolve(new Uint8Array),Promise.all([a,s]).then(p=>(n.password=p[0],n.new_settings.new_algo=i,n.new_settings.new_password_hash=p[1],this.apiManager.invokeApi("account.updatePasswordSettings",n)))})}getInputCheckPassword(e,t){return this.cryptoWorker.invokeCrypto("computeSRP",e,t,!1)}check(e,t,a={}){return this.getInputCheckPassword(e,t).then(s=>this.apiManager.invokeApi("auth.checkPassword",{password:s},a).then(n=>(n._==="auth.authorization"&&this.apiManager.setUser(n.user),n)))}confirmPasswordEmail(e){return this.apiManager.invokeApi("account.confirmPasswordEmail",{code:e})}resendPasswordEmail(){return this.apiManager.invokeApi("account.resendPasswordEmail")}cancelPasswordEmail(){return this.apiManager.invokeApi("account.cancelPasswordEmail")}}function It(o,e,t){const a=t&&new Set(t),s=p=>Object.keys(p).filter(d=>p[d]!==void 0),n=t?p=>s(p).filter(d=>!a.has(d)):s,i=typeof o;return o&&e&&i==="object"&&i===typeof e?n(o).length===n(e).length&&n(o).every(p=>It(o[p],e[p],t)):o===e}class or extends ce{constructor(){super(...arguments),this.contexts=new Map,this.links={},this.log=We("RD",void 0,!0)}saveContext(e,t,a){[a,e]=this.getContexts(e),a||(a=new Set,this.contexts.set(e,a)),this.links[Ue(e)]=e;for(const s of a)if(It(s,t))return;a.add(t)}getReferenceByLink(e){return this.links[Ue(e)]}getContexts(e){return[this.contexts.get(e)||(e=this.getReferenceByLink(e)||e,this.contexts.get(e)),e]}getContext(e){const t=this.getContexts(e);return t[0]?[t[0].values().next().value,t[1]]:void 0}deleteContext(e,t,a){if([a,e]=this.getContexts(e),a){for(const s of a)if(It(s,t))return a.delete(s),a.size||(this.contexts.delete(e),delete this.links[Ue(e)]),!0}return!1}refreshReference(e,t){if(this.log("refreshReference: start",e.slice(),t),!t){const n=this.getContext(e);if(!n)return this.log("refreshReference: got no context for reference:",e.slice()),Promise.reject("NO_CONTEXT");[t,e]=n}let a;switch(t?.type){case"message":{a=this.appMessagesManager.reloadMessages(t.peerId,t.messageId,!0);break}case"emojiesSounds":{a=this.refreshEmojiesSoundsPromise||this.appStickersManager.getAnimatedEmojiSounds(!0).then(()=>{this.refreshEmojiesSoundsPromise=void 0});break}case"userFull":{a=Promise.resolve(this.appProfileManager.getProfile(t.userId,!0));break}case"customEmoji":{a=this.appEmojiManager.getCustomEmojiDocuments([t.docId]);break}case"attachMenuBotIcon":{a=this.appAttachMenuBotsManager.getAttachMenuBot(t.botId,!0);break}case"wallPaper":{a=this.appThemesManager.getWallPaperById(t.wallPaperId);break}case"storyItem":{a=Promise.resolve(this.appStoriesManager.getStoryById(t.peerId,t.storyId,!0));break}case"premiumPromo":{a=Promise.resolve(this.appPaymentsManager.getPremiumPromo(!0));break}case"webPage":{a=Promise.resolve(this.appWebPagesManager.getWebPage(t.url));break}case"botApp":{a=Promise.resolve(this.appAttachMenuBotsManager.getBotApp(t.botId,t.appName));break}case"chatInvite":{a=Promise.resolve(this.appChatInvitesManager.checkChatInvite(t.hash));break}default:return this.log.warn("refreshReference: not implemented context",t),Promise.reject()}const s=Ue(e);return this.log("refreshReference: refreshing reference:",s),a.then(()=>{const n=Ue(e);if(this.log("refreshReference: refreshed, reference before:",s,"after:",n),s!==n)return e;this.deleteContext(e,t);const i=this.getContext(e);if(i)return this.refreshReference(e,i[0]);throw this.log.error("refreshReference: no new context, reference before:",s,"after:",n,t),Ee("NO_NEW_CONTEXT")})}}function De(o){const e=Date.now();return o?e/1e3|0:e}const pr={Á:"A",Ă:"A",Ắ:"A",Ặ:"A",Ằ:"A",Ẳ:"A",Ẵ:"A",Ǎ:"A",Â:"A",Ấ:"A",Ậ:"A",Ầ:"A",Ẩ:"A",Ẫ:"A",Ä:"A",Ǟ:"A",Ȧ:"A",Ǡ:"A",Ạ:"A",Ȁ:"A",À:"A",Ả:"A",Ȃ:"A",Ā:"A",Ą:"A",Å:"A",Ǻ:"A",Ḁ:"A","Ⱥ":"A",Ã:"A","Ꜳ":"AA",Æ:"AE",Ǽ:"AE",Ǣ:"AE","Ꜵ":"AO","Ꜷ":"AU","Ꜹ":"AV","Ꜻ":"AV","Ꜽ":"AY",Ḃ:"B",Ḅ:"B",Ɓ:"B",Ḇ:"B","Ƀ":"B",Ƃ:"B",Ć:"C",Č:"C",Ç:"C",Ḉ:"C",Ĉ:"C",Ċ:"C",Ƈ:"C","Ȼ":"C",Ď:"D",Ḑ:"D",Ḓ:"D",Ḋ:"D",Ḍ:"D",Ɗ:"D",Ḏ:"D",ǲ:"D",ǅ:"D",Đ:"D",Ƌ:"D",Ǳ:"DZ",Ǆ:"DZ",É:"E",Ĕ:"E",Ě:"E",Ȩ:"E",Ḝ:"E",Ê:"E",Ế:"E",Ệ:"E",Ề:"E",Ể:"E",Ễ:"E",Ḙ:"E",Ë:"E",Ė:"E",Ẹ:"E",Ȅ:"E",È:"E",Ẻ:"E",Ȇ:"E",Ē:"E",Ḗ:"E",Ḕ:"E",Ę:"E","Ɇ":"E",Ẽ:"E",Ḛ:"E","Ꝫ":"ET",Ḟ:"F",Ƒ:"F",Ǵ:"G",Ğ:"G",Ǧ:"G",Ģ:"G",Ĝ:"G",Ġ:"G",Ɠ:"G",Ḡ:"G",Ǥ:"G",Ḫ:"H",Ȟ:"H",Ḩ:"H",Ĥ:"H","Ⱨ":"H",Ḧ:"H",Ḣ:"H",Ḥ:"H",Ħ:"H",Í:"I",Ĭ:"I",Ǐ:"I",Î:"I",Ï:"I",Ḯ:"I",İ:"I",Ị:"I",Ȉ:"I",Ì:"I",Ỉ:"I",Ȋ:"I",Ī:"I",Į:"I",Ɨ:"I",Ĩ:"I",Ḭ:"I","Ꝺ":"D","Ꝼ":"F","Ᵹ":"G","Ꞃ":"R","Ꞅ":"S","Ꞇ":"T","Ꝭ":"IS",Ĵ:"J","Ɉ":"J",Ḱ:"K",Ǩ:"K",Ķ:"K","Ⱪ":"K","Ꝃ":"K",Ḳ:"K",Ƙ:"K",Ḵ:"K","Ꝁ":"K","Ꝅ":"K",Ĺ:"L","Ƚ":"L",Ľ:"L",Ļ:"L",Ḽ:"L",Ḷ:"L",Ḹ:"L","Ⱡ":"L","Ꝉ":"L",Ḻ:"L",Ŀ:"L","Ɫ":"L",ǈ:"L",Ł:"L",Ǉ:"LJ",Ḿ:"M",Ṁ:"M",Ṃ:"M","Ɱ":"M",Ń:"N",Ň:"N",Ņ:"N",Ṋ:"N",Ṅ:"N",Ṇ:"N",Ǹ:"N",Ɲ:"N",Ṉ:"N","Ƞ":"N",ǋ:"N",Ñ:"N",Ǌ:"NJ",Ó:"O",Ŏ:"O",Ǒ:"O",Ô:"O",Ố:"O",Ộ:"O",Ồ:"O",Ổ:"O",Ỗ:"O",Ö:"O",Ȫ:"O",Ȯ:"O",Ȱ:"O",Ọ:"O",Ő:"O",Ȍ:"O",Ò:"O",Ỏ:"O",Ơ:"O",Ớ:"O",Ợ:"O",Ờ:"O",Ở:"O",Ỡ:"O",Ȏ:"O","Ꝋ":"O","Ꝍ":"O",Ō:"O",Ṓ:"O",Ṑ:"O",Ɵ:"O",Ǫ:"O",Ǭ:"O",Ø:"O",Ǿ:"O",Õ:"O",Ṍ:"O",Ṏ:"O",Ȭ:"O",Ƣ:"OI","Ꝏ":"OO",Ɛ:"E",Ɔ:"O",Ȣ:"OU",Ṕ:"P",Ṗ:"P","Ꝓ":"P",Ƥ:"P","Ꝕ":"P","Ᵽ":"P","Ꝑ":"P","Ꝙ":"Q","Ꝗ":"Q",Ŕ:"R",Ř:"R",Ŗ:"R",Ṙ:"R",Ṛ:"R",Ṝ:"R",Ȑ:"R",Ȓ:"R",Ṟ:"R","Ɍ":"R","Ɽ":"R","Ꜿ":"C",Ǝ:"E",Ś:"S",Ṥ:"S",Š:"S",Ṧ:"S",Ş:"S",Ŝ:"S",Ș:"S",Ṡ:"S",Ṣ:"S",Ṩ:"S","ẞ":"SS",Ť:"T",Ţ:"T",Ṱ:"T",Ț:"T","Ⱦ":"T",Ṫ:"T",Ṭ:"T",Ƭ:"T",Ṯ:"T",Ʈ:"T",Ŧ:"T","Ɐ":"A","Ꞁ":"L",Ɯ:"M","Ʌ":"V","Ꜩ":"TZ",Ú:"U",Ŭ:"U",Ǔ:"U",Û:"U",Ṷ:"U",Ü:"U",Ǘ:"U",Ǚ:"U",Ǜ:"U",Ǖ:"U",Ṳ:"U",Ụ:"U",Ű:"U",Ȕ:"U",Ù:"U",Ủ:"U",Ư:"U",Ứ:"U",Ự:"U",Ừ:"U",Ử:"U",Ữ:"U",Ȗ:"U",Ū:"U",Ṻ:"U",Ų:"U",Ů:"U",Ũ:"U",Ṹ:"U",Ṵ:"U","Ꝟ":"V",Ṿ:"V",Ʋ:"V",Ṽ:"V","Ꝡ":"VY",Ẃ:"W",Ŵ:"W",Ẅ:"W",Ẇ:"W",Ẉ:"W",Ẁ:"W","Ⱳ":"W",Ẍ:"X",Ẋ:"X",Ý:"Y",Ŷ:"Y",Ÿ:"Y",Ẏ:"Y",Ỵ:"Y",Ỳ:"Y",Ƴ:"Y",Ỷ:"Y","Ỿ":"Y",Ȳ:"Y","Ɏ":"Y",Ỹ:"Y",Ź:"Z",Ž:"Z",Ẑ:"Z","Ⱬ":"Z",Ż:"Z",Ẓ:"Z",Ȥ:"Z",Ẕ:"Z",Ƶ:"Z",Ĳ:"IJ",Œ:"OE","ᴀ":"A","ᴁ":"AE",ʙ:"B","ᴃ":"B","ᴄ":"C","ᴅ":"D","ᴇ":"E","ꜰ":"F",ɢ:"G",ʛ:"G",ʜ:"H",ɪ:"I",ʁ:"R","ᴊ":"J","ᴋ":"K",ʟ:"L","ᴌ":"L","ᴍ":"M",ɴ:"N","ᴏ":"O",ɶ:"OE","ᴐ":"O","ᴕ":"OU","ᴘ":"P",ʀ:"R","ᴎ":"N","ᴙ":"R","ꜱ":"S","ᴛ":"T","ⱻ":"E","ᴚ":"R","ᴜ":"U","ᴠ":"V","ᴡ":"W",ʏ:"Y","ᴢ":"Z",á:"a",ă:"a",ắ:"a",ặ:"a",ằ:"a",ẳ:"a",ẵ:"a",ǎ:"a",â:"a",ấ:"a",ậ:"a",ầ:"a",ẩ:"a",ẫ:"a",ä:"a",ǟ:"a",ȧ:"a",ǡ:"a",ạ:"a",ȁ:"a",à:"a",ả:"a",ȃ:"a",ā:"a",ą:"a","ᶏ":"a",ẚ:"a",å:"a",ǻ:"a",ḁ:"a","ⱥ":"a",ã:"a","ꜳ":"aa",æ:"ae",ǽ:"ae",ǣ:"ae","ꜵ":"ao","ꜷ":"au","ꜹ":"av","ꜻ":"av","ꜽ":"ay",ḃ:"b",ḅ:"b",ɓ:"b",ḇ:"b","ᵬ":"b","ᶀ":"b",ƀ:"b",ƃ:"b",ɵ:"o",ć:"c",č:"c",ç:"c",ḉ:"c",ĉ:"c",ɕ:"c",ċ:"c",ƈ:"c","ȼ":"c",ď:"d",ḑ:"d",ḓ:"d","ȡ":"d",ḋ:"d",ḍ:"d",ɗ:"d","ᶑ":"d",ḏ:"d","ᵭ":"d","ᶁ":"d",đ:"d",ɖ:"d",ƌ:"d",ı:"i","ȷ":"j",ɟ:"j",ʄ:"j",ǳ:"dz",ǆ:"dz",é:"e",ĕ:"e",ě:"e",ȩ:"e",ḝ:"e",ê:"e",ế:"e",ệ:"e",ề:"e",ể:"e",ễ:"e",ḙ:"e",ë:"e",ė:"e",ẹ:"e",ȅ:"e",è:"e",ẻ:"e",ȇ:"e",ē:"e",ḗ:"e",ḕ:"e","ⱸ":"e",ę:"e","ᶒ":"e","ɇ":"e",ẽ:"e",ḛ:"e","ꝫ":"et",ḟ:"f",ƒ:"f","ᵮ":"f","ᶂ":"f",ǵ:"g",ğ:"g",ǧ:"g",ģ:"g",ĝ:"g",ġ:"g",ɠ:"g",ḡ:"g","ᶃ":"g",ǥ:"g",ḫ:"h",ȟ:"h",ḩ:"h",ĥ:"h","ⱨ":"h",ḧ:"h",ḣ:"h",ḥ:"h",ɦ:"h",ẖ:"h",ħ:"h",ƕ:"hv",í:"i",ĭ:"i",ǐ:"i",î:"i",ï:"i",ḯ:"i",ị:"i",ȉ:"i",ì:"i",ỉ:"i",ȋ:"i",ī:"i",į:"i","ᶖ":"i",ɨ:"i",ĩ:"i",ḭ:"i","ꝺ":"d","ꝼ":"f","ᵹ":"g","ꞃ":"r","ꞅ":"s","ꞇ":"t","ꝭ":"is",ǰ:"j",ĵ:"j",ʝ:"j","ɉ":"j",ḱ:"k",ǩ:"k",ķ:"k","ⱪ":"k","ꝃ":"k",ḳ:"k",ƙ:"k",ḵ:"k","ᶄ":"k","ꝁ":"k","ꝅ":"k",ĺ:"l",ƚ:"l",ɬ:"l",ľ:"l",ļ:"l",ḽ:"l","ȴ":"l",ḷ:"l",ḹ:"l","ⱡ":"l","ꝉ":"l",ḻ:"l",ŀ:"l",ɫ:"l","ᶅ":"l",ɭ:"l",ł:"l",ǉ:"lj",ſ:"s","ẜ":"s",ẛ:"s","ẝ":"s",ḿ:"m",ṁ:"m",ṃ:"m",ɱ:"m","ᵯ":"m","ᶆ":"m",ń:"n",ň:"n",ņ:"n",ṋ:"n","ȵ":"n",ṅ:"n",ṇ:"n",ǹ:"n",ɲ:"n",ṉ:"n",ƞ:"n","ᵰ":"n","ᶇ":"n",ɳ:"n",ñ:"n",ǌ:"nj",ó:"o",ŏ:"o",ǒ:"o",ô:"o",ố:"o",ộ:"o",ồ:"o",ổ:"o",ỗ:"o",ö:"o",ȫ:"o",ȯ:"o",ȱ:"o",ọ:"o",ő:"o",ȍ:"o",ò:"o",ỏ:"o",ơ:"o",ớ:"o",ợ:"o",ờ:"o",ở:"o",ỡ:"o",ȏ:"o","ꝋ":"o","ꝍ":"o","ⱺ":"o",ō:"o",ṓ:"o",ṑ:"o",ǫ:"o",ǭ:"o",ø:"o",ǿ:"o",õ:"o",ṍ:"o",ṏ:"o",ȭ:"o",ƣ:"oi","ꝏ":"oo",ɛ:"e","ᶓ":"e",ɔ:"o","ᶗ":"o",ȣ:"ou",ṕ:"p",ṗ:"p","ꝓ":"p",ƥ:"p","ᵱ":"p","ᶈ":"p","ꝕ":"p","ᵽ":"p","ꝑ":"p","ꝙ":"q",ʠ:"q","ɋ":"q","ꝗ":"q",ŕ:"r",ř:"r",ŗ:"r",ṙ:"r",ṛ:"r",ṝ:"r",ȑ:"r",ɾ:"r","ᵳ":"r",ȓ:"r",ṟ:"r",ɼ:"r","ᵲ":"r","ᶉ":"r","ɍ":"r",ɽ:"r","ↄ":"c","ꜿ":"c",ɘ:"e",ɿ:"r",ś:"s",ṥ:"s",š:"s",ṧ:"s",ş:"s",ŝ:"s",ș:"s",ṡ:"s",ṣ:"s",ṩ:"s",ʂ:"s","ᵴ":"s","ᶊ":"s","ȿ":"s",ɡ:"g",ß:"ss","ᴑ":"o","ᴓ":"o","ᴝ":"u",ť:"t",ţ:"t",ṱ:"t",ț:"t","ȶ":"t",ẗ:"t","ⱦ":"t",ṫ:"t",ṭ:"t",ƭ:"t",ṯ:"t","ᵵ":"t",ƫ:"t",ʈ:"t",ŧ:"t","ᵺ":"th",ɐ:"a","ᴂ":"ae",ǝ:"e","ᵷ":"g",ɥ:"h","ʮ":"h","ʯ":"h","ᴉ":"i",ʞ:"k","ꞁ":"l",ɯ:"m",ɰ:"m","ᴔ":"oe",ɹ:"r",ɻ:"r",ɺ:"r","ⱹ":"r",ʇ:"t",ʌ:"v",ʍ:"w",ʎ:"y","ꜩ":"tz",ú:"u",ŭ:"u",ǔ:"u",û:"u",ṷ:"u",ü:"u",ǘ:"u",ǚ:"u",ǜ:"u",ǖ:"u",ṳ:"u",ụ:"u",ű:"u",ȕ:"u",ù:"u",ủ:"u",ư:"u",ứ:"u",ự:"u",ừ:"u",ử:"u",ữ:"u",ȗ:"u",ū:"u",ṻ:"u",ų:"u","ᶙ":"u",ů:"u",ũ:"u",ṹ:"u",ṵ:"u","ᵫ":"ue","ꝸ":"um","ⱴ":"v","ꝟ":"v",ṿ:"v",ʋ:"v","ᶌ":"v","ⱱ":"v",ṽ:"v","ꝡ":"vy",ẃ:"w",ŵ:"w",ẅ:"w",ẇ:"w",ẉ:"w",ẁ:"w","ⱳ":"w",ẘ:"w",ẍ:"x",ẋ:"x","ᶍ":"x",ý:"y",ŷ:"y",ÿ:"y",ẏ:"y",ỵ:"y",ỳ:"y",ƴ:"y",ỷ:"y","ỿ":"y",ȳ:"y",ẙ:"y","ɏ":"y",ỹ:"y",ź:"z",ž:"z",ẑ:"z",ʑ:"z","ⱬ":"z",ż:"z",ẓ:"z",ȥ:"z",ẕ:"z","ᵶ":"z","ᶎ":"z",ʐ:"z",ƶ:"z","ɀ":"z",ﬀ:"ff",ﬃ:"ffi",ﬄ:"ffl",ﬁ:"fi",ﬂ:"fl",ĳ:"ij",œ:"oe",ﬆ:"st","ₐ":"a","ₑ":"e","ᵢ":"i","ⱼ":"j","ₒ":"o","ᵣ":"r","ᵤ":"u","ᵥ":"v","ₓ":"x",Ё:"YO",Й:"I",Ц:"TS",У:"U",К:"K",Е:"E",Н:"N",Г:"G",Ш:"SH",Щ:"SCH",З:"Z",Х:"H",Ъ:"",ё:"yo",й:"i",ц:"ts",у:"u",к:"k",е:"e",н:"n",г:"g",ш:"sh",щ:"sch",з:"z",х:"h",ъ:"",Ф:"F",Ы:"I",В:"V",А:"A",П:"P",Р:"R",О:"O",Л:"L",Д:"D",Ж:"ZH",Э:"E",ф:"f",ы:"i",в:"v",а:"a",п:"p",р:"r",о:"o",л:"l",д:"d",ж:"zh",э:"e",Я:"Ya",Ч:"CH",С:"S",М:"M",И:"I",Т:"T",Ь:"",Б:"B",Ю:"YU",я:"ya",ч:"ch",с:"s",м:"m",и:"i",т:"t",ь:"",б:"b",ю:"yu"},dr=/[`~!@#$%^&*()\-_=+\[\]\\|{}'";:\/?.>,<]+/g,fr=/^\s+|\s$/g,cr={й:"q",ц:"w",у:"e",к:"r",е:"t",н:"y",г:"u",ш:"i",щ:"o",з:"p",х:"[",ъ:"]",ф:"a",ы:"s",в:"d",а:"f",п:"g",р:"h",о:"j",л:"k",д:"l",ж:";",э:"'",я:"z",ч:"x",с:"c",м:"v",и:"b",т:"n",ь:"m",б:",",ю:".",".":"/"};function lr(o){return o.replace(dr,"").replace(fr,"")}function gr(o){return o.toLowerCase().replace(/[\wа-я]/g,e=>cr[e]??e)}function mr(o){return o.replace(/[^A-Za-z0-9]/g,e=>pr[e]??e)}function hr(o,e=!0){return Tn(o,{clearBadChars:!0,latinize:e,ignoreCase:!0})}function Tn(o="",e={}){const t=e.includeTag&&o.charAt(0)==="%",a=o;return e.clearBadChars&&(o=lr(o)),e.latinize&&(o=mr(o)),e.ignoreCase&&(o=o.toLowerCase()),t&&(o="%"+o),e.latinize&&(o+=""+gr(a)),o}function ur(o){return o.reduce((e,t)=>(e.push(...t),e),[])}class Ya{constructor(e={}){this.options=e,this.fullTexts=new Map,e.minChars??(e.minChars=0)}indexObject(e,t){if(t.trim()&&(t=this.processSearchText(t)),!t)return this.fullTexts.delete(e),!1;this.fullTexts.set(e,t)}_search(e,t=e.split(" ").filter(a=>a.trim())){const a=[],s=this.fullTexts,n=t.length;return s.forEach((i,r)=>{let p=!0,d=0;for(let f=0;f<n;++f){const c=t[f],l=i.indexOf(c),h=f===n-1;if(l===-1||this.options.fullWords&&!h&&i[l+c.length]!==" "||l!==0&&i[l-1]!==" "){p=!1;break}d+=c.length}if(p){d+=n-1;const f=i.length;(this.options.minChars<=d||f<=d)&&a.push({fullText:i,fullTextLength:f,what:r,foundChars:d})}}),a}search(e){e=this.processSearchText(e);const a=e.split("").map(i=>this._search(i)),s=ur(a);return s.sort((i,r)=>i.fullTextLength-r.fullTextLength||r.foundChars-i.foundChars),new Set(s.map(i=>i.what))}processSearchText(e){return this.options?Tn(e,this.options):e}}function yr(o,e){const t=o.length;if(t!==e.length){const s=t-e.length;return s<0?-1:s>0?1:0}const a=15;for(let s=0;s<t;s+=a){const n=+o.slice(s,s+a),i=+e.slice(s,s+a),r=n-i;if(r)return r}return 0}function zs(o,e){if(o.toExponential){const t=o-e;return t<0?-1:t>0?1:0}return yr(o,e)}var Ne=(o=>(o[o.None=0]="None",o[o.Top=1]="Top",o[o.Bottom=2]="Bottom",o[o.Both=3]="Both",o))(Ne||{});class da{constructor(){this.sliceConstructor=da.getSliceConstructor(this);const e=this.constructSlice();this.slices=[e]}static getSliceConstructor(e){return class extends Array{constructor(){super(...arguments),this.end=0}isEnd(a){if((this.end&a)===a)return!0;let s=!1;if(a===1){const n=e.last;s=n.end&a?this.includes(n[n.length-1]):!1}else if(a===2){const n=e.first;s=n.end&a?this.includes(n[0]):!1}else if(a===3)return this.isEnd(1)&&this.isEnd(2);return s&&this.setEnd(a),s}getEnds(){return{top:this.isEnd(1),bottom:this.isEnd(2),both:this.isEnd(3)}}setEnd(a){this.end|=a}unsetEnd(a){this.end&=~a}splice(a,s,...n){const i=super.splice(a,s,...n);if(!this.length){const r=e.slices,p=r.indexOf(this);p!==-1&&(r.length===1?this.unsetEnd(3):r.splice(p,1))}return i}}}constructSlice(...e){const t=new this.sliceConstructor(e.length);for(let a=0,s=e.length;a<s;++a)t[a]=e[a];return t}insertSlice(e,t=!0){if(!e.length)return;const a=this.slices[0];if(!a.length)return a.push(...e),a;const s=e[e.length-1],n=e[0];let i,r=-1,p=-1,d=0;for(;d<this.slices.length&&(i=this.slices[d],r=i.indexOf(s),p=i.indexOf(n),!(p!==-1&&r!==-1));++d)if(p!==-1||r!==-1)break;if(!(p!==-1&&r!==-1))if(p!==-1){const f=e.slice(i.length-p);i.push(...f)}else if(r!==-1){const f=e.slice(0,e.length-r-1);i.unshift(...f)}else{let f=0;for(const c=this.slices.length;f<c;++f){const l=this.slices[f];if(zs(e[0],l[0])===1)break}this.slices.splice(f,0,this.constructSlice(...e)),d=f}if(t)return this.flatten(d)}flatten(e){if(this.slices.length>=2)for(let t=0,a=this.slices.length;t<a-1;++t){const s=this.slices[t],n=this.slices[t+1];s.indexOf(n[0])!==-1&&(s.setEnd(n.end),this.slices.splice(t+1,1),t<e&&--e,--a,--t,this.insertSlice(n,!1))}return this.slices[e]}get first(){return this.slices[0]}get last(){return this.slices[this.slices.length-1]}get slice(){return this.first}get length(){return this.slice.length}findSlice(e){for(let t=0,a=this.slices.length;t<a;++t){const s=this.slices[t],n=s.indexOf(e);if(n!==-1)return{slice:s,index:n}}}findOffsetInSlice(e,t){for(let a=0;a<t.length;++a)if(zs(e,t[a])>=0)return{slice:t,offset:e===t[a]?a+1:a}}findSliceOffset(e){let t;for(let a=0;a<this.slices.length;++a){t=this.slices[a];const s=this.findOffsetInSlice(e,t);if(s)return s}if(t?.isEnd(1))return{slice:t,offset:t.length}}sliceMe(e,t,a){let s=this.slice,n=0,i=0;if(e){const y=this.findSliceOffset(e);if(!y)return;s=y.slice,n=i=y.offset}else if(!s.isEnd(2))return;const r=Math.max(i+t,0),p=i+t+a,d=s.slice(r,p),f=t<0?a+t:a,c=Math.abs(t),l=s.length-i>=f||(s.isEnd(1)?(d.setEnd(1),!0):!1),h=i-c>=0||(s.isEnd(2)?(d.setEnd(2),!0):!1);return{slice:d,offsetIdOffset:n,fulfilled:0|(l&&h?3:(l?1:0)|(h?2:0))}}unshift(...e){let t=this.first;t.length?t.isEnd(2)||(t=this.constructSlice(),t.setEnd(2),this.slices.unshift(t)):t.setEnd(2),t.unshift(...e)}push(...e){let t=this.last;t.length?t.isEnd(1)||(t=this.constructSlice(),t.setEnd(1),this.slices.push(t)):t.setEnd(1),t.push(...e)}delete(e){const t=this.findSlice(e);return t?(t.slice.splice(t.index,1),!0):!1}deleteSlice(e){Le(this.slices,e)}toJSON(){const t={slices:this.slices.map(a=>({values:a.slice(),isEnd:a.getEnds()}))};return JSON.stringify(t)}static fromJSON(e){const t=JSON.parse(e),a=new da;return t.slices.forEach(s=>{const n=a.insertSlice(s.values)||a.first;s.isEnd.top&&n.setEnd(1),s.isEnd.bottom&&n.setEnd(2)}),a}}Fe&&(Fe.SlicedArray=da);function ut(o,e){for(let t=o.length,a=t-1;a>=0;--a)e(o[a],a,o)}function jt(o,e,t,a,s){if(!t)t=r=>r;else if(typeof t!="function"){const r=t;t=p=>p[r]}s||(s=(r,p)=>r-p);const n=t(e);if(a??(a=o.indexOf(e)),a!==-1){const r=o[a-1],p=o[a+1];if((!r||s(t(r),n)>=0)&&(!p||s(t(p),n)<=0))return a;o.splice(a,1)}const i=o.length;if(!i||s(n,t(o[i-1]))<=0)return o.push(e)-1;if(s(n,t(o[0]))>=0)return o.unshift(e),0;for(let r=0;r<i;r++)if(s(n,t(o[r]))>0)return o.splice(r,0,e),r;return console.error("wtf",o,e),o.indexOf(e)}function Gt(o,e){if(!o)return e;for(var t in o)e.hasOwnProperty(t)||delete o[t];for(var t in e)o[t]=e[t];return o}function _r(o,e){if(o!==void 0)return o=+o.toFixed(0),e?o<ba?o:o%ba:o}function ae(o){return _r(o,!0)}function ma(o=0){return`index_${o}`}function Xe(o){return typeof o=="object"&&o!==null}function us(o,e=ma(o.folder_id)){return o?.[e]}function He(o){if(o!==void 0&&(o.isPeerId&&o.isPeerId()))return o;if(Xe(o)){const a=o.user_id;if(a!==void 0)return a.toPeerId(!1);const s=o.channel_id||o.chat_id;return s!==void 0?s.toPeerId(!0):ht}else if(!o)return ht;const e=o.charAt(0)==="u",t=o.substr(1).split("_");return e?t[0].toPeerId():(t[0]||"").toPeerId(!0)}function Pr(o){const e=[o.fromId,o.viaBotId,o.fwdFromId],t=o.media;if(t){const p=[t.user_id,...t.winners||[]];e.push(...p.filter(Boolean).map(l=>l.toPeerId()));const d=[...t.channels||[],t.channel_id];e.push(...d.filter(Boolean).map(l=>l.toPeerId(!0)));const f=[...t.results?.recent_voters||[],t.peer],c=t?.webpage;if(c){const l=c.attributes?.find(h=>h._==="webPageAttributeStory");f.push(l?.peer)}e.push(...f.filter(Boolean).map(l=>He(l)))}const a=o.reactions?.recent_reactions;a?.length&&e.push(...a.map(p=>He(p.peer_id)));const s=o.action;if(s){const p=[...s.users||[],s.user_id,s.inviter_id];e.push(...p.filter(Boolean).map(c=>c.toPeerId()));const d=[s.channel_id,s.chat_id];e.push(...d.filter(Boolean).map(c=>c.toPeerId(!0)));const f=[s.boost_peer,...s.peers||[],s.from_id,s.to_id];e.push(...f.filter(Boolean).map(c=>He(c)))}const n=o.replies?.recent_repliers;n?.length&&e.push(...n.map(p=>He(p)));const i=o.saved_peer_id;i&&e.push(He(i));const r=o.fwd_from;return r&&e.push(...[r.from_id,r.saved_from_id,r.saved_from_peer].filter(Boolean).map(p=>He(p))),new Set(e.filter(Boolean))}function Zt(o,e){const t={writable:!0,configurable:!0},a={};e.forEach(s=>{o.hasOwnProperty(s)||(a[s]=t)}),Object.defineProperties(o,a)}function Ks(o,e,t){return o[e]=t}function Ye(o){return o?._==="forumTopic"}function Ze(o){return o?._==="savedDialog"}function mt(o){return o?._==="dialog"}function kt(o){let e;return mt(o)?e=o.peerId:Ye(o)?e=o.id:Ze(o)&&(e=o.savedPeerId),e}function vr(o){if(!mt(o))return kt(o)}var ys=(o=>(o[o.Folder=0]="Folder",o[o.Forum=1]="Forum",o[o.Saved=2]="Saved",o))(ys||{});const At=void 0;class Mr extends ce{constructor(){super(...arguments),this.log=We("DIALOGS"),this.clear=(e=!1)=>{if(e){this.allDialogsLoaded={},this.pinnedOrders={};for(const t of je)this.pinnedOrders[t]=[]}else{this.storage.clear(),this.allDialogsLoaded={},this.saveAllDialogsLoaded(),this.pinnedOrders=Object.assign({},this.pinnedOrders);for(const t of je)this.resetPinnedOrder(t);this.savePinnedOrders()}this.forumTopics=new Map,this.savedDialogsPromises=new Map,this.folders={},this.dialogsOffsetDate={},this.dialogsNum=0,this.dialogsIndex=this.createSearchIndex(),this.cachedResults={query:"",count:0,dialogs:[],folderId:0},this.savedDialogs={}},this.onUpdateFolderPeers=e=>{e.folder_peers.forEach(a=>{const{folder_id:s,peer:n}=a,i=this.appPeersManager.getPeerId(n),r=this.dropDialog(i)[0];r&&(r.pFlags?.pinned&&this.handleDialogUnpinning(r,s),r.folder_id=s,this.generateIndexForDialog(r),this.pushDialog({dialog:r})),this.appMessagesManager.scheduleHandleNewDialogs(i,r)})},this.onUpdateDialogPinned=e=>{const t=this.appPeersManager.getPeerId(e.peer.peer);let a,s;e._==="updateDialogPinned"?(s=e.folder_id??ot,a=this.getDialogOnly(t)):(s=this.appPeersManager.peerId,a=this.getAnyDialog(this.appPeersManager.peerId,t)),this.handleDialogTogglePinned(a,e.pFlags.pinned,s)},this.onUpdateChannelPinnedTopic=e=>{const t=e.channel_id,a=t.toPeerId(!0),s=this.appMessagesIdsManager.generateMessageId(e.topic_id,t),n=this.getForumTopic(a,s);n&&this.handleDialogTogglePinned(n,e.pFlags.pinned,this.getFilterIdForForum(n))},this.onUpdatePinnedDialogs=e=>{const t=e._==="updatePinnedSavedDialogs";let a;if(t?a=this.appPeersManager.peerId:a=e.folder_id??ot,e.order)this.handleDialogsPinned(a,e.order.map(s=>this.appPeersManager.getPeerId(s.peer)));else{let s;t?s=this.apiManager.invokeApi("messages.getPinnedSavedDialogs"):s=this.apiManager.invokeApi("messages.getPinnedDialogs",{folder_id:a}),s.then(n=>{this.applyDialogs(n),this.handleDialogsPinned(a,n.dialogs.map(i=>i.peerId))})}},this.onUpdateChannelPinnedTopics=async e=>{const t=e.channel_id,a=t.toPeerId(!0);if(!this.forumTopics.get(a))return;const n=a;if(e.order){const i=e.order.map(r=>this.appMessagesIdsManager.generateMessageId(r,t));this.handleDialogsPinned(n,i)}else{const i=await this.apiManager.getLimit("topicPin",!0),r=this.apiManager.invokeApi("channels.getForumTopics",{channel:this.appChatsManager.getChannelInput(t),limit:i,offset_date:0,offset_id:0,offset_topic:0}),f=(await this.processTopics(a,r)).topics.filter(c=>c.pFlags.pinned);this.handleDialogsPinned(n,f.map(c=>c.id))}},this.onUpdateChannelViewForumAsMessages=e=>{const t=e.channel_id.toPeerId(!0),a=this.getDialogOnly(t);a&&(e.enabled?a.pFlags.view_forum_as_messages=!0:delete a.pFlags.view_forum_as_messages,this.setDialogToState(a))}}after(){this.clear(!0);const e=t=>{const a=this.getCachedDialogs(!1);for(let s=0;s<a.length;++s)this.processDialogForFilter(a[s],t)};return this.rootScope.addEventListener("filter_order",()=>{const t=this.getCachedDialogs(!1);for(const a in this.folders)this.isVirtualFilter(+a)||delete this.folders[a];for(let a=0;a<t.length;++a){const s=t[a];this.processDialogForFilters(s)}}),this.rootScope.addEventListener("filter_update",e),this.rootScope.addEventListener("filter_new",e),this.rootScope.addEventListener("filter_delete",t=>{const a=this.getCachedDialogs(!1),s=this.getDialogIndexKeyByFilterId(t.id);for(let n=0;n<a.length;++n){const i=a[n];delete i[s]}delete this.folders[t.id]}),this.rootScope.addEventListener("dialog_notify_settings",t=>{this.processChangedUnreadOrUnmuted(t.peerId)}),this.rootScope.addEventListener("chat_update",t=>{const a=t.toPeerId(!0),s=this.getDialogOnly(a);s&&!this.canSaveDialog(a,s)&&this.dropDialogOnDeletion(a)}),this.rootScope.addEventListener("chat_toggle_forum",({chatId:t,enabled:a})=>{const s=t.toPeerId(!0);a||this.flushForumTopicsCache(s),this.processChangedUnreadOrUnmuted(s)}),this.rootScope.addEventListener("user_auth",()=>{this.rootScope.addEventListener("premium_toggle",()=>{[ot,Ct].forEach(t=>{this.apiUpdatesManager.processLocalUpdate({_:"updatePinnedDialogs",folder_id:t})})})}),this.apiUpdatesManager.addMultipleEventsListeners({updateFolderPeers:this.onUpdateFolderPeers,updateDialogPinned:this.onUpdateDialogPinned,updateSavedDialogPinned:this.onUpdateDialogPinned,updateChannelPinnedTopic:this.onUpdateChannelPinnedTopic,updatePinnedDialogs:this.onUpdatePinnedDialogs,updatePinnedSavedDialogs:this.onUpdatePinnedDialogs,updateChannelPinnedTopics:this.onUpdateChannelPinnedTopics,updateChannelViewForumAsMessages:this.onUpdateChannelViewForumAsMessages}),Promise.all([this.appStateManager.getState(),this.appStoragesManager.loadStorage("dialogs")]).then(([t,{results:a,storage:s}])=>{this.storage=s,this.dialogs=this.storage.getCache();for(const n of je){const i=t.pinnedOrders[n];if(!i)continue;const r=this.getPinnedOrders(n);r.splice(0,r.length,...i)}a.length&&Nt.freezeSaving(this.setDialogsFromState.bind(this,a),["chats","dialogs","messages","users"]),this.allDialogsLoaded=t.allDialogsLoaded||{},a.length&&this.appDraftsManager.addMissedDialogs()})}indexMyDialog(){const e=this.appUsersManager.getSelf().id.toPeerId(!1);if(this.getDialogOnly(e)){const a=this.appPeersManager.getPeerSearchText(e);this.dialogsIndex.indexObject(e,a)}}setDialogsFromState(e){for(let t=0,a=e.length;t<a;++t){const s=e[t];if(!s)continue;s.top_message=ae(s.top_message),s.topMessage&&this.appMessagesManager.saveMessages([s.topMessage]);for(let i=0;i<=21;++i){const r=`index_${i}`;delete s[r]}this.saveDialog({dialog:s,ignoreOffsetDate:!0}),this.appMessagesManager.getMessageByPeer(s.peerId,s.top_message)||this.appMessagesManager.reloadConversation(s.peerId)}}isDialogsLoaded(e){return!!this.allDialogsLoaded[e]}setDialogsLoaded(e,t){const a=this.isVirtualFilter(e);e===At&&t?(this.allDialogsLoaded[ot]=t,this.allDialogsLoaded[Ct]=t):(a&&Zt(this.allDialogsLoaded,[e]),this.allDialogsLoaded[e]=t),!a&&(Array.from(je).every(s=>this.allDialogsLoaded[s])&&(this.allDialogsLoaded[At]=!0),this.saveAllDialogsLoaded())}saveAllDialogsLoaded(){this.appStateManager.pushToState("allDialogsLoaded",this.allDialogsLoaded)}createSearchIndex(){return new Ya({clearBadChars:!0,ignoreCase:!0,latinize:!0,includeTag:!0})}handleDialogUnpinning(e,t){delete e.pFlags.pinned,Le(this.getPinnedOrders(t),kt(e)),this.savePinnedOrders()}savePinnedOrders(){this.appStateManager.pushToState("pinnedOrders",this.pinnedOrders)}resetPinnedOrder(e){this.getPinnedOrders(e).length=0}getPinnedOrders(e){let t=this.pinnedOrders[e];return!t&&this.isVirtualFilter(e)&&(Zt(this.pinnedOrders,[e]),t=this.pinnedOrders[e]=[]),t}isDialogPinned(e,t){const a=this.filtersStorage.getFilter(t);let s;return a?s=a.pinnedPeerIds.indexOf(e)!==-1:s=!!this.getDialogOnly(e).pFlags.pinned,s}getOffsetDate(e){const t=this.dialogsOffsetDate[e]||0;return e===At&&!t?Math.min(...Array.from(je).sort((a,s)=>a-s)):t}generateFolder(e){const t={dialogs:[],id:e,count:null,unreadMessagesCount:0,unreadPeerIds:new Set,unreadUnmutedPeerIds:new Set};return Zt(t,["dispatchUnreadTimeout"]),t}getFolder(e){var t;return(t=this.folders)[e]??(t[e]=this.generateFolder(e))}isVirtualFilter(e){return this.getFilterType(e)!==0}getFilterType(e){return e&&e<0?1:e===this.appPeersManager.peerId?2:0}isFilterIdForForum(e){return e&&e<0}getFilterIdForForum(e){return e.peerId}getFolderDialogs(e,t=!0){if(e===At)return this.getCachedDialogs(t);const a=this.getFolder(e),s=this.getFilterType(e);return s===1?t?a.dialogs.filter(n=>!n.pFlags.hidden):a.dialogs:s===2?a.dialogs:t?a.dialogs.filter(n=>n.migratedTo===void 0):a.dialogs}getNextDialog(e,t,a){const s=this.getFolderDialogs(a,!0);let n;if(!e)t&&(n=s[0]);else{const i=s.findIndex(r=>r.peerId===e);if(i!==-1){const r=t?i+1:i-1;n=s[r]}}return n}getDialogIndexKeyByFilterId(e){if(this.isVirtualFilter(e))return ma();if(je.has(e))return ma(e);const t=this.filtersStorage.getFilter(e);return ma(t.localId)}isDialogUnmuted(e){return!this.appNotificationsManager.isPeerLocalMuted({peerId:e.peerId,respectType:!0,threadId:Ye(e)?e.id:void 0})}getFolderUnreadCount(e){const t=this.getFolder(e);return{unreadUnmutedCount:t.unreadUnmutedPeerIds.size,unreadCount:t.unreadPeerIds.size}}getCachedDialogs(e){const t=Array.from(je).map(a=>this.getFolderDialogs(a,e));return[].concat(...t)}setDialogIndexInFilter(e,t,a){let s;const n=this.isVirtualFilter(this.getDialogFilterId(e)),i=n||je.has(a.id);if(this.filtersStorage.testDialogForFilter(e,a)){const r=n?this.getPinnedOrdersByDialog(e):a.pinnedPeerIds,p=kt(e),d=r.indexOf(p);d!==-1?s=this.generateDialogIndex(this.generateDialogPinnedDateByIndex(r.length-1-d),!0):e.pFlags?.pinned||i?s=this.generateIndexForDialog(e,!0,void 0,!i):s=us(e)??this.generateIndexForDialog(e,!0)}return Ks(e,t,s)}getDialog(e,t,a,s=!0){const n=[];a&&(t=e),t===void 0?n.push(...Array.from(je).map(r=>this.getFolder(r).dialogs)):n.push(this.getFolderDialogs(t,!1));let i;a?this.isFilterIdForForum(t)?i=r=>r.id===a:i=r=>r.savedPeerId===a:i=r=>r.peerId===e;for(const r of n){let p=0,d=0;for(let f=r.length;p<f;++p){const c=r[p];if(i(c))return[c,p-d];s&&(c.pFlags.hidden||c.migratedTo!==void 0)&&++d}}return[]}getDialogOnly(e){return this.dialogs[e]}getAnyDialog(e,t){return t?e.isUser()?this.savedDialogs[t]:this.getForumTopic(e,t):this.dialogs[e]}getDialogIndex(e,t,a){const s=Xe(e)?e:this.getAnyDialog(e,a);return us(s,t)}generateDialogIndex(e,t){return e??(e=De(!0)+this.timeManager.getServerTimeOffset()),e*65536+(t?0:++this.dialogsNum&65535)}getDialogFilterId(e){let t;return Ye(e)?t=this.getFilterIdForForum(e):Ze(e)?t=e.peerId:t=e.folder_id,t}getPinnedOrdersByDialog(e){return this.getPinnedOrders(this.getDialogFilterId(e))}processDialogForFilters(e,t){if(!mt(e)){this.processDialogForFilter(e,void 0,t);return}const a=this.filtersStorage.getFilters();for(const s in a){const n=a[s];this.processDialogForFilter(e,n,t)}}processDialogForFilter(e,t,a){const s=t?.id??this.getDialogFilterId(e),n=this.getDialogIndexKeyByFilterId(s),i=this.getFolder(s),r=i.dialogs,d={dialog:y=>y.peerId===e.peerId,forumTopic:y=>y.id===e.id,savedDialog:y=>y.savedPeerId===e.savedPeerId}[e._],f=r.findIndex(d),c=r[f],l=this.getDialogIndex(c,n);a&&!this.isVirtualFilter(s)&&s>Ct&&(a=void 0);const h=a?void 0:this.setDialogIndexInFilter(e,n,t);return l===h?!1:(!!l!=!!h&&this.prepareFolderUnreadCountModifyingByDialog(s,e,!!h),f!==-1&&(r.splice(f,1),i.count!==null&&--i.count),h&&(jt(r,e,y=>this.getDialogIndex(y,n),-1),f===-1&&i.count!==null&&++i.count),!0)}prepareDialogUnreadCountModifying(e,t){if(Ze(e))return()=>{};const a=Ye(e),s=[],n=a?this.getFilterIdForForum(e):e.folder_id;if(s.push(this.prepareFolderUnreadCountModifyingByDialog(n,e,t)),!a){const i=this.filtersStorage.getFilters();for(const r in i){const p=i[r];this.filtersStorage.testDialogForFilter(e,p)&&s.push(this.prepareFolderUnreadCountModifyingByDialog(p.id,e,t))}}return()=>!t&&s.forEach(i=>i())}prepareFolderUnreadCountModifyingByDialog(e,t,a){if(Ze(t))return a!==void 0?void 0:()=>{};const s=this.appMessagesManager.getDialogUnreadCount(t),n=this.isDialogUnmuted(t);if(a!==void 0){const i=a?s:-s;this.modifyFolderUnreadCount(e,i,a&&!!s,a&&!!s&&n,t);return}return()=>{const i=this.appMessagesManager.getDialogUnreadCount(t),r=this.isDialogUnmuted(t),p=i-s;this.modifyFolderUnreadCount(e,p,!!i,i&&r,t)}}modifyFolderUnreadCount(e,t,a,s,n){const{peerId:i}=n,r=this.appPeersManager.isForum(i),p=Ye(n);if(r&&!p){const c=this.getForumUnreadCount(i);if(c instanceof Promise){c.then(({count:l,hasUnmuted:h})=>{n=this.getDialogOnly(i);const y=this.getFolder(e);!n||!this.appPeersManager.isForum(i)||!y||!y.dialogs.some(v=>v.peerId===i)||this.modifyFolderUnreadCount(e,0,!1,!1,n)});return}else t=0,a=c.count>0,s=c.hasUnmuted}const d=this.getFolder(e);t&&(d.unreadMessagesCount=Math.max(0,d.unreadMessagesCount+t));const f=kt(n);a?d.unreadPeerIds.add(f):d.unreadPeerIds.delete(f),s?d.unreadUnmutedPeerIds.add(f):d.unreadUnmutedPeerIds.delete(f),d.dispatchUnreadTimeout??(d.dispatchUnreadTimeout=Ae.setTimeout(()=>{d.dispatchUnreadTimeout=void 0;const c={...d};delete c.dialogs,this.rootScope.dispatchEvent("folder_unread",c),p&&this.processChangedUnreadOrUnmuted(i)},0))}processChangedUnreadOrUnmuted(e){const t=this.getDialogOnly(e);t&&(this.processDialogForFilters(t),this.prepareDialogUnreadCountModifying(t)(),this.rootScope.dispatchEvent("dialog_unread",{peerId:e,dialog:t}))}generateIndexForDialog(e,t,a,s){if(!t)return;const n=Ye(e),i=mt(e);let r=0,p;if(n&&e.pFlags.hidden)r=this.generateDialogPinnedDateByIndex(4095),p=!0;else if(e.pFlags.pinned&&!s)r=this.generateDialogPinnedDate(e),p=!0;else{const{peerId:c}=e;if(a||(a=this.appMessagesManager.getMessageByPeer(c,e.top_message)),r=a?.date||r,i){const l=this.appPeersManager.isChannel(c)&&c.toChatId();if(l){const h=this.appChatsManager.getChat(l);(!r||h.date&&h.date>r)&&(r=h.date)}}(n||i)&&e.draft?._==="draftMessage"&&e.draft.date>r&&(r=e.draft.date)}r||(r=De(!0));const d=this.generateDialogIndex(r,p);if(t)return d;const f=ma(e.folder_id);Ks(e,f,d)}generateDialogPinnedDateByIndex(e){return 2147418112+(e&65535)}generateDialogPinnedDate(e){const t=this.getPinnedOrdersByDialog(e),a=kt(e);let s=t.indexOf(a);return s===-1&&(t.unshift(a),s=0,mt(e)&&this.savePinnedOrders()),this.generateDialogPinnedDateByIndex(t.length-1-s)}getDialogMessageForState(e){const{peerId:t}=e,a=Ze(e)?e.savedPeerId:void 0,s=this.appMessagesManager.getHistoryStorage(t,a),n=this.appMessagesManager.getHistoryMessagesStorage(t),i=s.history.slice;let r;for(let p=0,d=i.length;p<d;++p){const f=i[p],c=this.appMessagesManager.getMessageFromStorage(n,f);if(c&&!c.pFlags.is_outgoing){r=c;break}}return r}setDialogToState(e){if(!mt(e))return;const{peerId:t,pts:a}=e,s=this.getDialogMessageForState(e);if(s){const n=Pr(s);this.peersStorage.requestPeersForKey(n,`topMessage_${t}`)}if(e.topMessage=s,t.isAnyChat()&&a){const n=this.apiUpdatesManager.getChannelState(t.toChatId(),a).pts;e.pts=n}this.storage.set({[t]:e}),this.peersStorage.requestPeer(t,"dialog")}pushDialog({dialog:e,offsetDate:t,ignoreOffsetDate:a,saveGlobalOffset:s}){const n=mt(e),{peerId:i}=e,r=kt(e);if(n?this.dialogs[r]=e:Ye(e)?this.getForumTopicsCache(i).topics.set(r,e):Ze(e)&&(this.savedDialogs[r]=e),t??(t=this.getDialogOffsetDate(e)),this.processDialogForFilters(e),t&&!e.pFlags.pinned){if(n&&s){const f=this.dialogsOffsetDate[At];(!f||t<f)&&this.setDialogOffsetDate(At,t)}const p=this.getDialogFilterId(e),d=this.dialogsOffsetDate[p];if(!d||t<d){if(!a&&!this.isDialogsLoaded(p)){this.dropDialog(i,vr(e),!0);return}this.setDialogOffsetDate(p,t)}}this.setDialogToState(e)}dropDialogFromFolders(e,t,a){const s=this.getDialog(e,void 0,t,!1),[n,i]=s;if(n){const r=this.getDialogFilterId(n),p=Le(this.getPinnedOrders(r),kt(n))!==void 0;this.processDialogForFilters(n,!0),a||(Ye(n)?this.getForumTopicsCache(e).index.indexObject(t,""):Ze(n)||this.dialogsIndex.indexObject(e,"")),p&&this.savePinnedOrders()}return s}dropDialog(e,t,a){const s=this.getAnyDialog(e,t),n=this.dropDialogFromFolders(e,t,a);return s&&(a||(Ye(s)?this.getForumTopicsCache(e).topics.delete(t):Ze(s)?delete this.savedDialogs[t]:delete this.dialogs[e]),this.clearDialogFromState(s,a)),n}clearDialogFromState(e,t){if(!mt(e))return;const{peerId:a}=e;this.peersStorage.requestPeersForKey([],`topMessage_${a}`),this.peersStorage.releasePeer(a,"dialog"),this.storage.delete(a,t)}dropDialogWithEvent(e,t){const a=this.dropDialog(e,t);return a.length&&this.rootScope.dispatchEvent("dialog_drop",a[0]),a}dropDialogOnDeletion(e,t){if(this.dropDialogWithEvent(e,t),this.appPeersManager.isBroadcast(e)){const a=this.appMessagesManager.getHistoryStorage(e),s=a?.channelJoinedMid;s&&(a.channelJoinedMid=void 0,this.apiUpdatesManager.processLocalUpdate({_:"updateDeleteChannelMessages",channel_id:e.toChatId(),messages:[s],pts:void 0,pts_count:void 0}))}this.rootScope.dispatchEvent("peer_deleted",e)}applyDialogs(e,t){const a=e._==="messages.forumTopics",s=e._==="messages.savedDialogs",n=!a&&!s,i=a?e.topics:e.dialogs;a?this.processTopics(t,e):n&&ut(e.dialogs,(d,f,c)=>{d._==="dialogFolder"&&c.splice(f,1)}),this.appMessagesManager.saveApiResult(e);const r=new Map,p=d=>{let f=r.get(d);return f||r.set(d,f={}),f};i.forEach(d=>{const f=this.getDialogPeerId(d);let c=d.top_message;const{pendingTopMsgs:l}=this.appMessagesManager;let h,y;n?h=f:a?(y=this.appMessagesIdsManager.generateMessageId(d.id,this.getDialogPeerId(d).toChatId()),h=`${f}_${y}`):(y=He(d.peer),h=`${f}_${y}`);const v=l[h];if(v){const w=this.appMessagesManager.getMessageByPeer(f,v),D=this.appMessagesManager.getMessageByPeer(f,c);(!c||w&&(!D||w?.date>D?.date))&&(d.top_message=c=v,this.appMessagesManager.getHistoryStorage(f,y).maxId=v)}if(c||d.draft?._==="draftMessage"){if(this.saveDialog({dialog:d})){const w=p(f);a?(w.topics??(w.topics=new Map)).set(d.id,d):s?(w.saved??(w.saved=new Map)).set(d.savedPeerId,d):w.dialog=d}}else this.dropDialogWithEvent(f,y);const A=this.appMessagesManager.getUpdateAfterReloadKey(f,y),I=this.appMessagesManager.newUpdatesAfterReloadToHandle[A];if(I!==void 0){const w=[...I];for(const D of w)I.delete(D),this.apiUpdatesManager.saveUpdate(D);I.size||delete this.appMessagesManager.newUpdatesAfterReloadToHandle[A]}}),r.size&&this.rootScope.dispatchEvent("dialogs_multiupdate",r)}getDialogOffsetDate(e){return this.getDialogMessageForState(e)?.date||0}setDialogOffsetDate(e,t){return this.log("setting offset date",e,t),this.dialogsOffsetDate[e]=t}canSaveDialog(e,t){if(e.isAnyChat()){const a=this.appChatsManager.getChat(e.toChatId());if(a._==="channelForbidden"||a.pFlags.left)return!1}else if(this.appUsersManager.isDeleted(e.toUserId())&&!ae(t.top_message))return!1;return!0}getDialogPeerId(e){const{peerId:t}=e;return t||(Ze(e)?this.appPeersManager.peerId:this.appPeersManager.getPeerId(e.peer))}saveDialog({dialog:e,folderId:t,ignoreOffsetDate:a,saveGlobalOffset:s}){const n=Ye(e),i=Ze(e),r=mt(e),p=this.getDialogPeerId(e),d=this.appPeersManager.isChannel(p)?p.toChatId():void 0,f=i?He(e.peer):void 0,c=n?e.id=this.appMessagesIdsManager.generateMessageId(e.id,d):i?f:void 0;if(r&&(t??(t=e.folder_id??ot)),!p)return this.log.error("saveConversation no peerId???",e,t),!1;if(r&&e._!=="dialog"&&this.log.error("saveConversation not regular dialog",e,Object.assign({},e)),r&&!d&&p.isAnyChat()){const I=this.appChatsManager.getChat(p.toChatId());if(I&&I.migrated_to&&I.pFlags.deactivated){const w=this.appPeersManager.getPeerId(I.migrated_to);this.appMessagesManager.migratedFromTo[p]=w,this.appMessagesManager.migratedToFrom[w]=p,e.migratedTo=w}}if(r&&!this.canSaveDialog(p,e))return!1;if(n)this.getForumTopicsCache(p).index.indexObject(c,e.title);else if(r&&!e.migratedTo){const I=this.appPeersManager.getPeerSearchText(p);this.dialogsIndex.indexObject(p,I)}const l=this.getAnyDialog(p,c);let h,y;if(e.top_message,h=this.appMessagesIdsManager.generateMessageId(e.top_message,d),(l?.top_message&&this.appMessagesManager.getMessageByPeer(p,l.top_message))?.pFlags?.is_outgoing&&l.top_message>=h&&(h=l.top_message),y=this.appMessagesManager.getMessageByPeer(p,h),e.top_message=h,i||(e.read_inbox_max_id=this.appMessagesIdsManager.generateMessageId(l&&!e.read_inbox_max_id?l.read_inbox_max_id:e.read_inbox_max_id,d),e.read_outbox_max_id=this.appMessagesIdsManager.generateMessageId(l&&!e.read_outbox_max_id?l.read_outbox_max_id:e.read_outbox_max_id,d)),r&&e.folder_id===void 0&&e._==="dialog"&&(e.folder_id=l?l.folder_id:t),i?e.savedPeerId=f:e.draft=this.appDraftsManager.saveDraft({peerId:p,threadId:c,draft:e.draft}),e.peerId=p,!i&&y&&y.pFlags.is_outgoing){const I=y.pFlags.out,w=e[I?"read_outbox_max_id":"read_inbox_max_id"];h>w?(y.pFlags.unread=!0,!e.unread_count&&!I&&++e.unread_count):delete y.pFlags.unread}const v=this.appMessagesManager.getHistoryStorage(p,c),A=v.history.slice;if(h&&(!A.length||!A.isEnd(Ne.Bottom)?(v.history.unshift(h),v.count||(v.count=v.history.length),this.appMessagesManager.mergeReplyKeyboard(v,y)&&this.rootScope.dispatchEvent("history_reply_markup",{peerId:p}),v.originalInsertSlice&&this.appMessagesManager.insertChannelJoinedService(p,v,v.history.slice)):r&&!l&&this.appMessagesManager.insertChannelJoinedService(p,v)),r&&e.top_message<v.history.first[0]&&(h=e.top_message=v.history.first[0],e.topMessage=this.appMessagesManager.getMessageByPeer(p,e.top_message)),v.maxId=h,i||(v.readMaxId=e.read_inbox_max_id,v.readOutboxMaxId=e.read_outbox_max_id,this.appNotificationsManager.savePeerSettings({peerId:p,threadId:n?e.id:void 0,settings:e.notify_settings})),r&&d&&e.pts&&this.apiUpdatesManager.addChannelState(d,e.pts),this.generateIndexForDialog(e),l){const I=this.dialogsStorage.prepareDialogUnreadCountModifying(l);Gt(l,e),I()}return this.pushDialog({dialog:e,ignoreOffsetDate:a,saveGlobalOffset:s}),n&&this.processTopicUpdate(e,l),!0}processTopicUpdate(e,t){if(!t)return;const{peerId:a,id:s}=e,n=e.icon_emoji_id!==t.icon_emoji_id,i=e.title!==t.title,r=n||i;n&&this.rootScope.dispatchEvent("avatar_update",{peerId:a,threadId:s}),r&&this.rootScope.dispatchEvent("peer_title_edit",{peerId:a,threadId:s})}getDialogs(e){const{query:t="",offsetIndex:a,limit:s=20,filterId:n=ot,filterType:i=this.getFilterType(n),skipMigrated:r=i===1,forceLocal:p,recursion:d}=e,f=this.isFilterIdForForum(n),c=this.isVirtualFilter(n);if(!c&&!je.has(n)){const q=[],L=this.appUsersManager.fillContacts();L.cached||q.push(L.promise);const H=this.filtersStorage.reloadMissingPeerIds(n);if(H&&q.push(H),q.length)return Promise.all(q).then(()=>this.getDialogs(e))}const l=(!je.has(n)||this.getOffsetDate(n))&&!c?At:n;let h=this.getFolderDialogs(n,r);const y=this.getDialogIndexKeyByFilterId(n),v=i!==2,A=i===1;if(t&&v){if(!s||this.cachedResults.query!==t||this.cachedResults.folderId!==n||d){this.cachedResults.query=t,this.cachedResults.folderId=n;const L=(f?this.getForumTopicsCache(n).index:this.dialogsIndex).search(t),H=[];if(f)for(const W of L){const Q=this.getForumTopic(n,W);Q&&H.push(Q)}else for(const W of L){const Q=this.dialogs[W];Q&&Q.folder_id===n&&H.push(Q)}H.sort((W,Q)=>this.getDialogIndex(Q,y)-this.getDialogIndex(W,y)),this.cachedResults.dialogs=H,this.cachedResults.count=H.length}h=this.cachedResults.dialogs}else this.cachedResults.query="";let I=0;if(a>0)for(let q=h.length;I<q&&!(a>this.getDialogIndex(h[I],y));++I);const w=this.isDialogsLoaded(l),D=h.length>=I+s;if(!A&&t||w||D||p){const q=h.slice(I,I+s);return{dialogs:q,count:w?h.length:this.getFolder(n).count,isTopEnd:h.length&&(q[0]&&q[0]===h[0]||this.getDialogIndex(h[0],y)<a),isEnd:((A?!1:t)||w)&&I+s>=h.length}}return this.appMessagesManager.getTopMessages({limit:s,folderId:l,query:t,offsetTopicId:f&&t?h[h.length-1]?.id:void 0}).then(q=>{if(t)return this.getDialogs({...e,forceLocal:!0,recursion:!0});const L=this.getFolder(n);if(L.count=q.count,r&&(h=this.getFolderDialogs(n,r)),I=0,a>0)for(let W=h.length;I<W&&!(a>this.getDialogIndex(h[I],y));++I);const H=h.slice(I,I+s);return{dialogs:H,count:q.count??h.length,isTopEnd:h.length&&(H[0]&&H[0]===h[0]||this.getDialogIndex(h[0],y)<a),isEnd:q.isEnd&&h[h.length-1]===H[H.length-1]}})}async markFolderAsRead(e){const a=[...this.getFolder(e).unreadPeerIds];for(const s of a)await this.appMessagesManager.markDialogUnread(s,!0)}flushForumTopicsCache(e){const t=this.forumTopics.get(e);if(!t)return;const a=this.folders[e];a&&(a.dispatchUnreadTimeout&&clearTimeout(a.dispatchUnreadTimeout),delete this.allDialogsLoaded[e],delete this.pinnedOrders[e],delete this.dialogsOffsetDate[e],delete this.folders[e]),t.topics.clear()}getForumTopicsCache(e){let t=this.forumTopics.get(e);return t||(t={topics:new Map,deletedTopics:new Set,getTopicPromises:new Map,index:this.createSearchIndex()},this.forumTopics.set(e,t)),t}getForumTopicById(e,t){if(!this.appPeersManager.isForum(e))return Promise.reject(Ee("CHANNEL_FORUM_MISSING"));const a=this.getForumTopicsCache(e);let s;if(t){if(s=a.getTopicPromises.get(t),s)return s;if(a.deletedTopics.has(t))return Promise.resolve(void 0);a.getTopicPromises.set(t,s=Se())}return a.getTopicsPromise??(a.getTopicsPromise=dt(0).then(()=>{const n={},i=[];for(const[p,d]of a.getTopicPromises)n[p]=d,i.push(ae(p));a.getTopicPromises.clear();const r=()=>{for(const p in n)n[p].resolve(void 0),a.deletedTopics.add(+p)};if(this.getForumTopicsCache(e)!==a){r();return}return this.apiManager.invokeApi("channels.getForumTopicsByID",{channel:this.appChatsManager.getChannelInput(e.toChatId()),topics:i}).then(p=>{if(this.getForumTopicsCache(e)===a)return this.applyDialogs(p,e),p.topics.forEach(d=>{Ye(d)&&(n[d.id].resolve(d),delete n[d.id])}),p},()=>{}).then(()=>{r(),a.getTopicsPromise=void 0,a.getTopicPromises.size&&this.getForumTopicById(e)})})),s||a.getTopicsPromise}getForumTopic(e,t){return this.forumTopics.get(e)?.topics?.get(t)}getForumTopicOrReload(e,t){const a=this.getForumTopic(e,t);return a||(this.getForumTopicsCache(e)?.deletedTopics?.has(t)?void 0:this.getForumTopicById(e,t))}processTopics(e,t){return Re(t,a=>{"pts"in a&&this.apiUpdatesManager.addChannelState(e.toChatId(),a.pts);const s=this.appPeersManager.getOutputPeer(e);return a.topics=a.topics.map(n=>{if(Ye(n))return n.peer=s,n.id=this.appMessagesIdsManager.generateMessageId(n.id,s.channel_id),n}).filter(Boolean),a})}processTopicsPromise(e,t){return t.then(a=>(this.processTopics(e,a),a))}getForumUnreadCount(e){if(!this.appPeersManager.isForum(e))return;const t=this.getFolder(e),a=t.dialogs.length>=20||this.isDialogsLoaded(e)?t.dialogs.slice(0,20):Re(this.getDialogs({filterId:e,limit:20}),s=>s.dialogs);return Re(a,s=>({count:s.reduce((n,i)=>n+ +!!i.unread_count,0),hasUnmuted:s.some(n=>n.unread_count&&this.isDialogUnmuted(n))}))}canManageTopic(e){if(e.pFlags.my)return!0;const t=e.peerId.toChatId();return this.appChatsManager.getChat(t).admin_rights?this.appChatsManager.hasRights(e.peerId.toChatId(),"manage_topics"):!1}getSavedDialogById(e){let t=this.savedDialogsPromises.get(e);if(t)return t;const a=this.appPeersManager.peerId;t=this.apiManager.invokeApi("messages.getSavedHistory",{peer:this.appPeersManager.getInputPeerById(e),add_offset:0,hash:0,limit:1,max_id:0,min_id:0,offset_date:0,offset_id:0}).then(s=>{this.savedDialogsPromises.get(e)===t&&this.savedDialogsPromises.delete(e),this.appMessagesManager.saveApiResult(s);const i=s.messages[0];if(!i){this.log("reloaded saved dialog is empty",e),this.dropDialogOnDeletion(a,e);return}const r=this.getPinnedOrders(a),p={_:"savedDialog",peer:this.appPeersManager.getOutputPeer(e),pFlags:{pinned:r.includes(e)||void 0},top_message:i.id||0};return this.log("saving reloaded saved dialog",e),this.applyDialogs({_:"messages.savedDialogs",dialogs:[p]}),p.peerId?p:void 0})}handleDialogTogglePinned(e,t,a){e&&(t?e.pFlags.pinned=!0:this.handleDialogUnpinning(e,a),this.generateIndexForDialog(e)),this.appMessagesManager.scheduleHandleNewDialogs(e.peerId,e)}handleDialogsPinned(e,t){const a=this.isFilterIdForForum(e),s=e===this.appPeersManager.peerId,n=a||s;this.resetPinnedOrder(e),this.getPinnedOrders(e).push(...t),this.savePinnedOrders(),t.reverse();const i={};t.forEach(p=>{i[p]=!0;const d=n?e:p,f=n?p:void 0,c=this.getAnyDialog(d,f);this.appMessagesManager.scheduleHandleNewDialogs(d,c),c&&(c.pFlags.pinned=!0,this.generateIndexForDialog(c))});const r=this.getFolderDialogs(e,!1);for(const p of r){if(!p.pFlags.pinned)break;i[kt(p)]||(delete p.pFlags.pinned,this.generateIndexForDialog(p),this.appMessagesManager.scheduleHandleNewDialogs(p.peerId,p))}}}function pt(o){if(o===null||typeof o!="object")return o;if(o instanceof Date)return new Date(o.getTime());if(Array.isArray(o))return o.map(s=>pt(s));if(ArrayBuffer.isView(o))return o.slice();const e=new o.constructor;for(var t in o)o.hasOwnProperty(t)&&(e[t]=pt(o[t]));return e}function Ft(o,e){const t=o.findIndex(e);return t!==-1?o.splice(t,1)[0]:void 0}const Sr=[["pinned_peers","pinnedPeerIds"],["exclude_peers","excludePeerIds"],["include_peers","includePeerIds"]],br=je.size,Cr={_:"dialogFilter",pFlags:{},id:0,title:"",exclude_peers:[],include_peers:[],pinned_peers:[],excludePeerIds:[],includePeerIds:[],pinnedPeerIds:[]};class Ir extends ce{constructor(){super(...arguments),this.clear=e=>{if(!e)this.reloadedPeerIds.clear(),this.clearFilters();else{this.filters={},this.filtersArr=[],this.reloadedPeerIds=new Set,this.localFilters={};for(const t of je)this.localFilters[t]=this.generateLocalFilter(t)}this.localId=ts},this.onUpdateDialogFilter=e=>{e.filter?this.saveDialogFilter(e.filter):this.filters[e.id]&&(this.rootScope.dispatchEvent("filter_delete",this.filters[e.id]),delete this.filters[e.id],Ft(this.filtersArr,t=>t.id===e.id)),this.pushToState()},this.onUpdateDialogFilters=e=>{const t=pt(this.filters);this.getDialogFilters(!0).then(a=>{for(const s in t){const n=+s;a.find(i=>i.id===n)||this.onUpdateDialogFilter({_:"updateDialogFilter",id:n})}this.onUpdateDialogFilterOrder({_:"updateDialogFilterOrder",order:a.map(s=>s.id)})})},this.onUpdateDialogFilterOrder=e=>{const t=e.order.slice();t.includes(Ct)||t.splice(t[0]===ot?1:0,0,Ct),this.localId=ts,t.forEach(a=>{const s=this.filters[a];delete s.localId,this.setLocalId(s)}),this.rootScope.dispatchEvent("filter_order",t),this.pushToState()}}after(){return this.clear(!0),this.apiUpdatesManager.addMultipleEventsListeners({updateDialogFilter:this.onUpdateDialogFilter,updateDialogFilters:this.onUpdateDialogFilters,updateDialogFilterOrder:this.onUpdateDialogFilterOrder}),this.rootScope.addEventListener("premium_toggle",()=>{this.onUpdateDialogFilters({_:"updateDialogFilters"})}),this.appStateManager.getState().then(e=>{this.prependFilters(e.filtersArr).map(a=>{this.saveDialogFilter(a,!1,!0)})})}prependFilters(e){e=e.slice();const t=this.localFilters[ot],a=this.localFilters[Ct],s=e.findIndex(n=>n._==="dialogFilterDefault"||n.id===ot);return s!==-1?e[s]=t:e.unshift(t),Ft(e,n=>n.id===Ct),e.splice(e[0]===t?1:0,0,a),this.localId=ts,e.forEach(n=>{delete n.localId}),e}generateLocalFilter(e){const t={...pt(Cr),id:e};return e===ot?t.pFlags.exclude_archived=!0:e===Ct&&(t.pFlags.exclude_unarchived=!0),je.has(e)&&(t.pinnedPeerIds=this.dialogsStorage.getPinnedOrders(e)),t}pushToState(){this.appStateManager.pushToState("filtersArr",this.filtersArr)}testDialogForFilter(e,t){if(!t||!mt(e))return!0;const{peerId:a}=e;if(je.has(t.id))return e.folder_id===t.id&&this.dialogsStorage.canSaveDialog(a,e);if(!this.appMessagesManager.getDialogOnly(a)||t.excludePeerIds?.includes(a))return!1;if(t.includePeerIds?.includes(a))return!0;const s=t.pFlags;if(!s)return!0;if(s.exclude_archived&&e.folder_id===Ct||s.exclude_read&&!this.appMessagesManager.isDialogUnread(e)||s.exclude_muted&&this.appNotificationsManager.isPeerLocalMuted({peerId:a})&&!(e.unread_mentions_count&&e.unread_count))return!1;if(this.appPeersManager.isAnyChat(a)){if(s.broadcasts&&this.appPeersManager.isBroadcast(a)||s.groups&&this.appPeersManager.isAnyGroup(a))return!0}else{const n=a.toUserId();if(this.appUsersManager.isBot(n))return!!s.bots;if(s.non_contacts&&!this.appUsersManager.isContact(n)||s.contacts&&this.appUsersManager.isContact(n))return!0}return!1}testDialogForFilterId(e,t){return this.testDialogForFilter(e,this.filters[t])}getFilter(e){return this.filters[e]}getFilters(){return this.filters}clearFilters(){const e=this.getFilters();for(const t in e)je.has(+t)||this.onUpdateDialogFilter({_:"updateDialogFilter",id:+t})}async toggleDialogPin(e,t){const a=this.filters[t],s=a.pinnedPeerIds.indexOf(e),n=s!==-1;if(n&&(a.pinned_peers.splice(s,1),a.pinnedPeerIds.splice(s,1)),!n){if(a.pinned_peers.length>=await this.apiManager.getLimit("folderPin"))return Promise.reject(Ee("PINNED_DIALOGS_TOO_MUCH"));a.pinned_peers.unshift(this.appPeersManager.getInputPeerById(e)),a.pinnedPeerIds.unshift(e)}return this.updateDialogFilter(a)}createDialogFilter(e,t){const a=Math.max(1,...Object.keys(this.filters).map(s=>+s));return e=pt(e),e.id=a+1,this.updateDialogFilter(e,void 0,t)}updateDialogFilter(e,t=!1,a=!1){return this.apiManager.invokeApi("messages.updateDialogFilter",{id:e.id,filter:t?void 0:this.getOutputDialogFilter(e)}).then(()=>{if(this.onUpdateDialogFilter({_:"updateDialogFilter",id:e.id,filter:t?void 0:e}),a){const n=Object.values(this.filters).sort((i,r)=>i.localId-r.localId).map(i=>i.id);Le(n,e.id),Le(n,Ct),n.splice(n[0]===ot?1:0,0,e.id),this.onUpdateDialogFilterOrder({_:"updateDialogFilterOrder",order:n})}return e})}updateDialogFiltersOrder(e){return this.apiManager.invokeApi("messages.updateDialogFiltersOrder",{order:e}).then(()=>{this.onUpdateDialogFilterOrder({_:"updateDialogFilterOrder",order:e})})}getOutputDialogFilter(e){const t=pt(e);return this.filterIncludedPinnedPeers(e),t}filterIncludedPinnedPeers(e){ut(e.includePeerIds,(t,a)=>{e.pinnedPeerIds.includes(t)&&(e.include_peers.splice(a,1),e.includePeerIds.splice(a,1))})}reloadMissingPeerIds(e,t="pinned_peers"){const s=this.getFilter(e)?.[t];if(!s?.length)return;const n=s.filter(p=>{const d=this.appPeersManager.getPeerId(p),f=this.reloadedPeerIds.has(d),c=this.appMessagesManager.getDialogOnly(d);return!f&&!c});if(!n.length)return;const i=n.map(p=>{const d=this.appPeersManager.getPeerId(p);return this.appMessagesManager.reloadConversation(p).then(c=>(this.reloadedPeerIds.add(d),c?void 0:d))});return Promise.all(i).then(p=>{p=p.filter(Boolean),p.length})}async getDialogFilters(e=!1){const t=Object.keys(this.filters);if(t.length>br&&!e)return t.map(n=>this.filters[n]).sort((n,i)=>n.localId-i.localId);const a=await this.apiManager.invokeApiSingle("messages.getDialogFilters");return this.prependFilters(a).map(n=>this.saveDialogFilter(n,e)).filter(Boolean)}getSuggestedDialogsFilters(){return this.apiManager.invokeApi("messages.getSuggestedDialogFilters")}saveDialogFilter(e,t=!0,a){e._==="dialogFilterDefault"&&(e=this.localFilters[ot]),je.has(e.id)||(Sr.forEach(([n,i])=>{const r=e[n];r&&(e[i]=r.map(p=>this.appPeersManager.getPeerId(p)))}),this.filterIncludedPinnedPeers(e),e.include_peers=e.pinned_peers.concat(e.include_peers),e.includePeerIds=e.pinnedPeerIds.concat(e.includePeerIds));const s=this.filters[e.id];return s?e=Object.assign(s,e):this.filters[e.id]=e,this.setLocalId(e),a||(t?this.rootScope.dispatchEvent("filter_update",e):s||this.rootScope.dispatchEvent("filter_new",e)),e}setLocalId(e){e.localId!==void 0?e.localId>=this.localId&&(this.localId=e.localId+1):(e.localId=this.localId++,Ft(this.filtersArr,t=>t.id===e.id),this.filtersArr.push(e),this.pushToState())}async isFilterIdAvailable(e){if(je.has(e))return!0;const t=await this.apiManager.getLimit("folders");return this.filtersArr.filter(s=>!je.has(s.id)).slice(0,t).some(s=>s.id===e)}getChatlistInput(e){return{_:"inputChatlistDialogFilter",filter_id:e}}exportChatlistInvite(e){return this.apiManager.invokeApiSingleProcess({method:"chatlists.exportChatlistInvite",params:{chatlist:this.getChatlistInput(e.id),title:e.title,peers:e.include_peers},processResult:t=>(this.saveDialogFilter(t.filter),t)})}deleteExportedInvite(e,t){return this.apiManager.invokeApiSingleProcess({method:"chatlists.deleteExportedInvite",params:{chatlist:this.getChatlistInput(e),slug:t}})}editExportedInvite(e,t,a,s){return this.apiManager.invokeApi("chatlists.editExportedInvite",{chatlist:this.getChatlistInput(e),slug:t,title:s,peers:a.map(n=>this.appPeersManager.getInputPeerById(n))})}getExportedInvites(e){return this.getFilter(e)?._==="dialogFilter"?Promise.reject(Ee("FILTER_NOT_SUPPORTED")):this.apiManager.invokeApiSingleProcess({method:"chatlists.getExportedInvites",params:{chatlist:this.getChatlistInput(e)},processResult:a=>(this.appUsersManager.saveApiUsers(a.users),this.appChatsManager.saveApiChats(a.chats),a.invites)})}checkChatlistInvite(e){return this.apiManager.invokeApiSingleProcess({method:"chatlists.checkChatlistInvite",params:{slug:e},processResult:t=>(this.appUsersManager.saveApiUsers(t.users),this.appChatsManager.saveApiChats(t.chats),t)})}joinChatlistInvite(e,t){return this.apiManager.invokeApiSingleProcess({method:"chatlists.joinChatlistInvite",params:{slug:e,peers:t.map(a=>this.appPeersManager.getInputPeerById(a))},processResult:a=>{this.apiUpdatesManager.processUpdateMessage(a);const n=a.updates.find(i=>i._==="updateDialogFilter").id;return this.rootScope.dispatchEvent("filter_joined",this.getFilter(n)),n}})}getChatlistUpdates(e){if(this.getFilter(e)?._!=="dialogFilterChatlist")return Promise.reject(Ee("FILTER_NOT_SUPPORTED"));const a=Date.now();return this.apiManager.invokeApiSingleProcess({method:"chatlists.getChatlistUpdates",params:{chatlist:this.getChatlistInput(e)},processResult:s=>{this.appUsersManager.saveApiUsers(s.users),this.appChatsManager.saveApiChats(s.chats);const n=this.getFilter(e);return n?._==="dialogFilterChatlist"&&(n.updatedTime=a,this.pushToState()),s}})}joinChatlistUpdates(e,t){return this.apiManager.invokeApiSingleProcess({method:"chatlists.joinChatlistUpdates",params:{chatlist:this.getChatlistInput(e),peers:t.map(a=>this.appPeersManager.getInputPeerById(a))},processResult:a=>{this.apiUpdatesManager.processUpdateMessage(a)}})}hideChatlistUpdates(e){return this.apiManager.invokeApiSingle("chatlists.hideChatlistUpdates",{chatlist:this.getChatlistInput(e)})}getLeaveChatlistSuggestions(e){return this.apiManager.invokeApiSingle("chatlists.getLeaveChatlistSuggestions",{chatlist:this.getChatlistInput(e)})}leaveChatlist(e,t){return this.apiManager.invokeApiSingleProcess({method:"chatlists.leaveChatlist",params:{chatlist:this.getChatlistInput(e),peers:t.map(a=>this.appPeersManager.getInputPeerById(a))},processResult:a=>{this.apiUpdatesManager.processUpdateMessage(a)}})}}function Za(o){return[...new Set(o)]}const Dr="((?:👨🏻‍❤️?‍💋‍👨\uD83C[\uDFFB-\uDFFF]|👨🏼‍❤️?‍💋‍👨\uD83C[\uDFFB-\uDFFF]|👨🏽‍❤️?‍💋‍👨\uD83C[\uDFFB-\uDFFF]|👨🏾‍❤️?‍💋‍👨\uD83C[\uDFFB-\uDFFF]|👨🏿‍❤️?‍💋‍👨\uD83C[\uDFFB-\uDFFF]|👩🏻‍❤️?‍💋‍👨\uD83C[\uDFFB-\uDFFF]|👩🏻‍❤️?‍💋‍👩\uD83C[\uDFFB-\uDFFF]|👩🏼‍❤️?‍💋‍👨\uD83C[\uDFFB-\uDFFF]|👩🏼‍❤️?‍💋‍👩\uD83C[\uDFFB-\uDFFF]|👩🏽‍❤️?‍💋‍👨\uD83C[\uDFFB-\uDFFF]|👩🏽‍❤️?‍💋‍👩\uD83C[\uDFFB-\uDFFF]|👩🏾‍❤️?‍💋‍👨\uD83C[\uDFFB-\uDFFF]|👩🏾‍❤️?‍💋‍👩\uD83C[\uDFFB-\uDFFF]|👩🏿‍❤️?‍💋‍👨\uD83C[\uDFFB-\uDFFF]|👩🏿‍❤️?‍💋‍👩\uD83C[\uDFFB-\uDFFF]|🧑🏻‍❤️?‍💋‍🧑\uD83C[\uDFFC-\uDFFF]|🧑🏼‍❤️?‍💋‍🧑\uD83C[\uDFFB\uDFFD-\uDFFF]|🧑🏽‍❤️?‍💋‍🧑\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|🧑🏾‍❤️?‍💋‍🧑\uD83C[\uDFFB-\uDFFD\uDFFF]|🧑🏿‍❤️?‍💋‍🧑\uD83C[\uDFFB-\uDFFE]|👨🏻‍❤️?‍👨\uD83C[\uDFFB-\uDFFF]|👨🏻‍🤝‍👨\uD83C[\uDFFC-\uDFFF]|👨🏼‍❤️?‍👨\uD83C[\uDFFB-\uDFFF]|👨🏼‍🤝‍👨\uD83C[\uDFFB\uDFFD-\uDFFF]|👨🏽‍❤️?‍👨\uD83C[\uDFFB-\uDFFF]|👨🏽‍🤝‍👨\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|👨🏾‍❤️?‍👨\uD83C[\uDFFB-\uDFFF]|👨🏾‍🤝‍👨\uD83C[\uDFFB-\uDFFD\uDFFF]|👨🏿‍❤️?‍👨\uD83C[\uDFFB-\uDFFF]|👨🏿‍🤝‍👨\uD83C[\uDFFB-\uDFFE]|👩🏻‍❤️?‍👨\uD83C[\uDFFB-\uDFFF]|👩🏻‍❤️?‍👩\uD83C[\uDFFB-\uDFFF]|👩🏻‍🤝‍👨\uD83C[\uDFFC-\uDFFF]|👩🏻‍🤝‍👩\uD83C[\uDFFC-\uDFFF]|👩🏼‍❤️?‍👨\uD83C[\uDFFB-\uDFFF]|👩🏼‍❤️?‍👩\uD83C[\uDFFB-\uDFFF]|👩🏼‍🤝‍👨\uD83C[\uDFFB\uDFFD-\uDFFF]|👩🏼‍🤝‍👩\uD83C[\uDFFB\uDFFD-\uDFFF]|👩🏽‍❤️?‍👨\uD83C[\uDFFB-\uDFFF]|👩🏽‍❤️?‍👩\uD83C[\uDFFB-\uDFFF]|👩🏽‍🤝‍👨\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|👩🏽‍🤝‍👩\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|👩🏾‍❤️?‍👨\uD83C[\uDFFB-\uDFFF]|👩🏾‍❤️?‍👩\uD83C[\uDFFB-\uDFFF]|👩🏾‍🤝‍👨\uD83C[\uDFFB-\uDFFD\uDFFF]|👩🏾‍🤝‍👩\uD83C[\uDFFB-\uDFFD\uDFFF]|👩🏿‍❤️?‍👨\uD83C[\uDFFB-\uDFFF]|👩🏿‍❤️?‍👩\uD83C[\uDFFB-\uDFFF]|👩🏿‍🤝‍👨\uD83C[\uDFFB-\uDFFE]|👩🏿‍🤝‍👩\uD83C[\uDFFB-\uDFFE]|🧑🏻‍❤️?‍🧑\uD83C[\uDFFC-\uDFFF]|🧑🏻‍🤝‍🧑\uD83C[\uDFFB-\uDFFF]|🧑🏼‍❤️?‍🧑\uD83C[\uDFFB\uDFFD-\uDFFF]|🧑🏼‍🤝‍🧑\uD83C[\uDFFB-\uDFFF]|🧑🏽‍❤️?‍🧑\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|🧑🏽‍🤝‍🧑\uD83C[\uDFFB-\uDFFF]|🧑🏾‍❤️?‍🧑\uD83C[\uDFFB-\uDFFD\uDFFF]|🧑🏾‍🤝‍🧑\uD83C[\uDFFB-\uDFFF]|🧑🏿‍❤️?‍🧑\uD83C[\uDFFB-\uDFFE]|🧑🏿‍🤝‍🧑\uD83C[\uDFFB-\uDFFF]|👨‍❤️?‍💋‍👨|👩‍❤️?‍💋‍\uD83D[\uDC68\uDC69]|🫱🏻‍🫲\uD83C[\uDFFC-\uDFFF]|🫱🏼‍🫲\uD83C[\uDFFB\uDFFD-\uDFFF]|🫱🏽‍🫲\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|🫱🏾‍🫲\uD83C[\uDFFB-\uDFFD\uDFFF]|🫱🏿‍🫲\uD83C[\uDFFB-\uDFFE]|👨‍❤️?‍👨|👩‍❤️?‍\uD83D[\uDC68\uDC69]|🧑‍🤝‍🧑|👫\uD83C[\uDFFB-\uDFFF]|👬\uD83C[\uDFFB-\uDFFF]|👭\uD83C[\uDFFB-\uDFFF]|💏\uD83C[\uDFFB-\uDFFF]|💑\uD83C[\uDFFB-\uDFFF]|🤝\uD83C[\uDFFB-\uDFFF]|\uD83D[\uDC6B-\uDC6D\uDC8F\uDC91]|🤝)|(?:\uD83D[\uDC68\uDC69]|🧑)(?:\uD83C[\uDFFB-\uDFFF])?‍(?:⚕️?|⚖️?|✈️?|\uD83C[\uDF3E\uDF73\uDF7C\uDF84\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uD83E[\uDDAF-\uDDB3\uDDBC\uDDBD])|(?:\uD83C[\uDFCB\uDFCC]|\uD83D[\uDD74\uDD75]|⛹)(?:(?:\uD83C[\uDFFB-\uDFFF]|️?)‍[♀♂]️?)|(?:\uD83C[\uDFC3\uDFC4\uDFCA]|\uD83D[\uDC6E\uDC70\uDC71\uDC73\uDC77\uDC81\uDC82\uDC86\uDC87\uDE45-\uDE47\uDE4B\uDE4D\uDE4E\uDEA3\uDEB4-\uDEB6]|\uD83E[\uDD26\uDD35\uDD37-\uDD39\uDD3D\uDD3E\uDDB8\uDDB9\uDDCD-\uDDCF\uDDD4\uDDD6-\uDDDD])(?:\uD83C[\uDFFB-\uDFFF])?‍[♀♂]️?|(?:👨‍👨‍👦‍👦|👨‍👨‍👧‍\uD83D[\uDC66\uDC67]|👨‍👩‍👦‍👦|👨‍👩‍👧‍\uD83D[\uDC66\uDC67]|👩‍👩‍👦‍👦|👩‍👩‍👧‍\uD83D[\uDC66\uDC67]|👨‍👦‍👦|👨‍👧‍\uD83D[\uDC66\uDC67]|👨‍👨‍\uD83D[\uDC66\uDC67]|👨‍👩‍\uD83D[\uDC66\uDC67]|👩‍👦‍👦|👩‍👧‍\uD83D[\uDC66\uDC67]|👩‍👩‍\uD83D[\uDC66\uDC67]|🏳️?‍⚧️?|🏳️?‍🌈|😶‍🌫️?|❤️?‍🔥|❤️?‍🩹|🏴‍☠️?|🐕‍🦺|🐻‍❄️?|👁‍🗨|👨‍\uD83D[\uDC66\uDC67]|👩‍\uD83D[\uDC66\uDC67]|👯‍♀️?|👯‍♂️?|😮‍💨|😵‍💫|🤼‍♀️?|🤼‍♂️?|🧞‍♀️?|🧞‍♂️?|🧟‍♀️?|🧟‍♂️?|🐈‍⬛)|[#*0-9]️??⃣|(?:[©®™♟]️?)|(?:\uD83C[\uDC04\uDD70\uDD71\uDD7E\uDD7F\uDE02\uDE1A\uDE2F\uDE37\uDF21\uDF24-\uDF2C\uDF36\uDF7D\uDF96\uDF97\uDF99-\uDF9B\uDF9E\uDF9F\uDFCD\uDFCE\uDFD4-\uDFDF\uDFF3\uDFF5\uDFF7]|\uD83D[\uDC3F\uDC41\uDCFD\uDD49\uDD4A\uDD6F\uDD70\uDD73\uDD76-\uDD79\uDD87\uDD8A-\uDD8D\uDDA5\uDDA8\uDDB1\uDDB2\uDDBC\uDDC2-\uDDC4\uDDD1-\uDDD3\uDDDC-\uDDDE\uDDE1\uDDE3\uDDE8\uDDEF\uDDF3\uDDFA\uDECB\uDECD-\uDECF\uDEE0-\uDEE5\uDEE9\uDEF0\uDEF3]|[‼⁉ℹ↔-↙↩↪⌚⌛⌨⏏⏭-⏯⏱⏲⏸-⏺Ⓜ▪▫▶◀◻-◾☀-☄☎☑☔☕☘☠☢☣☦☪☮☯☸-☺♀♂♈-♓♠♣♥♦♨♻♿⚒-⚗⚙⚛⚜⚠⚡⚧⚪⚫⚰⚱⚽⚾⛄⛅⛈⛏⛑⛓⛔⛩⛪⛰-⛵⛸⛺⛽✂✈✉✏✒✔✖✝✡✳✴❄❇❗❣❤➡⤴⤵⬅-⬇⬛⬜⭐⭕〰〽㊗㊙])(?:️?|(?!︎))|(?:(?:\uD83C[\uDFCB\uDFCC]|\uD83D[\uDD74\uDD75\uDD90]|[☝⛷⛹✌✍])(?:️?|(?!︎))|(?:\uD83C[\uDF85\uDFC2-\uDFC4\uDFC7\uDFCA]|\uD83D[\uDC42\uDC43\uDC46-\uDC50\uDC66-\uDC69\uDC6E\uDC70-\uDC78\uDC7C\uDC81-\uDC83\uDC85-\uDC87\uDCAA\uDD7A\uDD95\uDD96\uDE45-\uDE47\uDE4B-\uDE4F\uDEA3\uDEB4-\uDEB6\uDEC0\uDECC]|\uD83E[\uDD0C\uDD0F\uDD18-\uDD1C\uDD1E\uDD1F\uDD26\uDD30-\uDD39\uDD3D\uDD3E\uDD77\uDDB5\uDDB6\uDDB8\uDDB9\uDDBB\uDDCD-\uDDCF\uDDD1-\uDDDD\uDEC3-\uDEC5\uDEF0-\uDEF6]|[✊✋]))(?:\uD83C[\uDFFB-\uDFFF])?|(?:🏴󠁧󠁢󠁥󠁮󠁧󠁿|🏴󠁧󠁢󠁳󠁣󠁴󠁿|🏴󠁧󠁢󠁷󠁬󠁳󠁿|🇦\uD83C[\uDDE8-\uDDEC\uDDEE\uDDF1\uDDF2\uDDF4\uDDF6-\uDDFA\uDDFC\uDDFD\uDDFF]|🇧\uD83C[\uDDE6\uDDE7\uDDE9-\uDDEF\uDDF1-\uDDF4\uDDF6-\uDDF9\uDDFB\uDDFC\uDDFE\uDDFF]|🇨\uD83C[\uDDE6\uDDE8\uDDE9\uDDEB-\uDDEE\uDDF0-\uDDF5\uDDF7\uDDFA-\uDDFF]|🇩\uD83C[\uDDEA\uDDEC\uDDEF\uDDF0\uDDF2\uDDF4\uDDFF]|🇪\uD83C[\uDDE6\uDDE8\uDDEA\uDDEC\uDDED\uDDF7-\uDDFA]|🇫\uD83C[\uDDEE-\uDDF0\uDDF2\uDDF4\uDDF7]|🇬\uD83C[\uDDE6\uDDE7\uDDE9-\uDDEE\uDDF1-\uDDF3\uDDF5-\uDDFA\uDDFC\uDDFE]|🇭\uD83C[\uDDF0\uDDF2\uDDF3\uDDF7\uDDF9\uDDFA]|🇮\uD83C[\uDDE8-\uDDEA\uDDF1-\uDDF4\uDDF6-\uDDF9]|🇯\uD83C[\uDDEA\uDDF2\uDDF4\uDDF5]|🇰\uD83C[\uDDEA\uDDEC-\uDDEE\uDDF2\uDDF3\uDDF5\uDDF7\uDDFC\uDDFE\uDDFF]|🇱\uD83C[\uDDE6-\uDDE8\uDDEE\uDDF0\uDDF7-\uDDFB\uDDFE]|🇲\uD83C[\uDDE6\uDDE8-\uDDED\uDDF0-\uDDFF]|🇳\uD83C[\uDDE6\uDDE8\uDDEA-\uDDEC\uDDEE\uDDF1\uDDF4\uDDF5\uDDF7\uDDFA\uDDFF]|🇴🇲|🇵\uD83C[\uDDE6\uDDEA-\uDDED\uDDF0-\uDDF3\uDDF7-\uDDF9\uDDFC\uDDFE]|🇶🇦|🇷\uD83C[\uDDEA\uDDF4\uDDF8\uDDFA\uDDFC]|🇸\uD83C[\uDDE6-\uDDEA\uDDEC-\uDDF4\uDDF7-\uDDF9\uDDFB\uDDFD-\uDDFF]|🇹\uD83C[\uDDE6\uDDE8\uDDE9\uDDEB-\uDDED\uDDEF-\uDDF4\uDDF7\uDDF9\uDDFB\uDDFC\uDDFF]|🇺\uD83C[\uDDE6\uDDEC\uDDF2\uDDF3\uDDF8\uDDFE\uDDFF]|🇻\uD83C[\uDDE6\uDDE8\uDDEA\uDDEC\uDDEE\uDDF3\uDDFA]|🇼\uD83C[\uDDEB\uDDF8]|🇽🇰|🇾\uD83C[\uDDEA\uDDF9]|🇿\uD83C[\uDDE6\uDDF2\uDDFC]|\uD83C[\uDCCF\uDD8E\uDD91-\uDD9A\uDDE6-\uDDFF\uDE01\uDE32-\uDE36\uDE38-\uDE3A\uDE50\uDE51\uDF00-\uDF20\uDF2D-\uDF35\uDF37-\uDF7C\uDF7E-\uDF84\uDF86-\uDF93\uDFA0-\uDFC1\uDFC5\uDFC6\uDFC8\uDFC9\uDFCF-\uDFD3\uDFE0-\uDFF0\uDFF4\uDFF8-\uDFFF]|\uD83D[\uDC00-\uDC3E\uDC40\uDC44\uDC45\uDC51-\uDC65\uDC6A\uDC6F\uDC79-\uDC7B\uDC7D-\uDC80\uDC84\uDC88-\uDC8E\uDC90\uDC92-\uDCA9\uDCAB-\uDCFC\uDCFF-\uDD3D\uDD4B-\uDD4E\uDD50-\uDD67\uDDA4\uDDFB-\uDE44\uDE48-\uDE4A\uDE80-\uDEA2\uDEA4-\uDEB3\uDEB7-\uDEBF\uDEC1-\uDEC5\uDED0-\uDED2\uDED5-\uDED7\uDEDD-\uDEDF\uDEEB\uDEEC\uDEF4-\uDEFC\uDFE0-\uDFEB\uDFF0]|\uD83E[\uDD0D\uDD0E\uDD10-\uDD17\uDD20-\uDD25\uDD27-\uDD2F\uDD3A\uDD3C\uDD3F-\uDD45\uDD47-\uDD76\uDD78-\uDDB4\uDDB7\uDDBA\uDDBC-\uDDCC\uDDD0\uDDDE-\uDDFF\uDE70-\uDE74\uDE78-\uDE7C\uDE80-\uDE86\uDE90-\uDEAC\uDEB0-\uDEBA\uDEC0-\uDEC2\uDED0-\uDED9\uDEE0-\uDEE7]|[⏩-⏬⏰⏳♾⛎✅✨❌❎❓-❕➕-➗➰➿])|️)",Pa="a-z\\u00c0-\\u00d6\\u00d8-\\u00f6\\u00f8-\\u00ff\\u0100-\\u024f\\u0253\\u0254\\u0256\\u0257\\u0259\\u025b\\u0263\\u0268\\u026f\\u0272\\u0289\\u028b\\u02bb\\u0300-\\u036f\\u1e00-\\u1eff\\u0400-\\u04ff\\u0500-\\u0527\\u2de0-\\u2dff\\ua640-\\ua69f\\u0591-\\u05bf\\u05c1-\\u05c2\\u05c4-\\u05c5\\u05c7\\u05d0-\\u05ea\\u05f0-\\u05f4\\ufb1d-\\ufb28\\ufb2a-\\ufb36\\ufb38-\\ufb3c\\ufb3e\\ufb40-\\ufb41\\ufb43-\\ufb44\\ufb46-\\ufb4f\\u0610-\\u061a\\u0620-\\u065f\\u066e-\\u06d3\\u06d5-\\u06dc\\u06de-\\u06e8\\u06ea-\\u06ef\\u06fa-\\u06fc\\u06ff\\u0750-\\u077f\\u08a0\\u08a2-\\u08ac\\u08e4-\\u08fe\\ufb50-\\ufbb1\\ufbd3-\\ufd3d\\ufd50-\\ufd8f\\ufd92-\\ufdc7\\ufdf0-\\ufdfb\\ufe70-\\ufe74\\ufe76-\\ufefc\\u200c\\u0e01-\\u0e3a\\u0e40-\\u0e4e\\u1100-\\u11ff\\u3130-\\u3185\\uA960-\\uA97F\\uAC00-\\uD7AF\\uD7B0-\\uD7FF\\u3003\\u3005\\u303b\\uff21-\\uff3a\\uff41-\\uff5a\\uff66-\\uff9f\\uffa1-\\uffdc",wr="0-9_"+Pa,Js="·",Ra="["+Pa+"0-9]",kr="((?:https?|ftp)://|mailto:)?",Rn=kr+"(?:"+Ra+"{1,64}(?::"+Ra+"{0,64})?@)?(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])(?:\\.(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])){3}|"+Ra+"["+Pa+Js+"0-9-]{0,64}(?:\\."+Ra+"["+Pa+Js+"0-9-]{0,64}){0,10}(?:\\.(xn--[0-9a-z]{2,16}|["+Pa+`]{2,24})))(?::\\d{2,5})?(?:/(?:\\S{0,255}[^\\s.;,(\\[\\]{}<>"'])?)?`,xn="[a-zA-Z\\d_]{5,32}",Ar="(?:\\s|^)((?:\\d{1,2}:)?(?:[0-5]?[0-9]):(?:[0-5][0-9]))(?:\\s|$)",Fr="\\/([a-zA-Z\\d_]{1,32})(?:@("+xn+"))?(\\b|$)",Ys=new RegExp("(^| )(@)("+xn+")|("+Rn+")|(\\n)|("+Dr+")|(^|[\\s\\(\\]])(#["+wr+"]{2,64})|(^|\\s)"+Fr+"|"+Ar,"i"),Er=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,Ur=/(^|\s|\n)(````?)([\s\S]+?)(````?)([\s\n\.,:?!;]|$)|(^|\s|\x01)(`|~~|\*\*|__|_-_|\|\|)([^\n]+?)\7([\x01\s\.,:?!;]|$)|@(\d+)\s*\((.+?)\)|(\[(.+?)\]\((.+?)\))/m,ja={"`":"messageEntityCode","``":"messageEntityPre","**":"messageEntityBold",__:"messageEntityItalic","~~":"messageEntityStrike","_-_":"messageEntityUnderline","||":"messageEntitySpoiler"};new Set(Object.values(ja));const Ga=new Set(["messageEntityEmoji","messageEntityLinebreak","messageEntityCaret"]),Tr=new Set(Ga);for(const o in ja)Ga.add(ja[o]);const Rr=/^\+\d+$/,xr=new Set(["messageEntityLinebreak","messageEntityCaret","messageEntityHighlight","messageEntityBotCommand","messageEntityTimestamp"]),Br=new Set(["messageEntityBold","messageEntityItalic","messageEntityCode","messageEntityPre","messageEntityUnderline","messageEntityStrike","messageEntityBlockquote","messageEntitySpoiler"]);function Lr(o){for(let e=0;e<o.length;++e){const t=o[e];let a=-1;do if(a=o.findIndex((s,n)=>Br.has(s._)&&n!==e&&s._===t._&&s.offset-t.length===t.offset),a!==-1){const s=o[a];t.length+=s.length,o.splice(a,1)}while(a!==-1)}}const Or=new Set(["messageEntityPre","messageEntityCode"]);function Bn(o,e){let t=-1,a=-1;return o.find(s=>{const{offset:n,length:i}=s;return Or.has(s._)&&(t=n,a=t+i),t!==-1&&e.offset>=t&&e.offset<a&&!Tr.has(e._)?!0:e._===s._||!Ga.has(e._)&&!Ga.has(s._)?e.offset>=n&&e.length+e.offset<=i+n:!1})}function Vr(o){o.sort((e,t)=>e.offset-t.offset||t.length-e.length)}function Ln(o,e){const t=e.filter(a=>!Bn(o,a));o.push(...t),Vr(o);for(let a=0;a<o.length;++a){const s=o[a];if(s._==="messageEntityEmoji"){const n=o[a+1];n&&n.offset<s.offset+s.length&&(s.length=n.offset-s.offset)}}return o}function aa(o,e,t){const a=[];let s=!1;const n=c=>Bn(e,c)?s=!1:(a.push(c),s=!0),i=[];let r=0,p;for(;p=o.match(Ur);){const c=r+p.index,l=p.index+p[0].length,h=p.index>0&&o.slice(0,p.index);h&&i.push(h);const y=p[3]||p[8]||p[11]||p[13];let v;if(s=!1,y.match(/^`*$/))i.push(p[0]);else if(p[3]){let I=p[3].match(/(.*?)\n/);I?.[1]||(I=void 0);let w=I?p[3].slice(I[1].length):p[3];const D=w[0]===`
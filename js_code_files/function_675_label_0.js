  `;const F=w.querySelector(".document-name"),N=new Jm;N.dataset.fontWeight=""+t,N.dataset.fontSize=""+u,N.dataset.sizeType=c,N.getSize=p,N.textContent=E,o.mid||w.classList.add("downloaded"),F.append(N),i&&F.append(eg(o));const G=w.querySelector(".document-size");if(A.append(...Ar(O," Â· ")),G.append(A),w.prepend(S),!y&&o.pFlags.is_outgoing&&!o.mid)return w;let R,B=null;const H=()=>{if(w.classList.remove("downloading"),f.size>Bg&&!y){B.setManual(),B.attach(R),B.preloader.classList.add("manual"),B.setDownloadFunction(W);return}if(f.size<=Bg&&w.classList.add("downloaded"),R){if(R!==S){const K=R;setTimeout(()=>{K.remove()},200)}R=null}B&&(B=null)},z=K=>{w.classList.add("downloading");const ee=document.createElement("span"),_e=na(f.size);ee.style.position="absolute",ee.style.left="0",K.then(H,qt).finally(()=>{A.style.visibility="",ee.remove()});const ae=Ue=>na(Ue);let re=ae(0);A.style.visibility="hidden",ee.append(re,T,_e),A.parentElement.append(ee),K.addNotifyListener(Ue=>{const ye=ae(Ue.done);re.replaceWith(ye),re=ye})},W=K=>{const ee=!K||K.isTrusted,_e=w.doc;let ae;const re=ce.chat.bubbles?ce.chat.bubbles.lazyLoadQueue.queueId:void 0;ee?(_e.type,ia.has(_e.mime_type)&&_e.thumbs?.length?ae=as.downloadMediaURL({media:_e,queueId:re}):(ae=as.downloadToDisc({media:_e,queueId:re}),_e.mime_type==="image/svg+xml"&&ft({descriptionLangKey:"Chat.File.QuickLook.Svg",button:{langKey:"OK",isCancel:!0}}))):ae=as.downloadToDisc({media:_e,queueId:re},!0),ae.catch(()=>{w.classList.remove("downloading")}),R&&(B.attach(R,!0,ae),z(ae))},{fileName:ue}=qC({media:f,downloadId:"1"});if(await d.apiFileManager.isDownloading(ue)){R=w.querySelector(".document-download")||S;const K=as.downloadToDisc({media:f},!0);B=new Qi,B.attach(R,!1,K),B.setDownloadFunction(W),z(K)}else if(!h.downloaded||y)if(R=w.querySelector(".document-download")||S,B=new Qi({isUpload:!!y}),!y)B.construct(),B.setManual(),B.attach(R),B.setDownloadFunction(W),r!==void 0&&r>=f.size&&hs(B.preloader);else{const K=as.getUpload(y);B.attachPromise(K),B.attach(R),z(K)}return D(w,K=>{U(K.target,"time")||(B?B.onClick(K):W(K))}),w}function Bd(o){if(!o)return;const e=o.media?.document;return["voice","audio","video"].includes(e?.type)&&e.duration||void 0}async function S0({albumMustBeRenderedFull:o,message:e,bubble:t,messageDiv:s,chat:i,loadPromises:n,autoDownloadSize:a,lazyLoadQueue:r,searchContext:l,useSearch:c,sizeType:d,managers:h,fontWeight:u,fontSize:p,richTextFragment:m,richTextOptions:g,canTranscribeVoice:f}){let y;const v=o?await i.getMidsByMid(e.mid):[e.mid],b=v.map(async(S,I)=>{const L=i.getMessage(S),M=await lc({message:L,loadPromises:n,autoDownloadSize:a,lazyLoadQueue:r,searchContext:l,sizeType:d,managers:h,fontWeight:u,fontSize:p,canTranscribeVoice:f}),P=document.createElement("div");P.classList.add("document-container"),P.dataset.mid=""+S,P.dataset.peerId=""+L.peerId;const E=document.createElement("div");if(E.classList.add("document-wrapper"),L.message){const k=document.createElement("div");k.classList.add("document-message");let A=m;A||(A=us(L.message,{...g,entities:L.totalEntities,maxMediaTimestamp:Bd(L)})),St(k,A),E.append(k)}if(v.length>1){const k=document.createElement("div");k.classList.add("document-selection"),P.append(k),P.classList.add("grouped-item"),I===0&&(y=E)}return E.append(M),P.append(E),P}),w=await Promise.all(b);return s.append(...w),v.length>1&&t.classList.add("is-multiple-documents","is-grouped"),y}class Nf extends Tt{async init(e){this.container.id="poll-results-container",this.container.classList.add("chatlist-container"),this.resultsDiv=document.createElement("div"),this.resultsDiv.classList.add("poll-results"),this.scrollable.append(this.resultsDiv);const t=await this.managers.appPollsManager.getPoll(e.media.poll.id);this.setTitle(t.poll.pFlags.quiz?"PollResults.Title.Quiz":"PollResults.Title.Poll");const s=document.createElement("h3");St(s,Pe(t.poll.question));const i=t.results.results.map(a=>a.voters/t.results.total_voters*100);Gb(i);const n=document.createDocumentFragment();t.results.results.forEach((a,r)=>{if(!a.voters)return;const l=document.createElement("hr"),c=t.poll.answers[r],d=document.createElement("div");d.classList.add("poll-results-answer");const h=document.createElement("div");St(h,Pe(c.text));const u=document.createElement("div");u.innerText=Math.round(i[r])+"%",d.append(h,u);const p=Qe.createChatList();p.classList.add("poll-results-voters"),Qe.setListClickListener({list:p,onFound:()=>{ss.onCloseBtnClick()},withContext:void 0,autonomous:!0}),p.style.minHeight=Math.min(a.voters,4)*48+"px",n.append(l,d,p);let m,g=4,f=!1,y=Math.max(0,a.voters-4);const v=()=>{f||(f=!0,this.managers.appPollsManager.getVotes(e,c.option,m,g).then(w=>{w.votes.forEach(S=>{const{dom:I}=Qe.addDialogNew({peerId:Je(S.peer),container:p,rippleEnabled:!1,meAsSaved:!1,avatarSize:"small",withStories:!1,wrapOptions:{middleware:this.middlewareHelper.get()}});I.lastMessageSpan.parentElement.remove()}),m&&(y=Math.max(0,y-w.votes.length),y&&b.lastElementChild.replaceWith(_("PollResults.LoadMore",[Math.min(20,y)]))),m=w.next_offset,g=20,(!y||!w.votes.length)&&b.remove()}).finally(()=>{f=!1}))},b=Ve("poll-results-more btn btn-primary btn-transparent",{icon:"down"});b.addEventListener("click",v),b.append(_("PollResults.LoadMore",[Math.min(20,y)])),n.append(b),v()}),this.resultsDiv.append(s,n),ss.toggleSidebar(!0).then(()=>{})}}let Of=0;const C0=9,Yr=10,$b=340,Uf=$b/Yr,Gb=o=>{const e=o.reduce((t,s)=>t+Math.round(s),0);if(e>100){const t=e-100,s=o.length;for(let i=0;i<t;++i){let n=-1,a=1;for(let r=0;r<s;++r){const l=o[r]%1;l>=.5&&l<a&&(a=l,n=r)}if(n===-1)return;o[n]-=a}}else if(e<100){const t=100-e,s=o.length;for(let i=0;i<t;++i){let n=-1,a=0;for(let r=0;r<s;++r){const l=o[r]%1;l<.5&&l>a&&(a=l,n=r)}if(n===-1)return;o[n]+=1-a}}};C.addEventListener("poll_update",({poll:o,results:e})=>{Array.from(document.querySelectorAll(`poll-element[poll-id="${o.id}"]`)).forEach(s=>{s.isClosed=!!o.pFlags.closed,s.performResults(e,o.chosenIndexes)})});Fe.addEventListener("resize",()=>{Pr.setMaxLength(),Pr.resizePolls()});Fe.addEventListener("changeScreen",()=>{Pr.setMaxLength()});const Ou=(o,e,t)=>{o.classList.remove("active"),clearTimeout(t),setTimeout(()=>{e?.(),o.remove(),ar===o&&xl===e&&Al===t&&(ar=xl=null,Al=0)},200)};let ar,xl,Al,Hf=!1;const zb=o=>{ar&&Ou(ar,xl,Al);const e=document.createElement("div");e.classList.add("quiz-hint","from-"+o.from);const t=document.createElement("div");t.classList.add("quiz-hint-container");const s=document.createElement("div");s.classList.add("quiz-hint-text");let i;o.textRight&&(i=document.createElement("div"),i.classList.add("quiz-hint-text-right"),i.append(o.textRight),t.classList.add("has-right-text")),t.append(...[Le(o.icon,"quiz-hint-icon"),s,i].filter(Boolean)),e.append(t),St(s,o.textElement),o.appendTo.append(e),e.offsetLeft,e.classList.add("active");const n=()=>{Ou(e,o.onHide,a)};ar=e,xl=o.onHide;const a=Al=window.setTimeout(n,o.duration);return Hf||(Hf=!0,ce.addEventListener("peer_changed",()=>{ar&&Ou(ar,xl,Al)})),{hide:n}},dr=class dr extends HTMLElement{constructor(){super(...arguments),this.isClosed=!1,this.isQuiz=!1,this.isRetracted=!1,this.isPublic=!1,this.isMultiple=!1,this.chosenIndexes=[],this.chosingIndexes=[],this.sentVote=!1,this.clickHandler=e=>{const t=U(e.target,"poll-answer");if(!t)return;X(e);const s=+t.dataset.index;if(this.isMultiple){t.classList.toggle("is-chosing");const i=this.chosingIndexes.indexOf(s);i!==-1?this.chosingIndexes.splice(i,1):this.chosingIndexes.push(s)}else this.sendVotes([s])}}static setMaxLength(){const e=nt.width<=360?nt.width-120:Fe.active.poll.width;this.MAX_LENGTH=e+C0+this.MAX_OFFSET+-13.7}static resizePolls(){if(!this.MAX_LENGTH)return;Array.from(document.querySelectorAll("poll-element.is-voted")).forEach(t=>{t.svgLines.forEach((s,i)=>{t.setLineProgress(i,1)})})}async render(){Of||(Of=document.getElementById("poll-line").getTotalLength(),dr.setMaxLength());const{poll:e,results:t}=this.message.media;this.message.pFlags.is_scheduled&&this.classList.add("disable-hover");let s;e.pFlags&&(this.isPublic=!!e.pFlags.public_voters,this.isQuiz=!!e.pFlags.quiz,this.isClosed=!!e.pFlags.closed,this.isMultiple=!!e.pFlags.multiple_choice,this.isClosed?(s="Chat.Poll.Type.Closed",this.classList.add("is-closed")):this.isQuiz?s=this.isPublic?"Chat.Poll.Type.Quiz":"Chat.Poll.Type.AnonymousQuiz":s=this.isPublic?"Chat.Poll.Type.Public":"Chat.Poll.Type.Anonymous"),this.classList.toggle("is-multiple",this.isMultiple);const i=e.answers.map((r,l)=>{const c=`
      <div class="poll-answer" data-index="${l}">
        <div class="circle-hover">
          <div class="animation-ring"></div>
          <svg class="progress-ring">
            <circle class="progress-ring__circle" cx="13" cy="13" r="9"></circle>
          </svg>
        </div>
        <div class="poll-answer-percents"></div>
        <div class="poll-answer-text"></div>
        <svg version="1.1" class="poll-line" style="display: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 485.9 35" xml:space="preserve">
          <use href="#poll-line"></use>
        </svg>
      </div>
      `,d=zl(c);if(this.isMultiple){const u=document.createElement("span");u.classList.add("poll-answer-selected"),u.append(Le("check")),d.firstElementChild.firstElementChild.append(u)}const h=document.createElement("span");return h.classList.add("poll-answer-selected"),d.firstElementChild.append(h),d});if(this.innerHTML=`
      <div class="poll-title"></div>
      <div class="poll-desc">
        <div class="poll-type"></div>
        <div class="poll-avatars"></div>
      </div>
    `,this.append(...i),St(this.firstElementChild,Pe(e.question)),Array.from(this.querySelectorAll(".poll-answer-text")).forEach((r,l)=>{St(r,Pe(e.answers[l].text))}),this.descDiv=this.firstElementChild.nextElementSibling,this.typeDiv=this.descDiv.firstElementChild,this.avatarsDiv=this.descDiv.lastElementChild,s&&this.typeDiv.append(_(s)),this.isQuiz&&(this.classList.add("is-quiz"),e.close_period&&e.close_date)){const r=document.createElement("div");r.classList.add("poll-time"),this.descDiv.append(r);const l=document.createElementNS("http://www.w3.org/2000/svg","svg");l.classList.add("poll-quiz-timer"),this.quizTimer=l;const c=2,d=7,h=2*Math.PI*d,u=document.createElementNS("http://www.w3.org/2000/svg","circle");u.classList.add("poll-quiz-timer-circle"),u.setAttributeNS(null,"cx","16"),u.setAttributeNS(null,"cy","16"),u.setAttributeNS(null,"r",""+d),u.setAttributeNS(null,"stroke-width",""+c),l.append(u),this.descDiv.append(l);const p=e.close_period*1e3,m=(e.close_date-await C.managers.timeManager.getServerTimeOffset())*1e3;this.quizInterval=window.setInterval(()=>{const g=Date.now(),f=(m-g)/p,y=(m-g)/1e3+1|0;r.textContent=Ci(y),y<=5&&(r.style.color="#ee545c",u.style.stroke="#ee545c"),u.style.strokeDashoffset=h+f*h,u.style.strokeDasharray=`${h} ${h}`,g>=m&&(clearInterval(this.quizInterval),r.replaceChildren(),u.style.strokeDashoffset=h,this.quizInterval=0,setTimeout(()=>{this.managers.appPollsManager.getResults(this.message)},3e3))},1e3)}this.answerDivs=Array.from(this.querySelectorAll(".poll-answer")),this.svgLines=Array.from(this.querySelectorAll(".poll-line")),this.numberDivs=Array.from(this.querySelectorAll(".poll-answer-percents"));const n=document.createElement("div");n.classList.add("poll-footer"),this.viewResults=document.createElement("div"),this.viewResults.className="poll-footer-button poll-view-results hide",this.viewResults.append(_("Chat.Poll.ViewResults")),this.votersCountDiv=document.createElement("div"),this.votersCountDiv.className="poll-votes-count",n.append(this.viewResults,this.votersCountDiv),this.append(n),this.viewResults.addEventListener("click",r=>{X(r),ss.isTabExists(Nf)||ss.createTab(Nf).open(this.message)}),pi(this.viewResults),this.isMultiple&&(this.sendVoteBtn=document.createElement("div"),this.sendVoteBtn.classList.add("poll-footer-button","poll-send-vote"),this.sendVoteBtn.append(_("Chat.Poll.SubmitVote")),pi(this.sendVoteBtn),e.chosenIndexes.length||this.votersCountDiv.classList.add("hide"),D(this.sendVoteBtn,r=>{X(r),this.chosingIndexes.length&&this.sendVotes(this.chosingIndexes).then(()=>{this.chosingIndexes.length=0,this.answerDivs.forEach(l=>{l.classList.remove("is-chosing")})})}),n.append(this.sendVoteBtn));const a=!(e.chosenIndexes.length||this.isClosed);(!a||this.isPublic)&&this.performResults(t,e.chosenIndexes,!1),a&&(this.setVotersCount(t),this.detachClickEvent=D(this,this.clickHandler))}initQuizHint(e){if(e.solution&&e.solution_entities){const t=document.createElement("div");if(t.classList.add("poll-hint"),t.append(Le("tip")),this.descDiv.append(t),D(t,s=>{X(s),t.classList.add("active"),zb({textElement:us(e.solution,{entities:e.solution_entities}),appendTo:ce.chat.bubbles.container,from:"top",duration:Ye?5e3:7e3,icon:"info2",onHide:()=>{t.classList.remove("active")}})}),this.sentVote){const s=e.results.find(i=>i.pFlags.correct);s&&!s.pFlags.chosen&&hs(t)}}}sendVotes(e){if(this.sendVotePromise)return this.sendVotePromise;const t=this.answerDivs.filter((s,i)=>e.includes(i));return t.forEach(s=>{s.classList.add("is-voting")}),this.classList.add("disable-hover"),this.sentVote=!0,this.sendVotePromise=this.managers.appPollsManager.sendVote(this.message,e).then(()=>{t.forEach(s=>{s.classList.remove("is-voting")}),this.classList.remove("disable-hover")}).catch(()=>{this.sentVote=!1}).finally(()=>{this.sendVotePromise=null})}performResults(e,t,s=!0){if(et.isAvailable("animations")||(s=!1),this.isQuiz&&(e.results?.length||this.isClosed)&&(this.answerDivs.forEach((n,a)=>{const l=!!e.results[a].pFlags.correct;n.classList.toggle("is-correct",l)}),this.initQuizHint&&(this.initQuizHint(e),this.initQuizHint=null),this.quizInterval&&(clearInterval(this.quizInterval),this.quizInterval=0),this.quizTimer?.parentElement&&this.quizTimer.remove(),this.descDiv.querySelector(".poll-time")?.remove()),this.isClosed&&(this.classList.add("is-closed"),tt(this.typeDiv,_("Chat.Poll.Type.Closed"))),(this.chosenIndexes.length!==t.length||this.isClosed)&&(this.isRetracted=this.chosenIndexes.length&&!t.length,this.chosenIndexes=t.slice(),this.isRetracted?this.detachClickEvent=D(this,this.clickHandler):(this.detachClickEvent?.(),this.detachClickEvent=void 0)),this.chosenIndexes.length||this.isRetracted||this.isClosed){const i=e.results.map(n=>e.total_voters?n.voters/e.total_voters*100:0);this.classList.toggle("no-transition",!s),s&&vt({element:this,className:"",forwards:!this.isRetracted,duration:340}),vs(()=>{this.setResults(this.isRetracted?this.percents:i,this.chosenIndexes,s),this.percents=i,this.isRetracted=!1})}if(this.setVotersCount(e),this.isPublic){this.isMultiple||(this.viewResults.classList.toggle("hide",!e.total_voters||!this.chosenIndexes.length),this.votersCountDiv.classList.toggle("hide",!!this.chosenIndexes.length));const i=(e.recent_voters||[]).map(a=>Je(a)),n=new Wo({avatarSize:16,middleware:this.middlewareHelper.get()});n.render(i),tt(this.avatarsDiv,n.container)}if(this.isMultiple){const i=!!this.chosenIndexes.length,n=this.isClosed||i,a=!this.isPublic||!e.total_voters||!i&&!this.isClosed;this.sendVoteBtn.classList.toggle("hide",n),this.viewResults.classList.toggle("hide",a),this.votersCountDiv.classList.toggle("hide",!n||!a)}}setResults(e,t,s){this.svgLines.forEach(r=>r.style.display=""),this.answerDivs.forEach((r,l)=>{const c=t.includes(l);r.classList.toggle("is-chosen",c);const d=r.lastElementChild;let h;r.classList.contains("is-correct")||!this.isQuiz&&c?h=Le("check"):c&&(h=Le("close")),d.replaceChildren(h)});const i=Math.max(...e);if(this.maxPercents=e.map(r=>r/i),this.isRetracted)this.svgLines.forEach((r,l)=>{this.setLineProgress(l,-1)});else{const r=()=>{this.svgLines.forEach((l,c)=>{this.setLineProgress(c,1)})};s?vs(r):r()}e=e.slice(),Gb(e);let n;const a=r=>{e.forEach((l,c)=>{const d=n(l,r);this.numberDivs[c].innerText=d+"%"})};if(this.isRetracted)if(n=(r,l)=>Math.round(r/Yr*l),s)for(let r=Yr-1,l=0;r>=0;--r,++l)setTimeout(()=>{a(r)},Uf*l);else a(0);else if(n=(r,l)=>Math.round(r/Yr*(l+1)),s)for(let r=0;r<Yr;++r)setTimeout(()=>{a(r)},Uf*r);else a(Yr-1);if(this.isRetracted){s&&this.classList.add("is-retracting"),this.classList.remove("is-voted");const r=()=>{this.svgLines.forEach(l=>l.style.display="none")};s?setTimeout(()=>{this.classList.remove("is-retracting"),r()},$b):r()}else this.classList.add("is-voted")}setVotersCount(e){const t=e.total_voters||0;let s;const i=[t];this.isClosed?this.isQuiz?s=t?"Chat.Quiz.TotalVotes":"Chat.Quiz.TotalVotesResultEmpty":s=t?"Chat.Poll.TotalVotes1":"Chat.Poll.TotalVotesResultEmpty":this.isQuiz?s=t?"Chat.Quiz.TotalVotes":"Chat.Quiz.TotalVotesEmpty":s=t?"Chat.Poll.TotalVotes1":"Chat.Poll.TotalVotesEmpty",tt(this.votersCountDiv,_(s,i))}setLineProgress(e,t){const s=this.svgLines[e];t===-1?(s.style.strokeDasharray="",s.style.strokeDashoffset=""):(s.style.strokeDasharray=t*this.maxPercents[e]*dr.MAX_LENGTH+", 485.9",s.style.strokeDashoffset=""+t*dr.MAX_OFFSET)}};dr.MAX_OFFSET=-46.5,dr.MAX_LENGTH=0;let Pr=dr;customElements.define("poll-element",Pr);function I0(o,e=C.managers,t){const s=new Pr;return s.message=o,s.managers=e,s.setAttribute("peer-id",""+o.peerId),s.setAttribute("poll-id",o.media.poll.id),s.setAttribute("message-id",""+o.mid),s.middlewareHelper=t.create(),s.render(),s}const L0="A-Za-zÃ-ÃÃ-Ã¶Ã¸-Ê¸Ì-Öà -á¿¿â°-ï¬ï·¾-ï¹¯ï»½-ï¿¿",Kb="Ö-ß¿ï¬-ï·½ï¹°-ï»¼",M0=new RegExp("^[^"+L0+"]*["+Kb+"]"),Wb=new RegExp("["+Kb+"]");function P0(o,e){return e?Wb.test(o):M0.test(o)}function E0(o){return Wb.test(o?.slice(-1))}async function jb(o){const{peerId:e,threadId:t,lastMsgId:s}=o,i=Promise.resolve(),n=QC("t.me/c/"+e.toChatId()+(t?"/"+Gi(t):"")+(s?"/"+Gi(s):""));return n.classList.add("topic-name","topic-name-button"),n.append(await Oe(o)),{cached:!0,element:n,loadPromise:i}}const Sd="popup-chatlist-invite";class rg extends J{constructor(e){super("popup-forward "+Sd,{closable:!0,overlayClosable:!0,body:!0,footer:!0,title:!0,withConfirm:!0}),Lt(this,e),this.construct()}async construct(){const e=document.createElement("div");e.classList.add("menu-horizontal-scrollable");const t=document.createElement("nav");t.classList.add("menu-horizontal-div");const{chatlistInvite:s,deleting:i,updating:n}=this,a=s?._==="chatlists.chatlistInviteAlready",r=a&&!!s.missing_peers.length,l=this.filter??(this.filter=a?await this.managers.filtersStorage.getFilter(s.filter_id):void 0);this.title.append(_(i?"SharedFolder.Link.TitleRemove":r?"SharedFolder.Link.TitleAdd":"SharedFolder.Link.Title"));let c;i&&(c=(await this.managers.filtersStorage.getLeaveChatlistSuggestions(this.filter.id)).map(E=>Je(E)));const d=()=>{const P=document.createElement("div");P.classList.add("menu-horizontal-div-item");const E=document.createElement("span");return E.classList.add("menu-horizontal-div-item-span"),P.append(E),t.append(P),E};d().append(_("FilterAllChats"));const h=d();h.parentElement.classList.add("active"),h.append(Pe(l?l.title:s.title),document.createElement("i")),d().append(_("FilterPersonal"));const u=document.createElement("div");u.classList.add("inner-shadow","inner-shadow-inset"),e.append(t,u);const p=document.createElement("div");p.classList.add(Sd+"-description","subtitle");let m;i?$t(p,"SharedFolder.Link.DescriptionRemove",[Pe(l.title)]):r?m=new De.IntlElement:$t(p,a?"SharedFolder.Link.DescriptionAlready":"SharedFolder.Link.Description");const g=new De.IntlElement,f=P=>{w&&r&&(P=Math.max(0,P-w.length)),g.update({key:i?"SharedFolder.Link.ChatsRemove":r?"SharedFolder.Link.ChatsAdd":a?"SharedFolder.Link.ChatsAlready":"SharedFolder.Link.Chats",args:[_("Chats",[P])]}),v?.update({key:(y=P===b.length)?"DeselectAll":"SelectAll"}),m?.update({key:"SharedFolder.Link.DescriptionAdd",args:[_("Chats",[P]),Pe(l.title)]}),v&&(P&&(I.dataset.badge=""+P),I.classList.toggle("has-badge",!!P)),i&&S.update({key:P?"SharedFolder.Link.Remove":"SharedFolder.Link.TitleRemove"}),i||zt([this.btnConfirm],!P)};let y;this.selector=new li({middleware:this.middlewareHelper.get(),appendTo:this.body,onChange:f,onFirstRender:()=>{this.show(),this.selector.checkForTriggers()},multiSelect:!0,noSearch:!0,sectionNameLangPackKey:g.element,avatarSize:"abitbigger",managers:this.managers,peerType:[],getSubtitleForElement:async P=>{if(w?.includes(P)){const E=await this.managers.appPeersManager.isBroadcast(P);return _(E?"SharedFolder.Link.ChannelAlready":"SharedFolder.Link.ChatAlready")}},processElementAfter:(P,E)=>{w?.includes(P)&&E.dom.containerEl.classList.add("already")}});let v;(!a||r)&&(v=new De.IntlElement,v.element.classList.add("sidebar-left-section-name-right"),this.selector.section.title.append(v.element),D(v.element,()=>{y?this.selector.removeBatch(b):this.selector.addBatch(b)},{listenerSetter:this.listenerSetter}));let b;s?b=(r?s.missing_peers:a?s.already_peers:s.peers).map(E=>Je(E)):b=l.includePeerIds;let w;if(a&&(w=s.already_peers.map(P=>Je(P))),w){const P=this.selector.remove.bind(this.selector);this.selector.remove=(...E)=>{const k=E[0].toPeerId();if(w.includes(k)){const A=this.selector.getElementByPeerId(k);return Ha(A),!1}return P(...E)}}this.scrollable=this.selector.scrollable,this.attachScrollableListeners(),this.scrollable.prepend(e,p),this.btnConfirm.classList.add(`${Sd}-button`);const S=new De.IntlElement({key:i?"SharedFolder.Link.Remove":r?"SharedFolder.Link.Join":a?"OK":"SharedFolder.Link.Title"}),I=S.element;I.classList.add(`${Sd}-button-text`),this.btnConfirm.append(I),this.footer.append(this.btnConfirm),D(this.btnConfirm,()=>{if(a&&!r){this.hide();return}let P;const E=zt([this.btnConfirm],!0),k=[...this.selector.selected];n?P=this.managers.filtersStorage.joinChatlistUpdates(this.filter.id,k):s?P=this.managers.filtersStorage.joinChatlistInvite(this.slug,k).catch(A=>{if(A.type==="DIALOG_FILTERS_TOO_MUCH")Hn("folders"),this.hide();else throw A}):P=this.managers.filtersStorage.leaveChatlist(this.filter.id,k),P.then(()=>{this.hide()},A=>{throw E(),A})},{listenerSetter:this.listenerSetter});const L=w?b.concat(w):b,M=i?c:L;this.selector.addInitial(M),this.selector.renderResultsFunc(i?Ua(c.concat(L)):L),M.length||f(0),this.body.after(this.footer)}}const _0=new Set(["showMaskedAlert","execBotCommand"]);function Bs(o){window[(o.protocol?o.protocol+"_":"")+o.name]=(e,t)=>{!o.noCancelEvent&&X(null);let s=e.href;if(!s)return;let i,n;const a=new URL(s),r=a.host.match(/(.+?)\.t(?:elegram)?\.me/);r&&!rC.has(r[1])&&(a.pathname=r[1]+(a.pathname==="/"?"":a.pathname),s=a.toString()),o.noPathnameParams||(i=new URL(s).pathname.split("/").slice(1)),o.noUriParams||(n=Qy(s));const l=e.href!==e.textContent&&e.getAttribute("safe")===null,c=o.callback({pathnameParams:i,uriParams:n},e,l);if(!t?.isTrusted)return c}}function Ao(o,e,t){const s=document.createElement(o);return s.className=`badge badge-${e} badge-${t} is-badge-empty`,s}const qb=He("<div>"),k0=He("<div><div>"),T0=He("<hr>"),x0=He("<div class=sidebar-left-section-name-right>"),Fl="sidebar-left-section",Qb=o=>(()=>{const e=qb();return q(e,()=>o.children),mt(()=>st(e,jt(Fl+"-content",o.class))),e})(),Vf=o=>ke(Qb,{class:Fl+"-caption",get children(){return _(o.caption,o.captionArgs)}}),Ws=o=>(()=>{const e=k0(),t=e.firstChild,s=o.ref;return typeof s=="function"?Nt(s,e):o.ref=e,q(t,(()=>{const i=he(()=>!!o.fakeGradientDelimiter);return()=>i()?Hh():(()=>{const n=he(()=>!o.noDelimiter);return()=>n()&&T0()})()})(),null),q(t,ke(Qb,{get children(){return[he(()=>he(()=>!!o.name)()&&(()=>{const i=qb();return q(i,(()=>{const n=he(()=>typeof o.name=="string");return()=>n()?_(o.name,o.nameArgs):o.name})(),null),q(i,(()=>{const n=he(()=>!!o.nameRight);return()=>n()&&(()=>{const a=x0();return q(a,()=>o.nameRight),a})()})(),null),mt(()=>st(i,jt("sidebar-left-h2",Fl+"-name"))),i})()),he(()=>o.children)]}}),null),q(t,(()=>{const i=he(()=>!!(o.caption&&o.captionOld));return()=>i()&&ke(Vf,o)})(),null),q(e,(()=>{const i=he(()=>!!(o.caption&&!o.captionOld));return()=>i()&&ke(Vf,o)})(),null),mt(i=>{const n=jt(Fl+"-container",o.class),a=jt(Fl,o.noShadow&&"no-shadow",o.fakeGradientDelimiter?"with-fake-delimiter":o.noDelimiter&&"no-delimiter");return n!==i._v$&&st(e,i._v$=n),a!==i._v$2&&st(t,i._v$2=a),i},{_v$:void 0,_v$2:void 0}),e})(),A0=He("<div>");let $f=!1;const F0=()=>{if($f)return;const o=[];cc.forEach((e,t)=>{const s=[...e.keys()],i=C.managers.appStoriesManager.getStoriesById(t,s,!0).then(()=>{s.forEach(n=>{e.get(n).mounted||(e.delete(n),e.size||cc.delete(t))})});o.push(i)}),Promise.all(o).then(()=>{$f=!1})},cc=new Map;window.wrappedStories=cc;setInterval(F0,3e5);const zc=o=>{const[e,t]=we(),[s,i]=we(),[n,a]=we(!1);let r=cc.get(o.peerId);r||cc.set(o.peerId,r=new Map);let l=r.get(o.storyItem.id);l||r.set(o.storyItem.id,l={mounted:0}),++l.mounted,Et(()=>{--l.mounted});const c=vl(o.storyItem.media),d=Ii().get();let h;const u=(()=>{const f=A0(),y=h;return typeof y=="function"?Nt(y,f):h=f,$o(f,an(()=>o.containerProps||{}),!1,!1),f})(),p=(f,y)=>{[f.images.thumb,f.images.full].filter(Boolean).forEach(v=>{v.classList.add(y)})},m={photo:f=>{const y=f.document||f.photo,v=Ns({...o,container:h,photo:y,middleware:d,...o.forPreview&&{...o.noAspecter&&{size:ji(y,150,200)},useRenderCache:!1},...o.forViewer&&{size:ji(y,1/0,1/0),noFadeIn:!0},withoutPreloader:!o.withPreloader});return v.then(async b=>{d()&&(o.childrenClassName&&p(b,o.childrenClassName),await b.loadPromises.thumb,d()&&(t(b.images.thumb),a(!0),await b.loadPromises.full,d()&&i(b.images.full)))}),v},video:f=>{const y=f.document,v=f.alt_document,b=On({...o,container:h,doc:y,altDoc:v,middleware:d,...o.forViewer&&{noInfo:!0,noAutoplayAttribute:!0},...o.forPreview&&{...o.noAspecter&&{photoSize:ji(y,200,200,!1)},onlyPreview:!0},withoutPreloader:!o.withPreloader});return b.then(async w=>{if(!d()||(o.childrenClassName&&(w?.thumb&&p(w.thumb,o.childrenClassName),w?.video&&w.video.classList.add(o.childrenClassName)),w?.thumb&&await w.thumb.loadPromises.thumb,!d()))return;w?.thumb&&t(w.thumb.images.full||w.thumb.images.thumb),a(!0);const S=w?.video;S&&o.forViewer&&(S.loop=!1,S.muted=!0,Yi&&S.load()),await w?.loadPromise,d()&&i(S)}),b}};let g;switch(c._){case"messageMediaPhoto":{g=m.photo(c);break}case"messageMediaDocument":{g=m.video(c);break}}return{container:u,div:h,media:s,mediaResult:g,thumb:e,ready:n}},R0=o=>{let{loadPromises:e}=o;e&&delete o.loadPromises;const t=e&&Rt();e?.push(t),e=void 0;const[s,i]=we(void 0,{equals:!1}),[n,a]=we();return C.managers.acknowledged.appStoriesManager.getStoryById(o.peerId,o.storyId).then(async l=>{l.cached||t?.resolve();const c=await l.result;i(c)}),Ne(xi(()=>s(),l=>{if(!l){o.onExpiredStory?.(),t.resolve();return}Et(()=>{t?.reject()});const{container:c,ready:d}=zc({...o,storyItem:l,forPreview:!0});Ne(xi(()=>d(),()=>{t?.resolve(),a(c)},{defer:!0}))},{defer:!0})),n},D0=He("<span class=statistics-overview-item-value-description>"),B0=He("<span>"),N0=He("<div class=statistics-overview-item><div class=statistics-overview-item-value></div><div class=statistics-overview-item-name>"),O0=He("<div class=statistics-overview>"),U0=He("<div class=statistics-chart>"),H0=He("<div>"),V0={growth_graph:"GrowthChartTitle",followers_graph:"FollowersChartTitle",mute_graph:"Notifications",top_hours_graph:"TopHoursChartTitle",views_by_source_graph:"ViewsBySourceChartTitle",new_followers_by_source_graph:"NewFollowersBySourceChartTitle",languages_graph:"LanguagesChartTitle",interactions_graph:"InteractionsChartTitle",iv_interactions_graph:"IVInteractionsChartTitle",reactions_by_emotion_graph:"ReactionsByEmotionChartTitle",story_interactions_graph:"StoryInteractionsChartTitle",story_reactions_by_emotion_graph:"StoryReactionsByEmotionChartTitle"},$0={growth_graph:"GrowthChartTitle",members_graph:"GroupMembersChartTitle",new_members_by_source_graph:"NewMembersBySourceChartTitle",languages_graph:"MembersLanguageChartTitle",messages_graph:"MessagesChartTitle",actions_graph:"ActionsChartTitle",top_hours_graph:"TopHoursChartTitle",weekdays_graph:"TopDaysOfWeekChartTitle"},Yb={views_graph:"ViewsAndSharesChartTitle",reactions_by_emotion_graph:"ReactionsByEmotionChartTitle"},G0=Yb,z0={followers:"FollowersChartTitle",enabled_notifications:"EnabledNotifications",views_per_post:"ViewsPerPost",views_per_story:"ViewsPerStory",shares_per_post:"SharesPerPost",shares_per_story:"SharesPerStory",reactions_per_post:"ReactionsPerPost",reactions_per_story:"ReactionsPerStory"},K0={members:"MembersOverviewTitle",messages:"MessagesOverview",viewers:"ViewingMembers",posters:"PostingMembers"},Xb={views:"StatisticViews",public_shares:"PublicShares",reactions:"Reactions",private_shares:"PrivateShares"},W0=Xb;let j0,Zb;function q0(){return j0??(j0=oC(()=>import("./chart-8tjcGii-.js"),__vite__mapDeps([0,1]),import.meta.url).then(o=>{Zb=o.default}))}function Q0(o){return o.substring(o.indexOf("#"))}const yn=(o,e)=>({_:"statsAbsValueAndPrev",current:o,previous:0,approximate:e}),tu=(o={})=>we({rendered:[],values:[],left:0,count:0,...o},{equals:!1}),Bp=(o,e,t,s="PollResults.LoadMore")=>{const i=Ve("btn btn-primary btn-transparent primary",{icon:"down",text:s,textArgs:[o]});return D(i,()=>{e(i)},{listenerSetter:t}),i},Y0=({value:o,title:e,includeZeroValue:t,describePercentage:s})=>{const i=o._==="statsPercentValue";let n;if(i)n=`${(o.part/o.total*100).toFixed(2)}%`,s&&(n=[he(()=>`â${o.part} `),(()=>{const r=D0();return q(r,n),r})()]);else{if(n=Ri(o.current,1),o.approximate&&(n="â"+n),!o.current&&!o.previous&&!t)return;if(o.current!==o.previous&&o.previous){const a=o.current-o.previous,r=Math.abs(a),l=`${a>0?"+":"-"}${Ri(r,1)}`,c=+(Math.abs(1-o.current/o.previous)*100).toFixed(2),d=`${l} (${c}%)`;n=[n," ",(()=>{const h=B0();return q(h,d),mt(()=>st(h,jt("statistics-overview-item-value-description",a>0?"green":"red"))),h})()]}}return(()=>{const a=N0(),r=a.firstChild,l=r.nextSibling;return q(r,n),q(l,()=>_(e)),a})()},Jb=o=>(()=>{const e=O0();return q(e,ke(Mi,{get each(){return o.items},children:Y0})),e})();class Kc extends Kt{constructor(){super(...arguments);rd(this,"renderPeer",async t=>{const s=t._==="message"?t.peerId:t.user_id.toPeerId(!1),i=[],{dom:n}=Qe.addDialogNew({peerId:s,container:!1,rippleEnabled:!0,avatarSize:"abitbigger",loadPromises:i,wrapOptions:{middleware:this.middlewareHelper.get()},meAsSaved:!1});let a;return t._==="message"?(a=[await Nn(s.toChatId()),_("Views",[Ri(t.views,1)])],n.listEl.dataset.mid=""+t.mid):t._==="statsGroupTopPoster"?a=[t.messages&&_("messages",[t.messages]),t.avg_chars&&_("CharactersPerMessage",[_("Characters",[t.avg_chars])])]:t._==="statsGroupTopAdmin"?a=[t.deleted&&_("Deletions",[t.deleted]),t.banned&&_("Bans",[t.banned]),t.kicked&&_("Restrictions",[t.kicked])]:a=[t.invitations&&_("Invitations",[t.invitations])],a=a.filter(Boolean),a.length&&n.lastMessageSpan.replaceChildren(...ci(a,!1)),await Promise.all(i),{container:n.listEl,peerId:s}});rd(this,"renderPublicForward",async t=>{if(t._==="publicForwardMessage"){const n=t.message;return this.renderRecentPost({_:"postInteractionCountersMessage",forwards:n.forwards,msg_id:n.mid,views:n.views,reactions:n.reactions?n.reactions.results.reduce((a,r)=>a+r.count,0):0},n.peerId,n)}const s=t.story;if(!s)return;const i=s.views;return this.renderRecentPost({_:"postInteractionCountersStory",forwards:i?.forwards_count||0,story_id:s.id,views:i?.views_count||0,reactions:i?.reactions_count||0},Je(t.peer),void 0,s)})}onOpenAfterTimeout(){this.openPromise.resolve()}_construct(t,s,i,n,a,r){const l=this,c=new De.IntlDateElement({options:{}}),d=(M,P={})=>{P.displayYear??(P.displayYear=!0),P.isMonthShort??(P.isMonthShort=!0);const E=new Date(M);return c.update({date:E,options:{weekday:P.displayWeekDay?P.isShort?"short":"long":void 0,year:P.displayYear?"numeric":void 0,hour:P.displayHours?"2-digit":void 0,minute:P.displayHours?"2-digit":void 0,month:P.isMonthShort?"short":"long",day:"numeric"}}),c.element.textContent},h=M=>{const P=new Date(M);return c.update({date:P,options:{hour:"2-digit",minute:"2-digit"}}),c.element.textContent},u=()=>{const M=fs.getProperty("surface-color"),P=fs.getProperty("primary-color"),E=fs.getProperty("secondary-color"),k=tn(M),A=yl(tn(E),yl(tn(P),k,.1),.2),x=yl(tn(E),yl(tn(P),k,.3),.4);return{primary:fs.getProperty("primary-color"),secondary:fs.getProperty("secondary-color"),background:M,backgroundRgb:k,text:fs.getProperty("primary-text-color"),dates:fs.getProperty("secondary-text-color"),grid:`rgba(${tn(fs.getProperty("secondary-text-color")).join(", ")}, 0.2)`,axis:{x:fs.getProperty("secondary-text-color"),y:fs.getProperty("secondary-text-color")},barsSelectionBackground:`rgba(${k.join(", ")}, 0.5)`,miniMask:`rgba(${A.join(", ")}, 0.6)`,miniFrame:`rgb(${x.join(", ")})`}};let p=u();this.listenerSetter.add(C)("theme_changed",()=>{p=u()});const m=this.isBroadcast?V0:this.isMegagroup?$0:this.isStory?G0:Yb,g=Object.keys(m).map(M=>{const P=this.stats[M];return P&&{statsGraph:P,title:m[M],percentage:M==="languages_graph"}}).filter(Boolean),f=({statsGraph:M,title:P,percentage:E})=>{Ho(()=>{let O=JSON.parse(M.json.data);const F=(H,z)=>{for(const W in H.colors){const ue=H.colors[W];H.colors[W]=Q0(ue)}if(z)for(const W in H.types)H.types[W]==="bar"&&(H.types[W]="area");return H};O=F(O,E);const N={getLabelDate:d,getLabelTime:h,tooltipOnHover:!0},G=M.zoom_token,R=Zb.render({container:T,data:{...O,...N,x_on_zoom:G?async H=>{const z=await this.managers.appStatisticsManager.loadAsyncGraph(G,H,this.dcId);if(z._!=="statsGraphError")return{...F(JSON.parse(z.json.data),E),...N}}:void 0},settings:{darkMode:bs.isNight(),ALL_LABEL:De.format("Chart.Tooltip.All",!0),DATES_SIDE:"left",DATES_WEIGHT:"normal",DATES_FONT_SIZE:14,ZOOM_TEXT:De.format("ZoomOut",!0),FONT:{family:Io,bold:"500",normal:"400"},COLORS:p}}),B=()=>{[["primary-color",p.primary],["background-color",p.background],["background-color-rgb",p.backgroundRgb.join(", ")],["text-color",p.text],["secondary-color",p.secondary],["font-family",Io]].forEach(([z,W])=>{R.$wrapper.style.setProperty(`--tchart-${z}`,W)})};B(),this.listenerSetter.add(C)("theme_changed",()=>{R.setDarkMode(bs.isNight(),{...p}),B()})});const k=document.createElement("div"),A=document.createElement("div");k.classList.add("statistics-title");const x=_(P);x.classList.add("statistics-title-text"),k.append(x);let T;return ke(Ws,{name:k,nameRight:A,get children(){const O=U0(),F=T;return typeof F=="function"?Nt(F,O):T=O,O}})},y=this.stats._==="stats.broadcastStats"?z0:this.isMegagroup?K0:this.isStory?W0:Xb,v=Object.keys(y).map(M=>{const P=this.stats[M];return P&&{value:P,title:y[M]}}).filter(Boolean),b=(M,P)=>Ar([M,P].map(E=>new De.IntlDateElement({date:new Date(E*1e3),options:{month:"short",day:"numeric",year:"numeric"}}).element)," â "),w=this.stats.period,S=["TopMembers","TopAdmins","TopInviters"];let I;const L=[r&&ke(Ws,{get children(){return r.container}}),ke(Ws,{name:"StatisticOverview",get nameRight(){return w&&b(w.min_date,w.max_date)},get children(){return ke(Jb,{items:v})}}),ke(Mi,{each:g,children:f}),he((()=>{const M=he(()=>!!t.length);return()=>M()&&ke(Ws,{ref(P){const E=I;typeof E=="function"?E(P):I=P},name:"RecentPosts",get children(){return t.map(({container:P})=>P)}})})()),ke(Mi,{each:[s,i,n],children:(M,P)=>{if(!M.length)return;M=M.slice();const E=Qe.createChatList();E.append(...M.splice(0,10).map(({container:A})=>A));let k;return M.length&&(k=Bp(M.length,()=>{k.remove(),E.append(...M.map(({container:A})=>A))},l.listenerSetter)),ke(Ws,{get name(){return S[P()]},get nameRight(){return w&&b(w.min_date,w.max_date)},get children(){return[E,k]}})}}),he((()=>{const M=he(()=>!!a().count);return()=>M()&&ke(Ws,{name:"PublicSharesCount",get nameArgs(){return[a().count]},get children(){return[(()=>{const P=H0();return Nt(E=>{Qe.setListClickListener({list:E,onFound:k=>{if(k.dataset.storyId)return Da({target:()=>k.querySelector(".avatar"),peerId:k.dataset.peerId.toPeerId(),id:+k.dataset.storyId}),!1},withContext:void 0,autonomous:void 0,openInner:!0})},P),q(P,()=>a().rendered),P})(),he(()=>he(()=>!!a().loadMore)()&&Bp(a().count-a().rendered.length,P=>{const E=zt(P,!0);a().loadMore().finally(()=>E())},l.listenerSetter))]}})})())];if(I){const M=new Map;t.forEach(({container:A,postInteractionCounters:x})=>{M.set(A,x)});const P=A=>U(A.target,"statistics-post");let E;const k=()=>{this.slider.createTab(Kc).open(this.chatId,E.msg_id,E.story_id)};D(I,A=>{E=M.get(P(A)),E&&k()},{listenerSetter:this.listenerSetter}),Xi({buttons:[{icon:"statistics",text:"ViewStatistics",onClick:k},{icon:"message",text:"Message.Context.Goto",onClick:()=>{ce.setInnerPeer({peerId:this.chatId.toPeerId(!0),lastMsgId:E.msg_id})},verify:()=>E._==="postInteractionCountersMessage"},{icon:"stories",text:"ViewStory",onClick:()=>{Da({peerId:this.chatId.toPeerId(!0),id:E.story_id})},verify:()=>E._==="postInteractionCountersStory"}],listenTo:I,listenerSetter:this.listenerSetter,findElement:A=>{const x=P(A);return E=M.get(x),x},middleware:this.middlewareHelper.get()})}return L}async renderRecentPost(t,s=this.chatId.toPeerId(!0),i,n,a){const r=document.createDocumentFragment(),l=[["reactions",t.reactions],["reply",t.forwards]];!a&&l.forEach(([p,m])=>{if(!m)return;const g=Le(p,"statistics-post-counter-icon");p==="reply"&&g.classList.add("icon-reflect");const f=document.createElement("span");f.classList.add("statistics-post-counter"),f.append(g,Ri(m,1)),r.append(f)});const c=new ge({title:!0,titleRight:a?void 0:_("Views",[_o(t.views)]),subtitle:!0,subtitleRight:a?void 0:r,clickable:!0,noWrap:!0,asLink:!!(i||n)}),{container:d}=c;d.classList.add("statistics-post"),c.title.classList.add("statistics-post-title");const h=this.middlewareHelper.get(),u=document.createElement("div");if(u.classList.add("statistics-post-media"),i||n){const{node:p,readyThumbPromise:m,setStoriesSegments:g}=ls({middleware:h,size:42,isDialog:!0,peerId:s});c.container.dataset.peerId=""+s,n?(g([{length:1,type:"unread"}]),c.container.dataset.storyId=""+n.id):c.container.dataset.mid=""+i.mid,u.append(p),await m,c.title.append(await Oe({peerId:s})),c.subtitle.append(Ss(i?.date||n?.date)),c.applyMediaElement(u,"abitbigger")}else if(t._==="postInteractionCountersMessage"){if(d.classList.add("statistics-post-message"),i||(i=this.messages.get(t.msg_id)),!await ng({titleEl:c.subtitle,title:Ss(i.date),subtitleEl:c.title,message:i,mediaEl:u,middleware:h,withoutMediaType:!0})){const{node:m,readyThumbPromise:g}=ls({middleware:h,peerId:s,size:42});u.append(m),await g}c.applyMediaElement(u,"abitbigger")}else{d.classList.add("statistics-post-story"),n||(n=this.stories.get(t.story_id)),c.title.append(_("Story")),c.subtitle.append(Ss(n.date));const p=document.createElement("div");p.classList.add("avatar-stories-simple","is-unread"),u.append(p),await qs(m=>{h.onDestroy(m);const{ready:g,div:f}=zc({storyItem:n,peerId:this.chatId.toPeerId(!0),forPreview:!0,noInfo:!0,withPreloader:!1,noAspecter:!0}),y=Rt();return Ne(()=>{g()&&(u.append(f),y.resolve())}),y}),c.applyMediaElement(u,"abitbigger")}return{container:d,postInteractionCounters:t}}async loadStats(){const t=this.chatId.toPeerId(!0),s=this.managers.appStatisticsManager,i=100,n=this.isBroadcast?s.getBroadcastStats:this.isMegagroup?s.getMegagroupStats:this.isStory?s.getStoryStats:s.getMessageStats,a=this.isMessage?this.managers.appMessagesManager.reloadMessages(t,this.mid):void 0,r=this.isMessage?s.getMessagePublicForwards({peerId:t,mid:this.mid,limit:i}):void 0,l=this.isStory?this.managers.appStoriesManager.getStoryById(t,this.storyId):void 0,c=this.isStory?s.getStoryPublicForwards({peerId:t,id:this.storyId,limit:i}):void 0,{stats:d,dcId:h}=await n({peerId:t,dark:bs.isNight(),storyId:this.storyId,mid:this.mid});this.stats=d,this.dcId=h;const u=[];for(const S in d){const I=d[S];if(I._==="statsGraphAsync"){const L=s.loadAsyncGraph(I.token,void 0,h).then(M=>{if(M._==="statsGraphError"){delete d[S];return}d[S]=M});u.push(L)}else I._==="statsGraphError"&&delete d[S]}const p=d.recent_posts_interactions||[];p.forEach(S=>{let I;S._==="postInteractionCountersMessage"?I=this.managers.appMessagesManager.reloadMessages(t,S.msg_id).then(L=>{if(!L){cs(p,S);return}this.messages.set(L.mid,L)}):I=this.managers.appStoriesManager.getStoryById(t,S.story_id).then(L=>{if(!L){cs(p,S);return}this.stories.set(L.id,L)}),u.push(I)});const m=Promise.all([a,r,l,c]).then(async([S,I,L,M])=>{const[P,E]=tu();if(!S&&!L)return P;if(S){this.messages.set(S.mid,S);const k=I.count;d.views=yn(S.views),d.reactions=yn(S.reactions?S.reactions.results.reduce((T,O)=>T+O.count,0):0),d.public_shares=yn(k),d.private_shares=yn(S.forwards-k,!0),E(T=>(T.count=k,T));let A;const x=async T=>{A=T.next_offset;const O=T.forwards.map(this.renderPublicForward),F=await Promise.all(O);E(N=>(N.rendered.push(...F.map(({container:G})=>G)),N.loadMore=A?()=>s.getMessagePublicForwards({peerId:t,mid:this.mid,limit:i,offset:A}).then(x):void 0,N))};await x(I)}else{const k=M.count,A=L.views;d.views=yn(A.views_count),d.reactions=yn(A.reactions_count||0),d.public_shares=yn(k),d.private_shares=yn(Math.abs((A.forwards_count||0)-k),!0),E(O=>(O.count=k,O));let x;const T=async O=>{x=O.next_offset;const F=O.forwards.map(this.renderPublicForward),N=await Promise.all(F);E(G=>(G.rendered.push(...N.map(({container:R})=>R)),G.loadMore=x?()=>s.getStoryPublicForwards({peerId:t,id:L.id,limit:i,offset:x}).then(T):void 0,G))};await T(M)}return P});u.push(m);const g=d.top_posters||[],f=d.top_admins||[],y=d.top_inviters||[],v=g.map(this.renderPeer),b=f.map(this.renderPeer),w=y.map(this.renderPeer);return Promise.all(u).then(()=>{const S=p.map(M=>this.renderRecentPost(M)),I=this.isMessage?this.renderRecentPost({_:"postInteractionCountersMessage",msg_id:this.mid,forwards:0,reactions:0,views:0},void 0,void 0,void 0,!0):void 0,L=[Promise.all(S),Promise.all(v),Promise.all(b),Promise.all(w),m,I];return Promise.all(L)})}async init(t,s,i){this.container.classList.add("statistics-container"),this.chatId=t,this.mid=s,this.storyId=i,this.messages=new Map,this.stories=new Map,this.openPromise=Rt(),s?this.isMessage=!0:i?this.isStory=!0:(this.isBroadcast=await this.managers.appChatsManager.isBroadcast(t),this.isMegagroup=await this.managers.appChatsManager.isMegagroup(t)),this.setTitle(this.isBroadcast?"Statistics":this.isMegagroup?"GroupStats.Title":this.isStory?"StoryStatistics":"PostStatistics");const n=Promise.all([q0(),this.openPromise,this.loadStats()]),[a,r]=we(!1),l=await zv({title:()=>_("LoadingStats"),description:()=>_("LoadingStatsDescription"),assetName:"StatsEmoji",middleware:this.middlewareHelper.get(),hide:a,isFullSize:!0});this.scrollable.append(l),n.then(async([c,d,h])=>{console.log(this.stats,this.messages,this.stories);const u=document.createElement("div");this.scrollable.append(u);const p=$a(()=>this._construct(...h),u);if(this.eventListener.addEventListener("destroy",p),et.isAvailable("animations")){const m=[{opacity:"1"},{opacity:"0"}],g={duration:200,fill:"forwards",easing:"ease-in-out"},f=[l.animate(m,g),u.animate(m.slice().reverse(),g)];await Promise.all(f.map(y=>y.finished))}r(!0)})}}const X0="_List_956vb_36",Z0="_ListItem_956vb_51",J0="_ListItemName_956vb_66",eE="_isRead_956vb_78",tE="_isMasked_956vb_81",sE="_ListContainer_956vb_110",iE="_skipAnimation_956vb_118",Tn={List:X0,"space-evenly":"_space-evenly_956vb_40",ListItem:Z0,ListItemName:J0,isRead:eE,isMasked:tE,ListContainer:sE,skipAnimation:iE};var ch=(o=>(o.Stories="stories",o.Pinned="pinnedStories",o.Archive="archiveStories",o))(ch||{});function nE(o,e,t){return t!==ch.Stories?Oa(o,e,typeof e!="number"?"id":void 0):Oa(o,e,typeof e!="number"?s=>4294967295-s.id:s=>4294967295-s)}const ew=(o=new Map)=>({positions:o,onPosition:({peerId:t,position:s})=>{s?o.set(t,s):o.delete(t)}}),{positions:aE,onPosition:rE}=ew();C.addEventListener("stories_position",rE);const oE=o=>{for(const e in o){const t=o[e];o[e]=(...s)=>Zt(()=>t(...s))}return o},lE=o=>{const e=(R,B,H=n.index,z=n.peers[H])=>{const W=R?1:-1,ue=z.index+W,K=R?ue>=z.stories.length:ue<0,ee=R?H>=n.peers.length-1:H<=0;if(K)if(ee){if(B){const _e=n.peers[R?0:n.peers.length-1];return{peer:_e,index:_e.index}}}else{const _e=n.peers[H+W];return{peer:_e,index:_e.index}}else return{peer:z,index:ue}},t={index:o.index||0,paused:!0,ended:!1,muted:!0,loop:!1,buffering:!1,hideInterface:!1,playAfterGesture:!1,ready:!!o.peers,hasViewer:!1,startTime:0,get elapsedTime(){return n.elapsedTimeOnPause||Date.now()-n.startTime},elapsedTimeOnPause:0,changeTimeout:0,storyDuration:0,width:0,height:0,pinned:o.pinned,archive:o.archive,peers:o.peers||[],get peer(){return n.peers[n.index]},freezedSorting:new Set,getNearestStory:e};let s,i;const[n,a]=lC(t),r=o.peerId||o.peers&&o.peers[0].peerId,l=o.archive?"archive":"stories",{positions:c,onPosition:d}=ew(new Map(aE)),h=[],u=R=>{const B=R.maxReadId||0,H=R.stories.findIndex(z=>z.id>B);return Math.max(0,H)},p=(R,B,H)=>{let z;const W=[];for(let ue=0;ue<B&&(z=n.getNearestStory(R,H,z?.peer?n.peers.indexOf(z.peer):void 0),!!z);++ue)W.push(z);return W},m=()=>{[...p(!0,3,!1),...p(!1,3,!1)].forEach(R=>{const B=R.peer.stories[R.index];B?._==="storyItemSkipped"&&C.managers.appStoriesManager.getStoryById(R.peer.peerId,B.id)})},g=()=>{const{peerId:R,pinned:B,archive:H}=o;if(R){if(B||H){const{peer:z}=n,W=z?z.stories[z.stories.length-1].id:0,ue=30;let K;return B?K=C.managers.appStoriesManager.getPinnedStories(R,ue,W):K=C.managers.appStoriesManager.getStoriesArchive(R,ue,W),K.then(({count:ee,stories:_e})=>(W?(a("peers",0,"stories",ae=>[...ae,..._e]),a("peers",0,"count",ee)):(P([{index:0,peerId:R,stories:_e,count:ee}]),a({ready:!0})),i=_e.length<ue))}return C.managers.appStoriesManager.getPeerStories(R).then(z=>(k([z]),i=!0))}return C.managers.appStoriesManager.getAllStories(s?!0:void 0,s,H).then(z=>(s=z.state,i=!z.pFlags.has_more,k(z.peer_stories),i||g(),i))},f={set:R=>{if(!R){a({ended:!0});return}const B=n.peers.indexOf(R.peer);R.index!==void 0&&a("peers",B,"index",R.index),f.stop(),n.peer!==R.peer&&a({index:B}),m()},pause:R=>{a({paused:!0,playAfterGesture:R&&!n.paused}),f.toggleInterface(R)},play:(R=n.storyDuration)=>{n.buffering||!n.hasViewer||(a({paused:!1,storyDuration:R}),f.toggleInterface(!1))},stop:()=>{f.pause(),a({startTime:0,elapsedTimeOnPause:0})},restart:()=>{a({buffering:!1}),f.stop(),f.play()},toggle:(R=n.paused)=>{R?f.play():f.pause()},previous:()=>f.goToNearestStory(!1),next:()=>f.goToNearestStory(!0),goToNearestStorySafe:R=>{if(R){f.next();return}const B=n.getNearestStory(R);!B||n.storyDuration!==Ww&&n.elapsedTime/n.storyDuration>.5?f.restart():f.set(B)},goToNearestStory:R=>{const B=n.getNearestStory(R);f.set(B)},viewerReady:R=>{a({hasViewer:R,ended:!1})},resetIndexes:()=>{a("peers",{},R=>({index:u(R)}))},toggleMute:()=>{a({muted:!n.muted})},toggleInterface:R=>{a({hideInterface:R})},toggleSorting:(R,B)=>{B?n.freezedSorting.add(R):(n.freezedSorting.delete(R),n.freezedSorting.size?R==="viewer"&&ii(h,(H,z)=>{H.position&&H.position.type!==l&&(h.splice(z,1),G(H,!0))}):h.splice(0,1/0).forEach(H=>G(H,!0)))},load:g,setBuffering:R=>{a({buffering:R})},setLoop:R=>{a({loop:R})}};oE(f);const y=()=>{clearTimeout(n.changeTimeout),a({startTime:Date.now()-n.elapsedTimeOnPause,changeTimeout:window.setTimeout(()=>{n.loop?f.restart():f.next()},n.storyDuration-n.elapsedTimeOnPause)})};Ne(xi(he(()=>n.paused||n.buffering),R=>{R?(clearTimeout(n.changeTimeout),a({elapsedTimeOnPause:Date.now()-n.startTime})):y()},{defer:!0}));const v=jw(),b=()=>nt.height-48-8-8*2-8,w=(R=b())=>Math.min(nt.width,R*.5625),S=()=>{const R=b();return{width:w(R),height:R}};Ne(()=>{a(S())});const L=(R,B=n.peers)=>B.findIndex(H=>H.peerId===R),M=R=>{const B={peerId:Je(R.peer),stories:R.stories,maxReadId:R.max_read_id,count:R.stories.length};return B.index=u(B),B},P=R=>{const B=[];let H=n.index;const z=n.peers.slice(),W=new Map(z.map((ee,_e)=>[ee.peerId,_e])),ue=n.peer?.peerId,K=W.get(ue)??-1;for(const ee of R){const _e=W.get(ee.peerId)??-1,ae=z[_e],re=Ot(ae?.index||u(ee),0,ee.stories.length-1);ee.index!==re&&B.push({peerId:ee.peerId,index:re}),_e!==-1&&(z[_e]=ee),Oa(z,ee,Ue=>c.get(Ue.peerId)?.index??0,_e)}if(K!==-1){const ee=L(ue,z);ee!==K&&(H=ee)}ur(()=>{a("peers",Ng(z,{key:"peerId",merge:!0})),a({index:H});for(const{peerId:ee,index:_e}of B){const ae=L(ee,z);a("peers",ae,"index",_e)}})},E=R=>{if(r)return r===R;const B=c.get(R);return B?B.type===l:!1},k=R=>{const B=R.map(M);P(B),a({ready:!0})},A=(R,B=L(R))=>{if(B===-1)return;const H=n.index===B;ur(()=>{const z=n.peers.slice();z.splice(B,1);const W=n.index>B?n.index-1:n.index;a({peers:z,...z.length?{}:{ended:!0},...W<z.length?{index:W}:{ended:!0}}),H&&f.restart()})},x=({peerId:R,story:B,modifiedPinned:H,modifiedArchive:z})=>{const W=L(R);if(W===-1)return;const ue=n.peers[W],K=ue.stories.findIndex(ee=>ee.id===B.id);if(o.pinned&&H){B.pFlags.pinned?O({peerId:R,story:B,cacheType:ch.Pinned,maxReadId:ue.maxReadId}):F({peerId:R,id:B.id});return}if(K===-1){o.archive&&r&&z&&O({peerId:R,story:B,cacheType:ch.Archive,maxReadId:ue.maxReadId});return}a("peers",W,"stories",K,Ng(B))},T=R=>{const B=Je(R.peer);E(B)&&k([R])},O=({peerId:R,story:B,cacheType:H,maxReadId:z})=>{if(!E(R)||o.pinned&&!B.pFlags?.pinned)return;const W=L(R);if(W===-1){const _e={peerId:R,stories:[B],maxReadId:z,count:1};_e.index=u(_e),P([_e]);return}const ee=n.peers[W].stories.findIndex(_e=>_e.id===B.id);if(ee!==-1){a("peers",W,"stories",ee,B);return}ur(()=>{const _e=n.peer.index;let ae;a("peers",W,"stories",re=>(re=re.slice(),ae=nE(re,B,H),re)),a("peers",W,"count",re=>re+1),ae<=_e&&a("peers",W,"index",re=>re+1)})},F=({peerId:R,id:B})=>{const H=L(R);if(H===-1)return;const z=n.peers[H],W=z.stories,ue=W.findIndex(K=>K.id===B);if(ue!==-1){if(W.length===1){A(R,H);return}ur(()=>{n.peer===z&&z.index===ue&&f.next(),a("peers",H,"stories",K=>(K=K.slice(),K.splice(ue,1),K)),a("peers",H,"count",K=>K-1),z.index>=ue&&a("peers",H,"index",z.index-1)})}},N=({peerId:R,maxReadId:B})=>{const H=L(R);H!==-1&&a("peers",H,"maxReadId",B)},G=(R,B)=>{const{peerId:H,position:z}=R;if(n.freezedSorting.size&&!B){const ue=c.get(H);if(ue?.type===z?.type||n.hasViewer&&ue&&z){Ba(h,K=>K.peerId===H),h.push(R);return}}if(d(R),!E(H)){A(H);return}const W=n.peers.find(ue=>ue.peerId===H);W&&P([W])};return v.add(C)("story_update",x),v.add(C)("story_deleted",F),!o.archive&&!o.pinned&&v.add(C)("story_expired",F),o.singleStory||v.add(C)("story_new",O),r||(v.add(C)("stories_stories",T),v.add(C)("stories_read",N),v.add(C)("stories_position",G)),o.onLoadCallback?o.onLoadCallback(f.load):n.ready?n.peer.index===void 0&&f.resetIndexes():f.load(),[n,f]},tw=cC(),og=o=>(da(o,["peers","index","peerId","pinned","archive"]),ke(tw.Provider,{get value(){return lE(o)},get children(){return o.children}})),Ur=()=>dC(tw);class Fo extends Tt{static getInitArgs(){return{animationData:Cs.loadAnimationFromURLManually("UtyanStories")}}init(e=Fo.getInitArgs()){this.header.classList.add("with-border"),this.container.classList.add("chat-folders-container",`${this.isArchive?"archive":"my"}-stories-container`),this.setTitle(this.isArchive?"MyStories.Archive":"MyStories.Title");const t=()=>{const c=this.slider.createTab(Fo);c.isArchive=!0,c.open()};let s,i;if(this.isArchive)i=new Ce({caption:"ProfileStoriesArchiveHint"}),i.innerContainer.remove();else{s=document.createElement("div"),s.classList.add("my-stories-placeholder","hide"),this.stickerContainer=document.createElement("div"),this.stickerContainer.classList.add("sticker-container");const c=document.createElement("div");c.classList.add("caption"),Gd({element:c,key:"MyStories.Subtitle"}),this.showArchiveBtn=Ve("btn-primary btn-color-primary btn-control",{text:"MyStories.ShowArchive"}),D(this.showArchiveBtn,t,{listenerSetter:this.listenerSetter}),s.append(this.stickerContainer,c,this.showArchiveBtn)}const n=yi({listenerSetter:this.listenerSetter,direction:"bottom-left",buttons:[{icon:"archive",text:"MyStories.ShowArchive",onClick:t,verify:()=>!this.isArchive},{icon:"select",text:"Message.Context.Select",onClick:()=>{r.selection.toggleSelection(!0,!0)},verify:()=>!!(a&&!r.selection.isSelecting)},{icon:"select",text:"Message.Context.Selection.Clear",onClick:()=>{r.selection.cancelSelection()},verify:()=>r.selection.isSelecting}]});this.header.append(n);let a;const r=this.searchSuper=new fg({mediaTabs:[{inputFilter:"inputMessagesFilterEmpty",name:"Stories",type:"stories"}],scrollable:this.scrollable,hideEmptyTabs:!0,managers:this.managers,storiesArchive:this.isArchive});r.onStoriesLengthChange=c=>{a=c,s&&s.classList.toggle("hide",c>0)},r.setQuery({peerId:C.myId}),r.selectTab(0),this.middlewareHelper.onDestroy(()=>{r.destroy()}),this.scrollable.append(...[i?.container,r.container,s].filter(Boolean));const l=this.middlewareHelper.get();return Promise.all([this.loadAnimationPromise=!this.isArchive&&e.animationData.then(async c=>{const d=await c({container:this.stickerContainer,loop:!1,autoplay:!1,width:100,height:100,middleware:l});return this.animation=d,Cs.waitForFirstFrame(d)}),r.load(!0)])}}const Np=He("<div>"),cE=He("<div><div>"),Cd=1,Ya=0,lg=o=>{const[,e]=da(o,[]);let t;const s=(()=>{const i=Np(),n=t;return typeof n=="function"?Nt(n,i):t=i,$o(i,e,!1,!0),q(i,()=>o.children),i})();return new Va(void 0,void 0,void 0,void 0,t),s},sw=o=>{const e=new Mt,[t]=hC(()=>o.peerId,s=>e.update({peerId:s,dialog:!1,onlyFirstName:o.onlyFirstName}).then(()=>!0));return he(()=>t()&&e.element)};function dE(o){const[e,t]=Ur(),[s,i]=we(),[n,a]=we(Cd),[r,l]=we(),[c,d]=we(!1),h=he(()=>n()===Cd),u=he(()=>n()!==Ya),p=he(()=>e.peers),m=(Z,de)=>{et.isAvailable("animations")&&!de&&d(!0),a(Z)};let g,f;const y=he(()=>p().findIndex(Z=>Z.peerId===C.myId)),v=he(()=>{const Z=r();return Z&&Z.width>p().length*F?(Z.width-p().length*F)/(p().length+1):0}),b=new WeakMap,w=new WeakMap,S=(Z,de)=>{const be=Date.now(),pe=M=la(()=>{const xe=Ot((Date.now()-be)/125,0,1);let ne=Z;return(Z>.5||de===!1)&&de!==!0?(ne+=(1-Z)*xe,P=!1):(P=!0,ne-=Z*xe),m(ne),xe<1},Ue).finally(()=>{pe===M&&(M=void 0)})},I=()=>{cm(Ue)},L=Z=>{n()!==Ya&&(I(),m(Ya),X(Z))};let M,P;const k=Zs(()=>{},75,!1,!0),A=(Z,de)=>{const be=o.getScrollable().scrollTop,pe=de instanceof WheelEvent;{const Y=Z<0?Ya:Cd;if(be&&n()!==Ya||k.isDebounced()){k();return}if(n()===Y)return;de&&X(de),m(Y);return}const xe=n();if(Ue.classList.add(Tn.skipAnimation),Z>0&&M&&P){k.clearTimeout(),S(xe,!1);return}if(M||xe>=Cd&&Z>0||xe<=Ya&&Z<=0)return;let ne=Z/600;ne=Ot(xe+ne,0,1),console.log("value",ne),m(ne),ne>=1||ne<=0?k.clearTimeout():(de&&X(de),k())},x=Z=>{if(!p().length)return;const be=-Z.wheelDeltaY;A(be,Z)};if(o.listenWheelOn.addEventListener("wheel",x,{passive:!1}),Et(()=>{o.listenWheelOn.removeEventListener("wheel",x)}),Ye){const Z=new Or({element:o.listenWheelOn,onSwipe:(de,be,pe)=>{const xe=-be;A(xe,pe)},cancelEvent:!1,cursor:"",verifyTouchTarget:de=>de instanceof TouchEvent&&p().length&&!U(de.target,"folders-tabs-scrollable")});Et(()=>{Z.removeListeners()})}Ne(()=>{if(!s())return;const de=()=>{i(void 0)},be=he(()=>b.get(e.peer)?.querySelector(".avatar"));Wc({onExit:de,target:be})});const T=(Z,de)=>{if(n()!==Ya)return L(de);t.resetIndexes(),t.set({peer:Z}),i(Z)},F=74+0*2,N=54,G=3,R=he(()=>Math.min(G,p().length-(y()!==-1?1:0))),B=he(()=>({min:y()===0&&p().length>1?1:0,max:y()===0?R():R()-1})),H=(Z,de=B())=>{const{min:be,max:pe}=de;return Z<be||Z>pe},z=(Z,de)=>{const be=T.bind(null,Z),pe=he(()=>{const j=r(),te=n(),le=de(),me=v(),Ee=me?0:ue,Ie=B(),Ke=H(le,Ie),se=f.left+Ee+le*F+me*(le+1);if(j.left+Ee+le*F+me*(le+1)>j.right)return;const ve={};Ke?ve["z-index"]=100-le:ve["z-index"]=100+R()+1-le;const Te=g.right+(o.offsetX||0),Ae=Ke?0:(Ie.max-le)*16;let Ge=Te-se+5-Ae,We;Ke?(ve["transform-origin"]="center 43.75%",Ge+=8*(le<Ie.min?1:-1),We=.2):We=26.67/48;const Pt=`translateX(${Ge*te*(De.isRTL?-1:1)}px)`,yt=`scale(${1-te*(1-We)})`;return ve.transform=`${Pt} ${yt}`,{isOut:Ke,isLastIn:!Ke&&le===Ie.max,cssProperties:ve}}),xe=dn({peerId:Z.peerId,size:N,props:{onClick:be},isDialog:!1,withStories:!0,isStoryFolded:u}),ne=Z.peerId===C.myId,Y=(()=>{const j=cE(),te=j.firstChild;return km(j,"click",be,!0),Nt(le=>(b.set(Z,le),w.set(le,Z)),j),q(j,()=>xe.element,te),q(te,()=>ne?_("MyStory"):ke(sw,{get peerId(){return Z.peerId},onlyFirstName:!0})),mt(le=>{const me=Tn.ListItem,Ee={[Tn.isRead]:!ne&&Z.maxReadId&&Z.maxReadId>=Z.stories[Z.stories.length-1].id,[Tn.isMasked]:(()=>{const $=pe();return $&&!$.isOut&&!$.isLastIn})()},Ie=pe()?.cssProperties,Ke=Tn.ListItemName;return me!==le._v$&&st(j,le._v$=me),le._v$2=vr(j,Ee,le._v$2),le._v$3=qi(j,Ie,le._v$3),Ke!==le._v$4&&st(te,le._v$4=Ke),le},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0}),j})();return ke(kh,{get when(){return pe()||!h()},children:Y})},W=-69,ue=6,K=92;let ee=!1;const _e=()=>{const Z=n(),de=!ee&&ae();de?.scrollLeft&&(ee=!0,lm({container:de,element:de,getElementPosition:()=>-de.scrollLeft,position:"start",axis:"x"}).then(()=>{ee=!1}));const pe=`translateY(${Z*W}px)`;return o.setScrolledOn.style.setProperty("--stories-scrolled",Z*K+"px"),{transform:pe,"--progress":Z}};Ne(xi(()=>p().length,Z=>{Z||S(n(),!1)},{defer:!0}));const ae=()=>Ue.firstElementChild;Ne(()=>{if(h()||c()){const Z=X,de=ae();de.addEventListener("wheel",Z,{capture:!0}),Et(()=>{de.removeEventListener("wheel",Z,{capture:!0})})}}),Ne(()=>{c()||t.toggleSorting("list",!h())});const re=()=>{g=o.foldInto.getBoundingClientRect(),f=o.foldInto.parentElement.getBoundingClientRect(),l(o.foldInto.parentElement.parentElement.getBoundingClientRect())};Fe.addEventListener("resize",re),Et(()=>{Fe.removeEventListener("resize",re)}),re(),o.resizeCallback?.(re);let Ue;const ye=(()=>{const Z=Np();Z.addEventListener("transitionend",be=>be.target===Ue&&d(!1)),Z.addEventListener("transitionstart",be=>be.target===Ue&&d(!0));const de=Ue;return typeof de=="function"?Nt(de,Z):Ue=Z,q(Z,ke(lg,{get children(){const be=Np();return q(be,ke(Mi,{get each(){return p()},children:z})),mt(pe=>{const xe=Tn.List,ne={[Tn["space-evenly"]]:!!v()};return xe!==pe._v$5&&st(be,pe._v$5=xe),pe._v$6=vr(be,ne,pe._v$6),pe},{_v$5:void 0,_v$6:void 0}),be}})),mt(be=>{const pe=Tn.ListContainer,xe={"disable-hover":h()||c(),[Tn.skipAnimation]:h()&&!c()},ne=_e();return pe!==be._v$7&&st(Z,be._v$7=pe),be._v$8=vr(Z,xe,be._v$8),be._v$9=qi(Z,ne,be._v$9),be},{_v$7:void 0,_v$8:void 0,_v$9:void 0}),Z})();return Ho(()=>{const Z=async xe=>{C.managers.appNotificationsManager.toggleStoriesMute(be.peerId,xe),Re({langPackKey:xe?"NotificationsStoryMutedHint":"NotificationsStoryUnmutedHint",langPackArguments:[await Oe({peerId:be.peerId})]})},de=async xe=>{C.managers.appStoriesManager.toggleStoriesHidden(be.peerId,xe),Re({langPackKey:xe?"StoriesMovedToContacts":"StoriesMovedToDialogs",langPackArguments:[await Oe({peerId:be.peerId})]})};let be,pe;Xi({buttons:[{icon:"stories",text:"SavedStories",onClick:()=>{ri.createTab(Fo).open()},verify:()=>pe},{icon:"archive",text:"ArchivedStories",onClick:()=>{const xe=ri.createTab(Fo);xe.isArchive=!0,xe.open()},verify:()=>pe},{icon:"message",text:"SendMessage",onClick:()=>{ce.setInnerPeer({peerId:be.peerId,type:Q.Chat})},verify:()=>!pe&&be.peerId.isUser()},{icon:"channel",text:"OpenChannel2",onClick:()=>{ce.setInnerPeer({peerId:be.peerId,type:Q.Chat})},verify:()=>!be.peerId.isUser()},{icon:"mute",text:"NotificationsStoryMute2",onClick:()=>Z(!0),verify:()=>!pe&&C.managers.appNotificationsManager.isPeerStoriesMuted(be.peerId).then(xe=>!xe),multiline:!0},{icon:"unmute",text:"NotificationsStoryUnmute2",onClick:()=>Z(!1),verify:()=>!pe&&C.managers.appNotificationsManager.isPeerStoriesMuted(be.peerId),multiline:!0},{icon:"archive",text:"ArchivePeerStories",onClick:()=>de(!0),verify:()=>!pe&&!o.archive},{icon:"unarchive",text:"UnarchiveStories",onClick:()=>de(!1),verify:()=>!pe&&!!o.archive}],listenTo:Ue,middleware:Ii().get(),findElement:xe=>!h()&&U(xe.target,Tn.ListItem),onOpen:(xe,ne)=>{be=w.get(ne),pe=be.peerId===C.myId},onClose:()=>{be=void 0}})}),he(()=>e.ready&&ye)}function iw(o){const[,e]=da(o,["foldInto","getScrollable","listenWheelOn","setScrolledOn","offsetX","resizeCallback"]);return ke(og,an(e,{get children(){return ke(dE,o)}}))}Dr(["click"]);const hE=He("<div class=popup-gift-link-peer>"),uE=He("<div class=popup-gift-link-wrapper><div class=popup-gift-link-header><img class=popup-gift-link-image><div class=popup-gift-link-title></div><div class=popup-gift-link-subtitle></div></div><table class=popup-gift-link-table>"),pE=He('<tr class=popup-gift-link-table-row><td class="popup-gift-link-table-cell popup-gift-link-table-key"></td><td class=popup-gift-link-table-cell>'),mE=He("<div class=popup-gift-link-share>");class Kn extends J{constructor(e,t,s){super("popup-boosts popup-gift-link",{closable:!0,overlayClosable:!0,body:!0,withConfirm:!0,scrollable:!0,floatingHeader:!0,footer:!0,title:!0}),this.slug=e,this.stack=t,this.checkedGiftCode=s,this.isInChat=!!s,this.construct()}_construct(e){const t=this,s=!!this.checkedGiftCode.used_date,i=s?"BoostingUsedGiftLink":"BoostingGiftLink";this.title.replaceChildren(_(i));const n=this.isInChat&&!s?"":"https://t.me/giftcode/"+this.slug,a=new Hc({button:!1,listenerSetter:this.listenerSetter,url:n,noRightButton:!n,onClick:!n&&(()=>{Re({langPackKey:"BoostingOnlyRecipientCode"})})});e&&(e.classList.add("invite-link-dots"),a.container.appendChild(e));const r=v=>{const b=this,w=dn({peerId:v,size:24});return(()=>{const S=hE();return S.$$click=()=>{b.hideWithCallback(()=>{ce.setInnerPeer({peerId:v})})},q(S,()=>w.element,null),q(S,ke(sw,{peerId:v}),null),S})()},l=this.checkedGiftCode.pFlags.via_giveaway,c=Je(this.checkedGiftCode.from_id),d=this.checkedGiftCode.to_id&&Je(this.checkedGiftCode.to_id),h=this.checkedGiftCode.giveaway_msg_id||l?document.createElement("a"):void 0;h&&(h.href="#",h.append(_("BoostingIncompleteGiveaway")),D(h,()=>{this.hideWithCallback(()=>{ce.setInnerPeer({peerId:c,lastMsgId:this.checkedGiftCode.giveaway_msg_id})})},{listenerSetter:this.listenerSetter}));const u=d?d===C.myId?_("BoostingYouWereSelected"):_("BoostingUserWasSelected",[new Mt({peerId:d}).element]):h;let p=[["BoostingFrom",r(c)],["BoostingTo",d?r(d):_("BoostingNoRecipient")],["BoostingGift",_("BoostingTelegramPremiumFor",[Cr(this.checkedGiftCode.months)])],!this.isInChat&&["BoostingReason",u],["BoostingDate",Ss(this.checkedGiftCode.date,void 0,!0)]];p=p.filter(Boolean);const m=fi(v=>{X(v),this.hideWithCallback(()=>{Kn.shareGiftLink(n,!0)})});let g;const f=(()=>{const v=uE(),b=v.firstChild,w=b.firstChild,S=w.nextSibling,I=S.nextSibling,L=b.nextSibling,M=g;return typeof M=="function"?Nt(M,w):g=w,q(S,()=>_(i)),q(I,()=>s?_("BoostingLinkUsed"):_(d===C.myId?"BoostingLinkAllows":d?"BoostingLinkAllowsToUser":"BoostingLinkAllowsAnyone",d?[new Mt({peerId:d}).element]:void 0)),q(v,()=>a.container,L),q(L,ke(Mi,{each:p,children:([P,E])=>(()=>{const k=pE(),A=k.firstChild,x=A.nextSibling;return q(A,()=>_(P)),q(x,E),k})()})),q(v,(()=>{const P=he(()=>!t.isInChat||!s);return()=>P()&&(()=>{const E=mE();return q(E,()=>s?_("BoostingUsedLinkDate",[Ss(t.checkedGiftCode.used_date,void 0,!0)]):t.isInChat&&!t.checkedGiftCode.slug?_("BoostingLinkNotActivated"):_(d?"Giveaway.SendLinkToFriend":"Giveaway.SendLinkToAnyone",[m])),E})()})(),null),v})();In(g,`assets/img/premium-star${window.devicePixelRatio>1?"@2x":""}.png`);const y=!this.isInChat&&!s;return this.btnConfirm.append(_(y?"BoostingUseLink":"OK")),this.btnConfirm.classList.add("popup-boosts-button"),this.footer.append(this.btnConfirm),this.body.after(this.footer),this.footer.classList.add("abitlarger"),D(this.btnConfirm,()=>{if(!y){this.hide();return}Kn.applyGiftCode(this.slug,this.btnConfirm,this)},{listenerSetter:this.listenerSetter}),f}async construct(){if(this.checkedGiftCode??(this.checkedGiftCode=await this.managers.appPaymentsManager.checkGiftCode(this.slug)),Qd(this.checkedGiftCode)){this.destroy(),ps.show({gift:this.checkedGiftCode,stack:this.stack});return}let e;if(this.isInChat&&!this.checkedGiftCode.used_date){const{dotRenderer:i,readyResult:n}=oc.create({width:320,height:32,middleware:this.middlewareHelper.get(),animationGroup:"STICKERS-POPUP",config:{particlesCount:1e3,color:bs.isNight()?16777215:0}});await n,e=i.canvas}const t=document.createElement("div");this.scrollable.append(t,this.btnConfirm);const s=$a(()=>this._construct(e),t);this.addEventListener("closeAfterTimeout",s),this.show()}static async shareGiftLink(e,t){const s=await _s.createSharingPicker2();C.managers.appMessagesManager.sendText({peerId:s,text:e}),t?ce.setInnerPeer({peerId:s}):Re({langPackKey:C.myId===s?"BoostingGiftLinkForwardedToSavedMsg":"BoostingGiftLinkForwardedTo",langPackArguments:[await Oe({peerId:s})]})}static async applyGiftCode(e,t,s){const i=zt(t,!0);try{await J.MANAGERS.appPaymentsManager.applyGiftCode(e),s.hide(),Re({langPackKey:"GiftLink.UseSuccess"})}catch(n){if(n.type.includes("PREMIUM_SUB_ACTIVE_UNTIL_")){s.hide();const a=+n.type.split("_").pop();let r;ft({titleLangKey:"GiftPremiumActivateErrorTitle",descriptionLangKey:"GiftCode.Activation.After",descriptionLangArgs:[Ss(a),fi(()=>{hs(r.element),s.hide(),this.shareGiftLink("https://t.me/giftcode/"+e)})],button:r={langKey:"OK",isCancel:!0}})}console.error("giftcode error",n),i()}}}Dr(["click"]);const gE=He('<div class="menu-horizontal-div-item boosts-users-tab"><div class=menu-horizontal-div-item-span><i>'),fE=He("<div>"),yE=He('<div class="menu-horizontal-div boosts-users-tabs">'),vE=He("<div class=boosts-users-contents>"),nw=o=>o===12?"red":o===3?"green":"blue",Gf=(o,e)=>{const t=(e-o)/86400;return Math.round(t/30)},aw=o=>{const{quantity:e,months:t}=o.giveaway,s=new ge({titleLangKey:"BoostingGiveawayMsgInfoPlural1",titleLangArgs:[e],subtitleLangKey:"Giveaway.Prepaid.Subtitle",subtitleLangArgs:[e,_("Giveaway.Prepaid.Period",[t])],clickable:o.clickable,listenerSetter:o.listenerSetter,rightContent:ow({boosts:(o.appConfig.giveaway_boosts_per_premium||1)*e})});s.title.classList.add("text-bold");const i=s.createMedia("abitbigger"),n=dn({size:42});return n.set({icon:"gift_premium",color:nw(t)}),i.append(n.node),s.container};class bE extends Kt{constructor(){super(...arguments);rd(this,"renderBoost",async t=>{const s=1*(t.multiplier||1),i=Gf(t.date,t.expires);let n=t.user_id?.toPeerId(!1);n===C.myId&&t.pFlags.unclaimed&&(n=void 0);let a;s>1&&(a=document.createElement("span"),a.classList.add("boosts-user-boosts","boosts-user-badge"),a.append(Le("boost"),` ${s}`));let r;n?(r=await Oe({peerId:n}),r.classList.add("boosts-user-name")):r=_(t.pFlags.unclaimed?"BoostingUnclaimed":"BoostingToBeDistributed");let l;n?l=_("BoostsExpiration",[s,Ss(t.expires,void 0,!0)]):(l=document.createElement("span"),l.append(...Ar([_("BoostingShortMonths",[i]),Ss(t.expires,void 0,!0)]," â¢ ")));let c;(t.pFlags.giveaway||t.pFlags.gift)&&(c=document.createElement("span"),c.classList.add("boosts-user-badge-right","boosts-user-badge"),c.append(Le(t.pFlags.giveaway?"gift_premium":"gift"),_(t.pFlags.giveaway?"BoostingGiveaway":"BoostingGift")),c.classList.toggle("is-gift",!t.pFlags.giveaway&&!!t.pFlags.gift));const d=new ge({title:!0,subtitle:l,clickable:!0,noWrap:!0,rightContent:c});n&&(d.container.dataset.peerId=""+n),d.title.classList.add("boosts-user-title"),d.title.append(...[r,a].filter(Boolean));const h=d.createMedia("abitbigger"),u=ls({peerId:n,size:42,middleware:this.middlewareHelper.get()});return h.append(u.node),n?await u.readyThumbPromise:u.set({icon:t.pFlags.unclaimed?"deleteuser":"noncontacts",color:nw(i)}),this.targets.set(d.container,t),d.container})}_construct(t,s,i,n){const a=this,r=new Oh({progress:!0,hint:{icon:"boost",noStartEnd:!0}}),c=t.next_level_boosts===void 0?1:(t.boosts-t.current_level_boosts)/(t.next_level_boosts-t.current_level_boosts);r.setProgress(c,""+t.boosts,{from1:_("BoostsLevel",[t.level]),to1:_("BoostsLevel",[t.level+1]),from2:_("BoostsLevel",[t.level]),to2:_("BoostsLevel",[t.level+1])}),r._setHintActive();const d=t.boost_url,h=new Hc({listenerSetter:this.listenerSetter,url:d}),u=Ve("btn-primary btn-transparent primary",{icon:"gift_premium",text:"BoostingGetBoostsViaGifts"});D(u,()=>{J.createPopup(Kf,this.peerId)},{listenerSetter:this.listenerSetter});const p=_("NoBoostersHint");p.classList.add("boosts-no-boosters");let m,g;const f=E=>(()=>{const k=gE(),A=k.firstChild,x=A.firstChild;return q(A,()=>_(E.key,[E.count]),x),k})(),y=E=>{const k=this;return(()=>{const A=fE();return q(A,(()=>{const x=he(()=>!!E.list.count);return()=>x()?[he(()=>E.list.rendered),he((()=>{const T=he(()=>!!E.list.loadMore);return()=>T()&&Bp(E.list.count-E.list.rendered.length,O=>{const F=zt(O,!0);E.list.loadMore().finally(()=>F())},k.listenerSetter,E.moreKey)})())]:p})()),mt(()=>st(A,jt("boosts-users-content",!E.list.count&&"is-empty",E.hide&&"hide"))),A})()},[v,b]=we(0),[w,S]=we(t.prepaid_giveaways?.slice()||[],{equals:!1}),I=he(()=>t.gift_boosts===t.boosts),L=he(()=>!I()&&!!n().count),M=[ke(Ws,{get children(){return[he(()=>r.container),ke(Jb,{get items(){return[{title:"BoostsLevel2",value:yn(t.level),includeZeroValue:!0},{title:"PremiumSubscribers",value:t.premium_audience,includeZeroValue:!0,describePercentage:!0},{title:"BoostsExisting",value:yn(t.boosts),includeZeroValue:!0},{title:"BoostsToLevel",value:yn(t.next_level_boosts-t.boosts)}]}})]}}),he((()=>{const E=he(()=>!!(a.canCreateGiveaway&&w().length));return()=>E()&&ke(Ws,{name:"Giveaway.Prepaid",nameArgs:[1],caption:"BoostingSelectPaidGiveaway",get children(){return ke(Mi,{get each(){return w()},children:k=>ke(aw,{giveaway:k,appConfig:s,clickable:()=>{J.createPopup(Kf,a.peerId,k,()=>{S(A=>(cs(A,k),A))})},get listenerSetter(){return a.listenerSetter}})})}})})()),ke(Ws,{class:"boosts-users-container",get children(){return[(()=>{const E=yE(),k=m;return typeof k=="function"?Nt(k,E):m=E,q(E,ke(f,{key:"BoostingBoostsCount",get count(){return i().count}}),null),q(E,(()=>{const A=he(()=>!!L());return()=>A()&&ke(f,{key:"BoostingGiftsCount",get count(){return n().count}})})(),null),E})(),(()=>{const E=vE();E.$$click=async A=>{const x=U(A.target,"row"),T=a.targets.get(x);if(!T)return;const O=T.used_gift_slug,F=T.user_id?.toPeerId(!1);F&&!T.pFlags.gift&&!T.pFlags.unclaimed&&!T.pFlags.giveaway?ce.setInnerPeer({peerId:T.user_id.toPeerId(!1)}):F&&F!==C.myId?J.createPopup(Kn,O,void 0,{_:"payments.checkedGiftCode",chats:[],date:T.date,months:Gf(T.date,T.expires),pFlags:{via_giveaway:T.pFlags.giveaway||void 0},users:[],from_id:await a.managers.appPeersManager.getOutputPeer(a.peerId),giveaway_msg_id:T.giveaway_msg_id,slug:O,to_id:F.toUserId(),used_date:O?1:void 0}):O?J.createPopup(Kn,O):Re({langPackKey:"BoostingRecipientWillBeSelected"})};const k=g;return typeof k=="function"?Nt(k,E):g=E,q(E,ke(y,{get list(){return i()},get hide(){return v()!==0},moreKey:"BoostingShowMoreBoosts"}),null),q(E,(()=>{const A=he(()=>!!L());return()=>A()&&ke(y,{get list(){return n()},get hide(){return v()!==1},moreKey:"BoostingShowMoreGifts"})})(),null),E})()]}}),ke(Ws,{name:"LinkForBoosting",caption:"BoostingShareThisLink",get children(){return h.container}}),he((()=>{const E=he(()=>!!a.canCreateGiveaway);return()=>E()&&ke(Ws,{caption:"BoostingGetMoreBoosts",children:u})})())];return Ac(m,g,E=>{b(E)},void 0,void 0,void 0,this.listenerSetter)(v()),M}async init(t){this.container.classList.add("boosts-container"),this.peerId=t,this.targets=new Map,this.setTitle("Boosts");const s=p=>{const m=this.middlewareHelper.get();let g="",f=!0;const y=async()=>{const w=f?20:100;f=!1;const S=await this.managers.appBoostsManager.getBoostsList({peerId:t,offset:g,limit:w,gifts:p});if(!m())return;const I=S.boosts.map(this.renderBoost),L=await Promise.all(I);b(M=>(M.count=S.count,g=S.next_offset,g||(M.loadMore=void 0),M.rendered.push(...L),M))},[v,b]=tu({loadMore:y});return v},[i,n]=qs(p=>(this.middlewareHelper.get().onDestroy(p),[s(!1),s(!0)])),[a,r,l,c,d]=await Promise.all([this.managers.appBoostsManager.getBoostsStatus(t),this.managers.apiManager.getAppConfig(),i().loadMore(),n().loadMore(),this.managers.appChatsManager.hasRights(t.toChatId(),"create_giveaway")]);this.canCreateGiveaway=d;const h=document.createElement("div");this.scrollable.append(h);const u=$a(()=>this._construct(a,r,i,n),h);this.eventListener.addEventListener("destroy",u)}}Dr(["click"]);const wE=He("<span class=popup-boosts-badge>"),SE=He("<span class=popup-boosts-button-text>"),rw=He("<span>"),CE=He('<span class="primary is-flex"> '),zf=He("<form>"),IE=He('<div class=popup-boosts-additional-row><div class=popup-boosts-additional-row-count></div><input class="input-clear popup-boosts-additional-row-input">'),LE=He("<div class=popup-boosts-star-container><img class=popup-boosts-star>"),ME=He("<div class=popup-boosts-title>"),PE=He("<div class=popup-boosts-subtitle>"),ow=o=>(()=>{const e=wE();return q(e,ke(kr,{icon:"boost",class:"popup-boosts-badge-icon"}),null),q(e,()=>o.boosts,null),e})(),lw=o=>{let e,t;(()=>{const s=SE(),i=e;return typeof i=="function"?Nt(i,s):e=s,q(s,()=>_(o.langKey(),o.langArgs?.())),s})(),(()=>{const s=rw(),i=t;return typeof i=="function"?Nt(i,s):t=s,q(s,ke(kr,{icon:"boost",class:"popup-boosts-button-badge-icon"}),null),q(s,()=>o.boosts(),null),mt(()=>st(s,jt("popup-boosts-button-badge",!o.boosts()&&"hide"))),s})(),o.button.classList.add("popup-boosts-button"),o.button.append(e,t)};class Kf extends J{constructor(e,t,s){super("popup-boosts",{closable:!0,overlayClosable:!0,body:!0,scrollable:!0,title:"BoostsViaGifts.Title",floatingHeader:!0,footer:!0,withConfirm:!0}),this.peerId=e,this.prepaidGiveaway=t,this.onCreated=s,this.construct()}_construct(){const e=this,t=this,[s,i]=we(0),[n,a]=we(Es(!0)+3*86400),[r,l]=we([this.peerId]),[c,d]=we([]),[h,u]=we(!1),[p,m]=we(),[g,f]=we(),[y,v]=we(),[b,w]=we(!1),[S,I]=we(!1),[L,M]=we(""),[P,E]=we(!0),k=he(()=>!!this.prepaidGiveaway),A=he(()=>s()*(this.appConfig.giveaway_boosts_per_premium??1)),x=new Ip({generateStep:ne=>[""+ne,ne],onValue:ne=>{i(ne)},middleware:this.middlewareHelper.get(),noFirstLast:!0}),T=[1,3,5,7,10,25,50,100].filter(ne=>this.premiumGiftCodeOptions.some(Y=>Y.users===ne)),O=x.generateSteps(T);k()?i(this.prepaidGiveaway.quantity):x.setSteps(O,T.indexOf(10));const F={round:!0,asRadio:!0},N=new ge({titleLangKey:"Ends",titleRightSecondary:!0,clickable:()=>{const ne=new Date(Date.now()+(this.appConfig.giveaway_period_max??604800)*1e3),Y=new Date(n()*1e3);new Wm({initDate:Y,onPick:te=>{a(te)},btnConfirmLangKey:"Save",maxDate:ne}).show()},listenerSetter:this.listenerSetter});N.titleRight.classList.add("primary"),Ne(()=>{N.titleRight.replaceChildren(Ss(n()))});const G=ne=>{i(ne?c().length:x.value),u(ne),this.scrollable.updateThumb()};let R,B,H,z;if(this.prepaidGiveaway)B=aw({giveaway:this.prepaidGiveaway,appConfig:this.appConfig});else{const ne=new ge({titleLangKey:"BoostsViaGifts.Create",subtitleLangKey:"BoostsViaGifts.CreateSubtitle",clickable:()=>{G(!1)},checkboxField:new ct({...F,checked:!h(),name:"giveaway-type"}),listenerSetter:this.listenerSetter}),Y=ne.createMedia("abitbigger"),j=dn({size:42});j.set({icon:"gift_premium"}),Y.append(j.node),H=ne.container;const te=new ge({titleLangKey:"BoostsViaGifts.Specific",subtitle:!0,clickable:Ee=>{X(Ee),J.createPopup(_s,{peerType:["channelParticipants"],peerId:this.peerId,onMultiSelect:Ke=>{d(Ke),G(!0),te.checkboxField.setValueSilently(!0)},placeholder:"SearchPlaceholder",exceptSelf:!0,titleLangKey:"Giveaway.Type.Specific.Modal.SelectUsers",initial:c()}).selector.setLimit(this.subscribersLimit,()=>{Re({langPackKey:"Giveaway.MaximumSubscribers",langPackArguments:[this.subscribersLimit]})})},checkboxField:new ct({...F,checked:h(),name:"giveaway-type"}),listenerSetter:this.listenerSetter});Ne(()=>{const Ee=c(),Ie=!(!Ee.length||Ee.length>2);if(te.subtitle.classList.toggle("is-flex",!Ie),!Ie)te.subtitle.replaceChildren(_(Ee.length>2?"Recipient":"BoostsViaGifts.SpecificSubtitle",[Ee.length]),W());else{te.subtitle.classList.remove("is-flex");const Ke=Ee.map($=>new Mt({peerId:$}).element);te.subtitle.replaceChildren(...ci(Ke,!1))}}),te.subtitle.classList.add("primary");const le=te.createMedia("abitbigger"),me=dn({size:42});me.set({icon:"newgroup_filled",color:"pink"}),le.append(me.node),z=te.container,z.classList.add("popup-boosts-type","popup-boosts-specific"),H.classList.add("popup-boosts-type")}const W=()=>Le("next","popup-boosts-specific-next"),ue=fi(()=>{ps.show()});let K;Ne(()=>{const ne=s(),Y=new Map;this.premiumGiftCodeOptions.forEach((le,me,Ee)=>{const Ie=le.months;if(Y.has(Ie))return;const Ke=Ee.filter(oe=>oe.months===Ie).sort((oe,ve)=>oe.users-ve.users),$=Ke.findIndex(oe=>oe.users>=ne),se=Ke[$]||Ke[Ke.length-1];Y.set(Ie,se)});const j=[...Y.values()].sort((le,me)=>me.months-le.months),te=ES({periodOptions:j,onOption:le=>{K=j.indexOf(le),f(le)},checked:K,users:ne,discountInTitle:!0});m(te)});const ee=Ve("btn btn-primary btn-transparent primary",{icon:"add",text:"AddChannel"});D(ee,async()=>{const ne=zt(ee,!0),Y=J.createPopup(_s,{filterPeerTypeBy:["isBroadcast"],onMultiSelect:le=>{l([this.peerId,...le])},placeholder:"SearchPlaceholder",titleLangKey:"AddChannels",initial:r().filter(le=>le!==this.peerId),excludePeerIds:new Set([this.peerId])});Y.selector.setLimit(this.channelsLimit,()=>{Re({langPackKey:"BoostingSelectUpToWarningChannelsPlural",langPackArguments:[this.channelsLimit]})}),Y.addEventListener("closeAfterTimeout",()=>ne(),{once:!0});const j=Y.selector.add.bind(Y.selector);let te;Y.selector.add=le=>{const me=le.key.toPeerId(),Ee=fe.getChat(me.toChatId());return!si(Ee)[0]&&te!==me&&Y.selector.getSelected().length<this.channelsLimit?(ft({titleLangKey:"BoostingGiveawayPrivateChannel",descriptionLangKey:"BoostingGiveawayPrivateChannelWarning",button:{langKey:"Add"}}).then(()=>{te=me,Y.selector.add({key:me}),Y.selector.toggleElementCheckboxByPeerId(me,!0),te=void 0}),!1):j(le)}},{listenerSetter:this.listenerSetter});const _e=()=>(()=>{const ne=CE(),Y=ne.firstChild;return q(ne,()=>_(y()?"BoostingFromCountriesCount":"BoostingFromAllCountries",[y()?.length]),Y),q(ne,W,null),ne})(),ae=ne=>{if(!U(ne.target,"row").querySelector(".checkbox-field-input").checked)return;let te;const le=J.createPopup(_s,{peerType:["custom"],renderResultsFunc:Ee=>{Ee.forEach(Ie=>{const Ke=te.get(Ie),$=cp(Ke.iso2),se=document.createDocumentFragment(),oe=document.createElement("span");oe.classList.add("selector-countries-emoji"),oe.append(Pe($)),se.append(oe," ",_(Ke.default_name));const ve=new ge({title:se,clickable:!0,havePadding:!0});ve.container.append(le.selector.checkbox(le.selector.selected.has(Ie))),ve.container.dataset.peerId=""+Ie,le.selector.list.append(ve.container)})},placeholder:"Search",onMultiSelect:Ee=>{v(Ee)},getMoreCustom:async Ee=>{const Ie=cI(Ee,!0);return te=new Map,{result:Ie.map(Ke=>(te.set(Ke.iso2,Ke),Ke.iso2)),isEnd:!0}},titleLangKey:"BoostingSelectCountry",checkboxSide:"left",noPlaceholder:!0}),me=le.selector.add.bind(le.selector);le.selector.add=({key:Ee,scroll:Ie})=>{const Ke=De.countriesList.find(se=>se.iso2===Ee),$=me({key:Ee,title:_(Ke.default_name),scroll:Ie});return hm($)&&$.avatar.render({peerTitle:cp(Ke.iso2)}),$},le.selector.searchSection.container.classList.add("is-countries"),le.selector.container.classList.add("is-countries"),le.selector.addInitial(y()),le.selector.setLimit(this.countriesLimit,()=>{Re({langPackKey:"BoostingSelectUpToWarningCountriesPlural",langPackArguments:[this.countriesLimit]})})},re=[he((()=>{const ne=he(()=>!k());return()=>ne()&&ke(Ws,{name:"BoostsViaGifts.Quantity",get nameRight(){return ke(ow,{get boosts(){return A()}})},caption:"BoostsViaGifts.QuantitySubtitle",captionOld:!0,get children(){return x.container}})})()),ke(Ws,{name:"BoostsViaGifts.Channels",get children(){return[ke(Mi,{get each(){return r()},children:(ne,Y)=>{const j=new Mt;j.update({peerId:ne}),j.element.classList.add("text-bold");let te;(()=>{const me=rw(),Ee=te;return typeof Ee=="function"?Nt(Ee,me):te=me,q(me,(()=>{const Ie=he(()=>Y()===0);return()=>Ie()&&_("BoostsViaGifts.ChannelSubscription",[A()])})(),null),q(me,(()=>{const Ie=he(()=>Y()!==0);return()=>Ie()&&Nn(ne.toChatId(),void 0,void 0,!0)})(),null),me})();const le=new ge({title:j.element,subtitle:te,...ne!==e.peerId&&{clickable:me=>{le.openContextMenu(me)},contextMenu:{buttons:[{icon:"delete",danger:!0,text:"Remove",onClick:()=>{l(me=>me.filter(Ee=>Ee!==ne))}}]}}});return le.container.classList.add("popup-boosts-channel"),le.createMedia("abitbigger").append(dn({peerId:ne,size:42}).node),le.container}}),ee]}}),ke(Ws,{name:"BoostsViaGifts.Users",caption:"BoostsViaGifts.UsersSubtitle",captionOld:!0,get children(){const ne=zf();return q(ne,()=>new ge({titleLangKey:"AllSubscribers",clickable:Y=>(w(!1),ae(Y)),checkboxField:new ct({...F,checked:!0,name:"giveaway-users"}),subtitle:_e(),listenerSetter:e.listenerSetter}).container,null),q(ne,()=>new ge({titleLangKey:"OnlyNewSubscribers",clickable:Y=>(w(!0),ae(Y)),checkboxField:new ct({...F,name:"giveaway-users"}),subtitle:_e(),listenerSetter:e.listenerSetter}).container,null),ne}})],Ue=(()=>{const ne=IE(),Y=ne.firstChild,j=Y.nextSibling;return q(Y,s),j.$$input=te=>{const le=te.target;let me=le.value;const Ee=me.length>128;Ee&&(le.value=me=me.slice(0,128)),M(me),Ee&&Ha(le)},Nt(te=>{$t(te,"BoostsViaGifts.AdditionalPrizeLabel",void 0,"placeholder")},j),ne})(),ye=[ke(Ws,{get caption(){return S()?"BoostsViaGifts.AdditionalPrizesSubtitle":"BoostsViaGifts.AdditionalPrizesSubtitleOff"},get captionArgs(){return he(()=>!!S())()?[_(L()?"BoostsViaGifts.AdditionalPrizesDetailedWith":"BoostsViaGifts.AdditionalPrizesDetailed",[s(),L(),Cr(g().months,!0)].filter(Boolean))]:void 0},captionOld:!0,get children(){return[he(()=>new ge({titleLangKey:"BoostsViaGifts.AdditionalPrizes",clickable:()=>{I(ne=>!ne)},checkboxField:new ct({toggle:!0,checked:Zt(S)}),listenerSetter:t.listenerSetter}).container),he(()=>S()&&Ue)]}}),ke(Ws,{caption:"BoostsViaGifts.ShowWinnersSubtitle",captionOld:!0,get children(){return new ge({titleLangKey:"BoostsViaGifts.ShowWinners",clickable:()=>{E(ne=>!ne)},checkboxField:new ct({toggle:!0,checked:Zt(P)}),listenerSetter:t.listenerSetter}).container}}),ke(Ws,{name:"BoostsViaGifts.End",caption:"BoostsViaGifts.EndSubtitle",get captionArgs(){return[A()]},captionOld:!0,get children(){return N.container}})],Z=[ke(Ws,{noDelimiter:!0,get children(){return[(()=>{const ne=LE(),Y=ne.firstChild,j=R;return typeof j=="function"?Nt(j,Y):R=Y,ne})(),(()=>{const ne=ME();return q(ne,()=>_("BoostsViaGifts.Title")),ne})(),(()=>{const ne=PE();return q(ne,()=>_("BoostsViaGifts.Subtitle")),ne})(),he(()=>k()&&B),he(()=>he(()=>!k())()&&(()=>{const ne=zf();return q(ne,H,null),q(ne,z,null),ne})())]}}),he(()=>!h()&&re),he((()=>{const ne=he(()=>!k());return()=>ne()&&ke(Ws,{name:"BoostsViaGifts.Duration",caption:"BoostsViaGifts.DurationSubtitle",captionArgs:[ue],captionOld:!0,get children(){return p()}})})()),he(()=>!h()&&ye)];In(R,`assets/img/premiumboostsstar${window.devicePixelRatio>1?"@2x":""}.png`),lw({button:this.btnConfirm,langKey:()=>"BoostsViaGifts.Start",boosts:A}),this.footer.append(this.btnConfirm),this.body.after(this.footer),this.footer.classList.add("abitlarger");const de=async()=>{const{amount:ne,currency:Y}=g(),j=await Promise.all(r().map(te=>this.managers.appPeersManager.getInputPeerById(te)));return{_:"inputStorePaymentPremiumGiveaway",pFlags:{only_new_subscribers:b()||void 0,winners_are_visible:P()||void 0},amount:ne,currency:Y,boost_peer:j[0],random_id:Dc(),until_date:n(),additional_peers:j.length>1?j.slice(1):void 0,countries_iso2:y()?.length?y():void 0,prize_description:S()&&L()||void 0}},be=async()=>{const{amount:ne,currency:Y}=g(),j=await Promise.all(c().map(te=>this.managers.appUsersManager.getUserInput(te.toUserId())));return{_:"inputStorePaymentPremiumGiftCode",amount:ne,currency:Y,boost_peer:await this.managers.appPeersManager.getInputPeerById(this.peerId),users:j}},pe=async ne=>(await ft({titleLangKey:"BoostingStartGiveawayConfirmTitle",descriptionLangKey:"BoostingStartGiveawayConfirmText",button:{langKey:"Start"}}),this.managers.appPaymentsManager.launchPrepaidGiveaway(this.peerId,this.prepaidGiveaway.id,ne)),xe=async ne=>{const Y={_:"inputInvoicePremiumGiftCode",purpose:ne,option:g()},j=await this.managers.appPaymentsManager.getPaymentForm(Y),te=J.createPopup(sh,{inputInvoice:Y,paymentForm:j});await new Promise((le,me)=>{te.addEventListener("finish",Ee=>{Ee==="cancelled"||Ee==="failed"?me():le()})})};return D(this.btnConfirm,async()=>{const ne=zt(this.btnConfirm,!0);try{const Y=await(h()?be:de)();let j;k()?j=pe(Y):j=xe(Y),await j,this.onCreated?.(),this.hide()}catch(Y){console.error("boosts via gifts error",Y),ne()}},{listenerSetter:this.listenerSetter}),Z}async construct(){const[e,t]=await Promise.all([this.managers.appPaymentsManager.getPremiumGiftCodeOptions(this.peerId),this.managers.apiManager.getAppConfig()]);this.premiumGiftCodeOptions=e,this.appConfig=t,this.subscribersLimit=this.channelsLimit=t.giveaway_add_peers_max??10,this.countriesLimit=t.giveaway_countries_max??10;const s=document.createElement("div");this.scrollable.append(s);const i=$a(()=>this._construct(),s);this.addEventListener("closeAfterTimeout",i),this.show()}}Dr(["input"]);const EE=He("<div class=popup-boost-avatars-avatar-container>"),_E=He("<div><div class=popup-boost-avatars-left></div><div class=popup-boost-avatars-right>"),kE=He("<div class=popup-boost-title>"),TE=He("<span>"),dl="popup-boost";class xE extends ms{constructor(e,t,s){super("popup-forward popup-chatlist-invite "+dl,{closable:!0,overlayClosable:!0,body:!0,description:!0,footer:!0,withConfirm:!0}),this.peerId=e,this.myBoosts=t,this.appConfig=s,this.btnClose.remove(),this.header.remove(),qs(i=>{this.middlewareHelper.get().onDestroy(i),this.construct()})}async construct(){const[e,t]=we([]),[s,i]=we(0),n=new Map,a=()=>{const u=v=>{const b=Zt(()=>dn({peerId:v.peerId,size:60}));return b.node.classList.add(`${dl}-avatars-avatar`),b.node.append(),b},p=u({peerId:this.peerId,right:!0}),m=he(v=>{const b=new Map;v?.forEach((S,I)=>{b.set(S,I)});const w=Ua(e().map(S=>Je(S.peer)).reverse());return w.sort((S,I)=>(b.get(S)??0)-(b.get(I)??0)),w}),g=26,f=ke(Mi,{get each(){return m()},children:(v,b)=>{const{element:w}=u({peerId:v}),S=he(()=>m().length-b()-1);return(()=>{const I=EE();return q(I,w,null),q(I,ke(kr,{icon:"boostcircle",get class(){return jt(`${dl}-avatars-avatar-icon`,!S()&&"is-visible")}}),null),mt(L=>qi(I,`--offset: ${S()*-g}px`,L)),I})()}}),y=pg(Ym(()=>f).toArray,{exitMethod:"keep-index",onChange:({added:v,removed:b,finishRemoved:w})=>{const S={duration:et.isAvailable("animations")?200:0,easing:"ease-in-out"},I=[{transform:"translateX(var(--offset)) scale(0)"},{transform:"translateX(var(--offset)) scale(1)"}];queueMicrotask(()=>{for(const P of v)P.animate(I,S);const L=I.slice().reverse(),M=[];for(const P of b){const E=P.animate(L,S);M.push(E.finished)}Promise.all(M).then(()=>w(b))})}});return(()=>{const v=_E(),b=v.firstChild,w=b.nextSibling;return q(b,y),q(v,ke(kr,{icon:"next",class:`${dl}-avatars-arrow`}),w),q(w,()=>p.element),mt(S=>{const I=jt(`${dl}-avatars`,m().length&&"has-left"),L=`transform: translateX(${Math.max(0,m().length-1)*(g/2)}px)`;return I!==S._v$&&st(v,S._v$=I),S._v$2=qi(v,L,S._v$2),S},{_v$:void 0,_v$2:void 0}),v})()};this.description.before(a(),(()=>{const u=kE();return q(u,()=>_("Boost.Replace")),u})());const r=new Map;this.selector=new li({middleware:this.middlewareHelper.get(),appendTo:this.body,onChange:u=>{t(this.selector.getSelected().map(p=>n.get(p))),i(u)},onFirstRender:()=>{this.show()},multiSelect:!0,noSearch:!0,sectionNameLangPackKey:"BoostingRemoveBoostFrom",avatarSize:"abitbigger",managers:this.managers,peerType:[],getSubtitleForElement:u=>{const p=n.get(u);return qs(m=>{this.middlewareHelper.get().onDestroy(()=>{m(),clearInterval(b)});const g=_("BoostsExpiration",[1,Ss(p.expires,void 0,!0)]),[f,y]=we(Es(!0)),v=he(w=>{const S=Math.max(0,(p.cooldown_until_date||0)-f());return!S&&w!==void 0&&clearInterval(b),S});r.set(u,v);const b=v()?window.setInterval(()=>{y(Es(!0))},1e3):void 0;return(()=>{const w=TE();return q(w,(()=>{const S=he(()=>!!v());return()=>S()?_("BoostingAvailableIn",[pv(v())]):g})()),w})()})},getPeerIdFromKey:u=>u.split("_")[1].toPeerId(),processElementAfter:(u,p)=>{const m=r.get(u);qs(g=>{this.middlewareHelper.get().onDestroy(g),Ne(()=>{p.container.classList.toggle("is-unavailable",!!m())})})}});const l=this.selector.add.bind(this.selector);this.selector.add=(...u)=>this.selector.getElementByPeerId(u[0].key).classList.contains("is-unavailable")?(Re({langPackKey:"Boost.Reassign.Wait",langPackArguments:[_("MoreBoosts",[this.appConfig.boosts_per_sent_gift??1]),fi(()=>{Br(),this.hideWithCallback(()=>{ce.initGifting()})})]}),!1):l(...u);const c=this.myBoosts.my_boosts.map(u=>{const p=Je(u.peer);if(p===this.peerId)return;const m="S"+u.slot+"_"+p;return n.set(m,u),m}).filter(Boolean);this.scrollable=this.selector.scrollable,this.attachScrollableListeners(),this.selector.renderResultsFunc(c);let d=!1;const h=async u=>{X(u),d=!0;const p=zt(this.btnConfirm,!0);try{const m=e().map(f=>f.slot),g=Ua(e().map(f=>Je(f.peer)));await this.managers.appBoostsManager.applyBoost(this.peerId,m),this.hide(),Re({langPackKey:"BoostingReassignedFromPlural",langPackArguments:[m.length,_("BoostingFromOtherChannel",[g.length])]})}catch(m){console.error("error replacing boosts",m),p()}d=!1};D(this.btnConfirm,h,{listenerSetter:this.listenerSetter}),lw({button:this.btnConfirm,langKey:()=>"Boost.Reassign",langArgs:()=>[s()||1],boosts:s}),Ne(()=>{d||zt(this.btnConfirm,!s())}),this.description.append(_("Boost.Reassign.Description",[await Oe({peerId:this.peerId}),_("Boost.GiftPremium",[fi(()=>{this.hideWithCallback(()=>{ce.initGifting()})})]),_("Boost.Additional",[this.appConfig.boosts_per_sent_gift??1])])),this.footer.append(this.btnConfirm),this.body.after(this.footer)}}const Id="popup-boost";class AE extends ms{constructor(e){super(Id,{closable:!0,overlayClosable:!0,description:!0}),this.peerId=e,this.btnClose.remove(),this.header.remove(),this.construct()}async construct(){let[e,t,s,i]=await Promise.all([this.managers.appBoostsManager.getBoostsStatus(this.peerId),this.managers.appBoostsManager.getMyBoosts(),this.managers.apiManager.getAppConfig(),fe.isPremiumPurchaseBlocked()]);const n=li.renderEntity({key:this.peerId,middleware:this.middlewareHelper.get(),avatarSize:30});n.element.classList.add(`${Id}-entity`,"selector-user-alone","hover-primary");const a=Ao("span",20,"premium");a.classList.add(`${Id}-entity-badge`),n.element.append(a),D(n.element,()=>{this.hideWithCallback(()=>{ce.setInnerPeer({peerId:this.peerId})})},{listenerSetter:this.listenerSetter});const r=document.createElement("div");r.classList.add(`${Id}-title`);const l=await Oe({peerId:this.peerId});await n.avatar.readyThumbPromise;let c,d,h,u,p=!1;const m=M=>{e=M,c=e.level>0||e.next_level_boosts===e.boosts,d=e.next_level_boosts-e.boosts,h=e.next_level_boosts===void 0,u=!!e.pFlags.my_boost},g=()=>{u?r.replaceChildren(_("YouBoostedChannel")):h?r.replaceChildren(_("BoostsMaxLevelReached")):c?r.replaceChildren(_("HelpUpgradeChannel")):r.replaceChildren(_("Boost.EnableStoriesFor"))},f=()=>{p&&e.level===0&&c?this.description.replaceChildren(_("Boost.DescriptionJustReachedLevel1")):h||p&&e.level>0?this.description.replaceChildren(_("Boost.DescriptionJustReachedLevel",[e.level,_("Boost.StoriesCount",[e.level+1])])):c?this.description.replaceChildren(_("ChannelNeedBoostsDescriptionForNewFeatures",[l,_("MoreBoosts",[d])])):this.description.replaceChildren(_("ChannelNeedBoostsDescriptionLevel1",[_("MoreBoosts",[d])]))},y=new Oh({progress:!0,hint:{icon:"boost",noStartEnd:!0}});this.description.before(y.container,r,n.element);const v=()=>t.my_boosts.filter(M=>Je(M.peer)===this.peerId),b=()=>{const M=h?1:(e.boosts-e.current_level_boosts)/(e.next_level_boosts-e.current_level_boosts);y.setProgress(M,""+e.boosts,{from1:_("BoostsLevel",[e.level]),to1:_("BoostsLevel",[e.level+1]),from2:_("BoostsLevel",[e.level]),to2:_("BoostsLevel",[e.level+1])}),g(),f(),w(),a.textContent=`x${v().length}`,a.classList.toggle("is-badge-empty",!u)},w=()=>{this.setButtons(xr([h||v().length===t.my_boosts.length&&i?{langKey:"OK",isCancel:!0}:{langKey:"BoostChannel",iconLeft:"boost",callback:L}]))},S=M=>{if(M==="PREMIUM_ACCOUNT_REQUIRED")I();else if(M.includes("FLOOD_WAIT")){const P=+M.split("_")[2];ft({titleLangKey:"CantBoostTooOften",descriptionLangKey:"CantBoostTooOftenDescription",descriptionLangArgs:[xh(Oc(P,2),!1)],button:{langKey:"OK",isCancel:!0}})}else M==="PREMIUM_GIFTED_NOT_ALLOWED"&&ft({titleLangKey:"CantBoostWithGiftedPremium",descriptionLangKey:"CantBoostWithGiftedPremiumDescription",button:{langKey:"OK",isCancel:!0}})},I=()=>{ft({titleLangKey:"PremiumNeeded",descriptionLangKey:"PremiumNeededForBoosting",button:{langKey:"Yes"}}).then(()=>{ps.show()})},L=async M=>{X(M);try{const P=v(),E=t.my_boosts.find(A=>!A.peer);let k;if(!C.premium)k="PREMIUM_ACCOUNT_REQUIRED";else if(P.length===t.my_boosts.length){await ft({titleLangKey:"BoostingMoreBoostsNeeded",descriptionLangKey:"Boost.GetMoreBoosts",descriptionLangArgs:[await Oe({peerId:this.peerId}),s.boosts_per_sent_gift??1],button:{langKey:"GiftPremium"}}),this.hideWithCallback(()=>{ce.initGifting()});return}else if(!E){this.hide(),J.createPopup(xE,this.peerId,t,s);return}if(k)throw{type:k};await this.managers.appBoostsManager.applyBoost(this.peerId,[E.slot]),[t,e]=await Promise.all([this.managers.appBoostsManager.getMyBoosts(),this.managers.appBoostsManager.getBoostsStatus(this.peerId)]),p=!0,m(e),b()}catch(P){S(P.type)}return!1};m(e),b(),y._setHintActive(),this.show()}}class FE{constructor(){this.processMessageLink=e=>{const t=e.post?+e.post:void 0,s=e.comment?+e.comment:void 0,i=e.thread?+e.thread:void 0;return ce.openUsername({userName:e.domain,lastMsgId:t,commentId:s,startParam:e.start,stack:e.stack,threadId:i,mediaTimestamp:e.t&&+e.t})},this.processPrivatePostLink=async e=>{const t=e.channel.toChatId(),s=await this.managers.appChatsManager.getChat(t);if(!s)try{await this.managers.appChatsManager.resolveChannel(t)}catch(a){throw Re({langPackKey:"LinkNotFound"}),a}const i=+e.post,n=e.thread?+e.thread:void 0;return ce.op({peer:s,lastMsgId:i,threadId:n,stack:e.stack,mediaTimestamp:e.t&&+e.t})},this.processStickerSetLink=e=>{const t=J.createPopup(Pn,{id:e.set},e._===gt.EMOJI_SET);return t.show(),t},this.processJoinChatLink=e=>this.managers.appChatInvitesManager.checkChatInvite(e.invite).then(t=>{if(t._==="chatInviteAlready"||t._==="chatInvitePeek"){ce.setInnerPeer({peerId:t.chat.id.toPeerId(!0)});return}return J.createPopup(ac,e.invite,t)},t=>{t.type==="INVITE_HASH_EXPIRED"&&Rs(_("InviteExpired"))}),this.processVoiceChatLink=e=>{if($l)return ce.joinGroupCall(e.chat_id.toPeerId(!0),e.id)},this.processUserPhoneNumberLink=e=>this.managers.appUsersManager.resolvePhone(e.phone).then(t=>ce.setInnerPeer({peerId:t.id.toPeerId(!1)})).catch(t=>{t.type==="PHONE_NOT_OCCUPIED"&&Re({langPackKey:"Alert.UserDoesntExists"})}),this.processInvoiceLink=e=>this.managers.appPaymentsManager.getInputInvoiceBySlug(e.slug).then(t=>this.managers.appPaymentsManager.getPaymentForm(t).then(s=>J.createPopup(sh,{inputInvoice:t,paymentForm:s}),s=>{throw s.type==="SLUG_INVALID"&&Re({langPackKey:"PaymentInvoiceLinkInvalid"}),s})),this.processAttachMenuBotLink=async e=>{const t=e.attach||e.domain||e.nestedLink.domain,s=await this.managers.appUsersManager.resolveUserByUsername(t).catch(()=>{});let i;e.attach!==void 0&&(i=this.processInternalLink(e.nestedLink));let n;if(s?s.pFlags.bot_attach_menu||(n="BotCantAddToAttachMenu"):n="Alert.UserDoesntExists",n){Re({langPackKey:n});return}i&&await i;const a=await ce.toggleBotInAttachMenu(s.id,!0);if(e.choose){const r=e.choose.split("+"),l={bots:"attachMenuPeerTypeBotPM",users:"attachMenuPeerTypePM",groups:"attachMenuPeerTypeChat",channels:"attachMenuPeerTypeBroadcast"},c=r.filter(h=>{const u=l[h];return a.peer_types.some(p=>p._===u)}),d=await _s.createPicker(c);await ce.setInnerPeer({peerId:d})}ce.chat.openWebApp({attachMenuBot:a,startParam:e.startattach})},this.processWebAppLink=async e=>{const t=await this.managers.appUsersManager.resolveUserByUsername(e.domain).catch(()=>{});if(!t){Re({langPackKey:"Alert.UserDoesntExists"});return}const s=t.id;let i;try{i=await this.managers.appAttachMenuBotsManager.getBotApp(s,e.appname)}catch(r){if(r.type==="BOT_APP_INVALID"){Re({langPackKey:"Alert.BotAppDoesntExist"});return}else throw r}const n=t.pFlags.bot_attach_menu&&await ce.toggleBotInAttachMenu(s,!0);let a;n||(i.pFlags.inactive||e.masked)&&(a=await ce.confirmBotWebViewInner({botId:s,requestWriteAccess:i.pFlags.request_write_access,showDisclaimer:t.pFlags.bot_attach_menu&&i.pFlags.inactive})),ce.chat.openWebApp({attachMenuBot:n,startParam:e.startapp,writeAllowed:a,botId:s,app:i.app,noConfirmation:!n,hasSettings:i.pFlags.has_settings})},this.processListLink=async e=>{let t;try{t=await this.managers.filtersStorage.checkChatlistInvite(e.slug)}catch(s){if(s.type==="INVITE_SLUG_EXPIRED"){Re({langPackKey:"SharedFolder.Link.Expired"});return}throw s}J.createPopup(rg,{chatlistInvite:t,slug:e.slug})},this.processStoryLink=async e=>{const t=window.event,s=U(t.target,"bubble");if(s&&s.classList.contains("story")){hs(s.querySelector(".media-container").querySelector("img, video"));return}let i;try{i=await this.managers.appUsersManager.resolveUsername(e.domain)}catch(r){r.type==="USERNAME_NOT_OCCUPIED"?Re({langPackKey:"NoUsernameFound"}):console.error(r);return}const n=i.id.toPeerId(i._!=="user");if(!await this.managers.appStoriesManager.getStoryById(n,+e.story)){Re({langPackKey:"NoStoryFound"});return}Da({peerId:n,id:+e.story})},this.processBoostLink=async e=>{let t=e.channel?e.channel.toPeerId(!0):void 0;t===void 0&&(t=(await this.managers.appUsersManager.resolveUsername(e.domain)).id.toPeerId(!0)),J.createPopup(AE,t)},this.processPremiumFeaturesLink=async e=>{if(C.premium){Re({langPackKey:"Premium.Offset.AlreadyHave"});return}ps.show()},this.processGiftCodeLink=e=>{J.createPopup(Kn,e.slug,e.stack)}}construct(e){this.managers=e,Bs({name:"showMaskedAlert",callback:(t,s)=>{const i=s.href,n=s.cloneNode(!0);n.className="anchor-url",n.innerText=i,n.removeAttribute("onclick");const a=J.createPopup(ms,"popup-masked-url",{titleLangKey:"OpenUrlTitle",descriptionLangKey:"OpenUrlAlert2",descriptionLangArgs:[n],buttons:[{langKey:"Open",callback:()=>{n.click()}}]});return a.show(),a}}),Bs({name:"execBotCommand",callback:({uriParams:t})=>{const{command:s,bot:i}=t;return this.managers.appMessagesManager.sendText({peerId:ce.chat.peerId,text:"/"+s+(i?"@"+i:"")})}}),Bs({name:"searchByHashtag",callback:({uriParams:t})=>{const{hashtag:s}=t;if(s)return ce.chat.initSearch({query:"#"+s+" "})}}),Bs({name:"setMediaTimestamp",callback:(t,s)=>{const i=+s.dataset.timestamp;if(U(s,"bubble")){ce.chat.bubbles.playMediaWithTimestamp(s,i);return}if(U(s,"media-viewer-caption"))return window.appMediaViewer.setMediaTimestamp(i)}}),[["addstickers",gt.STICKER_SET],["addemoji",gt.EMOJI_SET]].forEach(([t,s])=>{Bs({name:t,callback:({pathnameParams:i})=>{if(!i[1])return;const n={_:s,set:i[1]};return this.processInternalLink(n)}}),Bs({name:t,protocol:"tg",callback:({uriParams:i})=>{const n=this.makeLink(s,i);return this.processInternalLink(n)}})}),Bs({name:"invoice",callback:({pathnameParams:t})=>{const s={_:gt.INVOICE,slug:t.length>1?t[1]:t[0].slice(1)};return this.processInternalLink(s)}}),Bs({name:"addlist",callback:({pathnameParams:t})=>{const s={_:gt.ADD_LIST,slug:t[1]};return this.processInternalLink(s)}}),Bs({name:"joinchat",callback:({pathnameParams:t})=>{const s={_:gt.JOIN_CHAT,invite:t[1]||decodeURIComponent(t[0]).slice(1)};return this.processInternalLink(s)}}),$l&&Bs({name:"voicechat",protocol:"tg",callback:({uriParams:t})=>{const s=this.makeLink(gt.VOICE_CHAT,t);return this.processInternalLink(s)}}),Bs({name:"im",callback:async({pathnameParams:t,uriParams:s},i,n)=>{let a;if("boost"in s||t?.[0]==="boost"){const r=t?.[0]==="c"?t[1]:s.c;a={_:gt.BOOST,domain:r?void 0:"boost"in s?t[0]:t[1],channel:r}}else if(t?.[1]==="s")a={_:gt.STORY,domain:t[0],story:t[2]};else if(uC.test(t[0]))a={_:gt.USER_PHONE_NUMBER,phone:t[0].slice(1)};else if(t[0]==="c"){t.shift();const r="thread"in s?s.thread:t[2]&&t[1];a={_:gt.PRIVATE_POST,channel:t[0],post:t[2]||t[1],thread:r,comment:s.comment,stack:ce.getStackFromElement(i),t:s.t}}else if(t[1]&&lL(t[1]))a={_:gt.WEB_APP,domain:t[0],appname:t[1],startapp:s.startapp,masked:n};else{const r="thread"in s?s.thread:t[2]&&t[1];a={_:gt.MESSAGE,domain:t[0],post:t[2]||t[1],thread:r,comment:s.comment,start:"start"in s?s.start:void 0,stack:ce.getStackFromElement(i),t:s.t}}return("startattach"in s||"attach"in s)&&(a={_:gt.ATTACH_MENU_BOT,nestedLink:a,...s}),this.processInternalLink(a)}}),Bs({name:"resolve",protocol:"tg",callback:({uriParams:t},s,i)=>{let n;if(t.story?n=this.makeLink(gt.STORY,t):t.phone?n=this.makeLink(gt.USER_PHONE_NUMBER,t):t.domain==="telegrampassport"||(t.appname?n=this.makeLink(gt.WEB_APP,{masked:i,...t}):n=this.makeLink(gt.MESSAGE,{...t,stack:ce.getStackFromElement(s)})),t.attach!==void 0||t.startattach!==void 0){const a=n;n=this.makeLink(gt.ATTACH_MENU_BOT,t),n.nestedLink=a}return this.processInternalLink(n)}}),Bs({name:"privatepost",protocol:"tg",callback:({uriParams:t})=>{const s=this.makeLink(gt.PRIVATE_POST,t);return this.processInternalLink(s)}}),Bs({name:"invoice",protocol:"tg",callback:({uriParams:t})=>{const s=this.makeLink(gt.INVOICE,t);return this.processInternalLink(s)}}),Bs({name:"addlist",protocol:"tg",callback:({uriParams:t})=>{const s=this.makeLink(gt.ADD_LIST,t);return this.processInternalLink(s)}}),["joinchat","join"].forEach(t=>{Bs({name:t,protocol:"tg",callback:({uriParams:s})=>{const i=this.makeLink(gt.JOIN_CHAT,s);return this.processInternalLink(i)}})}),Bs({name:"boost",protocol:"tg",callback:({uriParams:t})=>{const s=this.makeLink(gt.BOOST,t);return this.processInternalLink(s)}}),Bs({name:"boost",callback:({pathnameParams:t})=>{const s={_:gt.BOOST,domain:t[1]};return this.processInternalLink(s)}}),Bs({name:"premium_offer",protocol:"tg",callback:({uriParams:t})=>{const s=this.makeLink(gt.PREMIUM_FEATURES,t);return this.processInternalLink(s)}}),Bs({name:"giftcode",callback:({pathnameParams:t},s)=>{const i={_:gt.GIFT_CODE,slug:t[1],stack:ce.getStackFromElement(s)};return this.processInternalLink(i)}}),Bs({name:"giftcode",protocol:"tg",callback:({uriParams:t},s)=>{const i=this.makeLink(gt.GIFT_CODE,t);return i.stack=ce.getStackFromElement(s),this.processInternalLink(i)}})}makeLink(e,t){return{_:e,...t}}processInternalLink(e){const s={[gt.MESSAGE]:this.processMessageLink,[gt.PRIVATE_POST]:this.processPrivatePostLink,[gt.EMOJI_SET]:this.processStickerSetLink,[gt.STICKER_SET]:this.processStickerSetLink,[gt.JOIN_CHAT]:this.processJoinChatLink,[gt.VOICE_CHAT]:this.processVoiceChatLink,[gt.USER_PHONE_NUMBER]:this.processUserPhoneNumberLink,[gt.INVOICE]:this.processInvoiceLink,[gt.ATTACH_MENU_BOT]:this.processAttachMenuBotLink,[gt.WEB_APP]:this.processWebAppLink,[gt.ADD_LIST]:this.processListLink,[gt.STORY]:this.processStoryLink,[gt.BOOST]:this.processBoostLink,[gt.PREMIUM_FEATURES]:this.processPremiumFeaturesLink,[gt.GIFT_CODE]:this.processGiftCodeLink}[e._];if(!s){console.warn("Not supported internal link:",e);return}return s(e)}}const co=new FE;Gs&&(Gs.internalLinkProcessor=co);function cw(){return window.getSelection?window.getSelection().toString():document.selection?document.selection.createRange().text:""}async function RE(o){return{cached:o.cached,result:o.cached?await o.result:o.result}}function Ro(o){return o.then(RE)}function DE(o,e){const t=[];for(;o.parentElement&&o.parentElement!==document.body&&(o=o.parentElement,t.push(o),!(e&&o.matches(e))););return t}const BE=He("<div><span class=similar-channels-channel-badge>"),NE=He("<div class=similar-channels-channel-avatar-stack><div class=similar-channels-channel-avatar-stack-middle></div><div class=similar-channels-channel-avatar-stack-last>"),OE=He("<div class=similar-channels-list>"),Wf=He("<div class=similar-channels-list-margin>"),UE=He('<div class=similar-channels-container><svg class=similar-channels-notch width=19 height=7 viewBox="0 0 19 7"fill=none xmlns=http://www.w3.org/2000/svg><path class=similar-channels-notch-path fill-rule=evenodd clip-rule=evenodd d="M19 7C16.8992 7 13.59 3.88897 11.5003 1.67424C10.7648 0.894688 10.397 0.50491 10.0434 0.385149C9.70568 0.270811 9.4225 0.270474 9.08456 0.38401C8.73059 0.50293 8.36133 0.892443 7.62279 1.67147C5.52303 3.88637 2.18302 7 0 7L19 7Z"></path></svg><div class=similar-channels-header>');function HE(o){const[e,t]=we(C.premium),[s,i]=we(),[n,a]=we();let{onAcked:r,onReady:l,onEmpty:c}=o;const d=document.createElement("canvas");d.width=20,d.height=20;const h=d.getContext("2d",{alpha:!1,willReadFrequently:!0});C.addEventListener("premium_toggle",t);const u=async()=>{const p=fe.isPremiumFeaturesHidden(),m=await Promise.all([C.managers.acknowledged.appChatsManager.getChannelRecommendations(o.chatId),C.managers.acknowledged.apiManager.getLimit("recommendedChannels",!1),C.managers.acknowledged.apiManager.getLimit("recommendedChannels",!0),{cached:!(p instanceof Promise),result:Promise.resolve(p)}]);return{cached:m.every(g=>g.cached),results:Promise.all(m.map(g=>g.result))}};return Ne(async()=>{e();const p=Ii().get(),{cached:m,results:g}=await u();if(r?.(m),r=void 0,!p())return;const f=await g;if(p()){if(!f[0].chats.length){o.onEmpty?.();return}i(f)}}),Ne(async()=>{const p=s();if(!p)return;const[m,g,f,y]=p,v=m.count??m.chats.length,b=v>g&&!y,w=new Map,S=(k,A)=>{const[x,T]=we(),O=H=>{H.naturalWidth<100||(h.drawImage(H,0,0,d.width,d.height),T(YC(d)))},F=k.id.toPeerId(!0),N=b&&A()===g-1,G=Zt(()=>dn({peerId:F,size:60,processImageOnLoad:O}));G.node.classList.add("similar-channels-channel-avatar"),L.push(G.readyThumbPromise),N&&G.node.classList.add("similar-channels-channel-avatar-stack-first");let R;if(N)R=_("MoreSimilar");else{const H=new Mt;L.push(H.update({peerId:F})),R=H.element}R.classList.add("similar-channels-channel-name");const B=ke(kr,{icon:N?"premium_lock":"newprivate_filled",class:"similar-channels-channel-badge-icon"});return(()=>{const H=BE(),z=H.firstChild;return Nt(W=>w.set(W,N?void 0:k),H),q(H,()=>N?(()=>{const W=NE(),ue=W.firstChild;return q(W,()=>G.element,ue),W})():G.element,z),q(z,N?[`+${v-g}`,he(()=>!Zt(e)&&B)]:[B,he(()=>Ri(k.participants_count||1,1))]),q(H,R,null),mt(W=>{const ue=jt("similar-channels-channel",N&&"is-last"),K=x()&&{"background-image":`url(${x()})`};return ue!==W._v$&&st(H,W._v$=ue),W._v$2=qi(z,K,W._v$2),W},{_v$:void 0,_v$2:void 0}),H})()},I=Ii().get(),L=[];let M;const P=(()=>{const k=OE(),A=M;return typeof A=="function"?Nt(A,k):M=k,q(k,ke(Mi,{get each(){return m.chats.slice(0,g)},children:S})),k})(),E=D(M,k=>{const A=U(k.target,"similar-channels-channel");if(!A)return;X(k);const x=w.get(A);if(x){ce.setInnerPeer({peerId:x.id.toPeerId(!0)});return}if(e()){J.createPopup(_s,{onSelect:F=>{ce.setInnerPeer({peerId:F})},peerType:["custom"],getMoreCustom:async()=>({result:m.chats.map(F=>F.id.toPeerId(!0)),isEnd:!0}),headerLangPackKey:"SimilarChannels"});return}const T=fi(()=>{O(),ps.show()});T.classList.add("primary");const{close:O}=uo({element:A.querySelector(".similar-channels-channel-avatar-stack, .similar-channels-channel-avatar"),container:A.parentElement,vertical:"top",textElement:_("SimilarChannels.Unlock",[T,f]),icon:"star"})});Et(E),await Promise.all(L),I()&&(a(P),l?.(),l=void 0)}),(()=>{const p=UE(),m=p.firstChild,g=m.nextSibling;return q(g,()=>_("SimilarChannels"),null),q(g,ke(Cn,{icon:"close",get onClick(){return o.onClose}}),null),q(p,ke(lg,{get children(){return[Wf(),he(()=>n()),Wf()]}}),null),p})()}function ra(o){return o?._==="forumTopic"}function Dn(o){return o?._==="savedDialog"}function Ta(o){return o?._==="dialog"}function dw(o){const e=o.fwd_from;if(!e)return!1;const t=hn(e),s=Je(e.from_id);return!!(t&&(s||e.from_name&&e.saved_from_name&&e.from_name!==e.saved_from_name))||!!e.saved_from_id}function Op(o){return o[0]}const VE=!1,$E=!1,jf=!1,GE=[["messageActionHistoryClear",!0],["messageActionChatCreate",o=>o.pFlags.out],["messageActionChannelMigrateFrom",!0],["messageActionChatMigrateTo",!0],["messageActionContactSignUp",!0]],zE=new Map(GE),cg=new Set;Gl&&cg.add("messageActionPhoneCall");let qf=0;const Qf=1,hw=3,Yf=300,Uu=new Error("peer changed"),KE=!1,WE=Yi,Hu=!0,uw={1:96,2:90,3:84,4:72,5:60,6:48,7:36},jE=Object.keys(uw).length,qE={telegram_channel:"Chat.Message.ViewChannel",telegram_megagroup:"OpenGroup",telegram_bot:"Chat.Message.ViewBot",telegram_botapp:"Chat.Message.ViewApp",telegram_user:"Chat.Message.SendMessage",telegram_chatlist:"OpenChatlist",telegram_story:"OpenStory",telegram_channel_boost:"BoostLinkButton",telegram_giftcode:"Open",telegram_chat:"OpenGroup"};function Vu(o){return Math.min(...o)}const QE=o=>{if(Je(o.from_id)!==Vt)return;let t;const s=o.chat_invite,i=o.webpage;return s?(t=s.photo,t||(t=s.chat)):i&&(t=i.photo),t};class YE{constructor(e,t){this.chat=e,this.managers=t,this.unreadOut=new Set,this.needUpdate=[],this.bubbles={},this.skippedMids=new Set,this.bubblesNewByGroupedId={},this.bubblesNew={},this.dateMessages={},this.scrolledDown=!0,this.isScrollingTimeout=0,this.unreaded=new Map,this.unreadedSeen=new Set,this.preloader=null,this.messagesQueueOnRenderAdditional=null,this.firstUnreadBubble=null,this.middlewareHelper=Gt(),this.followStack=[],this.isHeavyAnimationInProgress=!1,this.isFirstLoad=!0,this.passEntities={},this.viewsMids=new Set,this.isTopPaddingSet=!1,this.renderingMessages=new Set,this.bubblesToEject=new Set,this.bubblesToReplace=new Map,this.setPeerTempId=0,this.renderNewPromises=new Set,this.extendedMediaMessages=new Set,this.updateLocationOnEdit=new Map,this.unreadedObserverCallback=n=>{if(n.isIntersecting){const a=n.target,r=this.unreaded.get(a);this.onUnreadedInViewport(a,r)}},this.viewsObserverCallback=n=>{if(n.isIntersecting){const a=+n.target.dataset.mid;if(this.observer.unobserve(n.target,this.viewsObserverCallback),a)this.viewsMids.add(a),this.sendViewCountersDebounced();else{const{sponsoredMessage:r}=this;if(!r||r.viewed)return;r.viewed=!0,this.managers.appChatsManager.viewSponsoredMessage(this.peerId.toChatId(),r.random_id)}}},this.stickerEffectObserverCallback=n=>{if(n.isIntersecting){this.observer.unobserve(n.target,this.stickerEffectObserverCallback);const a=n.target.querySelector(".attachment");xs().then(()=>{Bn(a)&&hs(a)})}},this.onBubblesMouseMove=async n=>{const a=U(n.target,"bubble-content");if(!(this.chat.type!==Q.Scheduled&&a&&!this.chat.selection.isSelecting&&!U(n.target,"service")&&!U(n.target,"bubble-beside-button")&&this.peerId!==C.myId)){this.unhoverPrevious();return}const r=U(a,"bubble");if(!this.chat.selection.canSelectBubble(r)){this.unhoverPrevious();return}let{hoverBubble:l,hoverReaction:c}=this;if(r===l)return;if(this.unhoverPrevious(),l=this.hoverBubble=r,c=this.hoverReaction,c){c.dataset.loaded&&this.setHoverVisible(c,!0);return}c=this.hoverReaction=document.createElement("div"),c.classList.add("bubble-hover-reaction");const h=(c.middlewareHelper=this.getMiddleware().create()).get(()=>this.hoverReaction===c),u=document.createElement("div");u.classList.add("bubble-hover-reaction-sticker"),c.append(u),a.append(c);let p=this.chat.getMessage(+r.dataset.mid);if(p?._!=="message"){this.unhoverPrevious();return}p=await this.managers.appMessagesManager.getGroupsFirstMessage(p),Promise.all([this.managers.appReactionsManager.getAvailableReactionsByMessage(p,!0),fe.getAvailableReactions(),js(400)]).then(async([{reactions:m},g])=>{const f=m[0];if(!f){c.remove();return}const v=(f._==="reactionEmoji"?g.find(b=>b.reaction===f.emoticon):void 0)?.select_animation??await this.managers.appEmojiManager.getCustomEmojiDocument(f.document_id);h()&&Ds({div:u,doc:v,width:18,height:18,needUpscale:!0,middleware:h,group:this.chat.animationGroup,withThumb:!1,needFadeIn:!1}).then(({render:b})=>b).then(b=>{const w=()=>{h()&&(c.dataset.loaded="1",this.setHoverVisible(c,!0))};Array.isArray(b)?w():b.addEventListener("firstFrame",w,{once:!0}),D(c,S=>{X(S),this.chat.sendReaction({message:p,reaction:f}),this.unhoverPrevious()},{listenerSetter:this.listenerSetter})},qt)})},this.unhoverPrevious=()=>{const{hoverBubble:n,hoverReaction:a}=this;n&&(this.setHoverVisible(a,!1),this.hoverBubble=this.hoverReaction=void 0)},this.onBubblesClick=async n=>{let a=n.target,r=null;try{r=U(a,"bubble")}catch{}if(!r&&!this.chat.selection.isSelecting){const v=U(a,"user-avatar");if(!v)return;const b=v.dataset.peerId.toPeerId();b!==Vt?this.chat.appImManager.setInnerPeer({peerId:b}):Rs(De.format("HidAccount",!0));return}if(!r)return;if(r.classList.contains("is-date")&&U(a,"bubble-content")){if(r.classList.contains("is-fake")&&(r=r.previousElementSibling),r.classList.contains("is-sticky")&&!this.chatInner.classList.contains("is-scrolling"))return;for(const v in this.dateMessages)if(this.dateMessages[v].div===r){J.createPopup($c,new Date(+v),this.onDatePick).show();break}return}if(!Ye&&U(a,"time")){this.chat.selection.toggleByElement(r);return}if(this.chat.selection.isSelecting&&n.isTrusted){if(r.classList.contains("service")&&r.dataset.mid===void 0)return;if(X(n),Ye&&this.chat.selection.selectedText){this.chat.selection.selectedText=void 0;return}this.chat.selection.toggleByElement(U(a,"grouped-item")||r);return}const l=U(a,"media-spoiler-container");if(l){Hb({event:n,mediaSpoiler:l});return}const c=U(a,"contact");if(c){const v=c.dataset.peerId.toPeerId();if(v)this.chat.appImManager.setInnerPeer({peerId:v});else{const b=c.querySelector(".contact-number");Us(b.innerText.replace(/\s/g,"")),Re({langPackKey:"PhoneCopied"}),X(n)}return}const d=U(a,"bubble-call");if(d){this.chat.appImManager.callUser(this.peerId.toUserId(),d.dataset.type);return}if(U(a,"is-buy")){X(n);const v=this.chat.getMessage(+r.dataset.mid);if(!v)return;J.createPopup(sh,{message:v,inputInvoice:await this.managers.appPaymentsManager.getInputInvoiceByPeerId(v.peerId,v.mid)});return}const u=oi(a,"REACTION-ELEMENT");if(u){if(X(n),u.classList.contains("is-inactive"))return;const v=u.parentElement,b=v.getReactionCount(u),{reaction:w}=b;if(v.getType()===Ki.Tag){if(!C.premium){ps.show({feature:"saved_tags"});return}const S=this.chat.searchSignal();if(Ai(S?.reaction,w)){this.chat.contextMenu.onContextMenu(n);return}this.chat.initSearch({reaction:w})}else{const S=v.getContext();this.chat.sendReaction({message:S,reaction:w})}return}const p=kd(a,"data-sticker-emoji");if(p&&p.parentElement.querySelectorAll("[data-sticker-emoji]").length===1&&r.classList.contains("emoji-big")){this.chat.appImManager.onEmojiStickerClick({event:n,container:p,managers:this.managers,middleware:this.getMiddleware(),peerId:this.peerId});return}if(U(a,"replies")){const v=+r.dataset.mid;if(this.peerId===xa){const b=this.chat.getMessage(v),w=Je(b.reply_to.reply_to_peer_id),S=b.reply_to.reply_to_top_id,I=b.fwd_from.saved_from_msg_id;this.chat.appImManager.openThread({peerId:w,lastMsgId:I,threadId:S})}else{const b=this.chat.getMessage(v),w=await this.managers.appMessagesManager.getMessageWithReplies(b),S=w.replies;S&&this.managers.appMessagesManager.getDiscussionMessage(this.peerId,w.mid).then(I=>{this.chat.appImManager.setInnerPeer({peerId:S.channel_id.toPeerId(!0),type:Q.Discussion,threadId:I.mid})})}return}const g=U(a,"is-via");if(g){const v=g.querySelector(".peer-title");if(a===v||Vs(a,v)){if(this.chat.input.canSendPlain()){const b=v.innerText+" ";this.managers.appDraftsManager.setDraft(this.peerId,this.chat.threadId,b)}X(n);return}}const f=U(a,"peer-title")||jl(a)||U(a,"selector-user")||kd(a,"data-saved-from");if(f&&f!==r){a=f||a;const v=a.dataset.peerId||a.getAttribute("peer")||a.dataset.key,b=a.dataset.savedFrom;if(typeof v=="string"||b)if(b){const[w,S]=b.split("_");if(a.classList.contains("is-receipt-link")){const I=await this.managers.appMessagesManager.getMessageByPeer(w.toPeerId(),+S);if(I){const L=await this.managers.appPaymentsManager.getInputInvoiceByPeerId(this.peerId,+r.dataset.mid);J.createPopup(sh,{message:I,inputInvoice:L,isReceipt:!0})}}else this.chat.appImManager.setInnerPeer({peerId:w.toPeerId(),lastMsgId:+S,stack:this.chat.appImManager.getStackFromElement(a)})}else{const w=v.toPeerId();w!==Vt?(this.chat.appImManager.setInnerPeer({peerId:w}),this.chat.appImManager.clickIfSponsoredMessage(r.message)):Rs(De.format("HidAccount",!0))}return}if(r.classList.contains("sticker")&&a.parentElement.classList.contains("attachment")){const v=+r.dataset.mid,w=this.chat.getMessage(v).media?.document;w?.stickerSetInput&&J.createPopup(Pn,w.stickerSetInput).show();return}if(await this.checkTargetForMediaViewer(a,n))return;const y=U(a,"webpage");if(y){if(U(a,"webpage-preview-resizer")){n.preventDefault();return}const v=y.dataset.callback;v&&window[v](oi(a,"A"),n);const b=y.callback;b?.();return}if(["IMG","DIV","SPAN"].indexOf(a.tagName)===-1&&(a=oi(a,"DIV")),["DIV","SPAN"].indexOf(a.tagName)!==-1){if(a.classList.contains("goto-original")){const b=r.dataset.savedFrom,[w,S]=b.split("_");this.chat.appImManager.setInnerPeer({peerId:w.toPeerId(),lastMsgId:+S});return}else if(a.classList.contains("forward")){const b=+r.dataset.mid,w=await this.managers.appMessagesManager.getMessageByPeer(this.peerId,b);J.createPopup(jn,{[this.peerId]:await this.managers.appMessagesManager.getMidsByMessage(w)});return}let v=!1;try{v=!!U(n.target,"reply")}catch{}if(v&&r.classList.contains("is-reply")){const b=+r.dataset.mid,S=this.chat.getMessage(b).reply_to;if(S._==="messageReplyStoryHeader"){const M=r.querySelector(".reply-media"),P=Je(S.peer);Da({target:()=>M,peerId:P,id:S.story_id});return}let I=S.reply_to_msg_id;if(!I){Re({langPackKey:S.pFlags.quote?"QuotePrivate":"ReplyPrivate"});return}let L=S.reply_to_peer_id?Je(S.reply_to_peer_id):this.peerId;if(this.chat.type===Q.Discussion&&!this.chat.isForum){const M=await this.managers.appMessagesManager.getHistory({peerId:this.chat.peerId,threadId:this.chat.threadId,limit:1,offsetId:1,addOffset:-1}),P=this.chat.getMessage(M.history[0]);P.fwd_from.channel_post===I&&(I=P.mid,L=this.peerId)}this.followStack.push(b),this.chat.appImManager.setInnerPeer({peerId:L,lastMsgId:I,type:this.chat.type,threadId:this.chat.threadId})}}},this.onScroll=(n,a,r)=>{if(this.isHeavyAnimationInProgress){if(this.sliceViewportDebounced?.clearTimeout(),this.scrolledDown&&!n)return}else this.chat.topbar.pinnedMessage?.setCorrectIndexThrottled(this.scrollable.lastScrollDirection),this.sliceViewportDebounced?.(),this.setStickyDateManually();if(a&&a.distanceToEnd<Yf&&this.scrolledDown)return;const l=r?0:a?.distanceToEnd??this.scrollable.getDistanceToEnd();(this.scrollable.lastScrollDirection!==0&&l>0||a||r)&&(this.isScrollingTimeout?clearTimeout(this.isScrollingTimeout):this.chatInner.classList.contains("is-scrolling")||this.chatInner.classList.add("is-scrolling"),this.isScrollingTimeout=window.setTimeout(()=>{this.chatInner.classList.remove("is-scrolling"),this.isScrollingTimeout=0},1350+(a?.duration??0))),l<Yf&&(r||this.scrollable.loadedAll.bottom||this.chat.setPeerPromise||!this.peerId)?(this.container.classList.add("scrolled-down"),this.scrolledDown=!0):this.container.classList.contains("scrolled-down")&&(this.container.classList.remove("scrolled-down"),this.scrolledDown=!1)},this.processBatch=async(...n)=>{let[a,r,l]=n;const c=T=>T.filter(O=>O&&this.bubbles[O.bubble.dataset.mid]===O.bubble);a=c(a),l("messages rendered");const{firstGroup:d,lastGroup:h}=this.bubbleGroups,u=d?.firstMid,p=h?.lastMid,{groups:m,avatarPromises:g}=this.groupBubbles(a.filter(T=>T.updatePosition)),{firstGroup:f,lastGroup:y}=this.bubbleGroups,v=f?.firstMid;let b=y?.lastMid;const w=a.find(({message:T})=>T.pFlags.sponsored);w&&(b=w.message.mid);const S=u!==v,I=!!h&&p!==b,M=a?.[0]?.reverse,E=a.every(({reverse:T})=>T===M)?M:S&&!I;l("changed ends",S,I);const k=a.reduce((T,O)=>{const F=performance.now(),N=O.promises.slice(),G=N.map(async R=>(await R,performance.now()-F));return Promise.all(G).then(R=>{l.groupCollapsed("media message time",performance.now()-F,O,R),R.forEach((B,H)=>{l("media message time",B,H,N[H])}),l.groupEnd()}),T.push(...O.promises),T},[]);k.push(...g),k.push(xs()),l("media promises to call",k,a,this.isHeavyAnimationInProgress),await r(Promise.all([...k,this.setUnreadDelimiter()]).catch(qt)),await r(ip()),l("media promises end"),a=c(a);const{restoreScroll:A,scrollSaver:x}=this.prepareToSaveScroll(E,u===v,p===b);a.some(T=>T.canAnimateLadder)&&this.messagesQueueOnRenderAdditional?.(),this.ejectBubbles();for(const[T,O]of this.bubblesToReplace){if(x&&x.replaceSaved(O,T),!a.find(N=>N.bubble===T))continue;const F=this.bubbleGroups.getItemByBubble(T);F?(F.mounted=!1,m.includes(F.group)||m.push(F.group)):this.log.error("NO ITEM BY BUBBLE",T),this.bubblesToReplace.delete(T)}this.chat.selection.isSelecting&&a.forEach(({bubble:T})=>{this.chat.selection.toggleElementCheckbox(T,!0)}),a.forEach(({message:T,bubble:O,updatePosition:F})=>{if(T.pFlags.local&&F){this.chatInner[T.pFlags.sponsored?"append":"prepend"](O);return}}),this.bubbleGroups.mountUnmountGroups(m),this.updatePlaceholderPosition?.(),A?.(),r(js(this.chat.setPeerPromise?1e3:0)).then(()=>r(xs())).then(()=>{this.lazyLoadQueue.setAllSeen()}).catch(qt)},this.onDatePick=n=>{const a=this.peerId;this.managers.appMessagesManager.requestHistory({...this.chat.requestHistoryOptionsPart,offsetId:0,limit:2,addOffset:-1,offsetDate:n}).then(r=>{if(r?.messages?.length){if(this.peerId!==a)return}else{this.log.error("no history!");return}this.chat.setMessageId({lastMsgId:r.messages[0].mid})})},this.log=this.chat.log,this.listenerSetter=new Qt,this.constructBubbles(),this.batchProcessor=new Ov({log:this.log,process:this.processBatch,possibleError:Uu}),this.bubbleGroups=new e0(this.chat),this.preloader=new Qi({cancelable:!1}),this.lazyLoadQueue=new ha(void 0,!0),this.lazyLoadQueue.queueId=++qf,this.listenerSetter.add(C)("history_update",async({storageKey:n,sequential:a,message:r})=>{if(this.chat.messagesStorageKey!==n||this.chat.type===Q.Scheduled)return;const{mid:l}=r,c=this.bubbles[l];if(!c||(this.renderNewPromises.size&&await Promise.all(Array.from(this.renderNewPromises)),this.messagesQueuePromise&&await this.messagesQueuePromise,this.bubbles[l]!==c))return;const d=this.bubbleGroups.getItemByBubble(c);if(d){if(d.mid===l)return}else return;if(a){const u=d.group,p=this.bubbleGroups.createItem(c,r),m=this.bubbleGroups.itemsArr.slice();cs(m,d);const g=this.bubbleGroups.findGroupSiblingByItem(p,m);if(u===g?.group||u===this.bubbleGroups.lastGroup&&u.items.length===1&&p.dateTimestamp===d.dateTimestamp||this.peerId===C.myId&&a&&p.dateTimestamp===d.dateTimestamp){this.bubbleGroups.changeBubbleMid(c,l);return}}this.bubbleGroups.removeAndUnmountBubble(c);const{groups:h}=this.groupBubbles([{bubble:c,message:r}]);this.bubbleGroups.mountUnmountGroups(h),this.scrollingToBubble&&this.scrollToEnd()}),this.listenerSetter.add(C)("dialog_flush",({peerId:n})=>{this.peerId===n&&this.deleteMessagesByIds(Object.keys(this.bubbles).map(a=>+a))}),this.listenerSetter.add(C)("message_sent",async n=>{const{storageKey:a,tempId:r,tempMessage:l,mid:c,message:d}=n;if(this.chat.messagesStorageKey!==a)return;const h=this.bubbles,u=h[r];if(u){const y=h[r];h[c]=y,y.dataset.mid=""+c,delete h[r],vs(()=>{const v=+y.dataset.mid;if(h[v]!==y||!y.classList.contains("is-outgoing"))return;y.classList.remove("is-outgoing");let b;y.classList.contains("is-out")&&(b=this.peerId===C.myId&&this.chat.type!==Q.Scheduled||!this.unreadOut.has(v)?"read":"sent"),this.setBubbleSendingStatus(y,b)})}if(this.unreadOut.has(r)&&(this.unreadOut.delete(r),this.unreadOut.add(c)),this.chat.type===Q.Scheduled){const y=Date.now()/1e3|0,v=l.date-10;y>=v&&this.deleteMessagesByIds([c])}if(!u)return;let p,m;const g=d.grouped_id;if(g){p=await this.managers.appMessagesManager.getMessagesByGroupedId(g);const y=p.map(({mid:v})=>v);if(!y.length||Vu(y)!==c||h[c]!==u||h[c]!==u)return;m=Array.from(u.querySelectorAll(".grouped-item")).map(v=>+v.dataset.mid)}else p=[d],m=[r];const f=Array.from(u.querySelectorAll("reactions-element"));f.length&&f.forEach(y=>{y.changeContext(d)}),p.forEach((y,v)=>{if(!y)return;const b=m[v],w=y.mid,S=u.querySelector(`.document-container[data-mid="${w}"]`)||u;if(y._!=="message")return;if(y.replies){const E=u.querySelector("replies-element");E&&(E.message=y,E.init())}const I=y.media??{},L=I.document,M=I.poll,P=I.webpage;if(L){const E=S.querySelector(`.document-container[data-mid="${b}"]`),k=E?.querySelector(".document");k&&!l.media?.document?.thumbs?.length&&L.thumbs?.length&&xs().then(async()=>{const x=k.querySelector(".time"),T=await lc({message:y,fontSize:C.settings.messagesTextSize});k.replaceWith(T),x&&(T.querySelector(".document")||T).append(x)}),E&&(E.dataset.mid=""+w);const A=S.querySelector(`audio-element[data-mid="${b}"], .document[data-doc-id="${b}"], .media-round[data-mid="${b}"]`);A&&(A instanceof tg||A.classList.contains("media-round")?(A.dataset.mid=""+y.mid,delete A.dataset.isOutgoing,A.message=y,A.onLoad(!0)):(A.dataset.docId=""+L.id,A.doc=L))}else if(M){const E=S.querySelector("poll-element");E&&(E.message=y,E.setAttribute("poll-id",""+M.id),E.setAttribute("message-id",""+w))}else P&&!S.querySelector(".web")&&xs().then(()=>{this.safeRenderMessage({message:y,reverse:!0,bubble:S}),this.scrollToBubbleIfLast(S)});if(g){const E=S.querySelector(`.grouped-item[data-mid="${b}"]`)||S;E&&(E.dataset.mid=""+w)}})}),this.listenerSetter.add(C)("message_edit",async({storageKey:n,message:a})=>{if(n!==this.chat.messagesStorageKey)return;const r=this.bubbles[a.mid];if(!r||(await xs(),this.bubbles[a.mid]!==r))return;const l=this.updateLocationOnEdit.get(r);if(l){l(a);return}r.querySelector(".geo-container")||this.safeRenderMessage({message:a,reverse:!0,bubble:r})}),this.listenerSetter.add(C)("message_error",async({storageKey:n,tempId:a})=>{if(n!==this.chat.messagesStorageKey)return;const r=this.bubbles[a];r&&(await xs(),this.bubbles[a]===r&&(r.classList.remove("is-outgoing"),this.setBubbleSendingStatus(r,"error")))}),this.listenerSetter.add(C)("message_transcribed",({peerId:n,mid:a,text:r,pending:l})=>{if(n!==this.peerId)return;const c=this.bubbles[a];if(!c)return;const d=c.querySelector("audio-element");if(!d)return;const h=c.querySelector(".document-wrapper, .quote-text.has-document"),u=d.querySelector(".audio-to-text-button span"),p=d.querySelector(".loader");if(h&&u){let m=h.querySelector(".audio-transcribed-text");if(m)l||m.querySelector(".audio-transcribing-dots")?.remove();else if(m=document.createElement("div"),m.classList.add("audio-transcribed-text"),m.append(document.createTextNode("")),h.classList.contains("document-wrapper")?d.before(m):h.append(m),l){const g=document.createElement("span");g.classList.add("audio-transcribing-dots"),m.append(g)}!r&&!l?(m.replaceChildren(_("Chat.Voice.Transribe.Error")),m.classList.add("is-error")):r&&(m.firstChild.textContent=r),u.classList.remove(sa("transcribe")),u.classList.add(sa("up")),!l&&p&&(p.classList.remove("active"),setTimeout(()=>{p.remove()},300)),d.transcriptionState=2}}),this.listenerSetter.add(C)("grouped_edit",({peerId:n,messages:a,deletedMids:r})=>{if(n!==this.peerId)return;const l=a.map(({mid:m})=>m),c=l.concat(Array.from(r)),d=Vu(c),h=this.bubbles[d];if(!h)return;delete this.bubbles[d];const u=Vu(l),p=a.find(m=>m.mid===u);this.safeRenderMessage({message:p,reverse:!0,bubble:h})}),this.listenerSetter.add(C)("messages_reactions",async n=>{if(this.chat.type===Q.Scheduled)return;let a;const r=n.map(async({message:c,changedResults:d})=>{if(this.peerId!==c.peerId&&!Hu)return;const h=await this.getMountedBubble(c.mid,c);if(h)return{bubble:U(h.bubble,"bubble"),message:c,changedResults:d}}),l=Rt();(await Promise.all(r)).filter(Boolean).forEach(({bubble:c,message:d,changedResults:h})=>{a||(a=this.createScrollSaver(!1),a.save()),c.dataset.ignoreReactions&&(delete c.dataset.ignoreReactions,h=[]);const u=d.peerId+"_"+d.mid,p=so.get(u);if(p)for(const m of p)m.update(d,h,l);else{if(!d.reactions||!d.reactions.results.length)return;this.appendReactionsElementToBubble(c,d,d,h)}}),a?.restore(),l.resolve()});const s=async n=>{const a=this.getMiddleware();if(await xs(),!a())return;const r=[],l=n.peerId,c=n.mids||n.ids,d=this.needUpdate,h=n.mids?"replyMid":"replyStoryId",u=c.map(m=>{const g=[];ii(d,(y,v)=>{y[h]===m&&(y.replyToPeerId===l||!l)&&(d.splice(v,1)[0],g.push(y))});const f=g.map(async({mid:y,replyMid:v,replyToPeerId:b})=>{const w=this.bubbles[y];if(!w)return;const[S,I]=await Promise.all([this.chat.getMessage(y),v&&this.managers.appMessagesManager.getMessageByPeer(b,v)]);r.push(async()=>{const L=nr.setReply({chat:this.chat,bubble:w,message:S,middleware:w.middlewareHelper.get(),lazyLoadQueue:this.lazyLoadQueue,needUpdate:this.needUpdate,isStandaloneMedia:w.classList.contains("just-media"),isOut:w.classList.contains("is-out")});if(!I)return L;await L;let M;const P=w.querySelectorAll(".timestamp");(M=Bd(I))&&P.forEach(E=>{+E.dataset.timestamp<M?E.classList.remove("is-disabled"):E.removeAttribute("href")})})});return Promise.all(f)});if(await Promise.all(u),!a()||!r.length)return;const p=this.createScrollSaver(!0);p.save(),await Promise.all(r.map(m=>m())),p.restore()};this.listenerSetter.add(C)("messages_downloaded",s),this.listenerSetter.add(C)("stories_downloaded",s),Ko({listenTo:this.scrollable.container,listenerSetter:this.listenerSetter,findTarget:n=>{const a=n.target;return a.closest(".attachment.media-sticker-wrapper")||U(a,"attachment")&&a.closest(".custom-emoji")}}),D(this.scrollable.container,this.onBubblesClick,{listenerSetter:this.listenerSetter}),this.listenerSetter.add(this.scrollable.container)("mousedown",n=>{if(n.button!==0)return;const a=U(n.target,"code-header")&&U(n.target,"code"),r=a?.querySelector(".code-code")||U(n.target,"monospace-text");if(r){const l=!!U(n.target,"code-header-toggle-wrap");X(n),l||u0(r);const d=D(window,h=>{if(X(h),l){const u=a.classList.toggle("is-scrollable");r.classList.toggle("no-scrollbar",u);return}Re({langPackKey:"CodeCopied",onClose:()=>{d()}})},{listenerSetter:this.listenerSetter,once:!0,capture:!0,ignoreMove:!0});return}}),this.stickyIntersector=new yb(this.scrollable.container,(n,a)=>{for(const r in this.dateMessages){const l=this.dateMessages[r];if(l.container===a){const c=l.div;c.classList.toggle("is-sticky",n),n&&(this.previousStickyDate=c);break}}this.previousStickyDate}),WE||(this.sliceViewportDebounced=Zs(this.sliceViewport.bind(this),3e3,!1,!0));let i;dm(()=>{this.isHeavyAnimationInProgress=!0,this.lazyLoadQueue.lock(),i=this.getMiddleware()},()=>{this.isHeavyAnimationInProgress=!1,i?.()&&this.lazyLoadQueue.unlockAndRefresh(),i=null},this.listenerSetter)}constructBubbles(){const e=this.container=document.createElement("div");e.classList.add("bubbles","scrolled-down"),(this.chatInner=document.createElement("div")).classList.add("bubbles-inner");const s=document.createElement("div");s.classList.add("bubbles-remover-container");const i=this.remover=document.createElement("div");i.classList.add("bubbles-remover","bubbles-inner"),s.append(i),this.setScroll(),e.append(s,this.scrollable.container)}attachContainerListeners(){const e=this.container;if(this.chat.contextMenu.attachTo(e),this.chat.selection.attachListeners(e,new Qt),ki&&this.listenerSetter.add(e)("dblclick",t=>{const s=U(t.target,"grouped-item")||U(t.target,"bubble");if(s){const i=+s.dataset.mid;this.log("debug message:",this.chat.getMessage(i)),this.highlightBubble(s)}}),!mi&&!$E)this.listenerSetter.add(e)("dblclick",async t=>{if(this.chat.type===Q.Pinned||this.chat.selection.isSelecting||!this.chat.input.canSendPlain()||U(t.target,"attachment")||U(t.target,"audio")||U(t.target,"document")||U(t.target,"contact")||U(t.target,"time"))return;const s=t.target;let i=s.classList.contains("bubble")?s:s.classList.contains("document-selection")?s.parentElement:null;const n=cw();if(!i&&(!n.trim()||/^\s/.test(n))&&(i=U(s,"bubble")),i&&!i.classList.contains("bubble-first")){const a=+i.dataset.mid,r=this.chat.getMessage(a);if(r.pFlags.is_outgoing||r.peerId!==this.peerId)return;this.chat.input.initMessageReply({replyToMsgId:a})}});else if(Ye){const t="is-gesturing-reply";let n=!1,a,r,l;this.replySwipeHandler=Db({element:e,verifyTouchTarget:async c=>{if(this.chat.type===Q.Pinned||this.chat.selection.isSelecting||!await this.chat.canSend()||(a=U(c.target,"bubble"),!a||a.classList.contains("service")||a.classList.contains("is-sending")))return!1;if(a){try{const d=a.parentElement.querySelector(".bubbles-group-avatar");d&&Fr(d,a)&&(l=d)}catch{}[a,l].filter(Boolean).forEach(d=>{vt({element:d,className:t,forwards:!0,duration:250}),d.offsetLeft}),r?(r.classList.remove("is-visible"),r.style.opacity=""):r=Le("reply_filled","bubble-gesture-reply-icon"),a.append(r)}return!!a},onSwipe:c=>{n=c>=48,n&&!r.classList.contains("is-visible")&&r.classList.add("is-visible"),r.style.opacity=""+Math.min(1,c/48);const h=`translateX(${-Math.max(0,Math.min(64,c))}px)`;a.style.transform=h,l&&(l.style.transform=h),kv()},onReset:()=>{const c=a,d=l;a=l=void 0;const h=()=>{r.parentElement===c&&(r.classList.remove("is-visible"),r.remove())};[c,d].filter(Boolean).forEach((u,p)=>{vt({element:u,className:t,forwards:!1,duration:250,onTransitionEnd:p===0?h:void 0})}),vs(()=>{if(c.style.transform="",d&&(d.style.transform=""),n){const{mid:u}=c.dataset;this.chat.input.initMessageReply({replyToMsgId:+u}),n=!1}})},listenerOptions:{capture:!0}})}}constructPeerHelpers(){this.listenerSetter.add(C)("history_append",async({storageKey:s,message:i})=>{s!==this.chat.messagesStorageKey||this.chat.type===Q.Scheduled||(et.isAvailable("chat_background")&&(this.updateGradient=!0),!(this.chat.threadId&&Un(i,this.chat.isForum)!==this.chat.threadId)&&(this.scrollable.loadedAll.bottom?this.renderNewMessage(i,!0):this.chat.setMessageId()))}),this.listenerSetter.add(C)("history_multiappend",s=>{this.peerId!==s.peerId||this.chat.type===Q.Scheduled||this.renderNewMessage(s)}),this.listenerSetter.add(C)("history_delete",({peerId:s,msgs:i})=>{s!==this.peerId&&!Hu||this.chat.type===Q.Scheduled||this.deleteMessagesByIds([...i.keys()])}),this.listenerSetter.add(C)("history_delete_key",({historyKey:s,mid:i})=>{this.chat.historyStorageKey===s&&this.deleteMessagesByIds([i])}),this.listenerSetter.add(C)("dialog_unread",({peerId:s})=>{s===this.peerId&&(this.chat.input.setUnreadCount(),xs().then(()=>{this.updateUnreadByDialog()}))}),this.listenerSetter.add(C)("dialogs_multiupdate",s=>{!s.has(this.peerId)||this.chat.type===Q.Scheduled||this.chat.type===Q.Saved||this.chat.input.setUnreadCount()}),this.listenerSetter.add(C)("dialog_notify_settings",s=>{this.peerId!==s.peerId||this.chat.type===Q.Scheduled||this.chat.type===Q.Saved||this.chat.input.setUnreadCount()});const e=async()=>{(await Promise.all([this.finishPeerChange(),this.chat.input.finishPeerChange({peerId:this.peerId,middleware:this.getMiddleware()})])).forEach(i=>i())};this.listenerSetter.add(C)("user_full_update",async s=>{if(s.toPeerId(!1)!==this.peerId)return;const n=this.getMiddleware(),[a,r]=await Promise.all([this.managers.appProfileManager.isCachedUserBlocked(s),this.chat.isPremiumRequiredToContact()]);if(!n())return;const l=this.chat.isUserBlocked,c=this.chat.isPremiumRequired;let d=!1;(l===void 0?a:l!==a)&&(this.chat.isUserBlocked=a,d=!0),(c===void 0?r:c!==r)&&(this.chat.isPremiumRequired=r,d=!0,this.cleanupPlaceholders(),this.checkIfEmptyPlaceholderNeeded()),d&&e()}),this.listenerSetter.add(C)("chat_update",async s=>{const{peerId:i}=this;if(i!==s.toPeerId(!0))return;const n=this.getMiddleware(),a=fe.getChat(s),r=this.chatInner.classList.contains("has-rights"),l=this.chat.input.canSendPlain(),[c,d,h]=await Promise.all([this.chat.canSend("send_messages"),this.chat.canSend("send_plain"),this.chat.canSend("embed_links")]);n()&&((r!==c||l!==d)&&await e(),n()&&((h&&!this.chat.input.willSendWebPage||!h&&this.chat.input.willSendWebPage)&&(this.chat.input.lastUrl="",this.chat.input.onMessageInput()),!!a.pFlags.forum!==this.chat.isForum&&this.chat.type===Q.Chat&&(this.chat.peerId=0,this.chat.appImManager.setPeer({peerId:i}))))}),this.listenerSetter.add(C)("history_reload",s=>{if(s!==this.peerId)return;const i=Ca(this.bubbles,"desc").filter(a=>a>0&&pC(a,!1)===a),n=this.getMiddleware();this.managers.appMessagesManager.reloadMessages(this.peerId,i).then(a=>{if(!n())return;const r=[];a.forEach((l,c)=>{const d=i[c];if(l){const h=this.bubbles[l.mid];if(!h)return;this.safeRenderMessage({message:l,reverse:!0,bubble:h})}else r.push(d)}),this.deleteMessagesByIds(r),this.setLoaded("top",!1),this.setLoaded("bottom",!1),this.scrollable.checkForTriggers()})}),this.listenerSetter.add(C)("settings_updated",({key:s})=>{s==="settings.emoji.big"&&(this.getMiddleware(),Ca(this.bubbles,"desc").map(a=>{const r=this.bubbles[a];if(r.classList.contains("can-have-big-emoji"))return{bubble:r,message:this.chat.getMessage(a)}}).filter(Boolean).forEach(({bubble:a,message:r})=>{this.bubbles[r.mid]===a&&this.safeRenderMessage({message:r,reverse:!0,bubble:a})}))}),this.listenerSetter.add(C)("messages_views",s=>{this.chat.type!==Q.Scheduled&&vs(()=>{let i;for(const{peerId:n,views:a,mid:r}of s){if(this.peerId!==n&&!Hu)continue;const l=this.bubbles[r];if(!l)continue;const c=Array.from(l.querySelectorAll(".post-views"));if(!c.length)continue;const d=Ri(a,1);let h=!1;c.forEach(u=>{(h||u.textContent!==d)&&(i||(i=this.createScrollSaver(!0),i.save()),h=!0,u.textContent=d)})}i?.restore()})}),this.observer=new h0({root:this.scrollable.container}),this.sendViewCountersDebounced=Zs(()=>{const s=[...this.viewsMids];this.viewsMids.clear(),this.managers.appMessagesManager.incrementMessageViews(this.peerId,s)},1e3,!1,!0),this.listenerSetter.add(C)("peer_pinned_messages",({peerId:s,mids:i,pinned:n})=>{this.chat.type!==Q.Pinned||s!==this.peerId||i&&(n||this.deleteMessagesByIds(i))});const t=async()=>{this.chat.topbar.setTitle((await this.managers.appMessagesManager.getScheduledMessagesStorage(this.peerId)).size)};this.listenerSetter.add(C)("scheduled_new",s=>{this.chat.type!==Q.Scheduled||s.peerId!==this.peerId||(this.renderNewMessage(s),t())}),this.listenerSetter.add(C)("scheduled_delete",({peerId:s,mids:i})=>{this.chat.type!==Q.Scheduled||s!==this.peerId||(this.deleteMessagesByIds(i),t())})}get peerId(){return this.chat.peerId}get messagesQueuePromise(){return this.batchProcessor.queuePromise}createScrollSaver(e=!0){return new Wh(this.scrollable,".bubble:not(.is-date)",e)}createResizeObserver(){if(!("ResizeObserver"in window)||this.resizeObserver)return;const e=this.scrollable.container;let t=0,s=!1,i=!1,n=0,a=0;const r=()=>{const h=e.offsetHeight,u=this.scrollable.isScrolledToEnd;h!==t&&(!i||!u)&&(n+=t-h),n&&this.scrollable.setScrollPositionSilently(this.scrollable.scrollPosition+Math.round(n)),t=h,a=0,n=0,s=!1,i=!1},l=h=>{a&&window.cancelAnimationFrame(a),a=window.requestAnimationFrame(h?r:()=>{a=window.requestAnimationFrame(r)})},c=h=>{if(i){l(!1);return}const p=h[0].contentRect.height;if(!t){t=p;return}const m=t-p;let g=m+n;const f=g%1;if(g-=f,!s&&(s=!0,m<0&&this.scrollable.isScrolledToEnd)){n=-m,i=!0,l(!1);return}if(g){const y=this.scrollable.scrollPosition+g;this.scrollable.setScrollPositionSilently(y)}l(!1),n=f,t=p};(this.resizeObserver=new ResizeObserver(c)).observe(e)}destroyResizeObserver(){const e=this.resizeObserver;e&&(e.disconnect(),this.resizeObserver=void 0)}setReactionsHoverListeners(){this.listenerSetter.add($s)("toggle",this.unhoverPrevious),this.listenerSetter.add(hi)("change",this.unhoverPrevious),this.listenerSetter.add(this.chat.selection)("toggle",this.unhoverPrevious),this.listenerSetter.add(this.container)("mousemove",this.onBubblesMouseMove)}setHoverVisible(e,t){e.parentElement&&e.parentElement.classList.toggle("hover-reaction-visible",t),vt({element:e,className:"is-visible",forwards:t,duration:200,onTransitionEnd:t?void 0:()=>{e.remove(),e.middlewareHelper.destroy()},useRafs:t?2:0})}setStickyDateManually(){}getRenderedLength(){return Object.keys(this.bubbles).length-this.skippedMids.size}onUnreadedInViewport(e,t){this.unreadedSeen.add(t),this.observer.unobserve(e,this.unreadedObserverCallback),this.unreaded.delete(e),this.readUnreaded()}readUnreaded(){if(this.readPromise)return;const e=this.getMiddleware();this.readPromise=aa.getFocusPromise().then(async()=>{if(!e())return;const{peerId:t,threadId:s}=this.chat;let i=Math.max(...Array.from(this.unreadedSeen));if(this.scrollable.loadedAll.bottom){const r=Math.max(...Object.keys(this.bubbles).map(l=>+l));if(i>=r&&(i=Math.max(await this.chat.getHistoryMaxId()||0,i),!e()))return}this.unreaded.forEach((r,l)=>{r<=i&&this.onUnreadedInViewport(l,r)});const n=[];for(const r of this.unreadedSeen){const l=this.chat.getMessage(r);Df(l)&&n.push(r)}return this.managers.appMessagesManager.readMessages(t,n),this.unreadedSeen.clear(),ki&&this.log("will readHistory by maxId:",i),this.managers.appMessagesManager.readHistory(t,i,s).catch(r=>{this.log.error("readHistory err:",r),this.managers.appMessagesManager.readHistory(t,i,s)}).finally(()=>{e()&&(this.readPromise=void 0,this.unreadedSeen.size&&this.readUnreaded())})})}async checkTargetForMediaViewer(e,t,s){const i=U(e,"bubble"),n=U(e,"document-with-thumb");if(e.tagName==="IMG"&&!e.classList.contains("emoji")&&!e.classList.contains("document-thumb")||e.classList.contains("album-item")||e.classList.contains("album-item-media")||e.tagName==="VIDEO"&&!i.classList.contains("round")||n&&!n.querySelector(".preloader-container")||e.classList.contains("canvas-thumbnail")){const a=U(e,"album-item")||U(e,"document-container"),r=(a||i).querySelector(".preloader-container");if(r&&t){hs(r),X(t);return}X(t);const l=+(a||i).dataset.mid,c=this.chat.getMessage(l);if(!c){this.log.warn("no message by messageId:",l);return}if(i.classList.contains("story")){const f=kd(e,"data-story-peer-id"),y=f.dataset.storyPeerId.toPeerId(),v=+f.dataset.storyId;Da({target:()=>f.querySelector(".media-container-aspecter")||e,peerId:y,id:v});return}const d="has-webpage",h=i.classList.contains(d),u=n?f=>Oo.isMediaCompatibleForDocumentViewer(f):f=>f._==="photo"||["video","gif"].includes(f.type),p=[],m=h?[l]:Object.keys(this.bubbles).map(f=>+f).map(f=>{const y=this.bubbles[f];if(!h&&y.classList.contains(d))return;const v=this.chat.getMessage(f),b=Hs(v);return b&&u(b)&&f}).filter(Boolean).sort((f,y)=>f-y);m.forEach(f=>{let y=this.skippedMids.has(f)?void 0:this.bubbles[f];if(y||(y=this.chatInner.querySelector(`.grouped-item:not(.album-item)[data-mid="${f}"]`),y&&(y=U(y,"bubble"))),!y)return;let v;if(n)v=".document-container";else{const S=y.classList.contains("with-media-tail");v=".album-item, .webpage-preview, ",S?v+=".bubble__media-container":v+=".attachment"}const b=Array.from(y.querySelectorAll(v)),w=new Set;if(n)b.forEach(S=>{p.push({element:S.querySelector(".document-ico"),mid:+S.dataset.mid,peerId:this.peerId})});else{const S=!!y.querySelector(".media-container-aspecter");b.forEach(I=>{if(I=I.querySelector("video, img")||I,S&&!U(I,"media-container-aspecter"))return;const L=U(I,"album-item"),M=L||I.parentElement;w.has(M)||(w.add(M),p.push({element:I,mid:L?+L.dataset.mid:f,peerId:this.peerId}))})}}),ii(p,(f,y,v)=>{const b=v.findIndex(w=>w.element===f.element);b!==y&&v.splice(b,1)}),p.sort((f,y)=>f.mid-y.mid);const g=p.findIndex(f=>f.mid===l);if(ki&&this.log("open mediaViewer single with ids:",m,g,p),!p[g]){this.log("no target for media viewer!",e);return}return new Oo().setSearchContext({threadId:this.chat.threadId,peerId:this.peerId,inputFilter:{_:n?"inputMessagesFilterDocument":"inputMessagesFilterPhotoVideo"},useSearch:this.chat.type!==Q.Scheduled&&!h,isScheduled:this.chat.type===Q.Scheduled}).openMedia({message:c,target:p[g].element,fromRight:0,reverse:!0,prevTargets:p.slice(0,g),nextTargets:p.slice(g+1),mediaTimestamp:s}),!0}}async onGoDownClick(){if(!this.followStack.length){this.chat.setMessageId();return}const e=this.getMiddleware(),t=this.followStack.slice(),s=await Promise.all(t.map(n=>this.chat.getMessage(n)));if(!e())return;t.forEach((n,a)=>{const r=s[a],l=this.bubbles[n];let c=!0;if(l){const d=l.getBoundingClientRect();c=nt.height/2>d.top}else r&&(c=!1);c&&this.followStack.splice(this.followStack.indexOf(n),1)}),this.followStack.sort((n,a)=>a-n);const i=this.followStack.pop();this.chat.setMessageId({lastMsgId:i})}getBubbleByPoint(e){const t=this.getViewportSlice();return t.visible[e==="top"?0:t.visible.length-1]?.element}async getGroupedBubble(e){const t=await this.managers.appMessagesManager.getMidsByGroupedId(e);for(const s of t)if(this.bubbles[s]&&!this.skippedMids.has(s))return{bubble:this.bubbles[s],mid:s}}getBubbleGroupedItems(e){return Array.from(e.querySelectorAll(".grouped-item"))}async getMountedBubble(e,t){if(t===void 0&&(t=this.chat.getMessage(e)),!t)return;const s=t.grouped_id;if(s){const n=await this.getGroupedBubble(s);if(n)return n.bubble=n.bubble.querySelector(`.document-container[data-mid="${e}"]`)||n.bubble,n}const i=this.bubbles[e];if(!(!i||this.skippedMids.has(e)))return{bubble:i,mid:e}}findNextMountedBubbleByMsgId(e,t){const s=Ca(this.bubbles,t?"desc":"asc");let i;t?i=a=>a<e:i=a=>e<a;const n=s.find(a=>i(a)?!!this.bubbles[a]?.parentElement:!1);return this.bubbles[n]}loadMoreHistory(e,t=!1){if(!this.peerId||this.chat.setPeerPromise||this.isHeavyAnimationInProgress||e&&(this.getHistoryTopPromise||this.scrollable.loadedAll.top)||!e&&(this.getHistoryBottomPromise||this.scrollable.loadedAll.bottom))return;const s=Object.keys(this.bubbles).map(i=>+i).filter(i=>i>0&&!this.skippedMids.has(i)).sort((i,n)=>i-n);s.length||s.push(0),e?(ki&&this.log("Will load more (up) history by id:",s[0],"maxId:",s[s.length-1],t),this.getHistory1(s[0],!0,void 0,void 0,t)):(ki&&this.log("Will load more (down) history by id:",s[s.length-1],t),this.getHistory1(s[s.length-1],!1,!0,void 0,t))}setScroll(){this.scrollable&&this.destroyScrollable(),this.scrollable=new Ys(null,"IM",300),this.setLoaded("top",!1,!1),this.setLoaded("bottom",!1,!1),this.scrollable.container.append(this.chatInner),this.scrollable.onAdditionalScroll=this.onScroll,this.scrollable.onScrolledTop=()=>this.loadMoreHistory(!0),this.scrollable.onScrolledBottom=()=>this.loadMoreHistory(!1),Ye}async updateUnreadByDialog(){const e=await this.chat.getHistoryStorage(),t=this.peerId===C.myId?e.readMaxId:e.readOutboxMaxId;for(const s of this.unreadOut)if(s>0&&s<=t){const i=this.bubbles[s];if(i){if(this.unreadOut.delete(s),i.classList.contains("is-outgoing")||i.classList.contains("is-error"))continue;this.setBubbleSendingStatus(i,"read")}}}destroyBubble(e,t=+e.dataset.mid,s){let i,n,a,r;if(s&&e.isConnected){const c=[".bubbles-date-group",".bubbles-group",".bubble"];n=[e,...DE(e,c[0])].map((d,h,u)=>{const p=u.length,m=c.slice(0,p-h),g=Array.from(u[p-1].parentElement.querySelectorAll(m.join(" "))),f=g[g.indexOf(d)-1];return{element:d,parentElement:d.parentElement,index:ui(d,!1),rect:d.getBoundingClientRect(),previousElement:d.previousElementSibling,marginBottom:parseInt(window.getComputedStyle(d).marginBottom),previousSameKindElement:f}}),r=this.setTopPadding(),a=this.scrollable.scrollSize,i=document.createElement("div"),i.classList.add("bubble-delete-placeholder")}this.bubbles[t]===e&&delete this.bubbles[t],this.skippedMids.delete(t),this.firstUnreadBubble===e&&(this.firstUnreadBubble=null);const l=n&&this.createScrollSaver(!1);if(l?.save(),this.bubbleGroups.removeAndUnmountBubble(e),this.observer&&(this.observer.unobserve(e,this.unreadedObserverCallback),this.unreaded.delete(e),this.observer.unobserve(e,this.viewsObserverCallback),this.viewsMids.delete(t),this.observer.unobserve(e,this.stickerEffectObserverCallback)),n){let c;n.forEach(S=>{S.element.parentElement||(c=S)});const d=a-this.scrollable.scrollSize,h=c===n[0],u=e.classList.contains("is-group-last"),p=e.classList.contains("is-group-first");i.style.cssText=`width: 100%; height: ${d}px;`,c.element.style.cssText=`position: absolute; z-index: 0; left: 0; right: 0; top: ${c.rect.top-56}px; height: ${c.rect.height}px;`,this.remover.append(c.element),n.forEach(S=>{S.element.parentElement||ws(S.element,S.parentElement,S.index,-1)}),c.previousElement&&!c.previousElement.parentElement&&n[0].previousSameKindElement?n[0].previousSameKindElement.after(i):ws(i,c.parentElement,c.index,-1),l.restore(),l.save();const m={duration:300,fill:"forwards",easing:"cubic-bezier(.4, .0, .2, 1)"},g=h&&u&&!p&&c.parentElement.querySelector(".bubbles-group-avatar"),f=i.animate([{height:"0.01px",marginBottom:"0px"}],m),y=c.element.animate([{opacity:0}],m),v=g?g.animate([{transform:`translateY(-${c.marginBottom}px)`},{transform:`translateY(-${c.marginBottom}px)`}],m):void 0,b=[f,y,v].filter(Boolean).map(S=>S.finished),w=Promise.all(b).then(()=>{i.remove(),c.element.remove(),v?.cancel(),e.middlewareHelper.destroy(),xs().then(()=>{r.unsetPadding?.()})});this.animateSomethingWithScroll(w,l)}else e.middlewareHelper.destroy()}animateSomethingWithScroll(e,t){t||(t=this.createScrollSaver(!0),t.save());let s=!1;e.then(()=>{s=!0}),wr(e),t&&la(()=>s?!1:(t.restore(),!0),this.scrollable.container)}deleteMessagesByIds(e,t=!0,s){let i=!1;e.slice().sort((n,a)=>a-n).forEach(n=>{const a=this.bubbles[n];a&&(this.destroyBubble(a,n,t&&et.isAvailable("animations")),i=!0)}),i&&(this.scrollable.ignoreNextScrollEvent(),t&&this.chat.selection.isSelecting&&this.chat.selection.deleteSelectedMids(this.peerId,e),ut.checkAnimations(!1,this.chat.animationGroup),this.deleteEmptyDateGroups(),s||this.scrollable.onScroll())}pollExtendedMediaMessages(){const e=Array.from(this.extendedMediaMessages);return this.managers.appMessagesManager.getExtendedMedia(this.peerId,e)}setExtendedMediaMessagesPollInterval(){this.pollExtendedMediaMessagesPromise||!this.extendedMediaMessages.size||(this.pollExtendedMediaMessagesPromise=js(3e4).then(()=>this.pollExtendedMediaMessages()).then(()=>this.setExtendedMediaMessagesPollInterval()))}setTopPadding(e=this.getMiddleware()){let t=!1,s;if(!this.isTopPaddingSet&&this.chat.type!==Q.Scheduled){const{clientHeight:i,scrollHeight:n}=this.scrollable.container;t=i===n,t&&(s=this.chatInner,s.style.paddingTop=i+"px",this.scrollable.setScrollPositionSilently(n),this.isTopPaddingSet=!0)}return{isPaddingNeeded:t,unsetPadding:t?()=>{e()&&(s.style.paddingTop="",this.isTopPaddingSet=!1)}:void 0}}renderNewMessage(e,t){const s=this._renderNewMessage(e,t);return this.renderNewPromises.add(s),s.catch(qt).finally(()=>{this.renderNewPromises.delete(s)}),s}async _renderNewMessage(e,t){if(!this.scrollable.loadedAll.bottom){const l=this.chat.setPeerPromise;if(l){const c=this.getMiddleware();l.then(()=>{if(!c())return;const d=this.chat.getMessage(e.mid);this.renderNewMessage(d)})}return}if(this.chat.threadId&&Un(e,this.chat.isForum)!==this.chat.threadId)return;const{savedReaction:s}=this.chat;if(s?.length){const{reactions:l}=e;if(!(l?.results&&s.every(d=>l.results.some(h=>Ai(h.reaction,d)))))return}if(this.bubbles[e.mid])return;t||(t=this.scrolledDown&&(!this.scrollingToBubble||this.scrollingToBubble===this.getLastBubble()||this.scrollingToBubble===this.chatInner));const i=this.getMiddleware(),{isPaddingNeeded:n,unsetPadding:a}=this.setTopPadding(i),r=this.performHistoryResult({history:[e]},!1);return t&&r.then(()=>{if(!i())return;let l;this.chat.type===Q.Scheduled&&(l=this.bubbles[e.mid]);const c=l?this.scrollToBubbleEnd(l):this.scrollToEnd();n&&c.then(a)}),r}getLastBubble(){return this.bubbleGroups.lastGroup?.lastItem?.bubble}scrollToBubble(e,t,s,i){const n=U(e,"bubble");e.parentElement||this.log.error("element is not connected",n);let a;if(n&&t!=="end"){const d=this.bubbleGroups.getItemByBubble(n);d&&d.group.firstItem===d&&ui(d.group.container)===(this.stickyIntersector?hw:1)&&(a=d.group.container.parentElement)}const r=4,l=this.chat.input.messageInput&&this.chat.input.messageInput.classList.contains("is-changing-height")||this.chat.container.classList.contains("is-toggling-helper"),c=this.scrollable.scrollIntoViewNew({element:e,position:t,margin:r,forceDirection:s,forceDuration:i,axis:"y",getNormalSize:l?({rect:d})=>{let h=nt.height;return h-=this.container.offsetTop,h-=Fe.isMobile||nt.height<570?58:78,h}:void 0,fallbackToElementStartWhenCentering:a,startCallback:d=>{if(this.onScroll(!0,d),this.updateGradient){const{gradientRenderer:h}=this.chat;h?.toNextPosition(d.getProgress),this.updateGradient=void 0}}});return s===Hd.Static&&(this.scrollable.lastScrollPosition=this.scrollable.scrollPosition),c}scrollToEnd(){return this.scrollToBubbleEnd(this.chatInner)}async scrollToBubbleEnd(e){if(e){this.scrollingToBubble=e;const t=this.getMiddleware();if(await this.scrollToBubble(e,"end",void 0,void 0),!t())return;this.scrollingToBubble=void 0}}async scrollToBubbleIfLast(e){if(this.getLastBubble()===e)return this.scrollToEnd()}highlightBubble(e){const t="highlightTimeout";e.dataset[t]&&(clearTimeout(+e.dataset[t]),e.classList.remove("is-highlighted"),e.offsetWidth),e.classList.add("is-highlighted"),e.dataset[t]=""+setTimeout(()=>{e.classList.remove("is-highlighted"),delete e.dataset[t]},2e3)}createDateBubble(e,t=new Date(e*1e3)){let s;const i=new Date;i.setHours(0,0,0,0);const n=this.chat.type===Q.Scheduled;i.getTime()===t.getTime()?s=_(n?"Chat.Date.ScheduledForToday":"Date.Today"):n&&e===Vl?s=_("MessageScheduledUntilOnline"):(s=Gy(t,i),n&&(s=_("Chat.Date.ScheduledFor",[s])));const a=document.createElement("div");a.className="bubble service is-date";const r=document.createElement("div");r.classList.add("bubble-content");const l=document.createElement("div");return l.classList.add("service-msg"),l.append(s),r.append(l),a.append(r),a}getDateForDateContainer(e){const t=new Date(e*1e3);return e!==Vl&&t.setHours(0,0,0),{date:t,dateTimestamp:t.getTime()}}getDateContainerByTimestamp(e){const{date:t,dateTimestamp:s}=this.getDateForDateContainer(e);let i=this.dateMessages[s];if(i)return i;const n=this.createDateBubble(e,t),a=this.createDateBubble(e,t);a.classList.add("is-fake");const r=document.createElement("section");r.className="bubbles-date-group",r.append(n,a),i=this.dateMessages[s]={div:n,container:r,firstTimestamp:t.getTime(),groupsLength:0};const l=Ca(this.dateMessages,"asc"),c=l.length;let d=0,h;for(;d<l.length;++d){const u=l[d];if(h=this.dateMessages[u].container,s<u)break}return d===c&&h&&(h=h.nextElementSibling),h?this.chatInner.insertBefore(r,h):this.chatInner.append(r),this.stickyIntersector?.observeStickyHeaderChanges(r),this.chatInner.parentElement&&this.container.classList.add("has-groups"),i}destroyScrollable(){this.scrollable.destroy()}destroy(){this.destroyScrollable(),this.listenerSetter.removeAll(),this.lazyLoadQueue.clear(),this.observer&&this.observer.disconnect(),this.stickyIntersector&&this.stickyIntersector.disconnect(),delete this.lazyLoadQueue,this.observer&&delete this.observer,this.stickyIntersector&&delete this.stickyIntersector}cleanup(e=!1){this.log("cleanup"),this.bubbles={},this.setLoaded("top",!1,!1),this.setLoaded("bottom",!1,!1),cm(this.scrollable.container),qS(),this.skippedMids.clear(),this.dateMessages={},this.bubbleGroups.cleanup(),this.unreadOut.clear(),this.needUpdate=[],this.lazyLoadQueue.clear(),this.renderNewPromises.clear(),e&&(this.scrollable.replaceChildren(),this.chatInner.replaceChildren(),this.cleanupPlaceholders()),this.firstUnreadBubble=null,this.attachedUnreadBubble=!1,this.batchProcessor.clear(),this.getHistoryTopPromise=this.getHistoryBottomPromise=void 0,this.fetchNewPromise=void 0,this.getSponsoredMessagePromise=void 0,this.updateGradient=void 0,this.stickyIntersector&&this.stickyIntersector.disconnect(),this.observer&&(this.observer.disconnect(),this.unreaded.clear(),this.unreadedSeen.clear(),this.readPromise=void 0,this.viewsMids.clear()),this.middlewareHelper.clean(),this.onAnimateLadder=void 0,this.resolveLadderAnimation=void 0,this.attachPlaceholderOnRender=void 0,this.emptyPlaceholderBubble=void 0,this.sponsoredMessage=void 0,this.previousStickyDate=void 0,this.scrollingToBubble=void 0,this.isTopPaddingSet=!1,this.renderingMessages.clear(),this.bubblesToEject.clear(),this.bubblesToReplace.clear(),this.isScrollingTimeout&&(clearTimeout(this.isScrollingTimeout),this.isScrollingTimeout=0),this.container.classList.remove("has-sticky-dates"),this.scrollable.cancelMeasure()}cleanupPlaceholders(e=this.emptyPlaceholderBubble){e&&this.destroyBubble(e)}tryToForceStartParam(e){const t=this.chat.input.startParam;t!==void 0&&this.chat.isStartButtonNeeded().then(s=>{!e()||s||this.chat.input.startParam!==t||this.chat.input.startBot()})}async setPeer(e){const{samePeer:t,sameReactions:s,peerId:i,stack:n}=e;let{lastMsgId:a,startParam:r}=e;const l=++this.setPeerTempId;if(!i)return this.cleanup(!0),this.preloader.detach(),null;const c=performance.now(),d=this.log.bindPrefix("setPeer");d.warn("start");const h=()=>this.setPeerTempId===l,u=Ir(h,Uu);t||await u(this.chat.onChangePeer(e,u));const p=this.chat.type;(p===Q.Scheduled||this.chat.isRestricted)&&(a=0);const m=await u(this.chat.getHistoryStorage()),g=p===Q.Pinned?await u(this.managers.appMessagesManager.getPinnedMessagesMaxId(i,this.chat.threadId)):m.maxId??0,f=a!==void 0;n&&this.chat.appImManager.clickIfSponsoredMessage(n.message);let y,v=0,b,w;if(!f&&(t||(b=this.chat.appImManager.getChatSavedPosition(this.chat)),!b)){if(g){let z;if(e.savedReaction||([v,z]=await u(Promise.all([this.managers.appMessagesManager.getReadMaxIdIfUnread(i,this.chat.threadId),this.chat.getDialogOrTopic()]))),v&&!t&&(!z||!Dn(z)&&z.unread_count!==1)){const W=m.history.findSliceOffset(v);W&&W.slice.isEnd(Qr.Bottom)&&(w=W.slice[W.offset-25]||W.slice[0]||v),y=!f,a=v}else a=g}}const S=a===g||!a&&!y,I=a!==g;if(S&&a&&(this.chat.getMessage(a)||(this.log("fix going to bottom end without existing message",a),a=0)),r===void 0&&await u(this.chat.isStartButtonNeeded())&&(r=Yy),t&&s){n&&a&&this.followStack.push(n.mid);let W=(await u(this.getMountedBubble(a)))?.bubble;if(!W&&this.skippedMids.has(a)&&(W=this.findNextMountedBubbleByMsgId(a,!1)||this.findNextMountedBubbleByMsgId(a,!0)),W)return f?(this.scrollToBubble(W,"center"),this.highlightBubble(W),this.chat.dispatchEvent("setPeer",a,!1)):g&&!I&&(this.scrollToEnd(),this.chat.dispatchEvent("setPeer",a,!0)),r!==void 0&&(this.chat.input.setStartParam(r),this.tryToForceStartParam(h)),e.mediaTimestamp&&xs().then(()=>{this.playMediaWithTimestampAndMid({lastMsgId:a,middleware:h,mediaTimestamp:e.mediaTimestamp})}),null}else this.peerId&&(this.lazyLoadQueue.queueId=++qf,this.managers.apiFileManager.setQueueId(this.chat.bubbles.lazyLoadQueue.queueId)),this.followStack.length=0,this.passEntities={messageEntityBotCommand:await u(this.managers.appPeersManager.isAnyGroup(i))||this.chat.isBot};ki&&d("setPeer peerId:",i,m,a,g);const L=w??(I||p===Q.Scheduled||this.chat.isRestricted?0:g);let M=0;if(t){const z=this.getBubbleByPoint("bottom");z&&(M=+z.dataset.mid),M<=0&&(M=Math.max(...Object.keys(this.bubbles).map(W=>+W)))}else this.isFirstLoad=!0,this.destroyResizeObserver();const P=this.chatInner,E=this.emptyPlaceholderBubble;this.cleanup();const k=this.chatInner=document.createElement("div");t?(k.className=P.className,k.classList.remove("disable-hover","is-scrolling")):k.classList.add("bubbles-inner"),this.lazyLoadQueue.lock();const A=t&&s,x=A||g&&I||f,T=M>0&&(!a||M<a||a<0),O=!T&&A,F=!O&&T&&A;if(this.willScrollOnLoad=O||F,this.setPeerOptions={lastMsgId:a,topMessage:g,savedPosition:b},!t){this.ranks=void 0,this.processRanks=void 0,this.canShowRanks=!1;let z=this.chat.isMegagroup,W=this.peerId.toChatId();if(this.chat.type===Q.Saved&&!this.chat.threadId.isUser()&&(z=fe.getChat(W=this.chat.threadId.toChatId())?._==="channel"),z){this.canShowRanks=!0;const ue=this.processRanks=new Set,K=this.managers.acknowledged.appProfileManager.getParticipants({id:W,filter:{_:"channelParticipantsAdmins"},limit:100}),ee=await u(K),_e=ee.result.then(ae=>{if(this.processRanks!==ue)return;const re=ae.participants;this.ranks=new Map,re.forEach(Ue=>{const ye=Dm(Ue);this.ranks.set(Ue.user_id.toPeerId(),ye)}),xs().then(()=>{this.processRanks===ue&&(ue.forEach(Ue=>Ue()),this.processRanks=void 0)})},ae=>{ae.type!=="CHAT_ADMIN_REQUIRED"&&this.log.error("ranks error",ae),this.ranks=new Map});ee.cached&&await u(_e)}}let N;b?N={promise:xs().then(()=>this.performHistoryResult({history:b.mids},!0)),cached:!0,waitPromise:Promise.resolve()}:N=await u(this.getHistory1(a,!0,I,L)),this.setPeerCached=N.cached,d.warn("got history");const{promise:G,cached:R}=N,B={peerId:i,isTarget:f,isJump:I,lastMsgId:a,startParam:r,middleware:h};!R&&!t&&(await u(this.chat.finishPeerChange(B)),this.scrollable.replaceChildren(),this.preloader.attach(this.container)),ut.lockGroup(this.chat.animationGroup);const H=u(G).then(async()=>{d.warn("promise fulfilled");const z=x?await u(a?this.getMountedBubble(a):{bubble:this.getLastBubble()}):void 0;R&&!t&&(d.warn("finishing peer change"),await u(this.chat.finishPeerChange(B)),d.warn("finished peer change")),this.preloader.detach(),this.resolveLadderAnimation&&(this.resolveLadderAnimation(),this.resolveLadderAnimation=void 0),this.setPeerCached=void 0;const W=this.scrollable;W.lastScrollDirection=0,W.lastScrollPosition=0,W.replaceChildren(k),E&&this.cleanupPlaceholders(E),this.attachPlaceholderOnRender?.(),!f&&this.chat.isPinnedMessagesNeeded()&&this.chat.topbar.pinnedMessage?.setCorrectIndex(0),this.container.classList.toggle("has-groups",!!Object.keys(this.dateMessages).length),d.warn("mounted chat",this.chatInner===k,this.chatInner.parentElement,performance.now()-c),ut.unlockGroup(this.chat.animationGroup),ut.checkAnimations(!1,this.chat.animationGroup),this.lazyLoadQueue.unlock();const ue=Promise.all([H,xs()]);if(b)W.setScrollPositionSilently(b.top);else if(x){let K;if(O)W.setScrollPositionSilently(99999);else if(F){const re=this.setTopPadding();re.isPaddingNeeded&&(K=re.unsetPadding),W.setScrollPositionSilently(0)}let ee=y&&this.firstUnreadBubble||z?.bubble;const _e=!!ee?.parentElement;_e||(ee=this.findNextMountedBubbleByMsgId(a,!1)||this.findNextMountedBubbleByMsgId(a,!0));let ae;if(ee){const re=this.getLastBubble(),Ue=y?"start":!I&&!f&&re===ee?"end":"center";Ue==="end"&&re===ee&&t?ae=this.scrollToEnd():ae=this.scrollToBubble(ee,Ue,t?void 0:Hd.Static),!y&&f&&_e&&this.highlightBubble(ee)}f&&!_e&&ue.then(()=>{Re({langPackKey:"MessageNotFound"})}),K&&(ae||Promise.resolve()).then(()=>{K()})}else W.setScrollPositionSilently(99999);W.updateThumb(W.lastScrollPosition),this.onRenderScrollSet(),this.onScroll(),ue.then(()=>{h()&&(W.onScroll(),e.mediaTimestamp!==void 0&&(R&&!t&&et.isAvailable("animations")&&this.chat.appImManager.chats.length>1?js(400):Promise.resolve()).then(()=>this.playMediaWithTimestampAndMid({lastMsgId:a,middleware:h,mediaTimestamp:e.mediaTimestamp})),this.tryToForceStartParam(h))}),this.chat.dispatchEvent("setPeer",a,!I),Promise.all([this.setFetchReactionsInterval(ue),this.setFetchHistoryInterval({afterSetPromise:ue,lastMsgId:a,samePeer:t,savedPosition:b,topMessage:g})]).then(()=>{d("scrolledAllDown:",W.loadedAll.bottom),W.loadedAll.bottom&&g&&!this.unreaded.size&&this.onScrolledAllDown()}),p===Q.Chat&&!this.chat.isForumTopic&&(await u(this.managers.appMessagesManager.getDialogOnly(i)))?.pFlags.unread_mark&&this.managers.appMessagesManager.markDialogUnread(i,!0)}).catch(z=>{throw d.error("setPeer promise error:",z),h()||this.preloader.detach(),z});return{cached:R,promise:H}}playMediaWithTimestampAndMid({middleware:e,lastMsgId:t,mediaTimestamp:s}){this.getMountedBubble(t).then(i=>{!e()||!i||this.playMediaWithTimestamp(i.bubble,s)})}playMediaWithTimestamp(e,t){const s=U(e,"bubble"),i=U(e,"grouped-item"),n=i?+i.dataset.mid:+s.dataset.textMid;let a=s.querySelector(".attachment");if(a){n&&(a=a.querySelector(`[data-mid="${n}"]`));const d=a.querySelector("img, video, canvas");this.checkTargetForMediaViewer(d,void 0,t);return}const r=(i||s).querySelector(".audio");if(r){r.playWithTimestamp(t);return}const l=s.dataset.replyToPeerId.toPeerId(),c=+s.dataset.replyToMid;l&&c&&(l===this.peerId?this.chat.setMessageId({lastMsgId:c,mediaTimestamp:t}):this.chat.appImManager.setInnerPeer({peerId:l,mediaTimestamp:t}))}async setFetchReactionsInterval(e){const t=this.getMiddleware();if(this.chat.isChannel){const i=()=>{if(!t())return;const n=[];for(const r in this.bubbles){let l=this.chat.getMessage(+r);l?._==="message"&&(l=fe.getGroupsFirstMessage(l),n.push(l.mid))}(n.length?this.managers.appReactionsManager.getMessagesReactions(this.peerId,n):Promise.resolve()).then(()=>{setTimeout(i,1e4)})};Promise.all([e,xs(),js(500)]).then(()=>{i()})}}async setFetchHistoryInterval({lastMsgId:e,topMessage:t,afterSetPromise:s,savedPosition:i,samePeer:n}){const a=this.peerId;if(a.isUser())return;const r=this.getMiddleware(),l=await this.managers.appMessagesManager.isFetchIntervalNeeded(a);if(!(i||l)||(await s,!r()))return;const d=a.toChatId();r.onClean(()=>{this.managers.apiUpdatesManager.unsubscribeFromChannelUpdates(d)}),this.managers.apiUpdatesManager.subscribeToChannelUpdates(d)}async onScrolledAllDown(){if(this.chat.type===Q.Chat||this.chat.type===Q.Discussion){const{peerId:e,threadId:t}=this.chat,s=await this.chat.getHistoryMaxId();this.managers.appMessagesManager.readHistory(e,s,t,!0)}}async finishPeerChange(){const[e,t,s]=await Promise.all([this.chat.isBroadcast,this.chat.canSend(),this.chat.isAnyGroup]);return()=>{this.chatInner.classList.toggle("has-rights",t),this.container.classList.toggle("is-chat-input-hidden",!t),[this.chatInner,this.remover].forEach(i=>{i.classList.toggle("is-chat",s),i.classList.toggle("is-broadcast",e)}),this.createResizeObserver()}}renderMessagesQueue(e){return this.batchProcessor.addToQueue(e)}ejectBubbles(){for(const e of this.bubblesToEject)e.remove();this.bubblesToEject.clear()}groupBubbles(e){let t;this.chat.type===Q.Scheduled&&(t=new Set,e.forEach(({bubble:n,message:a})=>{const r=this.bubbleGroups.getItemByBubble(n),l=r?.group;l&&r.message.date!==a.date&&(this.bubbleGroups.removeItem(r),t.add(l))})),e.forEach(({bubble:n,message:a})=>{this.bubbleGroups.prepareForGrouping(n,a)});const s=this.bubbleGroups.groupUngrouped(),i=Array.from(s).map(n=>{if(n.avatar)return;const a=n.firstItem;if(a&&this.chat.isAvatarNeeded(a.message))return n.createAvatar(a.message)}).filter(Boolean);if(t)for(const n of t)s.add(n);return{groups:[...s],avatarPromises:i}}getMiddleware(e){return this.middlewareHelper.get(e)}async wrapMediaSpoiler({media:e,promise:t,middleware:s,attachmentDiv:i}){if(await t,!s())return;const{width:n,height:a}=i.style,r=await eu({media:e,width:parseInt(n),height:parseInt(a),middleware:s,animationGroup:this.chat.animationGroup});s()&&i.append(r)}async safeRenderMessage({message:e,reverse:t,bubble:s,updatePosition:i=!0,processResult:n,canAnimateLadder:a}){if(!e||this.renderingMessages.has(e.mid)||this.bubbles[e.mid]&&!s)return;const r=Gt(),l=r.get(),c=this.getMiddleware();c.onClean(()=>{(this.chat.destroyPromise||this.chat.setPeerPromise||Promise.resolve()).then(()=>{r.destroy()})});let d;try{this.renderingMessages.add(e.mid);const h=document.createElement("div");h.middlewareHelper=r,h.dataset.mid=""+e.mid,h.dataset.peerId=""+e.peerId,h.dataset.timestamp=""+e.date,s&&(s.middlewareHelper.destroy(),this.skippedMids.delete(e.mid),this.bubblesToEject.add(s),this.bubblesToReplace.delete(s),this.bubblesToReplace.set(h,s),this.bubbleGroups.changeBubbleByBubble(s,h)),s=this.bubbles[e.mid]=h;let u=this.renderMessage(e,t,s,l);n&&(u=n(u,s));const p=u.then(m=>m&&c()?{...m,updatePosition:i,canAnimateLadder:a}:void 0);if(this.renderMessagesQueue(p.catch(()=>{})),d=await p,!c())return;d||this.skippedMids.add(+e.mid)}catch(h){this.log.error("renderMessage error:",h)}if(c())return this.renderingMessages.delete(e.mid),d}wrapKeyboardButton({button:e,message:t,noTextInject:s,replyMarkup:i}){let n=us(e.text,{noLinks:!0,noLinebreaks:!0}),a,r,l;const{peerId:c}=this,d=t?.media,h=i?.mid||t?.mid,u=i?.fromId||t?.viaBotId||t?.fromId;switch(e._){case"keyboardButtonUrl":{const p=us(" ",{entities:[{_:"messageEntityTextUrl",length:1,offset:0,url:e.url}]});a=zl(p).firstElementChild,a.classList.add("is-link"),r=Le("arrow_next");break}case"keyboardButtonSwitchInline":{a=document.createElement("button"),a.classList.add("is-switch-inline"),r=Le("forward_filled"),l=p=>{X(p);let m;e.pFlags.same_peer?m=Promise.resolve(c):m=this.managers.appInlineBotsManager.checkSwitchReturn(u).then(g=>{if(g)return g;let f;if(e.peer_types){const y={inlineQueryPeerTypePM:"users",inlineQueryPeerTypeBotPM:"bots",inlineQueryPeerTypeBroadcast:"channels",inlineQueryPeerTypeChat:"groups",inlineQueryPeerTypeMegagroup:"groups"};f=e.peer_types.map(v=>y[v._])}return _s.createPicker(f,["send_inline"])}),m.then(async g=>{const f=c===g?this.chat.threadId:void 0;await this.chat.appImManager.setInnerPeer({peerId:g,threadId:f}),this.managers.appInlineBotsManager.switchInlineQuery(g,f,u,e.query)})};break}case"keyboardButtonBuy":{const p=d._==="messageMediaInvoice"?d:void 0;if(p?.extended_media)break;a=document.createElement("button"),a.classList.add("is-buy"),r=Le("card"),p?.receipt_msg_id&&(n=_("Message.ReplyActionButtonShowReceipt"));break}case"keyboardButtonUrlAuth":{a=document.createElement("button"),a.classList.add("is-url-auth");const{url:p,button_id:m}=e;l=()=>{const g=zt([a],!0);this.chat.appImManager.handleUrlAuth({peerId:c,mid:h,url:p,buttonId:m}).then(()=>{g()})};break}case"keyboardButtonSimpleWebView":case"keyboardButtonWebView":{a=document.createElement("button"),a.classList.add("is-web-view"),r=Le("webview"),l=()=>{const p=zt([a],!0);this.chat.openWebApp({botId:u,url:e.url,isSimpleWebView:e._==="keyboardButtonSimpleWebView",buttonText:e.text}).finally(()=>{p()})};break}case"keyboardButtonRequestPhone":{a=document.createElement("button"),a.classList.add("is-request-phone"),l=()=>{this.chat.appImManager.requestPhone(c)};break}case"keyboardButtonCallback":{a=document.createElement("button"),l=()=>{this.managers.appInlineBotsManager.callbackButtonClick(c,h,e).then(p=>{typeof p.message=="string"&&p.message.length&&Rs(us(p.message,{noLinks:!0,noLinebreaks:!0}))})};break}case"keyboardButtonRequestPeer":{a=document.createElement("button"),l=async()=>{let p;const m=e.peer_type,g=m._==="requestPeerTypeUser",f=m._==="requestPeerTypeBroadcast",y=m._==="requestPeerTypeChat",v=["dialogs"];if(g)p=w=>!(w._!=="user"||m.bot!==void 0&&m.bot!==!!w.pFlags.bot||m.premium!==void 0&&m.premium!==!!w.pFlags.premium),v.push("contacts");else{let w;y&&(w=(await this.managers.appUsersManager.getCommonChats(c,100)).chats.map(I=>I.id)),p=S=>{if(S._!=="channel"&&(f||S._!=="chat")||!!S.pFlags.broadcast!==f||m.pFlags.creator&&!S.pFlags.creator||m.has_username!==void 0&&!!si(S)[0]!=!!m.has_username||m.forum!==void 0&&m.forum!==!!S.pFlags.forum)return!1;if(m.user_admin_rights){for(const I in m.user_admin_rights.pFlags)if(!zn(S,I))return!1}return!(m.pFlags.bot_participant&&!w.includes(S.id)&&!zn(S,"invite_users"))}}const b=await _s.createPicker2({peerType:v,filterPeerTypeBy:p,multiSelect:!0,limit:e.max_quantity,limitCallback:()=>{Re({langPackKey:"RequestPeer.MultipleLimit",langPackArguments:[_(g?"RequestPeer.MultipleLimit.Users":f?"RequestPeer.MultipleLimit.Channels":"RequestPeer.MultipleLimit.Groups",[e.max_quantity])]})},titleLangKey:g?"RequestPeer.Title.Users":f?"RequestPeer.Title.Channels":"RequestPeer.Title.Groups"});if(!g){const w=await Promise.all(b.map(P=>Oe({peerId:P}))),S=ci(w,!1);let I;S.length===1?I=S[0]:(I=document.createElement("span"),I.append(...S));const L=[I,await Oe({peerId:c})];await ft({descriptionLangKey:"Chat.Service.PeerRequest.Confirm.Plain",descriptionLangArgs:L,button:{langKey:"Chat.Service.PeerRequest.Confirm.Ok"}})}this.managers.appMessagesManager.sendBotRequestedPeer(c,h,e.button_id,b).catch(w=>{w.type==="CHAT_ADMIN_INVITE_REQUIRED"&&Re({langPackKey:f?"Error.RequestPeer.NoRights.Channel":"Error.RequestPeer.NoRights.Group"})})};break}default:{a=document.createElement("button"),t||(l=()=>{this.managers.appMessagesManager.sendText({peerId:c,text:e.text})});break}}return r&&r.classList.add("reply-markup-button-icon"),s||a?.append(n),{text:n,buttonEl:a,buttonIcon:r,onClick:l}}setBubbleSendingStatus(e,t,s){!s&&e.classList.remove("is-sending","is-error","is-sent","is-read"),t&&e.classList.add("is-"+t),e.querySelectorAll(".time, .time-inner").forEach(i=>{const n=i.firstElementChild.classList.contains("time-sending-status");if(!t){n&&i.firstElementChild.remove();return}let a;t==="error"?a="sendingerror":t==="sending"?a="sending":t==="sent"?a="check":a="checks";const r=Le(a,"time-sending-status");n?i.firstElementChild.replaceWith(r):i.prepend(r)})}async renderMessage(e,t=!1,s,i){const n=e._==="message",a=n&&e.grouped_id;let r,l;const c=a?await this.managers.appMessagesManager.getMessagesByGroupedId(a):void 0,d=this.chat.type!==Q.Pinned;if(a&&d){r=c.map(se=>se.mid);const $=Op(c);if(e.mid!==$.mid)return}const h=r?Math.max(...r):e.mid;n&&(l=a?Op(c):e);const u=this.chat.isOurMessage(e),p=document.createElement("div");p.classList.add("message","spoilers-container");const m=document.createElement("div");m.classList.add("bubble-content-wrapper");const g=document.createElement("div");g.classList.add("bubble-content"),s.classList.add("bubble"),m.append(g),s.append(m);let f=!u&&!e.pFlags.out&&(e.pFlags.unread||Df(e));if(!f&&this.chat.peerId.isAnyChat()){const $=await this.managers.appMessagesManager.getReadMaxIdIfUnread(this.chat.peerId,this.chat.threadId);$!==void 0&&$<h&&(f=!0)}const y=[],v={bubble:s,promises:y,message:e,reverse:t},b={lazyLoadQueue:this.lazyLoadQueue,middleware:i,customEmojiSize:this.chat.appImManager.customEmojiSize,animationGroup:this.chat.animationGroup},w=n&&e.media?.pFlags?.via_mention,S=!!w;let I;if(S||!n&&(!e.action||!cg.has(e.action._))){const $=e.action;if($){const oe=$._,ve=zE.get(oe);if(ve&&(ve===!0||ve(e))||$d.hasOwnProperty(oe)&&!$d[oe])return}s.className="bubble service",g.replaceChildren();const se=document.createElement("div");if(se.classList.add("service-msg"),$){const oe=$._==="messageActionGiftCode";let ve;if(oe&&!Qd($)){const Te=$.pFlags.unclaimed,Ae=$.pFlags.via_giveaway,Ge=_(Te?"BoostingUnclaimedPrize":"BoostingCongratulations"),We=document.createElement("span");We.append(_(Te?"BoostingYouHaveUnclaimedPrize":Ae?"BoostingReceivedPrizeFrom":$.boost_peer?"BoostingReceivedGiftFrom":"BoostingReceivedGiftNoName",$.boost_peer?[await Oe({peerId:Je($.boost_peer)})]:void 0),document.createElement("br"),document.createElement("br"),_(Te?"BoostingUnclaimedPrizeDuration":Ae?"BoostingReceivedPrizeDuration":"BoostingReceivedGiftDuration",[Cr($.months,!0)]));const Ct=Yp($.months);this.wrapGift({content:g,service:se,middleware:i,loadPromises:y,assetName:Ct,title:Ge,subtitle:We,buttonText:"BoostingReceivedGiftOpenBtn",buttonCallback:()=>{J.createPopup(Kn,$.slug)}})}else if($._==="messageActionChannelMigrateFrom"){const Te=new Mt;ve=Te.update({peerId:$.chat_id.toPeerId(!0),wrapOptions:b}),se.append(_("ChatMigration.From",[Te.element]))}else if($._==="messageActionChatMigrateTo"){const Te=new Mt;ve=Te.update({peerId:$.channel_id.toPeerId(!0),wrapOptions:b}),se.append(_("ChatMigration.To",[Te.element]))}else ve=vv({message:e,...b}).then(Te=>se.append(Te));if($._==="messageActionGiftPremium"||oe&&Qd($)){const Te=g.cloneNode(!1);Te.classList.add("has-service-before");const Ae=se.cloneNode(!1),Ge=$.months,We=Yp(Ge),Ct=_("ActionGiftPremiumTitle"),Pt=_("ActionGiftPremiumSubtitle",[Cr(Ge,!1)]);this.wrapGift({content:Te,service:Ae,middleware:i,loadPromises:y,assetName:We,title:Ct,subtitle:Pt,buttonText:oe&&e.fromId===e.peerId?"GiftPremiumUseGiftBtn":"ActionGiftPremiumView",buttonCallback:()=>{if(oe){const ze={_:gt.GIFT_CODE,slug:$.slug,stack:this.chat.appImManager.getStackFromElement(s)};co.processGiftCodeLink(ze);return}ps.show({gift:$,peerId:this.peerId,isOut:!!e.pFlags.out})}}),Te.append(Ae),g.after(Te)}else if($._==="messageActionChannelJoined"){s.classList.add("is-similar-channels");const Te=document.createElement("div");Te.classList.add("bubble-similar-channels");let Ae=!1;const Ge=(yt=!Ae,at)=>{if(yt===Ae)return;Ae=yt,yt&&!Te.parentElement&&g.after(Te),et.isAvailable("animations")||(at=!0);let It;s.isConnected&&(It=this.createScrollSaver(!0),It.save());const bt={duration:at?0:300,fill:"forwards",easing:"cubic-bezier(.4, .0, .2, 1)"},Me=[{height:"0"},{height:"9.125rem"}];yt||Me.reverse();const Be=Te.animate(Me,bt);It&&this.animateSomethingWithScroll(Be.finished,It),yt||Be.finished.then(()=>{Ae===yt&&Te.remove()}),Ct(!yt)},We=Rt(),Ct=async yt=>{const at=await fe.getState();yt?at.hiddenSimilarChannels.push(Pt):cs(at.hiddenSimilarChannels,Pt),await this.managers.appStateManager.pushToState("hiddenSimilarChannels",at.hiddenSimilarChannels)},Pt=this.chat.peerId;let ze;this.wrapSomeSolid(()=>HE({chatId:Pt.toChatId(),onClose:()=>{Ge(!1)},onAcked:yt=>{ze=yt,ze||We.resolve()},onReady:async()=>{g.classList.add("is-clickable"),await xs(),(await fe.getState()).hiddenSimilarChannels.includes(Pt)||Ge(!0,ze),ze&&We.resolve(),D(g,()=>{Ge()})},onEmpty:()=>{We.isFulfilled&&Ge(!1),We.resolve()}}),Te,i),y.push(We)}y.push(ve)}else if(w){const oe=e.media,ve=Je(oe.peer),Te=oe.id,Ae=ve===C.myId,Ge=await Ro(this.managers.acknowledged.appStoriesManager.getStoryById(ve,Te));if(!Ge.cached)se.append(_("Loading")),Ge.result.then(()=>{this.safeRenderMessage({message:e,reverse:!0,bubble:s})});else if(Ge.result){se.classList.add("bubble-story-mention-wrapper");const We=document.createElement("div");We.classList.add("bubble-story-mention-avatar-container");const Ct=ls({middleware:i,size:100,peerId:ve,lazyLoadQueue:this.lazyLoadQueue,withStories:!0,storyId:Te,storyColors:{read:"rgba(255, 255, 255, .3)"}});Ct.node.dataset.storyId=""+Te,y.push(Ct.readyThumbPromise);const Pt=Rt();y.push(Pt),Xs(Ge.result,at=>{if(!i()||!at||at.pFlags.noforwards){Pt.resolve();return}qs(It=>{i.onClean(()=>{Pt.resolve(),It()});const{container:bt,ready:Me}=zc({peerId:ve,storyItem:at,forPreview:!0,noInfo:!0,lazyLoadQueue:this.lazyLoadQueue,withPreloader:!0,noAspecter:!0});Ne(()=>{Me()&&(Pt.resolve(),bt.classList.add("bubble-story-mention-preview"),D(We,Be=>{X(Be),Da({peerId:ve,id:Te,target:()=>bt})},{listenerSetter:this.listenerSetter}),We.append(bt))})})}),We.append(Ct.node);const ze=_(Ae?"StoryMentionYou":"StoryMention",[await Oe({peerId:Ae?e.peerId:ve})]);ze.classList.add("bubble-story-mention-text");const yt=Ve("bubble-service-button bubble-story-mention-button",{noRipple:!0,text:"StoryMentionView"});D(yt,()=>{hs(Ct.node)},{listenerSetter:this.listenerSetter}),se.append(We,ze,yt)}else{let We;Ae?We=_("ExpiredStoryMentionYou",[await Oe({peerId:e.peerId})]):We=_("ExpiredStoryMention");const Ct=Le("bomb","expired-story-icon");se.append(Ct,We)}}g.append(se),e.pFlags.is_single&&s.classList.add("is-group-last"),I=!0}const L=f&&this.observer?($=s)=>{this.observer.observe($,this.unreadedObserverCallback),this.unreaded.set($,h)}:void 0,M=this.chat.isBroadcast;if(I)return L?.(),v;M||L?.();const P=e.pFlags.sponsored,E=e.sponsoredMessage;let k=n&&e.media,A=!0,x,T,O;if(n){if(a&&d){const se=O=Ob(c);x=se?.message||"",T=se?.totalEntities||[]}else x=e.message,T=e.totalEntities;const $=k?.document;$&&($?.type==="sticker"?x=T=void 0:["video","gif"].includes($.type)||(A=!1))}else e.action._==="messageActionPhoneCall"&&(k={_:"messageMediaCall",action:e.action});let F=0,N;if(T&&!k){const $=[];for(let ve=0,Te=T.length;ve<Te;++ve){const Ae=T[ve];Ae._==="messageEntityCustomEmoji"?(++ve,$.push(Ae)):Ae._==="messageEntityEmoji"&&$.push(Ae)}const se=x.replace(/\s/g,"").length;if($.reduce((ve,Te)=>ve+Te.length,0)===se){F=Math.min(jE,$.length),N=Fe.active.customEmoji;const ve=uw[F];ve&&(N=ys(ve,ve),s.style.setProperty("--emoji-size",ve+"px"))}}N??(N=this.chat.appImManager.customEmojiSize);let G=Bd(O||e);O&&A&&(s.dataset.textMid=""+O.mid);let R=e.reply_to;if(R?._==="messageReplyHeader"){const $=R.reply_to_peer_id?Je(R.reply_to_peer_id):this.peerId;if(s.dataset.replyToPeerId=""+$,s.dataset.replyToMid=""+e.reply_to_mid,G===void 0){const se=fe.getMessageByPeer($,e.reply_to_mid);se?G=Bd(se):G=1/0}}else R&&(s.dataset.replyToPeerId=""+Je(R.peer),s.dataset.replyToStoryId=""+R.story_id);const B=$=>({entities:$,passEntities:this.passEntities,loadPromises:y,lazyLoadQueue:this.lazyLoadQueue,customEmojiSize:N,middleware:i,animationGroup:this.chat.animationGroup,maxMediaTimestamp:G,textColor:"primary-text-color",passMaskedLinks:!!e.sponsoredMessage}),H=x?us(x,B(T)):void 0;let z=!0,W=!1,ue=!1,K;if(F){if(C.settings.emoji.big){const $=F===1&&!T.find(se=>se._==="messageEntityCustomEmoji")&&await this.managers.appStickersManager.getAnimatedEmojiSticker(x);F===1&&!k&&$?k={_:"messageMediaDocument",document:$,pFlags:{}}:(K=document.createElement("div"),K.classList.add("attachment","spoilers-container"),St(K,H),g.append(K)),s.classList.add("is-message-empty","emoji-big"),ue=!0,z=!1,A=!1}s.classList.add("can-have-big-emoji")}A&&St(p,H);const ee=this.chat.isOutMessage(e),_e=P0(x,!0);let ae;P?s.classList.add("is-sponsored"):(ae=nr.setTime({chat:this.chat,chatType:this.chat.type,message:e,reactionsMessage:l,isOut:ee}),p.append(ae),(De.isRTL?!E0(x):_e)&&ae.classList.add("is-block"),M&&L?.(ae)),g.prepend(p);let re;if(n&&this.chat.isAllMessagesForum){const $=await jb({peerId:this.peerId,threadId:Un(e,this.chat.isForum),lastMsgId:e.mid,wrapOptions:{middleware:i},withIcons:!0}),{element:se}=$;re=document.createElement("div"),re.classList.add("topic-name-button-container"),re.append(se)}if(n&&e.views){if(s.classList.add("channel-post"),!e.fwd_from?.saved_from_msg_id&&this.chat.type!==Q.Pinned){const $=document.createElement("div");$.classList.add("bubble-beside-button","with-hover","forward"),$.append(Le("forward_filled")),g.prepend($),s.classList.add("with-beside-button")}!e.pFlags.is_outgoing&&this.observer&&this.observer.observe(s,this.viewsObserverCallback)}const Ue=n&&e.reply_markup;let ye=Ue?._==="replyInlineMarkup"&&Ue.rows;if(ye&&(ye=ye.filter($=>$.buttons.length)),ye){const $=document.createElement("div");$.classList.add("reply-markup");const se=new Map;ye.forEach((ve,Te,Ae)=>{const Ge=ve.buttons,We=Te===Ae.length-1,Ct=document.createElement("div");Ct.classList.add("reply-markup-row"),Ge.forEach((Pt,ze,yt)=>{const at=ze===0,It=ze===yt.length-1,{text:bt,buttonEl:Me,buttonIcon:Be,onClick:je}=this.wrapKeyboardButton({button:Pt,message:e,noTextInject:!0});if(!Me)return;je&&se.set(Me,je),We&&(at&&Me.classList.add("is-first"),It&&Me.classList.add("is-last")),Me.classList.add("reply-markup-button","rp");const pt=document.createElement("span");pt.classList.add("reply-markup-button-text"),pt.append(bt),pi(Me),Me.append(...[Be,pt].filter(Boolean)),Ct.append(Me)}),Ct.childElementCount&&$.append(Ct)});const oe=!!$.childElementCount;oe&&D($,ve=>{let Te=ve.target;Te=U(Te,"reply-markup-button");const Ae=se.get(Te);Ae&&(Ae(ve),X(ve))}),oe&&(s.classList.add("with-reply-markup"),m.append($))}const Z=e.pFlags.is_outgoing;Z&&!e.error&&(s.classList.add("is-outgoing"),e.reactions&&(s.dataset.ignoreReactions="1"));const de=n&&await this.managers.appMessagesManager.getMessageWithCommentReplies(e),be=!!de&&e.mid>0;be&&s.classList.add("with-replies");const pe=n&&e.fwd_from,xe=n&&e.fwdFromId,ne=this.chat.isForwardOfForward(e);let Y=g;const j=!e.viaBotId&&(e.fromId===C.myId||!e.pFlags.out)&&!e.post_author&&!ne,te=!x&&!P,le=n&&e.pFlags.invert_media;le&&s.classList.add("invert-media");let me;if(k){K=document.createElement("div"),K.classList.add("attachment"),te&&s.classList.add("is-message-empty");let $=!1;switch(k._){case"messageMediaPhotoExternal":case"messageMediaPhoto":{const se=k.photo;if(te&&(W=!0),j&&s.classList.add("hide-name"),s.classList.add("photo"),d&&a&&r.length!==1){s.classList.add("is-album","is-grouped"),Bf({messages:c,attachmentDiv:K,middleware:this.getMiddleware(),isOut:u,lazyLoadQueue:this.lazyLoadQueue,chat:this.chat,loadPromises:y,autoDownload:this.chat.autoDownload});break}const oe=!sp&&z&&!be&&jf;oe&&s.classList.add("with-media-tail");const ve=Ns({photo:se,message:e,container:K,withTail:oe,isOut:ee,lazyLoadQueue:this.lazyLoadQueue,middleware:this.getMiddleware(),loadPromises:y,autoDownloadSize:this.chat.autoDownload.photo});k.pFlags?.spoiler&&y.push(this.wrapMediaSpoiler({media:se,promise:ve,middleware:i,attachmentDiv:K}));break}case"messageMediaWebPage":{const se="webpage";$=!0,K=void 0;const oe=k.webpage;if(oe._!=="webPage")break;const ve=oe.attributes?.find(rt=>rt._==="webPageAttributeStory"),Te=ve&&Je(ve.peer),Ae=ve?.id;if(ve&&await this.getStoryReplyIfExpired(Te,Ae,!0)===null)break;const Ge=document.createElement("a");Ge.classList.add(se,"quote-like","quote-like-hoverable"),pi(Ge);const We=`${se}-quote`,Ct=Eh(oe.url);let Pt;if(Ct.onclick&&!_0.has(Ct.onclick)||P)if(Pt=document.createElement("div"),Pt.classList.add(`${se}-button`),nn(Pt),P){const rt=Je(E.from_id),xt=rt!==Vt?rt.isUser():this.chat.isBot,Wt=E.webpage;let os,Os,ni,Di,pa;E.app?os="Chat.Message.ViewApp":Wt?os="OpenUrlTitle":E.channel_post?(os="OpenChannelPost",Os=E.channel_post):E.start_param||xt?(os="Chat.Message.ViewBot",ni=E.start_param):os=fe.getPeer(rt)?.pFlags?.broadcast?"Chat.Message.ViewChannel":"Chat.Message.ViewGroup";const Ms=E.chat_invite,mn=E.chat_invite_hash;E.app?Di=()=>{const Bi=fe.getUser(rt.toUserId()),Vr={_:gt.WEB_APP,appname:E.app.short_name,domain:si(Bi)[0],startapp:E.start_param};co.processInternalLink(Vr)}:Wt?(pa=Wt.url,Ge.href=pa,Ge.target="_blank"):Ms?((Ms.pFlags?.broadcast||Ms.chat?.pFlags?.broadcast)&&(os="Chat.Message.ViewChannel"),Di=()=>{ac.open(mn,Ms)}):mn?Di=()=>{const Bi={_:gt.JOIN_CHAT,invite:mn};co.processInternalLink(Bi)}:Di=()=>{this.chat.appImManager.setInnerPeer({peerId:rt,lastMsgId:Os,startParam:ni})},Di&&(Ge.callback=()=>{this.chat.appImManager.clickIfSponsoredMessage(e),Di()}),Pt.append(E.button_text?Pe(E.button_text):_(os)),this.observer.observe(Pt,this.viewsObserverCallback)}else{const rt=qE[oe.type]||"OpenMessage";Pt.append(_(rt)),Ge.dataset.callback=Ct.onclick}else vm(Ge),k.pFlags.safe||(Ge.dataset.callback="showMaskedAlert");Ct?.url&&!P&&(Ge.href=Ct.url),s.classList.add("has-webpage");const ze=document.createElement("div");ze.classList.add(We,"quote-like-border"),Pt&&ze.classList.add("has-button");let yt,at;const It=oe.photo,bt=oe.document,Me=!!oe.pFlags.has_large_media,Be=!!(Me&&k.pFlags.force_small_media),je=E&&QE(E),pt=E&&(Je(E.from_id)!==Vt||je),Jt=E&&E.pFlags.show_peer_photo&&pt;(It||bt||ve||Jt)&&(yt=document.createElement("div"),yt.classList.add(`${se}-preview-resizer`),at=document.createElement("div"),at.classList.add(`${se}-preview`),yt.append(at));const wt=document.createElement("div");if(wt.classList.add(`${se}-content`),bt)if(bt.type==="gif"||bt.type==="video"||bt.type==="round"){const rt=bt.type==="round"?Fe.active.round:Fe.active.webpage;bt.type==="round"?(s.classList.add("round"),at.classList.add("is-round")):s.classList.add("video"),On({doc:bt,container:at,message:e,boxWidth:rt.width,boxHeight:rt.height,lazyLoadQueue:this.lazyLoadQueue,middleware:this.getMiddleware(),isOut:ee,group:this.chat.animationGroup,loadPromises:y,autoDownload:this.chat.autoDownload,noInfo:e.mid<0})}else{const rt=await lc({message:e,autoDownloadSize:this.chat.autoDownload.file,lazyLoadQueue:this.lazyLoadQueue,loadPromises:y,sizeType:"documentName",searchContext:{useSearch:!1,peerId:this.peerId,inputFilter:{_:"inputMessagesFilterEmpty"}},fontSize:C.settings.messagesTextSize,canTranscribeVoice:!0});at.append(rt),at.classList.add(`${se}-preview-with-document`),wt.classList.add("has-document")}const gs=[];if(oe.site_name||E){let rt;if(E)rt=document.createElement("div");else{const Wt=us(oe.url);rt=zl(Wt).firstElementChild}rt.classList.add(`${se}-name`);const xt=document.createElement("strong");E?(xt.append(_(E.pFlags.recommended?"SponsoredMessageRecommended":"SponsoredMessage")),xt.classList.add("text-capitalize")):xt.append(Pe(oe.site_name)),rt.replaceChildren(xt),nn(rt),wt.append(rt),gs.push(rt)}const bi=Nb(oe);if(bi.textContent||E){const rt=document.createElement("div");rt.classList.add(`${se}-title`);const xt=document.createElement("strong");if(E)if(E.webpage||E.chat_invite){let Wt;const os=E.chat_invite,Os=E.webpage;if(Os)Wt=Pe(Os.site_name);else if(os){let ni;os._!=="chatInvite"?ni=os.chat.title:ni=os.title,Wt=Pe(ni)}Wt&&xt.append(Wt)}else xt.append(await Oe({peerId:e.fromId,withPremiumIcon:!0,wrapOptions:b}));else xt.append(bi);rt.append(xt),nn(rt),wt.append(rt),gs.push(rt)}const rs=Bb(oe,B(oe.entities),P);if(rs.textContent){const rt=document.createElement("div");rt.classList.add(`${se}-text`),St(rt,rs),wt.append(rt),gs.push(rt)}ze.append(wt);let As=!1;if(Jt||It&&!bt){s.classList.add("photo");const rt=48,xt=!E&&It.sizes[It.sizes.length-1];(!xt||xt.w===xt.h&&!Me||Be)&&gs[0]?(s.classList.add("is-square-photo"),Ge.classList.add("has-square-photo"),As=!0,at.style.width=at.style.height=`${rt}px`):xt.h>xt.w&&!Me&&(s.classList.add("is-vertical-photo"),Ge.classList.add("has-vertical-photo"));const Wt=je?._==="photo"?je:It;if(Wt)Ns({photo:Wt,message:e,container:at,boxWidth:As?0:Fe.active.webpage.width,boxHeight:As?0:Fe.active.webpage.height,isOut:ee,lazyLoadQueue:this.lazyLoadQueue,middleware:i,loadPromises:y,withoutPreloader:As,autoDownloadSize:this.chat.autoDownload.photo});else{const os=je&&je._!=="photo",{node:Os,readyThumbPromise:ni}=ls({middleware:i,size:rt,lazyLoadQueue:this.lazyLoadQueue,peerId:os?je.id.toPeerId(!0):je?void 0:Je(E.from_id),peer:os?je:void 0});Os.classList.add("avatar-full"),at.append(Os),ni&&y.push(ni)}}if(ve){s.classList.add("photo","story");const rt=Fe.active.webpage;lo({photo:{_:"photo",id:0,sizes:[{_:"photoSize",w:180,h:320,type:"q",size:0}],pFlags:{},access_hash:0,file_reference:[],date:0,dc_id:0},element:at,boxWidth:rt.width,boxHeight:rt.height,message:e}),this.wrapStory({message:e,bubble:s,storyPeerId:Te,storyId:Ae,container:at,middleware:i,loadPromises:y,boxWidth:rt.width,boxHeight:rt.height})}yt&&wt[le||As?"prepend":"append"](yt),Pt&&wt.append(Pt),Ge.append(ze),ae?le?ae.parentElement.prepend(Ge):ae.before(Ge):p.append(Ge);break}case"messageMediaDocument":{const se=k.document;if(se.sticker){s.classList.add("sticker"),z=!1,ue=!0,se.animated&&s.classList.add("sticker-animated");const oe=Fe.active,ve=s.classList.contains("emoji-big"),Te=ve?oe.emojiSticker:se.animated?oe.animatedSticker:oe.staticSticker;lo({photo:se,element:K,boxWidth:Te.width,boxHeight:Te.height}),g.style.minWidth=K.style.width,g.style.minHeight=K.style.height;const Ae=k?.pFlags?.nopremium;Ds({doc:se,div:K,middleware:i,lazyLoadQueue:this.lazyLoadQueue,group:this.chat.animationGroup,play:!0,liteModeKey:"stickers_chat",loop:!0,emoji:ve?x:void 0,withThumb:!0,loadPromises:y,isOut:ee,noPremium:Ae,scrollable:this.scrollable,showPremiumInfo:()=>{const We=fi(()=>{Br(),J.createPopup(Pn,se.stickerSetInput).show()});Re({langPackKey:"Sticker.Premium.Click.Info",langPackArguments:[We]})}}),(Nc(se)||ve)&&(f||Z)&&this.observer.observe(s,this.stickerEffectObserverCallback)}else if(se.type==="video"||se.type==="gif"||se.type==="round"){const oe=se.type==="round";if(oe&&(ue=!0),oe?z=!1:te&&(W=!0),j&&s.classList.add("hide-name"),s.classList.add(oe?"round":"video"),d&&a&&r.length!==1)s.classList.add("is-album","is-grouped"),Bf({messages:c,attachmentDiv:K,middleware:i,isOut:u,lazyLoadQueue:this.lazyLoadQueue,chat:this.chat,loadPromises:y,autoDownload:this.chat.autoDownload});else{const ve=!sp&&!Sr&&!oe&&z&&!be&&jf;ve&&s.classList.add("with-media-tail");const Te=On({doc:se,container:K,message:e,boxWidth:Fe.active.regular.width,boxHeight:Fe.active.regular.height,withTail:ve,isOut:ee,lazyLoadQueue:this.lazyLoadQueue,middleware:i,group:this.chat.animationGroup,loadPromises:y,autoDownload:this.chat.autoDownload,searchContext:oe?{peerId:this.peerId,inputFilter:{_:"inputMessagesFilterRoundVoice"},threadId:this.chat.threadId,useSearch:!e.pFlags.is_scheduled,isScheduled:e.pFlags.is_scheduled}:void 0,noInfo:e.mid<0,noAutoplayAttribute:!!k.pFlags.spoiler});k.pFlags.spoiler&&y.push(this.wrapMediaSpoiler({media:se,promise:Te,middleware:i,attachmentDiv:K}))}}else{const oe=await S0({albumMustBeRenderedFull:d,message:e,bubble:s,messageDiv:p,chat:this.chat,loadPromises:y,autoDownloadSize:this.chat.autoDownload.file,lazyLoadQueue:this.lazyLoadQueue,searchContext:se.type==="voice"||se.type==="audio"?{peerId:this.peerId,inputFilter:{_:se.type==="voice"?"inputMessagesFilterRoundVoice":"inputMessagesFilterMusic"},threadId:this.chat.threadId,useSearch:!e.pFlags.is_scheduled,isScheduled:e.pFlags.is_scheduled}:void 0,sizeType:"documentName",fontSize:C.settings.messagesTextSize,richTextFragment:typeof H=="string"?void 0:H,richTextOptions:B(),canTranscribeVoice:!0});oe&&(Y=oe);const ve=p.lastElementChild.querySelector(".document-message, .document, .audio");ve&&ve.append(ae),s.classList.remove("is-message-empty");const Te=(["photo","pdf"].includes(se.type)?"document":se.type||"document")+"-message";p.classList.add(Te),(se.type==="audio"||se.type==="voice")&&s.classList.add("min-content"),$=!0}break}case"messageMediaCall":{const se=k.action,oe=document.createElement("div");oe.classList.add("bubble-call"),oe.append(Le(se.pFlags.video?"videocamera":"phone","bubble-call-icon"));const ve=se.pFlags.video?"video":"voice";oe.dataset.type=ve;const Te=document.createElement("div");Te.classList.add("bubble-call-title"),$t(Te,ee?se.pFlags.video?"CallMessageVideoOutgoing":"CallMessageOutgoing":se.pFlags.video?"CallMessageVideoIncoming":"CallMessageIncoming");const Ae=document.createElement("div");if(Ae.classList.add("bubble-call-subtitle"),se.duration!==void 0)Ae.append(xd(se.duration));else{let Ge;switch(se.reason._){case"phoneCallDiscardReasonBusy":Ge="Call.StatusBusy";break;case"phoneCallDiscardReasonMissed":Ge="Chat.Service.Call.Missed";break;default:Ge="Chat.Service.Call.Cancelled";break}Ae.classList.add("is-reason"),$t(Ae,Ge)}Ae.prepend(Le("arrow_next","bubble-call-arrow","bubble-call-arrow-"+(se.duration!==void 0?"green":"red"))),oe.append(Te,Ae),$=!0,s.classList.remove("is-message-empty"),p.classList.add("call-message"),p.append(oe);break}case"messageMediaContact":{const se=k,oe=document.createElement("div");oe.classList.add("contact"),oe.dataset.peerId=""+se.user_id,$=!0;const ve=document.createElement("div");ve.className="contact-details";const Te=document.createElement("div");Te.className="contact-name";const Ae=[se.first_name,se.last_name].filter(Boolean).join(" ");Te.append(Ae.trim()?Pe(Ae):_("AttachContact"));const Ge=document.createElement("div");Ge.className="contact-number",Ge.textContent=se.phone_number?"+"+Vo(se.phone_number).formatted:"Unknown phone number",oe.append(ve),ve.append(Te,Ge);const We=ls({middleware:i,size:54,lazyLoadQueue:this.lazyLoadQueue,peerId:se.user_id.toPeerId(),peerTitle:se.user_id?void 0:Ae.trim()?Ae:De.format("AttachContact",!0)[0]});oe.prepend(We.node),s.classList.remove("is-message-empty"),p.classList.add("contact-message"),p.append(oe);break}case"messageMediaPoll":{s.classList.remove("is-message-empty");const se=I0(e,void 0,i);p.prepend(se),p.classList.add("poll-message");break}case"messageMediaInvoice":{const se=k.pFlags.test,oe=k.extended_media,ve=oe?._==="messageExtendedMedia",Te=oe?._==="messageExtendedMediaPreview";let Ae=ve?oe.media.photo||oe.media.document:k.photo;const Ge=Gn(k.total_amount,k.currency);let We;if(oe){if(Te&&(We=document.createElement("span"),We.classList.add("extended-media-buy"),We.append(Le("premium_lock","extended-media-buy-icon")),K.classList.add("is-buy"),$t(We,"Checkout.PayPrice",[Ge]),oe.video_duration!==void 0)){const ze=document.createElement("span");ze.classList.add("video-time"),ze.textContent=Ci(oe.video_duration,!1),K.append(ze)}}else{We=document.createElement(Ae?"span":"div");const ze=document.createDocumentFragment(),yt=_(k.receipt_msg_id?"PaymentReceipt":se?"PaymentTestInvoice":"PaymentInvoice");yt.classList.add("text-uppercase");const at=" "+Km,It=document.createElement("span");if(It.classList.add("text-bold"),It.textContent=Ge+at,ze.append(It,yt),se&&k.receipt_msg_id){const bt=document.createElement("span");bt.classList.add("text-uppercase","pre-wrap"),bt.append(at+"(Test)"),ze.append(bt)}St(We,ze)}if(Te&&(oe.thumb.w=oe.w,oe.thumb.h=oe.h,Ae={_:"photo",access_hash:"",pFlags:{},date:0,dc_id:0,file_reference:[],id:0,sizes:[oe.thumb]}),Ae){const ze=oe?Fe.active.extendedInvoice:Fe.active.invoice;Ae._==="document"?(On({doc:Ae,container:K,withTail:!1,isOut:ee,lazyLoadQueue:this.lazyLoadQueue,middleware:i,loadPromises:y,boxWidth:ze.width,boxHeight:ze.height,group:this.chat.animationGroup,message:e}),s.classList.add("video")):(Ns({photo:Ae,container:K,withTail:!1,isOut:ee,lazyLoadQueue:this.lazyLoadQueue,middleware:i,loadPromises:y,boxWidth:ze.width,boxHeight:ze.height,message:ve?e:void 0}),s.classList.add("photo")),We&&(oe||We.classList.add("video-time"),K.append(We))}else K=void 0;if(Te){const{mid:ze}=e;this.extendedMediaMessages.add(ze),i.onClean(()=>{this.extendedMediaMessages.delete(ze)}),this.setExtendedMediaMessagesPollInterval();const{width:yt,height:at}=K.style,{dotRenderer:It,readyResult:bt}=oc.create({width:parseInt(yt),height:parseInt(at),middleware:i,animationGroup:this.chat.animationGroup});y?.push(bt),K.append(It.canvas)}let Ct;oe||(Ct=document.createElement("div"),Ct.classList.add("bubble-primary-color"),St(Ct,Pe(k.title)));const Pt=ve?void 0:Pe(k.description);p.prepend(...[Ct,!Ae&&We,Pt].filter(Boolean)),Pt?s.classList.remove("is-message-empty"):z=!1,s.classList.add("is-invoice");break}case"messageMediaGeoLive":case"messageMediaVenue":case"messageMediaGeo":{let se=function(wt,gs){return 156543.03392*Math.cos(wt*(Math.PI/180))/2**gs};s.classList.add("photo");const oe=document.createElement("a");oe.classList.add("geo-container","shimmer-bright");const ve=k._==="messageMediaVenue",Te=k._==="messageMediaGeoLive",{geo:Ae}=k,Ge=277,We=195;oe.innerHTML=`
`}}mc=new WeakMap,gc=new WeakMap;function ug(o,e,t){const s=o.split(e),i=[];for(;t>0&&s.length;)i.push(s.shift()),--t;return s.length&&i.push(s.join(e)),i}var mo,fc,yc;class I_{constructor(e,t){es(this,mo,void 0);es(this,fc,void 0);es(this,yc,void 0);kt(this,mo,new Set),kt(this,fc,e),kt(this,yc,t)}generate(){const e=At(this,fc),t=At(this,yc),s=At(this,mo),i=t-e+1;let n=Math.floor(e+i*Math.random()),a=0;for(;s.has(n);)if(n<t?++n:n=e,++a>=i)return null;return s.add(n),n}add(e){At(this,mo).add(e)}}mo=new WeakMap,fc=new WeakMap,yc=new WeakMap;var vc,bc;class Gu{constructor(e,t){es(this,vc,void 0);es(this,bc,void 0);kt(this,vc,e),kt(this,bc,t)}get key(){return At(this,vc)}get value(){return At(this,bc)}}vc=new WeakMap,bc=new WeakMap;var wc,Sc,Cc,Ic;class ty{constructor(e,t,s,i){es(this,wc,void 0);es(this,Sc,void 0);es(this,Cc,void 0);es(this,Ic,void 0);kt(this,wc,e),kt(this,Sc,t),kt(this,Cc,s),kt(this,Ic,i)}get type(){return At(this,wc)}get port(){return At(this,Sc)}get protocol(){return At(this,Cc)}get ids(){return At(this,Ic)}toString(){return this.type+" "+this.port+" "+this.protocol+" "+this.ids.join(" ")}}wc=new WeakMap,Sc=new WeakMap,Cc=new WeakMap,Ic=new WeakMap;var Lc,gr,go,fo;class L_{constructor(e,t){es(this,Lc,void 0);es(this,gr,void 0);es(this,go,void 0);es(this,fo,void 0);if(kt(this,Lc,e),typeof t=="string"){if(kt(this,gr,t),e==="m"){const s=t.split(" ");kt(this,go,new ty(s[0],s[1],s[2],s.slice(3)))}else if(e==="a"){const s=ug(t,":",1);t=s[0],kt(this,fo,s.length===1?new Gu(t,null):new Gu(t,s[1]))}}else t instanceof ty?(kt(this,go,t),kt(this,gr,t.toString())):t instanceof Gu&&(kt(this,fo,t),kt(this,gr,t.value?`${t.key}:${t.value}`:t.key))}get key(){return At(this,Lc)}get value(){return At(this,gr)}get parsed(){return At(this,fo)}get mediaLineParts(){return At(this,go)}toString(){return`${this.key}=${this.value}`}}Lc=new WeakMap,gr=new WeakMap,go=new WeakMap,fo=new WeakMap;var Mc,Pc,Ec,Pa,yo,vo;const Ia=class Ia{constructor(e,t,s=":",i=!1){es(this,Mc,void 0);es(this,Pc,void 0);es(this,Ec,void 0);es(this,Pa,void 0);es(this,yo,void 0);es(this,vo,void 0);kt(this,Mc,e),kt(this,Pc,t),kt(this,Ec,s),kt(this,yo,i),kt(this,Pa,i?new Map:null),kt(this,vo,i?[]:null)}get lines(){return At(this,Pc)}get value(){return At(this,yo)||!this.lines.length?null:this.lines[0]}get exists(){return!At(this,yo)}get key(){return At(this,Mc)}get keys(){return Ia.fill(this),At(this,vo)}forEach(e){Ia.fill(this),At(this,Pa).forEach(e)}get(e){return Ia.fill(this),At(this,Pa).get(e)||new Ia(e,[],":",!0)}static fill(e){if(At(e,Pa)!==null)return;const t=new Map;e.lines.forEach(i=>{const[n,a]=ug(i,At(e,Ec),1),r=t.get(n)||[];t.set(n,[...r,a||""])});const s=kt(e,Pa,Ia.makeAttributes(t));kt(e,vo,Array.from(s.keys()))}static makeAttributes(e){const t=new Map;return e.forEach((s,i)=>{t.set(i,new Ia(i,s))}),t}};Mc=new WeakMap,Pc=new WeakMap,Ec=new WeakMap,Pa=new WeakMap,yo=new WeakMap,vo=new WeakMap;let uh=Ia;var _c,bo;const _g=class _g{constructor(e){es(this,_c,void 0);es(this,bo,void 0);kt(this,_c,e),kt(this,bo,new Map),_g.fillAttributes(this)}get(e){return At(this,bo).get(e)||new uh(e,[]," ",!0)}static fillAttributes(e){const t=new Map;At(e,_c).forEach(s=>{if(s.key==="a"){const{key:i,value:n}=s.parsed;let a=t.get(i);a||(a=[],t.set(i,a)),a.push(n||"")}}),t.forEach((s,i)=>{At(e,bo).set(i,new uh(i,s," ",!1))})}};_c=new WeakMap,bo=new WeakMap;let $p=_g;var kc,wo,fr,yr;class Fw{constructor(e){es(this,kc,void 0);es(this,wo,void 0);es(this,fr,void 0);es(this,yr,void 0);kt(this,kc,e),kt(this,wo,e[0]),kt(this,fr,kt(this,yr,null))}get lines(){return At(this,kc)}get mediaLine(){return At(this,wo)}get mediaLineParts(){return At(this,wo).mediaLineParts}get mediaType(){return this.mediaLineParts.type}get direction(){if(!At(this,yr)){const e=this.attributes;let t;e.get("sendonly").exists?t="sendonly":e.get("recvonly").exists?t="recvonly":e.get("inactive").exists?t="inactive":t="sendrecv",kt(this,yr,t)}return At(this,yr)}get isSending(){return this.direction==="sendrecv"||this.direction==="sendonly"}get isReceiving(){return this.direction==="sendrecv"||this.direction==="recvonly"}get attributes(){return At(this,fr)||kt(this,fr,new $p(this.lines)),At(this,fr)}get mid(){return this.attributes.get("mid").value}lookupAttributeKeys(e){const t={};for(const s in e){const i=this.attributes.get(s),n=!e[s];i?t[s]=n?i.lines:i.value:t[s]=n?[]:void 0}return t}}kc=new WeakMap,wo=new WeakMap,fr=new WeakMap,yr=new WeakMap;var Tc,xc;class M_{constructor(e){es(this,Tc,void 0);es(this,xc,void 0);kt(this,Tc,e),kt(this,xc,e.filter(t=>t.key==="o").map(t=>t.value.split(" ")[1])[0])}get lines(){return At(this,Tc)}get sessionId(){return At(this,xc)}}Tc=new WeakMap,xc=new WeakMap;function ph(o){function e(){t?i.push(new Fw(s)):t=new M_(s)}let t=null,s=[];const i=[];return o.split(/\r?\n/).forEach(n=>{if(!P_(n)){const a=Il(n);a.key==="m"&&(e(),s=[]),s.push(a)}}),e(),new C_(t,i)}function P_(o){return/^[\s\xa0]*$/.test(o)}function Il(o){const e=ug(o,"=",1);return new L_(e[0],e[1])}function E_(o){let e;return o.media.forEach((t,s)=>{if(t.mediaType==="video"&&t.isSending&&!t.attributes.get("ssrc-group").get("SIM").exists){e||(e=new I_(2,4294967295));const i=t.attributes.get("ssrc-group").get("FID").value.split(" "),n=t.lines;i.forEach(c=>e.add(+c));const a=[i[0],e.generate(),e.generate()],r=[i[1],e.generate(),e.generate()];n.push(Il("a=ssrc-group:SIM "+a.join(" ")));const l=t.attributes.get("ssrc").get(i[0]).lines;a.forEach((c,d)=>{const h=r[d];d>0&&(n.push(Il("a=ssrc-group:FID "+c+" "+h)),l.forEach(u=>{n.push(Il("a=ssrc:"+c+" "+u))}),l.forEach(u=>{n.push(Il("a=ssrc:"+h+" "+u))}))}),o.media[s]=new Fw(n)}}),!!e}function __(o){const e=o.map(t=>{const[s,...i]=t.split(" ");return{_:"groupCallParticipantVideoSourceGroup",semantics:s,sources:i.map(a=>hg(+a))}});return e.length?e:void 0}function mh(o,e){const t=e.lookupAttributeKeys({"ice-ufrag":!0,"ice-pwd":!0,fingerprint:!0,setup:!0,ssrc:!0,mid:!0,"ssrc-group":!1});if(!t.fingerprint){const r=o.session.lines.find(l=>l.parsed?.key==="fingerprint");t.fingerprint=r.parsed.value}const s=__(t["ssrc-group"]),[i,n]=t.fingerprint.split(" ",2),a=t.ssrc&&hg(+t.ssrc.split(" ",1)[0]);return{raw:t,ufrag:t["ice-ufrag"],pwd:t["ice-pwd"],fingerprint:{fingerprint:n,setup:t.setup,hash:i},source:a,sourceGroups:s,mid:t.mid}}function k_(o){const{offer:e,data:t}=o,s=ph(e.sdp);let i=!1;if(o.skipAddingMulticast||(i=E_(s)||i),ii(s.media,(n,a,r)=>{if(n.isSending||n.mediaType==="application")return;const l=n.mediaLine,c=l.mediaLineParts;c.ids;const d=l.toString(),p=t[n.mediaType]["payload-types"].map(g=>""+g.id),m=Tw(n.mediaType,void 0,p);if(d!==m){const g=mh(s,n),f={...t};f.transport=Fi(f.transport),f.transport.ufrag=g.ufrag,f.transport.pwd=g.pwd,f.transport.fingerprints=[g.fingerprint],f.transport.candidates=[];const y=new ou(g.mid,c.type);y.setPort(c.port),g.source&&y.setSource(g.sourceGroups||g.source),y.setDirection(n.direction);const v=new ru().addSsrcEntry(y,f).finalize(),b=ph(v).media[0];r[a]=b,i=!0}}),i){const n=s.toString();e.sdp=n}return{offer:e,sdp:s}}function T_(o,e){const t=mh(o,e),s=e.mediaType,i={source:t.source,sourceGroups:t.sourceGroups,type:s};t.fingerprint.setup="active";const n={fingerprints:[t.fingerprint],pwd:t.pwd,ssrc:t.source,"ssrc-groups":t.sourceGroups||[],ufrag:t.ufrag};return{params:{_:"dataJSON",data:JSON.stringify(n)},source:t.source,media:e,sourceGroups:t.sourceGroups,entry:i}}class x_ extends Aw{constructor(e){super(e),this.negotiateThrottled=$n(this.negotiate.bind(this),0,!1)}createPeerConnection(){return this.connection||super.createPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",iceCandidatePoolSize:0})}createDataChannel(){if(this.dataChannel)return this.dataChannel;const e=super.createDataChannel();return e.addEventListener("open",()=>{this.maybeUpdateRemoteVideoConstraints()}),e.addEventListener("close",()=>{this.updateConstraintsInterval&&(clearInterval(this.updateConstraintsInterval),this.updateConstraintsInterval=void 0)}),e}createDescription(){return this.description?this.description:super.createDescription()}appendStreamToConference(){super.appendStreamToConference()}async invokeJoinGroupCall(e,t,s){const{groupCall:i,description:n}=this,a=i.id,r=t.map(f=>{const y=T_(e,f);return this.sources[y.entry.type]=y.entry,y}),l=r.find(f=>f.media.mediaType==="audio"),c=r.find(f=>f.media.mediaType==="video");let{source:d,params:h}=l||{};const u=c||l,p={audio:l,video:c};if(n.entries.forEach(f=>{if(f.direction==="sendonly"){const y=p[f.type];if(!y)return;n.setEntrySource(f,y.sourceGroups||y.source),n.setEntryPeerId(f,C.myId)}}),h!==u.params){const f=JSON.parse(u.params.data);d?f.ssrc=d:delete f.ssrc,h={_:"dataJSON",data:JSON.stringify(f)}}const m=await this.managers.appGroupCallsManager.joinGroupCall(a,h,s),g=JSON.parse(m.params.data);return g.audio=g.audio||i.connections.main.description.audio,n.setData(g),S_(t,g),g}async negotiateInternal(){const{connection:e,description:t}=this,s=e.iceConnectionState==="new"&&!t.getEntryByMid("0").source,i=this.log.bindPrefix("startNegotiation");i("start");const n=await e.createOffer({iceRestart:!1});s&&this.dataChannel&&t.createEntry("application").setDirection("sendrecv");const{sdp:a,offer:r}=k_({offer:n,data:t});i("[sdp] setLocalDescription",r.sdp),await e.setLocalDescription(r);const l=a.media.filter(m=>m.mediaType!=="application"&&m.isSending);if(s)try{await this.invokeJoinGroupCall(a,l,this.options)}catch(m){this.log.error("[tdweb] joinGroupCall error",m)}const c=!0,d=[],h=a.bundle;ii(h,(m,g,f)=>{const y=t.getEntryByMid(m);y.shouldBeSkipped(c)&&(f.splice(g,1),d.push(y))});const u=a.media.map(m=>{const g=m.mid;let f=t.getEntryByMid(g);return f||(f=new ou(g,m.mediaType),f.setDirection("inactive")),f}),p={type:"answer",sdp:t.generateSdp({bundle:h,entries:u,isAnswer:c})};d.forEach(m=>{t.deleteEntry(m)}),i(`[sdp] setRemoteDescription signaling=${e.signalingState} ice=${e.iceConnectionState} gathering=${e.iceGatheringState} connection=${e.connectionState}`,p.sdp),await e.setRemoteDescription(p),i("end")}negotiate(){let e=this.negotiating;return e||(e=super.negotiate(),this.updateConstraints&&e.then(()=>{this.maybeUpdateRemoteVideoConstraints(),this.updateConstraints=!1}),this.options.type==="presentation"&&e.then(()=>{this.connection.getTransceivers().find(t=>{t.sender?.track?.kind==="video"&&t.sender.setParameters({...t.sender.getParameters(),degradationPreference:"maintain-resolution"})})}),e)}maybeUpdateRemoteVideoConstraints(){if(this.dataChannel.readyState!=="open")return;this.log("maybeUpdateRemoteVideoConstraints");const e={colibriClass:"ReceiverVideoConstraints",constraints:{},defaultConstraints:{maxHeight:0},onStageEndpoints:[]};for(const t of this.description.entries){if(t.direction!=="recvonly"||t.type!=="video")continue;const{endpoint:s}=t;e.onStageEndpoints.push(s),e.constraints[s]={minHeight:180,maxHeight:720}}this.sendDataChannelData(e),e.onStageEndpoints.length?this.updateConstraintsInterval||(this.updateConstraintsInterval=window.setInterval(this.maybeUpdateRemoteVideoConstraints.bind(this),5e3)):this.updateConstraintsInterval&&(clearInterval(this.updateConstraintsInterval),this.updateConstraintsInterval=void 0)}addInputVideoStream(e){this.groupCall.saveInputVideoStream(e,this.type),this.streamManager.addStream(e,"input"),this.appendStreamToConference()}}var ts=(o=>(o[o.UNMUTED=0]="UNMUTED",o[o.MUTED=1]="MUTED",o[o.MUTED_BY_ADMIN=2]="MUTED_BY_ADMIN",o[o.CONNECTING=3]="CONNECTING",o[o.CLOSED=4]="CLOSED",o))(ts||{});class tr extends xw{constructor(e){super(),Lt(this,e),this.log||(this.log=zs("GROUP-CALL")),this.connections||(this.connections={}),this.isSpeakingMap||(this.isSpeakingMap=new Map),this.pinnedSources=[],this.participantsSsrcs=new Map,this.hadAutoPinnedSources=new Set,this.dispatchPinnedThrottled=$n(()=>{this.dispatchEvent("pinned",this.pinnedSource)},0,!1),this.addEventListener("state",t=>{t===ts.CLOSED&&this.cleanup()})}get connectionState(){return this.connections.main.connection.iceConnectionState}get state(){const{connectionState:e}=this;if(e==="closed")return ts.CLOSED;if(e!=="connected"&&(!Yi||e!=="completed"))return ts.CONNECTING;{const{participant:t}=this;return t.pFlags.can_self_unmute?t.pFlags.muted?ts.MUTED:ts.UNMUTED:ts.MUTED_BY_ADMIN}}get participants(){return this.managers.appGroupCallsManager.getCachedParticipants(this.id)}get isSharingScreen(){return!!this.connections.presentation}get pinnedSource(){return this.pinnedSources[this.pinnedSources.length-1]}get isMuted(){return this.state!==ts.UNMUTED}get isClosing(){const{state:e}=this;return e===ts.CLOSED}get streamManager(){return this.connections.main.streamManager}get description(){return this.connections.main.description}pinSource(e){cs(this.pinnedSources,e),this.pinnedSources.push(e),this.dispatchPinnedThrottled()}unpinSource(e){this.hadAutoPinnedSources.delete(e),cs(this.pinnedSources,e),this.dispatchPinnedThrottled()}unpinAll(){this.pinnedSources.length=0,this.dispatchPinnedThrottled()}async getParticipantByPeerId(e){return Vt===e?this.participant:(await this.participants).get(e)}toggleMuted(){return this.requestAudioSource(!0).then(()=>this.changeUserMuted(Vt))}async changeUserMuted(e,t){const s=await this.getParticipantByPeerId(e);return Vt===e&&s.pFlags.can_self_unmute&&(t=t===void 0?!s.pFlags.muted:t),this.editParticipant(s,{muted:t})}getElement(e){return super.getElement(e)}getVideoElementFromParticipantByType(e,t){let s;e.pFlags.self?s=t==="video"?"main":"presentation":s=e[t].source_groups[0].sources[0];const i=this.getElement(s);if(!i)return;const n=i.cloneNode();return n.srcObject=i.srcObject,{video:n,source:s}}createConnectionInstance(e){return this.connections[e.type]=new x_({groupCall:this,log:this.log.bindPrefix(e.type),managers:this.managers,...e})}changeRaiseHand(e){return this.editParticipant(this.participant,{raiseHand:e})}async startScreenSharingInternal(){try{const e="presentation",t=await Mw(Lw()),s=new Er,i=this.createConnectionInstance({streamManager:s,type:e,options:{type:e}});i.createPeerConnection().addEventListener("negotiationneeded",()=>{i.negotiate()}),t.getVideoTracks()[0].addEventListener("ended",()=>{this.connections.presentation&&this.stopScreenSharing()},{once:!0}),i.createDescription(),i.addInputVideoStream(t)}catch(e){this.log.error("start screen sharing error",e)}}startScreenSharing(){return this.startScreenSharingPromise??(this.startScreenSharingPromise=this.startScreenSharingInternal().finally(()=>{this.startScreenSharingPromise=void 0}))}stopScreenSharing(){const e=this.connections.presentation;return e?(delete this.connections.presentation,this.unpinSource("presentation"),e.closeConnectionAndStream(!0),delete this.participant.presentation,this.managers.appGroupCallsManager.saveApiParticipant(this.id,this.participant),this.managers.appGroupCallsManager.leaveGroupCallPresentation(this.id)):Promise.resolve()}toggleScreenSharing(){return this.isSharingScreen?this.stopScreenSharing():this.startScreenSharing()}async startVideoSharingInternal(){const e={video:dg()};try{const t=await iu(e,!1);this.connections.main.addInputVideoStream(t),await this.editParticipant(this.participant,{videoPaused:!1,videoStopped:!1})}catch(t){this.log.error("startVideoSharing error",t,e)}}startVideoSharing(){return this.startVideoSharingPromise??(this.startVideoSharingPromise=this.startVideoSharingInternal().finally(()=>{this.startVideoSharingPromise=void 0}))}async stopVideoSharing(){const e=this.connections.main,t=e.streamManager.inputStream.getVideoTracks()[0];t&&(nu(t),e.streamManager.appendToConference(e.description),await this.editParticipant(this.participant,{videoStopped:!0}))}toggleVideoSharing(){return this.isSharingVideo?this.stopVideoSharing():this.startVideoSharing()}async hangUp(e=!1,t=!1,s=!1){for(const i in this.connections)this.connections[i].closeConnectionAndStream(!t);if(this.dispatchEvent("state",this.state),!s&&!t){const i=e||(this.joined?this.connections.main.sources.audio.source:void 0);this.managers.appGroupCallsManager.hangUp(this.id,i)}}tryAddTrack(e){const{description:t}=this,s=super.tryAddTrack(e);if(e.type==="output"){const i=t.getEntryBySource(+s);this.getParticipantByPeerId(i.peerId).then(n=>{n&&C.dispatchEvent("group_call_participant",{groupCallId:this.id,participant:n})})}return s}async editParticipant(e,t){if(Object.keys(t).length){if(e){const s=e.pFlags.self;if(s&&t.muted!==void 0&&!this.isSharingAudio&&(delete t.muted,!Object.keys(t).length))return;const i=t.muted;i!==void 0&&e.pFlags.self&&(i?e.pFlags.muted=!0:e.pFlags.can_self_unmute&&delete e.pFlags.muted),t.raiseHand!==void 0&&(t.raiseHand?e.raise_hand_rating="1":delete e.raise_hand_rating),s&&(t.videoStopped!==void 0&&(t.videoStopped?delete e.video:e.video=D_(this.connections.main.sources.video)),!e.pFlags.muted&&e.pFlags.can_self_unmute&&this.setMuted(!1),this.dispatchEvent("state",this.state))}return this.managers.appGroupCallsManager.editParticipant(this.id,e,t)}}onParticipantUpdate(e,t){const s=this.connections.main,{connection:i,description:n}=s,a=Je(e.peer),r=!!e.pFlags.left,l=this.participantsSsrcs.get(a)||[];if(e.presentation&&!r){const{source:h}=Xr(e,"video",e.presentation.source_groups,e.presentation.endpoint);this.hadAutoPinnedSources.has(h)||(this.hadAutoPinnedSources.add(h),this.pinSource(e.pFlags.self?"presentation":h))}if(e.pFlags.self){this.participant=e,s.sources.audio.source!==e.source&&this.hangUp();let h=!1;e.pFlags.can_self_unmute?e.pFlags.muted&&(h=!0):(this.stopScreenSharing(),this.stopVideoSharing(),h=!0),h&&this.setMuted(!0),t!==a&&this.dispatchEvent("state",this.state);return}const c=r?[]:R_(e);r?this.participantsSsrcs.delete(a):this.participantsSsrcs.set(a,c);const d=new Set;l.forEach(h=>{const u=h.source;if(!c.find(m=>m.source===u)){this.unpinSource(u);const m=n.getEntryBySource(u);m&&m.direction!=="inactive"&&(m.setDirection("inactive"),d.add(m.type))}}),c.forEach(h=>{let u=n.getEntryBySource(h.source);if(u){u.direction==="inactive"&&(u.setDirection(u.originalDirection),d.add(u.type));return}u=n.createEntry(h.type),n.setEntrySource(u,h.sourceGroups||h.source),n.setEntryPeerId(u,a),h.type==="video"&&u.setEndpoint(h.endpoint),u.createTransceiver(i,{direction:"recvonly"}),d.add(u.type)}),d.size&&(d.has("video")&&(s.updateConstraints=!0),s.negotiateThrottled())}}async function A_(o,e){const t={audio:Iw(),video:e&&dg()},s=new Er(Ew);try{const i=await iu(t,o);s.addStream(i,"input")}catch(i){console.error("joinGroupCall getStream error",i,t),s.inputStream=new MediaStream}return s}const F_=!0;function R_(o){return[Xr(o,"audio",o.source),o.video?.audio_source&&Xr(o,"audio",o.video.audio_source),o.video&&Xr(o,"video",o.video.source_groups,o.video.endpoint),o.presentation?.audio_source&&Xr(o,"audio",o.presentation.audio_source),o.presentation&&Xr(o,"video",o.presentation.source_groups,o.presentation.endpoint)].filter(Boolean)}function Xr(o,e,t,s){return Nd(e,t,s)}function D_(o,e){return o&&{_:"groupCallParticipantVideo",pFlags:{},endpoint:"",source_groups:o.sourceGroups,audio_source:e}}class B_ extends vi{construct(e){this.managers=e,this.audioAsset=u_(),this.log=zs("GCC"),C.addEventListener("group_call_update",t=>{const{currentGroupCall:s}=this;s?.id===t.id&&(s.groupCall=t,t._==="groupCallDiscarded"&&s.hangUp(!1,!1,!0))}),C.addEventListener("group_call_participant",({groupCallId:t,participant:s})=>{const{currentGroupCall:i}=this;i?.id===t&&i.onParticipantUpdate(s)})}get groupCall(){return this.currentGroupCall}setCurrentGroupCall(e){this.currentGroupCall=e,e&&this.dispatchEvent("instance",e)}startConnectingSound(){this.stopConnectingSound(),this.audioAsset.playSoundWithTimeout("group_call_connect.mp3",!0,2500)}stopConnectingSound(){this.audioAsset.stopSound(),this.audioAsset.cancelDelayedPlay()}async joinGroupCall(e,t,s=F_,i,n){this.audioAsset.createAudio(),this.log(`joinGroupCall chatId=${e} id=${t} muted=${s} rejoin=${i}`);let a;return i?a=this.currentGroupCall.connections.main.streamManager:a=await A_(s,n),this.joinGroupCallInternal(e,t,a,s,i,n).then(()=>{const{currentGroupCall:r}=this;r.participants.then(l=>{this.currentGroupCall!==r||r.state===ts.CLOSED||l.forEach(c=>{c.pFlags.self||r.onParticipantUpdate(c)})})})}async joinGroupCallInternal(e,t,s,i,n=!1,a){const r=this.log.bindPrefix("joinGroupCallInternal");r("start",t);const l="main";let{currentGroupCall:c}=this;if(c&&n)c.handleUpdateGroupCallParticipants=!1,c.updatingSdp=!1,r("update currentGroupCall",t,c);else{c=new tr({chatId:e,id:t,managers:this.managers}),c.fixSafariAudio(),c.addEventListener("state",u=>{this.currentGroupCall===c&&u===ts.CLOSED&&(this.setCurrentGroupCall(null),this.stopConnectingSound(),this.audioAsset.playSound("group_call_end.mp3"),C.dispatchEvent("chat_update",c.chatId))}),c.groupCall=await this.managers.appGroupCallsManager.getGroupCallFull(t);const d=c.createConnectionInstance({streamManager:s,type:l,options:{type:l,isMuted:i,joinVideo:a,rejoin:n}}),h=d.createPeerConnection();return h.addEventListener("negotiationneeded",()=>{d.negotiate()}),h.addEventListener("track",u=>{r("ontrack",u),c.onTrack(u)}),h.addEventListener("iceconnectionstatechange",()=>{c.dispatchEvent("state",c.state);const{iceConnectionState:u}=h;switch(u==="disconnected"||u==="checking"||u==="new"?this.startConnectingSound():this.stopConnectingSound(),u){case"checking":break;case"closed":{c.hangUp();break}case"completed":break;case"connected":{c.joined||(c.joined=!0,this.audioAsset.playSound("group_call_start.mp3"),this.managers.appGroupCallsManager.getGroupCallParticipants(t));break}case"disconnected":break;case"failed":{c.hangUp();break}}}),d.createDescription(),d.createDataChannel(),d.appendStreamToConference(),this.setCurrentGroupCall(c),r("set currentGroupCall",t,c),this.startConnectingSound(),d.negotiate()}}}const Sn=new B_;Gs&&(Gs.groupCallController=Sn);class N_ extends su{constructor(e,t,s){super({topbar:e,chat:t,listenerSetter:e.listenerSetter,className:"requests",divAndCaption:new Yh("pinned-requests",i=>{}),onClose:()=>{fe.getState().then(i=>{i.hideChatJoinRequests[this.peerId]=Date.now(),this.managers.appStateManager.pushToState("hideChatJoinRequests",i.hideChatJoinRequests)})},floating:!0}),this.topbar=e,this.chat=t,this.managers=s,D(this.wrapper,async i=>{if(X(i),ss.isTabExists(Mp))return;await ss.createTab(Mp).open(this.chat.peerId.toChatId()),ss.toggleSidebar(!0)},{listenerSetter:this.topbar.listenerSetter}),this.divAndCaption.border.remove(),this.divAndCaption.content.remove(),this.titleElement=new De.IntlElement({key:"Chat.Header.RequestToJoin",args:[0],element:this.divAndCaption.title})}unset(e){this.peerId=e,this.stackedAvatars&&(this.stackedAvatars.container.remove(),this.stackedAvatarsMiddlewareHelper.destroy()),this.toggle(!0)}async set(e,t,s){if(!t.length)return()=>this.unset(e);const i=this.stackedAvatars,n=this.stackedAvatarsMiddlewareHelper;this.stackedAvatarsMiddlewareHelper=Gt();const a=this.stackedAvatars=new Wo({avatarSize:32,middleware:this.stackedAvatarsMiddlewareHelper.get()}),r=[];return a.render(t,r),await Promise.all(r),()=>{this.peerId=e,this.titleElement.compareAndUpdate({args:[s]}),this.wrapperUtils.before(a.container,this.titleElement.element),i&&(i.container.remove(),n?.destroy()),this.toggle(!1)}}setPeerId(e){return Promise.all([this.chat.managers.acknowledged.appProfileManager.getProfileByPeerId(e),fe.getState()]).then(([t,s])=>({cached:t.cached,result:Xs(t.result,i=>{const n=i?.recent_requesters;return n&&(!s.hideChatJoinRequests[e]||Date.now()-s.hideChatJoinRequests[e]>=pm)?this.set(e,n.slice(0,3).map(a=>a.toPeerId(!1)),i.requests_pending):this.set(e,[],0)})}))}destroy(){}}class O_ extends su{constructor(e,t,s){super({topbar:e,chat:t,listenerSetter:e.listenerSetter,className:"actions",divAndCaption:new Yh("pinned-actions",n=>{}),onClose:()=>{this.managers.appProfileManager.hidePeerSettingsBar(this.peerId)},floating:!0}),this.topbar=e,this.chat=t,this.managers=s,this.wrapper.firstElementChild.remove(),this.divAndCaption.border.remove(),this.divAndCaption.content.remove(),((n,a)=>{D(n,r=>{X(r),a(r)},{listenerSetter:this.topbar.listenerSetter})})(this.wrapper,n=>{const a=U(n.target,"pinned-actions-button");if(!a)return;const r=a.dataset.key;this.actions.find(c=>c.key===r).onClick()}),this.actions=[{key:"autoarchived",onClick:async()=>{const n=this.managers.appMessagesManager.editPeerFolders([this.peerId],0);this.freeze(n)}},{key:"block_contact",onClick:()=>{this.chat.topbar.blockUser(this.filteredActions.some(n=>n.key==="report_spam"),!0,n=>{this.freeze(n)})},danger:!0},{key:"add_contact",onClick:()=>{this.chat.topbar.addContact()}},{key:"report_spam",onClick:async()=>{const n=this.peerId;if(n.isUser())this.actions.find(a=>a.key==="block_contact").onClick();else{await ft({titleLangKey:"Chat.Confirm.ReportSpam.Header",descriptionLangKey:this.managers.appPeersManager.isBroadcast(n)?"Chat.Confirm.ReportSpam.Channel":"Chat.Confirm.ReportSpam.Group",button:{langKey:"ReportChat"}});const a=Promise.all([this.managers.appMessagesManager.reportSpam(n),this.managers.appChatsManager.leave(n.toChatId())]);this.freeze(a)}},danger:!0}]}async freeze(e){this.wrapper.classList.add("is-disabled");try{await e}catch{}this.wrapper.classList.remove("is-disabled")}unset(e){this.peerId=e,this.toggle(!0)}set(e,t){const s=t?.pFlags?this.actions.filter(i=>t.pFlags[i.key]):[];return s.length?()=>{this.peerId=e,this.filteredActions=s;const i={add_contact:"AddContact",autoarchived:"Unarchive",block_contact:"BlockUser",report_spam:"DeleteReportSpam"},n=[];for(let a=0,r=Math.min(2,s.length);a<r;++a){const l=s[a],c=document.createElement("div");c.classList.add("pinned-actions-button",l.danger?"danger":"primary"),r>1&&c.classList.add("half",a===0?"is-first":"is-last"),c.dataset.key=l.key,n.push(c);const d=_(i[l.key]);d.classList.add("pinned-actions-button-text"),pi(c),c.append(d)}this.wrapper.replaceChildren(...n,this.wrapperUtils),this.toggle(!1)}:()=>this.unset(e)}setPeerId(e){return Promise.all([this.chat.managers.acknowledged.appProfileManager.getPeerSettings(e)]).then(([t])=>({cached:t.cached,result:Xs(t.result,s=>this.set(e,s))}))}destroy(){}}function hc(o,e){tt(o,e),o.classList.toggle("is-badge-empty",!e)}const U_=!1;class H_{constructor(e,t,s){this.chat=e,this.appSidebarRight=t,this.managers=s,this.verifyButtons=i=>{const n=!!i||!!(this.btnMore&&this.btnMore.classList.contains("menu-open"));i&&X(i),(async()=>{const r=this.buttonsToVerify.concat(n?this.menuButtons:[]);(await Promise.all(r.map(async c=>({result:await c.verify(),button:c})))).forEach(({button:c,result:d})=>{c.element.classList.toggle("hide",!d)})})()},this.verifyVideoChatButton=async i=>{if(!$l||this.peerId.isUser()||this.chat.type!==Q.Chat||this.chat.threadId)return!1;const n=Sn.groupCall,a=this.peerId.toChatId();if(n?.chatId===a||i&&(await this.managers.appPeersManager.isBroadcast(this.peerId)&&i==="group"||await this.managers.appPeersManager.isAnyGroup(this.peerId)&&i==="broadcast"))return!1;const r=fe.getChat(a);return r.pFlags?.call_active||zn(r,"manage_call")},this.verifyCallButton=async i=>{if(!Gl||!this.peerId.isUser()||this.chat.type!==Q.Chat)return!1;const n=this.peerId.toUserId(),a=await this.managers.appProfileManager.getCachedFullUser(n);return!!a&&!!(i==="voice"?a.pFlags.phone_calls_available:a.pFlags.video_calls_available)},this.onJoinGroupCallClick=()=>{this.chat.appImManager.joinGroupCall(this.peerId)},this.onJoinClick=async i=>{const n=this.chat.bubbles.getMiddleware();i.setAttribute("disabled","true");const a=this.peerId.toChatId();let r;await this.managers.appChatsManager.isChannel(a)?r=this.managers.appChatsManager.joinChannel(a):r=this.managers.appChatsManager.addChatUser(a,C.myId),r.catch(l=>{switch(l.type){case"INVITE_REQUEST_SENT":{Re({langPackKey:"Chat.SendJoinRequest.Info"});return}}throw l}).finally(()=>{n()&&i.removeAttribute("disabled")})},this.onMuteClick=()=>{J.createPopup(xv,this.peerId)},this.onUnmuteClick=()=>{this.managers.appMessagesManager.togglePeerMute({peerId:this.peerId,threadId:this.chat.threadId})},this.onResize=()=>{this.setUtilsWidth(!0),this.setFloating()},this.onChangeScreen=(i,n)=>{const a=n===ei.mobile||U_;this.container.classList.toggle("is-pinned-floating",Fe.isMobile||a),this.pinnedMessage&&this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.classList.toggle("is-floating",a),this.onResize()},this.setUtilsWidth=(i=!1)=>{this.setUtilsRAF&&window.cancelAnimationFrame(this.setUtilsRAF),Yi&&i&&this.chatUtils.classList.add("hide"),this.setUtilsRAF=window.requestAnimationFrame(()=>{Yi&&i&&this.chatUtils.classList.remove("hide");const n=this.chatUtils.getBoundingClientRect().width;this.chat.log("utils width:",n),this.container.style.setProperty("--utils-width",n+"px"),this.setUtilsRAF=0})},this.setFloating=()=>{const n=[this.chatAudio,this.chatRequests,this.chatActions,this.pinnedMessage?.pinnedMessageContainer].filter(Boolean).reduce((a,r)=>{const l=r.isFloating();return this.container.classList.toggle(`is-pinned-${r.className}-floating`,l),r.isVisible()?a+ +l:a},0);this.container.dataset.floating=""+n},this.listenerSetter=new Qt,this.menuButtons=[],this.buttonsToVerify=[]}construct(){this.container=document.createElement("div"),this.container.classList.add("sidebar-header","topbar","hide"),this.container.dataset.floating="0",this.btnBack=Xe("left sidebar-close-button",{noRipple:!0}),this.btnBackBadge=Ao("span",20,"primary"),this.btnBackBadge.classList.add("back-unread-badge"),this.btnBack.append(this.btnBackBadge),this.chatInfoContainer=document.createElement("div"),this.chatInfoContainer.classList.add("chat-info-container"),this.chatInfo=document.createElement("div"),this.chatInfo.classList.add("chat-info");const e=this.person=document.createElement("div");e.classList.add("person");const t=document.createElement("div");t.classList.add("content");const s=document.createElement("div");s.classList.add("top"),this.title=document.createElement("div"),this.title.classList.add("user-title"),s.append(this.title);const i=document.createElement("div");i.classList.add("bottom"),this.subtitle&&i.append(this.subtitle),t.append(s,i),e.append(t),this.chatInfo.append(e),this.chatUtils=document.createElement("div"),this.chatUtils.classList.add("chat-utils"),this.chatAudio=new r_(this,this.chat,this.managers),this.chatRequests=new N_(this,this.chat,this.managers),this.chatActions=new O_(this,this.chat,this.managers),this.menuButtons.length&&(this.btnMore=yi({listenerSetter:this.listenerSetter,direction:"bottom-left",buttons:this.menuButtons,onOpen:async(a,r)=>{const l=this.menuButtons[this.menuButtons.length-1];if(l?.element){const c=await this.managers.appPeersManager.getDeleteButtonText(this.peerId);l.element.lastChild.replaceWith(_(c))}}})),this.chatUtils.append(...[this.btnJoin,this.btnPinned,this.btnCall,this.btnGroupCall,this.btnMute,this.btnSearch,this.btnMore].filter(Boolean)),this.pushButtonToVerify(this.btnCall,this.verifyCallButton.bind(this,"voice")),this.pushButtonToVerify(this.btnGroupCall,this.verifyVideoChatButton),this.chatInfoContainer.append(this.btnBack,this.chatInfo,this.chatUtils),this.container.append(this.chatInfoContainer),this.pinnedMessage&&this.appendPinnedMessage(this.pinnedMessage),this.chatAudio&&this.container.append(this.chatAudio.divAndCaption.container),this.chatRequests&&this.container.append(this.chatRequests.divAndCaption.container),this.chatActions&&this.container.append(this.chatActions.divAndCaption.container),this.listenerSetter.add(window)("resize",this.onResize),this.listenerSetter.add(Fe)("changeScreen",this.onChangeScreen),D(this.container,a=>{if(U(a.target,"topbar-search-container")||!a.target.isConnected)return;const r=U(a.target,"pinned-container");if(un(),r){if(X(a),U(a.target,"progress-line")||U(a.target,"pinned-container-wrapper-utils"))return;const l=+r.dataset.mid;if(r.classList.contains("pinned-message"))this.pinnedMessage.followPinnedMessage(l);else if(r.dataset.peerId){const c=r.dataset.peerId.toPeerId(),d=lt.getSearchContext();this.chat.appImManager.setInnerPeer({peerId:c,lastMsgId:l,type:d.isScheduled?Q.Scheduled:void 0,threadId:d.threadId})}}else{const l=jl(a.target);if(Fe.activeScreen===ei.medium&&document.body.classList.contains(Rl))n();else if(l){if(l.classList.contains("has-stories"))return;this.appSidebarRight.toggleSidebar(!document.body.classList.contains(pc))}else this.appSidebarRight.toggleSidebar(!0)}},{listenerSetter:this.listenerSetter});const n=a=>{if(a&&X(a),Fe.activeScreen===ei.medium&&document.body.classList.contains(Rl))this.chat.appImManager.setPeer({peerId:this.peerId});else{const r=this.chat.appImManager.chats.indexOf(this.chat)===0;dt.back(r?"im":"chat")}};D(this.btnBack,n,{listenerSetter:this.listenerSetter})}pushButtonToVerify(e,t){e&&this.buttonsToVerify.push({element:e,verify:t})}constructUtils(){this.menuButtons=[{icon:"search",text:"Search",onClick:()=>{this.chat.initSearch()},verify:()=>Fe.isMobile},{icon:"mute",text:"ChatList.Context.Mute",onClick:this.onMuteClick,verify:async()=>this.chat.type===Q.Chat&&C.myId!==this.peerId&&!await this.managers.appNotificationsManager.isPeerLocalMuted({peerId:this.peerId,respectType:!1,threadId:this.chat.threadId})},{icon:"unmute",text:"ChatList.Context.Unmute",onClick:this.onUnmuteClick,verify:()=>this.chat.type===Q.Chat&&C.myId!==this.peerId&&this.managers.appNotificationsManager.isPeerLocalMuted({peerId:this.peerId,respectType:!1,threadId:this.chat.threadId})},{icon:"comments",text:"ViewDiscussion",onClick:()=>{const e=this.chat.bubbles.getMiddleware();Promise.resolve(this.managers.appProfileManager.getChannelFull(this.peerId.toChatId())).then(t=>{e()&&t.linked_chat_id&&this.chat.appImManager.setInnerPeer({peerId:t.linked_chat_id.toPeerId(!0)})})},verify:async()=>{const e=await this.managers.appProfileManager.getCachedFullChat(this.peerId.toChatId());return this.chat.type===Q.Chat&&!!e?.linked_chat_id}},{icon:"phone",text:"Call",onClick:this.onCallClick.bind(this,"voice"),verify:this.verifyCallButton.bind(this,"voice")},{icon:"videocamera",text:"VideoCall",onClick:this.onCallClick.bind(this,"video"),verify:this.verifyCallButton.bind(this,"video")},{icon:"videochat",text:"PeerInfo.Action.LiveStream",onClick:this.onJoinGroupCallClick,verify:this.verifyVideoChatButton.bind(this,"broadcast")},{icon:"videochat",text:"PeerInfo.Action.VoiceChat",onClick:this.onJoinGroupCallClick,verify:this.verifyVideoChatButton.bind(this,"group")},{icon:"topics",text:"TopicViewAsTopics",onClick:()=>{this.chat.appImManager.toggleViewAsMessages(this.peerId,!1)},verify:async()=>{const e=await this.managers.appMessagesManager.getDialogOnly(this.peerId);return!!(e&&e.pFlags.view_forum_as_messages)}},{icon:"topics",text:"SavedViewAsChats",onClick:()=>{this.chat.appImManager.toggleViewAsMessages(this.peerId,!1)},verify:()=>this.peerId===C.myId&&!this.chat.threadId&&!Hl.settings.savedAsForum},{icon:"select",text:"Chat.Menu.SelectMessages",onClick:()=>{const e=this.chat.selection;e.toggleSelection(!0,!0),fe.getState().then(t=>{if(t.chatContextMenuHintWasShown)return;const s=e.toggleByElement.bind(e);e.toggleByElement=async i=>{this.managers.appStateManager.pushToState("chatContextMenuHintWasShown",!0),Rs(_("Chat.Menu.Hint")),e.toggleByElement=s,e.toggleByElement(i)}})},verify:()=>!this.chat.selection.isSelecting&&!!this.chat.bubbles.getRenderedLength()},{icon:"select",text:"Chat.Menu.ClearSelection",onClick:()=>{this.chat.selection.cancelSelection()},verify:()=>this.chat.selection.isSelecting},{icon:"adduser",text:"AddContact",onClick:()=>{this.addContact()},verify:async()=>this.peerId.isUser()&&!await this.managers.appPeersManager.isContact(this.peerId)},{icon:"forward",text:"ShareContact",onClick:()=>{const e=this.peerId;_s.createSharingPicker({onSelect:t=>new Promise((s,i)=>{J.createPopup(ms,"",{titleLangKey:"SendMessageTitle",descriptionLangKey:"SendContactToGroupText",descriptionLangArgs:[new Mt({peerId:t,dialog:!0}).element],buttons:[{langKey:"Send",callback:()=>{s(),this.managers.appMessagesManager.sendContact(t,e),this.chat.appImManager.setInnerPeer({peerId:t})}},{langKey:"Cancel",callback:()=>{i()},isCancel:!0}],peerId:t,overlayClosable:!0}).show()})})},verify:async()=>C.myId!==this.peerId&&this.peerId.isUser()&&await this.managers.appPeersManager.isContact(this.peerId)&&!!(await this.managers.appUsersManager.getUser(this.peerId.toUserId())).phone},{icon:"gift",text:"GiftPremium",onClick:()=>this.chat.appImManager.giftPremium(this.peerId),verify:()=>this.chat.canGiftPremium()},{icon:"statistics",text:"Statistics",onClick:()=>{this.appSidebarRight.createTab(Kc).open(this.peerId.toChatId()),this.appSidebarRight.toggleSidebar(!0)},verify:()=>this.managers.appProfileManager.canViewStatistics(this.peerId)},{icon:"addboost",text:"Boosts",onClick:()=>{this.appSidebarRight.createTab(bE).open(this.peerId),this.appSidebarRight.toggleSidebar(!0)},verify:()=>this.chat.isBroadcast&&this.managers.appProfileManager.canViewStatistics(this.peerId)},{icon:"bots",text:"Settings",onClick:()=>{this.managers.appMessagesManager.sendText({peerId:this.peerId,text:"/settings"})},verify:async()=>{try{return!!(await this.managers.appAttachMenuBotsManager.getAttachMenuBot(this.peerId.toUserId()))?.pFlags?.has_settings}catch{return!1}}},{icon:"lock",text:"BlockUser",onClick:()=>{this.blockUser()},verify:async()=>{if(!this.peerId.isUser())return!1;const e=await this.managers.appProfileManager.getCachedFullUser(this.peerId.toUserId());return this.peerId!==C.myId&&e&&!e.pFlags?.blocked}},{icon:"lockoff",text:"Unblock",onClick:()=>{this.managers.appUsersManager.toggleBlock(this.peerId,!1).then(()=>{Re({langPackKey:"UserUnblocked"})})},verify:async()=>!!(await this.managers.appProfileManager.getCachedFullUser(this.peerId.toUserId()))?.pFlags?.blocked},{icon:"delete",danger:!0,text:"Delete",onClick:()=>{J.createPopup(Bh,this.peerId,void 0,void 0,this.chat.threadId)},verify:async()=>this.chat.type===Q.Saved||this.chat.type===Q.Chat&&!!await this.managers.appMessagesManager.getDialogOnly(this.peerId)}],this.btnSearch=Xe("search"),this.attachClickEvent(this.btnSearch,e=>{this.chat.initSearch()},!0)}addContact(){if(!this.appSidebarRight.isTabExists(Pp)){const e=this.appSidebarRight.createTab(Pp);e.peerId=this.peerId,e.open(),this.appSidebarRight.toggleSidebar(!0)}}async blockUser(e,t,s){const i=this.peerId,n=[e&&{text:"DeleteReportSpam",checked:!0},t&&{text:"DeleteThisChat",checked:!0}],a=await ft({peerId:i,titleLangKey:"BlockUser",descriptionLangKey:"AreYouSureBlockContact2",descriptionLangArgs:[new Mt({peerId:i}).element],button:{langKey:"BlockUser",isDanger:!0},checkboxes:n.filter(Boolean)}),[r,l]=Array.isArray(a)?a:[],c=Promise.all([r&&this.managers.appMessagesManager.reportSpam(i),l&&this.managers.appMessagesManager.flushHistory(i,!1,!0),this.managers.appUsersManager.toggleBlock(i,!0)]);s?.(c),await c,Re({langPackKey:"UserBlocked"})}attachClickEvent(e,t,s){D(e,i=>{X(i),!s&&un(),t(i)},{listenerSetter:this.listenerSetter})}onCallClick(e){this.chat.appImManager.callUser(this.peerId.toUserId(),e)}get peerId(){return this.chat.peerId}constructPeerHelpers(){return this.subtitle=document.createElement("div"),this.subtitle.classList.add("info"),this.pinnedMessage=new hh(this,this.chat,this.managers),this.btnJoin=Ve("btn-primary btn-color-primary chat-join hide"),this.btnCall=Xe("phone"),this.btnGroupCall=Xe("videochat"),this.btnPinned=Xe("pinlist chat-pinlist"),this.btnMute=Xe("mute"),this.attachClickEvent(this.btnCall,this.onCallClick.bind(this,"voice")),this.attachClickEvent(this.btnGroupCall,this.onJoinGroupCallClick),this.attachClickEvent(this.btnPinned,()=>{this.openPinned(!0)}),this.attachClickEvent(this.btnMute,()=>{!!+this.btnMute.dataset.muted?this.onUnmuteClick():this.onMuteClick()}),this.attachClickEvent(this.btnJoin,this.onJoinClick.bind(this,this.btnJoin)),this.listenerSetter.add(C)("folder_unread",e=>{if(e.id!==ai)return;const t=e.unreadUnmutedPeerIds.size;hc(this.btnBackBadge,t?""+Ri(t,1):"")}),this.listenerSetter.add(C)("chat_update",e=>{if(this.peerId===e.toPeerId(!0)){const t=fe.getChat(e);if(!t.pFlags.broadcast)return;this.btnJoin.classList.toggle("hide",!t?.pFlags?.left),this.setUtilsWidth(),this.verifyButtons()}}),this.listenerSetter.add(C)("dialog_notify_settings",e=>{e.peerId===this.peerId&&this.setMutedState()}),this.listenerSetter.add(C)("peer_full_update",e=>{this.peerId===e&&this.verifyButtons()}),this.listenerSetter.add(C)("chat_requests",({chatId:e,recentRequesters:t,requestsPending:s})=>{if(this.peerId!==e.toPeerId(!0))return;const i=this.chat.bubbles.getMiddleware();this.chatRequests.set(this.peerId,t.map(n=>n.toPeerId(!1)),s).then(n=>{i()&&n()})}),this.listenerSetter.add(C)("peer_settings",async({peerId:e,settings:t})=>{if(this.peerId!==e)return;this.chatActions.set(e,t)()}),this.chat.addEventListener("setPeer",(e,t)=>{const s=this.chat.bubbles.getMiddleware();fe.getState().then(i=>{!s()||!this.pinnedMessage||(this.pinnedMessage.hidden=!!i.hiddenPinnedMessages[this.chat.peerId],t?(this.pinnedMessage.unsetScrollDownListener(),this.pinnedMessage.testMid(e,0)):this.pinnedMessage.locked||(this.pinnedMessage.handleFollowingPinnedMessage(),this.pinnedMessage.testMid(e)))})}),this.listenerSetter.add(C)("peer_pinned_messages",({peerId:e,mids:t})=>{this.chat.type!==Q.Pinned||e!==this.peerId||t&&this.setTitle()}),this}openPinned(e){this.chat.appImManager.setInnerPeer({peerId:this.peerId,lastMsgId:e?+this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.dataset.mid:0,type:Q.Pinned})}destroy(){this.listenerSetter.removeAll(),this.status?.destroy(),this.titleMiddlewareHelper?.destroy(),this.avatarMiddlewareHelper?.destroy(),this.pinnedMessage?.destroy(),this.chatAudio?.destroy(),this.chatRequests?.destroy(),this.chatActions?.destroy(),delete this.pinnedMessage,delete this.chatAudio,delete this.chatRequests,delete this.chatActions}cleanup(){this.chat.peerId||this.container.classList.add("hide")}appendPinnedMessage(e){const t=e.pinnedMessageContainer.divAndCaption.container;this.pinnedMessage&&this.pinnedMessage!==e?this.pinnedMessage.pinnedMessageContainer.divAndCaption.container.replaceWith(t):this.chatUtils.prepend(t)}async finishPeerChange(e){const{peerId:t,threadId:s}=this.chat,{middleware:i}=e;let n,a;const r=this.chat.type===Q.Saved;if(this.chat.type===Q.Chat||r){const b=r?s:t,w=r?void 0:s,S=this.avatar;!S||S.node.dataset.peerId.toPeerId()!==b||S.node.dataset.threadId!==(w?""+w:void 0)||t===C.myId?(n=ls({middleware:(a=Gt()).get(),isDialog:!0,size:42,peerId:b,threadId:w,wrapOptions:{customEmojiSize:ys(32,32)},withStories:!0,meAsNotes:r}),n.node.classList.add("person-avatar")):n=this.avatar}this.status?.destroy();const l=this.status=this.createStatus(),c=[this.managers.appPeersManager.isBroadcast(t),this.managers.appPeersManager.isAnyChat(t),t.isAnyChat()?fe.getChat(t.toChatId()):void 0,n?.readyThumbPromise,this.setTitleManual(),l?.prepare(!0),fe.getState(),Ro(this.chatRequests.setPeerId(t)),Ro(this.chatActions.setPeerId(t))],[d,h,u,p,m,g,f,y,v]=await Promise.all(c);return!i()&&a&&a.destroy(),()=>{const b=!(this.chat.type===Q.Pinned||this.chat.type===Q.Scheduled);this.btnMute&&this.btnMute.classList.toggle("hide",!d||!b),this.btnJoin&&(d&&!this.chat.isRestricted&&b?(tt(this.btnJoin,_(d?"Chat.Subscribe":"ChannelJoin")),this.btnJoin.classList.toggle("hide",!u?.pFlags?.left)):this.btnJoin.classList.add("hide")),this.btnSearch&&this.btnSearch.classList.toggle("hide",!b),this.btnPinned&&this.btnPinned.classList.toggle("hide",!b),this.avatar!==n&&(n&&this.person.prepend(n.node),this.avatar&&(this.avatarMiddlewareHelper.destroy(),this.avatar.node.remove()),this.avatar=n,this.avatarMiddlewareHelper=a,this.container.classList.toggle("has-avatar",!!n)),this.setUtilsWidth(),this.verifyButtons(),this.btnMore&&this.btnMore.classList.toggle("hide",!b);const w=this.chat.isPinnedMessagesNeeded();if(w||this.chat.type===Q.Discussion){if(this.chat.wasAlreadyUsed||!this.pinnedMessage){const S=new hh(this,this.chat,this.managers);this.appendPinnedMessage(S),this.pinnedMessage?.destroy(),this.pinnedMessage=S}w?this.pinnedMessage.hidden=!!f.hiddenPinnedMessages[t]:this.chat.type===Q.Discussion&&(this.pinnedMessage.pinnedMid=this.chat.threadId,this.pinnedMessage.count=1,this.pinnedMessage.pinnedIndex=0,this.pinnedMessage._setPinnedMessage())}else this.pinnedMessage&&(this.pinnedMessage.destroy(),this.pinnedMessage=void 0);m(),g?.(),this.subtitle.classList.toggle("hide",!g),this.setMutedState(),this.container.classList.remove("hide"),y.result instanceof Promise&&this.chatRequests.unset(t),v.result instanceof Promise&&this.chatActions.unset(t),Xs(y.result,S=>{i()&&S()}),Xs(v.result,S=>{i()&&S()})}}async setTitleManual(e){const{peerId:t,threadId:s}=this.chat;let i;this.titleMiddlewareHelper?.destroy();const r=(this.titleMiddlewareHelper=Gt()).get();if(this.chat.type===Q.Pinned)e===void 0?i=_("Loading"):i=_("PinnedMessagesCount",[e]),e===void 0&&this.managers.appMessagesManager.getSearchCounters(t,[{_:"inputMessagesFilterPinned"}],!1).then(l=>{if(!r())return;const c=l[0].count;if(this.setTitle(c),!c){this.chat.appImManager.setPeer();const d=this.chat.appImManager.chat;d.topbar.pinnedMessage&&d.topbar.pinnedMessage.pinnedMessageContainer.toggle(!0)}});else if(this.chat.type===Q.Scheduled)i=_(t===C.myId?"Reminders":"ScheduledMessages");else if(this.chat.type===Q.Discussion){const l=this.messagesCounter(r,"Chat.Title.Comments");if(e===void 0){const c=await this.chat.getHistoryStorage();if(!r())return;l.compareAndUpdate(c.count===null?{key:"Loading",args:void 0}:{args:[c.count]})}i=l.element}else if(this.chat.type===Q.Chat||this.chat.type===Q.Saved){const l=this.chat.type===Q.Saved?s:t;if([i]=await Promise.all([Oe({peerId:l,dialog:!0,withIcons:!s,threadId:s,wrapOptions:{middleware:r},meAsNotes:this.chat.type===Q.Saved})]),!r())return}return()=>{tt(this.title,i)}}setTitle(e){this.setTitleManual(e).then(t=>t())}async setMutedState(){if(!this.btnMute)return;const e=this.peerId,t=await this.managers.appNotificationsManager.isPeerLocalMuted({peerId:e,respectType:!1,threadId:this.chat.threadId}),s=await this.managers.appPeersManager.isBroadcast(e);s&&(Uo(this.btnMute,t?"unmute":"mute"),this.btnMute.dataset.muted=""+ +t),this.btnMute.style.display=s?"":"none"}messagesCounter(e,t){const s=new De.IntlElement({key:t,args:[1]}),i=this.chat.historyStorageKey,n=({historyKey:a,count:r})=>{i===a&&s.compareAndUpdate({key:t,args:[r]})};return C.addEventListener("history_count",n),this.managers.appMessagesManager.toggleHistoryMaxIdSubscription(i,!0),e.onDestroy(()=>{C.removeEventListener("history_count",n),this.managers.appMessagesManager.toggleHistoryMaxIdSubscription(i,!1)}),s}createStatus(){if(!this.subtitle||this.chat.type!==Q.Chat&&this.chat.type!==Q.Saved)return;const e=Gt(),t=e.get(),s=new Qt;let i;if(this.chat.type===Q.Saved){const a=this.messagesCounter(t,"messages");i=async()=>{const r=await this.chat.getHistoryStorage();return a.compareAndUpdate({args:[r.count]}),()=>tt(this.subtitle,a.element)}}else if(this.chat.threadId)i=async()=>{const a=await Oe({peerId:this.peerId,dialog:!0}),r=_("TopicProfileStatus",[a]);return()=>tt(this.subtitle,r)};else{const a=this.peerId;s.add(C)("peer_typings",({peerId:l})=>{a===l&&n()}),s.add(C)("user_update",l=>{a===l.toPeerId()&&n()});const r=window.setInterval(()=>n(),6e4);t.onDestroy(()=>{clearInterval(r)}),i=l=>this.chat.appImManager.setPeerStatus({peerId:a,element:this.subtitle,needClear:l,useWhitespace:!1,middleware:t})}t.onDestroy(()=>{s.removeAll()});const n=()=>{i(!1).then(a=>t()&&a())};return{prepare:i,destroy:()=>e.destroy()}}}class Rw extends Tt{constructor(){super(...arguments),this.threadId=0,this.query=""}onOpenAfterTimeout(){this.appSearch.beginSearch(this.peerId,this.threadId,this.query)}init(e,t,s,i){this.container.id="search-private-container",this.container.classList.add("chatlist-container"),this.inputSearch=new Nr({placeholder:"Search"}),this.title.replaceWith(this.inputSearch.container),this.btnPickDate=Xe("calendar sidebar-header-right"),this.header.append(this.btnPickDate);const n=document.createElement("div");n.classList.add("chatlist-container"),this.scrollable.container.replaceWith(n),this.appSearch=new Dv(n,this.inputSearch,{messages:new Ma("Chat.Search.PrivateSearch","messages")},this.middlewareHelper.get(),void 0,void 0,!!(e===C.myId&&t)),this.peerId?this.appSearch.beginSearch(this.peerId,this.threadId,i):(this.query=i,this.peerId=e,this.threadId=t,this.onDatePick=s,this.btnPickDate.classList.toggle("hide",!this.onDatePick),this.onDatePick&&D(this.btnPickDate,()=>{J.createPopup($c,new Date,this.onDatePick).show()},{listenerSetter:this.listenerSetter}),i&&this.appSearch.searchInput.inputField.setValueSilently(i),ss.toggleSidebar(!0))}}class V_{constructor(e,t,s){this.topbar=e,this.chat=t,this.foundCount=0,this.selectedIndex=0,this.onDateClick=a=>{X(a),J.createPopup($c,new Date,this.chat.bubbles.onDatePick).show()},this.onResultsClick=a=>{const r=oi(a.target,Hr);r&&this.selectResult(r)},this.onFooterClick=a=>{this.foundCount&&(this.chat.bubbles.container.classList.toggle("search-results-active"),this.results.classList.toggle("active"))},this.onUpClick=a=>{X(a),this.selectResult(this.searchGroup.list.children[this.selectedIndex+1])},this.onDownClick=a=>{X(a),this.selectResult(this.searchGroup.list.children[this.selectedIndex-1])},this.middlewareHelper=Gt(),this.element=document.createElement("div"),this.element.classList.add("sidebar-header","chat-search","chatlist-container"),this.backBtn=Xe("left sidebar-close-button");const i=this.listenerSetter=new Qt,n=(a,r)=>{D(a,r,{listenerSetter:i})};n(this.backBtn,()=>{this.destroy()}),this.inputSearch=new Nr({placeholder:"Search"}),this.results=document.createElement("div"),this.results.classList.add("chat-search-results","chatlist-container"),this.searchGroup=new Ma(!1,"messages",void 0,"",!1),n(this.searchGroup.list,this.onResultsClick),this.appSearch=new Dv(this.results,this.inputSearch,{messages:this.searchGroup},this.middlewareHelper.get(),a=>{this.foundCount=a;const r=this.inputSearch.value;this.foundCountEl.classList.toggle("empty",!r),this.foundCount?this.selectResult(this.searchGroup.list.children[0]):(tt(this.foundCountEl,r?_("NoResult"):""),this.results.classList.remove("active"),this.chat.bubbles.container.classList.remove("search-results-active"),this.upBtn.setAttribute("disabled","true"),this.downBtn.setAttribute("disabled","true"))}),this.appSearch.beginSearch(this.chat.peerId,this.chat.threadId),this.chat.bubbles.container.append(this.results),this.footer=document.createElement("div"),this.footer.classList.add("chat-search-footer"),n(this.footer,this.onFooterClick),pi(this.footer),this.foundCountEl=document.createElement("span"),this.foundCountEl.classList.add("chat-search-count","empty"),this.dateBtn=Xe("calendar chat-search-calendar",{noRipple:!0}),this.controls=document.createElement("div"),this.controls.classList.add("chat-search-controls"),this.upBtn=Xe("up",{noRipple:!0}),this.downBtn=Xe("down",{noRipple:!0}),this.upBtn.setAttribute("disabled","true"),this.downBtn.setAttribute("disabled","true"),n(this.dateBtn,this.onDateClick),n(this.upBtn,this.onUpClick),n(this.downBtn,this.onDownClick),this.controls.append(this.upBtn,this.downBtn),this.footer.append(this.foundCountEl,this.dateBtn,this.controls),this.topbar.container.parentElement.insertBefore(this.footer,t.input.chatInput),this.element.append(this.backBtn,this.inputSearch.container),this.topbar.container.classList.add("hide-pinned"),this.topbar.container.parentElement.append(this.element),this.inputSearch.input.focus(),s&&this.setQuery(s),Vn||(this.navigationItem={type:"mobile-search",onPop:()=>{this.destroy()}},dt.pushItem(this.navigationItem))}destroy(){this.middlewareHelper.destroy(),this.topbar.container.classList.remove("hide-pinned"),this.element.remove(),this.inputSearch.remove(),this.results.remove(),this.footer.remove(),this.listenerSetter.removeAll(),this.chat.bubbles.container.classList.remove("search-results-active"),this.chat.search=void 0,dt.removeItem(this.navigationItem)}setQuery(e){this.inputSearch.inputField.value=e}selectResult(e){if(this.setPeerPromise)return this.setPeerPromise;const t=e.dataset.peerId.toPeerId(),s=+e.dataset.mid||void 0,i=ui(e);i===this.foundCount-1?this.upBtn.setAttribute("disabled","true"):this.upBtn.removeAttribute("disabled"),i?this.downBtn.removeAttribute("disabled"):this.downBtn.setAttribute("disabled","true"),this.results.classList.remove("active"),this.chat.bubbles.container.classList.remove("search-results-active");const n=this.chat.setPeer({peerId:t,lastMsgId:s});this.setPeerPromise=(n instanceof Promise?n:Promise.resolve(n)).then(()=>{this.selectedIndex=i,tt(this.foundCountEl,_("Of",[i+1,this.foundCount]));const a=this.searchGroup.list.childElementCount;this.selectedIndex>=a-6&&this.appSearch.searchMore()}).finally(()=>{this.setPeerPromise=null})}}async function $_(o){let e,t=0,s=0,i=0;const n=C.settings,a=C.managers.appPeersManager;return!n.autoDownloadNew.pFlags.disabled&&o&&(o.isUser()?await a.isContact(o)?e="contacts":e="private":await a.isBroadcast(o)?e="channels":e="groups",n.autoDownload.photo[e]&&(t=n.autoDownloadNew.photo_size_max),n.autoDownload.video[e]&&(s=n.autoDownloadNew.video_size_max),n.autoDownload.file[e]&&(i=n.autoDownloadNew.file_size_max)),{photo:t,video:s,file:i}}function G_(o,e){return-e*o*(o-2)}const Gp=50,sy=Gp;class uc{constructor(){this._width=Gp,this._height=sy,this._tails=90,this._curve=[0,.25,.5,.75,1,1.5,2,2.5,3,3.5,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,18.3,18.6,18.9,19.2,19.5,19.8,20.1,20.4,20.7,21,21.3,21.6,21.9,22.2,22.5,22.8,23.1,23.4,23.7,24,24.3,24.6,24.9,25.2,25.5,25.8,26.1,26.3,26.4,26.5,26.6,26.7,26.8,26.9,27],this._positions=[{x:.8,y:.1},{x:.6,y:.2},{x:.35,y:.25},{x:.25,y:.6},{x:.2,y:.9},{x:.4,y:.8},{x:.65,y:.75},{x:.75,y:.4}],this._phases=this._positions.length,this.drawNextPositionAnimated=t=>{let s,i;if(t){const n=t();s=n>=1;const a=G_(n,1),r=this._nextPositionTail??0,c=(this._nextPositionTail=this._nextPositionTails*a)-r;c&&(this._nextPositionLeft-=c,this.changeTailAndDraw(-c))}else{const n=this._frames;i=n.shift(),s=!n.length}return i&&this.drawImageData(i),s&&(this._nextPositionLeft=void 0,this._nextPositionTails=void 0,this._nextPositionTail=void 0,this._animatingToNextPosition=void 0),!s};const e=this._tails/this._curve[this._curve.length-1];for(let t=0,s=this._curve.length;t<s;++t)this._curve[t]=this._curve[t]*e;this._incrementalCurve=this._curve.map((t,s,i)=>t-(i[s-1]??0))}hexToRgb(e){const t=tn(e);return{r:t[0],g:t[1],b:t[2]}}getPositions(e){const t=this._positions.slice();t.push(...t.splice(0,e));const s=[];for(let i=0;i<t.length;i+=2)s.push(t[i]);return s}getNextPositions(e,t,s){const i=this.getPositions(e);if(!s[0]&&s.length===1)return[i];const a=this.getPositions(++e%this._phases).map((l,c)=>({x:(l.x-i[c].x)/t,y:(l.y-i[c].y)/t}));return s.map(l=>a.map((c,d)=>({x:i[d].x+c.x*l,y:i[d].y+c.y*l})))}curPosition(e,t){return this.getNextPositions(e,this._tails,[t])[0]}changeTail(e){for(this._tail+=e;this._tail>=this._tails;)this._tail-=this._tails,++this._phase>=this._phases&&(this._phase-=this._phases);for(;this._tail<0;)this._tail+=this._tails,--this._phase<0&&(this._phase+=this._phases)}changeTailAndDraw(e){this.changeTail(e);const t=this.curPosition(this._phase,this._tail);this.drawGradient(t)}getGradientImageData(e,t=this._phase,s=1-this._tail/this._tails){const i=this._hctx.createImageData(this._width,this._height),n=i.data,a=this._colors.length,r=u=>{const p=[];for(let m=0;m!=4;++m)p[m]={...this._positions[(u+m*2)%this._positions.length]},p[m].y=1-p[m].y;return p},l=(t+1)%this._positions.length,c=r(l),d=r(t);let h=0;for(let u=0;u<this._height;++u){const m=u/this._height-.5,g=m*m;for(let f=0;f<this._width;++f){const v=f/this._width-.5,w=.35*Math.sqrt(v*v+g),S=w*w*.8*8,I=Math.sin(S),L=Math.cos(S),M=Math.max(0,Math.min(1,.5+v*L-m*I)),P=Math.max(0,Math.min(1,.5+v*I+m*L));let E=0,k=0,A=0,x=0;for(let T=0;T<a;++T){const O=c[T].x+(d[T].x-c[T].x)*s,F=c[T].y+(d[T].y-c[T].y)*s,N=M-O,G=P-F;let R=Math.max(0,.9-Math.sqrt(N*N+G*G));R=R*R*R*R,E+=R,k+=R*this._colors[T].r,A+=R*this._colors[T].g,x+=R*this._colors[T].b}n[h++]=k/E,n[h++]=A/E,n[h++]=x/E,n[h++]=255}}return i}drawImageData(e){this._hctx.putImageData(e,0,0),this._ctx.drawImage(this._hc,0,0,this._width,this._height)}drawGradient(e){this.drawImageData(this.getGradientImageData(e))}init(e){this._frames=[],this._phase=0,this._tail=0;const t=e.getAttribute("data-colors").split(",");this._colors=t.map(s=>this.hexToRgb(s)),this._hc||(this._hc=document.createElement("canvas"),this._hc.width=this._width,this._hc.height=this._height,this._hctx=this._hc.getContext("2d",{alpha:!1})),this._canvas=e,this._ctx=this._canvas.getContext("2d",{alpha:!1}),this.update()}update(){if(this._colors.length<2){const t=this._colors[0];this._ctx.fillStyle=`rgb(${t.r}, ${t.g}, ${t.b})`,this._ctx.fillRect(0,0,this._width,this._height);return}const e=this.curPosition(this._phase,this._tail);this.drawGradient(e)}toNextPosition(e){if(this._colors.length<2)return;if(e){this._nextPositionLeft=this._tails+(this._nextPositionLeft??0),this._nextPositionTails=this._nextPositionLeft,this._nextPositionTail=void 0,this._animatingToNextPosition=!0,la(this.drawNextPositionAnimated.bind(this,e),this);return}const t=this._tail,s=this._tails;let i;const n=[];for(let l=0,c=this._incrementalCurve.length;l<c;++l){const d=this._incrementalCurve[l];let h=(n[l-1]??t)+d;+h.toFixed(2)>s&&i===void 0&&(i=l,h%=s),n.push(h)}const a=n.slice(0,i),r=i!==void 0?n.slice(i):[];[a,r].forEach((l,c,d)=>{const h=l[l.length-1];if(h!==void 0&&h>s&&(l[l.length-1]=+h.toFixed(2)),this._tail=h??0,!l.length)return;const u=this.getNextPositions(this._phase,s,l);c!==d.length-1&&++this._phase>=this._phases&&(this._phase-=this._phases);const p=u.map(m=>this.getGradientImageData(m));this._frames.push(...p)}),this._animatingToNextPosition=!0,la(this.drawNextPositionAnimated,this)}cleanup(){}static createCanvas(e){const t=document.createElement("canvas");return t.width=Gp,t.height=sy,e!==void 0&&(t.dataset.colors=e),t}static create(e){const t=this.createCanvas(e),s=new uc;return s.init(t),{gradientRenderer:s,canvas:t}}}const Bl=class Bl{constructor(){this.canvases=new Set}static getInstance(e){let t=this.INSTANCES.find(s=>Li(s.options,e));return t||(t=new Bl,t.init(e),this.INSTANCES.push(t)),t}init(e){this.options=e}renderToCanvas(e){return this.renderImageFromUrl(this.options.url).then(()=>this.fillCanvas(e))}renderImageFromUrl(e){if(this.renderImageFromUrlPromise)return this.renderImageFromUrlPromise;const t=this.image=document.createElement("img");return t.crossOrigin="anonymous",this.renderImageFromUrlPromise=cn(t,e,!1).then(()=>dp?createImageBitmap(t,{resizeWidth:1440,resizeHeight:2960}).then(s=>(this.imageBitmap=s,t)):t)}cleanup(e){this.canvases.delete(e),this.canvases.size||(cs(Bl.INSTANCES,this),this.objectUrl&&(this.imageBitmap?.close(),URL.revokeObjectURL(this.objectUrl)))}fillCanvas(e){const t=e.getContext("2d"),{width:s,height:i}=e,n=this.imageBitmap||this.image;let a=n.width,r=n.height;const l=(500+nt.height/2.5)*e.dpr,c=l/r;a*=c,r=l,this.options.mask?(t.fillStyle="#000",t.fillRect(0,0,s,i),t.globalCompositeOperation="destination-out"):t.globalCompositeOperation="source-over";const d=p=>{for(let m=0;m<s;m+=a)t.drawImage(n,m,p,a,r)},h=(i-r)/2;if(d(h),h>0){let p=h;do d(p-=r);while(p>=0)}const u=i-1;for(let p=h+r;p<u;p+=r)d(p)}setCanvasDimensions(e){const t=Math.min(2,window.devicePixelRatio),s=this.options.width*t;let i=this.options.height*t;e.dpr=t,e.dataset.originalHeight=""+i,Fe.activeScreen===ei.large&&(i*=1.5),e.width=s,e.height=i}createCanvas(){const e=document.createElement("canvas");return this.canvases.add(e),this.setCanvasDimensions(e),e}resize(e,t){this.init({...this.options,width:e,height:t});const s=[];for(const i of this.canvases)this.setCanvasDimensions(i),s.push(this.renderToCanvas(i));return Promise.all(s)}static resizeInstances(e,t){return Promise.all(this.INSTANCES.map(s=>s.resize(e,t)))}};Bl.INSTANCES=[];let gh=Bl;function z_(o){let e;return Ta(o)?e=o.peerId:ra(o)?e=o.id:Dn(o)&&(e=o.savedPeerId),e}function K_(o){const{type:e,peerId:t,threadId:s}=o,i=W_(o);return[e,t,i,s].filter(Boolean).join("_")}function W_({inputFilter:o,savedReaction:e,query:t}){let s;return e&&(s=`tag-${e.map(a=>a.document_id||a.emoticon).join(",")}`,o??(o={_:"inputMessagesFilterEmpty"})),[o?._,t,s].filter(Boolean).join("_")}const Ld="keydown",j_="active",iy=["ArrowUp","ArrowDown"],ny=["ArrowLeft","ArrowRight"];function Dw({list:o,type:e,onSelect:t,once:s,waitForKey:i,activeClassName:n=j_,cancelMouseDown:a,target:r}){let l=i?.length?new Set(i):void 0;const c=new Set(e==="xy"?iy.concat(ny):e==="x"?ny:iy),d=()=>r||o.querySelector("."+n)||o.firstElementChild,h=(P,E)=>{if(r===P)return;let k=!1;r&&(k=!0,r.classList.remove(n)),r=P,r&&(r.classList.add(n),k&&f&&E&&lm({container:f,element:r,position:"center",forceDuration:100,axis:e==="x"?"x":"y"}))},u=(P,E)=>{let k;return E?k=P.nextElementSibling||o.firstElementChild:k=P.previousElementSibling||o.lastElementChild,k},p=(P,E)=>{const k=E?"nextElementSibling":"previousElementSibling",A=E?"firstElementChild":"lastElementChild",x=P.getBoundingClientRect();let T=P[k]||o[A];for(;T!==P;){const O=T.getBoundingClientRect();if(O.x===x.x&&O.y!==x.y)break;T=T[k]||o[A]}return T};let m;e==="xy"?m=(P,E)=>E==="ArrowUp"||E==="ArrowDown"?p(P,E==="ArrowDown"):u(P,E==="ArrowRight"):m=(P,E)=>u(P,E==="ArrowRight"||E==="ArrowDown");let g=P=>{const E=P.key;if(!c.has(E)){(E==="Enter"||e!=="xy"&&E==="Tab")&&(X(P),b(d()));return}if(X(P),o.childElementCount>1){let k=d();k=m(k,E),h(k,!0)}};const f=U(o,"scrollable");o.classList.add("navigable-list");const y=P=>{const E=Vs(P.target,o);E&&h(E,!1)},v=P=>{X(P);const E=Vs(P.target,o);E&&(h(E,!1),b(d()))},b=async P=>{const E=await t(P);(E!==void 0?!E:s)&&L()};let w=!1,S;const I=()=>{w||(w=!0,document.addEventListener(Ld,g,{capture:!0,passive:!1}),o.addEventListener("mousemove",y,{passive:!0}),a&&o.addEventListener("mousedown",X),S=D(o,v,{ignoreMove:a}))},L=()=>{w&&(w=!1,document.removeEventListener(Ld,g,{capture:!0}),o.removeEventListener("mousemove",y),a&&o.removeEventListener("mousedown",X),S(),S=void 0)},M=()=>{l||h(o.firstElementChild,!1)};if(l){const P=g;g=E=>{l.has(E.key)&&(X(E),document.removeEventListener(Ld,g,{capture:!0}),g=P,document.addEventListener(Ld,g,{capture:!0,passive:!1}),l=void 0,M())}}else r||M();return I(),{attach:I,detach:L,resetTarget:M}}function q_(o,e){return o.length>e?o.slice(0,e/2|0)+"..."+o.slice(-Math.round(e/2)):o}const[Q_,Bw]=qs(()=>we(C.premium)),ay=()=>{C.managers.rootScope.getPremium().then(Bw)};C.addEventListener("premium_toggle",Bw);C.myId?ay():C.addEventListener("user_auth",ay);function Y_(){return Q_}const zp=He("<div>"),X_=He("<span><b></b> "),Z_=He("<span class=secondary>"),J_=He("<span>"),ek=He('<div class="topbar-search-left-chatlist chatlist">'),tk=He("<div class=topbar-search-left-results-empty>"),sk=He("<div class=topbar-search-left-results-padding>"),ik=He("<div class=topbar-search-left-delimiter>"),nk=He("<div class=topbar-search-container><div><div class=topbar-search-left-background></div></div><div class=topbar-search-right-container>"),ry=He("<div class=topbar-search-left-reactions-padding>"),ak=He('<div class="topbar-search-left-reactions-container topbar-search-left-collapsable"><div class=topbar-search-left-delimiter>'),rk=o=>{const[,e]=da(o,["onScrolledBottom","onScrolledTop"]);let t;const s=(()=>{const n=zp(),a=t;return typeof a=="function"?Nt(a,n):t=n,$o(n,e,!1,!0),q(n,()=>o.children),n})(),i=new Ys(void 0,void 0,void 0,void 0,t);return i.onScrolledBottom=o.onScrolledBottom,i.onScrolledTop=o.onScrolledTop,Et(()=>{i.destroy()}),s};function ok(o){return pg(Ym(()=>o.children).toArray,{exitMethod:"keep-index",onChange:({added:t,removed:s,finishRemoved:i})=>{const n=o.animationOptions;et.isAvailable("animations")||(n.duration=0);const a=o.keyframes;queueMicrotask(()=>{if(!o.animateOnlyReplacement||s.length)for(const c of t)c.animate(a,n);if(o.animateOnlyReplacement&&!t.length){i(s);return}const r=a.slice().reverse(),l=[];for(const c of s){const d=c.animate(r,n);l.push(d.finished)}Promise.all(l).then(()=>i(s))})}})}const lk=({middleware:o,peerId:e,fromSavedDialog:t,messages:s,query:i})=>{const n=s.map(async a=>{const r=a.fromId,l=[],{dom:c}=Qe.addDialogAndSetLastMessage({peerId:t?C.myId:r||e,container:!1,avatarSize:"abitbigger",meAsSaved:!1,message:a,query:i,wrapOptions:{middleware:o},loadPromises:l,threadId:t?a.saved_peer_id?Je(a.saved_peer_id):C.myId:void 0,autonomous:!0});return await Promise.all(l),c.containerEl});return Promise.all(n)},ck=o=>{const{middleware:e,peerId:t,threadId:s,query:i,fromPeerId:n,reaction:a}=o,r=!!(t===C.myId&&s);let l,c=!1;const d=async()=>{if(c)return;c=!0;const p=l?.mid||0,m=l?.peerId||Vt,g=await C.managers.appMessagesManager.getHistory({peerId:t,threadId:s,query:i,inputFilter:{_:"inputMessagesFilterEmpty"},offsetId:p,offsetPeerId:m,limit:30,fromPeerId:n,savedReaction:a?[a]:void 0});if(!e())return;const f=g.history.map(v=>fe.getMessageByPeer(t,v)),y=await lk({...o,fromSavedDialog:r,messages:f});e()&&(u(v=>(v.count=g.count,v.values.push(...f),l=f[f.length-1],g.isEnd.top&&(v.loadMore=void 0),v.rendered.push(...y),v)),c=!1)},[h,u]=tu({loadMore:d});return h},dk=o=>{const{middleware:e,peerId:t,query:s}=o;let i=!1,n=0;const a=async()=>{if(i)return;i=!0;const c=await C.managers.appProfileManager.getParticipants({id:t.toChatId(),filter:{_:"channelParticipantsSearch",q:s},limit:30,offset:n,forMessagesSearch:!0});if(!e())return;const d=c.participants.map(ko),h=d.map(async p=>{const m=await Oe({peerId:p}),g=fe.getPeer(p),f=si(g)[0],y=new ge({title:(()=>{const w=X_(),S=w.firstChild;return S.nextSibling,q(S,m),q(w,f&&(()=>{const I=Z_();return q(I,`@${f}`),I})(),null),w})(),clickable:!0});y.container.classList.add("topbar-search-left-sender");const v=40,b=ls({peerId:p,size:v,middleware:e});return y.createMedia(`${v}`).append(b.node),await b.readyThumbPromise,y.container}),u=await Promise.all(h);e()&&(l(p=>{p.count=c.count??d.length;const m=p.values.push(...d);return n=m,m>=p.count&&(p.loadMore=void 0),p.rendered.push(...u),p}),i=!1)},[r,l]=tu({loadMore:a});return r};function hk(o){const[e,t]=we(!1),[s,i]=we(""),[n,a]=we(),[r,l]=we(),[c,d]=we(),[h,u]=we(),[p,m]=we(),[g,f]=we(void 0,{equals:!1}),[y,v]=we(!1),[b,w]=we(),[S,I]=we(),[L,M]=we(void 0,{equals:!1}),[P,E]=we(),[k,A]=we(void 0,{equals:!1}),x=e,T=he(()=>x()&&n()&&r()||void 0),O=he(()=>{const Y=P(),j=L();return!!(Y&&j?.length)}),F=he(()=>O()||x()),N=Y_();o.onActive&&(Ne(()=>{o.onActive(F(),O())}),Et(()=>{o.onActive(!1,!1)})),Ne(()=>{B.onChange(B.value=o.query()),v(!!o.filterPeerId()),w(o.filterPeerId()),A(o.reaction()),Ho(()=>{Qs(B.input)})}),Ne(()=>{const{element:Y}=T()||{};if(!Y)return;const j=Y.firstElementChild,te="menu-open",le=j.querySelector(`.${te}`);le&&le.classList.remove(te);const{detach:me}=Dw({list:j,type:"y",onSelect:Ee=>{const Ie=!!(!y()||b());f(Ee),Ie&&un()},activeClassName:te,cancelMouseDown:!0,target:Zt(g)});Et(()=>{me()})});const G={type:"topbar-search",onPop:()=>{if(e()&&s())return un(),!1;o.onClose?.()}};dt.pushItem(G),Et(()=>{dt.removeItem(G)});const R=(Y,j=B.inputField.isEmpty())=>{if(b()){Y&&X(Y),j&&w(void 0);return}if(y()){Y&&X(Y),j&&v(!1);return}j&&o.onClose?.()},B=new Nr({placeholder:"Search",onChange:Y=>{i(Y)},onClear:R,onFocusChange:t,alwaysShowClear:!0,noBorder:!0});B.container.classList.add("topbar-search-input-container"),B.input.classList.add("topbar-search-input");const H=Y=>{if(Y.key!=="Backspace")return;const j=B.inputField.isEmpty();j&&(b()||y())&&R(void 0,j)};B.input.addEventListener("keydown",H),Et(()=>{B.input.removeEventListener("keydown",H),B.remove()});const z=De.format("Search.From",!0)+" ",W=Zl(z,fm),ue=(()=>{const Y=J_();return q(Y,z),mt(()=>st(Y,jt("topbar-search-input-from",y()&&"is-visible"))),Y})();B.container.append(ue),Ne(Y=>{const j=y();Y&&(Y.classList.remove("scale-in"),Y.offsetWidth,Y.classList.add("scale-out"),setTimeout(()=>{Y.remove()},200));const te=S();if(te){te.classList.add("topbar-search-input-entity","scale-in");const le=D(te,me=>{X(me),w()},{cancelMouseDown:!0});Et(le),B.container.append(te)}return B.container.style.setProperty("--padding-placeholder",(j?W:0)+"px"),B.container.style.setProperty("--padding-sender",(te?te.offsetWidth+6:0)+"px"),B.setPlaceholder(j&&!te?"Search.Member":"Search"),te}),Ne(async()=>{const Y=b(),j=Ii().get();let te;if(Y){const le=Zt(()=>li.renderEntity({key:Y,middleware:j,avatarSize:30,meAsSaved:!1}));if(te=le.element,await Promise.all(le.promises),!j())return}I(te)});const K=document.createElement("div");K.classList.add("topbar-search-input-tools"),B.clearBtn.replaceWith(K);const ee=271,_e=Y=>ke(Cn,{icon:Y,get class(){return jt("input-search-part","topbar-search-input-arrow",(!n()||y()&&!b())&&"hide")},noRipple:!0,onClick:()=>{let j=g();if(!j){j=xe.querySelector(".chatlist-chat"),f(j);return}if(Y==="down"?j=j.previousElementSibling:j=j.nextElementSibling,!j||!j.classList.contains("chatlist-chat"))return;const te=j.offsetTop,le=ee;xe.scrollTop=te-le/2+j.clientHeight/2,f(j)}}),ae=_e("up"),re=_e("down");K.append(ae,re,B.clearBtn),Ne(()=>{const{peerId:Y,threadId:j}=o,te=s(),le=b(),me=y()&&!le,Ee=Ii().get(),Ie=!te.trim(),Ke=!me&&k();m(()=>{}),d(),u(),f();const $=(me?dk:ck)({middleware:Ee,peerId:Y,threadId:j,query:te,fromPeerId:le,reaction:Ke});let se;(()=>{const Te=ek(),Ae=se;return typeof Ae=="function"?Nt(Ae,Te):se=Te,q(Te,(()=>{const Ge=he(()=>n()===0);return()=>Ge()?(()=>{const We=tk();return q(We,()=>Ie&&le?_("Search.EmptyFrom",[new Mt({peerId:le}).element]):_("Search.Empty",[Pe(q_(te,18))])),We})():[(()=>{const We=zp();return q(We,()=>$().rendered),We})(),he((()=>{const We=he(()=>!!$().rendered);return()=>We()&&sk()})())]})()),Te})();let oe=!0;const ve=()=>{oe&&(B.toggleLoading(!1),l({element:se,type:me?"senders":"messages"}),xe.scrollTop=0,oe=!1)};if(!me&&!le&&!Ke&&Ie){a(),ve();return}Ne(xi(()=>$(),({rendered:Te,values:Ae,loadMore:Ge})=>{a(Te.length),m(()=>Ge),me?u(Ae):d(Ae),ve()},{defer:!0})),B.toggleLoading(!0),Zt(()=>$().loadMore())}),Ne(xi(g,Y=>{const j=ui(Y);if(j===-1)return;if(y()&&!b()){const me=h()[j];ur(()=>{w(me),B.onChange(B.value="")});return}const te=Y.parentElement.querySelector(".active");te&&te.classList.remove("active"),Y.classList.add("active");const le=c()[j];ce.chat.setMessageId({lastMsgId:le.mid})},{defer:!0}));const Ue=Y=>({_:"reactionCount",count:Y.count,reaction:Y.reaction}),ye=Y=>({_:"messageReactions",pFlags:{reactions_as_tags:!0},results:Y.map(Ue)}),Z=({savedPeerId:Y,tags:j})=>{Y===o.threadId&&M(j)};C.addEventListener("saved_tags",Z),Et(()=>{C.removeEventListener("saved_tags",Z)}),Ne(Y=>{const j=L(),te=P();if(!j||!te)return Y;const le={...te.getContext(),reactions:ye(j)},me=k();let Ee;if(me){const Ke=le.reactions.results.find($=>Ai($.reaction,me));Ke&&(Ee=Ke,Ke.chosen_order=0)}if(Y?.remove(),te.update(le),Ee){const Ke=te.getSorted().find($=>Ai($.reactionCount.reaction,me));lm({container:ne,element:Ke,position:"center",axis:"x"})}const Ie=N();if(te.classList.toggle("is-locked",!Ie),!Ie){const Ke="premium_lock",$=new za;$.init(Ki.Tag,Ii().get()),$.reactionCount={_:"reactionCount",count:1,reaction:Ke},$.setCanRenderAvatars(!1),$.renderCounter(void 0,_("Unlock")),$.classList.add("reaction-tag-lock");const se=document.createElement("div");return se.classList.add("reaction-sticker","reaction-sticker-icon"),se.append(Le(Ke)),$.lastElementChild.before(se),te.prepend($),$}}),Ne(()=>{if(o.peerId!==C.myId){E(),M();return}const Y=Ii().get(),j=Gt();Et(()=>{setTimeout(()=>{j.destroy()},400)});const te=new Jh;te.init({context:{peerId:o.peerId,mid:0,reactions:ye([])},type:Ki.Block,middleware:j.get(),forceCounter:!0}),te.classList.remove("has-no-reactions"),te.classList.add("topbar-search-left-reactions");const le=D(te,Ee=>{const Ie=U(Ee.target,"reaction-tag");if(!Ie)return;if(!N()){ps.show({feature:"saved_tags"});return}const{reactionCount:Ke}=Ie,{reaction:$}=Ke;A(se=>{if(!Ai(se,$))return $}),Qs(B.input)},{cancelMouseDown:!0});Et(le);const me=()=>{C.managers.appReactionsManager.getSavedReactionTags(o.threadId).then(Ee=>{Y()&&(E(te),M(Ee))})};me(),C.addEventListener("saved_tags_clear",me),Et(()=>{C.removeEventListener("saved_tags_clear",me)})});let de=!0;Ne(xi(k,Y=>{de&&(de=!1,!Y)||ce.chat.setMessageId({lastMsgId:void 0,mediaTimestamp:void 0,savedReaction:Y?[Y]:void 0})})),Et(()=>{k()&&ce.chat.setMessageId({lastMsgId:void 0,mediaTimestamp:void 0,savedReaction:void 0})});const be=he(()=>{if(!x())return 0;const Y=n();if(Y===void 0)return 0;const j=8*2;let te;return Y===0?te=43:r().type==="senders"?te=1+j+Y*48:te=1+j+Y*56,Math.min(ee,te)}),pe=he(()=>F()&&O()?62:0);let xe,ne;return(()=>{const Y=nk(),j=Y.firstChild;j.firstChild;const te=j.nextSibling;return q(j,()=>B.container,null),q(j,()=>(()=>{const le=ak();return le.firstChild,q(le,ke(lg,{ref(me){const Ee=ne;typeof Ee=="function"?Ee(me):ne=me},class:"topbar-search-left-reactions-scrollable",get children(){return[ry(),he(()=>P()),ry()]}}),null),mt(me=>qi(le,pe()?{height:pe()+"px"}:void 0,me)),le})(),null),q(j,ke(rk,{ref(le){const me=xe;typeof me=="function"?me(le):xe=le},class:"topbar-search-left-results topbar-search-left-collapsable",get style(){return he(()=>!!be())()?{height:be()+"px"}:void 0},onScrolledBottom:()=>{p()?.()},get children(){return[ik(),ke(ok,{animationOptions:{duration:200,easing:"ease-in-out"},keyframes:[{opacity:0},{opacity:1}],animateOnlyReplacement:!0,get children(){return r()?.element}})]}}),null),q(te,(()=>{const le=he(()=>!!o.canFilterSender);return()=>le()&&(()=>{const me=zp();return q(me,ke(Cn,{class:"topbar-search-right-filter-button",icon:"newprivate",ref:Ee=>{const Ie=D(Ee,Ke=>{X(Ke),B.onChange(B.value=""),v(!0),Qs(B.input,!0)},{cancelMouseDown:!0});Et(Ie)}})),mt(()=>st(me,jt("topbar-search-right-filter",y()&&"is-hidden"))),me})()})(),null),q(te,(()=>{const le=he(()=>!!o.onDatePick);return()=>le()&&ke(Cn,{icon:"calendar",onClick:()=>{J.createPopup($c,new Date,o.onDatePick).show()}})})(),null),mt(()=>st(j,jt("topbar-search-left-container",F()&&"is-focused"))),Y})()}function uk(o){if(o.inputFilter||o.savedReaction||o.query)return o.query||!o.peerId||o.fromPeerId?"uncached":"cached"}var Q=(o=>(o.Chat="chat",o.Pinned="pinned",o.Discussion="discussion",o.Scheduled="scheduled",o.Stories="stories",o.Saved="saved",o))(Q||{});class Nw extends vi{constructor(e,t,s,i={}){super(),this.appImManager=e,this.managers=t,this.isMainChat=s,this.excludeParts=i,this.log=zs("CHAT",Si.Log|Si.Warn|Si.Debug|Si.Error),this.log.warn("constructor"),this.type="chat",this.animationGroup=`chat-${Math.round(Math.random()*65535)}`,this.middlewareHelper=Gt(),this.excludeParts.elements||(this.container=document.createElement("div"),this.container.classList.add("chat","tabs-tab"),this.backgroundEl=document.createElement("div"),this.backgroundEl.classList.add("chat-background"),this.container.append(this.backgroundEl)),this.peerId=Vt,this.backgroundTempId=0,this.sharedMediaTabs=[]}setBackground(e,t){const n=bs.getTheme().settings.wallpaper,a=ap(n);let r;if(!!a&&!n.slug&&!n.settings.intensity&&document.documentElement.style.cursor==="grabbing"&&this.gradientRenderer&&!this.patternRenderer)return this.gradientCanvas.dataset.colors=a,this.gradientRenderer.init(this.gradientCanvas),Promise.resolve();const c=++this.backgroundTempId,d=this.gradientRenderer,h=this.patternRenderer;this.gradientCanvas;const u=this.patternCanvas;this.gradientRenderer=this.patternRenderer=this.gradientCanvas=this.patternCanvas=void 0;const p=n.settings?.intensity&&n.settings.intensity/100,m=!!p&&p<0;let g,f=r?.firstElementChild,y;if(!r)if(r=document.createElement("div"),r.classList.add("chat-background-item"),e)if(p){r.classList.add("is-pattern");const w=this.appImManager.chatsContainer.getBoundingClientRect();g=this.patternRenderer=gh.getInstance({url:e,width:w.width,height:w.height,mask:m}),f=this.patternCanvas=g.createCanvas(),f.classList.add("chat-background-item-canvas","chat-background-item-pattern-canvas"),m&&r.classList.add("is-dark")}else r.classList.add("is-image");else r.classList.add("is-color");let v;if(a){const{canvas:w,gradientRenderer:S}=uc.create(a);v=this.gradientRenderer=S,y=this.gradientCanvas=w,y.classList.add("chat-background-item-canvas","chat-background-item-color-canvas")}if(g){const w=m?y:f;let S=Math.abs(p)*(m?.5:1);m&&(S=Math.max(.3,S)),w.style.setProperty("--opacity-max",""+S)}const b=new Promise(w=>{const S=()=>{if(this.backgroundTempId!==c){g&&g.cleanup(f),v&&v.cleanup();return}const I=this.backgroundEl.lastElementChild;if(I===r){w();return}const L=[y,f].filter(Boolean);L.length&&r.append(...L),this.backgroundEl.append(r),vt({element:r,className:"is-visible",forwards:!0,duration:t?0:200,onTransitionEnd:I?()=>{h?.cleanup(u),d?.cleanup(),I.remove()}:null,useRafs:2}),w()};g?g.renderToCanvas(f).then(()=>{this.backgroundTempId===c&&S()}):e?In(r,e,S):S()});return this.setBackgroundPromise=Promise.race([js(500),b])}setType(e){this.type=e}init(){this.topbar=new H_(this,ss,this.managers),this.bubbles=new YE(this,this.managers),this.input=new vh(this,this.appImManager,this.managers,"chat-input-main"),this.contextMenu=new wn(this,this.managers),this.selection=new a_(this,this.bubbles,this.input,this.managers),this.topbar.constructUtils(),this.topbar.constructPeerHelpers(),this.topbar.construct(),this.input.construct(),this.bubbles.constructPeerHelpers(),this.input.constructPeerHelpers(),Ye||this.bubbles.setReactionsHoverListeners(),this.bubbles.attachContainerListeners(),this.container.append(this.topbar.container,this.bubbles.container,this.input.chatInput),this.bubbles.listenerSetter.add(C)("dialog_migrate",({migrateFrom:s,migrateTo:i})=>{this.peerId===s&&this.setPeer({peerId:i})}),this.bubbles.listenerSetter.add(C)("dialog_drop",s=>{s.peerId===this.peerId&&(Ta(s)||this.threadId===z_(s))&&this.appImManager.setPeer()}),this.bubbles.listenerSetter.add(C)("chat_update",async s=>{const{peerId:i}=this;if(i.isAnyChat()&&i.toChatId()===s){const n=await this.managers.appMessagesManager.isAnonymousSending(i);i===this.peerId&&(this.isAnonymousSending=n)}});const e=s=>{const i=()=>{this.bubbles.observer?.toggleObservingNew(s),ut.toggleIntersectionGroup(this.animationGroup,s),s&&ut.checkAnimations(s,this.animationGroup)};s?i():setTimeout(()=>{i()},400)};this.bubbles.listenerSetter.add(this.appImManager)("chat_changing",({to:s})=>{e(s!==this)}),this.bubbles.listenerSetter.add(this.appImManager)("tab_changing",s=>{e(this.appImManager.chat!==this||s!==No.CHAT&&Fe.activeScreen===ei.mobile)}),this.searchSignal=Sa();const t=this.middlewareHelper.get();qs(s=>{t.onDestroy(s);const i=async(p,m)=>{const g=et.isAvailable("animations"),f=[{opacity:0},{opacity:1}],y={fill:"forwards",duration:g?200:0,easing:"ease-in-out"};m||f.reverse();const v=this.topbar.container.querySelectorAll(".content, .chat-utils"),b=[],w=p.animate(f,y).finished;f.reverse();const S=Array.from(v).map(I=>I.animate(f,y).finished);return b.push(w,...S),Promise.all(b)},[n,a]=we(!1),[r,l]=we("",{equals:!1}),[c,d]=we(void 0,{equals:!1}),[h,u]=we(void 0,{equals:!1});Ne(p=>{if(!n()){if(!p)return;i(p,!1).then(()=>{p.remove()});return}return p=hk({peerId:this.peerId,threadId:this.threadId,canFilterSender:this.isRealGroup,query:r,filterPeerId:c,reaction:h,onClose:()=>{this.searchSignal(void 0)},onDatePick:m=>{this.bubbles.onDatePick(m)},onActive:(m,g)=>{const f="is-search-active",y=!!(m&&g);if(this.container.classList.contains(f)===y)return;const b=this.bubbles.createScrollSaver();b.save(),this.container.classList.toggle(f,y),b.restore()}}),this.topbar.container.append(p),i(p,!0),p}),Ne(()=>{const p=this.searchSignal();l(p?.query),d(p?.filterPeerId),u(p?.reaction),a(!!p)})})}beforeDestroy(){this.destroyPromise=Rt(),this.bubbles.cleanup(),this.searchSignal?.(void 0)}cleanupBackground(){++this.backgroundTempId,this.patternRenderer?.cleanup(this.patternCanvas),this.gradientRenderer?.cleanup(),this.patternRenderer=this.gradientRenderer=void 0}destroy(){this.destroyPromise?.resolve(),this.destroySharedMediaTab(),this.topbar?.destroy(),this.bubbles?.destroy(),this.input?.destroy(),this.contextMenu?.destroy(),this.selection?.attachListeners(void 0,void 0),this.cleanupBackground(),this.topbar=this.bubbles=this.input=this.contextMenu=this.selection=void 0,this.container?.remove()}cleanup(e=!0){this.input?.cleanup(e),this.topbar?.cleanup(),this.selection?.cleanup(),this.searchSignal?.(void 0)}get isForumTopic(){return!!(this.isForum&&this.threadId)}async onChangePeer(e,t){const{peerId:s,threadId:i}=e;this.excludeParts.elements||ss.getTab(Rw)?.close();const[n,a,r,l,c,d,h,u,p,m,g,f,y]=await t(Promise.all([this.managers.appPeersManager.noForwards(s),this.managers.appPeersManager.isPeerRestricted(s),this._isAnyGroup(s),this.managers.appPeersManager.isAnyGroup(s),this.setAutoDownloadMedia(),this.managers.appPeersManager.isMegagroup(s),this.managers.appPeersManager.isBroadcast(s),this.managers.appPeersManager.isChannel(s),this.managers.appPeersManager.isBot(s),this.managers.appPeersManager.isForum(s),this.managers.appMessagesManager.isAnonymousSending(s),s.isUser()&&this.managers.appProfileManager.isCachedUserBlocked(s),s.isUser()&&this.managers.appUsersManager.isPremiumRequiredToContact(s.toUserId(),!0)]));m&&i&&await t(this.managers.dialogsStorage.getForumTopicOrReload(s,i)),this.noForwards=n,this.isRestricted=a,this.isAnyGroup=r,this.isRealGroup=l,this.isMegagroup=d,this.isBroadcast=h,this.isChannel=u,this.isBot=p,this.isForum=m,this.isAllMessagesForum=m&&!i,this.isAnonymousSending=g,this.isUserBlocked=f,this.isPremiumRequired=y,i&&!this.isForum&&(e.type=e.peerId===C.myId?"saved":"discussion");const v=e.type??"chat";this.setType(v),this.selection&&(this.selection.isScheduled=v==="scheduled"),this.messagesStorageKey=`${this.peerId}_${this.type==="scheduled"?"scheduled":"history"}`,this.container&&this.container.classList.toggle("no-forwards",this.noForwards),this.excludeParts.sharedMedia||(this.sharedMediaTab=ss.createSharedMediaTab(),this.sharedMediaTabs.push(this.sharedMediaTab),this.sharedMediaTab.setPeer(s,i)),this.input?.clearHelper(),this.selection?.cleanup()}get requestHistoryOptionsPart(){return{peerId:this.peerId,threadId:this.threadId,savedReaction:this.savedReaction}}setPeer(e){const{peerId:t,threadId:s}=e;t?this.inited||(this.init&&(this.init(),this.init=null),this.inited=!0):this.inited=void 0;const i=this.appImManager.isSamePeer(this,e);if(!i)this.appImManager.dispatchEvent("peer_changing",this),this.peerId=t||Vt,this.threadId=s,this.middlewareHelper.clean();else if(this.setPeerPromise)return;if(!t){ss.toggleSidebar(!1),this.cleanup(!0),this.bubbles.setPeer({peerId:t,samePeer:!1,sameReactions:!1}),this.peerId=0,this.appImManager.dispatchEvent("peer_changed",this),this.excludeParts.sharedMedia||(ss.replaceSharedMediaTab(),this.destroySharedMediaTab(),this.sharedMediaTab=void 0);return}this.peerChanged=i;let n=!0;(!i||e.hasOwnProperty("savedReaction"))&&(this.savedReaction=e.savedReaction,n=!1),this.managers.appMessagesManager.toggleHistoryMaxIdSubscription(this.historyStorageKey,!1),this.historyStorageKey=K_({type:uk(this.requestHistoryOptionsPart)?"search":this.threadId?"replies":"history",...this.requestHistoryOptionsPart}),this.managers.appMessagesManager.toggleHistoryMaxIdSubscription(this.historyStorageKey,!0);const a=this.bubbles.setPeer({...e,samePeer:i,sameReactions:n}),r=this.setPeerPromise=a.then(l=>l.promise).catch(qt).finally(()=>{this.setPeerPromise===r&&(this.setPeerPromise=null)});return a}destroySharedMediaTab(e=this.sharedMediaTab){e&&(cs(this.sharedMediaTabs,e),e.destroy())}async setAutoDownloadMedia(){this.autoDownload=await $_(this.peerId)}setMessageId(e={}){return this.setPeer({peerId:this.peerId,threadId:this.threadId,...e})}async finishPeerChange(e){if(this.peerChanged)return;const t=this.peerId;this.peerChanged=!0,this.wasAlreadyUsed=!0;const{middleware:s}=e;this.cleanup(!1);const i=this.sharedMediaTab,n=[this.topbar?.finishPeerChange(e),this.bubbles?.finishPeerChange(),this.input?.finishPeerChange(e),i?.fillProfileElements()],r=await Promise.all(n);i?.loadSidebarMedia(!0),s()&&(r.forEach(l=>{l?.()}),i&&(ss.replaceSharedMediaTab(i),this.sharedMediaTabs.filter(l=>l!==i).forEach(l=>this.destroySharedMediaTab(l))),this.container&&(this.container.dataset.type=this.type,this.container.classList.toggle("can-click-date",["chat","discussion","saved"].includes(this.type))),this.log.setPrefix("CHAT-"+t+"-"+this.type),this.isMainChat&&this.appImManager.dispatchEvent("peer_changed",this))}getMessage(e){return fe.getMessageFromStorage(this.messagesStorageKey,e)}async getMidsByMid(e){return this.managers.appMessagesManager.getMidsByMessage(this.getMessage(e))}getHistoryStorage(e){return this.managers.appMessagesManager.getHistoryStorageTransferable({...this.requestHistoryOptionsPart,threadId:e?void 0:this.threadId}).then(t=>({...t,history:nc.fromJSON(t.historySerialized)}))}getDialogOrTopic(){return this.managers.dialogsStorage.getAnyDialog(this.peerId,(this.isForum||this.type==="saved")&&this.threadId)}getHistoryMaxId(){return this.getHistoryStorage().then(e=>e.maxId)}_isAnyGroup(e){return e===C.myId||e===xa||this.managers.appPeersManager.isAnyGroup(e)}initSearch(e={}){if(!this.peerId)return;const{query:t}=e;Fe.isMobile?this.search?this.search.setQuery(t):this.search=new V_(this.topbar,this,t):(e.query||(e.query=""),this.searchSignal(e))}canSend(e){return this.type==="saved"&&this.threadId!==this.peerId?Promise.resolve(!1):this.managers.appMessagesManager.canSendToPeer(this.peerId,this.threadId,e)}isStartButtonNeeded(){return Promise.all([this.managers.appPeersManager.isBot(this.peerId),this.managers.appMessagesManager.getDialogOnly(this.peerId),this.getHistoryStorage(!0),this.peerId.isUser()?this.managers.appProfileManager.isCachedUserBlocked(this.peerId.toUserId()):void 0]).then(([e,t,s,i])=>e?!t&&!s.history.length||i:!1)}isPremiumRequiredToContact(){return this.peerId.isUser()?this.managers.appUsersManager.isPremiumRequiredToContact(this.peerId.toUserId(),!0):Promise.resolve(!1)}getMessageSendingParams(){return{peerId:this.peerId,threadId:this.threadId,updateStickersetOrder:C.settings.stickers.dynamicPackOrder,...this.input&&{...this.input.getReplyTo()||!1,scheduleDate:this.input.scheduleDate,silent:this.input.sendSilent,sendAsPeerId:this.input.sendAsPeerId},savedReaction:this.savedReaction}}isOurMessage(e){return this.isMegagroup?!!e.pFlags.out:!!(e.fromId===C.myId||e.fwd_from?.pFlags?.saved_out)}isOutMessage(e){const t=e.fwd_from;return!!(this.isOurMessage(e)&&(!t||this.peerId!==C.myId||this.threadId))}isAvatarNeeded(e){return this.isAnyGroup&&!this.isOutMessage(e)}isPinnedMessagesNeeded(){return this.type==="chat"||this.isForum}isForwardOfForward(e){let t=dw(e);const s=e.fwd_from;return t&&s.saved_from_id&&this.type==="saved"&&Je(s.saved_from_id)===this.threadId&&(t=!1),t}getPostAuthor(e){const t=e.fwd_from;if(e.pFlags.post||t?.post_author&&!this.isOutMessage(e))return e.post_author||t?.post_author}async canGiftPremium(){const e=this.peerId;if(!e.isUser())return!1;const[t,s]=await Promise.all([this.managers.appProfileManager.canGiftPremium(this.peerId.toUserId()),fe.isPremiumPurchaseBlocked()]);return e.isUser()&&t&&!s}async openWebApp(e){return Object.assign(e,this.getMessageSendingParams()),e.peerId??(e.peerId=this.peerId),this.appImManager.openWebApp(e)}sendReaction(e){return this.managers.appReactionsManager.sendReaction({sendAsPeerId:this.getMessageSendingParams().sendAsPeerId,...e})}}const oy=255,ly=100,cy=200;class pk extends J{constructor(e){super("popup-create-poll popup-new-media",{closable:!0,overlayClosable:!0,withConfirm:"Create",body:!0,title:"NewPoll",isConfirmationNeededOnClose:()=>{if(!(!this.getFilledAnswers().length||this.sent))return ft({titleLangKey:"CancelPollAlertTitle",descriptionLangKey:"CancelPollAlertText",button:{langKey:"Discard",isDanger:!0}})}}),this.chat=e,this.tempId=0,this.onSubmitClick=()=>{this.send()},this.onInput=t=>{const s=t.target,i=oi(s,"LABEL"),n=hp(s);n||(s.parentElement.classList.add("is-filled"),i.classList.remove("hidden-widget"),i.firstElementChild.removeAttribute("disabled")),!i.nextElementSibling&&!n&&this.questions.childElementCount<10&&this.appendMoreField(),this.handleChange()},this.onDeleteClick=t=>{const s=t.target,i=oi(s,"LABEL"),n=ui(i);this.correctAnswers&&this.correctAnswers[0][0]===n&&(this.correctAnswers=void 0),i.remove(),this.optionInputFields.splice(n,1),this.optionInputFields.forEach((a,r)=>{a.options.labelOptions.length=0,a.options.labelOptions.push(r+1),De.weakMap.get(a.label.firstElementChild).update()}),this.handleChange()},this.construct()}async construct(){if(this.questionInputField=new _t({placeholder:"AskAQuestion",label:"AskAQuestion",name:"question",maxLength:oy}),this.listenerSetter.add(this.questionInputField.input)("input",()=>{this.handleChange()}),this.optionInputFields=[],this.chat.type!==Q.Scheduled){const d=new ig({onSilentClick:()=>{this.chat.input.sendSilent=!0,this.send()},onScheduleClick:()=>{this.chat.input.scheduleSending(()=>{this.send()})},openSide:"bottom-left",onContextElement:this.btnConfirm});d.setPeerId(this.chat.peerId),this.header.append(d.sendMenu)}this.header.append(this.questionInputField.container);const e=document.createElement("hr"),t=document.createElement("div");t.classList.add("caption"),$t(t,"PollOptions"),this.questions=document.createElement("form"),this.questions.classList.add("poll-create-questions");const s=document.createElement("div");s.classList.add("poll-create-settings");const i=document.createElement("div");i.classList.add("caption"),$t(i,"Settings"),await this.chat.managers.appPeersManager.isBroadcast(this.chat.peerId)||(this.anonymousCheckboxField=new ct({text:"NewPoll.Anonymous",name:"anonymous"}),this.anonymousCheckboxField.input.checked=!0,s.append(this.anonymousCheckboxField.label)),this.multipleCheckboxField=new ct({text:"NewPoll.MultipleChoice",name:"multiple"}),this.quizCheckboxField=new ct({text:"NewPoll.Quiz",name:"quiz"}),this.listenerSetter.add(this.multipleCheckboxField.input)("change",()=>{const d=this.multipleCheckboxField.checked;this.quizCheckboxField.input.toggleAttribute("disabled",d)}),this.listenerSetter.add(this.quizCheckboxField.input)("change",()=>{const d=this.quizCheckboxField.checked;Array.from(this.questions.children).map(h=>{h.classList.toggle("radio-field",d)}),d||(this.correctAnswers=void 0,this.quizSolutionField.setValueSilently("")),n.forEach(h=>h.classList.toggle("hide",!d)),this.multipleCheckboxField.input.toggleAttribute("disabled",d),this.handleChange()}),s.append(this.multipleCheckboxField.label,this.quizCheckboxField.label);const n=[],a=document.createElement("div");a.classList.add("caption"),$t(a,"AccDescrQuizExplanation");const r=document.createElement("hr"),l=document.createElement("div");l.classList.add("poll-create-questions"),this.quizSolutionField=new _t({placeholder:"NewPoll.Explanation.Placeholder",label:"NewPoll.Explanation.Placeholder",name:"solution",maxLength:cy}),this.listenerSetter.add(this.questionInputField.input)("input",()=>{this.handleChange()});const c=document.createElement("div");c.classList.add("subtitle"),$t(c,"AddAnExplanationInfo"),l.append(this.quizSolutionField.container,c),n.push(r,a,l),n.forEach(d=>d.classList.add("hide")),this.body.parentElement.insertBefore(e,this.body),this.body.append(t,this.questions,document.createElement("hr"),i,s,...n),D(this.btnConfirm,this.onSubmitClick,{listenerSetter:this.listenerSetter}),this.scrollable=new Ys(this.body),this.appendMoreField(),this.handleChange()}getFilledAnswers(){return Array.from(this.questions.children).map((t,s)=>{const i=t.querySelector(".input-field-input");return i instanceof HTMLInputElement?i.value:sn(i,!1,!1).value}).filter(t=>!!t.trim())}validate(){const e=this.questionInputField.value;if(!e||e.length>oy||this.quizCheckboxField.checked&&!this.correctAnswers?.length)return!1;const t=this.getFilledAnswers();if(t.length<2||t.find(n=>n.length>ly))return!1;const{value:i}=sn(this.quizSolutionField.input,!1,!1);return!(i.length>cy)}handleChange(){const e=this.validate();this.btnConfirm.toggleAttribute("disabled",!e)}async send(e=!1){const t=this.questionInputField.value,s=this.getFilledAnswers(),{value:i,entities:n}=sn(this.quizSolutionField.input,!0,!1);if(this.chat.type===Q.Scheduled&&!e){this.chat.input.scheduleSending(()=>{this.send(!0)});return}this.sent=!0,this.hide();const a={};this.anonymousCheckboxField&&!this.anonymousCheckboxField.checked&&(a.public_voters=!0),this.multipleCheckboxField.checked&&(a.multiple_choice=!0),this.quizCheckboxField.checked&&(a.quiz=!0);const r={_:"poll",pFlags:a,question:t,answers:s.map((c,d)=>({_:"pollAnswer",text:c,option:new Uint8Array([d])})),id:void 0},l=await this.chat.managers.appPollsManager.getInputMediaPoll(r,this.correctAnswers,i,n);this.chat.managers.appMessagesManager.sendOther({...this.chat.getMessageSendingParams(),inputMedia:l}),this.chat.input.helperType==="reply"&&this.chat.input.clearHelper(),this.chat.input.onMessageSent(!1,!1)}appendMoreField(){const e=this.tempId++,t=this.questions.childElementCount+1,s=new _t({placeholder:"NewPoll.OptionsAddOption",label:"NewPoll.OptionLabel",labelOptions:[t],name:"question-"+e,maxLength:ly});this.listenerSetter.add(s.input)("input",this.onInput);const i=new di({text:"",name:"question"});i.main.append(s.container),D(s.input,X,{listenerSetter:this.listenerSetter}),i.label.classList.add("hidden-widget"),i.input.disabled=!0,this.quizCheckboxField.checked||i.label.classList.remove("radio-field"),this.listenerSetter.add(i.input)("change",()=>{if(i.input.checked){const r=ui(i.label);this.correctAnswers=[new Uint8Array([r])],this.handleChange()}});const n=Xe("close");s.container.append(n),D(n,this.onDeleteClick,{listenerSetter:this.listenerSetter,once:!0}),this.questions.append(i.label),this.scrollable.scrollIntoViewNew({element:this.questions.lastElementChild,position:"center"}),this.optionInputFields.push(s)}}function fh(o){return new Promise(async e=>{const t=document.createElement("canvas"),s=o.size??o.mediaSize.aspectFitted(o.boxSize),i=window.devicePixelRatio&&1;t.width=s.width*i,t.height=s.height*i;const n=t.getContext("2d");let a;dp?a=await createImageBitmap(o.media,{resizeWidth:s.width,resizeHeight:s.height}):a=o.media,n.drawImage(a,0,0,t.width,t.height),dp&&a?.close();const r=o.mimeType??"image/jpeg",l=o.quality??1;if(o.toDataURL){const c=t.toDataURL(r,l);e({url:c,size:s})}else t.toBlob(c=>{e({blob:c,size:s})},r,l)})}function Ow(o){let e,t;return o instanceof HTMLVideoElement?(e=o.videoWidth,t=o.videoHeight):(e=o.naturalWidth,t=o.naturalHeight),fh({media:o,mediaSize:ys(e,t),boxSize:ys(320,240),quality:.9})}function mk(o){return new Promise((e,t)=>{o.onseeked=()=>{o.onseeked=()=>{Ow(o).then(e),o.onseeked=void 0},ti(o,0)},o.onerror=t,ti(o,Math.min(o.duration,1))})}function gk(o){const e=o.src;return fetch(e).then(t=>t.arrayBuffer()).then(t=>{const s=new Uint8Array(t);let i=0;for(let n=0,a=s.length;n<a;++n)if(s[n]==33&&s[n+1]==249&&s[n+2]==4&&s[n+7]==0){const r=s[n+5]<<8|s[n+4]&255;i+=r<2?10:r}return i/1e3})}function fk(o,e){const t={writable:!0,configurable:!0},s={};e.forEach(i=>{o.hasOwnProperty(i)||(s[i]=t)}),Object.defineProperties(o,s)}const dy=new Set(["audio/mpeg","audio/aac","audio/wav"]);function Uw(o,e){const t=ro(o.message),s=o.entities||[],i=oo(s.slice(),t);return Im(o.message,{...e,entities:i})}let Od;const hy=384;function uy(){return Od}class Ra extends J{constructor(e,t,s,i){super("popup-send-photo popup-new-media",{closable:!0,withConfirm:"Modal.Send",confirmShortcutIsSendShortcut:!0,body:!0,title:!0,scrollable:!0}),this.chat=e,this.files=t,this.ignoreInputValue=i,this.onScroll=()=>{const{input:n}=this.messageInputField;this.scrollable.onAdditionalScroll(),n.scrollTop>0&&n.scrollHeight>130&&this.scrollable.container.classList.remove("scrolled-bottom")},this.onKeyDown=n=>{const a=n.target,{input:r}=this.messageInputField;if(a!==r){if(a.tagName==="INPUT"||a.isContentEditable)return;r.focus(),Qs(r)}},this.attachFile=n=>{const a=this.willAttach,r=this.shouldCompress(n.type),l=document.createElement("div");l.classList.add("popup-item");const c={file:n};fk(c,["scaledBlob","middlewareHelper","itemDiv","mediaSpoiler"]),c.middlewareHelper=this.middlewareHelper.get().create(),c.itemDiv=l;const d=r?this.attachMedia(c):this.attachDocument(c);return a.sendFileDetails.push(c),d.catch(h=>{l.style.backgroundColor="#000",console.error("error rendering file",h)})},this.animationGroup="NEW-MEDIA",this.construct(s)}static async canSend({peerId:e,onlyVisible:t,threadId:s}){const i=["send_photos","send_videos","send_docs","send_audios","send_gifs"],n=i.map(l=>e.isAnyChat()&&!t?C.managers.appChatsManager.hasRights(e.toChatId(),l,void 0,s?!0:void 0):!0),a={},r=await Promise.all(n);return i.forEach((l,c)=>{a[l]=r[c]}),a}async construct(e){this.willAttach={type:e,sendFileDetails:[],group:!0};const t=await this.managers.apiManager.getLimit("caption");this.captionLengthMax=t;const s=await Ra.canSend({...this.chat.getMessageSendingParams(),onlyVisible:!0}),i=s.send_photos,n=s.send_videos,a=s.send_docs;D(this.btnConfirm,()=>this.send(),{listenerSetter:this.listenerSetter});const r=yi({listenerSetter:this.listenerSetter,direction:"bottom-left",buttons:[{icon:"image",text:"Popup.Attach.AsMedia",onClick:()=>this.changeType("media"),verify:()=>{if(!this.hasAnyMedia()||this.willAttach.type!=="document"||!i&&!n)return!1;if(!i||!n){const p=i?Wd:_d,{media:m,files:g}=this.partition(p);if(g.length)return!1}return!0}},{icon:"document",text:"SendAsFile",onClick:()=>this.changeType("document"),verify:()=>this.files.length===1&&this.willAttach.type!=="document"&&a},{icon:"document",text:"SendAsFiles",onClick:()=>this.changeType("document"),verify:()=>this.files.length>1&&this.willAttach.type!=="document"&&a},{icon:"groupmedia",text:"Popup.Attach.GroupMedia",onClick:()=>this.changeGroup(!0),verify:()=>!this.willAttach.group&&this.canGroupSomething()},{icon:"groupmediaoff",text:"Popup.Attach.UngroupMedia",onClick:()=>this.changeGroup(!1),verify:()=>this.willAttach.group&&this.canGroupSomething()},{icon:"mediaspoiler",text:"EnablePhotoSpoiler",onClick:()=>this.changeSpoilers(!0),verify:()=>this.canToggleSpoilers(!0,!0)},{icon:"mediaspoiler",text:"Popup.Attach.EnableSpoilers",onClick:()=>this.changeSpoilers(!0),verify:()=>this.canToggleSpoilers(!0,!1)},{icon:"mediaspoileroff",text:"DisablePhotoSpoiler",onClick:()=>this.changeSpoilers(!1),verify:()=>this.canToggleSpoilers(!1,!0)},{icon:"mediaspoileroff",text:"Popup.Attach.RemoveSpoilers",onClick:()=>this.changeSpoilers(!1),verify:()=>this.canToggleSpoilers(!1,!1)}]});this.header.append(r),this.btnConfirm.remove(),this.mediaContainer=document.createElement("div"),this.mediaContainer.classList.add("popup-photo"),this.scrollable.container.append(this.mediaContainer);const l=this.inputContainer=document.createElement("div");l.classList.add("popup-input-container");const c=document.createElement("div");if(c.classList.add("popup-input-inputs","input-message-container"),this.messageInputField=new fb({placeholder:"PreviewSender.CaptionPlaceholder",name:"message",withLinebreaks:!0,maxLength:this.captionLengthMax}),this.messageInputField.input.dataset.animationGroup=this.animationGroup,this.listenerSetter.add(this.scrollable.container)("scroll",this.onScroll),this.listenerSetter.add(this.messageInputField.input)("scroll",this.onScroll),this.messageInputField.input.classList.replace("input-field-input","input-message-input"),this.messageInputField.inputFake.classList.replace("input-field-input","input-message-input"),c.append(this.messageInputField.input,this.messageInputField.placeholder,this.messageInputField.inputFake),l.append(c,this.btnConfirm),!this.ignoreInputValue&&!this.chat.input.editMsgId&&(this.wasDraft=this.chat.input.getCurrentInputAsDraft(),this.wasDraft)){const p=Uw(this.wasDraft,{wrappingForPeerId:this.chat.peerId,animationGroup:this.animationGroup});this.messageInputField.setValueSilently(p),this.chat.input.messageInputField.value=""}this.container.append(l),this.attachFiles(),this.addEventListener("close",()=>{this.files.length=0,this.willAttach.sendFileDetails.length=0,Od===this&&(Od=void 0)});let d,h,u;if(Xi({buttons:[{icon:"mediaspoiler",text:"EnablePhotoSpoiler",onClick:()=>{this.applyMediaSpoiler(u)},verify:()=>h&&!u.mediaSpoiler},{icon:"mediaspoileroff",text:"DisablePhotoSpoiler",onClick:()=>{this.removeMediaSpoiler(u)},verify:()=>!!(h&&u.mediaSpoiler)}],listenTo:this.mediaContainer,listenerSetter:this.listenerSetter,findElement:p=>(d=U(p.target,"popup-item"),h=d.classList.contains("popup-item-media"),u=this.willAttach.sendFileDetails.find(m=>m.itemDiv===d),d)}),this.chat.type!==Q.Scheduled){const p=new ig({onSilentClick:()=>{this.chat.input.sendSilent=!0,this.send()},onScheduleClick:()=>{this.chat.input.scheduleSending(()=>{this.send()})},onSendWhenOnlineClick:()=>{this.chat.input.setScheduleTimestamp(Vl,()=>{this.send()})},openSide:"top-left",onContextElement:this.btnConfirm,listenerSetter:this.listenerSetter,canSendWhenOnline:this.chat.input.canSendWhenOnline});p.setPeerId(this.chat.peerId),this.container.append(p.sendMenu)}Od=this}async applyMediaSpoiler(e,t){const s=e.middlewareHelper.get(),{width:i,height:n}=e.itemDiv.style;let a,r;if(e.itemDiv.classList.contains("album-item")){const{width:p,height:m}=e.itemDiv.parentElement.style,g=parseInt(p),f=parseInt(m);a=+i.slice(0,-1)/100*g,r=+n.slice(0,-1)/100*f}else a=parseInt(i),r=parseInt(n);const{url:l}=await fh({media:e.itemDiv.firstElementChild,boxSize:ys(40,40),mediaSize:ys(a,r),toDataURL:!0,quality:.2}),c=JC(l),d={_:"photoStrippedSize",bytes:c,type:"i"};e.strippedBytes=c;const h={_:"photo",sizes:[d],id:0,access_hash:0,date:0,dc_id:0,file_reference:[],pFlags:{}},u=await eu({middleware:s,width:a,height:r,animationGroup:this.animationGroup,media:h});s()&&(t||u.classList.add("is-revealing"),e.mediaSpoiler=u,e.itemDiv.append(u),await Wn(),s()&&Dp({mediaSpoiler:u,reveal:!1}))}removeMediaSpoiler(e){Dp({mediaSpoiler:e.mediaSpoiler,reveal:!0,destroyAfter:!0}),e.mediaSpoiler=void 0}appendDrops(e){this.body.append(e)}get type(){return this.willAttach.type}set type(e){this.willAttach.type=e}partition(e=ia){const[t,s]=oh(this.willAttach.sendFileDetails,i=>e.has(i.file.type));return{media:t,files:s}}mediaCount(){return this.partition().media.length}hasAnyMedia(){return this.mediaCount()>0}canGroupSomething(){const{media:e,files:t}=this.partition();return e.length>1||t.length>1}canToggleSpoilers(e,t){let s=this.willAttach.type==="media"&&this.hasAnyMedia();if(t&&s&&(s=this.files.length===1),s){const i=this.willAttach.sendFileDetails.filter(a=>ia.has(a.file.type)),n=i.filter(a=>a.mediaSpoiler);s=t?!0:i.length>1,s&&(s=e?i.length!==n.length:i.length===n.length)}return s}changeType(e){this.willAttach.type=e,this.attachFiles()}changeGroup(e){this.willAttach.group=e,this.attachFiles()}changeSpoilers(e){this.partition().media.forEach(t=>{e&&!t.mediaSpoiler?this.applyMediaSpoiler(t):!e&&t.mediaSpoiler&&this.removeMediaSpoiler(t)})}addFiles(e){const t=e.filter(s=>!this.files.find(n=>n.lastModified===s.lastModified&&n.name===s.name&&n.size===s.size));t.length&&(this.files.push(...t),this.attachFiles())}async send(e=!1){let{value:t,entities:s}=sn(this.messageInputField.input,!0,!1);if(t.length>this.captionLengthMax){Rs(De.format("Error.PreviewSender.CaptionTooLong",!0));return}const{input:i}=this.chat,n=await Ra.canSend(this.chat.getMessageSendingParams()),a=this.willAttach;a.isMedia=a.type==="media"||void 0;const{sendFileDetails:r,isMedia:l}=a;let c=!1;if(this.iterate(u=>{if(c)return;const m=u.map(g=>{const f=[[dy,"GlobalAttachAudioRestricted","send_audios"],[()=>!ia.has(g.file.type),"GlobalAttachDocumentsRestricted","send_docs"]];l&&f.unshift([Wd,"GlobalAttachPhotoRestricted","send_photos"],[()=>_d.has(g.file.type)&&g.noSound,"GlobalAttachGifRestricted","send_gifs"],[_d,"GlobalAttachVideoRestricted","send_videos"]);const y=f.find(([v])=>typeof v=="function"?v():v.has(g.file.type));return y?n[y[2]]?void 0:y[1]:!l&&!n.send_docs&&"GlobalAttachDocumentsRestricted"||void 0}).find(g=>typeof g=="string");m&&(Re({langPackKey:m}),et.isAvailable("animations")&&Ha(this.body)),c||(c=!!m)}),c)return;if(this.chat.type===Q.Scheduled&&!e){this.chat.input.scheduleSending(()=>{this.send(!0)});return}const{length:d}=r,h=this.chat.getMessageSendingParams();this.iterate(u=>{t&&u.length!==d&&(this.managers.appMessagesManager.sendText({...h,text:t,entities:s}),t=s=void 0);const p=u.map(g=>({...g,file:g.scaledBlob||g.file,spoiler:!!g.mediaSpoiler})),m={...a,sendFileDetails:p};this.managers.appMessagesManager.sendGrouped({...h,caption:t,entities:s,isMedia:l,...m}),t=s=void 0}),h.replyToMsgId&&i.onHelperCancel(),this.wasDraft=void 0,this.hide()}modifyMimeTypeForTelegram(e){return Og.has(e)?"image/jpeg":e}async scaleImageForTelegram(e,t,s){let n=e.src,a;if(t!=="image/gif"&&(Math.max(e.naturalWidth,e.naturalHeight)>2560||s&&!Og.has(t))){const{blob:r}=await fh({media:e,boxSize:ys(2560,2560),mediaSize:ys(e.naturalWidth,e.naturalHeight),mimeType:this.modifyMimeTypeForTelegram(t)});a=r,URL.revokeObjectURL(n),n=await fe.invoke("createObjectURL",r),await cn(e,n)}return a&&{url:n,blob:a}}async attachMedia(e){const{itemDiv:t}=e;t.classList.add("popup-item-media");const s=e.file;if(s.type.startsWith("video/")){const n=Lo({middleware:e.middlewareHelper.get()});n.src=e.objectURL=await fe.invoke("createObjectURL",s),n.autoplay=!0,n.controls=!1,n.muted=!0,n.addEventListener("timeupdate",()=>{n.pause()},{once:!0}),t.append(n);let a;try{const c=ca(n);await bm(n,c)}catch(c){a=c}if(e.width=n.videoWidth,e.height=n.videoHeight,e.duration=Math.floor(n.duration),a)throw a;const r=n.webkitAudioDecodedByteCount;r!==void 0&&(e.noSound=!r);const l=await mk(n);e.thumb={url:await fe.invoke("createObjectURL",l.blob),...l}}else{const n=new Image;t.append(n);const a=e.objectURL=await fe.invoke("createObjectURL",s);await cn(n,a);const r=e.file.type,l=await this.scaleImageForTelegram(n,r,!0);if(l&&(e.objectURL=l.url,e.scaledBlob=l.blob),e.width=n.naturalWidth,e.height=n.naturalHeight,s.type==="image/gif")return e.noSound=!0,Promise.all([gk(n).then(c=>{e.duration=Math.ceil(c)}),Ow(n).then(async c=>{e.thumb={url:await fe.invoke("createObjectURL",c.blob),...c}})]).then(()=>{})}}async attachDocument(e){const{itemDiv:t}=e;t.classList.add("popup-item-document");const s=e.file,i=s.type.startsWith("image/"),n=dy.has(s.type);(i||n||s.size<2e7)&&(e.objectURL||(e.objectURL=await fe.invoke("createObjectURL",s)));const a=[];let r;if(i&&e.objectURL){r=new Image,await cn(r,e.objectURL);const h=await this.scaleImageForTelegram(r,e.file.type);h&&(e.objectURL=h.url)}if(n&&e.objectURL)try{const h=new Audio;h.src=e.objectURL,h.muted=!0,h.autoplay=!0,await ca(h),e.duration=h.duration,a.push({_:"documentAttributeAudio",duration:e.duration,pFlags:{}})}catch(h){console.error("audio loading error",h)}const l={_:"document",file:s,file_name:s.name||"",size:s.size,type:n?"audio":i?"photo":void 0,access_hash:0,attributes:a,date:0,dc_id:0,file_reference:[],id:0,pFlags:{},duration:e.duration};let c;e.objectURL&&(c={url:e.objectURL,downloaded:s.size,type:gm});const d=await lc({message:{_:"message",pFlags:{is_outgoing:!0},mid:0,peerId:0,media:{_:"messageMediaDocument",document:l}},cacheContext:c});i&&(e.width=r.naturalWidth,e.height=r.naturalHeight),t.append(d)}shouldCompress(e){return this.willAttach.type==="media"&&ia.has(e)}onRender(){this.element.classList.contains("active")||(this.listenerSetter.add(document.body)("keydown",this.onKeyDown),ut.setOnlyOnePlayableGroup(this.animationGroup),this.addEventListener("close",()=>{ut.setOnlyOnePlayableGroup(),!this.ignoreInputValue&&this.wasDraft&&this.chat.input.setDraft(this.wasDraft,!1,!0)}),this.show())}setTitle(){const{willAttach:e,title:t,files:s}=this;let i;const n=[];if(e.type==="document")i="PreviewSender.SendFile",n.push(s.length);else{let a=0,r=0,l=0;s.forEach(c=>{c.type.startsWith("image/")?++a:c.type.startsWith("video/")?++r:++l}),[a,r,l].filter(c=>c>0).length>1?(i="PreviewSender.SendFile",n.push(s.length)):a?(i="PreviewSender.SendPhoto",n.push(a)):r&&(i="PreviewSender.SendVideo",n.push(r))}tt(t,_(i,n))}appendMediaToContainer(e){if(this.shouldCompress(e.file.type)){const t=mC(e.width,e.height,hy,320);e.itemDiv.style.width=t.width+"px",e.itemDiv.style.height=t.height+"px"}this.mediaContainer.append(e.itemDiv)}iterate(e){const{sendFileDetails:t}=this.willAttach;if(!this.willAttach.group){t.forEach(i=>e([i]));return}const s=t.length;for(let i=0;i<s;){const n=t[i].file.type;let a=0;for(;a<10&&i<s;++i,++a){const r=t[i].file.type;if(this.shouldCompress(n)!==this.shouldCompress(r))break}e(t.slice(i-a,i))}}attachFiles(){const{files:e,willAttach:t,mediaContainer:s}=this,i=t.sendFileDetails.splice(0,t.sendFileDetails.length);i.forEach(a=>{a.middlewareHelper.destroy()});const n=e.map(a=>this.attachFile(a));Promise.all(n).then(()=>{s.replaceChildren(),e.length&&(this.setTitle(),this.iterate(a=>{const r=this.shouldCompress(a[0].file.type);if(r&&a.length>1){const l=document.createElement("div");l.classList.add("popup-item-album","popup-item"),l.append(...a.map(c=>c.itemDiv)),Ub({container:l,items:a.map(c=>({w:c.width,h:c.height})),maxWidth:hy,minWidth:100,spacing:4}),s.append(l)}else a.forEach(l=>{this.appendMediaToContainer(l)});r&&a.forEach(l=>{const c=i.find(d=>d.file===l.file);c&&c.mediaSpoiler&&this.applyMediaSpoiler(l,!0)})}))}).then(()=>{this.onRender(),this.onScroll()})}}window.PopupNewMedia=Ra;class lu extends vi{constructor(e){super(!1),this.hidden=!0,this.onVisible=()=>{this.detach?.();const t=this.list,{attach:s,detach:i,resetTarget:n}=Dw({list:t,type:this.listType,onSelect:this.onSelect,once:!0,waitForKey:this.waitForKey});this.attach=s,this.detach=i,this.resetTarget=n,!mi&&!this.navigationItem&&(this.navigationItem={type:"autocomplete-helper",onPop:()=>{this.navigationItem=void 0,this.toggle(!0)},noBlurOnPop:!0},dt.pushItem(this.navigationItem)),this.addEventListener("hidden",()=>{this.resetTarget=void 0,this.attach=void 0,this.detach=void 0,t.replaceChildren(),i(),this.navigationItem&&(dt.removeItem(this.navigationItem),this.navigationItem=void 0)},{once:!0})},Lt(this,e),this.container=document.createElement("div"),this.container.classList.add("autocomplete-helper","z-depth-1"),e.appendTo.append(this.container),this.attachNavigation(),this.controller?.addHelper(this)}toggleListNavigation(e){e?this.attach?.():this.detach?.()}attachNavigation(){this.addEventListener("visible",this.onVisible)}toggle(e,t=!1,s){if(this.init)return;if(e===void 0&&(e=this.container.classList.contains("is-visible")&&!this.container.classList.contains("backwards")),this.hidden===e){e||this.dispatchEvent("visible");return}this.hidden=e,e?(this.navigationItem&&(dt.removeItem(this.navigationItem),this.navigationItem=void 0),!t&&this.controller&&this.controller.hideOtherHelpers(),this.detach?.()):(this.controller&&this.controller.hideOtherHelpers(this),this.dispatchEvent("visible"));const i=this.controller||e?0:2;e&&this.dispatchEvent("hiding"),vt({element:this.container,className:"is-visible",forwards:!e,duration:et.isAvailable("animations")&&!s?300:0,onTransitionEnd:()=>{this.hidden&&this.dispatchEvent("hidden")},useRafs:i})}}class yk extends lu{constructor(e,t,s,i){super({appendTo:e,controller:t,listType:"xy",onSelect:async n=>!await this.chat.input.emoticonsDropdown.onMediaClick({target:n},!0),waitForKey:["ArrowUp","ArrowDown"]}),this.chat=s,this.managers=i,this.container.classList.add("stickers-helper"),this.addEventListener("visible",()=>{setTimeout(()=>{this.scrollable.scrollPosition=0},0),C.dispatchEvent("choosing_sticker",!0)}),this.addEventListener("hidden",()=>{this.onChangeScreen&&(Fe.removeEventListener("changeScreen",this.onChangeScreen),this.onChangeScreen=void 0,this.listenerSetter.removeAll(),this.listenerSetter=void 0),C.dispatchEvent("choosing_sticker",!1)})}checkEmoticon(e){const t=this.controller.getMiddleware();this.lazyLoadQueue?.clear(),gw(e),this.managers.appStickersManager.getStickersByEmoticon({emoticon:e,includeOurStickers:!0,includeServerStickers:C.settings.stickers.suggest==="all"}).then(s=>{if(!t())return;this.init&&(this.init(),this.init=null);const i=this.list.cloneNode();let n;this.lazyLoadQueue.clear(),s.length?n=new Promise(a=>{const r=[];s.forEach(l=>{i.append(this.superStickerRenderer.renderSticker(l,void 0,r))}),Promise.all(r).finally(a)}):n=Promise.resolve(),n.then(()=>{this.list.replaceWith(i),this.list=i,this.onChangeScreen||(this.onChangeScreen=()=>{const a=this.list.childElementCount*Fe.active.esgSticker.width+(this.list.childElementCount-1);this.list.style.width=a+"px"},Fe.addEventListener("changeScreen",this.onChangeScreen),this.listenerSetter=new Qt,Ko({listenTo:this.container,listenerSetter:this.listenerSetter})),this.onChangeScreen(),this.toggle(!s.length),this.scrollable.scrollPosition=0})})}init(){this.list=document.createElement("div"),this.list.classList.add("stickers-helper-stickers","super-stickers"),this.container.append(this.list),this.scrollable=new Ys(this.container),this.lazyLoadQueue=new ha,this.superStickerRenderer=new Qh({regularLazyLoadQueue:this.lazyLoadQueue,group:this.chat.animationGroup,managers:this.managers})}}class vk extends lu{constructor(e,t,s,i){super({appendTo:e,controller:t,listType:"x",onSelect:n=>{s.onEmojiSelected(Sb(n),!0)}}),this.managers=i,this.container.classList.add("emoji-helper")}init(){this.list=document.createElement("div"),this.list.classList.add("emoji-helper-emojis","super-emojis"),this.container.append(this.list),this.scrollable=new Va(this.container),this.addEventListener("visible",()=>{setTimeout(()=>{this.scrollable.scrollPosition=0},0)})}render(e,t){if(this.init){if(!e.length)return;this.init(),this.init=null}e=e.slice(0,80),e.length&&(this.list.replaceChildren(),e.forEach(s=>{wb(s,this.list,!1,!0)})),this.waitForKey=t?["ArrowUp","ArrowDown"]:void 0,this.toggle(!e.length)}checkQuery(e,t){const s=this.controller.getMiddleware();this.managers.appEmojiManager.getBothEmojiKeywords().then(async()=>{if(!s())return;const i=e.replace(/^:/,""),n=await this.managers.appEmojiManager.searchEmojis(i);s()&&this.render(n,t!==":")})}}const Jn=class Jn extends lu{constructor(e,t,s,i){super({appendTo:e,controller:t,listType:"y",onSelect:i}),this.className=s,this.container.classList.add(Jn.BASE_CLASS,s)}init(){this.list=document.createElement("div"),this.list.classList.add(Jn.BASE_CLASS+"-list",this.className+"-list"),this.container.append(this.list),this.scrollable=new Ys(this.container),this.addEventListener("visible",()=>{setTimeout(()=>{this.scrollable.scrollPosition=0},0)})}render(e,t,s){if(this.init){if(!e.length)return;this.init(),this.init=null}e.length&&(this.list.replaceChildren(),e.forEach(i=>{const n=Jn.listElement({className:this.className,peerId:i.peerId,name:i.name,description:i.description,middleware:t});this.list.append(n)})),s||this.toggle(!e.length)}static listElement(e){const t=Jn.BASE_CLASS_LIST_ELEMENT;e.className+="-list-element";const s=document.createElement("div");s.classList.add(t,e.className),s.dataset.peerId=""+e.peerId;const{node:i}=ls({middleware:e.middleware,isBig:!1,size:30,peerId:e.peerId});i.classList.add(t+"-avatar",e.className+"-avatar");const n=document.createElement("div");if(n.classList.add(t+"-name",e.className+"-name"),e.name?St(n,Pe(e.name)):n.append(new Mt({peerId:e.peerId,dialog:!1,onlyFirstName:!1,plainText:!1}).element),s.append(i,n),e.description){const a=document.createElement("div");a.classList.add(t+"-description",e.className+"-description"),St(a,Pe(e.description)),s.append(a)}return s}};Jn.BASE_CLASS="autocomplete-peer-helper",Jn.BASE_CLASS_LIST_ELEMENT=Jn.BASE_CLASS+"-list-element";let _r=Jn;class bk{constructor(e={}){this.options=e,this.fullTexts=new Map,e.minChars??(e.minChars=0)}indexObject(e,t){if(t.trim()&&(t=this.processSearchText(t)),!t)return this.fullTexts.delete(e),!1;this.fullTexts.set(e,t)}_search(e,t=e.split(" ").filter(s=>s.trim())){const s=[],i=this.fullTexts,n=t.length;return i.forEach((a,r)=>{let l=!0,c=0;for(let d=0;d<n;++d){const h=t[d],u=a.indexOf(h),p=d===n-1;if(u===-1||this.options.fullWords&&!p&&a[u+h.length]!==" "||u!==0&&a[u-1]!==" "){l=!1;break}c+=h.length}if(l){c+=n-1;const d=a.length;(this.options.minChars<=c||d<=c)&&s.push({fullText:a,fullTextLength:d,what:r,foundChars:c})}}),s}search(e){e=this.processSearchText(e);const s=e.split("").map(a=>this._search(a)),i=Na(s);return i.sort((a,r)=>a.fullTextLength-r.fullTextLength||r.foundChars-a.foundChars),new Set(i.map(a=>a.what))}processSearchText(e){return this.options?w0(e,this.options):e}}function Hw(o,e,t){const s=[].concat(e.bot_info);let i;t!==void 0&&(i=new bk({ignoreCase:!0}));const n=new Map;s.forEach(r=>{r.commands&&r.commands.forEach(({command:l,description:c},d)=>{const h="/"+l;n.set(l,{peerId:r.user_id?r.user_id.toPeerId(!1):o,command:l,name:h,description:c,index:d}),i&&i.indexObject(l,h)})});let a;if(!i)a=[...n.values()];else{const r=i.search(t);a=Array.from(r).map(l=>n.get(l))}return a=a.sort((r,l)=>n.get(r.command).index-n.get(l.command).index),a}class wk extends _r{constructor(e,t,s,i){super(e,t,"commands-helper",n=>{const a=n.querySelector(`.${_r.BASE_CLASS_LIST_ELEMENT}-name`).innerHTML;return s.getReadyToSend(()=>{s.messageInput.innerHTML=a,s.sendMessage(!0)})}),this.managers=i}async checkQuery(e,t){if(!await this.managers.appUsersManager.isBot(t))return!1;const s=this.controller.getMiddleware();return this.managers.appProfileManager.getProfileByPeerId(t).then(i=>{if(!s())return;const n=Hw(t,i,e);this.render(n,s)}),!0}}class Sk{constructor(){this.helpers=new Set,this.middleware=Gt()}toggleListNavigation(e){for(const t of this.helpers)t.toggleListNavigation(e)}getMiddleware(){return this.middleware.clean(),this.middleware.get()}addHelper(e){this.helpers.add(e)}hideOtherHelpers(e){this.helpers.forEach(t=>{t!==e&&t.toggle(!0,!0)}),e||this.middleware.clean()}}class Ck extends _r{constructor(e,t,s,i){super(e,t,"mentions-helper",n=>{const a=n.dataset.peerId.toUserId();s.mentionUser(a,!0)}),this.managers=i}checkQuery(e,t,s,i){const n=e.trim();if(e.length!==n.length)return!1;const a=this.controller.getMiddleware();return this.managers.appProfileManager.getMentions(t&&t.toChatId(),n,s,i).then(async r=>{if(!a())return;r=r.filter(d=>d!==C.myId);const l=r.map(async d=>{const h=await this.managers.appUsersManager.getUser(d),u=si(h);return{peerId:d,description:u[0]?"@"+u[0]:void 0}}),c=(await Promise.all(l)).filter(Boolean);a()&&this.render(c,a)}),!0}}const no=class no extends kl{constructor(e){super({element:document.createElement("div")}),this.onBodyTouchStart=t=>{const s=t.touches[0].target;!Vs(s,this.element)&&s!==this.btnHover&&(X(t),this.toggle(!1))},Lt(this,e),this.element.classList.add(no.BASE_CLASS),this.element.style.display="none",this.onClickMap=new Map,this.scrollable=new Ys,this.element.append(this.scrollable.container),this.attachButtonListener(this.btnHover,this.listenerSetter),this.listenerSetter.add(C)("history_reply_markup",async({peerId:t})=>{this.peerId===t&&(this.checkAvailability()&&this.isActive()&&await this.render(),xs().then(()=>{this.checkForceReply()}))})}init(){return this.appendTo.append(this.element),this.listenerSetter.add(this)("open",async()=>{await this.render(),Ye&&(this.touchListener=this.listenerSetter.add(document.body)("touchstart",this.onBodyTouchStart,{passive:!1,capture:!0}),this.listenerSetter.add(this)("close",()=>{this.listenerSetter.remove(this.touchListener)},{once:!0}))}),D(this.element,e=>{const t=U(e.target,"btn");if(!t)return;this.onClickMap.get(t)?.(e),this.toggle(!1)},{listenerSetter:this.listenerSetter}),super.init()}async checkForceReply(){const e=await this.getReplyMarkup();e._==="replyKeyboardForceReply"&&!e.pFlags.hidden&&!e.pFlags.used&&(e.pFlags.used=!0,this.chatInput.initMessageReply({replyToMsgId:e.mid}))}async getReplyMarkup(){return(await this.managers.appMessagesManager.getHistoryStorageTransferable({peerId:this.peerId})).replyMarkup??{_:"replyKeyboardHide",pFlags:{}}}async render(e){e===void 0&&(e=await this.getReplyMarkup()),this.onClickMap.clear(),this.scrollable.replaceChildren();for(const t of e.rows){const s=document.createElement("div");s.classList.add(no.BASE_CLASS+"-row");for(const i of t.buttons){const{buttonEl:n,onClick:a}=this.chatInput.chat.bubbles.wrapKeyboardButton({button:i,replyMarkup:e});this.onClickMap.set(n,a),n.classList.add(no.BASE_CLASS+"-button","btn"),s.append(n)}this.scrollable.append(s)}}async checkAvailability(e){e===void 0&&(e=await this.getReplyMarkup());const t=e._==="replyKeyboardHide"||!e.rows?.length;return this.btnHover.classList.toggle("hide",t),t&&this.toggle(!1),!t}setPeer(e){this.peerId=e,this.checkAvailability(),this.checkForceReply()}};no.BASE_CLASS="reply-keyboard";let Kp=no;function Ik(o,e){return o+"_"+e}const py="INLINE-HELPER";class Lk extends lu{constructor(e,t,s,i){super({appendTo:e,controller:t,listType:"xy",waitForKey:["ArrowUp","ArrowDown"],onSelect:n=>{if(!n)return!1;const{peerId:a,botId:r,queryId:l}=this.list.dataset;return this.chat.input.getReadyToSend(()=>{const c=Ik(l,n.dataset.resultId);this.managers.appInlineBotsManager.sendInlineResult(a.toPeerId(),r,c,{...this.chat.getMessageSendingParams(),clearDraft:!0}),this.chat.input.onMessageSent(!0,!0)})}}),this.chat=s,this.managers=i,this._checkQuery=async(n,a,r,l)=>{const c=this.controller.getMiddleware(),d=await this.managers.appUsersManager.resolveUsername(a);if(!c())throw"PEER_CHANGED";if(d._!=="user"||!d.pFlags.bot)throw"NOT_A_BOT";if(!l)throw c()?(this.init&&(this.init(),this.init=null),this.container.classList.add("cant-send"),this.toggle(!1),"NO_INLINES"):"PEER_CHANGED";const h=d.id,u=this.managers.appInlineBotsManager.getInlineResults(n,h,r).then(p=>{if(!c())throw"PEER_CHANGED";this.init&&(this.init(),this.init=null);const m=this.list.cloneNode();m.dataset.peerId=""+n,m.dataset.botId=""+h,m.dataset.queryId=""+p.query_id;const g=new sg(null,py,this.scrollable,!1);this.lazyLoadQueue.clear(),this.superStickerRenderer.clear();const f=[],y=!!p.pFlags.gallery;for(const v of p.results){const b=document.createElement("div");b.classList.add("inline-helper-result"),b.dataset.resultId=v.id;const w=y?void 0:document.createElement("div");if(w&&(w.classList.add("inline-helper-result-preview"),b.append(w)),m.append(b),y)b.classList.add("grid-item");else{w.classList.add("empty"),St(w,Pe([...v.title.trim()][0]));const S=document.createElement("div");S.classList.add("inline-helper-result-title"),St(S,Pe(v.title));const I=document.createElement("div");I.classList.add("inline-helper-result-description"),St(I,us(v.description,{noCommands:!0,noLinks:!0})),b.append(S,I);const L=document.createElement("div");L.classList.add("inline-helper-separator"),m.append(L)}if(v._==="botInlineResult"){if(v.thumb&&v.thumb.mime_type.indexOf("image/")===0){let S;w?(S=document.createElement("div"),w.append(S)):S=b,S.classList.add("media-container"),y&&S.classList.add("no-border-radius"),this.lazyLoadQueue.push({div:b,load:()=>as.download({dcId:4,location:{_:"inputWebFileLocation",access_hash:v.thumb.access_hash,url:v.thumb.url},size:v.thumb.size,mimeType:v.thumb.mime_type}).then(I=>{const L=new Image;L.classList.add("media-photo"),WS(I).then(M=>{Lv({container:S,media:L,url:M,needFadeIn:et.isAvailable("animations")})})})})}}else{const S=v.document||v.photo;if(["sticker","gif"].includes(S?.type)&&y)S.type==="gif"?g.add(S,b):S.type==="sticker"&&(b.classList.add("super-sticker"),this.superStickerRenderer.renderSticker(S,b,f),S.animated&&this.superStickerRenderer.observeAnimated(b));else if(S){const I=y?48:void 0;y&&b.classList.add("no-border-radius"),Ns({photo:S,container:y?b:w,boxWidth:I,boxHeight:I,middleware:c,lazyLoadQueue:this.lazyLoadQueue,loadPromises:f})}}}return Promise.all(f).then(()=>{if(!c()){g.clear();return}m.classList.toggle("is-gallery",y),m.classList.toggle("super-stickers",y),this.container.classList.toggle("is-gallery",y);const v=this.list.parentElement;v.textContent="";const b=p.switch_pm||p.switch_webview;if(b){const w=Ve("btn-primary btn-secondary btn-primary-transparent primary");St(w,Pe(b.text)),D(w,async S=>{b._==="inlineBotSwitchPM"?(await this.chat.appImManager.setInnerPeer({peerId:n}),this.managers.appInlineBotsManager.switchToPM(n,h,b.start_param)):this.chat.openWebApp({botId:h,url:b.url,isSimpleWebView:!0,buttonText:b.text,fromSwitchWebView:!0})}),v.append(w)}v.append(this.list=m),this.container.classList.remove("cant-send"),this.gifsMasonry?.detach(),this.gifsMasonry=g,g.attach(),this.onChangeScreen||(this.onChangeScreen=()=>{if(this.list.classList.contains("is-gallery")){const w=this.list.childElementCount*Fe.active.popupSticker.width+(this.list.childElementCount-1);this.list.style.width=w+"px"}else this.list.style.width=""},Fe.addEventListener("changeScreen",this.onChangeScreen)),this.onChangeScreen(),this.toggle(!p.results.length&&!b),this.scrollable.scrollPosition=0})});return{user:d,renderPromise:u}},this.container.classList.add("inline-helper"),this.addEventListener("visible",()=>{setTimeout(()=>{this.scrollable.scrollPosition=0},0)}),this.checkQuery=Zs(this._checkQuery,200,!0,!0),this.addEventListener("hidden",()=>{this.onChangeScreen&&(Fe.removeEventListener("changeScreen",this.onChangeScreen),this.onChangeScreen=void 0)})}init(){this.list=document.createElement("div"),this.list.classList.add("inline-helper-results"),this.container.append(this.list),this.scrollable=new Ys(this.container),this.lazyLoadQueue=new ha,this.superStickerRenderer=new Qh({regularLazyLoadQueue:this.lazyLoadQueue,group:py,managers:this.managers});const e=_(or.send_inline);e.classList.add("inline-helper-cant-send"),this.container.append(e)}}const Mk="bot-commands";class Pk extends _r{constructor(e,t,s){super(e,void 0,Mk,i=>{const n=i.querySelector(`.${_r.BASE_CLASS_LIST_ELEMENT}-name`).innerHTML;return t.getReadyToSend(()=>{t.messageInput.innerHTML=n,t.sendMessage(!0),this.toggle(!0)})}),this.managers=s}setUserId(e,t){if(this.userId===e&&this.list?.childElementCount){this.toggle(!1);return}return this.userId=e,Xs(this.managers.appProfileManager.getProfile(e),s=>{if(!t())return;const i=Hw(e.toPeerId(!1),s),r=i.length*50+8+24;this.container.style.setProperty("--height",r+"px"),this.render(i,t)})}}function my(o,e,t){const s=[];let i=!1;const n=h=>tI(e,h)?i=!1:(s.push(h),i=!0),a=[];let r=0,l;for(;l=o.match(gC);){const h=r+l.index,u=l.index+l[0].length,p=l.index>0&&o.slice(0,l.index);p&&a.push(p);const m=l[3]||l[8]||l[11]||l[13];let g;if(i=!1,m.match(/^`*$/))a.push(l[0]);else if(l[3]){let y=l[3].match(/(.*?)\n/);y?.[1]||(y=void 0);let v=y?l[3].slice(y[1].length):l[3];const b=v[0]===`
this.cursorHandler);this.joinFile=function(O){if(!E)try{M&&(EditorUi.debug("P2PCollab: joinInProgress on",M),N="busy");M=++H;try{null!=d&&(EditorUi.debug("P2PCollab: force closing socket on",d.joinId),d.close(1E3),d=null)}catch(B){EditorUi.debug("P2PCollab: closing socket error",B)}var V=new WebSocket(window.RT_WEBSOCKET_URL+"?id="+f);V.addEventListener("open",function(B){d=V;d.joinId=M;M=!1;e.file.fireEvent(new mxEventObject("realtimeStateChanged"));EditorUi.debug("P2PCollab: open socket",d.joinId);
O&&e.scheduleCleanup()});V.addEventListener("message",mxUtils.bind(this,function(B){K||EditorUi.debug("P2PCollab: msg received",[B]);var L=JSON.parse(B.data);K&&"message"!=L.action&&EditorUi.debug("P2PCollab: msg received",[B]);switch(L.action){case "message":t(L.msg,L.from);break;case "clientsList":B=L.msg;I=B.cId;v=!0;for(L=0;L<B.list.length;L++)y(B.list[L],!0);break;case "signal":B=L.msg;K||(G[B.from]?L=G[B.from]:(L=y(B.from,!1),q=!0),L.signal(B.signal));break;case "newClient":q=!0;break;case "clientLeft":C(L.msg);
break;case "sendSignalFailed":B=L.msg,EditorUi.debug("P2PCollab: signal failed (socket not found on server)",B),delete G[B.to],D[B.to]=!1}}));var p=!1;V.addEventListener("close",mxUtils.bind(this,function(B){EditorUi.debug("P2PCollab: WebSocket closed",V.joinId,"reconnecting",B.code,B.reason);EditorUi.debug("P2PCollab: closing socket on",V.joinId);E||1E3==B.code||H!=V.joinId||(M==H&&(EditorUi.debug("P2PCollab: joinInProgress in close on",V.joinId),M=!1),p||(EditorUi.debug("P2PCollab: calling rejoin on",
V.joinId),p=!0,this.joinFile(!0)));e.file.fireEvent(new mxEventObject("realtimeStateChanged"))}));V.addEventListener("error",mxUtils.bind(this,function(B){EditorUi.debug("P2PCollab: WebSocket error, reconnecting",B);EditorUi.debug("P2PCollab: error socket on",V.joinId);E||H!=V.joinId||(M==H&&(EditorUi.debug("P2PCollab: joinInProgress in error on",V.joinId),M=!1),p||(EditorUi.debug("P2PCollab: calling rejoin on",V.joinId),p=!0,this.joinFile(!0)));e.file.fireEvent(new mxEventObject("realtimeStateChanged"))}));
e.file.fireEvent(new mxEventObject("realtimeStateChanged"))}catch(B){N=B,e.file.fireEvent(new mxEventObject("realtimeStateChanged"))}};this.destroy=function(){if(!E){EditorUi.debug("P2PCollab: destroyed");E=!0;for(sessionId in k)z(sessionId);null!=this.mouseListeners&&A.removeMouseListener(this.mouseListeners);null!=this.selectionChangeListener&&A.getSelectionModel().removeListener(this.selectionChangeListener);null!=this.shareCursorPositionListener&&b.removeListener(this.shareCursorPositionListener);
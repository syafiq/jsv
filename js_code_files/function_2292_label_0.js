            `);const xt=gs.lastElementChild.firstElementChild,Wt=xt.cloneNode(!0);Wt.classList.add("geo-footer-timer-circle-shadow"),gs.lastElementChild.append(Wt),je.append(gs);let os=e,Os=!1;const ni=(Ms=os,mn)=>{if(Os)return;const Bi=Ms.media,{period:Vr}=Bi,qn=Bi.geo;if(Me=mn?0:(Ms.date+Vr)*1e3,os!==Ms&&(os&&(Ae.lat!==qn.lat||Ae.long!==qn.long)&&(ze(qn),bt(Bi)),os=Ms),Date.now()>=Me){s.classList.add("is-message-empty"),oe.classList.add("is-expired"),ae.classList.remove("hide"),je.replaceWith(ae),pa();return}if(oe.style.setProperty("--heading",`${Bi.heading}deg`),qn.accuracy_radius!==void 0){const Qc=qn.accuracy_radius/se(qn.lat,Pt);oe.style.setProperty("--accuracy-size",`${Qc*2}px`)}let Yo,qc;Es(!0)-(Ms.edit_date??Ms.date)<60?Yo="LocationUpdatedJustNow":(Yo="UpdatedMinutes",qc=[Math.floor((Es(!0)-Ms.edit_date)/60)]);const Wa=(Me-Date.now())/1e3,uu=(1-Wa/Vr)*As;xt.setAttribute("stroke-dashoffset",`-${uu}`),wt.compareAndUpdate({key:Yo,args:qc}),rt.compareAndUpdate({key:Wa<3600?"JustArgument":"MessageTimer.ShortHours",args:[Math.round(Wa<3600?Wa/60:Wa/3600)]})},Di=setInterval(ni,1e3);ni();const pa=()=>{Os=!0,this.updateLocationOnEdit.delete(s),clearInterval(Di)};this.updateLocationOnEdit.set(s,ni),i.onClean(pa)}Jt&&Jt.append(ae);break}case"messageMediaStory":{const se=k.id,oe=Je(k.peer),ve=await this.getStoryReplyIfExpired(oe,se,!1,!0);if(ve){s.classList.add("is-expired-story"),s.classList.remove("is-message-empty"),p.append(ve),p.classList.add("expired-story-message","is-empty");break}s.classList.add("photo","story"),be?lo({size:ys(gp,Fe.active.regular.height),boxWidth:Fe.active.regular.width,boxHeight:Fe.active.regular.height,message:e,element:K}):this.setStoryContainerDimensions(K),te&&(z=!1),me=oe,this.wrapStory({message:e,bubble:s,storyPeerId:oe,storyId:se,container:K,middleware:i,loadPromises:y});break}case"messageMediaGiveawayResults":case"messageMediaGiveaway":{const se=k;se._==="messageMediaGiveawayResults"&&(R=void 0),s.classList.remove("is-message-empty"),s.classList.add("is-giveaway"),$=!0;const oe=this.makeViewButton({text:"BoostingHowItWork"}),ve=document.createElement("div");g.append(oe,ve),D(oe,()=>{hT(e)}),this.wrapSomeSolid(()=>uT({giveaway:se,loadPromises:y}),ve,i);break}default:K=void 0,s.classList.remove("is-message-empty"),p.append(_(ep),ae),this.log.warn("unrecognized media type:",k._,e);break}if($&&(K=void 0),!$&&K&&g.append(K),K){const se=K.style.width;se&&(g.style.maxWidth=se)}W&&!be&&s.classList.add("has-plain-media-tail")}if(ue&&s.classList.add("just-media"),E){const $=document.createElement("div");$.classList.add("bubble-beside-button","bubble-beside-button-top","bubble-sponsored-hide"),$.append(Le("close")),g.prepend($),s.classList.add("with-beside-button"),D($,()=>{ps.show({feature:"no_ads"})})}let Ee="";(ue||!ee||e.fwdFromId)&&this.chat.appImManager.setPeerColorToElement(e.fwdFromId||e.fromId,s,ue,ee);const Ie=e.fromId!==C.myId&&this.chat.isAnyGroup||e.viaBotId||me;if(Ie||pe||R||re){let $,se;const oe=e.fromId,ve=e.from_id?._==="peerChannel"&&e.fromId===xe,Te=hn(pe),Ae=ne&&!ee&&pe.from_name&&pe.saved_from_name;let Ge=!!e.viaBotId||me;const We=!!(pe&&(!pe.from_id||Te));e.viaBotId&&(se=document.createElement("span"),se.innerText="@"+await this.managers.appPeersManager.getPeerUsername(e.viaBotId),se.classList.add("peer-title"));let Ct=!!(me||xe||pe);if(Ct&&this.chat.type===Q.Saved&&xe===C.myId&&(Ct=!1),We&&!xe)$=document.createElement("span"),$.classList.add("peer-title"),St($,Pe(pe.from_name||Te)),s.classList.add("hidden-profile");else{const at=me||xe||e.fromId;$=this.createTitle(at,b,Ct).element}let Pt;n&&(R?._==="messageReplyStoryHeader"||e.reply_to_mid&&e.reply_to_mid!==this.chat.threadId||R?.reply_from)&&(!this.chat.isAllMessagesForum||R.reply_to_top_id)&&(Pt=await nr.setReply({chat:this.chat,bubble:s,bubbleContainer:g,message:e,appendCallback:at=>{K?K.after(at):s.classList.contains("is-message-empty")?g.append(at):p.prepend(at)},middleware:i,lazyLoadQueue:this.lazyLoadQueue,needUpdate:this.needUpdate,isStandaloneMedia:ue,isOut:ee}));let ze;if(Ct){const at=this.peerId===C.myId&&(!this.chat.threadId||!dw(e));if(!at&&!ve&&s.classList.add("forwarded"),e.savedFrom&&(Ee=e.savedFrom,$.dataset.savedFrom=Ee),ze=document.createElement("div"),$.dataset.peerId=""+(me||xe),(at||this.peerId===xa||ve)&&!ue&&!Ae&&!ne&&!me)ze.classList.add("colored-name"),ze.append($);else{Ge||(Ge=!0);const It=[$];if(ue){const Be=document.createElement("br");Be.classList.add("hide-ol"),It.unshift(Be)}let bt;const Me=[It];if(pe?.post_author){bt=me?"ForwardedStoryFromAuthor":"ForwardedFromAuthor";const Be=document.createElement("span");Be.append(Pe(pe.post_author)),Me.push(Be)}else bt=me?"ForwardedStoryFrom":"ForwardedFrom";if(ze.append(_(bt,Me)),Ae){let Be;if(Te)Be=document.createElement("span"),Be.classList.add("peer-title"),Be.style.color="var(--message-primary-color)",Be.dataset.peerId=""+Vt,Be.append(Pe(Te));else{const pt=Je(pe.saved_from_id),{element:Jt,textColorProperty:wt}=this.createTitle(pt,b,!1);Jt.style.color=`rgb(var(--${wt}))`,Be=Jt}const je=document.createElement("div");je.classList.add("name-first-line"),je.append(Be),ze.prepend(je)}}}else if(!e.viaBotId)if(!ue&&Ie){ze=document.createElement("div"),ze.append($);{const It=fe.getPeer(oe)?.pFlags;It&&(It.scam||It.fake)&&ze.append(hv(It.scam)),u||ze.classList.add("colored-name"),ze.dataset.peerId=""+oe}}else s.classList.add("hide-name");if(e.viaBotId){ze?ze.append(" "):ze=document.createElement("div");const at=document.createElement("span");at.append(_("ViaBot")," ",se),at.classList.add("is-via"),ze.append(at)}re&&(ue?re.classList.add("floating-part"):(ze||(ze=document.createElement("div")),ze.append(re),s.classList.remove("hide-name"))),ze?(ze.classList.add("name"),nn(ze),ue?(Y.append(Y=document.createElement("div")),Y.classList.add("name-with-reply","floating-part")):ze.classList.add("floating-part"),Y.append(ze),ue&&Pt&&Y.append(Pt)):ue&&Pt&&Pt.classList.add("floating-part");const yt=ze?.firstElementChild||$;if(this.canShowRanks&&$&&!We&&!xe){const at=()=>{const bt=this.ranks.get(e.fromId);bt&&this.wrapTitleAndRank(yt,bt)},It=e.post_author;if(It)this.wrapTitleAndRank(yt,It);else if(this.ranks)at();else{const bt=this.processRanks;bt.add(at),i.onDestroy(()=>{bt.delete(at)})}}else this.chat.isMegagroup&&!e.fromId.isUser()&&e.views&&this.wrapTitleAndRank(yt,0);if(re&&ue)if(K)K.after(re);else{this.log.error("no attachment div?",s,e);debugger}Ge&&s.classList.add("must-have-name")}else s.classList.add("hide-name");if(this.chat.type===Q.Pinned&&(Ee=`${this.chat.peerId}_${e.mid}`),de&&de.mid===this.chat.threadId&&s.classList.add("is-thread-starter","is-group-last"),Ee&&(this.chat.type===Q.Pinned||pe.saved_from_msg_id)&&this.peerId!==xa){const $=document.createElement("div");$.classList.add("bubble-beside-button","with-hover","goto-original"),$.append(Le("arrow_next")),g.append($),s.dataset.savedFrom=Ee,s.classList.add("with-beside-button")}if(s.classList.add(ee?"is-out":"is-in"),be&&(nr.renderReplies({bubble:s,bubbleContainer:g,message:de,messageDiv:p,loadPromises:y,lazyLoadQueue:this.lazyLoadQueue,middleware:i})?z=!0:s.classList.add("with-beside-replies")),n&&this.appendReactionsElementToBubble(s,e,l),z&&(s.classList.add("can-have-tail"),g.append(pw())),u&&(this.peerId!==C.myId||ee)){(e.pFlags.unread||Z)&&this.unreadOut.add(e.mid);let $;e.error?$="error":Z?$="sending":$=e.pFlags.unread||e.pFlags.is_scheduled?"sent":"read",(ee||$!=="sent"&&$!=="read")&&this.setBubbleSendingStatus(s,$,!0)}return v}appendReactionsElementToBubble(e,t,s,i){if(this.peerId.isUser()&&VE||!s?.reactions||!s.reactions.results.length)return;const n=new Jh;if(n.init({context:s,type:Ki.Block,middleware:e.middlewareHelper.get(),animationGroup:this.chat.animationGroup,lazyLoadQueue:this.lazyLoadQueue}),n.render(i),e.classList.contains("is-message-empty"))e.querySelector(".bubble-content-wrapper").append(n);else{const a=e.querySelector(".message");if(e.classList.contains("is-multiple-documents")){const r=a.lastElementChild;let l=r.querySelector(".document-message"),c=l&&l.querySelector(".time");c||(c=nr.setTime({chat:this.chat,chatType:this.chat.type,message:t,reactionsMessage:s,isOut:e.classList.contains("is-out")})),n.append(c),l||(l=document.createElement("div"),l.classList.add("document-message"),r.querySelector(".document-wrapper").prepend(l)),l.append(n)}else{const r=Array.from(e.querySelectorAll(".time")).pop();n.append(r),a.append(n)}}}setStoryContainerDimensions(e){e.style.width="144px",e.style.height="256px"}async getStoryReplyIfExpired(e,t,s,i){const n=await this.managers.acknowledged.appStoriesManager.getStoryById(e,t);if(n.cached&&!await n.result){if(s)return null;const a=await Oe({peerId:e}),{container:r,fillPromise:l}=Xh({title:s?a:void 0,subtitle:s?void 0:_("ExpiredStorySubtitle",[a]),isStoryExpired:!0,noBorder:i});return r}}wrapGift({content:e,service:t,middleware:s,loadPromises:i,assetName:n,title:a,subtitle:r,buttonText:l,buttonCallback:c}){e.classList.add("bubble-premium-gift-container"),t.classList.add("bubble-premium-gift-wrapper"),a.classList.add("text-bold");const d=160,h=$h({width:d,height:d,assetName:n,middleware:s,loop:!1,autoplay:et.isAvailable("stickers_chat")}).then(({container:p,promise:m})=>(p.classList.add("bubble-premium-gift-sticker"),p.style.position="relative",p.style.width=p.style.height=d+"px",t.prepend(p),m)),u=l&&Ve("bubble-service-button",{noRipple:!0,text:l});u&&c&&D(u,c),t.append(a,r),u&&t.append(u),i.push(h)}wrapSomeSolid(e,t,s){const i=$a(e,t);s.onClean(i)}wrapStory({message:e,bubble:t,storyPeerId:s,storyId:i,container:n,middleware:a,loadPromises:r,boxWidth:l,boxHeight:c}){n.dataset.storyPeerId=""+s,n.dataset.storyId=""+i,this.wrapSomeSolid(()=>R0({message:e,peerId:s,storyId:i,boxWidth:l,boxHeight:c,lazyLoadQueue:this.lazyLoadQueue,autoDownload:this.chat.autoDownload,loadPromises:r,canAutoplay:!1,onExpiredStory:async()=>{await xs(),e=this.chat.getMessage(e.mid),this.safeRenderMessage({message:e,reverse:!0,bubble:t})},withPreloader:!0}),n,a)}wrapTitleAndRank(e,t){const s=this.createBubbleNameRank(t),i=document.createElement("div");i.classList.add("title-flex"),e.replaceWith(i),i.append(e,s)}createBubbleNameRank(e){const t=document.createElement("span");return t.classList.add("bubble-name-rank"),t.append(Hv(e)),t}createTitle(e,t,s){const i=Rh(fe.getPeer(e));let n;return i!==-1&&(n=`peer-${i}-color-rgb`),{element:new Mt({peerId:e,withPremiumIcon:!s,wrapOptions:{...t,textColor:n}}).element,textColorProperty:n}}prepareToSaveScroll(e,t,s){if(!!!this.chatInner.parentElement)return{};const n=this.log.bindPrefix("prepareToSaveScroll");n("save");const a=this.createScrollSaver(e);if(a.save(),(t||s)&&this.getRenderedLength()&&!this.chat.setPeerPromise){const r=this.getViewportSlice(!0);t||(r.invisibleTop.length=0),s||(r.invisibleBottom.length=0),this.deleteViewportSlice(r,!0)}return{restoreScroll:()=>{n("restore"),a.restore(e),this.onRenderScrollSet(a.getSaved())},scrollSaver:a}}async performHistoryResult(e,t){const s=this.log.bindPrefix("perform-"+(Math.random()*1e3|0));s?.("start",this.chatInner.parentElement,e);let i=e.history;i=i.slice(),this.needReflowScroll&&(Jv(this.scrollable.container),this.needReflowScroll=!1);const n=d=>{if(d)return d.pFlags.local?this.processLocalMessageRender(d):this.safeRenderMessage({message:d,reverse:t,canAnimateLadder:!0})},a=await Promise.all(i.map(d=>typeof d=="number"?this.chat.getMessage(d):d)),r=[];if(!this.scrollable.loadedAll.bottom||!this.scrollable.loadedAll.top){let d=e.isEnd;if(!d){const h=await this.chat.getHistoryStorage(),u=h.history.first,p=h.history.last;d={top:!1,bottom:!1,both:!1},u.isEnd(Qr.Bottom)&&(!u.length||i.includes(u[0]))&&(d.bottom=!0),p.isEnd(Qr.Top)&&(!p.length||i.includes(p[p.length-1]))&&(d.top=!0)}if(!d.bottom&&this.setPeerOptions){const{lastMsgId:h,topMessage:u,savedPosition:p}=this.setPeerOptions;this.setPeerOptions=void 0,(!h&&!p||this.bubbles[u]||h===u)&&(d.bottom=!0)}d.top&&r.push(this.setLoaded("top",!0)),d.bottom&&r.push(this.setLoaded("bottom",!0))}await Promise.all(r);const l=a.map(n);await Promise.all(l),await this.messagesQueuePromise;const c=this.checkIfEmptyPlaceholderNeeded();c&&await c,this.messagesQueuePromise&&await this.messagesQueuePromise,this.scrollable.loadedAll.top&&this.messagesQueueOnRenderAdditional&&(this.messagesQueueOnRenderAdditional(),this.messagesQueueOnRenderAdditional?.()),s?.("performHistoryResult end")}onRenderScrollSet(e){const t="has-sticky-dates";if(!this.container.classList.contains(t)&&(!this.preloader.detached||(e??(e={scrollHeight:this.scrollable.scrollSize,clientHeight:this.scrollable.clientSize}),e.scrollHeight!==e.clientHeight))){const i=this.getMiddleware(),n=()=>{i()&&this.container.classList.add(t)};this.willScrollOnLoad?n():setTimeout(n,600);return}this.willScrollOnLoad=void 0}requestHistory(e,t,s){if(this.chat.type===Q.Chat||this.chat.type===Q.Discussion||this.chat.type===Q.Saved)return this.managers.acknowledged.appMessagesManager.getHistory({...this.chat.requestHistoryOptionsPart,offsetId:e,limit:t,backLimit:s});if(this.chat.type===Q.Pinned)return this.managers.acknowledged.appMessagesManager.getHistory({peerId:this.peerId,inputFilter:{_:"inputMessagesFilterPinned"},offsetId:e,limit:t,backLimit:s});if(this.chat.type===Q.Scheduled)return this.managers.acknowledged.appMessagesManager.getScheduledMessages(this.peerId).then(i=>({cached:i.cached,result:Promise.resolve(i.result).then(n=>({history:n.slice().reverse(),count:n.length,isEnd:{both:!0,bottom:!0,top:!0}}))}))}async animateAsLadder(e,t,s,i,n){const a=this.log.bindPrefix("ladder");if(this.chat.setPeerPromise&&!this.resolveLadderAnimation){a.warn("will be delayed"),this.resolveLadderAnimation=this.animateAsLadder.bind(this,e,t,s,i,n);return}if(!Object.keys(this.bubbles).length){a.warn("no bubbles");return}let r=Ca(this.bubbles,"desc");s&&t.length&&(r=r.filter(I=>!t.includes(I)));let l;i?l=n||Math.max(...r):e?l=e:l=Math.max(...r);const c=r.slice(r.findIndex(I=>l>I)),d=s?[]:[l],h=s?[]:r.slice(0,r.findIndex(I=>l>=I)).reverse();ki&&a("targeting mid:",l,n,e,c.map(I=>Gi(I)),h.map(I=>Gi(I)));const u=[];this.chatInner.classList.add("zoom-fading");const p=s?10:40,m=s?0:1,g=(I,L=0)=>{const M=Rt();let P=0;return I.forEach((E,k)=>{const A=this.bubbles[E];if(!A||this.skippedMids.has(E)){a.warn("no bubble by mid:",E);return}P=(k+L||.1)*p;const x=A.lastElementChild;if(!x){a.warn("bubble not ready yet",E,this.batchProcessor);return}const T=[x],O=this.bubbleGroups.getItemByBubble(A);if(O&&O.group.avatar&&O.group.lastItem===O&&T.push(O.group.avatar.node),T.forEach(F=>{F.classList.add("zoom-fade","can-zoom-fade"),F.style.setProperty("transition-delay",P+"ms","important")}),k===I.length-1){const F=N=>{N.target===x&&(M.resolve(),x.removeEventListener("transitionend",F))};x.addEventListener("transitionend",F)}u.push(...T)}),I.length||M.resolve(),{lastMsDelay:P,animationPromise:M}},f=g(c,m),y=g(d),v=g(h,m),b=[f.animationPromise,y.animationPromise,v.animationPromise],w=[f.lastMsDelay,y.lastMsDelay,v.lastMsDelay];this.onAnimateLadder&&await this.onAnimateLadder(),vs(()=>{this.setStickyDateManually(),u.forEach(I=>{I.classList.remove("zoom-fade")})}),performance.now();let S;if(c.length||d.length||h.length){S=Promise.all(b);const L=Math.max(...w)+300;wr(S,L).then(()=>{vs(()=>{u.forEach(M=>{M.style.transitionDelay="",M.classList.remove("can-zoom-fade")}),this.chatInner.classList.remove("zoom-fading")})})}return S}async renderEmptyPlaceholder(e,t,s,i){const n="empty-bubble-placeholder";t.classList.add(n,n+"-"+e);let a;e==="group"?a=_("GroupEmptyTitle1"):e==="saved"?a=_("ChatYourSelfTitle"):e==="noMessages"||e==="greeting"?a=_("NoMessages"):e==="noScheduledMessages"?a=_("NoScheduledMessages"):e==="restricted"&&(a=document.createElement("span"),a.innerText=await this.managers.appPeersManager.getRestrictionReasonText(this.peerId)),a&&(a.classList.add("center",n+"-title"),i.push(a));let r;if(e==="group")i.push(_("GroupEmptyTitle2")),r=[_("GroupDescription1"),_("GroupDescription2"),_("GroupDescription3"),_("GroupDescription4")];else if(e==="saved")r=[_("ChatYourSelfDescription1"),_("ChatYourSelfDescription2"),_("ChatYourSelfDescription3"),_("ChatYourSelfDescription4")];else if(e==="greeting"){const l=_("NoMessagesGreetingsDescription");l.classList.add("center",n+"-subtitle");const c=document.createElement("div");c.classList.add(n+"-sticker");const d=this.getMiddleware();await this.managers.appStickersManager.getGreetingSticker().then(async h=>{if(!d())return;const u=[];return await Ds({doc:h,div:c,middleware:d,lazyLoadQueue:this.lazyLoadQueue,group:this.chat.animationGroup,play:!0,loop:!0,withThumb:!0,loadPromises:u,liteModeKey:"stickers_chat"}),D(c,p=>{X(p),this.chat.input.emoticonsDropdown.onMediaClick({target:p.target})}),Promise.all(u)}),i.push(l,c)}else if(e==="premiumRequired"){const l=document.createElement("div");l.classList.add(n+"-sticker"),l.append(Le("premium_restrict"));const c=_("Chat.PremiumRequired",[await Oe({peerId:this.peerId,onlyFirstName:!0})]);c.classList.add("center",n+"-subtitle");const d=Ve("bubble-service-button",{noRipple:!0,text:"Chat.PremiumRequiredButton"});D(d,()=>{ps.show()}),i.push(l,c,d)}r&&(i.push(...r.map(l=>{const c=document.createElement("span");return c.classList.add(n+"-list-item"),c.append(l),c})),e==="group"?r.forEach(l=>{const c=Le("check",n+"-list-check");l.prepend(c)}):e==="saved"&&r.forEach(l=>{const c=document.createElement("span");c.classList.add(n+"-list-bullet"),c.innerText="•",l.prepend(c)})),i.length>1&&t.classList.add("has-description"),i.forEach(l=>l.classList.add(n+"-line"))}async processLocalMessageRender(e,t){const s=!!e.pFlags.sponsored,i=()=>{this.log.warn("local message was cleared before render",e)},n=async a=>{const{bubble:r}=await a;if(!r)return i(),a;const l=r.middlewareHelper.get(),c=Ir(l);r.message=e,r.classList.add("is-group-last","is-group-first");const d=()=>{if(this.updatePlaceholderPosition===d&&(this.updatePlaceholderPosition=void 0),!l()||this.bubbles[r.dataset.mid]!==r){i();return}g[f](p)};s||(r.classList.add("bubble-first"),r.classList.remove("can-have-tail","is-in"));const h=[],u=this.chat.isBot,p=r;let m,g=this.container,f="append";if(this.chat.isRestricted)m=this.renderEmptyPlaceholder("restricted",r,e,h);else if(s)r.classList.add("avoid-selection"),this.sponsoredMessage=e.sponsoredMessage,g=this.chatInner,f="append",t=!1;else if(u&&e._==="message"){const b=document.createElement("b");b.append(_("BotInfoTitle")),h.push(b,`
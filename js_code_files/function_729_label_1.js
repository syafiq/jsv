this.cursorHandler);this.joinFile=function(P){if(!G)try{N&&(EditorUi.debug("P2PCollab: joinInProgress on",N),M="busy");N=++I;try{null!=e&&(EditorUi.debug("P2PCollab: force closing socket on",e.joinId),e.close(1E3),e=null)}catch(q){EditorUi.debug("P2PCollab: closing socket error",q)}var V=new WebSocket(window.RT_WEBSOCKET_URL+"?id="+f);V.addEventListener("open",function(q){e=V;e.joinId=N;N=!1;d.file.fireEvent(new mxEventObject("realtimeStateChanged"));EditorUi.debug("P2PCollab: open socket",e.joinId);
P&&d.scheduleCleanup()});V.addEventListener("message",mxUtils.bind(this,function(q){K||EditorUi.debug("P2PCollab: msg received",[q]);var D=JSON.parse(q.data);K&&"message"!=D.action&&EditorUi.debug("P2PCollab: msg received",[q]);switch(D.action){case "message":t(D.msg,D.from);break;case "clientsList":q=D.msg;H=q.cId;x=!0;for(D=0;D<q.list.length;D++)y(q.list[D],!0);break;case "signal":q=D.msg;K||(F[q.from]?D=F[q.from]:(D=y(q.from,!1),p=!0),D.signal(q.signal));break;case "newClient":p=!0;break;case "clientLeft":B(D.msg);
break;case "sendSignalFailed":q=D.msg,EditorUi.debug("P2PCollab: signal failed (socket not found on server)",q),delete F[q.to],E[q.to]=!1}}));var W=!1;V.addEventListener("close",mxUtils.bind(this,function(q){EditorUi.debug("P2PCollab: WebSocket closed",V.joinId,"reconnecting",q.code,q.reason);EditorUi.debug("P2PCollab: closing socket on",V.joinId);G||1E3==q.code||I!=V.joinId||(N==I&&(EditorUi.debug("P2PCollab: joinInProgress in close on",V.joinId),N=!1),W||(EditorUi.debug("P2PCollab: calling rejoin on",
V.joinId),W=!0,this.joinFile(!0)));d.file.fireEvent(new mxEventObject("realtimeStateChanged"))}));V.addEventListener("error",mxUtils.bind(this,function(q){EditorUi.debug("P2PCollab: WebSocket error, reconnecting",q);EditorUi.debug("P2PCollab: error socket on",V.joinId);G||I!=V.joinId||(N==I&&(EditorUi.debug("P2PCollab: joinInProgress in error on",V.joinId),N=!1),W||(EditorUi.debug("P2PCollab: calling rejoin on",V.joinId),W=!0,this.joinFile(!0)));d.file.fireEvent(new mxEventObject("realtimeStateChanged"))}));
d.file.fireEvent(new mxEventObject("realtimeStateChanged"))}catch(q){M=q,d.file.fireEvent(new mxEventObject("realtimeStateChanged"))}};this.destroy=function(){if(!G){EditorUi.debug("P2PCollab: destroyed");G=!0;for(sessionId in k)z(sessionId);null!=this.mouseListeners&&A.removeMouseListener(this.mouseListeners);null!=this.selectionChangeListener&&A.getSelectionModel().removeListener(this.selectionChangeListener);null!=this.shareCursorPositionListener&&b.removeListener(this.shareCursorPositionListener);